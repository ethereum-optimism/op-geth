<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">

    <title>op-geth - go-ethereum fork diff overview</title>

    <link rel="icon" type="image/x-icon" href="">

    <style>
        .line-stat {
            width: 14rem;
            float: right;
        }
        .line-stat div {
            width: 50%;
        }
    </style>

    
<style>
    .term-container {
        background: #171717;
        border-radius: 5px;
        color: white;
        word-break: break-word;
        overflow-wrap: break-word;
        font-family: "SFMono-Regular", Monaco, Menlo, Consolas, "Liberation Mono", Courier, monospace;
        font-size: 12px;
        line-height: 20px;
        padding: 14px 18px;
        white-space: pre-wrap;
    }

    .term-container img { max-width: 100%; }

    .term a { color: inherit; text-decoration: underline; text-decoration-style: dashed; }
    .term a:hover { color: #2882F9 }

    @keyframes blink-animation {
        to {
            visibility: hidden;
        }
    }

    .term-fg1 { } /* don't bold beccause it looks weird */
    .term-fg2 { color: #838887; } /* faint (decreased intensity) - same as gray really */
    .term-fg3 { font-style: italic; } /* italic */
    .term-fg4 { text-decoration: underline; } /* underline */
    .term-fg5 { animation: blink-animation 1s steps(3, start) infinite; } /* blink */
    .term-fg9 { text-decoration: line-through; } /* crossed-out */

    .term-fg30 { color: #666666; } /* black (but we can't use black, so a diff color) */
    .term-fg31 { color: #ff7070; } /* red */
    .term-fg32 { color: #b0f986; } /* green */
    .term-fg33 { color: #c6c502; } /* yellow */
    .term-fg34 { color: #8db7e0; } /* blue */
    .term-fg35 { color: #f271fb; } /* magenta */
    .term-fg36 { color: #6bf7ff; } /* cyan */

    /* high intense colors */
    .term-fgi1 { color: #5ef765; }
    .term-fgi90 { color: #838887; } /* grey */
    .term-fgi91 { color: #ff3333; } /* red */
    .term-fgi92 { color: #00FF00; } /* green */
    .term-fgi93 { color: #fffc67; } /* yellow */
    .term-fgi94 { color: #6871ff; } /* blue */
    .term-fgi95 { color: #ff76ff; } /* magenta */
    .term-fgi96 { color: #60fcff; } /* cyan */

    /* background colors */
    .term-bg40 { background: #676767; } /* grey */
    .term-bg41 { background: #ff4343; } /* red */
    .term-bg42 { background: #99ff5f; } /* green */

    /* custom foreground/background combos for readability */
    .term-fg31.term-bg40 { color: #F8A39F; }

    /* xterm colors */
    .term-fgx16 { color: #000000; }
    .term-fgx17 { color: #00005f; }
    .term-fgx18 { color: #000087; }
    .term-fgx19 { color: #0000af; }
    .term-fgx20 { color: #0000d7; }
    .term-fgx21 { color: #0000ff; }
    .term-fgx22 { color: #005f00; }
    .term-fgx23 { color: #005f5f; }
    .term-fgx24 { color: #005f87; }
    .term-fgx25 { color: #005faf; }
    .term-fgx26 { color: #005fd7; }
    .term-fgx27 { color: #005fff; }
    .term-fgx28 { color: #008700; }
    .term-fgx29 { color: #00875f; }
    .term-fgx30 { color: #008787; }
    .term-fgx31 { color: #0087af; }
    .term-fgx32 { color: #0087d7; }
    .term-fgx33 { color: #0087ff; }
    .term-fgx34 { color: #00af00; }
    .term-fgx35 { color: #00af5f; }
    .term-fgx36 { color: #00af87; }
    .term-fgx37 { color: #00afaf; }
    .term-fgx38 { color: #00afd7; }
    .term-fgx39 { color: #00afff; }
    .term-fgx40 { color: #00d700; }
    .term-fgx41 { color: #00d75f; }
    .term-fgx42 { color: #00d787; }
    .term-fgx43 { color: #00d7af; }
    .term-fgx44 { color: #00d7d7; }
    .term-fgx45 { color: #00d7ff; }
    .term-fgx46 { color: #00ff00; }
    .term-fgx47 { color: #00ff5f; }
    .term-fgx48 { color: #00ff87; }
    .term-fgx49 { color: #00ffaf; }
    .term-fgx50 { color: #00ffd7; }
    .term-fgx51 { color: #00ffff; }
    .term-fgx52 { color: #5f0000; }
    .term-fgx53 { color: #5f005f; }
    .term-fgx54 { color: #5f0087; }
    .term-fgx55 { color: #5f00af; }
    .term-fgx56 { color: #5f00d7; }
    .term-fgx57 { color: #5f00ff; }
    .term-fgx58 { color: #5f5f00; }
    .term-fgx59 { color: #5f5f5f; }
    .term-fgx60 { color: #5f5f87; }
    .term-fgx61 { color: #5f5faf; }
    .term-fgx62 { color: #5f5fd7; }
    .term-fgx63 { color: #5f5fff; }
    .term-fgx64 { color: #5f8700; }
    .term-fgx65 { color: #5f875f; }
    .term-fgx66 { color: #5f8787; }
    .term-fgx67 { color: #5f87af; }
    .term-fgx68 { color: #5f87d7; }
    .term-fgx69 { color: #5f87ff; }
    .term-fgx70 { color: #5faf00; }
    .term-fgx71 { color: #5faf5f; }
    .term-fgx72 { color: #5faf87; }
    .term-fgx73 { color: #5fafaf; }
    .term-fgx74 { color: #5fafd7; }
    .term-fgx75 { color: #5fafff; }
    .term-fgx76 { color: #5fd700; }
    .term-fgx77 { color: #5fd75f; }
    .term-fgx78 { color: #5fd787; }
    .term-fgx79 { color: #5fd7af; }
    .term-fgx80 { color: #5fd7d7; }
    .term-fgx81 { color: #5fd7ff; }
    .term-fgx82 { color: #5fff00; }
    .term-fgx83 { color: #5fff5f; }
    .term-fgx84 { color: #5fff87; }
    .term-fgx85 { color: #5fffaf; }
    .term-fgx86 { color: #5fffd7; }
    .term-fgx87 { color: #5fffff; }
    .term-fgx88 { color: #870000; }
    .term-fgx89 { color: #87005f; }
    .term-fgx90 { color: #870087; }
    .term-fgx91 { color: #8700af; }
    .term-fgx92 { color: #8700d7; }
    .term-fgx93 { color: #8700ff; }
    .term-fgx94 { color: #875f00; }
    .term-fgx95 { color: #875f5f; }
    .term-fgx96 { color: #875f87; }
    .term-fgx97 { color: #875faf; }
    .term-fgx98 { color: #875fd7; }
    .term-fgx99 { color: #875fff; }
    .term-fgx100 { color: #878700; }
    .term-fgx101 { color: #87875f; }
    .term-fgx102 { color: #878787; }
    .term-fgx103 { color: #8787af; }
    .term-fgx104 { color: #8787d7; }
    .term-fgx105 { color: #8787ff; }
    .term-fgx106 { color: #87af00; }
    .term-fgx107 { color: #87af5f; }
    .term-fgx108 { color: #87af87; }
    .term-fgx109 { color: #87afaf; }
    .term-fgx110 { color: #87afd7; }
    .term-fgx111 { color: #87afff; }
    .term-fgx112 { color: #87d700; }
    .term-fgx113 { color: #87d75f; }
    .term-fgx114 { color: #87d787; }
    .term-fgx115 { color: #87d7af; }
    .term-fgx116 { color: #87d7d7; }
    .term-fgx117 { color: #87d7ff; }
    .term-fgx118 { color: #87ff00; }
    .term-fgx119 { color: #87ff5f; }
    .term-fgx120 { color: #87ff87; }
    .term-fgx121 { color: #87ffaf; }
    .term-fgx122 { color: #87ffd7; }
    .term-fgx123 { color: #87ffff; }
    .term-fgx124 { color: #af0000; }
    .term-fgx125 { color: #af005f; }
    .term-fgx126 { color: #af0087; }
    .term-fgx127 { color: #af00af; }
    .term-fgx128 { color: #af00d7; }
    .term-fgx129 { color: #af00ff; }
    .term-fgx130 { color: #af5f00; }
    .term-fgx131 { color: #af5f5f; }
    .term-fgx132 { color: #af5f87; }
    .term-fgx133 { color: #af5faf; }
    .term-fgx134 { color: #af5fd7; }
    .term-fgx135 { color: #af5fff; }
    .term-fgx136 { color: #af8700; }
    .term-fgx137 { color: #af875f; }
    .term-fgx138 { color: #af8787; }
    .term-fgx139 { color: #af87af; }
    .term-fgx140 { color: #af87d7; }
    .term-fgx141 { color: #af87ff; }
    .term-fgx142 { color: #afaf00; }
    .term-fgx143 { color: #afaf5f; }
    .term-fgx144 { color: #afaf87; }
    .term-fgx145 { color: #afafaf; }
    .term-fgx146 { color: #afafd7; }
    .term-fgx147 { color: #afafff; }
    .term-fgx148 { color: #afd700; }
    .term-fgx149 { color: #afd75f; }
    .term-fgx150 { color: #afd787; }
    .term-fgx151 { color: #afd7af; }
    .term-fgx152 { color: #afd7d7; }
    .term-fgx153 { color: #afd7ff; }
    .term-fgx154 { color: #afff00; }
    .term-fgx155 { color: #afff5f; }
    .term-fgx156 { color: #afff87; }
    .term-fgx157 { color: #afffaf; }
    .term-fgx158 { color: #afffd7; }
    .term-fgx159 { color: #afffff; }
    .term-fgx160 { color: #d70000; }
    .term-fgx161 { color: #d7005f; }
    .term-fgx162 { color: #d70087; }
    .term-fgx163 { color: #d700af; }
    .term-fgx164 { color: #d700d7; }
    .term-fgx165 { color: #d700ff; }
    .term-fgx166 { color: #d75f00; }
    .term-fgx167 { color: #d75f5f; }
    .term-fgx168 { color: #d75f87; }
    .term-fgx169 { color: #d75faf; }
    .term-fgx170 { color: #d75fd7; }
    .term-fgx171 { color: #d75fff; }
    .term-fgx172 { color: #d78700; }
    .term-fgx173 { color: #d7875f; }
    .term-fgx174 { color: #d78787; }
    .term-fgx175 { color: #d787af; }
    .term-fgx176 { color: #d787d7; }
    .term-fgx177 { color: #d787ff; }
    .term-fgx178 { color: #d7af00; }
    .term-fgx179 { color: #d7af5f; }
    .term-fgx180 { color: #d7af87; }
    .term-fgx181 { color: #d7afaf; }
    .term-fgx182 { color: #d7afd7; }
    .term-fgx183 { color: #d7afff; }
    .term-fgx184 { color: #d7d700; }
    .term-fgx185 { color: #d7d75f; }
    .term-fgx186 { color: #d7d787; }
    .term-fgx187 { color: #d7d7af; }
    .term-fgx188 { color: #d7d7d7; }
    .term-fgx189 { color: #d7d7ff; }
    .term-fgx190 { color: #d7ff00; }
    .term-fgx191 { color: #d7ff5f; }
    .term-fgx192 { color: #d7ff87; }
    .term-fgx193 { color: #d7ffaf; }
    .term-fgx194 { color: #d7ffd7; }
    .term-fgx195 { color: #d7ffff; }
    .term-fgx196 { color: #ff0000; }
    .term-fgx197 { color: #ff005f; }
    .term-fgx198 { color: #ff0087; }
    .term-fgx199 { color: #ff00af; }
    .term-fgx200 { color: #ff00d7; }
    .term-fgx201 { color: #ff00ff; }
    .term-fgx202 { color: #ff5f00; }
    .term-fgx203 { color: #ff5f5f; }
    .term-fgx204 { color: #ff5f87; }
    .term-fgx205 { color: #ff5faf; }
    .term-fgx206 { color: #ff5fd7; }
    .term-fgx207 { color: #ff5fff; }
    .term-fgx208 { color: #ff8700; }
    .term-fgx209 { color: #ff875f; }
    .term-fgx210 { color: #ff8787; }
    .term-fgx211 { color: #ff87af; }
    .term-fgx212 { color: #ff87d7; }
    .term-fgx213 { color: #ff87ff; }
    .term-fgx214 { color: #ffaf00; }
    .term-fgx215 { color: #ffaf5f; }
    .term-fgx216 { color: #ffaf87; }
    .term-fgx217 { color: #ffafaf; }
    .term-fgx218 { color: #ffafd7; }
    .term-fgx219 { color: #ffafff; }
    .term-fgx220 { color: #ffd700; }
    .term-fgx221 { color: #ffd75f; }
    .term-fgx222 { color: #ffd787; }
    .term-fgx223 { color: #ffd7af; }
    .term-fgx224 { color: #ffd7d7; }
    .term-fgx225 { color: #ffd7ff; }
    .term-fgx226 { color: #ffff00; }
    .term-fgx227 { color: #ffff5f; }
    .term-fgx228 { color: #ffff87; }
    .term-fgx229 { color: #ffffaf; }
    .term-fgx230 { color: #ffffd7; }
    .term-fgx231 { color: #ffffff; }
    .term-fgx232 { color: #080808; }
    .term-fgx233 { color: #121212; }
    .term-fgx234 { color: #1c1c1c; }
    .term-fgx235 { color: #262626; }
    .term-fgx236 { color: #303030; }
    .term-fgx237 { color: #3a3a3a; }
    .term-fgx238 { color: #444444; }
    .term-fgx239 { color: #4e4e4e; }
    .term-fgx240 { color: #585858; }
    .term-fgx241 { color: #626262; }
    .term-fgx242 { color: #6c6c6c; }
    .term-fgx243 { color: #767676; }
    .term-fgx244 { color: #808080; }
    .term-fgx245 { color: #8a8a8a; }
    .term-fgx246 { color: #949494; }
    .term-fgx247 { color: #9e9e9e; }
    .term-fgx248 { color: #a8a8a8; }
    .term-fgx249 { color: #b2b2b2; }
    .term-fgx250 { color: #bcbcbc; }
    .term-fgx251 { color: #c6c6c6; }
    .term-fgx252 { color: #d0d0d0; }
    .term-fgx253 { color: #dadada; }
    .term-fgx254 { color: #e4e4e4; }
    .term-fgx255 { color: #eeeeee; }
</style>

</head>
<body>
    <div class="col-xl-10 col-xxl-8 mx-auto px-3 py-1 py-md-3">
        <main class="container-fluid">
            <div class="row">
                <div>
                    <div class="float-end">
                        <div class="form-check form-switch">
                            <i class="bi bi-brightness-low" id="dark-mode-icon"></i>
                            <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle" data-bs-toggle="tooltip"
                                   data-bs-placement="bottom" data-bs-title="Toggle Dark Mode"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"role="button" aria-expanded="true" aria-controls="id-cc7516486e4940e0aff26bd7">
        
            <div class="col-12 col-sm-9 text-start"><h1>op-geth</h1></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3849</span></div>
                <div class="text-start"><span class="text-danger">-178</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse show border-1 ps-3 my-3" id="id-cc7516486e4940e0aff26bd7">
        <div><p>This is an overview of the changes in <a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a>,
a fork of <a href="https://github.com/ethereum/go-ethereum"><code>go-ethereum</code></a>, part of the OP-stack.</p>

<p>The OP-stack architecture is modular, following the Consensus/Execution split of post-Merge Ethereum L1:</p>

<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/tree/develop/op-node"><code>op-node</code></a> implements most rollup-specific functionality as Consensus-Layer, similar to a L1 beacon-node.</li>
<li><a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a> implements the Execution-Layer, with <strong>minimal changes</strong> for a secure Ethereum-equivalent application environment.</li>
</ul>

<p>Related <a href="https://github.com/ethereum-optimism/optimism/tree/develop/specs">op-stack specifications</a>:</p>

<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md">L2 Execution Engine spec</a></li>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md">Deposit Transaction spec</a></li>
</ul>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-084d38ee43c9d071531f8f37"role="button" aria-expanded="false" aria-controls="id-084d38ee43c9d071531f8f37">
        
            <div class="col-12 col-sm-9 text-start"><h2>Core modifications</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+919</span></div>
                <div class="text-start"><span class="text-danger">-54</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-084d38ee43c9d071531f8f37">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-14748112af093da9d057b261"role="button" aria-expanded="false" aria-controls="id-14748112af093da9d057b261">
        
            <div class="col-12 col-sm-9 text-start"><h3>State-transition modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+494</span></div>
                <div class="text-start"><span class="text-danger">-16</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-14748112af093da9d057b261">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-b28b1c1d59067367a4ed380a"role="button" aria-expanded="false" aria-controls="id-b28b1c1d59067367a4ed380a">
        
            <div class="col-12 col-sm-9 text-start"><h4>Deposit Transaction type</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+191</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-b28b1c1d59067367a4ed380a">
        <div><p>The Bedrock upgrade introduces a <code>Deposit</code> transaction-type (<code>0x7E</code>) to enable both users and the
rollup system itself to change the L2 state based on L1 events and system rules as
<a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md">specified</a>.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a6ed147c06c05db8ec557843" role="button"
                   aria-expanded="false" aria-controls="id-a6ed147c06c05db8ec557843">
                    <code>core/types/deposit_tx.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/deposit_tx.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+96</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a6ed147c06c05db8ec557843"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;deposit_tx.go op-geth&#47;core&#47;types&#47;deposit_tx.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..7ce326f5c320e976af22b56fed5a495362b43dba</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;deposit_tx.go</span>
<span class="term-fg36">@@ -0,0 +1,96 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2021 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const DepositTxType = 0x7E</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type DepositTx struct {</span>
<span class="term-fg32">+	&#47;&#47; SourceHash uniquely identifies the source of the deposit</span>
<span class="term-fg32">+	SourceHash common.Hash</span>
<span class="term-fg32">+	&#47;&#47; From is exposed through the types.Signer, not through TxData</span>
<span class="term-fg32">+	From common.Address</span>
<span class="term-fg32">+	&#47;&#47; nil means contract creation</span>
<span class="term-fg32">+	To *common.Address `rlp:&quot;nil&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Mint is minted on L2, locked on L1, nil if no minting.</span>
<span class="term-fg32">+	Mint *big.Int `rlp:&quot;nil&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Value is transferred from L2 balance, executed after Mint (if any)</span>
<span class="term-fg32">+	Value *big.Int</span>
<span class="term-fg32">+	&#47;&#47; gas limit</span>
<span class="term-fg32">+	Gas uint64</span>
<span class="term-fg32">+	&#47;&#47; Field indicating if this transaction is exempt from the L2 gas limit.</span>
<span class="term-fg32">+	IsSystemTransaction bool</span>
<span class="term-fg32">+	&#47;&#47; Normal Tx data</span>
<span class="term-fg32">+	Data []byte</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; copy creates a deep copy of the transaction data and initializes all fields.</span>
<span class="term-fg32">+func (tx *DepositTx) copy() TxData {</span>
<span class="term-fg32">+	cpy := &amp;DepositTx{</span>
<span class="term-fg32">+		SourceHash:          tx.SourceHash,</span>
<span class="term-fg32">+		From:                tx.From,</span>
<span class="term-fg32">+		To:                  copyAddressPtr(tx.To),</span>
<span class="term-fg32">+		Mint:                nil,</span>
<span class="term-fg32">+		Value:               new(big.Int),</span>
<span class="term-fg32">+		Gas:                 tx.Gas,</span>
<span class="term-fg32">+		IsSystemTransaction: tx.IsSystemTransaction,</span>
<span class="term-fg32">+		Data:                common.CopyBytes(tx.Data),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if tx.Mint != nil {</span>
<span class="term-fg32">+		cpy.Mint = new(big.Int).Set(tx.Mint)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if tx.Value != nil {</span>
<span class="term-fg32">+		cpy.Value.Set(tx.Value)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return cpy</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; accessors for innerTx.</span>
<span class="term-fg32">+func (tx *DepositTx) txType() byte              { return DepositTxType }</span>
<span class="term-fg32">+func (tx *DepositTx) chainID() *big.Int         { return common.Big0 }</span>
<span class="term-fg32">+func (tx *DepositTx) accessList() AccessList    { return nil }</span>
<span class="term-fg32">+func (tx *DepositTx) data() []byte              { return tx.Data }</span>
<span class="term-fg32">+func (tx *DepositTx) gas() uint64               { return tx.Gas }</span>
<span class="term-fg32">+func (tx *DepositTx) gasFeeCap() *big.Int       { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) gasTipCap() *big.Int       { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) gasPrice() *big.Int        { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) value() *big.Int           { return tx.Value }</span>
<span class="term-fg32">+func (tx *DepositTx) nonce() uint64             { return 0 }</span>
<span class="term-fg32">+func (tx *DepositTx) to() *common.Address       { return tx.To }</span>
<span class="term-fg32">+func (tx *DepositTx) blobGas() uint64           { return 0 }</span>
<span class="term-fg32">+func (tx *DepositTx) blobGasFeeCap() *big.Int   { return nil }</span>
<span class="term-fg32">+func (tx *DepositTx) blobHashes() []common.Hash { return nil }</span>
<span class="term-fg32">+func (tx *DepositTx) isSystemTx() bool          { return tx.IsSystemTransaction }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {</span>
<span class="term-fg32">+	return dst.Set(new(big.Int))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) effectiveNonce() *uint64 { return nil }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) rawSignatureValues() (v, r, s *big.Int) {</span>
<span class="term-fg32">+	return common.Big0, common.Big0, common.Big0</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) setSignatureValues(chainID, v, r, s *big.Int) {</span>
<span class="term-fg32">+	&#47;&#47; this is a noop for deposit transactions</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0b839ff16c7bf3515eb6e1fc" role="button"
                   aria-expanded="false" aria-controls="id-0b839ff16c7bf3515eb6e1fc">
                    <code>core/types/transaction_marshalling.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/transaction_marshalling.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/transaction_marshalling.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+81</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0b839ff16c7bf3515eb6e1fc"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_marshalling.go op-geth&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg1">index 6c6c50d498d7290439f2e7abf627002bcd2d9356..c5b04ce9dad47048c960e43a182171856d57c775 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg36">@@ -19,10 +19,12 @@</span>
 import (
 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;io&quot;</span>
 	&quot;math&#47;big&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
 	&quot;github.com&#47;holiman&#47;uint256&quot;
 )
&nbsp;
<span class="term-fg36">@@ -45,6 +47,12 @@</span> 	BlobVersionedHashes  []common.Hash   `json:&quot;blobVersionedHashes,omitempty&quot;`
 	V                    *hexutil.Big    `json:&quot;v&quot;`
 	R                    *hexutil.Big    `json:&quot;r&quot;`
 	S                    *hexutil.Big    `json:&quot;s&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Deposit transaction fields</span>
<span class="term-fg32">+	SourceHash *common.Hash    `json:&quot;sourceHash,omitempty&quot;`</span>
<span class="term-fg32">+	From       *common.Address `json:&quot;from,omitempty&quot;`</span>
<span class="term-fg32">+	Mint       *hexutil.Big    `json:&quot;mint,omitempty&quot;`</span>
<span class="term-fg32">+	IsSystemTx *bool           `json:&quot;isSystemTx,omitempty&quot;`</span>
&nbsp;
 	&#47;&#47; Only used for encoding:
 	Hash common.Hash `json:&quot;hash&quot;`
<span class="term-fg36">@@ -112,6 +120,19 @@</span> 		enc.To = tx.To()
 		enc.V = (*hexutil.Big)(itx.V.ToBig())
 		enc.R = (*hexutil.Big)(itx.R.ToBig())
 		enc.S = (*hexutil.Big)(itx.S.ToBig())
<span class="term-fg32">+</span>
<span class="term-fg32">+	case *DepositTx:</span>
<span class="term-fg32">+		enc.Gas = (*hexutil.Uint64)(&amp;itx.Gas)</span>
<span class="term-fg32">+		enc.Value = (*hexutil.Big)(itx.Value)</span>
<span class="term-fg32">+		enc.Input = (*hexutil.Bytes)(&amp;itx.Data)</span>
<span class="term-fg32">+		enc.To = tx.To()</span>
<span class="term-fg32">+		enc.SourceHash = &amp;itx.SourceHash</span>
<span class="term-fg32">+		enc.From = &amp;itx.From</span>
<span class="term-fg32">+		if itx.Mint != nil {</span>
<span class="term-fg32">+			enc.Mint = (*hexutil.Big)(itx.Mint)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		enc.IsSystemTx = &amp;itx.IsSystemTransaction</span>
<span class="term-fg32">+		&#47;&#47; other fields will show up as null.</span>
 	}
 	return json.Marshal(&amp;enc)
 }
<span class="term-fg36">@@ -343,6 +364,54 @@</span> 				return err
 			}
 		}
&nbsp;
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		if dec.AccessList != nil || dec.MaxFeePerGas != nil ||</span>
<span class="term-fg32">+			dec.MaxPriorityFeePerGas != nil {</span>
<span class="term-fg32">+			return errors.New(&quot;unexpected field(s) in deposit transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if dec.GasPrice != nil &amp;&amp; dec.GasPrice.ToInt().Cmp(common.Big0) != 0 {</span>
<span class="term-fg32">+			return errors.New(&quot;deposit transaction GasPrice must be 0&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if (dec.V != nil &amp;&amp; dec.V.ToInt().Cmp(common.Big0) != 0) ||</span>
<span class="term-fg32">+			(dec.R != nil &amp;&amp; dec.R.ToInt().Cmp(common.Big0) != 0) ||</span>
<span class="term-fg32">+			(dec.S != nil &amp;&amp; dec.S.ToInt().Cmp(common.Big0) != 0) {</span>
<span class="term-fg32">+			return errors.New(&quot;deposit transaction signature must be 0 or unset&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var itx DepositTx</span>
<span class="term-fg32">+		inner = &amp;itx</span>
<span class="term-fg32">+		if dec.To != nil {</span>
<span class="term-fg32">+			itx.To = dec.To</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if dec.Gas == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;gas&#39; for txdata&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Gas = uint64(*dec.Gas)</span>
<span class="term-fg32">+		if dec.Value == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;value&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Value = (*big.Int)(dec.Value)</span>
<span class="term-fg32">+		&#47;&#47; mint may be omitted or nil if there is nothing to mint.</span>
<span class="term-fg32">+		itx.Mint = (*big.Int)(dec.Mint)</span>
<span class="term-fg32">+		if dec.Input == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;input&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Data = *dec.Input</span>
<span class="term-fg32">+		if dec.From == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;from&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.From = *dec.From</span>
<span class="term-fg32">+		if dec.SourceHash == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;sourceHash&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.SourceHash = *dec.SourceHash</span>
<span class="term-fg32">+		&#47;&#47; IsSystemTx may be omitted. Defaults to false.</span>
<span class="term-fg32">+		if dec.IsSystemTx != nil {</span>
<span class="term-fg32">+			itx.IsSystemTransaction = *dec.IsSystemTx</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		if dec.Nonce != nil {</span>
<span class="term-fg32">+			inner = &amp;depositTxWithNonce{DepositTx: itx, EffectiveNonce: uint64(*dec.Nonce)}</span>
<span class="term-fg32">+		}</span>
 	default:
 		return ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -353,3 +422,15 @@</span>
 	&#47;&#47; TODO: check hash here?
 	return nil
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+type depositTxWithNonce struct {</span>
<span class="term-fg32">+	DepositTx</span>
<span class="term-fg32">+	EffectiveNonce uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; EncodeRLP ensures that RLP encoding this transaction excludes the nonce. Otherwise, the tx Hash would change</span>
<span class="term-fg32">+func (tx *depositTxWithNonce) EncodeRLP(w io.Writer) error {</span>
<span class="term-fg32">+	return rlp.Encode(w, tx.DepositTx)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *depositTxWithNonce) effectiveNonce() *uint64 { return &amp;tx.EffectiveNonce }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7cc496bacb3a242cbf501610" role="button"
                   aria-expanded="false" aria-controls="id-7cc496bacb3a242cbf501610">
                    <code>core/types/transaction_signing.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/transaction_signing.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/transaction_signing.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+14</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7cc496bacb3a242cbf501610"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_signing.go op-geth&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg1">index 59dd2e76eb86ce46352585b0ddfb814228ce34c2..68ad7719059a201e5d620354b32cf910acec05a1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg36">@@ -256,6 +256,14 @@</span> 	return londonSigner{eip2930Signer{NewEIP155Signer(chainId)}}
 }
&nbsp;
 func (s londonSigner) Sender(tx *Transaction) (common.Address, error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		switch tx.inner.(type) {</span>
<span class="term-fg32">+		case *DepositTx:</span>
<span class="term-fg32">+			return tx.inner.(*DepositTx).From, nil</span>
<span class="term-fg32">+		case *depositTxWithNonce:</span>
<span class="term-fg32">+			return tx.inner.(*depositTxWithNonce).From, nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() != DynamicFeeTxType {
 		return s.eip2930Signer.Sender(tx)
 	}
<span class="term-fg36">@@ -275,6 +283,9 @@</span> 	return ok &amp;&amp; x.chainId.Cmp(s.chainId) == 0
 }
&nbsp;
 func (s londonSigner) SignatureValues(tx *Transaction, sig []byte) (R, S, V *big.Int, err error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return nil, nil, nil, fmt.Errorf(&quot;deposits do not have a signature&quot;)</span>
<span class="term-fg32">+	}</span>
 	txdata, ok := tx.inner.(*DynamicFeeTx)
 	if !ok {
 		return s.eip2930Signer.SignatureValues(tx, sig)
<span class="term-fg36">@@ -292,6 +303,9 @@</span>
 &#47;&#47; Hash returns the hash to be signed by the sender.
 &#47;&#47; It does not uniquely identify the transaction.
 func (s londonSigner) Hash(tx *Transaction) common.Hash {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		panic(&quot;deposits cannot be signed and do not have a signing hash&quot;)</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() != DynamicFeeTxType {
 		return s.eip2930Signer.Hash(tx)
 	}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-b1fb36f2fe017e82b6706401"role="button" aria-expanded="false" aria-controls="id-b1fb36f2fe017e82b6706401">
        
            <div class="col-12 col-sm-9 text-start"><h4>Transaction properties</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+83</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-b1fb36f2fe017e82b6706401">
        <div><p>The <code>Transaction</code> type now exposes the deposit-transaction and L1-cost properties required for the rollup.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-18685045f154add7989cf9f6" role="button"
                   aria-expanded="false" aria-controls="id-18685045f154add7989cf9f6">
                    <code>core/types/transaction.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/transaction.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/transaction.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+80</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-18685045f154add7989cf9f6"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction.go op-geth&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg1">index b7cb36b6026f4fb61ac41b48931ae58afe7864ee..23f7613fe02c7b3f1fdd777459225de5bebdb35c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg36">@@ -28,6 +28,7 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 )
&nbsp;
<span class="term-fg36">@@ -57,6 +58,9 @@</span> 	&#47;&#47; caches
 	hash atomic.Value
 	size atomic.Value
 	from atomic.Value
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; cache of RollupGasData details to compute the gas the tx takes on L1 for its share of rollup data</span>
<span class="term-fg32">+	rollupGas atomic.Value</span>
 }
&nbsp;
 &#47;&#47; NewTx creates a new transaction.
<span class="term-fg36">@@ -86,6 +90,7 @@</span> 	to() *common.Address
 	blobGas() uint64
 	blobGasFeeCap() *big.Int
 	blobHashes() []common.Hash
<span class="term-fg32">+	isSystemTx() bool</span>
&nbsp;
 	rawSignatureValues() (v, r, s *big.Int)
 	setSignatureValues(chainID, v, r, s *big.Int)
<span class="term-fg36">@@ -200,6 +205,10 @@</span> 	case BlobTxType:
 		var inner BlobTx
 		err := rlp.DecodeBytes(b[1:], &amp;inner)
 		return &amp;inner, err
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		var inner DepositTx</span>
<span class="term-fg32">+		err := rlp.DecodeBytes(b[1:], &amp;inner)</span>
<span class="term-fg32">+		return &amp;inner, err</span>
 	default:
 		return nil, ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -304,12 +313,56 @@</span>
 &#47;&#47; Nonce returns the sender account nonce of the transaction.
 func (tx *Transaction) Nonce() uint64 { return tx.inner.nonce() }
&nbsp;
<span class="term-fg32">+&#47;&#47; EffectiveNonce returns the nonce that was actually used as part of transaction execution</span>
<span class="term-fg32">+&#47;&#47; Returns nil if the effective nonce is not known</span>
<span class="term-fg32">+func (tx *Transaction) EffectiveNonce() *uint64 {</span>
<span class="term-fg32">+	type txWithEffectiveNonce interface {</span>
<span class="term-fg32">+		effectiveNonce() *uint64</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if itx, ok := tx.inner.(txWithEffectiveNonce); ok {</span>
<span class="term-fg32">+		return itx.effectiveNonce()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonce := tx.inner.nonce()</span>
<span class="term-fg32">+	return &amp;nonce</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; To returns the recipient address of the transaction.
 &#47;&#47; For contract-creation transactions, To returns nil.
 func (tx *Transaction) To() *common.Address {
 	return copyAddressPtr(tx.inner.to())
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; SourceHash returns the hash that uniquely identifies the source of the deposit tx,</span>
<span class="term-fg32">+&#47;&#47; e.g. a user deposit event, or a L1 info deposit included in a specific L2 block height.</span>
<span class="term-fg32">+&#47;&#47; Non-deposit transactions return a zeroed hash.</span>
<span class="term-fg32">+func (tx *Transaction) SourceHash() common.Hash {</span>
<span class="term-fg32">+	if dep, ok := tx.inner.(*DepositTx); ok {</span>
<span class="term-fg32">+		return dep.SourceHash</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return common.Hash{}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Mint returns the ETH to mint in the deposit tx.</span>
<span class="term-fg32">+&#47;&#47; This returns nil if there is nothing to mint, or if this is not a deposit tx.</span>
<span class="term-fg32">+func (tx *Transaction) Mint() *big.Int {</span>
<span class="term-fg32">+	if dep, ok := tx.inner.(*DepositTx); ok {</span>
<span class="term-fg32">+		return dep.Mint</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsDepositTx returns true if the transaction is a deposit tx type.</span>
<span class="term-fg32">+func (tx *Transaction) IsDepositTx() bool {</span>
<span class="term-fg32">+	return tx.Type() == DepositTxType</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsSystemTx returns true for deposits that are system transactions. These transactions</span>
<span class="term-fg32">+&#47;&#47; are executed in an unmetered environment &amp; do not contribute to the block gas limit.</span>
<span class="term-fg32">+func (tx *Transaction) IsSystemTx() bool {</span>
<span class="term-fg32">+	return tx.inner.isSystemTx()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Cost returns (gas * gasPrice) + (blobGas * blobGasPrice) + value.
 func (tx *Transaction) Cost() *big.Int {
 	total := new(big.Int).Mul(tx.GasPrice(), new(big.Int).SetUint64(tx.Gas()))
<span class="term-fg36">@@ -320,6 +373,30 @@</span> 	total.Add(total, tx.Value())
 	return total
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; RollupDataGas is the amount of gas it takes to confirm the tx on L1 as a rollup</span>
<span class="term-fg32">+func (tx *Transaction) RollupDataGas() RollupGasData {</span>
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return RollupGasData{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if v := tx.rollupGas.Load(); v != nil {</span>
<span class="term-fg32">+		return v.(RollupGasData)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	data, err := tx.MarshalBinary()</span>
<span class="term-fg32">+	if err != nil { &#47;&#47; Silent error, invalid txs will not be marshalled&#47;unmarshalled for batch submission anyway.</span>
<span class="term-fg32">+		log.Error(&quot;failed to encode tx for L1 cost computation&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var out RollupGasData</span>
<span class="term-fg32">+	for _, byt := range data {</span>
<span class="term-fg32">+		if byt == 0 {</span>
<span class="term-fg32">+			out.Zeroes++</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			out.Ones++</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	tx.rollupGas.Store(out)</span>
<span class="term-fg32">+	return out</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; RawSignatureValues returns the V, R, S signature values of the transaction.
 &#47;&#47; The return values should not be modified by the caller.
 func (tx *Transaction) RawSignatureValues() (v, r, s *big.Int) {
<span class="term-fg36">@@ -350,6 +427,9 @@</span> &#47;&#47; EffectiveGasTip returns the effective miner gasTipCap for the given base fee.
 &#47;&#47; Note: if the effective gasTipCap is negative, this method returns both error
 &#47;&#47; the actual negative value, _and_ ErrGasFeeCapTooLow
 func (tx *Transaction) EffectiveGasTip(baseFee *big.Int) (*big.Int, error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return new(big.Int), nil</span>
<span class="term-fg32">+	}</span>
 	if baseFee == nil {
 		return tx.GasTipCap(), nil
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cfd73a31c479a1aeb4949f16" role="button"
                   aria-expanded="false" aria-controls="id-cfd73a31c479a1aeb4949f16">
                    <code>core/types/tx_access_list.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/tx_access_list.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/tx_access_list.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cfd73a31c479a1aeb4949f16"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_access_list.go op-geth&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg1">index 7ce9da73ecbe4a34d91803738c15b501dbaed134..a1c2fbb9bb242adc914e4f34ee1b6abcecb40570 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg36">@@ -108,6 +108,7 @@</span> func (tx *AccessListTx) to() *common.Address       { return tx.To }
 func (tx *AccessListTx) blobGas() uint64           { return 0 }
 func (tx *AccessListTx) blobGasFeeCap() *big.Int   { return nil }
 func (tx *AccessListTx) blobHashes() []common.Hash { return nil }
<span class="term-fg32">+func (tx *AccessListTx) isSystemTx() bool          { return false }</span>
&nbsp;
 func (tx *AccessListTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	return dst.Set(tx.GasPrice)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1753becc2a8bb2f84bb143f3" role="button"
                   aria-expanded="false" aria-controls="id-1753becc2a8bb2f84bb143f3">
                    <code>core/types/tx_dynamic_fee.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/tx_dynamic_fee.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/tx_dynamic_fee.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1753becc2a8bb2f84bb143f3"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_dynamic_fee.go op-geth&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg1">index 47b870abbf5c028fef7984dc00b320a1b5848ec8..989093404e926386bb3e5af4d69f9cfba09ba5b1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg36">@@ -97,6 +97,7 @@</span> func (tx *DynamicFeeTx) to() *common.Address       { return tx.To }
 func (tx *DynamicFeeTx) blobGas() uint64           { return 0 }
 func (tx *DynamicFeeTx) blobGasFeeCap() *big.Int   { return nil }
 func (tx *DynamicFeeTx) blobHashes() []common.Hash { return nil }
<span class="term-fg32">+func (tx *DynamicFeeTx) isSystemTx() bool          { return false }</span>
&nbsp;
 func (tx *DynamicFeeTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	if baseFee == nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9445ccbea8f45f9c62ea01be" role="button"
                   aria-expanded="false" aria-controls="id-9445ccbea8f45f9c62ea01be">
                    <code>core/types/tx_legacy.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/tx_legacy.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/tx_legacy.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9445ccbea8f45f9c62ea01be"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_legacy.go op-geth&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg1">index 902e70cf94b9607bb1a6b667e4a81070813f5e01..69cf5951d973af38c141e01a7a51c7d0667879ec 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg36">@@ -105,6 +105,7 @@</span> func (tx *LegacyTx) to() *common.Address       { return tx.To }
 func (tx *LegacyTx) blobGas() uint64           { return 0 }
 func (tx *LegacyTx) blobGasFeeCap() *big.Int   { return nil }
 func (tx *LegacyTx) blobHashes() []common.Hash { return nil }
<span class="term-fg32">+func (tx *LegacyTx) isSystemTx() bool          { return false }</span>
&nbsp;
 func (tx *LegacyTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	return dst.Set(tx.GasPrice)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4fef7945aa913776786c50d2"role="button" aria-expanded="false" aria-controls="id-4fef7945aa913776786c50d2">
        
            <div class="col-12 col-sm-9 text-start"><h4>L1 cost computation</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+103</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4fef7945aa913776786c50d2">
        <div><p>Transactions must pay an additional L1 cost based on the amount of rollup-data-gas they consume,
estimated based on gas-price-oracle information and encoded tx size.&rdquo;</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-eeb15def9bd8a0318723542b" role="button"
                   aria-expanded="false" aria-controls="id-eeb15def9bd8a0318723542b">
                    <code>core/vm/evm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/vm/evm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/vm/evm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-eeb15def9bd8a0318723542b"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;evm.go op-geth&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg1">index 01017572d178c2111d9728a7938bf9c890d632a3..d070a8230ed168b0412ba43fd04065a40e66e4d0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg36">@@ -20,10 +20,12 @@</span> import (
 	&quot;math&#47;big&quot;
 	&quot;sync&#47;atomic&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg31">-	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 &#47;&#47; emptyCodeHash is used by create to ensure deployment is disallowed to already
<span class="term-fg36">@@ -66,6 +68,8 @@</span> 	&#47;&#47; Transfer transfers ether from one account to the other
 	Transfer TransferFunc
 	&#47;&#47; GetHash returns the hash corresponding to n
 	GetHash GetHashFunc
<span class="term-fg32">+	&#47;&#47; L1CostFunc returns the L1 cost of the rollup message, the function may be nil, or return nil</span>
<span class="term-fg32">+	L1CostFunc types.L1CostFunc</span>
&nbsp;
 	&#47;&#47; Block information
 	Coinbase    common.Address &#47;&#47; Provides information for COINBASE</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e716854d83676f170d42f7bc" role="button"
                   aria-expanded="false" aria-controls="id-e716854d83676f170d42f7bc">
                    <code>core/types/rollup_l1_cost.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/rollup_l1_cost.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+83</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e716854d83676f170d42f7bc"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;rollup_l1_cost.go op-geth&#47;core&#47;types&#47;rollup_l1_cost.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..521dfc10d7a7f086456cea4d16b2a756a0dbc777</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;rollup_l1_cost.go</span>
<span class="term-fg36">@@ -0,0 +1,83 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2022 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type RollupGasData struct {</span>
<span class="term-fg32">+	Zeroes, Ones uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (r RollupGasData) DataGas(time uint64, cfg *params.ChainConfig) (gas uint64) {</span>
<span class="term-fg32">+	gas = r.Zeroes * params.TxDataZeroGas</span>
<span class="term-fg32">+	if cfg.IsRegolith(time) {</span>
<span class="term-fg32">+		gas += r.Ones * params.TxDataNonZeroGasEIP2028</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		gas += (r.Ones + 68) * params.TxDataNonZeroGasEIP2028</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return gas</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type StateGetter interface {</span>
<span class="term-fg32">+	GetState(common.Address, common.Hash) common.Hash</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; L1CostFunc is used in the state transition to determine the cost of a rollup message.</span>
<span class="term-fg32">+&#47;&#47; Returns nil if there is no cost.</span>
<span class="term-fg32">+type L1CostFunc func(blockNum uint64, blockTime uint64, dataGas RollupGasData, isDepositTx bool) *big.Int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	L1BaseFeeSlot = common.BigToHash(big.NewInt(1))</span>
<span class="term-fg32">+	OverheadSlot  = common.BigToHash(big.NewInt(5))</span>
<span class="term-fg32">+	ScalarSlot    = common.BigToHash(big.NewInt(6))</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var L1BlockAddr = common.HexToAddress(&quot;0x4200000000000000000000000000000000000015&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewL1CostFunc returns a function used for calculating L1 fee cost.</span>
<span class="term-fg32">+&#47;&#47; This depends on the oracles because gas costs can change over time.</span>
<span class="term-fg32">+&#47;&#47; It returns nil if there is no applicable cost function.</span>
<span class="term-fg32">+func NewL1CostFunc(config *params.ChainConfig, statedb StateGetter) L1CostFunc {</span>
<span class="term-fg32">+	cacheBlockNum := ^uint64(0)</span>
<span class="term-fg32">+	var l1BaseFee, overhead, scalar *big.Int</span>
<span class="term-fg32">+	return func(blockNum uint64, blockTime uint64, dataGas RollupGasData, isDepositTx bool) *big.Int {</span>
<span class="term-fg32">+		rollupDataGas := dataGas.DataGas(blockTime, config) &#47;&#47; Only fake txs for RPC view-calls are 0.</span>
<span class="term-fg32">+		if config.Optimism == nil || isDepositTx || rollupDataGas == 0 {</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if blockNum != cacheBlockNum {</span>
<span class="term-fg32">+			l1BaseFee = statedb.GetState(L1BlockAddr, L1BaseFeeSlot).Big()</span>
<span class="term-fg32">+			overhead = statedb.GetState(L1BlockAddr, OverheadSlot).Big()</span>
<span class="term-fg32">+			scalar = statedb.GetState(L1BlockAddr, ScalarSlot).Big()</span>
<span class="term-fg32">+			cacheBlockNum = blockNum</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return L1Cost(rollupDataGas, l1BaseFee, overhead, scalar)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func L1Cost(rollupDataGas uint64, l1BaseFee, overhead, scalar *big.Int) *big.Int {</span>
<span class="term-fg32">+	l1GasUsed := new(big.Int).SetUint64(rollupDataGas)</span>
<span class="term-fg32">+	l1GasUsed = l1GasUsed.Add(l1GasUsed, overhead)</span>
<span class="term-fg32">+	l1Cost := l1GasUsed.Mul(l1GasUsed, l1BaseFee)</span>
<span class="term-fg32">+	l1Cost = l1Cost.Mul(l1Cost, scalar)</span>
<span class="term-fg32">+	return l1Cost.Div(l1Cost, big.NewInt(1_000_000))</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-097e617ec49cdc5c47e63b1b" role="button"
                   aria-expanded="false" aria-controls="id-097e617ec49cdc5c47e63b1b">
                    <code>core/state_processor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/state_processor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/state_processor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+14</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-097e617ec49cdc5c47e63b1b"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_processor.go op-geth&#47;core&#47;state_processor.go</span>
<span class="term-fg1">index 03de673e19c2bc6fa9ff23532c3e9381d22d5396..92c7c4b8c4dbc38bc0129ae89fa7f8dcd771f149 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_processor.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_processor.go</span>
<span class="term-fg36">@@ -71,7 +71,7 @@</span> 	if p.config.DAOForkSupport &amp;&amp; p.config.DAOForkBlock != nil &amp;&amp; p.config.DAOForkBlock.Cmp(block.Number()) == 0 {
 		misc.ApplyDAOHardFork(statedb)
 	}
 	var (
<span class="term-fg31">-		context = NewEVMBlockContext(header, p.bc, nil)</span>
<span class="term-fg32">+		context = NewEVMBlockContext(header, p.bc, nil, p.config, statedb)</span>
 		vmenv   = vm.NewEVM(context, vm.TxContext{}, statedb, p.config, cfg)
 		signer  = types.MakeSigner(p.config, header.Number, header.Time)
 	)
<span class="term-fg36">@@ -105,6 +105,11 @@</span> 	&#47;&#47; Create a new context to be used in the EVM environment.
 	txContext := NewEVMTxContext(msg)
 	evm.Reset(txContext, statedb)
&nbsp;
<span class="term-fg32">+	nonce := tx.Nonce()</span>
<span class="term-fg32">+	if msg.IsDepositTx &amp;&amp; config.IsOptimismRegolith(evm.Context.Time) {</span>
<span class="term-fg32">+		nonce = statedb.GetNonce(msg.From)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Apply the transaction to the current state (included in the env).
 	result, err := ApplyMessage(evm, msg, gp)
 	if err != nil {
<span class="term-fg36">@@ -131,9 +136,15 @@</span> 	}
 	receipt.TxHash = tx.Hash()
 	receipt.GasUsed = result.UsedGas
&nbsp;
<span class="term-fg32">+	if msg.IsDepositTx &amp;&amp; config.IsOptimismRegolith(evm.Context.Time) {</span>
<span class="term-fg32">+		&#47;&#47; The actual nonce for deposit transactions is only recorded from Regolith onwards.</span>
<span class="term-fg32">+		&#47;&#47; Before the Regolith fork the DepositNonce must remain nil</span>
<span class="term-fg32">+		receipt.DepositNonce = &amp;nonce</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; If the transaction created a contract, store the creation address in the receipt.
 	if msg.To == nil {
<span class="term-fg31">-		receipt.ContractAddress = crypto.CreateAddress(evm.TxContext.Origin, tx.Nonce())</span>
<span class="term-fg32">+		receipt.ContractAddress = crypto.CreateAddress(evm.TxContext.Origin, nonce)</span>
 	}
&nbsp;
 	&#47;&#47; Set the receipt logs and create the bloom filter.
<span class="term-fg36">@@ -155,7 +166,7 @@</span> 	if err != nil {
 		return nil, err
 	}
 	&#47;&#47; Create a new context to be used in the EVM environment
<span class="term-fg31">-	blockContext := NewEVMBlockContext(header, bc, author)</span>
<span class="term-fg32">+	blockContext := NewEVMBlockContext(header, bc, author, config, statedb)</span>
 	vmenv := vm.NewEVM(blockContext, vm.TxContext{}, statedb, config, cfg)
 	return applyTransaction(msg, config, gp, statedb, header.Number, header.Hash(), tx, usedGas, vmenv)
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6c205ece2e028a3be6bfabc2" role="button"
                   aria-expanded="false" aria-controls="id-6c205ece2e028a3be6bfabc2">
                    <code>core/state_prefetcher.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/state_prefetcher.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/state_prefetcher.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6c205ece2e028a3be6bfabc2"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_prefetcher.go op-geth&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg1">index ff867309de302b90dc3e071e97cbe3705d34c970..bb6835202b9758e49611f8da677ddee3edc346f1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg36">@@ -51,7 +51,7 @@</span> func (p *statePrefetcher) Prefetch(block *types.Block, statedb *state.StateDB, cfg vm.Config, interrupt *atomic.Bool) {
 	var (
 		header       = block.Header()
 		gaspool      = new(GasPool).AddGas(block.GasLimit())
<span class="term-fg31">-		blockContext = NewEVMBlockContext(header, p.bc, nil)</span>
<span class="term-fg32">+		blockContext = NewEVMBlockContext(header, p.bc, nil, p.config, statedb)</span>
 		evm          = vm.NewEVM(blockContext, vm.TxContext{}, statedb, p.config, cfg)
 		signer       = types.MakeSigner(p.config, header.Number, header.Time)
 	)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-0e529de4b0f50df4b161831c"role="button" aria-expanded="false" aria-controls="id-0e529de4b0f50df4b161831c">
        
            <div class="col-12 col-sm-9 text-start"><h4>Transaction processing</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+110</span></div>
                <div class="text-start"><span class="text-danger">-9</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-0e529de4b0f50df4b161831c">
        <div><p>Deposit transactions have special processing rules: gas is pre-paid on L1,
and deposits with EVM-failure are included with rolled back changes (except mint).
For regular transactions, at the end of the transition, the 1559 burn and L1 cost are routed to vaults.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9e184a42a8399b82505b614d" role="button"
                   aria-expanded="false" aria-controls="id-9e184a42a8399b82505b614d">
                    <code>core/state_transition.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/state_transition.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/state_transition.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+110</span></div>
                        <div class="text-start"><span class="text-danger">-9</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9e184a42a8399b82505b614d"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_transition.go op-geth&#47;core&#47;state_transition.go</span>
<span class="term-fg1">index 72f975775c1b63dd6ea1085be12ee1f578f6db9b..e242f63aea84464b5d457ddc0ab5534344b67225 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_transition.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_transition.go</span>
<span class="term-fg36">@@ -140,20 +140,30 @@</span> 	&#47;&#47; When SkipAccountChecks is true, the message nonce is not checked against the
 	&#47;&#47; account nonce in state. It also disables checking that the sender is an EOA.
 	&#47;&#47; This field will be set to true for operations like RPC eth_call.
 	SkipAccountChecks bool
<span class="term-fg32">+</span>
<span class="term-fg32">+	IsSystemTx    bool                &#47;&#47; IsSystemTx indicates the message, if also a deposit, does not emit gas usage.</span>
<span class="term-fg32">+	IsDepositTx   bool                &#47;&#47; IsDepositTx indicates the message is force-included and can persist a mint.</span>
<span class="term-fg32">+	Mint          *big.Int            &#47;&#47; Mint is the amount to mint before EVM processing, or nil if there is no minting.</span>
<span class="term-fg32">+	RollupDataGas types.RollupGasData &#47;&#47; RollupDataGas indicates the rollup cost of the message, 0 if not a rollup or no cost.</span>
 }
&nbsp;
 &#47;&#47; TransactionToMessage converts a transaction into a Message.
 func TransactionToMessage(tx *types.Transaction, s types.Signer, baseFee *big.Int) (*Message, error) {
 	msg := &amp;Message{
<span class="term-fg31">-		Nonce:             tx.Nonce(),</span>
<span class="term-fg31">-		GasLimit:          tx.Gas(),</span>
<span class="term-fg31">-		GasPrice:          new(big.Int).Set(tx.GasPrice()),</span>
<span class="term-fg31">-		GasFeeCap:         new(big.Int).Set(tx.GasFeeCap()),</span>
<span class="term-fg31">-		GasTipCap:         new(big.Int).Set(tx.GasTipCap()),</span>
<span class="term-fg31">-		To:                tx.To(),</span>
<span class="term-fg31">-		Value:             tx.Value(),</span>
<span class="term-fg31">-		Data:              tx.Data(),</span>
<span class="term-fg31">-		AccessList:        tx.AccessList(),</span>
<span class="term-fg32">+		Nonce:         tx.Nonce(),</span>
<span class="term-fg32">+		GasLimit:      tx.Gas(),</span>
<span class="term-fg32">+		GasPrice:      new(big.Int).Set(tx.GasPrice()),</span>
<span class="term-fg32">+		GasFeeCap:     new(big.Int).Set(tx.GasFeeCap()),</span>
<span class="term-fg32">+		GasTipCap:     new(big.Int).Set(tx.GasTipCap()),</span>
<span class="term-fg32">+		To:            tx.To(),</span>
<span class="term-fg32">+		Value:         tx.Value(),</span>
<span class="term-fg32">+		Data:          tx.Data(),</span>
<span class="term-fg32">+		AccessList:    tx.AccessList(),</span>
<span class="term-fg32">+		IsSystemTx:    tx.IsSystemTx(),</span>
<span class="term-fg32">+		IsDepositTx:   tx.IsDepositTx(),</span>
<span class="term-fg32">+		Mint:          tx.Mint(),</span>
<span class="term-fg32">+		RollupDataGas: tx.RollupDataGas(),</span>
<span class="term-fg32">+</span>
 		SkipAccountChecks: false,
 	}
 	&#47;&#47; If baseFee provided, set gasPrice to effectiveGasPrice.
<span class="term-fg36">@@ -228,11 +238,21 @@</span>
 func (st *StateTransition) buyGas() error {
 	mgval := new(big.Int).SetUint64(st.msg.GasLimit)
 	mgval = mgval.Mul(mgval, st.msg.GasPrice)
<span class="term-fg32">+	var l1Cost *big.Int</span>
<span class="term-fg32">+	if st.evm.Context.L1CostFunc != nil &amp;&amp; !st.msg.SkipAccountChecks {</span>
<span class="term-fg32">+		l1Cost = st.evm.Context.L1CostFunc(st.evm.Context.BlockNumber.Uint64(), st.evm.Context.Time, st.msg.RollupDataGas, st.msg.IsDepositTx)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if l1Cost != nil {</span>
<span class="term-fg32">+		mgval = mgval.Add(mgval, l1Cost)</span>
<span class="term-fg32">+	}</span>
 	balanceCheck := mgval
 	if st.msg.GasFeeCap != nil {
 		balanceCheck = new(big.Int).SetUint64(st.msg.GasLimit)
 		balanceCheck = balanceCheck.Mul(balanceCheck, st.msg.GasFeeCap)
 		balanceCheck.Add(balanceCheck, st.msg.Value)
<span class="term-fg32">+		if l1Cost != nil {</span>
<span class="term-fg32">+			balanceCheck.Add(balanceCheck, l1Cost)</span>
<span class="term-fg32">+		}</span>
 	}
 	if have, want := st.state.GetBalance(st.msg.From), balanceCheck; have.Cmp(want) &lt; 0 {
 		return fmt.Errorf(&quot;%w: address %v have %v want %v&quot;, ErrInsufficientFunds, st.msg.From.Hex(), have, want)
<span class="term-fg36">@@ -248,6 +268,21 @@</span> 	return nil
 }
&nbsp;
 func (st *StateTransition) preCheck() error {
<span class="term-fg32">+	if st.msg.IsDepositTx {</span>
<span class="term-fg32">+		&#47;&#47; No fee fields to check, no nonce to check, and no need to check if EOA (L1 already verified it for us)</span>
<span class="term-fg32">+		&#47;&#47; Gas is free, but no refunds!</span>
<span class="term-fg32">+		st.initialGas = st.msg.GasLimit</span>
<span class="term-fg32">+		st.gasRemaining += st.msg.GasLimit &#47;&#47; Add gas here in order to be able to execute calls.</span>
<span class="term-fg32">+		&#47;&#47; Don&#39;t touch the gas pool for system transactions</span>
<span class="term-fg32">+		if st.msg.IsSystemTx {</span>
<span class="term-fg32">+			if st.evm.ChainConfig().IsOptimismRegolith(st.evm.Context.Time) {</span>
<span class="term-fg32">+				return fmt.Errorf(&quot;%w: address %v&quot;, ErrSystemTxNotSupported,</span>
<span class="term-fg32">+					st.msg.From.Hex())</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return st.gp.SubGas(st.msg.GasLimit) &#47;&#47; gas used by deposits may not be used by other txs</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Only check transactions that are not fake
 	msg := st.msg
 	if !msg.SkipAccountChecks {
<span class="term-fg36">@@ -309,6 +344,37 @@</span> &#47;&#47;
 &#47;&#47; However if any consensus issue encountered, return the error directly with
 &#47;&#47; nil evm execution result.
 func (st *StateTransition) TransitionDb() (*ExecutionResult, error) {
<span class="term-fg32">+	if mint := st.msg.Mint; mint != nil {</span>
<span class="term-fg32">+		st.state.AddBalance(st.msg.From, mint)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	snap := st.state.Snapshot()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := st.innerTransitionDb()</span>
<span class="term-fg32">+	&#47;&#47; Failed deposits must still be included. Unless we cannot produce the block at all due to the gas limit.</span>
<span class="term-fg32">+	&#47;&#47; On deposit failure, we rewind any state changes from after the minting, and increment the nonce.</span>
<span class="term-fg32">+	if err != nil &amp;&amp; err != ErrGasLimitReached &amp;&amp; st.msg.IsDepositTx {</span>
<span class="term-fg32">+		st.state.RevertToSnapshot(snap)</span>
<span class="term-fg32">+		&#47;&#47; Even though we revert the state changes, always increment the nonce for the next deposit transaction</span>
<span class="term-fg32">+		st.state.SetNonce(st.msg.From, st.state.GetNonce(st.msg.From)+1)</span>
<span class="term-fg32">+		&#47;&#47; Record deposits as using all their gas (matches the gas pool)</span>
<span class="term-fg32">+		&#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+		&#47;&#47; Regolith changes this behaviour so the actual gas used is reported.</span>
<span class="term-fg32">+		&#47;&#47; In this case the tx is invalid so is recorded as using all gas.</span>
<span class="term-fg32">+		gasUsed := st.msg.GasLimit</span>
<span class="term-fg32">+		if st.msg.IsSystemTx &amp;&amp; !st.evm.ChainConfig().IsRegolith(st.evm.Context.Time) {</span>
<span class="term-fg32">+			gasUsed = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		result = &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    gasUsed,</span>
<span class="term-fg32">+			Err:        fmt.Errorf(&quot;failed deposit: %w&quot;, err),</span>
<span class="term-fg32">+			ReturnData: nil,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		err = nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return result, err</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (st *StateTransition) innerTransitionDb() (*ExecutionResult, error) {</span>
 	&#47;&#47; First check this message satisfies all consensus rules before
 	&#47;&#47; applying the message. The rules include these clauses
 	&#47;&#47;
<span class="term-fg36">@@ -375,6 +441,24 @@</span> 		st.state.SetNonce(msg.From, st.state.GetNonce(sender.Address())+1)
 		ret, st.gasRemaining, vmerr = st.evm.Call(sender, st.to(), msg.Data, st.gasRemaining, msg.Value)
 	}
&nbsp;
<span class="term-fg32">+	&#47;&#47; if deposit: skip refunds, skip tipping coinbase</span>
<span class="term-fg32">+	&#47;&#47; Regolith changes this behaviour to report the actual gasUsed instead of always reporting all gas used.</span>
<span class="term-fg32">+	if st.msg.IsDepositTx &amp;&amp; !rules.IsOptimismRegolith {</span>
<span class="term-fg32">+		&#47;&#47; Record deposits as using all their gas (matches the gas pool)</span>
<span class="term-fg32">+		&#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+		gasUsed := st.msg.GasLimit</span>
<span class="term-fg32">+		if st.msg.IsSystemTx {</span>
<span class="term-fg32">+			gasUsed = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    gasUsed,</span>
<span class="term-fg32">+			Err:        vmerr,</span>
<span class="term-fg32">+			ReturnData: ret,</span>
<span class="term-fg32">+		}, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Note for deposit tx there is no ETH refunded for unused gas, but that&#39;s taken care of by the fact that gasPrice</span>
<span class="term-fg32">+	&#47;&#47; is always 0 for deposit tx. So calling refundGas will ensure the gasUsed accounting is correct without actually</span>
<span class="term-fg32">+	&#47;&#47; changing the sender&#39;s balance</span>
 	if !rules.IsLondon {
 		&#47;&#47; Before EIP-3529: refunds were capped to gasUsed &#47; 2
 		st.refundGas(params.RefundQuotient)
<span class="term-fg36">@@ -382,6 +466,14 @@</span> 	} else {
 		&#47;&#47; After EIP-3529: refunds are capped to gasUsed &#47; 5
 		st.refundGas(params.RefundQuotientEIP3529)
 	}
<span class="term-fg32">+	if st.msg.IsDepositTx &amp;&amp; rules.IsOptimismRegolith {</span>
<span class="term-fg32">+		&#47;&#47; Skip coinbase payments for deposit tx in Regolith</span>
<span class="term-fg32">+		return &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    st.gasUsed(),</span>
<span class="term-fg32">+			Err:        vmerr,</span>
<span class="term-fg32">+			ReturnData: ret,</span>
<span class="term-fg32">+		}, nil</span>
<span class="term-fg32">+	}</span>
 	effectiveTip := msg.GasPrice
 	if rules.IsLondon {
 		effectiveTip = cmath.BigMin(msg.GasTipCap, new(big.Int).Sub(msg.GasFeeCap, st.evm.Context.BaseFee))
<span class="term-fg36">@@ -395,6 +487,15 @@</span> 	} else {
 		fee := new(big.Int).SetUint64(st.gasUsed())
 		fee.Mul(fee, effectiveTip)
 		st.state.AddBalance(st.evm.Context.Coinbase, fee)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that we are post bedrock to enable op-geth to be able to create pseudo pre-bedrock blocks (these are pre-bedrock, but don&#39;t follow l2 geth rules)</span>
<span class="term-fg32">+	&#47;&#47; Note optimismConfig will not be nil if rules.IsOptimismBedrock is true</span>
<span class="term-fg32">+	if optimismConfig := st.evm.ChainConfig().Optimism; optimismConfig != nil &amp;&amp; rules.IsOptimismBedrock {</span>
<span class="term-fg32">+		st.state.AddBalance(params.OptimismBaseFeeRecipient, new(big.Int).Mul(new(big.Int).SetUint64(st.gasUsed()), st.evm.Context.BaseFee))</span>
<span class="term-fg32">+		if cost := st.evm.Context.L1CostFunc(st.evm.Context.BlockNumber.Uint64(), st.evm.Context.Time, st.msg.RollupDataGas, st.msg.IsDepositTx); cost != nil {</span>
<span class="term-fg32">+			st.state.AddBalance(params.OptimismL1FeeRecipient, cost)</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	return &amp;ExecutionResult{</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-1109cde1caea9bd4bea481d5"role="button" aria-expanded="false" aria-controls="id-1109cde1caea9bd4bea481d5">
        
            <div class="col-12 col-sm-9 text-start"><h4>Gaslimit</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+4</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-1109cde1caea9bd4bea481d5">
        <div><p>The gaslimit is free to be set by the Engine API caller, instead of enforcing adjustments of the
gaslimit in increments of <sup>1</sup>&frasl;<sub>1024</sub> of the previous gaslimit.
The gaslimit is changed (and limited) through the <code>SystemConfig</code> contract.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0600a578abb0ce31ad038583" role="button"
                   aria-expanded="false" aria-controls="id-0600a578abb0ce31ad038583">
                    <code>consensus/misc/eip1559.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/consensus/misc/eip1559.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/consensus/misc/eip1559.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0600a578abb0ce31ad038583"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;eip1559.go op-geth&#47;consensus&#47;misc&#47;eip1559.go</span>
<span class="term-fg1">index fbaf9eec76b22a0daa49893533027b289e5c0c40..3162f6bbb943008c03b173ffba5b4db8e9164168 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;misc&#47;eip1559.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;eip1559.go</span>
<span class="term-fg36">@@ -36,8 +36,10 @@</span> 	parentGasLimit := parent.GasLimit
 	if !config.IsLondon(parent.Number) {
 		parentGasLimit = parent.GasLimit * config.ElasticityMultiplier()
 	}
<span class="term-fg31">-	if err := VerifyGaslimit(parentGasLimit, header.GasLimit); err != nil {</span>
<span class="term-fg31">-		return err</span>
<span class="term-fg32">+	if config.Optimism == nil { &#47;&#47; gasLimit can adjust instantly in optimism</span>
<span class="term-fg32">+		if err := VerifyGaslimit(parentGasLimit, header.GasLimit); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
 	}
 	&#47;&#47; Verify the header is not malformed
 	if header.BaseFee == nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4382c6117b58ad4cc87235a0"role="button" aria-expanded="false" aria-controls="id-4382c6117b58ad4cc87235a0">
        
            <div class="col-12 col-sm-9 text-start"><h4>Consensus tweaks</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4382c6117b58ad4cc87235a0">
        <div><p>The Engine API is activated at the Merge transition, with a Total Terminal Difficulty (TTD).
The rollup starts post-merge, and thus sets the TTD to 0.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1ffb42ca21f343d912753a7d" role="button"
                   aria-expanded="false" aria-controls="id-1ffb42ca21f343d912753a7d">
                    <code>consensus/beacon/consensus.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/consensus/beacon/consensus.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/consensus/beacon/consensus.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1ffb42ca21f343d912753a7d"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;beacon&#47;consensus.go op-geth&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg1">index 75f1b65efa3046fc2079ff9a11fc8d738e303854..03046fdba7207f70b3e6131690b6ac506a62a432 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg36">@@ -452,6 +452,9 @@</span> func IsTTDReached(chain consensus.ChainHeaderReader, parentHash common.Hash, parentNumber uint64) (bool, error) {
 	if chain.Config().TerminalTotalDifficulty == nil {
 		return false, nil
 	}
<span class="term-fg32">+	if common.Big0.Cmp(chain.Config().TerminalTotalDifficulty) == 0 { &#47;&#47; in case TTD is reached at genesis.</span>
<span class="term-fg32">+		return true, nil</span>
<span class="term-fg32">+	}</span>
 	td := chain.GetTd(parentHash, parentNumber)
 	if td == nil {
 		return false, consensus.ErrUnknownAncestor</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-b589b955b30ae54e1c00f90a"role="button" aria-expanded="false" aria-controls="id-b589b955b30ae54e1c00f90a">
        
            <div class="col-12 col-sm-9 text-start"><h3>Chain config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+136</span></div>
                <div class="text-start"><span class="text-danger">-3</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-b589b955b30ae54e1c00f90a">
        <div><p>The rollup functionality is enabled with the <code>optimism</code> field in the chain config.
The EIP-1559 parameters are configurable to adjust for faster more frequent and smaller blocks.
The parameters can be overriden for testing.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-981e6371a4300483005acdc6" role="button"
                   aria-expanded="false" aria-controls="id-981e6371a4300483005acdc6">
                    <code>params/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/params/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/params/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+84</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-981e6371a4300483005acdc6"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;config.go op-geth&#47;params&#47;config.go</span>
<span class="term-fg1">index 08e5ea0be03d4d5b02cc6876d64e249ef01544e3..c07e0d15435854c92998df86d85bb3745cbeb0e9 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;config.go</span>
<span class="term-fg36">@@ -31,6 +31,20 @@</span> 	RinkebyGenesisHash = common.HexToHash(&quot;0x6341fd3daf94b748c72ced5a5b26028f2474f5f00d824504e4fa37a75767e177&quot;)
 	GoerliGenesisHash  = common.HexToHash(&quot;0xbf7e331f7f7c1dd2e05159666b3bf8bc7a8a3a9eb1d518969eab529dd9b88c1a&quot;)
 )
&nbsp;
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	OPMainnetChainID  = 10</span>
<span class="term-fg32">+	OPGoerliChainID   = 420</span>
<span class="term-fg32">+	BaseGoerliChainID = 84531</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; OP Stack chain config</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; March 17, 2023 @ 7:00:00 pm UTC</span>
<span class="term-fg32">+	OptimismGoerliRegolithTime = uint64(1679079600)</span>
<span class="term-fg32">+	&#47;&#47; May 4, 2023 @ 5:00:00 pm UTC</span>
<span class="term-fg32">+	BaseGoerliRegolithTime = uint64(1683219600)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
 func newUint64(val uint64) *uint64 { return &amp;val }
&nbsp;
 var (
<span class="term-fg36">@@ -244,6 +258,16 @@</span> 		Ethash:                        new(EthashConfig),
 		Clique:                        nil,
 	}
 	TestRules = TestChainConfig.Rules(new(big.Int), false, 0)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; This is an Optimism chain config with bedrock starting a block 5, introduced for historical endpoint testing, largely based on the clique config</span>
<span class="term-fg32">+	OptimismTestConfig = func() *ChainConfig {</span>
<span class="term-fg32">+		conf := *AllCliqueProtocolChanges &#47;&#47; copy the config</span>
<span class="term-fg32">+		conf.Clique = nil</span>
<span class="term-fg32">+		conf.TerminalTotalDifficultyPassed = true</span>
<span class="term-fg32">+		conf.BedrockBlock = big.NewInt(5)</span>
<span class="term-fg32">+		conf.Optimism = &amp;OptimismConfig{EIP1559Elasticity: 50, EIP1559Denominator: 10}</span>
<span class="term-fg32">+		return &amp;conf</span>
<span class="term-fg32">+	}()</span>
 )
&nbsp;
 &#47;&#47; NetworkNames are user friendly names to use in the chain spec banner.
<span class="term-fg36">@@ -289,6 +313,9 @@</span> 	ShanghaiTime *uint64 `json:&quot;shanghaiTime,omitempty&quot;` &#47;&#47; Shanghai switch time (nil = no fork, 0 = already on shanghai)
 	CancunTime   *uint64 `json:&quot;cancunTime,omitempty&quot;`   &#47;&#47; Cancun switch time (nil = no fork, 0 = already on cancun)
 	PragueTime   *uint64 `json:&quot;pragueTime,omitempty&quot;`   &#47;&#47; Prague switch time (nil = no fork, 0 = already on prague)
&nbsp;
<span class="term-fg32">+	BedrockBlock *big.Int `json:&quot;bedrockBlock,omitempty&quot;` &#47;&#47; Bedrock switch block (nil = no fork, 0 = already on optimism bedrock)</span>
<span class="term-fg32">+	RegolithTime *uint64  `json:&quot;regolithTime,omitempty&quot;` &#47;&#47; Regolith switch time (nil = no fork, 0 = already on optimism regolith)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; TerminalTotalDifficulty is the amount of total difficulty reached by
 	&#47;&#47; the network that triggers the consensus upgrade.
 	TerminalTotalDifficulty *big.Int `json:&quot;terminalTotalDifficulty,omitempty&quot;`
<span class="term-fg36">@@ -301,6 +328,9 @@</span>
 	&#47;&#47; Various consensus engines
 	Ethash *EthashConfig `json:&quot;ethash,omitempty&quot;`
 	Clique *CliqueConfig `json:&quot;clique,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Optimism config, nil if not active</span>
<span class="term-fg32">+	Optimism *OptimismConfig `json:&quot;optimism,omitempty&quot;`</span>
 }
&nbsp;
 &#47;&#47; EthashConfig is the consensus engine configs for proof-of-work based sealing.
<span class="term-fg36">@@ -322,6 +352,17 @@</span> func (c *CliqueConfig) String() string {
 	return &quot;clique&quot;
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; OptimismConfig is the optimism config.</span>
<span class="term-fg32">+type OptimismConfig struct {</span>
<span class="term-fg32">+	EIP1559Elasticity  uint64 `json:&quot;eip1559Elasticity&quot;`</span>
<span class="term-fg32">+	EIP1559Denominator uint64 `json:&quot;eip1559Denominator&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; String implements the stringer interface, returning the optimism fee config details.</span>
<span class="term-fg32">+func (o *OptimismConfig) String() string {</span>
<span class="term-fg32">+	return &quot;optimism&quot;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Description returns a human-readable description of ChainConfig.
 func (c *ChainConfig) Description() string {
 	var banner string
<span class="term-fg36">@@ -333,6 +374,8 @@</span> 		network = &quot;unknown&quot;
 	}
 	banner += fmt.Sprintf(&quot;Chain ID:  %v (%s)\n&quot;, c.ChainID, network)
 	switch {
<span class="term-fg32">+	case c.Optimism != nil:</span>
<span class="term-fg32">+		banner += &quot;Consensus: Optimism\n&quot;</span>
 	case c.Ethash != nil:
 		if c.TerminalTotalDifficulty == nil {
 			banner += &quot;Consensus: Ethash (proof-of-work)\n&quot;
<span class="term-fg36">@@ -407,6 +450,9 @@</span> 		banner += fmt.Sprintf(&quot; - Cancun:                      @%-10v\n&quot;, *c.CancunTime)
 	}
 	if c.PragueTime != nil {
 		banner += fmt.Sprintf(&quot; - Prague:                      @%-10v\n&quot;, *c.PragueTime)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c.RegolithTime != nil {</span>
<span class="term-fg32">+		banner += fmt.Sprintf(&quot; - Regolith:                    @%-10v\n&quot;, *c.RegolithTime)</span>
 	}
 	return banner
 }
<span class="term-fg36">@@ -506,6 +552,34 @@</span> func (c *ChainConfig) IsPrague(num *big.Int, time uint64) bool {
 	return c.IsLondon(num) &amp;&amp; isTimestampForked(c.PragueTime, time)
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; IsBedrock returns whether num is either equal to the Bedrock fork block or greater.</span>
<span class="term-fg32">+func (c *ChainConfig) IsBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return isBlockForked(c.BedrockBlock, num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsRegolith(time uint64) bool {</span>
<span class="term-fg32">+	return isTimestampForked(c.RegolithTime, time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimism returns whether the node is an optimism node or not.</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimism() bool {</span>
<span class="term-fg32">+	return c.Optimism != nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimismBedrock returns true iff this is an optimism node &amp; bedrock is active</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsBedrock(num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismRegolith(time uint64) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsRegolith(time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimismPreBedrock returns true iff this is an optimism node &amp; bedrock is not yet active</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismPreBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; !c.IsBedrock(num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; CheckCompatible checks whether scheduled fork transitions have been imported
 &#47;&#47; with a mismatching chain configuration.
 func (c *ChainConfig) CheckCompatible(newcfg *ChainConfig, height uint64, time uint64) *ConfigCompatError {
<span class="term-fg36">@@ -668,11 +742,17 @@</span> }
&nbsp;
 &#47;&#47; BaseFeeChangeDenominator bounds the amount the base fee can change between blocks.
 func (c *ChainConfig) BaseFeeChangeDenominator() uint64 {
<span class="term-fg32">+	if c.Optimism != nil {</span>
<span class="term-fg32">+		return c.Optimism.EIP1559Denominator</span>
<span class="term-fg32">+	}</span>
 	return DefaultBaseFeeChangeDenominator
 }
&nbsp;
 &#47;&#47; ElasticityMultiplier bounds the maximum gas limit an EIP-1559 block may have.
 func (c *ChainConfig) ElasticityMultiplier() uint64 {
<span class="term-fg32">+	if c.Optimism != nil {</span>
<span class="term-fg32">+		return c.Optimism.EIP1559Elasticity</span>
<span class="term-fg32">+	}</span>
 	return DefaultElasticityMultiplier
 }
&nbsp;
<span class="term-fg36">@@ -808,6 +888,7 @@</span> 	IsHomestead, IsEIP150, IsEIP155, IsEIP158               bool
 	IsByzantium, IsConstantinople, IsPetersburg, IsIstanbul bool
 	IsBerlin, IsLondon                                      bool
 	IsMerge, IsShanghai, IsCancun, IsPrague                 bool
<span class="term-fg32">+	IsOptimismBedrock, IsOptimismRegolith                   bool</span>
 }
&nbsp;
 &#47;&#47; Rules ensures c&#39;s ChainID is not nil.
<span class="term-fg36">@@ -832,5 +913,8 @@</span> 		IsMerge:          isMerge,
 		IsShanghai:       c.IsShanghai(num, timestamp),
 		IsCancun:         c.IsCancun(num, timestamp),
 		IsPrague:         c.IsPrague(num, timestamp),
<span class="term-fg32">+		&#47;&#47; Optimism</span>
<span class="term-fg32">+		IsOptimismBedrock:  c.IsOptimismBedrock(num),</span>
<span class="term-fg32">+		IsOptimismRegolith: c.IsOptimismRegolith(timestamp),</span>
 	}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5e0584eed234c03089ec72d9" role="button"
                   aria-expanded="false" aria-controls="id-5e0584eed234c03089ec72d9">
                    <code>params/protocol_params.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/params/protocol_params.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/params/protocol_params.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5e0584eed234c03089ec72d9"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;protocol_params.go op-geth&#47;params&#47;protocol_params.go</span>
<span class="term-fg1">index 1fb258c1fc1ef5649858e271408a528c58694012..0b82438fd6a8297c544301abe2e73f0966fce277 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;protocol_params.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;protocol_params.go</span>
<span class="term-fg36">@@ -16,7 +16,18 @@</span> &#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.
&nbsp;
 package params
&nbsp;
<span class="term-fg31">-import &quot;math&#47;big&quot;</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; The base fee portion of the transaction fee accumulates at this predeploy</span>
<span class="term-fg32">+	OptimismBaseFeeRecipient = common.HexToAddress(&quot;0x4200000000000000000000000000000000000019&quot;)</span>
<span class="term-fg32">+	&#47;&#47; The L1 portion of the transaction fee accumulates at this predeploy</span>
<span class="term-fg32">+	OptimismL1FeeRecipient = common.HexToAddress(&quot;0x420000000000000000000000000000000000001A&quot;)</span>
<span class="term-fg32">+)</span>
&nbsp;
 const (
 	GasLimitBoundDivisor uint64 = 1024               &#47;&#47; The bound divisor of the gas limit, used in update calculations.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6a0a3e67304633e6d362acab" role="button"
                   aria-expanded="false" aria-controls="id-6a0a3e67304633e6d362acab">
                    <code>core/genesis.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/genesis.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/genesis.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+40</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6a0a3e67304633e6d362acab"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;genesis.go op-geth&#47;core&#47;genesis.go</span>
<span class="term-fg1">index 68eeec216151ffc4c39c334dcc057d32d32cdd0d..0df7a63b65a676df17cac95c6af4cb868a23aa43 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;genesis.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;genesis.go</span>
<span class="term-fg36">@@ -63,6 +63,11 @@</span> 	Number     uint64      `json:&quot;number&quot;`
 	GasUsed    uint64      `json:&quot;gasUsed&quot;`
 	ParentHash common.Hash `json:&quot;parentHash&quot;`
 	BaseFee    *big.Int    `json:&quot;baseFeePerGas&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; StateHash represents the genesis state, to allow instantiation of a chain with missing initial state.</span>
<span class="term-fg32">+	&#47;&#47; Chains with history pruning, or extraordinarily large genesis allocation (e.g. after a regenesis event)</span>
<span class="term-fg32">+	&#47;&#47; may utilize this to get started, and then state-sync the latest state, while still verifying the header chain.</span>
<span class="term-fg32">+	StateHash *common.Hash `json:&quot;stateHash,omitempty&quot;`</span>
 }
&nbsp;
 func ReadGenesis(db ethdb.Database) (*Genesis, error) {
<span class="term-fg36">@@ -268,6 +273,10 @@</span>
 &#47;&#47; ChainOverrides contains the changes to chain config.
 type ChainOverrides struct {
 	OverrideCancun *uint64
<span class="term-fg32">+	&#47;&#47; optimism</span>
<span class="term-fg32">+	OverrideOptimismBedrock  *big.Int</span>
<span class="term-fg32">+	OverrideOptimismRegolith *uint64</span>
<span class="term-fg32">+	OverrideOptimism         *bool</span>
 }
&nbsp;
 &#47;&#47; SetupGenesisBlock writes or updates the genesis block in db.
<span class="term-fg36">@@ -293,8 +302,30 @@</span> 		return params.AllEthashProtocolChanges, common.Hash{}, errGenesisNoConfig
 	}
 	applyOverrides := func(config *params.ChainConfig) {
 		if config != nil {
<span class="term-fg32">+			if config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; config.ChainID.Cmp(big.NewInt(params.OPGoerliChainID)) == 0 {</span>
<span class="term-fg32">+				&#47;&#47; Apply Optimism Goerli regolith time</span>
<span class="term-fg32">+				config.RegolithTime = &amp;params.OptimismGoerliRegolithTime</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; config.ChainID.Cmp(big.NewInt(params.BaseGoerliChainID)) == 0 {</span>
<span class="term-fg32">+				&#47;&#47; Apply Base Goerli regolith time</span>
<span class="term-fg32">+				config.RegolithTime = &amp;params.BaseGoerliRegolithTime</span>
<span class="term-fg32">+			}</span>
 			if overrides != nil &amp;&amp; overrides.OverrideCancun != nil {
 				config.CancunTime = overrides.OverrideCancun
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimismBedrock != nil {</span>
<span class="term-fg32">+				config.BedrockBlock = overrides.OverrideOptimismBedrock</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimismRegolith != nil {</span>
<span class="term-fg32">+				config.RegolithTime = overrides.OverrideOptimismRegolith</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimism != nil {</span>
<span class="term-fg32">+				if *overrides.OverrideOptimism {</span>
<span class="term-fg32">+					config.Optimism = &amp;params.OptimismConfig{</span>
<span class="term-fg32">+						EIP1559Elasticity:  10,</span>
<span class="term-fg32">+						EIP1559Denominator: 50,</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+				}</span>
 			}
 		}
 	}
<span class="term-fg36">@@ -431,8 +462,15 @@</span> }
&nbsp;
 &#47;&#47; ToBlock returns the genesis block according to genesis specification.
 func (g *Genesis) ToBlock() *types.Block {
<span class="term-fg31">-	root, err := g.Alloc.deriveHash()</span>
<span class="term-fg31">-	if err != nil {</span>
<span class="term-fg32">+	var root common.Hash</span>
<span class="term-fg32">+	var err error</span>
<span class="term-fg32">+	if g.StateHash != nil {</span>
<span class="term-fg32">+		if len(g.Alloc) &gt; 0 {</span>
<span class="term-fg32">+			panic(fmt.Errorf(&quot;cannot both have genesis hash %s &quot;+</span>
<span class="term-fg32">+				&quot;and non-empty state-allocation&quot;, *g.StateHash))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		root = *g.StateHash</span>
<span class="term-fg32">+	} else if root, err = g.Alloc.deriveHash(); err != nil {</span>
 		panic(err)
 	}
 	head := &amp;types.Header{</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-f1717d5c4614805fb826c1e6"role="button" aria-expanded="false" aria-controls="id-f1717d5c4614805fb826c1e6">
        
            <div class="col-12 col-sm-9 text-start"><h3>Chain config cleanup</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-f1717d5c4614805fb826c1e6">
        <div><p>The optimism Goerli testnet used clique-config data to make geth internals accept blocks.
Post-bedrock the beacon-consensus (i.e. follow Engine API) is now used, and the clique config is removed.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d8a140ff75b1cee37fdcd04c" role="button"
                   aria-expanded="false" aria-controls="id-d8a140ff75b1cee37fdcd04c">
                    <code>core/rawdb/accessors_metadata.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/rawdb/accessors_metadata.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/rawdb/accessors_metadata.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d8a140ff75b1cee37fdcd04c"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_metadata.go op-geth&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg1">index 2ff29d1add93938a5f76f621ce6b47af179d9aca..45ced36a4fd400cc84f60a9a9dffedd19cb7e1cf 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg36">@@ -64,6 +64,9 @@</span> 	if err := json.Unmarshal(data, &amp;config); err != nil {
 		log.Error(&quot;Invalid chain config JSON&quot;, &quot;hash&quot;, hash, &quot;err&quot;, err)
 		return nil
 	}
<span class="term-fg32">+	if config.Optimism != nil {</span>
<span class="term-fg32">+		config.Clique = nil &#47;&#47; get rid of legacy clique data in chain config (optimism goerli issue)</span>
<span class="term-fg32">+	}</span>
 	return &amp;config
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-0d28bccf1f95e3a39ac4162d"role="button" aria-expanded="false" aria-controls="id-0d28bccf1f95e3a39ac4162d">
        
            <div class="col-12 col-sm-9 text-start"><h3>Engine API modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+58</span></div>
                <div class="text-start"><span class="text-danger">-4</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-0d28bccf1f95e3a39ac4162d">
        <div><p>The Engine API is extended to insert transactions into the block and optionally exclude the tx-pool,
to reproduce the exact block of the sequencer from just the inputs, as derived from L1 by the rollup-node.
See <a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md">L2 execution engine specs</a>.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-80ae115fc6fc39181f14aef7" role="button"
                   aria-expanded="false" aria-controls="id-80ae115fc6fc39181f14aef7">
                    <code>beacon/engine/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/beacon/engine/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/beacon/engine/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-80ae115fc6fc39181f14aef7"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;types.go op-geth&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg1">index 07ebe544b438f4c0d356efc4362928c37de8062b..00128cf777744fba0aec75a29d5566ca968d20ce 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg36">@@ -34,12 +34,23 @@</span> type PayloadAttributes struct {
 	Timestamp             uint64              `json:&quot;timestamp&quot;             gencodec:&quot;required&quot;`
 	Random                common.Hash         `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 	SuggestedFeeRecipient common.Address      `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
<span class="term-fg31">-	Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`</span>
<span class="term-fg32">+	Withdrawals           []*types.Withdrawal `json:&quot;withdrawals,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Transactions is a field for rollups: the transactions list is forced into the block</span>
<span class="term-fg32">+	Transactions [][]byte `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; NoTxPool is a field for rollups: if true, the no transactions are taken out of the tx-pool,</span>
<span class="term-fg32">+	&#47;&#47; only transactions from the above Transactions list will be included.</span>
<span class="term-fg32">+	NoTxPool bool `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; GasLimit is a field for rollups: if set, this sets the exact gas limit the block produced with.</span>
<span class="term-fg32">+	GasLimit *uint64 `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 }
&nbsp;
 &#47;&#47; JSON type overrides for PayloadAttributes.
 type payloadAttributesMarshaling struct {
 	Timestamp hexutil.Uint64
<span class="term-fg32">+</span>
<span class="term-fg32">+	Transactions []hexutil.Bytes</span>
<span class="term-fg32">+	GasLimit     *hexutil.Uint64</span>
 }
&nbsp;
 &#47;&#47;go:generate go run github.com&#47;fjl&#47;gencodec -type ExecutableData -field-override executableDataMarshaling -out gen_ed.go</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-89321efc01ec31e48f293478" role="button"
                   aria-expanded="false" aria-controls="id-89321efc01ec31e48f293478">
                    <code>beacon/engine/gen_blockparams.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/beacon/engine/gen_blockparams.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/beacon/engine/gen_blockparams.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-89321efc01ec31e48f293478"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;gen_blockparams.go op-geth&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg1">index 0dd2b52597ad5ddc7fc46d97c6c8878edf29d471..0a76475841a12886ef2f9eaadba0172f2708d2b4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg36">@@ -19,13 +19,24 @@</span> 	type PayloadAttributes struct {
 		Timestamp             hexutil.Uint64      `json:&quot;timestamp&quot;             gencodec:&quot;required&quot;`
 		Random                common.Hash         `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 		SuggestedFeeRecipient common.Address      `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
<span class="term-fg31">-		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`</span>
<span class="term-fg32">+		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		Transactions          []hexutil.Bytes     `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		NoTxPool              bool                `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		GasLimit              *hexutil.Uint64     `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 	}
 	var enc PayloadAttributes
 	enc.Timestamp = hexutil.Uint64(p.Timestamp)
 	enc.Random = p.Random
 	enc.SuggestedFeeRecipient = p.SuggestedFeeRecipient
 	enc.Withdrawals = p.Withdrawals
<span class="term-fg32">+	if p.Transactions != nil {</span>
<span class="term-fg32">+		enc.Transactions = make([]hexutil.Bytes, len(p.Transactions))</span>
<span class="term-fg32">+		for k, v := range p.Transactions {</span>
<span class="term-fg32">+			enc.Transactions[k] = v</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	enc.NoTxPool = p.NoTxPool</span>
<span class="term-fg32">+	enc.GasLimit = (*hexutil.Uint64)(p.GasLimit)</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -35,7 +46,10 @@</span> 	type PayloadAttributes struct {
 		Timestamp             *hexutil.Uint64     `json:&quot;timestamp&quot;             gencodec:&quot;required&quot;`
 		Random                *common.Hash        `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 		SuggestedFeeRecipient *common.Address     `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
<span class="term-fg31">-		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`</span>
<span class="term-fg32">+		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		Transactions          []hexutil.Bytes     `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		NoTxPool              *bool               `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		GasLimit              *hexutil.Uint64     `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 	}
 	var dec PayloadAttributes
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -55,6 +69,18 @@</span> 	}
 	p.SuggestedFeeRecipient = *dec.SuggestedFeeRecipient
 	if dec.Withdrawals != nil {
 		p.Withdrawals = dec.Withdrawals
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.Transactions != nil {</span>
<span class="term-fg32">+		p.Transactions = make([][]byte, len(dec.Transactions))</span>
<span class="term-fg32">+		for k, v := range dec.Transactions {</span>
<span class="term-fg32">+			p.Transactions[k] = v</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.NoTxPool != nil {</span>
<span class="term-fg32">+		p.NoTxPool = *dec.NoTxPool</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.GasLimit != nil {</span>
<span class="term-fg32">+		p.GasLimit = (*uint64)(dec.GasLimit)</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d816887509e9eb5dd8f6fd7f" role="button"
                   aria-expanded="false" aria-controls="id-d816887509e9eb5dd8f6fd7f">
                    <code>eth/catalyst/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/catalyst/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/catalyst/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+18</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d816887509e9eb5dd8f6fd7f"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;api.go op-geth&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg1">index 456bd7741327f33c5a98b6545b853224a9c0f3b7..b1b5b5d072384fbc4e84e667d5d8035458069119 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg36">@@ -144,6 +144,9 @@</span> 		invalidBlocksHits: make(map[common.Hash]int),
 		invalidTipsets:    make(map[common.Hash]*types.Header),
 	}
 	eth.Downloader().SetBadBlockCallback(api.setInvalidAncestor)
<span class="term-fg32">+	if api.eth.BlockChain().Config().Optimism != nil { &#47;&#47; don&#39;t start the api heartbeat, there is no transition</span>
<span class="term-fg32">+		return api</span>
<span class="term-fg32">+	}</span>
 	go api.heartbeat()
&nbsp;
 	return api
<span class="term-fg36">@@ -293,7 +296,7 @@</span> 	} else if api.eth.BlockChain().CurrentBlock().Hash() == update.HeadBlockHash {
 		&#47;&#47; If the specified head matches with our local head, do nothing and keep
 		&#47;&#47; generating the payload. It&#39;s a special corner case that a few slots are
 		&#47;&#47; missing and we are requested to generate the payload in slot.
<span class="term-fg31">-	} else {</span>
<span class="term-fg32">+	} else if api.eth.BlockChain().Config().Optimism == nil { &#47;&#47; minor Engine API divergence: allow proposers to reorg their own chain</span>
 		&#47;&#47; If the head block is already in our canonical chain, the beacon client is
 		&#47;&#47; probably resyncing. Ignore the update.
 		log.Info(&quot;Ignoring beacon update to old head&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, update.HeadBlockHash, &quot;age&quot;, common.PrettyAge(time.Unix(int64(block.Time()), 0)), &quot;have&quot;, api.eth.BlockChain().CurrentBlock().Number)
<span class="term-fg36">@@ -337,12 +340,26 @@</span> 	&#47;&#47; If payload generation was requested, create a new block to be potentially
 	&#47;&#47; sealed by the beacon client. The payload will be requested later, and we
 	&#47;&#47; will replace it arbitrarily many times in between.
 	if payloadAttributes != nil {
<span class="term-fg32">+		if api.eth.BlockChain().Config().Optimism != nil &amp;&amp; payloadAttributes.GasLimit == nil {</span>
<span class="term-fg32">+			return engine.STATUS_INVALID, engine.InvalidPayloadAttributes.With(errors.New(&quot;gasLimit parameter is required&quot;))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		transactions := make(types.Transactions, 0, len(payloadAttributes.Transactions))</span>
<span class="term-fg32">+		for i, otx := range payloadAttributes.Transactions {</span>
<span class="term-fg32">+			var tx types.Transaction</span>
<span class="term-fg32">+			if err := tx.UnmarshalBinary(otx); err != nil {</span>
<span class="term-fg32">+				return engine.STATUS_INVALID, fmt.Errorf(&quot;transaction %d is not valid: %v&quot;, i, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			transactions = append(transactions, &amp;tx)</span>
<span class="term-fg32">+		}</span>
 		args := &amp;miner.BuildPayloadArgs{
 			Parent:       update.HeadBlockHash,
 			Timestamp:    payloadAttributes.Timestamp,
 			FeeRecipient: payloadAttributes.SuggestedFeeRecipient,
 			Random:       payloadAttributes.Random,
 			Withdrawals:  payloadAttributes.Withdrawals,
<span class="term-fg32">+			NoTxPool:     payloadAttributes.NoTxPool,</span>
<span class="term-fg32">+			Transactions: transactions,</span>
<span class="term-fg32">+			GasLimit:     payloadAttributes.GasLimit,</span>
 		}
 		id := args.Id()
 		&#47;&#47; If we already are busy generating this work, then we do not need</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-798b8108017508ce872766c2"role="button" aria-expanded="false" aria-controls="id-798b8108017508ce872766c2">
        
            <div class="col-12 col-sm-9 text-start"><h3>Block-building modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+105</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-798b8108017508ce872766c2">
        <div><p>The block-building code (in the &ldquo;miner&rdquo; package because of Proof-Of-Work legacy of ethereum) implements the
changes to support the transaction-inclusion, tx-pool toggle and gaslimit parameters of the Engine API.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8cd0d06e26c5cfae596b7ff9" role="button"
                   aria-expanded="false" aria-controls="id-8cd0d06e26c5cfae596b7ff9">
                    <code>miner/miner.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/miner/miner.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/miner/miner.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+8</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8cd0d06e26c5cfae596b7ff9"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;miner.go op-geth&#47;miner&#47;miner.go</span>
<span class="term-fg1">index b1d1f7c4cbfe2a9b34f4f68ce345e0d09f209d9c..0c651042a2e31d8330ecf6be91cb2c662806d95b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;miner.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;miner.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> &#47;&#47; Package miner implements Ethereum block creation and mining.
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;sync&quot;
<span class="term-fg36">@@ -31,6 +32,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -43,6 +45,10 @@</span> 	BlockChain() *core.BlockChain
 	TxPool() *txpool.TxPool
 }
&nbsp;
<span class="term-fg32">+type BackendWithHistoricalState interface {</span>
<span class="term-fg32">+	StateAtBlock(ctx context.Context, block *types.Block, reexec uint64, base *state.StateDB, readOnly bool, preferDisk bool) (*state.StateDB, tracers.StateReleaseFunc, error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Config is the configuration parameters of mining.
 type Config struct {
 	Etherbase common.Address `toml:&quot;,omitempty&quot;` &#47;&#47; Public address for block mining rewards
<span class="term-fg36">@@ -53,6 +59,8 @@</span> 	GasPrice  *big.Int       &#47;&#47; Minimum gas price for mining a transaction
 	Recommit  time.Duration  &#47;&#47; The time interval for miner to re-create mining work.
&nbsp;
 	NewPayloadTimeout time.Duration &#47;&#47; The maximum time allowance for creating a new payload
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupComputePendingBlock bool &#47;&#47; Compute the pending block from tx-pool, instead of copying the latest-block</span>
 }
&nbsp;
 &#47;&#47; DefaultConfig contains default settings for miner.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c983630f1cde61f3802453b0" role="button"
                   aria-expanded="false" aria-controls="id-c983630f1cde61f3802453b0">
                    <code>miner/payload_building.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/miner/payload_building.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/miner/payload_building.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+22</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c983630f1cde61f3802453b0"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;payload_building.go op-geth&#47;miner&#47;payload_building.go</span>
<span class="term-fg1">index f84d908e86d68dbb132e2cd75ba5e21887fc018c..26e89eef31cab52754e0a41bb540639b4f58067f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;payload_building.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;payload_building.go</span>
<span class="term-fg36">@@ -40,6 +40,10 @@</span> 	Timestamp    uint64            &#47;&#47; The provided timestamp of generated payload
 	FeeRecipient common.Address    &#47;&#47; The provided recipient address for collecting transaction fee
 	Random       common.Hash       &#47;&#47; The provided randomness value
 	Withdrawals  types.Withdrawals &#47;&#47; The provided withdrawals
<span class="term-fg32">+</span>
<span class="term-fg32">+	NoTxPool     bool                 &#47;&#47; Optimism addition: option to disable tx pool contents from being included</span>
<span class="term-fg32">+	Transactions []*types.Transaction &#47;&#47; Optimism addition: txs forced into the block via engine API</span>
<span class="term-fg32">+	GasLimit     *uint64              &#47;&#47; Optimism addition: override gas limit of the block to build</span>
 }
&nbsp;
 &#47;&#47; Id computes an 8-byte identifier by hashing the components of the payload arguments.
<span class="term-fg36">@@ -51,6 +55,19 @@</span> 	binary.Write(hasher, binary.BigEndian, args.Timestamp)
 	hasher.Write(args.Random[:])
 	hasher.Write(args.FeeRecipient[:])
 	rlp.Encode(hasher, args.Withdrawals)
<span class="term-fg32">+</span>
<span class="term-fg32">+	if args.NoTxPool || len(args.Transactions) &gt; 0 { &#47;&#47; extend if extra payload attributes are used</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, args.NoTxPool)</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, uint64(len(args.Transactions)))</span>
<span class="term-fg32">+		for _, tx := range args.Transactions {</span>
<span class="term-fg32">+			h := tx.Hash()</span>
<span class="term-fg32">+			hasher.Write(h[:])</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if args.GasLimit != nil {</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, *args.GasLimit)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var out engine.PayloadID
 	copy(out[:], hasher.Sum(nil)[:8])
 	return out
<span class="term-fg36">@@ -156,12 +173,15 @@</span> func (w *worker) buildPayload(args *BuildPayloadArgs) (*Payload, error) {
 	&#47;&#47; Build the initial version with no transaction included. It should be fast
 	&#47;&#47; enough to run. The empty payload can at least make sure there is something
 	&#47;&#47; to deliver for not missing slot.
<span class="term-fg31">-	empty, _, err := w.getSealingBlock(args.Parent, args.Timestamp, args.FeeRecipient, args.Random, args.Withdrawals, true)</span>
<span class="term-fg32">+	empty, _, err := w.getSealingBlock(args.Parent, args.Timestamp, args.FeeRecipient, args.Random, args.Withdrawals, true, args.Transactions, args.GasLimit)</span>
 	if err != nil {
 		return nil, err
 	}
 	&#47;&#47; Construct a payload object for return.
 	payload := newPayload(empty, args.Id())
<span class="term-fg32">+	if args.NoTxPool { &#47;&#47; don&#39;t start the background payload updating job if there is no tx pool to pull from</span>
<span class="term-fg32">+		return payload, nil</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Spin up a routine for updating the payload in background. This strategy
 	&#47;&#47; can maximum the revenue for including transactions with highest fee.
<span class="term-fg36">@@ -180,7 +200,7 @@</span> 		for {
 			select {
 			case &lt;-timer.C:
 				start := time.Now()
<span class="term-fg31">-				block, fees, err := w.getSealingBlock(args.Parent, args.Timestamp, args.FeeRecipient, args.Random, args.Withdrawals, false)</span>
<span class="term-fg32">+				block, fees, err := w.getSealingBlock(args.Parent, args.Timestamp, args.FeeRecipient, args.Random, args.Withdrawals, false, args.Transactions, args.GasLimit)</span>
 				if err == nil {
 					payload.update(block, fees, time.Since(start))
 				}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4ef4c57f1c654c16e95ca192" role="button"
                   aria-expanded="false" aria-controls="id-4ef4c57f1c654c16e95ca192">
                    <code>miner/worker.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/miner/worker.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/miner/worker.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+71</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4ef4c57f1c654c16e95ca192"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;worker.go op-geth&#47;miner&#47;worker.go</span>
<span class="term-fg1">index 936a9e74a5b6d6ff68c76a399424ca0fa61f7909..59a2d5c2b98c01a9af22f283c27628b8bbcd9a31 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;worker.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;worker.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg36">@@ -31,6 +32,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -59,7 +61,7 @@</span> 	sealingLogAtDepth = 7
&nbsp;
 	&#47;&#47; minRecommitInterval is the minimal time interval to recreate the sealing block with
 	&#47;&#47; any newly arrived transactions.
<span class="term-fg31">-	minRecommitInterval = 1 * time.Second</span>
<span class="term-fg32">+	minRecommitInterval = 100 * time.Millisecond</span>
&nbsp;
 	&#47;&#47; maxRecommitInterval is the maximum time interval to recreate the sealing block with
 	&#47;&#47; any newly arrived transactions.
<span class="term-fg36">@@ -382,6 +384,9 @@</span> }
&nbsp;
 &#47;&#47; pending returns the pending state and corresponding block.
 func (w *worker) pending() (*types.Block, *state.StateDB) {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		return nil, nil &#47;&#47; when not computing the pending block, there is never a pending state</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; return a snapshot to avoid contention on currentMu mutex
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
<span class="term-fg36">@@ -393,6 +398,12 @@</span> }
&nbsp;
 &#47;&#47; pendingBlock returns pending block.
 func (w *worker) pendingBlock() *types.Block {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		&#47;&#47; For compatibility when not computing a pending block, we serve the latest block as &quot;pending&quot;</span>
<span class="term-fg32">+		headHeader := w.eth.BlockChain().CurrentHeader()</span>
<span class="term-fg32">+		headBlock := w.eth.BlockChain().GetBlock(headHeader.Hash(), headHeader.Number.Uint64())</span>
<span class="term-fg32">+		return headBlock</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; return a snapshot to avoid contention on currentMu mutex
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
<span class="term-fg36">@@ -401,6 +412,9 @@</span> }
&nbsp;
 &#47;&#47; pendingBlockAndReceipts returns pending block and corresponding receipts.
 func (w *worker) pendingBlockAndReceipts() (*types.Block, types.Receipts) {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		return nil, nil &#47;&#47; when not computing the pending block, there are no pending receipts, and thus no pending logs</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; return a snapshot to avoid contention on currentMu mutex
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
<span class="term-fg36">@@ -456,6 +470,19 @@</span>
 &#47;&#47; newWorkLoop is a standalone goroutine to submit new sealing work upon received events.
 func (w *worker) newWorkLoop(recommit time.Duration) {
 	defer w.wg.Done()
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		for { &#47;&#47; do not update the pending-block, instead drain work without doing it, to keep producers from blocking.</span>
<span class="term-fg32">+			select {</span>
<span class="term-fg32">+			case &lt;-w.startCh:</span>
<span class="term-fg32">+			case &lt;-w.chainHeadCh:</span>
<span class="term-fg32">+			case &lt;-w.resubmitIntervalCh:</span>
<span class="term-fg32">+			case &lt;-w.resubmitAdjustCh:</span>
<span class="term-fg32">+			case &lt;-w.exitCh:</span>
<span class="term-fg32">+				return</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var (
 		interrupt   *atomic.Int32
 		minRecommit = recommit &#47;&#47; minimal resubmit interval specified by user.
<span class="term-fg36">@@ -618,6 +645,9 @@</span> 				}
 			}
&nbsp;
 		case ev := &lt;-w.txsCh:
<span class="term-fg32">+			if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+				continue &#47;&#47; don&#39;t update the pending-block snapshot if we are not computing the pending block</span>
<span class="term-fg32">+			}</span>
 			&#47;&#47; Apply transactions to the pending state if we&#39;re not sealing
 			&#47;&#47;
 			&#47;&#47; Note all transactions received may not be continuous with transactions
<span class="term-fg36">@@ -794,6 +824,15 @@</span> func (w *worker) makeEnv(parent *types.Header, header *types.Header, coinbase common.Address) (*environment, error) {
 	&#47;&#47; Retrieve the parent state to execute on top and start a prefetcher for
 	&#47;&#47; the miner to speed block sealing up a bit.
 	state, err := w.chain.StateAt(parent.Root)
<span class="term-fg32">+	if err != nil &amp;&amp; w.chainConfig.Optimism != nil { &#47;&#47; Allow the miner to reorg its own chain arbitrarily deep</span>
<span class="term-fg32">+		if historicalBackend, ok := w.eth.(BackendWithHistoricalState); ok {</span>
<span class="term-fg32">+			var release tracers.StateReleaseFunc</span>
<span class="term-fg32">+			parentBlock := w.eth.BlockChain().GetBlockByHash(parent.Hash())</span>
<span class="term-fg32">+			state, release, err = historicalBackend.StateAtBlock(context.Background(), parentBlock, ^uint64(0), nil, false, false)</span>
<span class="term-fg32">+			state = state.Copy()</span>
<span class="term-fg32">+			release()</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -964,6 +1003,9 @@</span> 	random      common.Hash       &#47;&#47; The randomness generated by beacon chain, empty before the merge
 	withdrawals types.Withdrawals &#47;&#47; List of withdrawals to include in block.
 	noUncle     bool              &#47;&#47; Flag whether the uncle block inclusion is allowed
 	noTxs       bool              &#47;&#47; Flag whether an empty block without any transaction is expected
<span class="term-fg32">+</span>
<span class="term-fg32">+	txs      types.Transactions &#47;&#47; Deposit transactions to include at the start of the block</span>
<span class="term-fg32">+	gasLimit *uint64            &#47;&#47; Optional gas limit override</span>
 }
&nbsp;
 &#47;&#47; prepareWork constructs the sealing task according to the given parameters,
<span class="term-fg36">@@ -1000,7 +1042,7 @@</span> 		Time:       timestamp,
 		Coinbase:   genParams.coinbase,
 	}
 	&#47;&#47; Set the extra field.
<span class="term-fg31">-	if len(w.extra) != 0 {</span>
<span class="term-fg32">+	if len(w.extra) != 0 &amp;&amp; w.chainConfig.Optimism == nil { &#47;&#47; Optimism chains must not set any extra data.</span>
 		header.Extra = w.extra
 	}
 	&#47;&#47; Set the randomness field from the beacon chain if it&#39;s available.
<span class="term-fg36">@@ -1015,6 +1057,12 @@</span> 			parentGasLimit := parent.GasLimit * w.chainConfig.ElasticityMultiplier()
 			header.GasLimit = core.CalcGasLimit(parentGasLimit, w.config.GasCeil)
 		}
 	}
<span class="term-fg32">+	if genParams.gasLimit != nil { &#47;&#47; override gas limit if specified</span>
<span class="term-fg32">+		header.GasLimit = *genParams.gasLimit</span>
<span class="term-fg32">+	} else if w.chain.Config().Optimism != nil &amp;&amp; w.config.GasCeil != 0 {</span>
<span class="term-fg32">+		&#47;&#47; configure the gas limit of pending blocks with the miner gas limit config when using optimism</span>
<span class="term-fg32">+		header.GasLimit = w.config.GasCeil</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Run the consensus preparation with the default or customized consensus engine.
 	if err := w.engine.Prepare(w.chain, header); err != nil {
 		log.Error(&quot;Failed to prepare header for sealing&quot;, &quot;err&quot;, err)
<span class="term-fg36">@@ -1079,14 +1127,28 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; generateWork generates a sealing block based on the given parameters.
<span class="term-fg31">-func (w *worker) generateWork(params *generateParams) (*types.Block, *big.Int, error) {</span>
<span class="term-fg31">-	work, err := w.prepareWork(params)</span>
<span class="term-fg32">+func (w *worker) generateWork(genParams *generateParams) (*types.Block, *big.Int, error) {</span>
<span class="term-fg32">+	work, err := w.prepareWork(genParams)</span>
 	if err != nil {
 		return nil, nil, err
 	}
 	defer work.discard()
<span class="term-fg32">+	if work.gasPool == nil {</span>
<span class="term-fg32">+		work.gasPool = new(core.GasPool).AddGas(work.header.GasLimit)</span>
<span class="term-fg32">+	}</span>
&nbsp;
<span class="term-fg31">-	if !params.noTxs {</span>
<span class="term-fg32">+	for _, tx := range genParams.txs {</span>
<span class="term-fg32">+		from, _ := types.Sender(work.signer, tx)</span>
<span class="term-fg32">+		work.state.SetTxContext(tx.Hash(), work.tcount)</span>
<span class="term-fg32">+		_, err := w.commitTransaction(work, tx)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, nil, fmt.Errorf(&quot;failed to force-include tx: %s type: %d sender: %s nonce: %d, err: %w&quot;, tx.Hash(), tx.Type(), from, tx.Nonce(), err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		work.tcount++</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; forced transactions done, fill rest of block with transactions</span>
<span class="term-fg32">+	if !genParams.noTxs {</span>
 		interrupt := new(atomic.Int32)
 		timer := time.AfterFunc(w.newpayloadTimeout, func() {
 			interrupt.Store(commitInterruptTimeout)
<span class="term-fg36">@@ -1098,7 +1160,7 @@</span> 		if errors.Is(err, errBlockInterruptedByTimeout) {
 			log.Warn(&quot;Block building is interrupted&quot;, &quot;allowance&quot;, common.PrettyDuration(w.newpayloadTimeout))
 		}
 	}
<span class="term-fg31">-	block, err := w.engine.FinalizeAndAssemble(w.chain, work.header, work.state, work.txs, work.unclelist(), work.receipts, params.withdrawals)</span>
<span class="term-fg32">+	block, err := w.engine.FinalizeAndAssemble(w.chain, work.header, work.state, work.txs, work.unclelist(), work.receipts, genParams.withdrawals)</span>
 	if err != nil {
 		return nil, nil, err
 	}
<span class="term-fg36">@@ -1215,7 +1277,7 @@</span>
 &#47;&#47; getSealingBlock generates the sealing block based on the given parameters.
 &#47;&#47; The generation result will be passed back via the given channel no matter
 &#47;&#47; the generation itself succeeds or not.
<span class="term-fg31">-func (w *worker) getSealingBlock(parent common.Hash, timestamp uint64, coinbase common.Address, random common.Hash, withdrawals types.Withdrawals, noTxs bool) (*types.Block, *big.Int, error) {</span>
<span class="term-fg32">+func (w *worker) getSealingBlock(parent common.Hash, timestamp uint64, coinbase common.Address, random common.Hash, withdrawals types.Withdrawals, noTxs bool, transactions types.Transactions, gasLimit *uint64) (*types.Block, *big.Int, error) {</span>
 	req := &amp;getWorkReq{
 		params: &amp;generateParams{
 			timestamp:   timestamp,
<span class="term-fg36">@@ -1226,6 +1288,8 @@</span> 			random:      random,
 			withdrawals: withdrawals,
 			noUncle:     true,
 			noTxs:       noTxs,
<span class="term-fg32">+			txs:         transactions,</span>
<span class="term-fg32">+			gasLimit:    gasLimit,</span>
 		},
 		result: make(chan *newPayloadResult, 1),
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bd19f1e0f3085d7c5b106098" role="button"
                   aria-expanded="false" aria-controls="id-bd19f1e0f3085d7c5b106098">
                    <code>miner/worker_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/miner/worker_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/miner/worker_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bd19f1e0f3085d7c5b106098"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;worker_test.go op-geth&#47;miner&#47;worker_test.go</span>
<span class="term-fg1">index 683d019d2d551b9abd3f1453fb885925122fe876..34851e8e750e447cd27ec2d988766d959ef7d283 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;worker_test.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;worker_test.go</span>
<span class="term-fg36">@@ -472,7 +472,8 @@</span> 			min := float64(3 * time.Second.Nanoseconds())
 			estimate = estimate*(1-intervalAdjustRatio) + intervalAdjustRatio*(min-intervalAdjustBias)
 			wantMinInterval, wantRecommitInterval = 3*time.Second, time.Duration(estimate)*time.Nanosecond
 		case 3:
<span class="term-fg31">-			wantMinInterval, wantRecommitInterval = time.Second, time.Second</span>
<span class="term-fg32">+			&#47;&#47; lower than upstream test, since enforced min recommit interval is lower</span>
<span class="term-fg32">+			wantMinInterval, wantRecommitInterval = 500*time.Millisecond, 500*time.Millisecond</span>
 		}
&nbsp;
 		&#47;&#47; Check interval
<span class="term-fg36">@@ -631,7 +632,7 @@</span> 	}
&nbsp;
 	&#47;&#47; This API should work even when the automatic sealing is not enabled
 	for _, c := range cases {
<span class="term-fg31">-		block, _, err := w.getSealingBlock(c.parent, timestamp, c.coinbase, c.random, nil, false)</span>
<span class="term-fg32">+		block, _, err := w.getSealingBlock(c.parent, timestamp, c.coinbase, c.random, nil, false, nil, nil)</span>
 		if c.expectErr {
 			if err == nil {
 				t.Error(&quot;Expect error but get nil&quot;)
<span class="term-fg36">@@ -647,7 +648,7 @@</span>
 	&#47;&#47; This API should work even when the automatic sealing is enabled
 	w.start()
 	for _, c := range cases {
<span class="term-fg31">-		block, _, err := w.getSealingBlock(c.parent, timestamp, c.coinbase, c.random, nil, false)</span>
<span class="term-fg32">+		block, _, err := w.getSealingBlock(c.parent, timestamp, c.coinbase, c.random, nil, false, nil, nil)</span>
 		if c.expectErr {
 			if err == nil {
 				t.Error(&quot;Expect error but get nil&quot;)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-68eca167265c73fab1ea614e"role="button" aria-expanded="false" aria-controls="id-68eca167265c73fab1ea614e">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tx-pool tx cost updates</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+123</span></div>
                <div class="text-start"><span class="text-danger">-19</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-68eca167265c73fab1ea614e">
        <div><p>Transaction queueing and inclusion needs to account for the L1 cost component.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4b81832d7350e21754409445" role="button"
                   aria-expanded="false" aria-controls="id-4b81832d7350e21754409445">
                    <code>core/txpool/txpool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/txpool/txpool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/txpool/txpool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+93</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4b81832d7350e21754409445"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;txpool.go op-geth&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg1">index cbb8cc287a036878fef53785f9f63e301f63df17..d8e40d7972d4f97099ff02cfa27c548e581d772c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg36">@@ -100,6 +100,11 @@</span>
 var (
 	evictionInterval    = time.Minute     &#47;&#47; Time interval to check for evictable transactions
 	statsReportInterval = 8 * time.Second &#47;&#47; Time interval to report transaction pool stats
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; L1 Info Gas Overhead is the amount of gas the the L1 info deposit consumes.</span>
<span class="term-fg32">+	&#47;&#47; It is removed from the tx pool max gas to better indicate that L2 transactions</span>
<span class="term-fg32">+	&#47;&#47; are not able to consume all of the gas in a L2 block as the L1 info deposit is always present.</span>
<span class="term-fg32">+	l1InfoGasOverhead = uint64(70_000)</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -167,6 +172,10 @@</span> 	NoLocals  bool             &#47;&#47; Whether local transaction handling should be disabled
 	Journal   string           &#47;&#47; Journal of local transactions to survive node restarts
 	Rejournal time.Duration    &#47;&#47; Time interval to regenerate the local transaction journal
&nbsp;
<span class="term-fg32">+	&#47;&#47; JournalRemote controls whether journaling includes remote transactions or not.</span>
<span class="term-fg32">+	&#47;&#47; When true, all transactions loaded from the journal are treated as remote.</span>
<span class="term-fg32">+	JournalRemote bool</span>
<span class="term-fg32">+</span>
 	PriceLimit uint64 &#47;&#47; Minimum gas price to enforce for acceptance into the pool
 	PriceBump  uint64 &#47;&#47; Minimum price bump percentage to replace an already existing transaction (nonce)
&nbsp;
<span class="term-fg36">@@ -260,6 +269,8 @@</span> 	currentState  *state.StateDB &#47;&#47; Current state in the blockchain head
 	pendingNonces *noncer        &#47;&#47; Pending state tracking virtual nonces
 	currentMaxGas atomic.Uint64  &#47;&#47; Current gas limit for transaction caps
&nbsp;
<span class="term-fg32">+	l1CostFn func(dataGas types.RollupGasData, isDepositTx bool) *big.Int &#47;&#47; Current L1 fee cost function</span>
<span class="term-fg32">+</span>
 	locals  *accountSet &#47;&#47; Set of local transaction to exempt from eviction rules
 	journal *journal    &#47;&#47; Journal of local transaction to back up to disk
&nbsp;
<span class="term-fg36">@@ -323,14 +334,18 @@</span> 	&#47;&#47; Start the reorg loop early so it can handle requests generated during journal loading.
 	pool.wg.Add(1)
 	go pool.scheduleReorgLoop()
&nbsp;
<span class="term-fg31">-	&#47;&#47; If local transactions and journaling is enabled, load from disk</span>
<span class="term-fg31">-	if !config.NoLocals &amp;&amp; config.Journal != &quot;&quot; {</span>
<span class="term-fg32">+	&#47;&#47; If journaling is enabled and has transactions to journal, load from disk</span>
<span class="term-fg32">+	if (!config.NoLocals || config.JournalRemote) &amp;&amp; config.Journal != &quot;&quot; {</span>
 		pool.journal = newTxJournal(config.Journal)
&nbsp;
<span class="term-fg31">-		if err := pool.journal.load(pool.AddLocals); err != nil {</span>
<span class="term-fg32">+		add := pool.AddLocals</span>
<span class="term-fg32">+		if config.JournalRemote {</span>
<span class="term-fg32">+			add = pool.AddRemotesSync &#47;&#47; Use sync version to match pool.AddLocals</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if err := pool.journal.load(add); err != nil {</span>
 			log.Warn(&quot;Failed to load transaction journal&quot;, &quot;err&quot;, err)
 		}
<span class="term-fg31">-		if err := pool.journal.rotate(pool.local()); err != nil {</span>
<span class="term-fg32">+		if err := pool.journal.rotate(pool.toJournal()); err != nil {</span>
 			log.Warn(&quot;Failed to rotate transaction journal&quot;, &quot;err&quot;, err)
 		}
 	}
<span class="term-fg36">@@ -413,7 +428,7 @@</span> 		&#47;&#47; Handle local transaction journal rotation
 		case &lt;-journal.C:
 			if pool.journal != nil {
 				pool.mu.Lock()
<span class="term-fg31">-				if err := pool.journal.rotate(pool.local()); err != nil {</span>
<span class="term-fg32">+				if err := pool.journal.rotate(pool.toJournal()); err != nil {</span>
 					log.Warn(&quot;Failed to rotate local tx journal&quot;, &quot;err&quot;, err)
 				}
 				pool.mu.Unlock()
<span class="term-fg36">@@ -593,11 +608,34 @@</span> 	}
 	return txs
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; toJournal retrieves all transactions that should be included in the journal,</span>
<span class="term-fg32">+&#47;&#47; grouped by origin account and sorted by nonce.</span>
<span class="term-fg32">+&#47;&#47; The returned transaction set is a copy and can be freely modified by calling code.</span>
<span class="term-fg32">+func (pool *TxPool) toJournal() map[common.Address]types.Transactions {</span>
<span class="term-fg32">+	if !pool.config.JournalRemote {</span>
<span class="term-fg32">+		return pool.local()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	txs := make(map[common.Address]types.Transactions)</span>
<span class="term-fg32">+	for addr, pending := range pool.pending {</span>
<span class="term-fg32">+		txs[addr] = append(txs[addr], pending.Flatten()...)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for addr, queued := range pool.queue {</span>
<span class="term-fg32">+		txs[addr] = append(txs[addr], queued.Flatten()...)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return txs</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; validateTxBasics checks whether a transaction is valid according to the consensus
 &#47;&#47; rules, but does not check state-dependent validation such as sufficient balance.
 &#47;&#47; This check is meant as an early check which only needs to be performed once,
 &#47;&#47; and does not require the pool mutex to be held.
 func (pool *TxPool) validateTxBasics(tx *types.Transaction, local bool) error {
<span class="term-fg32">+	&#47;&#47; No unauthenticated deposits allowed in the transaction pool.</span>
<span class="term-fg32">+	&#47;&#47; This is for spam protection, not consensus,</span>
<span class="term-fg32">+	&#47;&#47; as the external engine-API user authenticates deposits.</span>
<span class="term-fg32">+	if tx.Type() == types.DepositTxType {</span>
<span class="term-fg32">+		return core.ErrTxTypeNotSupported</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Accept only legacy transactions until EIP-2718&#47;2930 activates.
 	if !pool.eip2718.Load() &amp;&amp; tx.Type() != types.LegacyTxType {
 		return core.ErrTxTypeNotSupported
<span class="term-fg36">@@ -668,18 +706,26 @@</span> 		return core.ErrNonceTooLow
 	}
 	&#47;&#47; Transactor should have enough funds to cover the costs
 	&#47;&#47; cost == V + GP * GL
<span class="term-fg32">+	cost := tx.Cost()</span>
<span class="term-fg32">+	if l1Cost := pool.l1CostFn(tx.RollupDataGas(), tx.IsDepositTx()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+		cost = cost.Add(cost, l1Cost)</span>
<span class="term-fg32">+	}</span>
 	balance := pool.currentState.GetBalance(from)
<span class="term-fg31">-	if balance.Cmp(tx.Cost()) &lt; 0 {</span>
<span class="term-fg32">+	if balance.Cmp(cost) &lt; 0 {</span>
 		return core.ErrInsufficientFunds
 	}
&nbsp;
 	&#47;&#47; Verify that replacing transactions will not result in overdraft
 	list := pool.pending[from]
 	if list != nil { &#47;&#47; Sender already has pending txs
<span class="term-fg31">-		sum := new(big.Int).Add(tx.Cost(), list.totalcost)</span>
<span class="term-fg32">+		sum := new(big.Int).Add(cost, list.totalcost)</span>
 		if repl := list.txs.Get(tx.Nonce()); repl != nil {
 			&#47;&#47; Deduct the cost of a transaction replaced by this
<span class="term-fg31">-			sum.Sub(sum, repl.Cost())</span>
<span class="term-fg32">+			replL1Cost := repl.Cost()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(tx.RollupDataGas(), tx.IsDepositTx()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+				replL1Cost = replL1Cost.Add(cost, l1Cost)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			sum.Sub(sum, replL1Cost)</span>
 		}
 		if balance.Cmp(sum) &lt; 0 {
 			log.Trace(&quot;Replacing transactions would overdraft&quot;, &quot;sender&quot;, from, &quot;balance&quot;, pool.currentState.GetBalance(from), &quot;required&quot;, sum)
<span class="term-fg36">@@ -887,7 +933,7 @@</span> &#47;&#47; journalTx adds the specified transaction to the local disk journal if it is
 &#47;&#47; deemed to have been sent from a local account.
 func (pool *TxPool) journalTx(from common.Address, tx *types.Transaction) {
 	&#47;&#47; Only journal if it&#39;s enabled and the transaction is local
<span class="term-fg31">-	if pool.journal == nil || !pool.locals.contains(from) {</span>
<span class="term-fg32">+	if pool.journal == nil || (!pool.config.JournalRemote &amp;&amp; !pool.locals.contains(from)) {</span>
 		return
 	}
 	if err := pool.journal.insert(tx); err != nil {
<span class="term-fg36">@@ -1370,6 +1416,16 @@</span> 						log.Error(&quot;Unrooted new chain seen by tx pool&quot;, &quot;block&quot;, newHead.Number, &quot;hash&quot;, newHead.Hash())
 						return
 					}
 				}
<span class="term-fg32">+				&#47;&#47; Do not insert deposit txs back into the pool</span>
<span class="term-fg32">+				&#47;&#47; (validateTx would still catch it if not filtered, but no need to re-inject in the first place).</span>
<span class="term-fg32">+				j := 0</span>
<span class="term-fg32">+				for _, tx := range discarded {</span>
<span class="term-fg32">+					if tx.Type() != types.DepositTxType {</span>
<span class="term-fg32">+						discarded[j] = tx</span>
<span class="term-fg32">+						j++</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+				discarded = discarded[:j]</span>
 				reinject = types.TxDifference(discarded, included)
 			}
 		}
<span class="term-fg36">@@ -1385,7 +1441,16 @@</span> 		return
 	}
 	pool.currentState = statedb
 	pool.pendingNonces = newNoncer(statedb)
<span class="term-fg31">-	pool.currentMaxGas.Store(newHead.GasLimit)</span>
<span class="term-fg32">+	if !pool.chainconfig.IsOptimism() {</span>
<span class="term-fg32">+		pool.currentMaxGas.Store(newHead.GasLimit)</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		pool.currentMaxGas.Store(newHead.GasLimit - l1InfoGasOverhead)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	costFn := types.NewL1CostFunc(pool.chainconfig, statedb)</span>
<span class="term-fg32">+	pool.l1CostFn = func(dataGas types.RollupGasData, isDepositTx bool) *big.Int {</span>
<span class="term-fg32">+		return costFn(newHead.Number.Uint64(), newHead.Time, dataGas, isDepositTx)</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Inject any transactions discarded due to reorgs
 	log.Debug(&quot;Reinjecting stale transactions&quot;, &quot;count&quot;, len(reinject))
<span class="term-fg36">@@ -1420,8 +1485,16 @@</span> 			hash := tx.Hash()
 			pool.all.Remove(hash)
 		}
 		log.Trace(&quot;Removed old queued transactions&quot;, &quot;count&quot;, len(forwards))
<span class="term-fg32">+		balance := pool.currentState.GetBalance(addr)</span>
<span class="term-fg32">+		if !list.Empty() {</span>
<span class="term-fg32">+			&#47;&#47; Reduce the cost-cap by L1 rollup cost of the first tx if necessary. Other txs will get filtered out afterwards.</span>
<span class="term-fg32">+			el := list.txs.FirstElement()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(el.RollupDataGas(), el.IsDepositTx()); l1Cost != nil {</span>
<span class="term-fg32">+				balance = new(big.Int).Sub(balance, l1Cost) &#47;&#47; negative big int is fine</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; Drop all transactions that are too costly (low balance or out of gas)
<span class="term-fg31">-		drops, _ := list.Filter(pool.currentState.GetBalance(addr), pool.currentMaxGas.Load())</span>
<span class="term-fg32">+		drops, _ := list.Filter(balance, pool.currentMaxGas.Load())</span>
 		for _, tx := range drops {
 			hash := tx.Hash()
 			pool.all.Remove(hash)
<span class="term-fg36">@@ -1617,8 +1690,16 @@</span> 			hash := tx.Hash()
 			pool.all.Remove(hash)
 			log.Trace(&quot;Removed old pending transaction&quot;, &quot;hash&quot;, hash)
 		}
<span class="term-fg32">+		balance := pool.currentState.GetBalance(addr)</span>
<span class="term-fg32">+		if !list.Empty() {</span>
<span class="term-fg32">+			&#47;&#47; Reduce the cost-cap by L1 rollup cost of the first tx if necessary. Other txs will get filtered out afterwards.</span>
<span class="term-fg32">+			el := list.txs.FirstElement()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(el.RollupDataGas(), el.IsDepositTx()); l1Cost != nil {</span>
<span class="term-fg32">+				balance = new(big.Int).Sub(balance, l1Cost) &#47;&#47; negative big int is fine</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; Drop all transactions that are too costly (low balance or out of gas), and queue any invalids back for later
<span class="term-fg31">-		drops, invalids := list.Filter(pool.currentState.GetBalance(addr), pool.currentMaxGas.Load())</span>
<span class="term-fg32">+		drops, invalids := list.Filter(balance, pool.currentMaxGas.Load())</span>
 		for _, tx := range drops {
 			hash := tx.Hash()
 			log.Trace(&quot;Removed unpayable pending transaction&quot;, &quot;hash&quot;, hash)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7b3d7f9d22e37499e149d193" role="button"
                   aria-expanded="false" aria-controls="id-7b3d7f9d22e37499e149d193">
                    <code>core/txpool/txpool_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/txpool/txpool_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/txpool/txpool_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7b3d7f9d22e37499e149d193"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;txpool_test.go op-geth&#47;core&#47;txpool&#47;txpool_test.go</span>
<span class="term-fg1">index 22e106aaf8c5565ff763b85d1cf57debe347f69e..38fcdb364306f500774747bb022875863ec00369 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;txpool_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;txpool_test.go</span>
<span class="term-fg36">@@ -2255,10 +2255,13 @@</span> }
&nbsp;
 &#47;&#47; Tests that local transactions are journaled to disk, but remote transactions
 &#47;&#47; get discarded between restarts.
<span class="term-fg31">-func TestJournaling(t *testing.T)         { testJournaling(t, false) }</span>
<span class="term-fg31">-func TestJournalingNoLocals(t *testing.T) { testJournaling(t, true) }</span>
<span class="term-fg32">+func TestJournaling(t *testing.T)         { testJournaling(t, false, false) }</span>
<span class="term-fg32">+func TestJournalingNoLocals(t *testing.T) { testJournaling(t, true, false) }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestJournalingRemotes(t *testing.T)         { testJournaling(t, false, true) }</span>
<span class="term-fg32">+func TestJournalingRemotesNoLocals(t *testing.T) { testJournaling(t, true, true) }</span>
&nbsp;
<span class="term-fg31">-func testJournaling(t *testing.T, nolocals bool) {</span>
<span class="term-fg32">+func testJournaling(t *testing.T, nolocals bool, journalRemotes bool) {</span>
 	t.Parallel()
&nbsp;
 	&#47;&#47; Create a temporary file for the journal
<span class="term-fg36">@@ -2279,6 +2282,7 @@</span> 	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))
&nbsp;
 	config := testTxPoolConfig
 	config.NoLocals = nolocals
<span class="term-fg32">+	config.JournalRemote = journalRemotes</span>
 	config.Journal = journal
 	config.Rejournal = time.Second
&nbsp;
<span class="term-fg36">@@ -2325,10 +2329,14 @@</span> 	pending, queued = pool.Stats()
 	if queued != 0 {
 		t.Fatalf(&quot;queued transactions mismatched: have %d, want %d&quot;, queued, 0)
 	}
<span class="term-fg31">-	if nolocals {</span>
<span class="term-fg32">+	if nolocals &amp;&amp; !journalRemotes {</span>
 		if pending != 0 {
 			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)
 		}
<span class="term-fg32">+	} else if journalRemotes {</span>
<span class="term-fg32">+		if pending != 3 {</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 3)</span>
<span class="term-fg32">+		}</span>
 	} else {
 		if pending != 2 {
 			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 2)
<span class="term-fg36">@@ -2348,10 +2356,16 @@</span> 	blockchain = newTestBlockChain(1000000, statedb, new(event.Feed))
 	pool = NewTxPool(config, params.TestChainConfig, blockchain)
&nbsp;
 	pending, queued = pool.Stats()
<span class="term-fg31">-	if pending != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)</span>
<span class="term-fg32">+	if journalRemotes {</span>
<span class="term-fg32">+		if pending != 1 { &#47;&#47; Remove the 2 replaced local transactions, but preserve the remote</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 1)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		if pending != 0 {</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)</span>
<span class="term-fg32">+		}</span>
 	}
<span class="term-fg31">-	if nolocals {</span>
<span class="term-fg32">+	if nolocals &amp;&amp; !journalRemotes {</span>
 		if queued != 0 {
 			t.Fatalf(&quot;queued transactions mismatched: have %d, want %d&quot;, queued, 0)
 		}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-efb34146e02932504857e0aa" role="button"
                   aria-expanded="false" aria-controls="id-efb34146e02932504857e0aa">
                    <code>core/txpool/list.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/txpool/list.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/txpool/list.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-efb34146e02932504857e0aa"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;list.go op-geth&#47;core&#47;txpool&#47;list.go</span>
<span class="term-fg1">index fae7c2fcac2dacf40797517e947e66d7076e1c91..c8d9835335451132cfd723b894ab9ca8b8f1c050 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;list.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;list.go</span>
<span class="term-fg36">@@ -246,6 +246,15 @@</span> 	cache := m.flatten()
 	return cache[len(cache)-1]
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; FirstElement returns the first element from the heap (guaranteed to be lowest), thus, the</span>
<span class="term-fg32">+&#47;&#47; transaction with the lowest nonce. Returns nil if there are no elements.</span>
<span class="term-fg32">+func (m *sortedMap) FirstElement() *types.Transaction {</span>
<span class="term-fg32">+	if m.Len() == 0 {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return m.Get((*m.index)[0])</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; list is a &quot;list&quot; of transactions belonging to an account, sorted by account
 &#47;&#47; nonce. The same type can be used both for storing contiguous transactions for
 &#47;&#47; the executable&#47;pending queue; and for storing gapped transactions for the non-</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-54acb04d8bad872d9c281168"role="button" aria-expanded="false" aria-controls="id-54acb04d8bad872d9c281168">
        
            <div class="col-12 col-sm-9 text-start"><h2>Node modifications</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+244</span></div>
                <div class="text-start"><span class="text-danger">-18</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-54acb04d8bad872d9c281168">
        <div><p>Changes to the node configuration and services.</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4e4f2d9e022c80dee3bf25eb"role="button" aria-expanded="false" aria-controls="id-4e4f2d9e022c80dee3bf25eb">
        
            <div class="col-12 col-sm-9 text-start"><h3>CLI</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+201</span></div>
                <div class="text-start"><span class="text-danger">-10</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4e4f2d9e022c80dee3bf25eb">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-58c041164a9041c92b4c620d"role="button" aria-expanded="false" aria-controls="id-58c041164a9041c92b4c620d">
        
            <div class="col-12 col-sm-9 text-start"><h4>Flags</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+147</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-58c041164a9041c92b4c620d">
        <div><p>Flag changes:
  - Transactions can be forwarded to an RPC for sequencing.
  - Historical calls can be forwarded to a legacy node.
  - The tx pool propagation can be enabled/disabled.
  - The Optimism bedrock fork activation can be changed for testing.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c32e55020b21ddd2e34ba6e5" role="button"
                   aria-expanded="false" aria-controls="id-c32e55020b21ddd2e34ba6e5">
                    <code>cmd/utils/flags.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/cmd/utils/flags.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/cmd/utils/flags.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+122</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c32e55020b21ddd2e34ba6e5"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;utils&#47;flags.go op-geth&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg1">index b67671e03b9867ea4aeb51df001b8342ff49bb0e..8d8524d90b0bbbe56176dd19f89bab2d2b9495ec 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg36">@@ -34,6 +34,10 @@</span> 	&quot;strconv&quot;
 	&quot;strings&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	pcsclite &quot;github.com&#47;gballet&#47;go-libpcsclite&quot;</span>
<span class="term-fg32">+	gopsutil &quot;github.com&#47;shirou&#47;gopsutil&#47;mem&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;urfave&#47;cli&#47;v2&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -74,9 +78,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;netutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg31">-	pcsclite &quot;github.com&#47;gballet&#47;go-libpcsclite&quot;</span>
<span class="term-fg31">-	gopsutil &quot;github.com&#47;shirou&#47;gopsutil&#47;mem&quot;</span>
<span class="term-fg31">-	&quot;github.com&#47;urfave&#47;cli&#47;v2&quot;</span>
 )
&nbsp;
 &#47;&#47; These are all the command line flags we support.
<span class="term-fg36">@@ -157,6 +158,11 @@</span> 		Name:     &quot;sepolia&quot;,
 		Usage:    &quot;Sepolia network: pre-configured proof-of-work test network&quot;,
 		Category: flags.EthCategory,
 	}
<span class="term-fg32">+	BetaOPNetworkFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;beta.op-network&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Beta feature: pick an OP Stack network configuration&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Dev mode
 	DeveloperFlag = &amp;cli.BoolFlag{
<span class="term-fg36">@@ -273,6 +279,21 @@</span> 		Name:     &quot;override.cancun&quot;,
 		Usage:    &quot;Manually specify the Cancun fork timestamp, overriding the bundled setting&quot;,
 		Category: flags.EthCategory,
 	}
<span class="term-fg32">+	OverrideOptimismBedrock = &amp;flags.BigFlag{</span>
<span class="term-fg32">+		Name:     &quot;override.bedrock&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify OptimismBedrock, overriding the bundled setting&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OverrideOptimismRegolith = &amp;flags.BigFlag{</span>
<span class="term-fg32">+		Name:     &quot;override.regolith&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify the OptimismRegolith fork timestamp, overriding the bundled setting&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OverrideOptimism = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;override.optimism&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify optimism&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Light server and client settings
 	LightServeFlag = &amp;cli.IntFlag{
 		Name:     &quot;light.serve&quot;,
<span class="term-fg36">@@ -340,6 +361,11 @@</span> 	TxPoolJournalFlag = &amp;cli.StringFlag{
 		Name:     &quot;txpool.journal&quot;,
 		Usage:    &quot;Disk journal for local transaction to survive node restarts&quot;,
 		Value:    txpool.DefaultConfig.Journal,
<span class="term-fg32">+		Category: flags.TxPoolCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	TxPoolJournalRemotesFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;txpool.journalremotes&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Includes remote transactions in the journal&quot;,</span>
 		Category: flags.TxPoolCategory,
 	}
 	TxPoolRejournalFlag = &amp;cli.DurationFlag{
<span class="term-fg36">@@ -831,6 +857,53 @@</span> 		Usage:    &quot;Gas price below which gpo will ignore transactions&quot;,
 		Value:    ethconfig.Defaults.GPO.IgnorePrice.Int64(),
 		Category: flags.GasPriceCategory,
 	}
<span class="term-fg32">+	GpoMinSuggestedPriorityFeeFlag = &amp;cli.Int64Flag{</span>
<span class="term-fg32">+		Name:     &quot;gpo.minsuggestedpriorityfee&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Minimum transaction priority fee to suggest. Used on OP chains when blocks are not full.&quot;,</span>
<span class="term-fg32">+		Value:    ethconfig.Defaults.GPO.MinSuggestedPriorityFee.Int64(),</span>
<span class="term-fg32">+		Category: flags.GasPriceCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Rollup Flags</span>
<span class="term-fg32">+	RollupSequencerHTTPFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.sequencerhttp&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;HTTP endpoint for the sequencer mempool&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupHistoricalRPCFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.historicalrpc&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;RPC endpoint for historical data.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupHistoricalRPCTimeoutFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.historicalrpctimeout&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Timeout for historical RPC requests.&quot;,</span>
<span class="term-fg32">+		Value:    &quot;5s&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupDisableTxPoolGossipFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.disabletxpoolgossip&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Disable transaction pool gossip.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupEnableTxPoolAdmissionFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.enabletxpooladmission&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Add RPC-submitted transactions to the txpool (on by default if --rollup.sequencerhttp is not set).&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupComputePendingBlock = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.computependingblock&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;By default the pending block equals the latest block to save resources and not leak txs from the tx-pool, this flag enables computing of the pending block from the tx-pool instead.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupHaltOnIncompatibleProtocolVersionFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;beta.rollup.halt&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Opt-in option to halt on incompatible protocol version requirements of the given level (major&#47;minor&#47;patch&#47;none), as signaled through the Engine API by the rollup node&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Metrics flags
 	MetricsEnabledFlag = &amp;cli.BoolFlag{
<span class="term-fg36">@@ -936,7 +1009,7 @@</span> 		GoerliFlag,
 		SepoliaFlag,
 	}
 	&#47;&#47; NetworkFlags is the flag group of all built-in supported networks.
<span class="term-fg31">-	NetworkFlags = append([]cli.Flag{MainnetFlag}, TestnetFlags...)</span>
<span class="term-fg32">+	NetworkFlags = append([]cli.Flag{MainnetFlag, BetaOPNetworkFlag}, TestnetFlags...)</span>
&nbsp;
 	&#47;&#47; DatabasePathFlags is the flag group of all database path flags.
 	DatabasePathFlags = []cli.Flag{
<span class="term-fg36">@@ -966,6 +1039,9 @@</span> 			return filepath.Join(path, &quot;goerli&quot;)
 		}
 		if ctx.Bool(SepoliaFlag.Name) {
 			return filepath.Join(path, &quot;sepolia&quot;)
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if ctx.IsSet(BetaOPNetworkFlag.Name) {</span>
<span class="term-fg32">+			return filepath.Join(path, ctx.String(BetaOPNetworkFlag.Name))</span>
 		}
 		return path
 	}
<span class="term-fg36">@@ -1470,6 +1546,8 @@</span> 	case ctx.Bool(GoerliFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():
 		cfg.DataDir = filepath.Join(node.DefaultDataDir(), &quot;goerli&quot;)
 	case ctx.Bool(SepoliaFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():
 		cfg.DataDir = filepath.Join(node.DefaultDataDir(), &quot;sepolia&quot;)
<span class="term-fg32">+	case ctx.IsSet(BetaOPNetworkFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():</span>
<span class="term-fg32">+		cfg.DataDir = filepath.Join(node.DefaultDataDir(), ctx.String(BetaOPNetworkFlag.Name))</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -1491,6 +1569,9 @@</span> 	}
 	if ctx.IsSet(GpoIgnoreGasPriceFlag.Name) {
 		cfg.IgnorePrice = big.NewInt(ctx.Int64(GpoIgnoreGasPriceFlag.Name))
 	}
<span class="term-fg32">+	if ctx.IsSet(GpoMinSuggestedPriorityFeeFlag.Name) {</span>
<span class="term-fg32">+		cfg.MinSuggestedPriorityFee = big.NewInt(ctx.Int64(GpoMinSuggestedPriorityFeeFlag.Name))</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 func setTxPool(ctx *cli.Context, cfg *txpool.Config) {
<span class="term-fg36">@@ -1510,6 +1591,9 @@</span> 	}
 	if ctx.IsSet(TxPoolJournalFlag.Name) {
 		cfg.Journal = ctx.String(TxPoolJournalFlag.Name)
 	}
<span class="term-fg32">+	if ctx.IsSet(TxPoolJournalRemotesFlag.Name) {</span>
<span class="term-fg32">+		cfg.JournalRemote = ctx.Bool(TxPoolJournalRemotesFlag.Name)</span>
<span class="term-fg32">+	}</span>
 	if ctx.IsSet(TxPoolRejournalFlag.Name) {
 		cfg.Rejournal = ctx.Duration(TxPoolRejournalFlag.Name)
 	}
<span class="term-fg36">@@ -1551,6 +1635,9 @@</span> 		cfg.Recommit = ctx.Duration(MinerRecommitIntervalFlag.Name)
 	}
 	if ctx.IsSet(MinerNewPayloadTimeout.Name) {
 		cfg.NewPayloadTimeout = ctx.Duration(MinerNewPayloadTimeout.Name)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupComputePendingBlock.Name) {</span>
<span class="term-fg32">+		cfg.RollupComputePendingBlock = ctx.Bool(RollupComputePendingBlock.Name)</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -1626,7 +1713,7 @@</span>
 &#47;&#47; SetEthConfig applies eth-related command line flags to the config.
 func SetEthConfig(ctx *cli.Context, stack *node.Node, cfg *ethconfig.Config) {
 	&#47;&#47; Avoid conflicting network flags
<span class="term-fg31">-	CheckExclusive(ctx, MainnetFlag, DeveloperFlag, RinkebyFlag, GoerliFlag, SepoliaFlag)</span>
<span class="term-fg32">+	CheckExclusive(ctx, MainnetFlag, DeveloperFlag, RinkebyFlag, GoerliFlag, SepoliaFlag, BetaOPNetworkFlag)</span>
 	CheckExclusive(ctx, LightServeFlag, SyncModeFlag, &quot;light&quot;)
 	CheckExclusive(ctx, DeveloperFlag, ExternalSignerFlag) &#47;&#47; Can&#39;t use both ephemeral unlocked and external signer
 	if ctx.String(GCModeFlag.Name) == &quot;archive&quot; &amp;&amp; ctx.Uint64(TxLookupLimitFlag.Name) != 0 {
<span class="term-fg36">@@ -1754,6 +1841,19 @@</span> 		} else {
 			cfg.EthDiscoveryURLs = SplitAndTrim(urls)
 		}
 	}
<span class="term-fg32">+	&#47;&#47; Only configure sequencer http flag if we&#39;re running in verifier mode i.e. --mine is disabled.</span>
<span class="term-fg32">+	if ctx.IsSet(RollupSequencerHTTPFlag.Name) &amp;&amp; !ctx.IsSet(MiningEnabledFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupSequencerHTTP = ctx.String(RollupSequencerHTTPFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupHistoricalRPCFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupHistoricalRPC = ctx.String(RollupHistoricalRPCFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupHistoricalRPCTimeoutFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupHistoricalRPCTimeout = ctx.Duration(RollupHistoricalRPCTimeoutFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	cfg.RollupDisableTxPoolGossip = ctx.Bool(RollupDisableTxPoolGossipFlag.Name)</span>
<span class="term-fg32">+	cfg.RollupDisableTxPoolAdmission = cfg.RollupSequencerHTTP != &quot;&quot; &amp;&amp; !ctx.Bool(RollupEnableTxPoolAdmissionFlag.Name)</span>
<span class="term-fg32">+	cfg.RollupHaltOnIncompatibleProtocolVersion = ctx.String(RollupHaltOnIncompatibleProtocolVersionFlag.Name)</span>
 	&#47;&#47; Override any default configs for hard coded networks.
 	switch {
 	case ctx.Bool(MainnetFlag.Name):
<span class="term-fg36">@@ -1858,6 +1958,12 @@</span> 		}
 		if !ctx.IsSet(MinerGasPriceFlag.Name) {
 			cfg.Miner.GasPrice = big.NewInt(1)
 		}
<span class="term-fg32">+	case ctx.IsSet(BetaOPNetworkFlag.Name):</span>
<span class="term-fg32">+		genesis := MakeGenesis(ctx)</span>
<span class="term-fg32">+		if !ctx.IsSet(NetworkIdFlag.Name) {</span>
<span class="term-fg32">+			cfg.NetworkId = genesis.Config.ChainID.Uint64()</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		cfg.Genesis = genesis</span>
 	default:
 		if cfg.NetworkId == 1 {
 			SetDNSDiscoveryDefaults(cfg, params.MainnetGenesisHash)
<span class="term-fg36">@@ -2118,6 +2224,17 @@</span> 	case ctx.Bool(RinkebyFlag.Name):
 		genesis = core.DefaultRinkebyGenesisBlock()
 	case ctx.Bool(GoerliFlag.Name):
 		genesis = core.DefaultGoerliGenesisBlock()
<span class="term-fg32">+	case ctx.IsSet(BetaOPNetworkFlag.Name):</span>
<span class="term-fg32">+		name := ctx.String(BetaOPNetworkFlag.Name)</span>
<span class="term-fg32">+		ch, err := params.OPStackChainIDByName(name)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			Fatalf(&quot;failed to load OP-Stack chain %q: %v&quot;, name, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis, err := core.LoadOPStackGenesis(ch)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			Fatalf(&quot;failed to load genesis for OP-Stack chain %q (%d): %v&quot;, name, ch, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return genesis</span>
 	case ctx.Bool(DeveloperFlag.Name):
 		Fatalf(&quot;Developer chains are ephemeral&quot;)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fdbbb9323f296bd28919d138" role="button"
                   aria-expanded="false" aria-controls="id-fdbbb9323f296bd28919d138">
                    <code>cmd/geth/main.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/cmd/geth/main.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/cmd/geth/main.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+11</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fdbbb9323f296bd28919d138"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;main.go op-geth&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg1">index b4a7b5fa95c26c5ce1cb487992f8b8058b6aec6f..77435f7e7359e38f859b109dfaaa100937ba7b9b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg36">@@ -66,9 +66,13 @@</span> 		utils.USBFlag,
 		utils.SmartCardDaemonPathFlag,
 		utils.OverrideCancun,
 		utils.EnablePersonal,
<span class="term-fg32">+		utils.OverrideOptimismBedrock,</span>
<span class="term-fg32">+		utils.OverrideOptimismRegolith,</span>
<span class="term-fg32">+		utils.OverrideOptimism,</span>
 		utils.TxPoolLocalsFlag,
 		utils.TxPoolNoLocalsFlag,
 		utils.TxPoolJournalFlag,
<span class="term-fg32">+		utils.TxPoolJournalRemotesFlag,</span>
 		utils.TxPoolRejournalFlag,
 		utils.TxPoolPriceLimitFlag,
 		utils.TxPoolPriceBumpFlag,
<span class="term-fg36">@@ -137,6 +141,13 @@</span> 		utils.GpoBlocksFlag,
 		utils.GpoPercentileFlag,
 		utils.GpoMaxGasPriceFlag,
 		utils.GpoIgnoreGasPriceFlag,
<span class="term-fg32">+		utils.GpoMinSuggestedPriorityFeeFlag,</span>
<span class="term-fg32">+		utils.RollupSequencerHTTPFlag,</span>
<span class="term-fg32">+		utils.RollupHistoricalRPCFlag,</span>
<span class="term-fg32">+		utils.RollupHistoricalRPCTimeoutFlag,</span>
<span class="term-fg32">+		utils.RollupDisableTxPoolGossipFlag,</span>
<span class="term-fg32">+		utils.RollupComputePendingBlock,</span>
<span class="term-fg32">+		utils.RollupHaltOnIncompatibleProtocolVersionFlag,</span>
 		configFileFlag,
 	}, utils.NetworkFlags, utils.DatabasePathFlags)
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1bcada7545842128487525a1" role="button"
                   aria-expanded="false" aria-controls="id-1bcada7545842128487525a1">
                    <code>internal/flags/categories.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/internal/flags/categories.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/internal/flags/categories.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1bcada7545842128487525a1"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;flags&#47;categories.go op-geth&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg1">index c2db6c6c1d25c115c77c8a829d481133a932faa7..f2b368775867174abef2e16d6c64d10b890ca9ff 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg36">@@ -31,6 +31,7 @@</span> 	NetworkingCategory = &quot;NETWORKING&quot;
 	MinerCategory      = &quot;MINER&quot;
 	GasPriceCategory   = &quot;GAS PRICE ORACLE&quot;
 	VMCategory         = &quot;VIRTUAL MACHINE&quot;
<span class="term-fg32">+	RollupCategory     = &quot;ROLLUP NODE&quot;</span>
 	LoggingCategory    = &quot;LOGGING AND DEBUGGING&quot;
 	MetricsCategory    = &quot;METRICS AND STATS&quot;
 	MiscCategory       = &quot;MISC&quot;</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f09845866ddb040f1ac58a50" role="button"
                   aria-expanded="false" aria-controls="id-f09845866ddb040f1ac58a50">
                    <code>cmd/geth/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/cmd/geth/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/cmd/geth/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+13</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f09845866ddb040f1ac58a50"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;config.go op-geth&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg1">index 42ded493224bba679b25a404dd413c3a88ad57f9..4ac647d1708170da84e451e0c4d7078c97cc80f8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg36">@@ -170,6 +170,19 @@</span> 	if ctx.IsSet(utils.OverrideCancun.Name) {
 		v := ctx.Uint64(utils.OverrideCancun.Name)
 		cfg.Eth.OverrideCancun = &amp;v
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimismBedrock.Name) {</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimismBedrock = flags.GlobalBig(ctx, utils.OverrideOptimismBedrock.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimismRegolith.Name) {</span>
<span class="term-fg32">+		v := ctx.Uint64(utils.OverrideOptimismRegolith.Name)</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimismRegolith = &amp;v</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimism.Name) {</span>
<span class="term-fg32">+		override := ctx.Bool(utils.OverrideOptimism.Name)</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimism = &amp;override</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	backend, eth := utils.RegisterEthService(stack, &amp;cfg.Eth)
&nbsp;
 	&#47;&#47; Configure log filter RPC API.</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-c5512b008bcf80d67939bc85"role="button" aria-expanded="false" aria-controls="id-c5512b008bcf80d67939bc85">
        
            <div class="col-12 col-sm-9 text-start"><h4>Versioning</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+54</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-c5512b008bcf80d67939bc85">
        <div><p>List the op-geth and upstream go-ethereum versions.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fde8c9dde419806539d770d7" role="button"
                   aria-expanded="false" aria-controls="id-fde8c9dde419806539d770d7">
                    <code>cmd/geth/misccmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/cmd/geth/misccmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/cmd/geth/misccmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fde8c9dde419806539d770d7"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;misccmd.go op-geth&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg1">index f3530c30fb69fe08024d9f62a1a377d416c684d9..e7fb108ebfb6a065eb1232ced8fcdf1c49eee4c5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg36">@@ -80,6 +80,7 @@</span> 	}
 	if git.Date != &quot;&quot; {
 		fmt.Println(&quot;Git Commit Date:&quot;, git.Date)
 	}
<span class="term-fg32">+	fmt.Println(&quot;Upstream Version:&quot;, params.GethVersionWithMeta)</span>
 	fmt.Println(&quot;Architecture:&quot;, runtime.GOARCH)
 	fmt.Println(&quot;Go Version:&quot;, runtime.Version())
 	fmt.Println(&quot;Operating System:&quot;, runtime.GOOS)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-35b2e66191565886a6ab0a5b" role="button"
                   aria-expanded="false" aria-controls="id-35b2e66191565886a6ab0a5b">
                    <code>params/version.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/params/version.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/params/version.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+49</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-35b2e66191565886a6ab0a5b"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;version.go op-geth&#47;params&#47;version.go</span>
<span class="term-fg1">index 33c5399d11edaaed88030cb9ebd92437e2cacefe..ff34aafebf371d1e9a446dbc3320c13e561a81ef 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;version.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;version.go</span>
<span class="term-fg36">@@ -18,8 +18,11 @@</span> package params
&nbsp;
 import (
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;regexp&quot;</span>
<span class="term-fg32">+	&quot;strconv&quot;</span>
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; Version is the version of upstream geth</span>
 const (
 	VersionMajor = 1        &#47;&#47; Major version component of the current release
 	VersionMinor = 12       &#47;&#47; Minor version component of the current release
<span class="term-fg36">@@ -27,14 +30,56 @@</span> 	VersionPatch = 0        &#47;&#47; Patch version component of the current release
 	VersionMeta  = &quot;stable&quot; &#47;&#47; Version metadata to append to the version string
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; OPVersion is the version of op-geth</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	OPVersionMajor = 0          &#47;&#47; Major version component of the current release</span>
<span class="term-fg32">+	OPVersionMinor = 1          &#47;&#47; Minor version component of the current release</span>
<span class="term-fg32">+	OPVersionPatch = 0          &#47;&#47; Patch version component of the current release</span>
<span class="term-fg32">+	OPVersionMeta  = &quot;unstable&quot; &#47;&#47; Version metadata to append to the version string</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; This is set at build-time by the linker when the build is done by build&#47;ci.go.</span>
<span class="term-fg32">+var gitTag string</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Override the version variables if the gitTag was set at build time.</span>
<span class="term-fg32">+var _ = func() (_ string) {</span>
<span class="term-fg32">+	semver := regexp.MustCompile(`^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$`)</span>
<span class="term-fg32">+	version := semver.FindStringSubmatch(gitTag)</span>
<span class="term-fg32">+	if version == nil {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if version[4] == &quot;&quot; {</span>
<span class="term-fg32">+		version[4] = &quot;stable&quot;</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OPVersionMajor, _ = strconv.Atoi(version[1])</span>
<span class="term-fg32">+	OPVersionMinor, _ = strconv.Atoi(version[2])</span>
<span class="term-fg32">+	OPVersionPatch, _ = strconv.Atoi(version[3])</span>
<span class="term-fg32">+	OPVersionMeta = version[4]</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
 &#47;&#47; Version holds the textual version string.
 var Version = func() string {
<span class="term-fg31">-	return fmt.Sprintf(&quot;%d.%d.%d&quot;, VersionMajor, VersionMinor, VersionPatch)</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d.%d.%d&quot;, OPVersionMajor, OPVersionMinor, OPVersionPatch)</span>
 }()
&nbsp;
 &#47;&#47; VersionWithMeta holds the textual version string including the metadata.
 var VersionWithMeta = func() string {
 	v := Version
<span class="term-fg32">+	if OPVersionMeta != &quot;&quot; {</span>
<span class="term-fg32">+		v += &quot;-&quot; + OPVersionMeta</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return v</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; GethVersion holds the textual geth version string.</span>
<span class="term-fg32">+var GethVersion = func() string {</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d.%d.%d&quot;, VersionMajor, VersionMinor, VersionPatch)</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; GethVersionWithMeta holds the textual geth version string including the metadata.</span>
<span class="term-fg32">+var GethVersionWithMeta = func() string {</span>
<span class="term-fg32">+	v := GethVersion</span>
 	if VersionMeta != &quot;&quot; {
 		v += &quot;-&quot; + VersionMeta
 	}
<span class="term-fg36">@@ -46,8 +91,8 @@</span> &#47;&#47; &quot;1.8.11-dea1ce05&quot; for stable releases, or &quot;1.8.13-unstable-21c059b6&quot; for unstable
 &#47;&#47; releases.
 func ArchiveVersion(gitCommit string) string {
 	vsn := Version
<span class="term-fg31">-	if VersionMeta != &quot;stable&quot; {</span>
<span class="term-fg31">-		vsn += &quot;-&quot; + VersionMeta</span>
<span class="term-fg32">+	if OPVersionMeta != &quot;stable&quot; {</span>
<span class="term-fg32">+		vsn += &quot;-&quot; + OPVersionMeta</span>
 	}
 	if len(gitCommit) &gt;= 8 {
 		vsn += &quot;-&quot; + gitCommit[:8]
<span class="term-fg36">@@ -60,7 +105,7 @@</span> 	vsn := VersionWithMeta
 	if len(gitCommit) &gt;= 8 {
 		vsn += &quot;-&quot; + gitCommit[:8]
 	}
<span class="term-fg31">-	if (VersionMeta != &quot;stable&quot;) &amp;&amp; (gitDate != &quot;&quot;) {</span>
<span class="term-fg32">+	if (OPVersionMeta != &quot;stable&quot;) &amp;&amp; (gitDate != &quot;&quot;) {</span>
 		vsn += &quot;-&quot; + gitDate
 	}
 	return vsn</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5e3fc7089bb3cd5a0433751d" role="button"
                   aria-expanded="false" aria-controls="id-5e3fc7089bb3cd5a0433751d">
                    <code>build/ci.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/build/ci.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/build/ci.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5e3fc7089bb3cd5a0433751d"><span class="term-fg1">diff --git go-ethereum&#47;build&#47;ci.go op-geth&#47;build&#47;ci.go</span>
<span class="term-fg1">index 7933724d7416ed28f518eed3a9213984ce0acbd1..596192206f6ad07e96fa3f757fe27777ad106b55 100644</span>
<span class="term-fg1">--- go-ethereum&#47;build&#47;ci.go</span>
<span class="term-fg1">+++ op-geth&#47;build&#47;ci.go</span>
<span class="term-fg36">@@ -251,6 +251,9 @@</span> 	if env.Commit != &quot;&quot; {
 		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;version.gitCommit=&quot;+env.Commit)
 		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;version.gitDate=&quot;+env.Date)
 	}
<span class="term-fg32">+	if env.Tag != &quot;&quot; {</span>
<span class="term-fg32">+		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;params.gitTag=&quot;+env.Tag)</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Strip DWARF on darwin. This used to be required for certain things,
 	&#47;&#47; and there is no downside to this, so we just keep doing it.
 	if runtime.GOOS == &quot;darwin&quot; {
<span class="term-fg36">@@ -507,7 +510,7 @@</span> 	switch {
 	case env.Branch == &quot;master&quot;:
 		tags = []string{&quot;latest&quot;}
 	case strings.HasPrefix(env.Tag, &quot;v1.&quot;):
<span class="term-fg31">-		tags = []string{&quot;stable&quot;, fmt.Sprintf(&quot;release-1.%d&quot;, params.VersionMinor), &quot;v&quot; + params.Version}</span>
<span class="term-fg32">+		tags = []string{&quot;stable&quot;, fmt.Sprintf(&quot;release-1.%d&quot;, params.OPVersionMinor), &quot;v&quot; + params.Version}</span>
 	}
 	&#47;&#47; If architecture specific image builds are requested, build and push them
 	if *image {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-92de2c06d3aeb7015b3facb7"role="button" aria-expanded="false" aria-controls="id-92de2c06d3aeb7015b3facb7">
        
            <div class="col-12 col-sm-9 text-start"><h3>Node config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+19</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-92de2c06d3aeb7015b3facb7">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0ab9c8ce4d9f2dda12f40e8b" role="button"
                   aria-expanded="false" aria-controls="id-0ab9c8ce4d9f2dda12f40e8b">
                    <code>eth/ethconfig/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/ethconfig/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/ethconfig/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0ab9c8ce4d9f2dda12f40e8b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;ethconfig&#47;config.go op-geth&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg1">index a98d9ee4aaffd25349e678f4e1c0c415ef540604..6f64e875576cd94a06437a216e151ceee752e4c4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg36">@@ -19,6 +19,7 @@</span> package ethconfig
&nbsp;
 import (
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -37,12 +38,13 @@</span> )
&nbsp;
 &#47;&#47; FullNodeGPO contains default gasprice oracle settings for full node.
 var FullNodeGPO = gasprice.Config{
<span class="term-fg31">-	Blocks:           20,</span>
<span class="term-fg31">-	Percentile:       60,</span>
<span class="term-fg31">-	MaxHeaderHistory: 1024,</span>
<span class="term-fg31">-	MaxBlockHistory:  1024,</span>
<span class="term-fg31">-	MaxPrice:         gasprice.DefaultMaxPrice,</span>
<span class="term-fg31">-	IgnorePrice:      gasprice.DefaultIgnorePrice,</span>
<span class="term-fg32">+	Blocks:                  20,</span>
<span class="term-fg32">+	Percentile:              60,</span>
<span class="term-fg32">+	MaxHeaderHistory:        1024,</span>
<span class="term-fg32">+	MaxBlockHistory:         1024,</span>
<span class="term-fg32">+	MaxPrice:                gasprice.DefaultMaxPrice,</span>
<span class="term-fg32">+	IgnorePrice:             gasprice.DefaultIgnorePrice,</span>
<span class="term-fg32">+	MinSuggestedPriorityFee: gasprice.DefaultMinSuggestedPriorityFee,</span>
 }
&nbsp;
 &#47;&#47; LightClientGPO contains default gasprice oracle settings for light client.
<span class="term-fg36">@@ -162,6 +164,17 @@</span> 	RPCTxFeeCap float64
&nbsp;
 	&#47;&#47; OverrideCancun (TODO: remove after the fork)
 	OverrideCancun *uint64 `toml:&quot;,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	OverrideOptimismBedrock  *big.Int</span>
<span class="term-fg32">+	OverrideOptimismRegolith *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+	OverrideOptimism         *bool</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupSequencerHTTP                     string</span>
<span class="term-fg32">+	RollupHistoricalRPC                     string</span>
<span class="term-fg32">+	RollupHistoricalRPCTimeout              time.Duration</span>
<span class="term-fg32">+	RollupDisableTxPoolGossip               bool</span>
<span class="term-fg32">+	RollupDisableTxPoolAdmission            bool</span>
<span class="term-fg32">+	RollupHaltOnIncompatibleProtocolVersion string</span>
 }
&nbsp;
 &#47;&#47; CreateConsensusEngine creates a consensus engine for the given chain config.</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-e394f12ecb2df23c99007143"role="button" aria-expanded="false" aria-controls="id-e394f12ecb2df23c99007143">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tx gossip disable option</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+24</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-e394f12ecb2df23c99007143">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-213982e6bde6f668caee216c" role="button"
                   aria-expanded="false" aria-controls="id-213982e6bde6f668caee216c">
                    <code>eth/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+7</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-213982e6bde6f668caee216c"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler.go op-geth&#47;eth&#47;handler.go</span>
<span class="term-fg1">index f0b043166efbfcc3f3e959dc6c958f4628d6fd6d..a951bcc19e6e47b5874c730b8749bb082e90d7f4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler.go</span>
<span class="term-fg36">@@ -85,6 +85,7 @@</span> 	Sync           downloader.SyncMode    &#47;&#47; Whether to snap or full sync
 	BloomCache     uint64                 &#47;&#47; Megabytes to alloc for snap sync bloom
 	EventMux       *event.TypeMux         &#47;&#47; Legacy event mux, deprecate for `feed`
 	RequiredBlocks map[uint64]common.Hash &#47;&#47; Hard coded map of required block hashes for sync challenges
<span class="term-fg32">+	NoTxGossip     bool                   &#47;&#47; Disable P2P transaction gossip</span>
 }
&nbsp;
 type handler struct {
<span class="term-fg36">@@ -98,6 +99,8 @@</span> 	database ethdb.Database
 	txpool   txPool
 	chain    *core.BlockChain
 	maxPeers int
<span class="term-fg32">+</span>
<span class="term-fg32">+	noTxGossip bool</span>
&nbsp;
 	downloader   *downloader.Downloader
 	blockFetcher *fetcher.BlockFetcher
<span class="term-fg36">@@ -132,6 +135,7 @@</span> 		forkFilter:     forkid.NewFilter(config.Chain),
 		eventMux:       config.EventMux,
 		database:       config.Database,
 		txpool:         config.TxPool,
<span class="term-fg32">+		noTxGossip:     config.NoTxGossip,</span>
 		chain:          config.Chain,
 		peers:          newPeerSet(),
 		merger:         config.Merger,
<span class="term-fg36">@@ -153,8 +157,10 @@</span> 			h.snapSync.Store(true)
 			log.Warn(&quot;Switch sync mode from full sync to snap sync&quot;)
 		}
 	} else {
<span class="term-fg31">-		if h.chain.CurrentBlock().Number.Uint64() &gt; 0 {</span>
<span class="term-fg32">+		blockNumber := h.chain.CurrentBlock().Number</span>
<span class="term-fg32">+		if blockNumber.Uint64() &gt; 0 &amp;&amp; (!config.Chain.Config().IsOptimism() || blockNumber.Cmp(config.Chain.Config().BedrockBlock) != 0) {</span>
 			&#47;&#47; Print warning log if database is not empty to run snap sync.
<span class="term-fg32">+			&#47;&#47; For OP chains, snap sync from bedrock block is allowed.</span>
 			log.Warn(&quot;Switch sync mode from snap sync to full sync&quot;)
 		} else {
 			&#47;&#47; If snap sync was requested and our database is empty, grant it</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-13fd772ff0860a9d71e7021a" role="button"
                   aria-expanded="false" aria-controls="id-13fd772ff0860a9d71e7021a">
                    <code>eth/handler_eth.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/handler_eth.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/handler_eth.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+17</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-13fd772ff0860a9d71e7021a"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler_eth.go op-geth&#47;eth&#47;handler_eth.go</span>
<span class="term-fg1">index 00be022d9e9c1580abf11559a83b7bfcf32c2d5b..72843fd6ff33033f360769b707467d11176e2b8b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler_eth.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler_eth.go</span>
<span class="term-fg36">@@ -33,7 +33,20 @@</span> &#47;&#47; packets that are sent as replies or broadcasts.
 type ethHandler handler
&nbsp;
 func (h *ethHandler) Chain() *core.BlockChain { return h.chain }
<span class="term-fg31">-func (h *ethHandler) TxPool() eth.TxPool      { return h.txpool }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NilPool satisfies the TxPool interface but does not return any tx in the</span>
<span class="term-fg32">+&#47;&#47; pool. It is used to disable transaction gossip.</span>
<span class="term-fg32">+type NilPool struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NilPool Get always returns nil</span>
<span class="term-fg32">+func (n NilPool) Get(hash common.Hash) *types.Transaction { return nil }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (h *ethHandler) TxPool() eth.TxPool {</span>
<span class="term-fg32">+	if h.noTxGossip {</span>
<span class="term-fg32">+		return &amp;NilPool{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return h.txpool</span>
<span class="term-fg32">+}</span>
&nbsp;
 &#47;&#47; RunPeer is invoked when a peer joins on the `eth` protocol.
 func (h *ethHandler) RunPeer(peer *eth.Peer, hand eth.Handler) error {
<span class="term-fg36">@@ -51,6 +64,9 @@</span>
 &#47;&#47; AcceptTxs retrieves whether transaction processing is enabled on the node
 &#47;&#47; or if inbound transactions should simply be dropped.
 func (h *ethHandler) AcceptTxs() bool {
<span class="term-fg32">+	if h.noTxGossip {</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
 	return h.acceptTxs.Load()
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-e57ef1c04ab6dca0d69662e8"role="button" aria-expanded="false" aria-controls="id-e57ef1c04ab6dca0d69662e8">
        
            <div class="col-12 col-sm-9 text-start"><h2>User API enhancements</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1036</span></div>
                <div class="text-start"><span class="text-danger">-64</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-e57ef1c04ab6dca0d69662e8">
        <div><p>Encode the Deposit Tx properties, the L1 costs, and daisy-chain RPC-calls for pre-Bedrock historical data</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-030f1d682492c20033e5fc7f"role="button" aria-expanded="false" aria-controls="id-030f1d682492c20033e5fc7f">
        
            <div class="col-12 col-sm-9 text-start"><h3>Receipts metadata</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+223</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-030f1d682492c20033e5fc7f">
        <div><p>Pre-Bedrock L1-cost receipt data is loaded from the database if available, and post-Bedrock the L1-cost
metadata is hydrated on-the-fly based on the L1 fee information in the corresponding block.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cd74fea07c4aea7ce2718679" role="button"
                   aria-expanded="false" aria-controls="id-cd74fea07c4aea7ce2718679">
                    <code>core/types/receipt.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/receipt.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/receipt.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+195</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cd74fea07c4aea7ce2718679"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;receipt.go op-geth&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg1">index 8fc9ec9894e5e6ad444814b06645e5eb23a8bacb..e7c88db3d600916c726dab66e453d7aa4dd60b5d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg36">@@ -58,17 +58,28 @@</span> 	CumulativeGasUsed uint64 `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`
 	Bloom             Bloom  `json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`
 	Logs              []*Log `json:&quot;logs&quot;              gencodec:&quot;required&quot;`
&nbsp;
<span class="term-fg31">-	&#47;&#47; Implementation fields: These fields are added by geth when processing a transaction.</span>
<span class="term-fg32">+	&#47;&#47; Implementation fields: These fields are added by geth when processing a transaction or retrieving a receipt.</span>
<span class="term-fg32">+	&#47;&#47; gencodec annotated fields: these are stored in the chain database.</span>
 	TxHash            common.Hash    `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`
 	ContractAddress   common.Address `json:&quot;contractAddress&quot;`
 	GasUsed           uint64         `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`
 	EffectiveGasPrice *big.Int       `json:&quot;effectiveGasPrice&quot;` &#47;&#47; required, but tag omitted for backwards compatibility
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions</span>
<span class="term-fg32">+	&#47;&#47; The state transition process ensures this is only set for Regolith deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
&nbsp;
 	&#47;&#47; Inclusion information: These fields provide information about the inclusion of the
 	&#47;&#47; transaction corresponding to this receipt.
 	BlockHash        common.Hash `json:&quot;blockHash,omitempty&quot;`
 	BlockNumber      *big.Int    `json:&quot;blockNumber,omitempty&quot;`
 	TransactionIndex uint        `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; OVM legacy: extend receipts with their L1 price (if a rollup tx)</span>
<span class="term-fg32">+	L1GasPrice *big.Int   `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+	L1GasUsed  *big.Int   `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+	L1Fee      *big.Int   `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+	FeeScalar  *big.Float `json:&quot;l1FeeScalar,omitempty&quot;`</span>
 }
&nbsp;
 type receiptMarshaling struct {
<span class="term-fg36">@@ -80,6 +91,12 @@</span> 	GasUsed           hexutil.Uint64
 	EffectiveGasPrice *hexutil.Big
 	BlockNumber       *hexutil.Big
 	TransactionIndex  hexutil.Uint
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Optimism: extend receipts with their L1 price (if a rollup tx)</span>
<span class="term-fg32">+	L1GasPrice *hexutil.Big</span>
<span class="term-fg32">+	L1GasUsed  *hexutil.Big</span>
<span class="term-fg32">+	L1Fee      *hexutil.Big</span>
<span class="term-fg32">+	FeeScalar  *big.Float</span>
 }
&nbsp;
 &#47;&#47; receiptRLP is the consensus encoding of a receipt.
<span class="term-fg36">@@ -90,11 +107,90 @@</span> 	Bloom             Bloom
 	Logs              []*Log
 }
&nbsp;
<span class="term-fg32">+type depositReceiptRlp struct {</span>
<span class="term-fg32">+	PostStateOrStatus []byte</span>
<span class="term-fg32">+	CumulativeGasUsed uint64</span>
<span class="term-fg32">+	Bloom             Bloom</span>
<span class="term-fg32">+	Logs              []*Log</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions.</span>
<span class="term-fg32">+	&#47;&#47; Must be nil for any transactions prior to Regolith or that aren&#39;t deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; storedReceiptRLP is the storage encoding of a receipt.
 type storedReceiptRLP struct {
 	PostStateOrStatus []byte
 	CumulativeGasUsed uint64
 	Logs              []*Log
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions.</span>
<span class="term-fg32">+	&#47;&#47; Must be nil for any transactions prior to Regolith or that aren&#39;t deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LegacyOptimismStoredReceiptRLP is the pre bedrock storage encoding of a</span>
<span class="term-fg32">+&#47;&#47; receipt. It will only exist in the database if it was migrated using the</span>
<span class="term-fg32">+&#47;&#47; migration tool. Nodes that sync using snap-sync will not have any of these</span>
<span class="term-fg32">+&#47;&#47; entries.</span>
<span class="term-fg32">+type LegacyOptimismStoredReceiptRLP struct {</span>
<span class="term-fg32">+	PostStateOrStatus []byte</span>
<span class="term-fg32">+	CumulativeGasUsed uint64</span>
<span class="term-fg32">+	Logs              []*LogForStorage</span>
<span class="term-fg32">+	L1GasUsed         *big.Int</span>
<span class="term-fg32">+	L1GasPrice        *big.Int</span>
<span class="term-fg32">+	L1Fee             *big.Int</span>
<span class="term-fg32">+	FeeScalar         string</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LogForStorage is a wrapper around a Log that handles</span>
<span class="term-fg32">+&#47;&#47; backward compatibility with prior storage formats.</span>
<span class="term-fg32">+type LogForStorage Log</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; EncodeRLP implements rlp.Encoder.</span>
<span class="term-fg32">+func (l *LogForStorage) EncodeRLP(w io.Writer) error {</span>
<span class="term-fg32">+	rl := rlpLog{Address: l.Address, Topics: l.Topics, Data: l.Data}</span>
<span class="term-fg32">+	return rlp.Encode(w, &amp;rl)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type legacyRlpStorageLog struct {</span>
<span class="term-fg32">+	Address     common.Address</span>
<span class="term-fg32">+	Topics      []common.Hash</span>
<span class="term-fg32">+	Data        []byte</span>
<span class="term-fg32">+	BlockNumber uint64</span>
<span class="term-fg32">+	TxHash      common.Hash</span>
<span class="term-fg32">+	TxIndex     uint</span>
<span class="term-fg32">+	BlockHash   common.Hash</span>
<span class="term-fg32">+	Index       uint</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; DecodeRLP implements rlp.Decoder.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Note some redundant fields(e.g. block number, tx hash etc) will be assembled later.</span>
<span class="term-fg32">+func (l *LogForStorage) DecodeRLP(s *rlp.Stream) error {</span>
<span class="term-fg32">+	blob, err := s.Raw()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var dec rlpLog</span>
<span class="term-fg32">+	err = rlp.DecodeBytes(blob, &amp;dec)</span>
<span class="term-fg32">+	if err == nil {</span>
<span class="term-fg32">+		*l = LogForStorage{</span>
<span class="term-fg32">+			Address: dec.Address,</span>
<span class="term-fg32">+			Topics:  dec.Topics,</span>
<span class="term-fg32">+			Data:    dec.Data,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		&#47;&#47; Try to decode log with previous definition.</span>
<span class="term-fg32">+		var dec legacyRlpStorageLog</span>
<span class="term-fg32">+		err = rlp.DecodeBytes(blob, &amp;dec)</span>
<span class="term-fg32">+		if err == nil {</span>
<span class="term-fg32">+			*l = LogForStorage{</span>
<span class="term-fg32">+				Address: dec.Address,</span>
<span class="term-fg32">+				Topics:  dec.Topics,</span>
<span class="term-fg32">+				Data:    dec.Data,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return err</span>
 }
&nbsp;
 &#47;&#47; NewReceipt creates a barebone transaction receipt, copying the init fields.
<span class="term-fg36">@@ -132,7 +228,13 @@</span>
 &#47;&#47; encodeTyped writes the canonical encoding of a typed receipt to w.
 func (r *Receipt) encodeTyped(data *receiptRLP, w *bytes.Buffer) error {
 	w.WriteByte(r.Type)
<span class="term-fg31">-	return rlp.Encode(w, data)</span>
<span class="term-fg32">+	switch r.Type {</span>
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		withNonce := depositReceiptRlp{data.PostStateOrStatus, data.CumulativeGasUsed, data.Bloom, data.Logs, r.DepositNonce}</span>
<span class="term-fg32">+		return rlp.Encode(w, withNonce)</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return rlp.Encode(w, data)</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 &#47;&#47; MarshalBinary returns the consensus encoding of the receipt.
<span class="term-fg36">@@ -202,6 +304,15 @@</span> 			return err
 		}
 		r.Type = b[0]
 		return r.setFromRLP(data)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		var data depositReceiptRlp</span>
<span class="term-fg32">+		err := rlp.DecodeBytes(b[1:], &amp;data)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		r.Type = b[0]</span>
<span class="term-fg32">+		r.DepositNonce = data.DepositNonce</span>
<span class="term-fg32">+		return r.setFromRLP(receiptRLP{data.PostStateOrStatus, data.CumulativeGasUsed, data.Bloom, data.Logs})</span>
 	default:
 		return ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -265,6 +376,9 @@</span> 			return err
 		}
 	}
 	w.ListEnd(logList)
<span class="term-fg32">+	if r.DepositNonce != nil {</span>
<span class="term-fg32">+		w.WriteUint64(*r.DepositNonce)</span>
<span class="term-fg32">+	}</span>
 	w.ListEnd(outerList)
 	return w.Flush()
 }
<span class="term-fg36">@@ -272,8 +386,51 @@</span>
 &#47;&#47; DecodeRLP implements rlp.Decoder, and loads both consensus and implementation
 &#47;&#47; fields of a receipt from an RLP stream.
 func (r *ReceiptForStorage) DecodeRLP(s *rlp.Stream) error {
<span class="term-fg32">+	&#47;&#47; Retrieve the entire receipt blob as we need to try multiple decoders</span>
<span class="term-fg32">+	blob, err := s.Raw()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; First try to decode the latest receipt database format, try the pre-bedrock Optimism legacy format otherwise.</span>
<span class="term-fg32">+	if err := decodeStoredReceiptRLP(r, blob); err == nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return decodeLegacyOptimismReceiptRLP(r, blob)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeLegacyOptimismReceiptRLP(r *ReceiptForStorage, blob []byte) error {</span>
<span class="term-fg32">+	var stored LegacyOptimismStoredReceiptRLP</span>
<span class="term-fg32">+	if err := rlp.DecodeBytes(blob, &amp;stored); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err := (*Receipt)(r).setStatus(stored.PostStateOrStatus); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.CumulativeGasUsed = stored.CumulativeGasUsed</span>
<span class="term-fg32">+	r.Logs = make([]*Log, len(stored.Logs))</span>
<span class="term-fg32">+	for i, log := range stored.Logs {</span>
<span class="term-fg32">+		r.Logs[i] = (*Log)(log)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.Bloom = CreateBloom(Receipts{(*Receipt)(r)})</span>
<span class="term-fg32">+	&#47;&#47; UsingOVM</span>
<span class="term-fg32">+	scalar := new(big.Float)</span>
<span class="term-fg32">+	if stored.FeeScalar != &quot;&quot; {</span>
<span class="term-fg32">+		var ok bool</span>
<span class="term-fg32">+		scalar, ok = scalar.SetString(stored.FeeScalar)</span>
<span class="term-fg32">+		if !ok {</span>
<span class="term-fg32">+			return errors.New(&quot;cannot parse fee scalar&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.L1GasUsed = stored.L1GasUsed</span>
<span class="term-fg32">+	r.L1GasPrice = stored.L1GasPrice</span>
<span class="term-fg32">+	r.L1Fee = stored.L1Fee</span>
<span class="term-fg32">+	r.FeeScalar = scalar</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeStoredReceiptRLP(r *ReceiptForStorage, blob []byte) error {</span>
 	var stored storedReceiptRLP
<span class="term-fg31">-	if err := s.Decode(&amp;stored); err != nil {</span>
<span class="term-fg32">+	if err := rlp.DecodeBytes(blob, &amp;stored); err != nil {</span>
 		return err
 	}
 	if err := (*Receipt)(r).setStatus(stored.PostStateOrStatus); err != nil {
<span class="term-fg36">@@ -282,7 +439,9 @@</span> 	}
 	r.CumulativeGasUsed = stored.CumulativeGasUsed
 	r.Logs = stored.Logs
 	r.Bloom = CreateBloom(Receipts{(*Receipt)(r)})
<span class="term-fg31">-</span>
<span class="term-fg32">+	if stored.DepositNonce != nil {</span>
<span class="term-fg32">+		r.DepositNonce = stored.DepositNonce</span>
<span class="term-fg32">+	}</span>
 	return nil
 }
&nbsp;
<span class="term-fg36">@@ -304,6 +463,9 @@</span> 		w.WriteByte(AccessListTxType)
 		rlp.Encode(w, data)
 	case DynamicFeeTxType:
 		w.WriteByte(DynamicFeeTxType)
<span class="term-fg32">+		rlp.Encode(w, data)</span>
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		w.WriteByte(DepositTxType)</span>
 		rlp.Encode(w, data)
 	default:
 		&#47;&#47; For unsupported types, write nothing. Since this is for
<span class="term-fg36">@@ -314,7 +476,7 @@</span> }
&nbsp;
 &#47;&#47; DeriveFields fills the receipts with their computed fields based on consensus
 &#47;&#47; data and contextual infos like containing block and transactions.
<span class="term-fg31">-func (rs Receipts) DeriveFields(config *params.ChainConfig, hash common.Hash, number uint64, time uint64, baseFee *big.Int, txs []*Transaction) error {</span>
<span class="term-fg32">+func (rs Receipts) DeriveFields(config *params.ChainConfig, hash common.Hash, number uint64, time uint64, baseFee *big.Int, txs Transactions) error {</span>
 	signer := MakeSigner(config, new(big.Int).SetUint64(number), time)
&nbsp;
 	logIndex := uint(0)
<span class="term-fg36">@@ -337,7 +499,11 @@</span> 		&#47;&#47; The contract address can be derived from the transaction itself
 		if txs[i].To() == nil {
 			&#47;&#47; Deriving the signer is expensive, only do if it&#39;s actually needed
 			from, _ := Sender(signer, txs[i])
<span class="term-fg31">-			rs[i].ContractAddress = crypto.CreateAddress(from, txs[i].Nonce())</span>
<span class="term-fg32">+			nonce := txs[i].Nonce()</span>
<span class="term-fg32">+			if rs[i].DepositNonce != nil {</span>
<span class="term-fg32">+				nonce = *rs[i].DepositNonce</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			rs[i].ContractAddress = crypto.CreateAddress(from, nonce)</span>
 		} else {
 			rs[i].ContractAddress = common.Address{}
 		}
<span class="term-fg36">@@ -359,5 +525,28 @@</span> 			rs[i].Logs[j].Index = logIndex
 			logIndex++
 		}
 	}
<span class="term-fg32">+	if config.Optimism != nil &amp;&amp; len(txs) &gt;= 2 { &#47;&#47; need at least an info tx and a non-info tx</span>
<span class="term-fg32">+		if data := txs[0].Data(); len(data) &gt;= 4+32*8 { &#47;&#47; function selector + 8 arguments to setL1BlockValues</span>
<span class="term-fg32">+			l1Basefee := new(big.Int).SetBytes(data[4+32*2 : 4+32*3]) &#47;&#47; arg index 2</span>
<span class="term-fg32">+			overhead := new(big.Int).SetBytes(data[4+32*6 : 4+32*7])  &#47;&#47; arg index 6</span>
<span class="term-fg32">+			scalar := new(big.Int).SetBytes(data[4+32*7 : 4+32*8])    &#47;&#47; arg index 7</span>
<span class="term-fg32">+			fscalar := new(big.Float).SetInt(scalar)                  &#47;&#47; legacy: format fee scalar as big Float</span>
<span class="term-fg32">+			fdivisor := new(big.Float).SetUint64(1_000_000)           &#47;&#47; 10**6, i.e. 6 decimals</span>
<span class="term-fg32">+			feeScalar := new(big.Float).Quo(fscalar, fdivisor)</span>
<span class="term-fg32">+			for i := 0; i &lt; len(rs); i++ {</span>
<span class="term-fg32">+				if !txs[i].IsDepositTx() {</span>
<span class="term-fg32">+					gas := txs[i].RollupDataGas().DataGas(time, config)</span>
<span class="term-fg32">+					rs[i].L1GasPrice = l1Basefee</span>
<span class="term-fg32">+					&#47;&#47; GasUsed reported in receipt should include the overhead</span>
<span class="term-fg32">+					rs[i].L1GasUsed = new(big.Int).Add(new(big.Int).SetUint64(gas), overhead)</span>
<span class="term-fg32">+					rs[i].L1Fee = L1Cost(gas, l1Basefee, overhead, scalar)</span>
<span class="term-fg32">+					rs[i].FeeScalar = feeScalar</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return fmt.Errorf(&quot;L1 info tx only has %d bytes, cannot read gas price parameters&quot;, len(data))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e92d0982cad3c86f7e408349" role="button"
                   aria-expanded="false" aria-controls="id-e92d0982cad3c86f7e408349">
                    <code>core/types/gen_receipt_json.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/gen_receipt_json.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/gen_receipt_json.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e92d0982cad3c86f7e408349"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;gen_receipt_json.go op-geth&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg1">index d83be1447744a64ae8772b7459e4404b21d75eae..06558f495d3f2f930c4883162737982255aee64f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg36">@@ -29,6 +29,10 @@</span> 		EffectiveGasPrice *hexutil.Big   `json:&quot;effectiveGasPrice&quot;`
 		BlockHash         common.Hash    `json:&quot;blockHash,omitempty&quot;`
 		BlockNumber       *hexutil.Big   `json:&quot;blockNumber,omitempty&quot;`
 		TransactionIndex  hexutil.Uint   `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+		L1GasPrice        *hexutil.Big   `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		L1GasUsed         *hexutil.Big   `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		L1Fee             *hexutil.Big   `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+		FeeScalar         *big.Float     `json:&quot;l1FeeScalar,omitempty&quot;`</span>
 	}
 	var enc Receipt
 	enc.Type = hexutil.Uint64(r.Type)
<span class="term-fg36">@@ -44,6 +48,10 @@</span> 	enc.EffectiveGasPrice = (*hexutil.Big)(r.EffectiveGasPrice)
 	enc.BlockHash = r.BlockHash
 	enc.BlockNumber = (*hexutil.Big)(r.BlockNumber)
 	enc.TransactionIndex = hexutil.Uint(r.TransactionIndex)
<span class="term-fg32">+	enc.L1GasPrice = (*hexutil.Big)(r.L1GasPrice)</span>
<span class="term-fg32">+	enc.L1GasUsed = (*hexutil.Big)(r.L1GasUsed)</span>
<span class="term-fg32">+	enc.L1Fee = (*hexutil.Big)(r.L1Fee)</span>
<span class="term-fg32">+	enc.FeeScalar = r.FeeScalar</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -63,6 +71,11 @@</span> 		EffectiveGasPrice *hexutil.Big    `json:&quot;effectiveGasPrice&quot;`
 		BlockHash         *common.Hash    `json:&quot;blockHash,omitempty&quot;`
 		BlockNumber       *hexutil.Big    `json:&quot;blockNumber,omitempty&quot;`
 		TransactionIndex  *hexutil.Uint   `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+		L1GasPrice        *hexutil.Big    `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		L1GasUsed         *hexutil.Big    `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		L1Fee             *hexutil.Big    `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+		FeeScalar         *big.Float      `json:&quot;l1FeeScalar,omitempty&quot;`</span>
<span class="term-fg32">+		DepositNonce      *hexutil.Uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
 	}
 	var dec Receipt
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -111,6 +124,21 @@</span> 		r.BlockNumber = (*big.Int)(dec.BlockNumber)
 	}
 	if dec.TransactionIndex != nil {
 		r.TransactionIndex = uint(*dec.TransactionIndex)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1GasPrice != nil {</span>
<span class="term-fg32">+		r.L1GasPrice = (*big.Int)(dec.L1GasPrice)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1GasUsed != nil {</span>
<span class="term-fg32">+		r.L1GasUsed = (*big.Int)(dec.L1GasUsed)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1Fee != nil {</span>
<span class="term-fg32">+		r.L1Fee = (*big.Int)(dec.L1Fee)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.FeeScalar != nil {</span>
<span class="term-fg32">+		r.FeeScalar = dec.FeeScalar</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.DepositNonce != nil {</span>
<span class="term-fg32">+		r.DepositNonce = (*uint64)(dec.DepositNonce)</span>
 	}
 	return nil
 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-de44b8be1da277477ee9015c"role="button" aria-expanded="false" aria-controls="id-de44b8be1da277477ee9015c">
        
            <div class="col-12 col-sm-9 text-start"><h3>API Backend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+130</span></div>
                <div class="text-start"><span class="text-danger">-9</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-de44b8be1da277477ee9015c">
        <div><p>Forward transactions to the sequencer if configured.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0767a9beefa188872f1d81dc" role="button"
                   aria-expanded="false" aria-controls="id-0767a9beefa188872f1d81dc">
                    <code>eth/api_backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/api_backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/api_backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+42</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0767a9beefa188872f1d81dc"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;api_backend.go op-geth&#47;eth&#47;api_backend.go</span>
<span class="term-fg1">index 1789f106e9f2be41d58259206fd59112abf007f3..1351c009ffb0fc8d0545a6536a610a006e35452e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;api_backend.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;api_backend.go</span>
<span class="term-fg36">@@ -19,12 +19,14 @@</span>
 import (
 	&quot;context&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&#47;big&quot;
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;bloombits&quot;
<span class="term-fg36">@@ -37,6 +39,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;gasprice&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;miner&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg36">@@ -46,6 +49,7 @@</span> &#47;&#47; EthAPIBackend implements ethapi.Backend for full nodes
 type EthAPIBackend struct {
 	extRPCEnabled       bool
 	allowUnprotectedTxs bool
<span class="term-fg32">+	disableTxPool       bool</span>
 	eth                 *Ethereum
 	gpo                 *gasprice.Oracle
 }
<span class="term-fg36">@@ -196,7 +200,11 @@</span> func (b *EthAPIBackend) StateAndHeaderByNumber(ctx context.Context, number rpc.BlockNumber) (*state.StateDB, *types.Header, error) {
 	&#47;&#47; Pending state is only known by the miner
 	if number == rpc.PendingBlockNumber {
 		block, state := b.eth.miner.Pending()
<span class="term-fg31">-		return state, block.Header(), nil</span>
<span class="term-fg32">+		if block != nil {</span>
<span class="term-fg32">+			return state, block.Header(), nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			number = rpc.LatestBlockNumber</span>
<span class="term-fg32">+		}</span>
 	}
 	&#47;&#47; Otherwise resolve the block number and return its state
 	header, err := b.HeaderByNumber(ctx, number)
<span class="term-fg36">@@ -204,7 +212,7 @@</span> 	if err != nil {
 		return nil, nil, err
 	}
 	if header == nil {
<span class="term-fg31">-		return nil, nil, errors.New(&quot;header not found&quot;)</span>
<span class="term-fg32">+		return nil, nil, fmt.Errorf(&quot;header %w&quot;, ethereum.NotFound)</span>
 	}
 	stateDb, err := b.eth.BlockChain().StateAt(header.Root)
 	return stateDb, header, err
<span class="term-fg36">@@ -220,7 +228,7 @@</span> 		if err != nil {
 			return nil, nil, err
 		}
 		if header == nil {
<span class="term-fg31">-			return nil, nil, errors.New(&quot;header for hash not found&quot;)</span>
<span class="term-fg32">+			return nil, nil, fmt.Errorf(&quot;header for hash %w&quot;, ethereum.NotFound)</span>
 		}
 		if blockNrOrHash.RequireCanonical &amp;&amp; b.eth.blockchain.GetCanonicalHash(header.Number.Uint64()) != hash {
 			return nil, nil, errors.New(&quot;hash is not currently canonical&quot;)
<span class="term-fg36">@@ -255,7 +263,7 @@</span> 	var context vm.BlockContext
 	if blockCtx != nil {
 		context = *blockCtx
 	} else {
<span class="term-fg31">-		context = core.NewEVMBlockContext(header, b.eth.BlockChain(), nil)</span>
<span class="term-fg32">+		context = core.NewEVMBlockContext(header, b.eth.BlockChain(), nil, b.eth.blockchain.Config(), state)</span>
 	}
 	return vm.NewEVM(context, txContext, state, b.eth.blockchain.Config(), *vmConfig), state.Error
 }
<span class="term-fg36">@@ -284,8 +292,28 @@</span> func (b *EthAPIBackend) SubscribeLogsEvent(ch chan&lt;- []*types.Log) event.Subscription {
 	return b.eth.BlockChain().SubscribeLogsEvent(ch)
 }
&nbsp;
<span class="term-fg31">-func (b *EthAPIBackend) SendTx(ctx context.Context, signedTx *types.Transaction) error {</span>
<span class="term-fg31">-	return b.eth.txPool.AddLocal(signedTx)</span>
<span class="term-fg32">+func (b *EthAPIBackend) SendTx(ctx context.Context, tx *types.Transaction) error {</span>
<span class="term-fg32">+	if b.eth.seqRPCService != nil {</span>
<span class="term-fg32">+		data, err := tx.MarshalBinary()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if err := b.eth.seqRPCService.CallContext(ctx, nil, &quot;eth_sendRawTransaction&quot;, hexutil.Encode(data)); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if b.disableTxPool {</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Retain tx in local tx pool after forwarding, for local RPC usage.</span>
<span class="term-fg32">+		if err := b.eth.txPool.AddLocal(tx); err != nil {</span>
<span class="term-fg32">+			log.Warn(&quot;successfully sent tx to sequencer, but failed to persist in local tx pool&quot;, &quot;err&quot;, err, &quot;tx&quot;, tx.Hash())</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if b.disableTxPool {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return b.eth.txPool.AddLocal(tx)</span>
 }
&nbsp;
 func (b *EthAPIBackend) GetPoolTransactions() (types.Transactions, error) {
<span class="term-fg36">@@ -408,3 +436,11 @@</span>
 func (b *EthAPIBackend) StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, tracers.StateReleaseFunc, error) {
 	return b.eth.stateAtTransaction(ctx, block, txIndex, reexec)
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *EthAPIBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.eth.historicalRPCService</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *EthAPIBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	return b.eth.blockchain.Genesis()</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-da364149aa8a6f35e013aa48" role="button"
                   aria-expanded="false" aria-controls="id-da364149aa8a6f35e013aa48">
                    <code>eth/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+86</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-da364149aa8a6f35e013aa48"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;backend.go op-geth&#47;eth&#47;backend.go</span>
<span class="term-fg1">index 4ba8df951b1b709f548e73ab3cf3d07ce8295cd8..7c8df0d7862be3e6ee43f9cb9dec3ef456bb4ef6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;backend.go</span>
<span class="term-fg36">@@ -18,11 +18,13 @@</span> &#47;&#47; Package eth implements the Ethereum protocol.
 package eth
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;runtime&quot;
 	&quot;sync&quot;
<span class="term-fg32">+	&quot;time&quot;</span>
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -73,6 +75,9 @@</span> 	ethDialCandidates  enode.Iterator
 	snapDialCandidates enode.Iterator
 	merger             *consensus.Merger
&nbsp;
<span class="term-fg32">+	seqRPCService        *rpc.Client</span>
<span class="term-fg32">+	historicalRPCService *rpc.Client</span>
<span class="term-fg32">+</span>
 	&#47;&#47; DB interfaces
 	chainDb ethdb.Database &#47;&#47; Block chain database
&nbsp;
<span class="term-fg36">@@ -98,6 +103,8 @@</span>
 	lock sync.RWMutex &#47;&#47; Protects the variadic fields (e.g. gas price and etherbase)
&nbsp;
 	shutdownTracker *shutdowncheck.ShutdownTracker &#47;&#47; Tracks if and when the node has shutdown ungracefully
<span class="term-fg32">+</span>
<span class="term-fg32">+	nodeCloser func() error</span>
 }
&nbsp;
 &#47;&#47; New creates a new Ethereum object (including the
<span class="term-fg36">@@ -157,6 +164,7 @@</span> 		bloomRequests:     make(chan chan *bloombits.Retrieval),
 		bloomIndexer:      core.NewBloomIndexer(chainDb, params.BloomBitsBlocks, params.BloomConfirms),
 		p2pServer:         stack.Server(),
 		shutdownTracker:   shutdowncheck.NewShutdownTracker(chainDb),
<span class="term-fg32">+		nodeCloser:        stack.Close,</span>
 	}
&nbsp;
 	bcVersion := rawdb.ReadDatabaseVersion(chainDb)
<span class="term-fg36">@@ -164,7 +172,6 @@</span> 	var dbVer = &quot;&lt;nil&gt;&quot;
 	if bcVersion != nil {
 		dbVer = fmt.Sprintf(&quot;%d&quot;, *bcVersion)
 	}
<span class="term-fg31">-	log.Info(&quot;Initialising Ethereum protocol&quot;, &quot;network&quot;, config.NetworkId, &quot;dbversion&quot;, dbVer)</span>
&nbsp;
 	if !config.SkipBcVersionCheck {
 		if bcVersion != nil &amp;&amp; *bcVersion &gt; core.BlockChainVersion {
<span class="term-fg36">@@ -197,10 +204,29 @@</span> 	var overrides core.ChainOverrides
 	if config.OverrideCancun != nil {
 		overrides.OverrideCancun = config.OverrideCancun
 	}
<span class="term-fg32">+	if config.OverrideOptimismBedrock != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimismBedrock = config.OverrideOptimismBedrock</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if config.OverrideOptimismRegolith != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimismRegolith = config.OverrideOptimismRegolith</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if config.OverrideOptimism != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimism = config.OverrideOptimism</span>
<span class="term-fg32">+	}</span>
 	eth.blockchain, err = core.NewBlockChain(chainDb, cacheConfig, config.Genesis, &amp;overrides, eth.engine, vmConfig, eth.shouldPreserve, &amp;config.TxLookupLimit)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+	if chainConfig := eth.blockchain.Config(); chainConfig.Optimism != nil { &#47;&#47; config.Genesis.Config.ChainID cannot be used because it&#39;s based on CLI flags only, thus default to mainnet L1</span>
<span class="term-fg32">+		config.NetworkId = chainConfig.ChainID.Uint64() &#47;&#47; optimism defaults eth network ID to chain ID</span>
<span class="term-fg32">+		eth.networkID = config.NetworkId</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	log.Info(&quot;Initialising Ethereum protocol&quot;, &quot;network&quot;, config.NetworkId, &quot;dbversion&quot;, dbVer)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if eth.blockchain.Config().Optimism != nil { &#47;&#47; Optimism Bedrock depends on Merge functionality</span>
<span class="term-fg32">+		eth.merger.FinalizePoS()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	eth.bloomIndexer.Start(eth.blockchain)
&nbsp;
 	if config.TxPool.Journal != &quot;&quot; {
<span class="term-fg36">@@ -220,6 +246,7 @@</span> 		Sync:           config.SyncMode,
 		BloomCache:     uint64(cacheLimit),
 		EventMux:       eth.eventMux,
 		RequiredBlocks: config.RequiredBlocks,
<span class="term-fg32">+		NoTxGossip:     config.RollupDisableTxPoolGossip,</span>
 	}); err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -227,7 +254,7 @@</span>
 	eth.miner = miner.New(eth, &amp;config.Miner, eth.blockchain.Config(), eth.EventMux(), eth.engine, eth.isLocalBlock)
 	eth.miner.SetExtra(makeExtraData(config.Miner.ExtraData))
&nbsp;
<span class="term-fg31">-	eth.APIBackend = &amp;EthAPIBackend{stack.Config().ExtRPCEnabled(), stack.Config().AllowUnprotectedTxs, eth, nil}</span>
<span class="term-fg32">+	eth.APIBackend = &amp;EthAPIBackend{stack.Config().ExtRPCEnabled(), stack.Config().AllowUnprotectedTxs, config.RollupDisableTxPoolAdmission, eth, nil}</span>
 	if eth.APIBackend.allowUnprotectedTxs {
 		log.Info(&quot;Unprotected transactions allowed&quot;)
 	}
<span class="term-fg36">@@ -248,6 +275,26 @@</span> 	if err != nil {
 		return nil, err
 	}
&nbsp;
<span class="term-fg32">+	if config.RollupSequencerHTTP != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupSequencerHTTP)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		eth.seqRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupHistoricalRPC != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), config.RollupHistoricalRPCTimeout)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupHistoricalRPC)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		eth.historicalRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Start the RPC service
 	eth.netRPCService = ethapi.NewNetAPI(eth.p2pServer, config.NetworkId)
&nbsp;
<span class="term-fg36">@@ -266,7 +313,7 @@</span> func makeExtraData(extra []byte) []byte {
 	if len(extra) == 0 {
 		&#47;&#47; create default extradata
 		extra, _ = rlp.EncodeToBytes([]interface{}{
<span class="term-fg31">-			uint(params.VersionMajor&lt;&lt;16 | params.VersionMinor&lt;&lt;8 | params.VersionPatch),</span>
<span class="term-fg32">+			uint(params.OPVersionMajor&lt;&lt;16 | params.OPVersionMinor&lt;&lt;8 | params.OPVersionPatch),</span>
 			&quot;geth&quot;,
 			runtime.Version(),
 			runtime.GOOS,
<span class="term-fg36">@@ -516,6 +563,12 @@</span> 	s.txPool.Stop()
 	s.miner.Close()
 	s.blockchain.Stop()
 	s.engine.Close()
<span class="term-fg32">+	if s.seqRPCService != nil {</span>
<span class="term-fg32">+		s.seqRPCService.Close()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.historicalRPCService != nil {</span>
<span class="term-fg32">+		s.historicalRPCService.Close()</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Clean shutdown marker as the last thing before closing db
 	s.shutdownTracker.Stop()
<span class="term-fg36">@@ -525,3 +578,33 @@</span> 	s.eventMux.Stop()
&nbsp;
 	return nil
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; HandleRequiredProtocolVersion handles the protocol version signal. This implements opt-in halting,</span>
<span class="term-fg32">+&#47;&#47; the protocol version data is already logged and metered when signaled through the Engine API.</span>
<span class="term-fg32">+func (s *Ethereum) HandleRequiredProtocolVersion(required params.ProtocolVersion) error {</span>
<span class="term-fg32">+	var needLevel int</span>
<span class="term-fg32">+	switch s.config.RollupHaltOnIncompatibleProtocolVersion {</span>
<span class="term-fg32">+	case &quot;major&quot;:</span>
<span class="term-fg32">+		needLevel = 3</span>
<span class="term-fg32">+	case &quot;minor&quot;:</span>
<span class="term-fg32">+		needLevel = 2</span>
<span class="term-fg32">+	case &quot;patch&quot;:</span>
<span class="term-fg32">+		needLevel = 1</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return nil &#47;&#47; do not consider halting if not configured to</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	haveLevel := 0</span>
<span class="term-fg32">+	switch params.OPStackSupport.Compare(required) {</span>
<span class="term-fg32">+	case params.OutdatedMajor:</span>
<span class="term-fg32">+		haveLevel = 3</span>
<span class="term-fg32">+	case params.OutdatedMinor:</span>
<span class="term-fg32">+		haveLevel = 2</span>
<span class="term-fg32">+	case params.OutdatedPatch:</span>
<span class="term-fg32">+		haveLevel = 1</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if haveLevel &gt;= needLevel { &#47;&#47; halt if we opted in to do so at this granularity</span>
<span class="term-fg32">+		log.Error(&quot;Opted to halt, unprepared for protocol change&quot;, &quot;required&quot;, required, &quot;local&quot;, params.OPStackSupport)</span>
<span class="term-fg32">+		return s.nodeCloser()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-58b6f83094282403ed2bc895" role="button"
                   aria-expanded="false" aria-controls="id-58b6f83094282403ed2bc895">
                    <code>internal/ethapi/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/internal/ethapi/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/internal/ethapi/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-58b6f83094282403ed2bc895"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;backend.go op-geth&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg1">index 918b3b630922687fff53c7ae8940ef896b5bc8b3..f4124257e498c1fa58fb587218d27b06cc0ce900 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg36">@@ -86,6 +86,8 @@</span> 	SubscribeNewTxsEvent(chan&lt;- core.NewTxsEvent) event.Subscription
&nbsp;
 	ChainConfig() *params.ChainConfig
 	Engine() consensus.Engine
<span class="term-fg32">+	HistoricalRPCService() *rpc.Client</span>
<span class="term-fg32">+	Genesis() *types.Block</span>
&nbsp;
 	&#47;&#47; This is copied from filters.Backend
 	&#47;&#47; eth&#47;filters needs to be initialized from this backend type, so methods needed by</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-6a26f5149ea695934f6d42db"role="button" aria-expanded="false" aria-controls="id-6a26f5149ea695934f6d42db">
        
            <div class="col-12 col-sm-9 text-start"><h3>Apply L1 cost in API responses</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-6a26f5149ea695934f6d42db">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8dc9a2c4f8f0e1ddb16c1bf1" role="button"
                   aria-expanded="false" aria-controls="id-8dc9a2c4f8f0e1ddb16c1bf1">
                    <code>eth/state_accessor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/state_accessor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/state_accessor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8dc9a2c4f8f0e1ddb16c1bf1"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;state_accessor.go op-geth&#47;eth&#47;state_accessor.go</span>
<span class="term-fg1">index 1b0ab0c5450976e70c8e3ff3e98dbe24872e3a49..a499cd60234c4379d61c09f4724be845ff1eaad7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;state_accessor.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;state_accessor.go</span>
<span class="term-fg36">@@ -214,7 +214,7 @@</span> 	for idx, tx := range block.Transactions() {
 		&#47;&#47; Assemble the transaction call message and return if the requested offset
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), eth.blockchain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), eth.blockchain, nil, eth.blockchain.Config(), statedb)</span>
 		if idx == txIndex {
 			return msg, context, statedb, release, nil
 		}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-623eb7dfeb41071ec1823572"role="button" aria-expanded="false" aria-controls="id-623eb7dfeb41071ec1823572">
        
            <div class="col-12 col-sm-9 text-start"><h3>API frontend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+235</span></div>
                <div class="text-start"><span class="text-danger">-14</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-623eb7dfeb41071ec1823572">
        <div><p>Format deposit and L1-cost data in transaction responses. Add <code>debug_chainConfig</code> API.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-431078a2f5cc9f5e82db4f62" role="button"
                   aria-expanded="false" aria-controls="id-431078a2f5cc9f5e82db4f62">
                    <code>internal/ethapi/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/internal/ethapi/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/internal/ethapi/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+225</span></div>
                        <div class="text-start"><span class="text-danger">-14</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-431078a2f5cc9f5e82db4f62"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;api.go op-geth&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg1">index 69b5bf1304bbea7466df73b1f392dcfe68da4c22..87f9b8030c8a6ab102dca4099674a323cc50e2d7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg36">@@ -25,7 +25,11 @@</span> 	&quot;math&#47;big&quot;
 	&quot;strings&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;davecgh&#47;go-spew&#47;spew&quot;
<span class="term-fg32">+	&quot;github.com&#47;tyler-smith&#47;go-bip39&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;abi&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
<span class="term-fg36">@@ -46,7 +50,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg31">-	&quot;github.com&#47;tyler-smith&#47;go-bip39&quot;</span>
 )
&nbsp;
 &#47;&#47; EthereumAPI provides an API to access Ethereum related information.
<span class="term-fg36">@@ -631,6 +634,24 @@</span> &#47;&#47; GetBalance returns the amount of wei for the given address in the state of the
 &#47;&#47; given block number. The rpc.LatestBlockNumber and rpc.PendingBlockNumber meta
 &#47;&#47; block numbers are also allowed.
 func (s *BlockChainAPI) GetBalance(ctx context.Context, address common.Address, blockNrOrHash rpc.BlockNumberOrHash) (*hexutil.Big, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Big</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getBalance&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
<span class="term-fg36">@@ -657,6 +678,22 @@</span> }
&nbsp;
 &#47;&#47; GetProof returns the Merkle-proof for a given account and optionally some storage keys.
 func (s *BlockChainAPI) GetProof(ctx context.Context, address common.Address, storageKeys []string, blockNrOrHash rpc.BlockNumberOrHash) (*AccountResult, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res AccountResult</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getProof&quot;, address, storageKeys, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
<span class="term-fg36">@@ -737,7 +774,7 @@</span> func (s *BlockChainAPI) GetHeaderByNumber(ctx context.Context, number rpc.BlockNumber) (map[string]interface{}, error) {
 	header, err := s.b.HeaderByNumber(ctx, number)
 	if header != nil &amp;&amp; err == nil {
 		response := s.rpcMarshalHeader(ctx, header)
<span class="term-fg31">-		if number == rpc.PendingBlockNumber {</span>
<span class="term-fg32">+		if number == rpc.PendingBlockNumber &amp;&amp; s.b.ChainConfig().Optimism == nil { &#47;&#47; don&#39;t remove info if optimism</span>
 			&#47;&#47; Pending header need to nil out a few fields
 			for _, field := range []string{&quot;hash&quot;, &quot;nonce&quot;, &quot;miner&quot;} {
 				response[field] = nil
<span class="term-fg36">@@ -766,7 +803,7 @@</span> func (s *BlockChainAPI) GetBlockByNumber(ctx context.Context, number rpc.BlockNumber, fullTx bool) (map[string]interface{}, error) {
 	block, err := s.b.BlockByNumber(ctx, number)
 	if block != nil &amp;&amp; err == nil {
 		response, err := s.rpcMarshalBlock(ctx, block, true, fullTx)
<span class="term-fg31">-		if err == nil &amp;&amp; number == rpc.PendingBlockNumber {</span>
<span class="term-fg32">+		if err == nil &amp;&amp; number == rpc.PendingBlockNumber &amp;&amp; s.b.ChainConfig().Optimism == nil { &#47;&#47; don&#39;t remove info if optimism</span>
 			&#47;&#47; Pending blocks need to nil out a few fields
 			for _, field := range []string{&quot;hash&quot;, &quot;nonce&quot;, &quot;miner&quot;} {
 				response[field] = nil
<span class="term-fg36">@@ -837,10 +874,29 @@</span> }
&nbsp;
 &#47;&#47; GetCode returns the code stored at the given address in the state for the given block number.
 func (s *BlockChainAPI) GetCode(ctx context.Context, address common.Address, blockNrOrHash rpc.BlockNumberOrHash) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getCode&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	code := state.GetCode(address)
 	return code, state.Error()
 }
<span class="term-fg36">@@ -849,10 +905,29 @@</span> &#47;&#47; GetStorageAt returns the storage from the state at the given address, key and
 &#47;&#47; block number. The rpc.LatestBlockNumber and rpc.PendingBlockNumber meta block
 &#47;&#47; numbers are also allowed.
 func (s *BlockChainAPI) GetStorageAt(ctx context.Context, address common.Address, hexKey string, blockNrOrHash rpc.BlockNumberOrHash) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getStorageAt&quot;, address, hexKey, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	key, err := decodeHash(hexKey)
 	if err != nil {
 		return nil, fmt.Errorf(&quot;unable to decode storage key: %s&quot;, err)
<span class="term-fg36">@@ -861,6 +936,18 @@</span> 	res := state.GetState(address, key)
 	return res[:], state.Error()
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; The HeaderByNumberOrHash method returns a nil error and nil header</span>
<span class="term-fg32">+&#47;&#47; if the header is not found, but only for nonexistent block numbers. This is</span>
<span class="term-fg32">+&#47;&#47; different from StateAndHeaderByNumberOrHash. To account for this discrepancy,</span>
<span class="term-fg32">+&#47;&#47; headerOrNumberByHash will properly convert the error into an ethereum.NotFound.</span>
<span class="term-fg32">+func headerByNumberOrHash(ctx context.Context, b Backend, blockNrOrHash rpc.BlockNumberOrHash) (*types.Header, error) {</span>
<span class="term-fg32">+	header, err := b.HeaderByNumberOrHash(ctx, blockNrOrHash)</span>
<span class="term-fg32">+	if header == nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;header %w&quot;, ethereum.NotFound)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return header, err</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; OverrideAccount indicates the overriding fields of account during the execution
 &#47;&#47; of a message call.
 &#47;&#47; Note, state and stateDiff can&#39;t be specified at the same time. If state is
<span class="term-fg36">@@ -1015,7 +1102,7 @@</span> 	msg, err := args.ToMessage(globalGasCap, header.BaseFee)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	blockCtx := core.NewEVMBlockContext(header, NewChainContext(ctx, b), nil)</span>
<span class="term-fg32">+	blockCtx := core.NewEVMBlockContext(header, NewChainContext(ctx, b), nil, b.ChainConfig(), state)</span>
 	if blockOverrides != nil {
 		blockOverrides.Apply(&amp;blockCtx)
 	}
<span class="term-fg36">@@ -1082,6 +1169,24 @@</span> &#47;&#47;
 &#47;&#47; Note, this function doesn&#39;t make and changes in the state&#47;blockchain and is
 &#47;&#47; useful to execute and retrieve values.
 func (s *BlockChainAPI) Call(ctx context.Context, args TransactionArgs, blockNrOrHash rpc.BlockNumberOrHash, overrides *StateOverride, blockOverrides *BlockOverrides) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_call&quot;, args, blockNrOrHash, overrides)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	result, err := DoCall(ctx, s.b, args, blockNrOrHash, overrides, blockOverrides, s.b.RPCEVMTimeout(), s.b.RPCGasCap())
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -1220,6 +1325,25 @@</span> 	bNrOrHash := rpc.BlockNumberOrHashWithNumber(rpc.LatestBlockNumber)
 	if blockNrOrHash != nil {
 		bNrOrHash = *blockNrOrHash
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, bNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return 0, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Uint64</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_estimateGas&quot;, args, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return 0, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return 0, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return DoEstimateGas(ctx, s.b, args, bNrOrHash, s.b.RPCGasCap())
 }
&nbsp;
<span class="term-fg36">@@ -1259,7 +1383,7 @@</span>
 &#47;&#47; RPCMarshalBlock converts the given block to the RPC output which depends on fullTx. If inclTx is true transactions are
 &#47;&#47; returned. When fullTx is true the returned block contains full transaction details, otherwise it will only contain
 &#47;&#47; transaction hashes.
<span class="term-fg31">-func RPCMarshalBlock(block *types.Block, inclTx bool, fullTx bool, config *params.ChainConfig) (map[string]interface{}, error) {</span>
<span class="term-fg32">+func RPCMarshalBlock(ctx context.Context, block *types.Block, inclTx bool, fullTx bool, config *params.ChainConfig, backend Backend) (map[string]interface{}, error) {</span>
 	fields := RPCMarshalHeader(block.Header())
 	fields[&quot;size&quot;] = hexutil.Uint64(block.Size())
&nbsp;
<span class="term-fg36">@@ -1269,7 +1393,7 @@</span> 			return tx.Hash()
 		}
 		if fullTx {
 			formatTx = func(idx int, tx *types.Transaction) interface{} {
<span class="term-fg31">-				return newRPCTransactionFromBlockIndex(block, uint64(idx), config)</span>
<span class="term-fg32">+				return newRPCTransactionFromBlockIndex(ctx, block, uint64(idx), config, backend)</span>
 			}
 		}
 		txs := block.Transactions()
<span class="term-fg36">@@ -1302,7 +1426,7 @@</span>
 &#47;&#47; rpcMarshalBlock uses the generalized output filler, then adds the total difficulty field, which requires
 &#47;&#47; a `BlockchainAPI`.
 func (s *BlockChainAPI) rpcMarshalBlock(ctx context.Context, b *types.Block, inclTx bool, fullTx bool) (map[string]interface{}, error) {
<span class="term-fg31">-	fields, err := RPCMarshalBlock(b, inclTx, fullTx, s.b.ChainConfig())</span>
<span class="term-fg32">+	fields, err := RPCMarshalBlock(ctx, b, inclTx, fullTx, s.b.ChainConfig(), s.b)</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -1333,11 +1457,16 @@</span> 	ChainID          *hexutil.Big      `json:&quot;chainId,omitempty&quot;`
 	V                *hexutil.Big      `json:&quot;v&quot;`
 	R                *hexutil.Big      `json:&quot;r&quot;`
 	S                *hexutil.Big      `json:&quot;s&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; deposit-tx only</span>
<span class="term-fg32">+	SourceHash *common.Hash `json:&quot;sourceHash,omitempty&quot;`</span>
<span class="term-fg32">+	Mint       *hexutil.Big `json:&quot;mint,omitempty&quot;`</span>
<span class="term-fg32">+	IsSystemTx *bool        `json:&quot;isSystemTx,omitempty&quot;`</span>
 }
&nbsp;
 &#47;&#47; newRPCTransaction returns a transaction that will serialize to the RPC
 &#47;&#47; representation, with the given location metadata set (if available).
<span class="term-fg31">-func newRPCTransaction(tx *types.Transaction, blockHash common.Hash, blockNumber uint64, blockTime uint64, index uint64, baseFee *big.Int, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransaction(tx *types.Transaction, blockHash common.Hash, blockNumber uint64, blockTime uint64, index uint64, baseFee *big.Int, config *params.ChainConfig, receipt *types.Receipt) *RPCTransaction {</span>
 	signer := types.MakeSigner(config, new(big.Int).SetUint64(blockNumber), blockTime)
 	from, _ := types.Sender(signer, tx)
 	v, r, s := tx.RawSignatureValues()
<span class="term-fg36">@@ -1360,8 +1489,25 @@</span> 		result.BlockHash = &amp;blockHash
 		result.BlockNumber = (*hexutil.Big)(new(big.Int).SetUint64(blockNumber))
 		result.TransactionIndex = (*hexutil.Uint64)(&amp;index)
 	}
<span class="term-fg32">+</span>
 	switch tx.Type() {
<span class="term-fg32">+	case types.DepositTxType:</span>
<span class="term-fg32">+		srcHash := tx.SourceHash()</span>
<span class="term-fg32">+		isSystemTx := tx.IsSystemTx()</span>
<span class="term-fg32">+		result.SourceHash = &amp;srcHash</span>
<span class="term-fg32">+		if isSystemTx {</span>
<span class="term-fg32">+			&#47;&#47; Only include IsSystemTx when true</span>
<span class="term-fg32">+			result.IsSystemTx = &amp;isSystemTx</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		result.Mint = (*hexutil.Big)(tx.Mint())</span>
<span class="term-fg32">+		if receipt != nil &amp;&amp; receipt.DepositNonce != nil {</span>
<span class="term-fg32">+			result.Nonce = hexutil.Uint64(*receipt.DepositNonce)</span>
<span class="term-fg32">+		}</span>
 	case types.LegacyTxType:
<span class="term-fg32">+		if v.Sign() == 0 &amp;&amp; r.Sign() == 0 &amp;&amp; s.Sign() == 0 { &#47;&#47; pre-bedrock relayed tx does not have a signature</span>
<span class="term-fg32">+			result.ChainID = (*hexutil.Big)(new(big.Int).Set(config.ChainID))</span>
<span class="term-fg32">+			break</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; if a legacy transaction has an EIP-155 chain id, include it explicitly
 		if id := tx.ChainId(); id.Sign() != 0 {
 			result.ChainID = (*hexutil.Big)(id)
<span class="term-fg36">@@ -1400,16 +1546,32 @@</span> 		baseFee = misc.CalcBaseFee(config, current)
 		blockNumber = current.Number.Uint64()
 		blockTime = current.Time
 	}
<span class="term-fg31">-	return newRPCTransaction(tx, common.Hash{}, blockNumber, blockTime, 0, baseFee, config)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, common.Hash{}, blockNumber, blockTime, 0, baseFee, config, nil)</span>
 }
&nbsp;
 &#47;&#47; newRPCTransactionFromBlockIndex returns a transaction that will serialize to the RPC representation.
<span class="term-fg31">-func newRPCTransactionFromBlockIndex(b *types.Block, index uint64, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransactionFromBlockIndex(ctx context.Context, b *types.Block, index uint64, config *params.ChainConfig, backend Backend) *RPCTransaction {</span>
 	txs := b.Transactions()
 	if index &gt;= uint64(len(txs)) {
 		return nil
 	}
<span class="term-fg31">-	return newRPCTransaction(txs[index], b.Hash(), b.NumberU64(), b.Time(), index, b.BaseFee(), config)</span>
<span class="term-fg32">+	tx := txs[index]</span>
<span class="term-fg32">+	rcpt := depositTxReceipt(ctx, b.Hash(), index, backend, tx)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, b.Hash(), b.NumberU64(), b.Time(), index, b.BaseFee(), config, rcpt)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func depositTxReceipt(ctx context.Context, blockHash common.Hash, index uint64, backend Backend, tx *types.Transaction) *types.Receipt {</span>
<span class="term-fg32">+	if tx.Type() != types.DepositTxType {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	receipts, err := backend.GetReceipts(ctx, blockHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if index &gt;= uint64(len(receipts)) {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return receipts[index]</span>
 }
&nbsp;
 &#47;&#47; newRPCRawTransactionFromBlockIndex returns the bytes of a transaction given a block and a transaction index.
<span class="term-fg36">@@ -1438,6 +1600,21 @@</span> 	bNrOrHash := rpc.BlockNumberOrHashWithNumber(rpc.PendingBlockNumber)
 	if blockNrOrHash != nil {
 		bNrOrHash = *blockNrOrHash
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, bNrOrHash)</span>
<span class="term-fg32">+	if err == nil &amp;&amp; header != nil &amp;&amp; s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res accessListResult</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_createAccessList&quot;, args, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	acl, gasUsed, vmerr, err := AccessList(ctx, s.b, bNrOrHash, args)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -1548,7 +1725,7 @@</span>
 &#47;&#47; GetTransactionByBlockNumberAndIndex returns the transaction for the given block number and index.
 func (s *TransactionAPI) GetTransactionByBlockNumberAndIndex(ctx context.Context, blockNr rpc.BlockNumber, index hexutil.Uint) *RPCTransaction {
 	if block, _ := s.b.BlockByNumber(ctx, blockNr); block != nil {
<span class="term-fg31">-		return newRPCTransactionFromBlockIndex(block, uint64(index), s.b.ChainConfig())</span>
<span class="term-fg32">+		return newRPCTransactionFromBlockIndex(ctx, block, uint64(index), s.b.ChainConfig(), s.b)</span>
 	}
 	return nil
 }
<span class="term-fg36">@@ -1556,7 +1733,7 @@</span>
 &#47;&#47; GetTransactionByBlockHashAndIndex returns the transaction for the given block hash and index.
 func (s *TransactionAPI) GetTransactionByBlockHashAndIndex(ctx context.Context, blockHash common.Hash, index hexutil.Uint) *RPCTransaction {
 	if block, _ := s.b.BlockByHash(ctx, blockHash); block != nil {
<span class="term-fg31">-		return newRPCTransactionFromBlockIndex(block, uint64(index), s.b.ChainConfig())</span>
<span class="term-fg32">+		return newRPCTransactionFromBlockIndex(ctx, block, uint64(index), s.b.ChainConfig(), s.b)</span>
 	}
 	return nil
 }
<span class="term-fg36">@@ -1588,10 +1765,29 @@</span> 		}
 		return (*hexutil.Uint64)(&amp;nonce), nil
 	}
 	&#47;&#47; Resolve block number and use its state to ask for the nonce
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Uint64</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getTransactionCount&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	nonce := state.GetNonce(address)
 	return (*hexutil.Uint64)(&amp;nonce), state.Error()
 }
<span class="term-fg36">@@ -1608,7 +1804,8 @@</span> 		header, err := s.b.HeaderByHash(ctx, blockHash)
 		if err != nil {
 			return nil, err
 		}
<span class="term-fg31">-		return newRPCTransaction(tx, blockHash, blockNumber, header.Time, index, header.BaseFee, s.b.ChainConfig()), nil</span>
<span class="term-fg32">+		rcpt := depositTxReceipt(ctx, blockHash, index, s.b, tx)</span>
<span class="term-fg32">+		return newRPCTransaction(tx, blockHash, blockNumber, header.Time, index, header.BaseFee, s.b.ChainConfig(), rcpt), nil</span>
 	}
 	&#47;&#47; No finalized transaction, try to retrieve it from the pool
 	if tx := s.b.GetPoolTransaction(hash); tx != nil {
<span class="term-fg36">@@ -1675,6 +1872,16 @@</span> 		&quot;logs&quot;:              receipt.Logs,
 		&quot;logsBloom&quot;:         receipt.Bloom,
 		&quot;type&quot;:              hexutil.Uint(tx.Type()),
 		&quot;effectiveGasPrice&quot;: (*hexutil.Big)(receipt.EffectiveGasPrice),
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().Optimism != nil &amp;&amp; !tx.IsDepositTx() {</span>
<span class="term-fg32">+		fields[&quot;l1GasPrice&quot;] = (*hexutil.Big)(receipt.L1GasPrice)</span>
<span class="term-fg32">+		fields[&quot;l1GasUsed&quot;] = (*hexutil.Big)(receipt.L1GasUsed)</span>
<span class="term-fg32">+		fields[&quot;l1Fee&quot;] = (*hexutil.Big)(receipt.L1Fee)</span>
<span class="term-fg32">+		fields[&quot;l1FeeScalar&quot;] = receipt.FeeScalar.String()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.b.ChainConfig().Optimism != nil &amp;&amp; tx.IsDepositTx() &amp;&amp; receipt.DepositNonce != nil {</span>
<span class="term-fg32">+		fields[&quot;depositNonce&quot;] = hexutil.Uint64(*receipt.DepositNonce)</span>
 	}
&nbsp;
 	&#47;&#47; Assign receipt status or post state.
<span class="term-fg36">@@ -2063,6 +2270,10 @@</span>
 &#47;&#47; SetHead rewinds the head of the blockchain to a previous block.
 func (api *DebugAPI) SetHead(number hexutil.Uint64) {
 	api.b.SetHead(uint64(number))
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (api *DebugAPI) ChainConfig() *params.ChainConfig {</span>
<span class="term-fg32">+	return api.b.ChainConfig()</span>
 }
&nbsp;
 &#47;&#47; NetAPI offers network related RPC methods</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9e153357208480de02df4f85" role="button"
                   aria-expanded="false" aria-controls="id-9e153357208480de02df4f85">
                    <code>rpc/errors.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/rpc/errors.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/rpc/errors.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9e153357208480de02df4f85"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;errors.go op-geth&#47;rpc&#47;errors.go</span>
<span class="term-fg1">index 7188332d551ebdcd541438d7a58daad996b5c70f..4a2dab3d9836494a8618d56bfa204e2339a12491 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;errors.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;errors.go</span>
<span class="term-fg36">@@ -69,6 +69,16 @@</span> const (
 	errMsgTimeout = &quot;request timed out&quot;
 )
&nbsp;
<span class="term-fg32">+var ErrNoHistoricalFallback = NoHistoricalFallbackError{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type NoHistoricalFallbackError struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (e NoHistoricalFallbackError) ErrorCode() int { return -32801 }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (e NoHistoricalFallbackError) Error() string {</span>
<span class="term-fg32">+	return &quot;no historical RPC is available for this historical (pre-bedrock) execution request&quot;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 type methodNotFoundError struct{ method string }
&nbsp;
 func (e *methodNotFoundError) ErrorCode() int { return -32601 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-ac347065eec7f0304856ebac"role="button" aria-expanded="false" aria-controls="id-ac347065eec7f0304856ebac">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tracer RPC daisy-chain</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+59</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-ac347065eec7f0304856ebac">
        <div><p>Forward pre-bedrock tracing calls to legacy node.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-44c71cf43a0706768c686214" role="button"
                   aria-expanded="false" aria-controls="id-44c71cf43a0706768c686214">
                    <code>eth/tracers/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/tracers/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/tracers/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+59</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-44c71cf43a0706768c686214"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;api.go op-geth&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg1">index 5e90180df8d5b603279d52a5a0e0221f12514911..d634ff59fd917bac52b4e5c4e6222a2be4891b39 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg36">@@ -23,6 +23,7 @@</span> 	&quot;context&quot;
 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
 	&quot;os&quot;
 	&quot;runtime&quot;
 	&quot;sync&quot;
<span class="term-fg36">@@ -68,8 +69,6 @@</span> 	&#47;&#47; trace states exceed this limit.
 	maximumPendingTraceStates = 128
 )
&nbsp;
<span class="term-fg31">-var errTxNotFound = errors.New(&quot;transaction not found&quot;)</span>
<span class="term-fg31">-</span>
 &#47;&#47; StateReleaseFunc is used to deallocate resources held by constructing a
 &#47;&#47; historical state for tracing purposes.
 type StateReleaseFunc func()
<span class="term-fg36">@@ -88,6 +87,7 @@</span> 	Engine() consensus.Engine
 	ChainDb() ethdb.Database
 	StateAtBlock(ctx context.Context, block *types.Block, reexec uint64, base *state.StateDB, readOnly bool, preferDisk bool) (*state.StateDB, StateReleaseFunc, error)
 	StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, StateReleaseFunc, error)
<span class="term-fg32">+	HistoricalRPCService() *rpc.Client</span>
 }
&nbsp;
 &#47;&#47; API is the collection of tracing APIs exposed over the private debugging endpoint.
<span class="term-fg36">@@ -208,6 +208,7 @@</span>
 &#47;&#47; TraceChain returns the structured logs created during the execution of EVM
 &#47;&#47; between two blocks (excluding start) and returns them as a JSON object.
 func (api *API) TraceChain(ctx context.Context, start, end rpc.BlockNumber, config *TraceConfig) (*rpc.Subscription, error) { &#47;&#47; Fetch the block interval that we want to trace
<span class="term-fg32">+	&#47;&#47; TODO: Need to implement a fallback for this</span>
 	from, err := api.blockByNumber(ctx, start)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -266,7 +267,7 @@</span> 			&#47;&#47; Fetch and execute the block trace taskCh
 			for task := range taskCh {
 				var (
 					signer   = types.MakeSigner(api.backend.ChainConfig(), task.block.Number(), task.block.Time())
<span class="term-fg31">-					blockCtx = core.NewEVMBlockContext(task.block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+					blockCtx = core.NewEVMBlockContext(task.block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), task.statedb)</span>
 				)
 				&#47;&#47; Trace all the transactions contained within
 				for i, tx := range task.block.Transactions() {
<span class="term-fg36">@@ -436,6 +437,20 @@</span> 	block, err := api.blockByNumber(ctx, number)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult []*txTraceResult</span>
<span class="term-fg32">+			err = api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceBlockByNumber&quot;, number, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return api.traceBlock(ctx, block, config)
 }
&nbsp;
<span class="term-fg36">@@ -446,6 +461,20 @@</span> 	block, err := api.blockByHash(ctx, hash)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult []*txTraceResult</span>
<span class="term-fg32">+			err = api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceBlockByHash&quot;, hash, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return api.traceBlock(ctx, block, config)
 }
&nbsp;
<span class="term-fg36">@@ -495,6 +524,7 @@</span> &#47;&#47; IntermediateRoots executes a block (bad- or canon- or side-), and returns a list
 &#47;&#47; of intermediate roots: the stateroot after each transaction.
 func (api *API) IntermediateRoots(ctx context.Context, hash common.Hash, config *TraceConfig) ([]common.Hash, error) {
 	block, _ := api.blockByHash(ctx, hash)
<span class="term-fg32">+	&#47;&#47; TODO: Cannot get intermediate roots for pre-bedrock block without daisy chain</span>
 	if block == nil {
 		&#47;&#47; Check in the bad blocks
 		block = rawdb.ReadBadBlock(api.backend.ChainDb(), hash)
<span class="term-fg36">@@ -523,7 +553,7 @@</span> 	var (
 		roots              []common.Hash
 		signer             = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		chainConfig        = api.backend.ChainConfig()
<span class="term-fg31">-		vmctx              = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		vmctx              = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, chainConfig, statedb)</span>
 		deleteEmptyObjects = chainConfig.IsEIP158(block.Number())
 	)
 	for i, tx := range block.Transactions() {
<span class="term-fg36">@@ -599,7 +629,7 @@</span> 	var (
 		txs       = block.Transactions()
 		blockHash = block.Hash()
 		is158     = api.backend.ChainConfig().IsEIP158(block.Number())
<span class="term-fg31">-		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 		signer    = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		results   = make([]*txTraceResult, len(txs))
 	)
<span class="term-fg36">@@ -632,7 +662,6 @@</span> 	&#47;&#47; Execute all the transaction contained within the block concurrently
 	var (
 		txs       = block.Transactions()
 		blockHash = block.Hash()
<span class="term-fg31">-		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
 		signer    = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		results   = make([]*txTraceResult, len(txs))
 		pend      sync.WaitGroup
<span class="term-fg36">@@ -648,6 +677,7 @@</span> 		go func() {
 			defer pend.Done()
 			&#47;&#47; Fetch and execute the next transaction trace tasks
 			for task := range jobs {
<span class="term-fg32">+				blockCtx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), task.statedb)</span>
 				msg, _ := core.TransactionToMessage(txs[task.index], signer, block.BaseFee())
 				txctx := &amp;Context{
 					BlockHash:   blockHash,
<span class="term-fg36">@@ -667,6 +697,7 @@</span> 	}
&nbsp;
 	&#47;&#47; Feed the transactions into the tracers and return
 	var failed error
<span class="term-fg32">+	blockCtx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 txloop:
 	for i, tx := range txs {
 		&#47;&#47; Send the trace task over for execution
<span class="term-fg36">@@ -744,7 +775,7 @@</span> 	var (
 		dumps       []string
 		signer      = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		chainConfig = api.backend.ChainConfig()
<span class="term-fg31">-		vmctx       = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		vmctx       = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, chainConfig, statedb)</span>
 		canon       = true
 	)
 	&#47;&#47; Check if there are any overrides: the caller may wish to enable a future
<span class="term-fg36">@@ -826,14 +857,25 @@</span>
 &#47;&#47; TraceTransaction returns the structured logs created during the execution of EVM
 &#47;&#47; and returns them as a JSON object.
 func (api *API) TraceTransaction(ctx context.Context, hash common.Hash, config *TraceConfig) (interface{}, error) {
<span class="term-fg31">-	tx, blockHash, blockNumber, index, err := api.backend.GetTransaction(ctx, hash)</span>
<span class="term-fg32">+	&#47;&#47; GetTransaction returns 0 for the blocknumber if the transaction is not found</span>
<span class="term-fg32">+	_, blockHash, blockNumber, index, err := api.backend.GetTransaction(ctx, hash)</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	&#47;&#47; Only mined txes are supported</span>
<span class="term-fg31">-	if tx == nil {</span>
<span class="term-fg31">-		return nil, errTxNotFound</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(new(big.Int).SetUint64(blockNumber)) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult json.RawMessage</span>
<span class="term-fg32">+			err := api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceTransaction&quot;, hash, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
 	}
<span class="term-fg32">+</span>
 	&#47;&#47; It shouldn&#39;t happen in practice.
 	if blockNumber == 0 {
 		return nil, errors.New(&quot;genesis is not traceable&quot;)
<span class="term-fg36">@@ -888,6 +930,11 @@</span> 	}
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		return nil, errors.New(&quot;l2geth does not have a debug_traceCall method&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; try to recompute the state
 	reexec := defaultTraceReexec
 	if config != nil &amp;&amp; config.Reexec != nil {
<span class="term-fg36">@@ -899,7 +946,7 @@</span> 		return nil, err
 	}
 	defer release()
&nbsp;
<span class="term-fg31">-	vmctx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+	vmctx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 	&#47;&#47; Apply the customization rules if required.
 	if config != nil {
 		if err := config.StateOverrides.Apply(statedb); err != nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-2be2954a1ec85c34d3f36998"role="button" aria-expanded="false" aria-controls="id-2be2954a1ec85c34d3f36998">
        
            <div class="col-12 col-sm-9 text-start"><h3>Light Ethereum Subprotocol (LES) RPC</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+37</span></div>
                <div class="text-start"><span class="text-danger">-4</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-2be2954a1ec85c34d3f36998">
        <div><p>Match the RPC changes in the LES RPC</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1eb03d0be7fa90b0ec778d91" role="button"
                   aria-expanded="false" aria-controls="id-1eb03d0be7fa90b0ec778d91">
                    <code>les/client.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/les/client.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/les/client.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+25</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1eb03d0be7fa90b0ec778d91"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;client.go op-geth&#47;les&#47;client.go</span>
<span class="term-fg1">index bd6667429e54b3c2867f5725a1a77223b144971f..69f9cae3aa75e8d364c416979cee90808abd5c2c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;client.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;client.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> &#47;&#47; Package les implements the Light Ethereum Subprotocol.
 package les
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;strings&quot;
 	&quot;time&quot;
<span class="term-fg36">@@ -66,6 +67,9 @@</span> 	serverPool         *vfc.ServerPool
 	serverPoolIterator enode.Iterator
 	pruner             *pruner
 	merger             *consensus.Merger
<span class="term-fg32">+</span>
<span class="term-fg32">+	seqRPCService        *rpc.Client</span>
<span class="term-fg32">+	historicalRPCService *rpc.Client</span>
&nbsp;
 	bloomRequests chan chan *bloombits.Retrieval &#47;&#47; Channel receiving bloom data retrieval requests
 	bloomIndexer  *core.ChainIndexer             &#47;&#47; Bloom indexer operating during block imports
<span class="term-fg36">@@ -189,6 +193,27 @@</span> 	}
 	leth.ApiBackend.gpo = gasprice.NewOracle(leth.ApiBackend, gpoParams)
&nbsp;
 	leth.handler = newClientHandler(config.UltraLightServers, config.UltraLightFraction, leth)
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupSequencerHTTP != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupSequencerHTTP)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		leth.seqRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupHistoricalRPC != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), config.RollupHistoricalRPCTimeout)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupHistoricalRPC)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		leth.historicalRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	leth.netRPCService = ethapi.NewNetAPI(leth.p2pServer, leth.config.NetworkId)
&nbsp;
 	&#47;&#47; Register the backend on the node</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1751723498b07fa5396997ad" role="button"
                   aria-expanded="false" aria-controls="id-1751723498b07fa5396997ad">
                    <code>les/odr_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/les/odr_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/les/odr_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1751723498b07fa5396997ad"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;odr_test.go op-geth&#47;les&#47;odr_test.go</span>
<span class="term-fg1">index 2db9acd4335e7d381298d4850e86a79218465dad..2e64094bfb232cc7d0c6e93d2aeb3eafc2b6e89a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;odr_test.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;odr_test.go</span>
<span class="term-fg36">@@ -144,7 +144,7 @@</span> 					Data:              data,
 					SkipAccountChecks: true,
 				}
&nbsp;
<span class="term-fg31">-				context := core.NewEVMBlockContext(header, bc, nil)</span>
<span class="term-fg32">+				context := core.NewEVMBlockContext(header, bc, nil, config, statedb)</span>
 				txContext := core.NewEVMTxContext(msg)
 				vmenv := vm.NewEVM(context, txContext, statedb, config, vm.Config{NoBaseFee: true})
&nbsp;
<span class="term-fg36">@@ -168,7 +168,7 @@</span> 				GasTipCap:         new(big.Int),
 				Data:              data,
 				SkipAccountChecks: true,
 			}
<span class="term-fg31">-			context := core.NewEVMBlockContext(header, lc, nil)</span>
<span class="term-fg32">+			context := core.NewEVMBlockContext(header, lc, nil, config, state)</span>
 			txContext := core.NewEVMTxContext(msg)
 			vmenv := vm.NewEVM(context, txContext, state, config, vm.Config{NoBaseFee: true})
 			gp := new(core.GasPool).AddGas(math.MaxUint64)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e52c443bf3cb22000d887801" role="button"
                   aria-expanded="false" aria-controls="id-e52c443bf3cb22000d887801">
                    <code>les/state_accessor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/les/state_accessor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/les/state_accessor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e52c443bf3cb22000d887801"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;state_accessor.go op-geth&#47;les&#47;state_accessor.go</span>
<span class="term-fg1">index 9a8214ac2f8f044493965fe989c54316a690a883..9383c2cc35019ff747ae8ec24edbac4a39121658 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;state_accessor.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;state_accessor.go</span>
<span class="term-fg36">@@ -62,7 +62,7 @@</span> 	for idx, tx := range block.Transactions() {
 		&#47;&#47; Assemble the transaction call message and return if the requested offset
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), leth.blockchain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), leth.blockchain, nil, leth.blockchain.Config(), statedb)</span>
 		statedb.SetTxContext(tx.Hash(), idx)
 		if idx == txIndex {
 			return msg, context, statedb, release, nil</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-dbe81ebf0e3d8e6741ce1482" role="button"
                   aria-expanded="false" aria-controls="id-dbe81ebf0e3d8e6741ce1482">
                    <code>les/api_backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/les/api_backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/les/api_backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-dbe81ebf0e3d8e6741ce1482"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;api_backend.go op-geth&#47;les&#47;api_backend.go</span>
<span class="term-fg1">index 97665757b19a6793fb34c6aa78eb6c453f97e272..838e08d37627cdaeeb6160bc5ac98ae0131003f2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;api_backend.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;api_backend.go</span>
<span class="term-fg36">@@ -189,7 +189,7 @@</span> 	if vmConfig == nil {
 		vmConfig = new(vm.Config)
 	}
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(header, b.eth.blockchain, nil)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(header, b.eth.blockchain, nil, b.eth.chainConfig, state)</span>
 	if blockCtx != nil {
 		context = *blockCtx
 	}
<span class="term-fg36">@@ -336,3 +336,11 @@</span>
 func (b *LesApiBackend) StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, tracers.StateReleaseFunc, error) {
 	return b.eth.stateAtTransaction(ctx, block, txIndex, reexec)
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *LesApiBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.eth.historicalRPCService</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *LesApiBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	return b.eth.blockchain.Genesis()</span>
<span class="term-fg32">+}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-ed6479fb08d25626024cc849"role="button" aria-expanded="false" aria-controls="id-ed6479fb08d25626024cc849">
        
            <div class="col-12 col-sm-9 text-start"><h3>Daisy Chain tests</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+351</span></div>
                <div class="text-start"><span class="text-danger">-18</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-ed6479fb08d25626024cc849">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b63b8c140a8628cce9002e4c" role="button"
                   aria-expanded="false" aria-controls="id-b63b8c140a8628cce9002e4c">
                    <code>internal/ethapi/transaction_args_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/internal/ethapi/transaction_args_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/internal/ethapi/transaction_args_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b63b8c140a8628cce9002e4c"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;transaction_args_test.go op-geth&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg1">index 0868f8762cb521dd2c5d68d5815ee12f93ed59ab..14663f4c2edbed6c51f2e4571b9a85d86bc95414 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg36">@@ -342,4 +342,6 @@</span> func (b *backendMock) SubscribeRemovedLogsEvent(ch chan&lt;- core.RemovedLogsEvent) event.Subscription {
 	return nil
 }
&nbsp;
<span class="term-fg31">-func (b *backendMock) Engine() consensus.Engine { return nil }</span>
<span class="term-fg32">+func (b *backendMock) Engine() consensus.Engine          { return nil }</span>
<span class="term-fg32">+func (b *backendMock) HistoricalRPCService() *rpc.Client { return nil }</span>
<span class="term-fg32">+func (b *backendMock) Genesis() *types.Block             { return nil }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d42f1b7a3e05445dea5ec115" role="button"
                   aria-expanded="false" aria-controls="id-d42f1b7a3e05445dea5ec115">
                    <code>ethclient/ethclient_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/ethclient/ethclient_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/ethclient/ethclient_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+152</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d42f1b7a3e05445dea5ec115"><span class="term-fg1">diff --git go-ethereum&#47;ethclient&#47;ethclient_test.go op-geth&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg1">index 385676075655352d334d54e6004e5cd0fabfcaab..66db4f8ebd24fb296fc7b819bcecc3a28a7a8b3e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg1">+++ op-geth&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg36">@@ -20,10 +20,16 @@</span> import (
 	&quot;bytes&quot;
 	&quot;context&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&#47;big&quot;
<span class="term-fg32">+	&quot;net&quot;</span>
<span class="term-fg32">+	&quot;net&#47;http&quot;</span>
 	&quot;reflect&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;ethapi&quot;</span>
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -193,6 +199,14 @@</span> 	Timestamp: 9000,
 	BaseFee:   big.NewInt(params.InitialBaseFee),
 }
&nbsp;
<span class="term-fg32">+var genesisForHistorical = &amp;core.Genesis{</span>
<span class="term-fg32">+	Config:    params.OptimismTestConfig,</span>
<span class="term-fg32">+	Alloc:     core.GenesisAlloc{testAddr: {Balance: testBalance}},</span>
<span class="term-fg32">+	ExtraData: []byte(&quot;test genesis&quot;),</span>
<span class="term-fg32">+	Timestamp: 9000,</span>
<span class="term-fg32">+	BaseFee:   big.NewInt(params.InitialBaseFee),</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 var testTx1 = types.MustSignNewTx(testKey, types.LatestSigner(genesis.Config), &amp;types.LegacyTx{
 	Nonce:    0,
 	Value:    big.NewInt(12),
<span class="term-fg36">@@ -209,9 +223,64 @@</span> 	Gas:      params.TxGas,
 	To:       &amp;common.Address{2},
 })
&nbsp;
<span class="term-fg31">-func newTestBackend(t *testing.T) (*node.Node, []*types.Block) {</span>
<span class="term-fg32">+type mockHistoricalBackend struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) Call(ctx context.Context, args ethapi.TransactionArgs, blockNrOrHash rpc.BlockNumberOrHash, overrides *ethapi.StateOverride) (hexutil.Bytes, error) {</span>
<span class="term-fg32">+	num, ok := blockNrOrHash.Number()</span>
<span class="term-fg32">+	if ok &amp;&amp; num == 1 {</span>
<span class="term-fg32">+		return hexutil.Bytes(&quot;test&quot;), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil, ethereum.NotFound</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) EstimateGas(ctx context.Context, args ethapi.TransactionArgs, blockNrOrHash *rpc.BlockNumberOrHash) (hexutil.Uint64, error) {</span>
<span class="term-fg32">+	num, ok := blockNrOrHash.Number()</span>
<span class="term-fg32">+	if ok &amp;&amp; num == 1 {</span>
<span class="term-fg32">+		return hexutil.Uint64(12345), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0, ethereum.NotFound</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newMockHistoricalBackend(t *testing.T) string {</span>
<span class="term-fg32">+	s := rpc.NewServer()</span>
<span class="term-fg32">+	err := node.RegisterApis([]rpc.API{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			Namespace:     &quot;eth&quot;,</span>
<span class="term-fg32">+			Service:       new(mockHistoricalBackend),</span>
<span class="term-fg32">+			Public:        true,</span>
<span class="term-fg32">+			Authenticated: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}, nil, s)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	hdlr := node.NewHTTPHandlerStack(s, []string{&quot;*&quot;}, []string{&quot;*&quot;}, nil)</span>
<span class="term-fg32">+	mux := http.NewServeMux()</span>
<span class="term-fg32">+	mux.Handle(&quot;&#47;&quot;, hdlr)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	listener, err := net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend listener: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	go func() {</span>
<span class="term-fg32">+		httpS := &amp;http.Server{Handler: mux}</span>
<span class="term-fg32">+		httpS.Serve(listener)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Cleanup(func() {</span>
<span class="term-fg32">+			httpS.Shutdown(context.Background())</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;http:&#47;&#47;%s&quot;, listener.Addr().String())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newTestBackend(t *testing.T, enableHistoricalState bool) (*node.Node, []*types.Block) {</span>
<span class="term-fg32">+	histAddr := newMockHistoricalBackend(t)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Generate test chain.
<span class="term-fg31">-	blocks := generateTestChain()</span>
<span class="term-fg32">+	blocks := generateTestChain(enableHistoricalState)</span>
&nbsp;
 	&#47;&#47; Create node
 	n, err := node.New(&amp;node.Config{})
<span class="term-fg36">@@ -219,7 +288,17 @@</span> 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new node: %v&quot;, err)
 	}
 	&#47;&#47; Create Ethereum Service
<span class="term-fg31">-	config := &amp;ethconfig.Config{Genesis: genesis}</span>
<span class="term-fg32">+	var actualGenesis *core.Genesis</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		actualGenesis = genesisForHistorical</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		actualGenesis = genesis</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	config := &amp;ethconfig.Config{Genesis: actualGenesis}</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		config.RollupHistoricalRPC = histAddr</span>
<span class="term-fg32">+		config.RollupHistoricalRPCTimeout = time.Second * 5</span>
<span class="term-fg32">+	}</span>
 	ethservice, err := eth.New(n, config)
 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new ethereum service: %v&quot;, err)
<span class="term-fg36">@@ -234,7 +313,7 @@</span> 	}
 	return n, blocks
 }
&nbsp;
<span class="term-fg31">-func generateTestChain() []*types.Block {</span>
<span class="term-fg32">+func generateTestChain(enableHistoricalState bool) []*types.Block {</span>
 	generate := func(i int, g *core.BlockGen) {
 		g.OffsetTime(5)
 		g.SetExtra([]byte(&quot;test&quot;))
<span class="term-fg36">@@ -244,12 +323,27 @@</span> 			g.AddTx(testTx1)
 			g.AddTx(testTx2)
 		}
 	}
<span class="term-fg31">-	_, blocks, _ := core.GenerateChainWithGenesis(genesis, ethash.NewFaker(), 2, generate)</span>
<span class="term-fg31">-	return append([]*types.Block{genesis.ToBlock()}, blocks...)</span>
<span class="term-fg32">+	var actualGenesis *core.Genesis</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		actualGenesis = genesisForHistorical</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		actualGenesis = genesis</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	_, blocks, _ := core.GenerateChainWithGenesis(actualGenesis, ethash.NewFaker(), 2, generate)</span>
<span class="term-fg32">+	return append([]*types.Block{actualGenesis.ToBlock()}, blocks...)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestEthClientHistoricalBackend(t *testing.T) {</span>
<span class="term-fg32">+	backend, _ := newTestBackend(t, true)</span>
<span class="term-fg32">+	client, _ := backend.Attach()</span>
<span class="term-fg32">+	defer backend.Close()</span>
<span class="term-fg32">+	defer client.Close()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	testHistoricalRPC(t, client)</span>
 }
&nbsp;
 func TestEthClient(t *testing.T) {
<span class="term-fg31">-	backend, chain := newTestBackend(t)</span>
<span class="term-fg32">+	backend, chain := newTestBackend(t, false)</span>
 	client, _ := backend.Attach()
 	defer backend.Close()
 	defer client.Close()
<span class="term-fg36">@@ -286,6 +380,9 @@</span> 			func(t *testing.T) { testAtFunctions(t, client) },
 		},
 		&quot;TransactionSender&quot;: {
 			func(t *testing.T) { testTransactionSender(t, client) },
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&quot;EstimateGas&quot;: {</span>
<span class="term-fg32">+			func(t *testing.T) { testEstimateGas(t, client) },</span>
 		},
 	}
&nbsp;
<span class="term-fg36">@@ -682,6 +779,54 @@</span> 		t.Fatal(err)
 	}
 	if sender2 != testAddr {
 		t.Fatal(&quot;wrong sender:&quot;, sender2)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testEstimateGas(t *testing.T, client *rpc.Client) {</span>
<span class="term-fg32">+	ec := NewClient(client)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; EstimateGas</span>
<span class="term-fg32">+	msg := ethereum.CallMsg{</span>
<span class="term-fg32">+		From:  testAddr,</span>
<span class="term-fg32">+		To:    &amp;common.Address{},</span>
<span class="term-fg32">+		Gas:   21000,</span>
<span class="term-fg32">+		Value: big.NewInt(1),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	gas, err := ec.EstimateGas(context.Background(), msg)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if gas != 21000 {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected gas price: %v&quot;, gas)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testHistoricalRPC(t *testing.T, client *rpc.Client) {</span>
<span class="term-fg32">+	ec := NewClient(client)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Estimate Gas RPC</span>
<span class="term-fg32">+	msg := ethereum.CallMsg{</span>
<span class="term-fg32">+		From:  testAddr,</span>
<span class="term-fg32">+		To:    &amp;common.Address{},</span>
<span class="term-fg32">+		Gas:   21000,</span>
<span class="term-fg32">+		Value: big.NewInt(1),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var res hexutil.Uint64</span>
<span class="term-fg32">+	err := client.CallContext(context.Background(), &amp;res, &quot;eth_estimateGas&quot;, toCallArg(msg), rpc.BlockNumberOrHashWithNumber(1))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if res != 12345 {</span>
<span class="term-fg32">+		t.Fatalf(&quot;invalid result: %d&quot;, res)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Call Contract RPC</span>
<span class="term-fg32">+	histVal, err := ec.CallContract(context.Background(), msg, big.NewInt(1))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if string(histVal) != &quot;test&quot; {</span>
<span class="term-fg32">+		t.Fatalf(&quot;expected %s to equal test&quot;, string(histVal))</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f8960505a490112dbcb33e7c" role="button"
                   aria-expanded="false" aria-controls="id-f8960505a490112dbcb33e7c">
                    <code>eth/tracers/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/tracers/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/tracers/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+196</span></div>
                        <div class="text-start"><span class="text-danger">-10</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f8960505a490112dbcb33e7c"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;api_test.go op-geth&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg1">index fdb02b18950e99555328c69692178cdc21093212..04fdaab7fa0f1b37c9a08bcd72457ff4b33fca96 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg36">@@ -24,12 +24,15 @@</span> 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg32">+	&quot;net&quot;</span>
<span class="term-fg32">+	&quot;net&#47;http&quot;</span>
 	&quot;reflect&quot;
 	&quot;sort&quot;
 	&quot;sync&#47;atomic&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;davecgh&#47;go-spew&#47;spew&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
<span class="term-fg36">@@ -43,15 +46,78 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&#47;logger&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;ethapi&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;node&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;mock&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg31">-	errStateNotFound = errors.New(&quot;state not found&quot;)</span>
<span class="term-fg31">-	errBlockNotFound = errors.New(&quot;block not found&quot;)</span>
<span class="term-fg32">+	errStateNotFound       = errors.New(&quot;state not found&quot;)</span>
<span class="term-fg32">+	errBlockNotFound       = errors.New(&quot;block not found&quot;)</span>
<span class="term-fg32">+	errTransactionNotFound = errors.New(&quot;transaction not found&quot;)</span>
 )
&nbsp;
<span class="term-fg32">+type mockHistoricalBackend struct {</span>
<span class="term-fg32">+	mock.Mock</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; mockHistoricalBackend does not have a TraceCall, because pre-bedrock there is no debug_traceCall available</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) TraceBlockByNumber(ctx context.Context, number rpc.BlockNumber, config *TraceConfig) ([]*txTraceResult, error) {</span>
<span class="term-fg32">+	ret := m.Mock.MethodCalled(&quot;TraceBlockByNumber&quot;, number, config)</span>
<span class="term-fg32">+	return ret[0].([]*txTraceResult), *ret[1].(*error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) ExpectTraceBlockByNumber(number rpc.BlockNumber, config *TraceConfig, out []*txTraceResult, err error) {</span>
<span class="term-fg32">+	m.Mock.On(&quot;TraceBlockByNumber&quot;, number, config).Once().Return(out, &amp;err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) TraceTransaction(ctx context.Context, hash common.Hash, config *TraceConfig) (interface{}, error) {</span>
<span class="term-fg32">+	ret := m.Mock.MethodCalled(&quot;TraceTransaction&quot;, hash, config)</span>
<span class="term-fg32">+	return ret[0], *ret[1].(*error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) ExpectTraceTransaction(hash common.Hash, config *TraceConfig, out interface{}, err error) {</span>
<span class="term-fg32">+	jsonOut, _ := json.Marshal(out)</span>
<span class="term-fg32">+	m.Mock.On(&quot;TraceTransaction&quot;, hash, config).Once().Return(json.RawMessage(jsonOut), &amp;err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newMockHistoricalBackend(t *testing.T, backend *mockHistoricalBackend) string {</span>
<span class="term-fg32">+	s := rpc.NewServer()</span>
<span class="term-fg32">+	err := node.RegisterApis([]rpc.API{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			Namespace:     &quot;debug&quot;,</span>
<span class="term-fg32">+			Service:       backend,</span>
<span class="term-fg32">+			Public:        true,</span>
<span class="term-fg32">+			Authenticated: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}, nil, s)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	hdlr := node.NewHTTPHandlerStack(s, []string{&quot;*&quot;}, []string{&quot;*&quot;}, nil)</span>
<span class="term-fg32">+	mux := http.NewServeMux()</span>
<span class="term-fg32">+	mux.Handle(&quot;&#47;&quot;, hdlr)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	listener, err := net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend listener: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	go func() {</span>
<span class="term-fg32">+		httpS := &amp;http.Server{Handler: mux}</span>
<span class="term-fg32">+		httpS.Serve(listener)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Cleanup(func() {</span>
<span class="term-fg32">+			httpS.Shutdown(context.Background())</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;http:&#47;&#47;%s&quot;, listener.Addr().String())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 type testBackend struct {
 	chainConfig *params.ChainConfig
 	engine      consensus.Engine
<span class="term-fg36">@@ -60,15 +126,28 @@</span> 	chain       *core.BlockChain
&nbsp;
 	refHook func() &#47;&#47; Hook is invoked when the requested state is referenced
 	relHook func() &#47;&#47; Hook is invoked when the requested state is released
<span class="term-fg32">+</span>
<span class="term-fg32">+	historical     *rpc.Client</span>
<span class="term-fg32">+	mockHistorical *mockHistoricalBackend</span>
 }
&nbsp;
 &#47;&#47; testBackend creates a new test backend. OBS: After test is done, teardown must be
 &#47;&#47; invoked in order to release associated resources.
 func newTestBackend(t *testing.T, n int, gspec *core.Genesis, generator func(i int, b *core.BlockGen)) *testBackend {
<span class="term-fg32">+	mock := new(mockHistoricalBackend)</span>
<span class="term-fg32">+	historicalAddr := newMockHistoricalBackend(t, mock)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	historicalClient, err := rpc.Dial(historicalAddr)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error making historical client: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	backend := &amp;testBackend{
<span class="term-fg31">-		chainConfig: gspec.Config,</span>
<span class="term-fg31">-		engine:      ethash.NewFaker(),</span>
<span class="term-fg31">-		chaindb:     rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		chainConfig:    gspec.Config,</span>
<span class="term-fg32">+		engine:         ethash.NewFaker(),</span>
<span class="term-fg32">+		chaindb:        rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		historical:     historicalClient,</span>
<span class="term-fg32">+		mockHistorical: mock,</span>
 	}
 	&#47;&#47; Generate blocks for testing
 	_, blocks, _ := core.GenerateChainWithGenesis(gspec, backend.engine, n, generator)
<span class="term-fg36">@@ -116,6 +195,9 @@</span> }
&nbsp;
 func (b *testBackend) GetTransaction(ctx context.Context, txHash common.Hash) (*types.Transaction, common.Hash, uint64, uint64, error) {
 	tx, hash, blockNumber, index := rawdb.ReadTransaction(b.chaindb, txHash)
<span class="term-fg32">+	if tx == nil {</span>
<span class="term-fg32">+		return nil, common.Hash{}, 0, 0, errTransactionNotFound</span>
<span class="term-fg32">+	}</span>
 	return tx, hash, blockNumber, index, nil
 }
&nbsp;
<span class="term-fg36">@@ -173,7 +255,7 @@</span> 	signer := types.MakeSigner(b.chainConfig, block.Number(), block.Time())
 	for idx, tx := range block.Transactions() {
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), b.chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), b.chain, nil, b.chainConfig, statedb)</span>
 		if idx == txIndex {
 			return msg, context, statedb, release, nil
 		}
<span class="term-fg36">@@ -184,6 +266,10 @@</span> 		}
 		statedb.Finalise(vmenv.ChainConfig().IsEIP158(block.Number()))
 	}
 	return nil, vm.BlockContext{}, nil, nil, fmt.Errorf(&quot;transaction index %d out of range for block %#x&quot;, txIndex, block.Hash())
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *testBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.historical</span>
 }
&nbsp;
 func TestTraceCall(t *testing.T) {
<span class="term-fg36">@@ -361,11 +447,58 @@</span> 		StructLogs:  []logger.StructLogRes{},
 	}) {
 		t.Error(&quot;Transaction tracing result is different&quot;)
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+func TestTraceTransactionHistorical(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
&nbsp;
<span class="term-fg31">-	&#47;&#47; Test non-existent transaction</span>
<span class="term-fg31">-	_, err = api.TraceTransaction(context.Background(), common.Hash{42}, nil)</span>
<span class="term-fg31">-	if !errors.Is(err, errTxNotFound) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;want %v, have %v&quot;, errTxNotFound, err)</span>
<span class="term-fg32">+	&#47;&#47; Initialize test accounts</span>
<span class="term-fg32">+	accounts := newAccounts(2)</span>
<span class="term-fg32">+	genesis := &amp;core.Genesis{</span>
<span class="term-fg32">+		Config: params.OptimismTestConfig,</span>
<span class="term-fg32">+		Alloc: core.GenesisAlloc{</span>
<span class="term-fg32">+			accounts[0].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[1].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	target := common.Hash{}</span>
<span class="term-fg32">+	signer := types.HomesteadSigner{}</span>
<span class="term-fg32">+	backend := newTestBackend(t, 1, genesis, func(i int, b *core.BlockGen) {</span>
<span class="term-fg32">+		&#47;&#47; Transfer from account[0] to account[1]</span>
<span class="term-fg32">+		&#47;&#47;    value: 1000 wei</span>
<span class="term-fg32">+		&#47;&#47;    fee:   0 wei</span>
<span class="term-fg32">+		tx, _ := types.SignTx(types.NewTransaction(uint64(i), accounts[1].addr, big.NewInt(1000), params.TxGas, b.BaseFee(), nil), signer, accounts[0].key)</span>
<span class="term-fg32">+		b.AddTx(tx)</span>
<span class="term-fg32">+		target = tx.Hash()</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer backend.mockHistorical.AssertExpectations(t)</span>
<span class="term-fg32">+	defer backend.chain.Stop()</span>
<span class="term-fg32">+	backend.mockHistorical.ExpectTraceTransaction(</span>
<span class="term-fg32">+		target,</span>
<span class="term-fg32">+		nil,</span>
<span class="term-fg32">+		logger.ExecutionResult{</span>
<span class="term-fg32">+			Gas:         params.TxGas,</span>
<span class="term-fg32">+			Failed:      false,</span>
<span class="term-fg32">+			ReturnValue: &quot;&quot;,</span>
<span class="term-fg32">+			StructLogs:  []logger.StructLogRes{},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		nil)</span>
<span class="term-fg32">+	api := NewAPI(backend)</span>
<span class="term-fg32">+	result, err := api.TraceTransaction(context.Background(), target, nil)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;Failed to trace transaction %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var have *logger.ExecutionResult</span>
<span class="term-fg32">+	spew.Dump(result)</span>
<span class="term-fg32">+	if err := json.Unmarshal(result.(json.RawMessage), &amp;have); err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;failed to unmarshal result %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if !reflect.DeepEqual(have, &amp;logger.ExecutionResult{</span>
<span class="term-fg32">+		Gas:         params.TxGas,</span>
<span class="term-fg32">+		Failed:      false,</span>
<span class="term-fg32">+		ReturnValue: &quot;&quot;,</span>
<span class="term-fg32">+		StructLogs:  []logger.StructLogRes{},</span>
<span class="term-fg32">+	}) {</span>
<span class="term-fg32">+		t.Error(&quot;Transaction tracing result is different&quot;)</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -449,6 +582,59 @@</span> 		want := tc.want
 		if string(have) != want {
 			t.Errorf(&quot;test %d, result mismatch, have\n%v\n, want\n%v\n&quot;, i, string(have), want)
 		}
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTraceBlockHistorical(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Initialize test accounts</span>
<span class="term-fg32">+	accounts := newAccounts(3)</span>
<span class="term-fg32">+	genesis := &amp;core.Genesis{</span>
<span class="term-fg32">+		Config: params.OptimismTestConfig,</span>
<span class="term-fg32">+		Alloc: core.GenesisAlloc{</span>
<span class="term-fg32">+			accounts[0].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[1].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[2].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	genBlocks := 10</span>
<span class="term-fg32">+	signer := types.HomesteadSigner{}</span>
<span class="term-fg32">+	backend := newTestBackend(t, genBlocks, genesis, func(i int, b *core.BlockGen) {</span>
<span class="term-fg32">+		&#47;&#47; Transfer from account[0] to account[1]</span>
<span class="term-fg32">+		&#47;&#47;    value: 1000 wei</span>
<span class="term-fg32">+		&#47;&#47;    fee:   0 wei</span>
<span class="term-fg32">+		tx, _ := types.SignTx(types.NewTransaction(uint64(i), accounts[1].addr, big.NewInt(1000), params.TxGas, b.BaseFee(), nil), signer, accounts[0].key)</span>
<span class="term-fg32">+		b.AddTx(tx)</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer backend.mockHistorical.AssertExpectations(t)</span>
<span class="term-fg32">+	defer backend.chain.Stop()</span>
<span class="term-fg32">+	api := NewAPI(backend)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var expectErr error</span>
<span class="term-fg32">+	var config *TraceConfig</span>
<span class="term-fg32">+	blockNumber := rpc.BlockNumber(3)</span>
<span class="term-fg32">+	want := `[{&quot;txHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;result&quot;:{&quot;failed&quot;:false,&quot;gas&quot;:21000,&quot;returnValue&quot;:&quot;&quot;,&quot;structLogs&quot;:[]}}]`</span>
<span class="term-fg32">+	var ret []*txTraceResult</span>
<span class="term-fg32">+	_ = json.Unmarshal([]byte(want), &amp;ret)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	backend.mockHistorical.ExpectTraceBlockByNumber(blockNumber, config, ret, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := api.TraceBlockByNumber(context.Background(), blockNumber, config)</span>
<span class="term-fg32">+	if expectErr != nil {</span>
<span class="term-fg32">+		if err == nil {</span>
<span class="term-fg32">+			t.Errorf(&quot;want error %v&quot;, expectErr)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !reflect.DeepEqual(err, expectErr) {</span>
<span class="term-fg32">+			t.Errorf(&quot;error mismatch, want %v, get %v&quot;, expectErr, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;want no error, have %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	have, _ := json.Marshal(result)</span>
<span class="term-fg32">+	if string(have) != want {</span>
<span class="term-fg32">+		t.Errorf(&quot;result mismatch, have\n%v\n, want\n%v\n&quot;, string(have), want)</span>
 	}
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-af909f07c0236dd4dd2b2be3"role="button" aria-expanded="false" aria-controls="id-af909f07c0236dd4dd2b2be3">
        
            <div class="col-12 col-sm-9 text-start"><h2>Geth extras</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+325</span></div>
                <div class="text-start"><span class="text-danger">-25</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-af909f07c0236dd4dd2b2be3">
        <div><p>Extend the tools available in geth to improve external testing and tooling.</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-5764b2b7a752b114454647de"role="button" aria-expanded="false" aria-controls="id-5764b2b7a752b114454647de">
        
            <div class="col-12 col-sm-9 text-start"><h3>Simulated Backend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+90</span></div>
                <div class="text-start"><span class="text-danger">-19</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-5764b2b7a752b114454647de">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-46eee3ca2d6b4bafd06f77aa" role="button"
                   aria-expanded="false" aria-controls="id-46eee3ca2d6b4bafd06f77aa">
                    <code>accounts/abi/bind/backends/simulated.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/accounts/abi/bind/backends/simulated.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/accounts/abi/bind/backends/simulated.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+90</span></div>
                        <div class="text-start"><span class="text-danger">-19</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-46eee3ca2d6b4bafd06f77aa"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go op-geth&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg1">index 0af520b5d927915c190b7044a898c6b1df8c0a1d..bd59ca783b955a8a95489e30cb4d0f06c8f11a59 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg36">@@ -30,6 +30,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;abi&#47;bind&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;ethash&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;bloombits&quot;
<span class="term-fg36">@@ -63,6 +64,8 @@</span> type SimulatedBackend struct {
 	database   ethdb.Database   &#47;&#47; In memory database to store our testing data
 	blockchain *core.BlockChain &#47;&#47; Ethereum blockchain to handle the consensus
&nbsp;
<span class="term-fg32">+	consensus consensus.Engine</span>
<span class="term-fg32">+</span>
 	mu              sync.Mutex
 	pendingBlock    *types.Block   &#47;&#47; Currently pending block that will be imported on request
 	pendingState    *state.StateDB &#47;&#47; Currently pending state that will be the active on request
<span class="term-fg36">@@ -78,20 +81,93 @@</span> &#47;&#47; NewSimulatedBackendWithDatabase creates a new binding backend based on the given database
 &#47;&#47; and uses a simulated blockchain for testing purposes.
 &#47;&#47; A simulated backend always uses chainID 1337.
 func NewSimulatedBackendWithDatabase(database ethdb.Database, alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {
<span class="term-fg31">-	genesis := core.Genesis{</span>
<span class="term-fg31">-		Config:   params.AllEthashProtocolChanges,</span>
<span class="term-fg31">-		GasLimit: gasLimit,</span>
<span class="term-fg31">-		Alloc:    alloc,</span>
<span class="term-fg32">+	return NewSimulatedBackendWithOpts(WithDatabase(database), WithAlloc(alloc), WithGasLimit(gasLimit))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewSimulatedBackend creates a new binding backend using a simulated blockchain</span>
<span class="term-fg32">+&#47;&#47; for testing purposes.</span>
<span class="term-fg32">+&#47;&#47; A simulated backend always uses chainID 1337.</span>
<span class="term-fg32">+func NewSimulatedBackend(alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {</span>
<span class="term-fg32">+	return NewSimulatedBackendWithOpts(WithGasLimit(gasLimit), WithAlloc(alloc))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type simulatedBackendConfig struct {</span>
<span class="term-fg32">+	genesis     core.Genesis</span>
<span class="term-fg32">+	cacheConfig *core.CacheConfig</span>
<span class="term-fg32">+	database    ethdb.Database</span>
<span class="term-fg32">+	vmConfig    vm.Config</span>
<span class="term-fg32">+	consensus   consensus.Engine</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type SimulatedBackendOpt func(s *simulatedBackendConfig)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithDatabase(database ethdb.Database) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.database = database</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithGasLimit(gasLimit uint64) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis.GasLimit = gasLimit</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithAlloc(alloc core.GenesisAlloc) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis.Alloc = alloc</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithCacheConfig(cacheConfig *core.CacheConfig) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.cacheConfig = cacheConfig</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithGenesis(genesis core.Genesis) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis = genesis</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithVMConfig(vmConfig vm.Config) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.vmConfig = vmConfig</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithConsensus(consensus consensus.Engine) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.consensus = consensus</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewSimulatedBackendWithOpts creates a new binding backend based on the given database</span>
<span class="term-fg32">+&#47;&#47; and uses a simulated blockchain for testing purposes. It exposes additional configuration</span>
<span class="term-fg32">+&#47;&#47; options that are useful to</span>
<span class="term-fg32">+func NewSimulatedBackendWithOpts(opts ...SimulatedBackendOpt) *SimulatedBackend {</span>
<span class="term-fg32">+	config := &amp;simulatedBackendConfig{</span>
<span class="term-fg32">+		genesis:   core.Genesis{Config: params.AllEthashProtocolChanges, GasLimit: 100000000, Alloc: make(core.GenesisAlloc)},</span>
<span class="term-fg32">+		database:  rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		consensus: ethash.NewFaker(),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for _, opt := range opts {</span>
<span class="term-fg32">+		opt(config)</span>
 	}
<span class="term-fg31">-	blockchain, _ := core.NewBlockChain(database, nil, &amp;genesis, nil, ethash.NewFaker(), vm.Config{}, nil, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	config.genesis.MustCommit(config.database)</span>
<span class="term-fg32">+	blockchain, _ := core.NewBlockChain(config.database, config.cacheConfig, &amp;config.genesis, nil, config.consensus, config.vmConfig, nil, nil)</span>
&nbsp;
 	backend := &amp;SimulatedBackend{
<span class="term-fg31">-		database:   database,</span>
<span class="term-fg32">+		database:   config.database,</span>
 		blockchain: blockchain,
<span class="term-fg31">-		config:     genesis.Config,</span>
<span class="term-fg32">+		config:     config.genesis.Config,</span>
<span class="term-fg32">+		consensus:  config.consensus,</span>
 	}
&nbsp;
<span class="term-fg31">-	filterBackend := &amp;filterBackend{database, blockchain, backend}</span>
<span class="term-fg32">+	filterBackend := &amp;filterBackend{config.database, blockchain, backend}</span>
 	backend.filterSystem = filters.NewFilterSystem(filterBackend, filters.Config{})
 	backend.events = filters.NewEventSystem(backend.filterSystem, false)
&nbsp;
<span class="term-fg36">@@ -102,13 +178,6 @@</span> 	backend.rollback(block)
 	return backend
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NewSimulatedBackend creates a new binding backend using a simulated blockchain</span>
<span class="term-fg31">-&#47;&#47; for testing purposes.</span>
<span class="term-fg31">-&#47;&#47; A simulated backend always uses chainID 1337.</span>
<span class="term-fg31">-func NewSimulatedBackend(alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {</span>
<span class="term-fg31">-	return NewSimulatedBackendWithDatabase(rawdb.NewMemoryDatabase(), alloc, gasLimit)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; Close terminates the underlying blockchain&#39;s update loop.
 func (b *SimulatedBackend) Close() error {
 	b.blockchain.Stop()
<span class="term-fg36">@@ -124,6 +193,8 @@</span>
 	if _, err := b.blockchain.InsertChain([]*types.Block{b.pendingBlock}); err != nil {
 		panic(err) &#47;&#47; This cannot happen unless the simulator is wrong, fail in that case
 	}
<span class="term-fg32">+	&#47;&#47; Don&#39;t wait for the async tx indexing</span>
<span class="term-fg32">+	rawdb.WriteTxLookupEntriesByBlock(b.database, b.pendingBlock)</span>
 	blockHash := b.pendingBlock.Hash()
&nbsp;
 	&#47;&#47; Using the last inserted block here makes it possible to build on a side
<span class="term-fg36">@@ -145,7 +216,7 @@</span> 	b.rollback(block)
 }
&nbsp;
 func (b *SimulatedBackend) rollback(parent *types.Block) {
<span class="term-fg31">-	blocks, _ := core.GenerateChain(b.config, parent, ethash.NewFaker(), b.database, 1, func(int, *core.BlockGen) {})</span>
<span class="term-fg32">+	blocks, _ := core.GenerateChain(b.config, parent, b.consensus, b.database, 1, func(int, *core.BlockGen) {})</span>
&nbsp;
 	b.pendingBlock = blocks[0]
 	b.pendingState, _ = state.New(b.pendingBlock.Root(), b.blockchain.StateCache(), nil)
<span class="term-fg36">@@ -666,7 +737,7 @@</span>
 	&#47;&#47; Create a new environment which holds all relevant information
 	&#47;&#47; about the transaction and calling mechanisms.
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	evmContext := core.NewEVMBlockContext(header, b.blockchain, nil)</span>
<span class="term-fg32">+	evmContext := core.NewEVMBlockContext(header, b.blockchain, nil, b.config, stateDB)</span>
 	vmEnv := vm.NewEVM(evmContext, txContext, stateDB, b.config, vm.Config{NoBaseFee: true})
 	gasPool := new(core.GasPool).AddGas(math.MaxUint64)
&nbsp;
<span class="term-fg36">@@ -694,7 +765,7 @@</span> 	if tx.Nonce() != nonce {
 		return fmt.Errorf(&quot;invalid transaction nonce: got %d, want %d&quot;, tx.Nonce(), nonce)
 	}
 	&#47;&#47; Include tx in chain
<span class="term-fg31">-	blocks, receipts := core.GenerateChain(b.config, block, ethash.NewFaker(), b.database, 1, func(number int, block *core.BlockGen) {</span>
<span class="term-fg32">+	blocks, receipts := core.GenerateChain(b.config, block, b.consensus, b.database, 1, func(number int, block *core.BlockGen) {</span>
 		for _, tx := range b.pendingBlock.Transactions() {
 			block.AddTxWithChain(b.blockchain, tx)
 		}
<span class="term-fg36">@@ -818,7 +889,7 @@</span> 	if block == nil {
 		return fmt.Errorf(&quot;could not find parent&quot;)
 	}
&nbsp;
<span class="term-fg31">-	blocks, _ := core.GenerateChain(b.config, block, ethash.NewFaker(), b.database, 1, func(number int, block *core.BlockGen) {</span>
<span class="term-fg32">+	blocks, _ := core.GenerateChain(b.config, block, b.consensus, b.database, 1, func(number int, block *core.BlockGen) {</span>
 		block.OffsetTime(int64(adjustment.Seconds()))
 	})
 	stateDB, _ := b.blockchain.State()</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-84487707b9edee637cca443d"role="button" aria-expanded="false" aria-controls="id-84487707b9edee637cca443d">
        
            <div class="col-12 col-sm-9 text-start"><h3>diff-included testing testing</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+235</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-84487707b9edee637cca443d">
        <div><p>Most of the op-geth changes are tested in the Optimism Monorepo and not part of the geth diff,
but some testing like the Deposit TX encoding and API interactions are embedded in the op-geth diff instead.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ae87216cd9f4fafa7ffa3094" role="button"
                   aria-expanded="false" aria-controls="id-ae87216cd9f4fafa7ffa3094">
                    <code>core/types/transaction_marshalling_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/transaction_marshalling_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+103</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ae87216cd9f4fafa7ffa3094"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_marshalling_test.go op-geth&#47;core&#47;types&#47;transaction_marshalling_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..4ab93a539d19bbcffa0293738b2e4dcc3ebe7ad2</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_marshalling_test.go</span>
<span class="term-fg36">@@ -0,0 +1,103 @@</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;encoding&#47;json&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTransactionUnmarshalJsonDeposit(t *testing.T) {</span>
<span class="term-fg32">+	tx := NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	json, err := tx.MarshalJSON()</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;Failed to marshal tx JSON&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	got := &amp;Transaction{}</span>
<span class="term-fg32">+	err = got.UnmarshalJSON(json)</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;Failed to unmarshal tx JSON&quot;)</span>
<span class="term-fg32">+	require.Equal(t, tx.Hash(), got.Hash())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTransactionUnmarshalJSON(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name          string</span>
<span class="term-fg32">+		json          string</span>
<span class="term-fg32">+		expectedError string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No gas&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;gas&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No value&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;value&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No input&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;input&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No from&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;from&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No sourceHash&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;sourceHash&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;No mint&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			&#47;&#47; Allowed</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;No IsSystemTx&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			&#47;&#47; Allowed</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			var parsedTx = &amp;Transaction{}</span>
<span class="term-fg32">+			err := json.Unmarshal([]byte(test.json), &amp;parsedTx)</span>
<span class="term-fg32">+			if test.expectedError == &quot;&quot; {</span>
<span class="term-fg32">+				require.NoError(t, err)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				require.ErrorContains(t, err, test.expectedError)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	tests = []struct {</span>
<span class="term-fg32">+		name          string</span>
<span class="term-fg32">+		json          string</span>
<span class="term-fg32">+		expectedError string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Valid deposit sender&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:&quot;0x1&quot;,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			var parsedTx = &amp;Transaction{}</span>
<span class="term-fg32">+			err := json.Unmarshal([]byte(test.json), &amp;parsedTx)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			signer := NewLondonSigner(big.NewInt(123))</span>
<span class="term-fg32">+			sender, err := signer.Sender(parsedTx)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			require.Equal(t, common.HexToAddress(&quot;0x1&quot;), sender)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b17f80470241d8ebc515289b" role="button"
                   aria-expanded="false" aria-controls="id-b17f80470241d8ebc515289b">
                    <code>internal/ethapi/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/internal/ethapi/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/internal/ethapi/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+132</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b17f80470241d8ebc515289b"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;api_test.go op-geth&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg1">index 61024900b20fd5368e6740df5e8dff8938f87167..9970e2a1ac02b4e9caca6e622fdf5e7c85beab33 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg36">@@ -46,9 +46,125 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;
 )
&nbsp;
<span class="term-fg32">+func TestNewRPCTransactionDepositTx(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	nonce := uint64(7)</span>
<span class="term-fg32">+	receipt := &amp;types.Receipt{</span>
<span class="term-fg32">+		DepositNonce: &amp;nonce,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, receipt)</span>
<span class="term-fg32">+	&#47;&#47; Should provide zero values for unused fields that are required in other transactions</span>
<span class="term-fg32">+	require.Equal(t, got.GasPrice, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().GasPrice = %v, want 0x0&quot;, got.GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, got.V, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().V = %v, want 0x0&quot;, got.V)</span>
<span class="term-fg32">+	require.Equal(t, got.R, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().R = %v, want 0x0&quot;, got.R)</span>
<span class="term-fg32">+	require.Equal(t, got.S, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().S = %v, want 0x0&quot;, got.S)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Should include deposit tx specific fields</span>
<span class="term-fg32">+	require.Equal(t, *got.SourceHash, tx.SourceHash(), &quot;newRPCTransaction().SourceHash = %v, want %v&quot;, got.SourceHash, tx.SourceHash())</span>
<span class="term-fg32">+	require.Equal(t, *got.IsSystemTx, tx.IsSystemTx(), &quot;newRPCTransaction().IsSystemTx = %v, want %v&quot;, got.IsSystemTx, tx.IsSystemTx())</span>
<span class="term-fg32">+	require.Equal(t, got.Mint, (*hexutil.Big)(tx.Mint()), &quot;newRPCTransaction().Mint = %v, want %v&quot;, got.Mint, tx.Mint())</span>
<span class="term-fg32">+	require.Equal(t, got.Nonce, (hexutil.Uint64)(nonce), &quot;newRPCTransaction().Mint = %v, want %v&quot;, got.Nonce, nonce)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestNewRPCTransactionOmitIsSystemTxFalse(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		IsSystemTransaction: false,</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Nil(t, got.IsSystemTx, &quot;should omit IsSystemTx when false&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestUnmarshalRpcDepositTx(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name     string</span>
<span class="term-fg32">+		modifier func(tx *RPCTransaction)</span>
<span class="term-fg32">+		valid    bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:     &quot;Unmodified&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {},</span>
<span class="term-fg32">+			valid:    true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Zero Values&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.R = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.S = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.GasPrice = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Nil Values&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = nil</span>
<span class="term-fg32">+				tx.R = nil</span>
<span class="term-fg32">+				tx.S = nil</span>
<span class="term-fg32">+				tx.GasPrice = nil</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero GasPrice&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.GasPrice = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero V&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero R&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.R = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero S&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.S = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+				SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+				IsSystemTransaction: true,</span>
<span class="term-fg32">+				Mint:                big.NewInt(34),</span>
<span class="term-fg32">+			})</span>
<span class="term-fg32">+			rpcTx := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, nil)</span>
<span class="term-fg32">+			test.modifier(rpcTx)</span>
<span class="term-fg32">+			json, err := json.Marshal(rpcTx)</span>
<span class="term-fg32">+			require.NoError(t, err, &quot;marshalling failed: %w&quot;, err)</span>
<span class="term-fg32">+			parsed := &amp;types.Transaction{}</span>
<span class="term-fg32">+			err = parsed.UnmarshalJSON(json)</span>
<span class="term-fg32">+			if test.valid {</span>
<span class="term-fg32">+				require.NoError(t, err, &quot;unmarshal failed: %w&quot;, err)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				require.Error(t, err, &quot;unmarshal should have failed but did not&quot;)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func TestTransaction_RoundTripRpcJSON(t *testing.T) {
 	var (
 		config = params.AllEthashProtocolChanges
<span class="term-fg36">@@ -73,7 +189,7 @@</span> 			t.Fatalf(&quot;test %d: stx changed, want %x have %x&quot;, i, want, have)
 		}
&nbsp;
 		&#47;&#47;  rpcTransaction
<span class="term-fg31">-		rpcTx := newRPCTransaction(tx, common.Hash{}, 0, 0, 0, nil, config)</span>
<span class="term-fg32">+		rpcTx := newRPCTransaction(tx, common.Hash{}, 0, 0, 0, nil, config, nil)</span>
 		if data, err := json.Marshal(rpcTx); err != nil {
 			t.Fatalf(&quot;test %d: marshalling failed; %v&quot;, i, err)
 		} else if err = tx2.UnmarshalJSON(data); err != nil {
<span class="term-fg36">@@ -237,7 +353,11 @@</span> func (b testBackend) HeaderByHash(ctx context.Context, hash common.Hash) (*types.Header, error) {
 	panic(&quot;implement me&quot;)
 }
 func (b testBackend) HeaderByNumberOrHash(ctx context.Context, blockNrOrHash rpc.BlockNumberOrHash) (*types.Header, error) {
<span class="term-fg31">-	panic(&quot;implement me&quot;)</span>
<span class="term-fg32">+	if blockNrOrHash.BlockHash != nil {</span>
<span class="term-fg32">+		return b.chain.GetHeaderByHash(*blockNrOrHash.BlockHash), nil</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		return b.HeaderByNumber(ctx, *blockNrOrHash.BlockNumber)</span>
<span class="term-fg32">+	}</span>
 }
 func (b testBackend) CurrentHeader() *types.Header { panic(&quot;implement me&quot;) }
 func (b testBackend) CurrentBlock() *types.Header  { panic(&quot;implement me&quot;) }
<span class="term-fg36">@@ -291,7 +411,7 @@</span> 	if vmConfig == nil {
 		vmConfig = b.chain.GetVMConfig()
 	}
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(header, b.chain, nil)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(header, b.chain, nil, b.ChainConfig(), state)</span>
 	if blockContext != nil {
 		context = *blockContext
 	}
<span class="term-fg36">@@ -345,6 +465,12 @@</span> func (b testBackend) BloomStatus() (uint64, uint64) { panic(&quot;implement me&quot;) }
 func (b testBackend) ServiceFilter(ctx context.Context, session *bloombits.MatcherSession) {
 	panic(&quot;implement me&quot;)
 }
<span class="term-fg32">+func (b testBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	panic(&quot;implement me&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+func (b testBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	panic(&quot;implement me&quot;)</span>
<span class="term-fg32">+}</span>
&nbsp;
 func TestEstimateGas(t *testing.T) {
 	t.Parallel()
<span class="term-fg36">@@ -489,7 +615,7 @@</span> 				From:  &amp;accounts[0].addr,
 				To:    &amp;accounts[1].addr,
 				Value: (*hexutil.Big)(big.NewInt(1000)),
 			},
<span class="term-fg31">-			expectErr: errors.New(&quot;header not found&quot;),</span>
<span class="term-fg32">+			expectErr: ethereum.NotFound,</span>
 		},
 		&#47;&#47; transfer on the latest block
 		{
<span class="term-fg36">@@ -705,12 +831,12 @@</span> 		&#47;&#47; full tx details
 		{
 			inclTx: true,
 			fullTx: true,
<span class="term-fg31">-			want:   `{&quot;difficulty&quot;:&quot;0x0&quot;,&quot;extraData&quot;:&quot;0x&quot;,&quot;gasLimit&quot;:&quot;0x0&quot;,&quot;gasUsed&quot;:&quot;0x0&quot;,&quot;hash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;logsBloom&quot;:&quot;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;miner&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;mixHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;nonce&quot;:&quot;0x0000000000000000&quot;,&quot;number&quot;:&quot;0x64&quot;,&quot;parentHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;receiptsRoot&quot;:&quot;0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421&quot;,&quot;sha3Uncles&quot;:&quot;0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347&quot;,&quot;size&quot;:&quot;0x296&quot;,&quot;stateRoot&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;timestamp&quot;:&quot;0x0&quot;,&quot;transactions&quot;:[{&quot;blockHash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;blockNumber&quot;:&quot;0x64&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;gas&quot;:&quot;0x457&quot;,&quot;gasPrice&quot;:&quot;0x2b67&quot;,&quot;hash&quot;:&quot;0x7d39df979e34172322c64983a9ad48302c2b889e55bda35324afecf043a77605&quot;,&quot;input&quot;:&quot;0x111111&quot;,&quot;nonce&quot;:&quot;0x1&quot;,&quot;to&quot;:&quot;0x0000000000000000000000000000000000000011&quot;,&quot;transactionIndex&quot;:&quot;0x0&quot;,&quot;value&quot;:&quot;0x6f&quot;,&quot;type&quot;:&quot;0x1&quot;,&quot;accessList&quot;:[],&quot;chainId&quot;:&quot;0x539&quot;,&quot;v&quot;:&quot;0x0&quot;,&quot;r&quot;:&quot;0x0&quot;,&quot;s&quot;:&quot;0x0&quot;},{&quot;blockHash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;blockNumber&quot;:&quot;0x64&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;gas&quot;:&quot;0x457&quot;,&quot;gasPrice&quot;:&quot;0x2b67&quot;,&quot;hash&quot;:&quot;0x9bba4c34e57c875ff57ac8d172805a26ae912006985395dc1bdf8f44140a7bf4&quot;,&quot;input&quot;:&quot;0x111111&quot;,&quot;nonce&quot;:&quot;0x2&quot;,&quot;to&quot;:&quot;0x0000000000000000000000000000000000000011&quot;,&quot;transactionIndex&quot;:&quot;0x1&quot;,&quot;value&quot;:&quot;0x6f&quot;,&quot;type&quot;:&quot;0x0&quot;,&quot;chainId&quot;:&quot;0x7fffffffffffffee&quot;,&quot;v&quot;:&quot;0x0&quot;,&quot;r&quot;:&quot;0x0&quot;,&quot;s&quot;:&quot;0x0&quot;},{&quot;blockHash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;blockNumber&quot;:&quot;0x64&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;gas&quot;:&quot;0x457&quot;,&quot;gasPrice&quot;:&quot;0x2b67&quot;,&quot;hash&quot;:&quot;0x98909ea1ff040da6be56bc4231d484de1414b3c1dac372d69293a4beb9032cb5&quot;,&quot;input&quot;:&quot;0x111111&quot;,&quot;nonce&quot;:&quot;0x3&quot;,&quot;to&quot;:&quot;0x0000000000000000000000000000000000000011&quot;,&quot;transactionIndex&quot;:&quot;0x2&quot;,&quot;value&quot;:&quot;0x6f&quot;,&quot;type&quot;:&quot;0x1&quot;,&quot;accessList&quot;:[],&quot;chainId&quot;:&quot;0x539&quot;,&quot;v&quot;:&quot;0x0&quot;,&quot;r&quot;:&quot;0x0&quot;,&quot;s&quot;:&quot;0x0&quot;},{&quot;blockHash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;blockNumber&quot;:&quot;0x64&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;gas&quot;:&quot;0x457&quot;,&quot;gasPrice&quot;:&quot;0x2b67&quot;,&quot;hash&quot;:&quot;0x12e1f81207b40c3bdcc13c0ee18f5f86af6d31754d57a0ea1b0d4cfef21abef1&quot;,&quot;input&quot;:&quot;0x111111&quot;,&quot;nonce&quot;:&quot;0x4&quot;,&quot;to&quot;:&quot;0x0000000000000000000000000000000000000011&quot;,&quot;transactionIndex&quot;:&quot;0x3&quot;,&quot;value&quot;:&quot;0x6f&quot;,&quot;type&quot;:&quot;0x0&quot;,&quot;chainId&quot;:&quot;0x7fffffffffffffee&quot;,&quot;v&quot;:&quot;0x0&quot;,&quot;r&quot;:&quot;0x0&quot;,&quot;s&quot;:&quot;0x0&quot;}],&quot;transactionsRoot&quot;:&quot;0x661a9febcfa8f1890af549b874faf9fa274aede26ef489d9db0b25daa569450e&quot;,&quot;uncles&quot;:[]}`,</span>
<span class="term-fg32">+			want:   `{&quot;difficulty&quot;:&quot;0x0&quot;,&quot;extraData&quot;:&quot;0x&quot;,&quot;gasLimit&quot;:&quot;0x0&quot;,&quot;gasUsed&quot;:&quot;0x0&quot;,&quot;hash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;logsBloom&quot;:&quot;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;miner&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;mixHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;nonce&quot;:&quot;0x0000000000000000&quot;,&quot;number&quot;:&quot;0x64&quot;,&quot;parentHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;receiptsRoot&quot;:&quot;0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421&quot;,&quot;sha3Uncles&quot;:&quot;0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347&quot;,&quot;size&quot;:&quot;0x296&quot;,&quot;stateRoot&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;timestamp&quot;:&quot;0x0&quot;,&quot;transactions&quot;:[{&quot;blockHash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;blockNumber&quot;:&quot;0x64&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;gas&quot;:&quot;0x457&quot;,&quot;gasPrice&quot;:&quot;0x2b67&quot;,&quot;hash&quot;:&quot;0x7d39df979e34172322c64983a9ad48302c2b889e55bda35324afecf043a77605&quot;,&quot;input&quot;:&quot;0x111111&quot;,&quot;nonce&quot;:&quot;0x1&quot;,&quot;to&quot;:&quot;0x0000000000000000000000000000000000000011&quot;,&quot;transactionIndex&quot;:&quot;0x0&quot;,&quot;value&quot;:&quot;0x6f&quot;,&quot;type&quot;:&quot;0x1&quot;,&quot;accessList&quot;:[],&quot;chainId&quot;:&quot;0x539&quot;,&quot;v&quot;:&quot;0x0&quot;,&quot;r&quot;:&quot;0x0&quot;,&quot;s&quot;:&quot;0x0&quot;},{&quot;blockHash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;blockNumber&quot;:&quot;0x64&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;gas&quot;:&quot;0x457&quot;,&quot;gasPrice&quot;:&quot;0x2b67&quot;,&quot;hash&quot;:&quot;0x9bba4c34e57c875ff57ac8d172805a26ae912006985395dc1bdf8f44140a7bf4&quot;,&quot;input&quot;:&quot;0x111111&quot;,&quot;nonce&quot;:&quot;0x2&quot;,&quot;to&quot;:&quot;0x0000000000000000000000000000000000000011&quot;,&quot;transactionIndex&quot;:&quot;0x1&quot;,&quot;value&quot;:&quot;0x6f&quot;,&quot;type&quot;:&quot;0x0&quot;,&quot;chainId&quot;:&quot;0x1&quot;,&quot;v&quot;:&quot;0x0&quot;,&quot;r&quot;:&quot;0x0&quot;,&quot;s&quot;:&quot;0x0&quot;},{&quot;blockHash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;blockNumber&quot;:&quot;0x64&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;gas&quot;:&quot;0x457&quot;,&quot;gasPrice&quot;:&quot;0x2b67&quot;,&quot;hash&quot;:&quot;0x98909ea1ff040da6be56bc4231d484de1414b3c1dac372d69293a4beb9032cb5&quot;,&quot;input&quot;:&quot;0x111111&quot;,&quot;nonce&quot;:&quot;0x3&quot;,&quot;to&quot;:&quot;0x0000000000000000000000000000000000000011&quot;,&quot;transactionIndex&quot;:&quot;0x2&quot;,&quot;value&quot;:&quot;0x6f&quot;,&quot;type&quot;:&quot;0x1&quot;,&quot;accessList&quot;:[],&quot;chainId&quot;:&quot;0x539&quot;,&quot;v&quot;:&quot;0x0&quot;,&quot;r&quot;:&quot;0x0&quot;,&quot;s&quot;:&quot;0x0&quot;},{&quot;blockHash&quot;:&quot;0x9b73c83b25d0faf7eab854e3684c7e394336d6e135625aafa5c183f27baa8fee&quot;,&quot;blockNumber&quot;:&quot;0x64&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000000&quot;,&quot;gas&quot;:&quot;0x457&quot;,&quot;gasPrice&quot;:&quot;0x2b67&quot;,&quot;hash&quot;:&quot;0x12e1f81207b40c3bdcc13c0ee18f5f86af6d31754d57a0ea1b0d4cfef21abef1&quot;,&quot;input&quot;:&quot;0x111111&quot;,&quot;nonce&quot;:&quot;0x4&quot;,&quot;to&quot;:&quot;0x0000000000000000000000000000000000000011&quot;,&quot;transactionIndex&quot;:&quot;0x3&quot;,&quot;value&quot;:&quot;0x6f&quot;,&quot;type&quot;:&quot;0x0&quot;,&quot;chainId&quot;:&quot;0x1&quot;,&quot;v&quot;:&quot;0x0&quot;,&quot;r&quot;:&quot;0x0&quot;,&quot;s&quot;:&quot;0x0&quot;}],&quot;transactionsRoot&quot;:&quot;0x661a9febcfa8f1890af549b874faf9fa274aede26ef489d9db0b25daa569450e&quot;,&quot;uncles&quot;:[]}`,</span>
 		},
 	}
&nbsp;
 	for i, tc := range testSuite {
<span class="term-fg31">-		resp, err := RPCMarshalBlock(block, tc.inclTx, tc.fullTx, params.MainnetChainConfig)</span>
<span class="term-fg32">+		resp, err := RPCMarshalBlock(context.Background(), block, tc.inclTx, tc.fullTx, params.MainnetChainConfig, testBackend{})</span>
 		if err != nil {
 			t.Errorf(&quot;test %d: got error %v&quot;, i, err)
 			continue</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-2288d280d753a09d260e275d"role="button" aria-expanded="false" aria-controls="id-2288d280d753a09d260e275d">
        
            <div class="col-12 col-sm-9 text-start"><h2>Other changes</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1325</span></div>
                <div class="text-start"><span class="text-danger">-17</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-2288d280d753a09d260e275d">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9925ed10e499ffe8f71faa07" role="button"
                   aria-expanded="false" aria-controls="id-9925ed10e499ffe8f71faa07">
                    <code>cmd/devp2p/internal/ethtest/snap.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/cmd/devp2p/internal/ethtest/snap.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/cmd/devp2p/internal/ethtest/snap.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9925ed10e499ffe8f71faa07"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg1">index f947e4bc9bae791bc1a0058fcadf7fae094632b8..8fa03660cfcc9f8e979cb9d9bdec20b0af4a215b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg36">@@ -249,11 +249,11 @@</span> 	for i, tc := range []byteCodesTest{
 		&#47;&#47; A few stateroots
 		{
 			nBytes: 10000, hashes: []common.Hash{s.chain.RootAt(0), s.chain.RootAt(999)},
<span class="term-fg31">-			expHashes: 0,</span>
<span class="term-fg32">+			expHashes: 1, &#47;&#47; 32-byte keys are detected as code, even if not code (like genesis hash), in legacy lookups.</span>
 		},
 		{
 			nBytes: 10000, hashes: []common.Hash{s.chain.RootAt(0), s.chain.RootAt(0)},
<span class="term-fg31">-			expHashes: 0,</span>
<span class="term-fg32">+			expHashes: 2, &#47;&#47; 32-byte keys are detected as code, even if not code (like genesis hash), in legacy lookups.</span>
 		},
 		&#47;&#47; Empties
 		{</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-96da7788566eda79a0cef702" role="button"
                   aria-expanded="false" aria-controls="id-96da7788566eda79a0cef702">
                    <code>core/blockchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/blockchain.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/blockchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-96da7788566eda79a0cef702"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;blockchain.go op-geth&#47;core&#47;blockchain.go</span>
<span class="term-fg1">index 659b2f02ea9ef7acdfbc24ed3ef2b3ba0b1a30ce..67658ec752a681bb88b6fb1776837701c9c58434 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;blockchain.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;blockchain.go</span>
<span class="term-fg36">@@ -254,6 +254,10 @@</span> 	}
 	log.Info(strings.Repeat(&quot;-&quot;, 153))
 	log.Info(&quot;&quot;)
&nbsp;
<span class="term-fg32">+	if chainConfig.IsOptimism() &amp;&amp; chainConfig.RegolithTime == nil {</span>
<span class="term-fg32">+		log.Warn(&quot;Optimism RegolithTime has not been set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	bc := &amp;BlockChain{
 		chainConfig:   chainConfig,
 		cacheConfig:   cacheConfig,</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-01c3130677d32a2662425e29" role="button"
                   aria-expanded="false" aria-controls="id-01c3130677d32a2662425e29">
                    <code>core/blockchain_reader.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/blockchain_reader.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/blockchain_reader.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+8</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-01c3130677d32a2662425e29"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;blockchain_reader.go op-geth&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg1">index fd65cb2db32f8faac481355cb7e0e0761adb5370..c0ea4bef3b445cab57ee8b18a0b53f130226cbb7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg36">@@ -311,6 +311,14 @@</span> 	}
 	return bc.stateCache.(codeReader).ContractCodeWithPrefix(common.Hash{}, hash)
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; ContractCode retrieves a blob of data associated with a contract hash</span>
<span class="term-fg32">+&#47;&#47; either from ephemeral in-memory cache, or from persistent storage.</span>
<span class="term-fg32">+&#47;&#47; This is a legacy-method, replaced by ContractCodeWithPrefix,</span>
<span class="term-fg32">+&#47;&#47; but required for old databases to serve snap-sync.</span>
<span class="term-fg32">+func (bc *BlockChain) ContractCode(hash common.Hash) ([]byte, error) {</span>
<span class="term-fg32">+	return bc.stateCache.ContractCode(common.Hash{}, hash)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; State returns a new mutable state based on the current HEAD block.
 func (bc *BlockChain) State() (*state.StateDB, error) {
 	return bc.StateAt(bc.CurrentBlock().Root)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-89b96fea833de55ea9ef18e8" role="button"
                   aria-expanded="false" aria-controls="id-89b96fea833de55ea9ef18e8">
                    <code>core/error.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/error.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/error.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-89b96fea833de55ea9ef18e8"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;error.go op-geth&#47;core&#47;error.go</span>
<span class="term-fg1">index 872ba8d365d8c152641f2dcd32b39343a285bd4d..d99b85e2490725b35c5797c93060ac7009b909d8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;error.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;error.go</span>
<span class="term-fg36">@@ -100,4 +100,7 @@</span> 	ErrFeeCapTooLow = errors.New(&quot;max fee per gas less than block base fee&quot;)
&nbsp;
 	&#47;&#47; ErrSenderNoEOA is returned if the sender of a transaction is a contract.
 	ErrSenderNoEOA = errors.New(&quot;sender not an eoa&quot;)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; ErrSystemTxNotSupported is returned for any deposit tx with IsSystemTx=true after the Regolith fork</span>
<span class="term-fg32">+	ErrSystemTxNotSupported = errors.New(&quot;system tx not supported&quot;)</span>
 )</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ed1717ab3a25d0d8c4e3714c" role="button"
                   aria-expanded="false" aria-controls="id-ed1717ab3a25d0d8c4e3714c">
                    <code>core/evm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/evm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/evm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ed1717ab3a25d0d8c4e3714c"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;evm.go op-geth&#47;core&#47;evm.go</span>
<span class="term-fg1">index bd4f2b0e55f1cf039549830eed93514272962171..527a81ad29d6d1b2faedb37579fce28d2ad24efd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;evm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;evm.go</span>
<span class="term-fg36">@@ -23,6 +23,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
 )
&nbsp;
 &#47;&#47; ChainContext supports retrieving headers and consensus parameters from the
<span class="term-fg36">@@ -36,7 +37,7 @@</span> 	GetHeader(common.Hash, uint64) *types.Header
 }
&nbsp;
 &#47;&#47; NewEVMBlockContext creates a new context for use in the EVM.
<span class="term-fg31">-func NewEVMBlockContext(header *types.Header, chain ChainContext, author *common.Address) vm.BlockContext {</span>
<span class="term-fg32">+func NewEVMBlockContext(header *types.Header, chain ChainContext, author *common.Address, config *params.ChainConfig, statedb types.StateGetter) vm.BlockContext {</span>
 	var (
 		beneficiary common.Address
 		baseFee     *big.Int
<span class="term-fg36">@@ -66,6 +67,7 @@</span> 		Difficulty:  new(big.Int).Set(header.Difficulty),
 		BaseFee:     baseFee,
 		GasLimit:    header.GasLimit,
 		Random:      random,
<span class="term-fg32">+		L1CostFunc:  types.NewL1CostFunc(config, statedb),</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-06b7e794c8bf3fd2a5f474bb" role="button"
                   aria-expanded="false" aria-controls="id-06b7e794c8bf3fd2a5f474bb">
                    <code>core/gen_genesis.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/gen_genesis.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/gen_genesis.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-06b7e794c8bf3fd2a5f474bb"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;gen_genesis.go op-geth&#47;core&#47;gen_genesis.go</span>
<span class="term-fg1">index 4e0844e889ab4e470790529515a0d5317b4a7a12..9a682b64ac54ed56a82757d745c40a017f4cadef 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;gen_genesis.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;gen_genesis.go</span>
<span class="term-fg36">@@ -31,6 +31,7 @@</span> 		Number     math.HexOrDecimal64                         `json:&quot;number&quot;`
 		GasUsed    math.HexOrDecimal64                         `json:&quot;gasUsed&quot;`
 		ParentHash common.Hash                                 `json:&quot;parentHash&quot;`
 		BaseFee    *math.HexOrDecimal256                       `json:&quot;baseFeePerGas&quot;`
<span class="term-fg32">+		StateHash  *common.Hash                                `json:&quot;stateHash,omitempty&quot;`</span>
 	}
 	var enc Genesis
 	enc.Config = g.Config
<span class="term-fg36">@@ -51,6 +52,7 @@</span> 	enc.Number = math.HexOrDecimal64(g.Number)
 	enc.GasUsed = math.HexOrDecimal64(g.GasUsed)
 	enc.ParentHash = g.ParentHash
 	enc.BaseFee = (*math.HexOrDecimal256)(g.BaseFee)
<span class="term-fg32">+	enc.StateHash = g.StateHash</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -70,6 +72,7 @@</span> 		Number     *math.HexOrDecimal64                        `json:&quot;number&quot;`
 		GasUsed    *math.HexOrDecimal64                        `json:&quot;gasUsed&quot;`
 		ParentHash *common.Hash                                `json:&quot;parentHash&quot;`
 		BaseFee    *math.HexOrDecimal256                       `json:&quot;baseFeePerGas&quot;`
<span class="term-fg32">+		StateHash  *common.Hash                                `json:&quot;stateHash,omitempty&quot;`</span>
 	}
 	var dec Genesis
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -119,6 +122,9 @@</span> 		g.ParentHash = *dec.ParentHash
 	}
 	if dec.BaseFee != nil {
 		g.BaseFee = (*big.Int)(dec.BaseFee)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.StateHash != nil {</span>
<span class="term-fg32">+		g.StateHash = dec.StateHash</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f47864f13bc80f7ceb96d7e5" role="button"
                   aria-expanded="false" aria-controls="id-f47864f13bc80f7ceb96d7e5">
                    <code>core/rawdb/accessors_chain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/rawdb/accessors_chain.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/rawdb/accessors_chain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f47864f13bc80f7ceb96d7e5"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_chain.go op-geth&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg1">index b479655b0b7469c47db053dd8591a418e865b495..de3337dfe0de2e03ab345aa2170b4fea9a0db7be 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg36">@@ -637,13 +637,11 @@</span> 		log.Error(&quot;Missing body but have receipt&quot;, &quot;hash&quot;, hash, &quot;number&quot;, number)
 		return nil
 	}
 	header := ReadHeader(db, hash, number)
<span class="term-fg31">-	var baseFee *big.Int</span>
 	if header == nil {
<span class="term-fg31">-		baseFee = big.NewInt(0)</span>
<span class="term-fg31">-	} else {</span>
<span class="term-fg31">-		baseFee = header.BaseFee</span>
<span class="term-fg32">+		log.Error(&quot;Missing header but have receipt&quot;, &quot;hash&quot;, hash, &quot;number&quot;, number)</span>
<span class="term-fg32">+		return nil</span>
 	}
<span class="term-fg31">-	if err := receipts.DeriveFields(config, hash, number, time, baseFee, body.Transactions); err != nil {</span>
<span class="term-fg32">+	if err := receipts.DeriveFields(config, hash, number, time, header.BaseFee, body.Transactions); err != nil {</span>
 		log.Error(&quot;Failed to derive block receipts fields&quot;, &quot;hash&quot;, hash, &quot;number&quot;, number, &quot;err&quot;, err)
 		return nil
 	}
<span class="term-fg36">@@ -681,6 +679,15 @@</span> type storedReceiptRLP struct {
 	PostStateOrStatus []byte
 	CumulativeGasUsed uint64
 	Logs              []*types.Log
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Remaining fields are declared to allow the receipt RLP to be parsed without errors.</span>
<span class="term-fg32">+	&#47;&#47; However, they must not be used as they may not be populated correctly due to multiple receipt formats</span>
<span class="term-fg32">+	&#47;&#47; being combined into a single list of optional fields which can be mistaken for each other.</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce (*uint64) from Regolith deposit tx receipts will be parsed into L1GasUsed</span>
<span class="term-fg32">+	L1GasUsed  *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	L1GasPrice *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	L1Fee      *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	FeeScalar  string   `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
 }
&nbsp;
 &#47;&#47; ReceiptLogs is a barebone version of ReceiptForStorage which only keeps</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-23f16f26d35e9d835128e2ba" role="button"
                   aria-expanded="false" aria-controls="id-23f16f26d35e9d835128e2ba">
                    <code>core/rawdb/accessors_chain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/rawdb/accessors_chain_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/rawdb/accessors_chain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+41</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-23f16f26d35e9d835128e2ba"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_chain_test.go op-geth&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg1">index 32e38a81ce4da94a86de28d07361913612e60b7d..9eb4103f0ae058431a7c9625c2c80750b9a52d82 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg36">@@ -27,10 +27,12 @@</span> 	&quot;reflect&quot;
 	&quot;testing&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;
 )
&nbsp;
<span class="term-fg36">@@ -347,6 +349,9 @@</span> 	&#47;&#47; Create a live block since we need metadata to reconstruct the receipt
 	tx1 := types.NewTransaction(1, common.HexToAddress(&quot;0x1&quot;), big.NewInt(1), 1, big.NewInt(1), nil)
 	tx2 := types.NewTransaction(2, common.HexToAddress(&quot;0x2&quot;), big.NewInt(2), 2, big.NewInt(2), nil)
&nbsp;
<span class="term-fg32">+	header := &amp;types.Header{</span>
<span class="term-fg32">+		Number: big.NewInt(0),</span>
<span class="term-fg32">+	}</span>
 	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2}}
&nbsp;
 	&#47;&#47; Create the two receipts to manage afterwards
<span class="term-fg36">@@ -378,12 +383,15 @@</span> 	receipt2.Bloom = types.CreateBloom(types.Receipts{receipt2})
 	receipts := []*types.Receipt{receipt1, receipt2}
&nbsp;
 	&#47;&#47; Check that no receipt entries are in a pristine database
<span class="term-fg31">-	hash := common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+	hash := header.Hash()</span>
 	if rs := ReadReceipts(db, hash, 0, 0, params.TestChainConfig); len(rs) != 0 {
 		t.Fatalf(&quot;non existent receipts returned: %v&quot;, rs)
 	}
 	&#47;&#47; Insert the body that corresponds to the receipts
 	WriteBody(db, hash, 0, body)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Insert the header that corresponds to the receipts</span>
<span class="term-fg32">+	WriteHeader(db, header)</span>
&nbsp;
 	&#47;&#47; Insert the receipt slice into the database and check presence
 	WriteReceipts(db, hash, 0, receipts)
<span class="term-fg36">@@ -698,6 +706,7 @@</span>
 	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2}}
&nbsp;
 	&#47;&#47; Create the two receipts to manage afterwards
<span class="term-fg32">+	depositNonce := uint64(math.MaxUint64)</span>
 	receipt1 := &amp;types.Receipt{
 		Status:            types.ReceiptStatusFailed,
 		CumulativeGasUsed: 1,
<span class="term-fg36">@@ -708,6 +717,7 @@</span> 		},
 		TxHash:          tx1.Hash(),
 		ContractAddress: common.BytesToAddress([]byte{0x01, 0x11, 0x11}),
 		GasUsed:         111111,
<span class="term-fg32">+		DepositNonce:    &amp;depositNonce,</span>
 	}
 	receipt1.Bloom = types.CreateBloom(types.Receipts{receipt1})
&nbsp;
<span class="term-fg36">@@ -765,6 +775,36 @@</span> 				t.Fatalf(&quot;receipt #%d: receipt mismatch: have %s, want %s&quot;, i, hex.EncodeToString(rlpHave), hex.EncodeToString(rlpWant))
 			}
 		}
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestParseLegacyReceiptRLP(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Create a gasUsed value greater than a uint64 can represent</span>
<span class="term-fg32">+	gasUsed := big.NewInt(0)</span>
<span class="term-fg32">+	gasUsed = gasUsed.SetUint64(math.MaxUint64)</span>
<span class="term-fg32">+	gasUsed = gasUsed.Add(gasUsed, big.NewInt(math.MaxInt64))</span>
<span class="term-fg32">+	sanityCheck := (&amp;big.Int{}).SetUint64(gasUsed.Uint64())</span>
<span class="term-fg32">+	require.NotEqual(t, gasUsed, sanityCheck)</span>
<span class="term-fg32">+	receipt := types.LegacyOptimismStoredReceiptRLP{</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		Logs: []*types.LogForStorage{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x11})},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x01, 0x11})},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		L1GasUsed:  gasUsed,</span>
<span class="term-fg32">+		L1GasPrice: gasUsed,</span>
<span class="term-fg32">+		L1Fee:      gasUsed,</span>
<span class="term-fg32">+		FeeScalar:  &quot;6&quot;,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	data, err := rlp.EncodeToBytes(receipt)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	var result storedReceiptRLP</span>
<span class="term-fg32">+	err = rlp.DecodeBytes(data, &amp;result)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1GasUsed, result.L1GasUsed)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1GasPrice, result.L1GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1Fee, result.L1Fee)</span>
<span class="term-fg32">+	require.Equal(t, receipt.FeeScalar, result.FeeScalar)</span>
 }
&nbsp;
 func TestDeriveLogFields(t *testing.T) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c17ab508cca5ac0defb36f27" role="button"
                   aria-expanded="false" aria-controls="id-c17ab508cca5ac0defb36f27">
                    <code>core/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+99</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c17ab508cca5ac0defb36f27"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;superchain.go op-geth&#47;core&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..96f68cedcf437f251d18e35764e4d49f4ddcab6b</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,99 @@</span>
<span class="term-fg32">+package core</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LoadOPStackGenesis(chainID uint64) (*Genesis, error) {</span>
<span class="term-fg32">+	chConfig, ok := superchain.OPChains[chainID]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;unknown chain ID: %d&quot;, chainID)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	cfg, err := params.LoadOPStackChainConfig(chainID)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;failed to load params.ChainConfig for chain %d: %w&quot;, chainID, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	gen, err := superchain.LoadGenesis(chainID)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;failed to load genesis definition for chain %d: %w&quot;, chainID, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesis := &amp;Genesis{</span>
<span class="term-fg32">+		Config:     cfg,</span>
<span class="term-fg32">+		Nonce:      gen.Nonce,</span>
<span class="term-fg32">+		Timestamp:  gen.Timestamp,</span>
<span class="term-fg32">+		ExtraData:  gen.ExtraData,</span>
<span class="term-fg32">+		GasLimit:   gen.GasLimit,</span>
<span class="term-fg32">+		Difficulty: (*big.Int)(gen.Difficulty),</span>
<span class="term-fg32">+		Mixhash:    common.Hash(gen.Mixhash),</span>
<span class="term-fg32">+		Coinbase:   common.Address(gen.Coinbase),</span>
<span class="term-fg32">+		Alloc:      make(GenesisAlloc),</span>
<span class="term-fg32">+		Number:     gen.Number,</span>
<span class="term-fg32">+		GasUsed:    gen.GasUsed,</span>
<span class="term-fg32">+		ParentHash: common.Hash(gen.ParentHash),</span>
<span class="term-fg32">+		BaseFee:    (*big.Int)(gen.BaseFee),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for addr, acc := range gen.Alloc {</span>
<span class="term-fg32">+		var code []byte</span>
<span class="term-fg32">+		if acc.CodeHash != ([32]byte{}) {</span>
<span class="term-fg32">+			dat, err := superchain.LoadContractBytecode(acc.CodeHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;failed to load bytecode %s of address %s in chain %d: %w&quot;, acc.CodeHash, addr, chainID, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			code = dat</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var storage map[common.Hash]common.Hash</span>
<span class="term-fg32">+		if len(acc.Storage) &gt; 0 {</span>
<span class="term-fg32">+			storage = make(map[common.Hash]common.Hash)</span>
<span class="term-fg32">+			for k, v := range acc.Storage {</span>
<span class="term-fg32">+				storage[common.Hash(k)] = common.Hash(v)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		bal := common.Big0</span>
<span class="term-fg32">+		if acc.Balance != nil {</span>
<span class="term-fg32">+			bal = (*big.Int)(acc.Balance)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis.Alloc[common.Address(addr)] = GenesisAccount{</span>
<span class="term-fg32">+			Code:    code,</span>
<span class="term-fg32">+			Storage: storage,</span>
<span class="term-fg32">+			Balance: bal,</span>
<span class="term-fg32">+			Nonce:   acc.Nonce,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if gen.StateHash != nil {</span>
<span class="term-fg32">+		if len(gen.Alloc) &gt; 0 {</span>
<span class="term-fg32">+			return nil, fmt.Errorf(&quot;chain definition unexpectedly contains both allocation (%d) and state-hash %s&quot;, len(gen.Alloc), *gen.StateHash)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis.StateHash = (*common.Hash)(gen.StateHash)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesisBlock := genesis.ToBlock()</span>
<span class="term-fg32">+	genesisBlockHash := genesisBlock.Hash()</span>
<span class="term-fg32">+	expectedHash := common.Hash([32]byte(chConfig.Genesis.L2.Hash))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Verify we correctly produced the genesis config by recomputing the genesis-block-hash,</span>
<span class="term-fg32">+	&#47;&#47; and check the genesis matches the chain genesis definition.</span>
<span class="term-fg32">+	if chConfig.Genesis.L2.Number != genesisBlock.NumberU64() {</span>
<span class="term-fg32">+		switch chainID {</span>
<span class="term-fg32">+		case params.OPMainnetChainID:</span>
<span class="term-fg32">+			expectedHash = common.HexToHash(&quot;0x7ca38a1916c42007829c55e69d3e9a73265554b586a499015373241b8a3fa48b&quot;)</span>
<span class="term-fg32">+		case params.OPGoerliChainID:</span>
<span class="term-fg32">+			expectedHash = common.HexToHash(&quot;0xc1fc15cd51159b1f1e5cbc4b82e85c1447ddfa33c52cf1d98d14fba0d6354be1&quot;)</span>
<span class="term-fg32">+		default:</span>
<span class="term-fg32">+			return nil, fmt.Errorf(&quot;unknown stateless genesis definition for chain %d&quot;, chainID)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if expectedHash != genesisBlockHash {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;produced genesis with hash %s but expected %s&quot;, genesisBlockHash, expectedHash)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return genesis, nil</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3dbb57988cb2209db887b6a7" role="button"
                   aria-expanded="false" aria-controls="id-3dbb57988cb2209db887b6a7">
                    <code>core/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+17</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3dbb57988cb2209db887b6a7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;superchain_test.go op-geth&#47;core&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..fa3246250ac32aebea1410295f946fd10f25252d</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,17 @@</span>
<span class="term-fg32">+package core</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestOPStackGenesis(t *testing.T) {</span>
<span class="term-fg32">+	for id := range superchain.OPChains {</span>
<span class="term-fg32">+		gen, err := LoadOPStackGenesis(id)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatal(err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		t.Logf(&quot;chain: %d, genesis block hash: %s&quot;, id, gen.ToBlock().Hash())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0e53afb4855384124f9be043" role="button"
                   aria-expanded="false" aria-controls="id-0e53afb4855384124f9be043">
                    <code>core/types/receipt_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/receipt_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/receipt_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+281</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0e53afb4855384124f9be043"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;receipt_test.go op-geth&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg1">index 168f36208b9eb5e7ef7fd01c947105122b51c31b..809540715e7de6acc5d9a1688aac5705df5203bf 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg36">@@ -19,6 +19,7 @@</span>
 import (
 	&quot;bytes&quot;
 	&quot;encoding&#47;json&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&quot;
 	&quot;math&#47;big&quot;
 	&quot;reflect&quot;
<span class="term-fg36">@@ -29,6 +30,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;holiman&#47;uint256&quot;
 	&quot;github.com&#47;kylelemons&#47;godebug&#47;diff&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -82,6 +84,42 @@</span> 			},
 		},
 		Type: DynamicFeeTxType,
 	}
<span class="term-fg32">+	depositReceiptNoNonce = &amp;Receipt{</span>
<span class="term-fg32">+		Status:            ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonce                   = uint64(1234)</span>
<span class="term-fg32">+	depositReceiptWithNonce = &amp;Receipt{</span>
<span class="term-fg32">+		Status:            ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		DepositNonce:      &amp;nonce,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Create a few transactions to have receipts for
 	to2 = common.HexToAddress(&quot;0x2&quot;)
<span class="term-fg36">@@ -147,8 +185,13 @@</span> 			GasTipCap:  uint256.NewInt(77),
 			GasFeeCap:  uint256.NewInt(1077),
 			BlobFeeCap: uint256.NewInt(100077),
 		}),
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   50,</span>
<span class="term-fg32">+		}),</span>
 	}
<span class="term-fg31">-</span>
<span class="term-fg32">+	depNonce    = uint64(7)</span>
 	blockNumber = big.NewInt(1)
 	blockTime   = uint64(2)
 	blockHash   = common.BytesToHash([]byte{0x03, 0x14})
<span class="term-fg36">@@ -287,6 +330,41 @@</span> 			BlockHash:         blockHash,
 			BlockNumber:       blockNumber,
 			TransactionIndex:  6,
 		},
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 50 + 28,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[7].Hash(),</span>
<span class="term-fg32">+					TxIndex:     7,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       4,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[7].Hash(),</span>
<span class="term-fg32">+					TxIndex:     7,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       5,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:            txs[7].Hash(),</span>
<span class="term-fg32">+			ContractAddress:   common.HexToAddress(&quot;0x3bb898b4bbe24f68a4e9be46cfe72d1787fd74f4&quot;),</span>
<span class="term-fg32">+			GasUsed:           50,</span>
<span class="term-fg32">+			EffectiveGasPrice: big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:         blockHash,</span>
<span class="term-fg32">+			BlockNumber:       blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:  7,</span>
<span class="term-fg32">+			DepositNonce:      &amp;depNonce,</span>
<span class="term-fg32">+		},</span>
 	}
 )
&nbsp;
<span class="term-fg36">@@ -517,3 +595,205 @@</span> 		l[i] = &amp;cpy
 	}
 	return l
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestDeriveOptimismTxReceipt(t *testing.T) {</span>
<span class="term-fg32">+	to4 := common.HexToAddress(&quot;0x4&quot;)</span>
<span class="term-fg32">+	&#47;&#47; Create a few transactions to have receipts for</span>
<span class="term-fg32">+	txs := Transactions{</span>
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   50,</span>
<span class="term-fg32">+			&#47;&#47; System config with L1Scalar=2_000_000 (becomes 2 after division), L1Overhead=2500, L1BaseFee=5000</span>
<span class="term-fg32">+			Data: common.Hex2Bytes(&quot;015d8eb900000000000000000000000000000000000000000000000026b39534042076f70000000000000000000000000000000000000000000000007e33b7c4995967580000000000000000000000000000000000000000000000000000000000001388547dea8ff339566349ed0ef6384876655d1b9b955e36ac165c6b8ab69b9af5cd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000123400000000000000000000000000000000000000000000000000000000000009c400000000000000000000000000000000000000000000000000000000001e8480&quot;),</span>
<span class="term-fg32">+		}),</span>
<span class="term-fg32">+		NewTx(&amp;DynamicFeeTx{</span>
<span class="term-fg32">+			To:        &amp;to4,</span>
<span class="term-fg32">+			Nonce:     4,</span>
<span class="term-fg32">+			Value:     big.NewInt(4),</span>
<span class="term-fg32">+			Gas:       4,</span>
<span class="term-fg32">+			GasTipCap: big.NewInt(44),</span>
<span class="term-fg32">+			GasFeeCap: big.NewInt(1045),</span>
<span class="term-fg32">+			Data:      []byte{0, 1, 255, 0},</span>
<span class="term-fg32">+		}),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	depNonce := uint64(7)</span>
<span class="term-fg32">+	blockNumber := big.NewInt(1)</span>
<span class="term-fg32">+	blockHash := common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Create the corresponding receipts</span>
<span class="term-fg32">+	receipts := Receipts{</span>
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 50 + 15,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[0].Hash(),</span>
<span class="term-fg32">+					TxIndex:     0,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       0,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[0].Hash(),</span>
<span class="term-fg32">+					TxIndex:     0,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       1,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:            txs[0].Hash(),</span>
<span class="term-fg32">+			ContractAddress:   common.HexToAddress(&quot;0x3bb898b4bbe24f68a4e9be46cfe72d1787fd74f4&quot;),</span>
<span class="term-fg32">+			GasUsed:           65,</span>
<span class="term-fg32">+			EffectiveGasPrice: big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:         blockHash,</span>
<span class="term-fg32">+			BlockNumber:       blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:  0,</span>
<span class="term-fg32">+			DepositNonce:      &amp;depNonce,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DynamicFeeTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{4}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 10,</span>
<span class="term-fg32">+			Logs:              []*Log{},</span>
<span class="term-fg32">+			&#47;&#47; derived fields:</span>
<span class="term-fg32">+			TxHash:            txs[1].Hash(),</span>
<span class="term-fg32">+			GasUsed:           18446744073709551561,</span>
<span class="term-fg32">+			EffectiveGasPrice: big.NewInt(1044),</span>
<span class="term-fg32">+			BlockHash:         blockHash,</span>
<span class="term-fg32">+			BlockNumber:       blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:  1,</span>
<span class="term-fg32">+			L1GasPrice:        big.NewInt(5000),</span>
<span class="term-fg32">+			L1GasUsed:         big.NewInt(3976),</span>
<span class="term-fg32">+			L1Fee:             big.NewInt(39760000),</span>
<span class="term-fg32">+			FeeScalar:         big.NewFloat(2),</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Re-derive receipts.</span>
<span class="term-fg32">+	basefee := big.NewInt(1000)</span>
<span class="term-fg32">+	derivedReceipts := clearComputedFieldsOnReceipts(receipts)</span>
<span class="term-fg32">+	err := Receipts(derivedReceipts).DeriveFields(params.OptimismTestConfig, blockHash, blockNumber.Uint64(), 0, basefee, txs)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;DeriveFields(...) = %v, want &lt;nil&gt;&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check diff of receipts against derivedReceipts.</span>
<span class="term-fg32">+	r1, err := json.MarshalIndent(receipts, &quot;&quot;, &quot;  &quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;error marshaling input receipts:&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r2, err := json.MarshalIndent(derivedReceipts, &quot;&quot;, &quot;  &quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;error marshaling derived receipts:&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	d := diff.Diff(string(r1), string(r2))</span>
<span class="term-fg32">+	if d != &quot;&quot; {</span>
<span class="term-fg32">+		t.Fatal(&quot;receipts differ:&quot;, d)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that we preserved the invariant: l1Fee = l1GasPrice * l1GasUsed * l1FeeScalar</span>
<span class="term-fg32">+	&#47;&#47; but with more difficult int math...</span>
<span class="term-fg32">+	l2Rcpt := derivedReceipts[1]</span>
<span class="term-fg32">+	l1GasCost := new(big.Int).Mul(l2Rcpt.L1GasPrice, l2Rcpt.L1GasUsed)</span>
<span class="term-fg32">+	l1Fee := new(big.Float).Mul(new(big.Float).SetInt(l1GasCost), l2Rcpt.FeeScalar)</span>
<span class="term-fg32">+	require.Equal(t, new(big.Float).SetInt(l2Rcpt.L1Fee), l1Fee)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestBedrockDepositReceiptUnchanged(t *testing.T) {</span>
<span class="term-fg32">+	expectedRlp := common.FromHex(&quot;7EF90156A003000000000000000000000000000000000000000000000000000000000000000AB9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0D7940000000000000000000000000000000000000033C001D7940000000000000000000000000000000000000333C002&quot;)</span>
<span class="term-fg32">+	&#47;&#47; Deposit receipt with no nonce</span>
<span class="term-fg32">+	receipt := &amp;Receipt{</span>
<span class="term-fg32">+		Type:              DepositTxType,</span>
<span class="term-fg32">+		PostState:         common.Hash{3}.Bytes(),</span>
<span class="term-fg32">+		CumulativeGasUsed: 10,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x33}), Data: []byte{1}, Topics: []common.Hash{}},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x03, 0x33}), Data: []byte{2}, Topics: []common.Hash{}},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		TxHash:          common.Hash{},</span>
<span class="term-fg32">+		ContractAddress: common.BytesToAddress([]byte{0x03, 0x33, 0x33}),</span>
<span class="term-fg32">+		GasUsed:         4,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	rlp, err := receipt.MarshalBinary()</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, expectedRlp, rlp)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Consensus values should be unchanged after reparsing</span>
<span class="term-fg32">+	parsed := new(Receipt)</span>
<span class="term-fg32">+	err = parsed.UnmarshalBinary(rlp)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, receipt.Status, parsed.Status)</span>
<span class="term-fg32">+	require.Equal(t, receipt.CumulativeGasUsed, parsed.CumulativeGasUsed)</span>
<span class="term-fg32">+	require.Equal(t, receipt.Bloom, parsed.Bloom)</span>
<span class="term-fg32">+	require.EqualValues(t, receipt.Logs, parsed.Logs)</span>
<span class="term-fg32">+	&#47;&#47; And still shouldn&#39;t have a nonce</span>
<span class="term-fg32">+	require.Nil(t, parsed.DepositNonce)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRoundTripReceipt(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name string</span>
<span class="term-fg32">+		rcpt *Receipt</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{name: &quot;Legacy&quot;, rcpt: legacyReceipt},</span>
<span class="term-fg32">+		{name: &quot;AccessList&quot;, rcpt: accessListReceipt},</span>
<span class="term-fg32">+		{name: &quot;EIP1559&quot;, rcpt: eip1559Receipt},</span>
<span class="term-fg32">+		{name: &quot;DepositNoNonce&quot;, rcpt: depositReceiptNoNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonce&quot;, rcpt: depositReceiptWithNonce},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := test.rcpt.MarshalBinary()</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			d := &amp;Receipt{}</span>
<span class="term-fg32">+			err = d.UnmarshalBinary(data)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt, d)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Run(fmt.Sprintf(&quot;%sRejectExtraData&quot;, test.name), func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := test.rcpt.MarshalBinary()</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			data = append(data, 1, 2, 3, 4)</span>
<span class="term-fg32">+			d := &amp;Receipt{}</span>
<span class="term-fg32">+			err = d.UnmarshalBinary(data)</span>
<span class="term-fg32">+			require.Error(t, err)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRoundTripReceiptForStorage(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name string</span>
<span class="term-fg32">+		rcpt *Receipt</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{name: &quot;Legacy&quot;, rcpt: legacyReceipt},</span>
<span class="term-fg32">+		{name: &quot;AccessList&quot;, rcpt: accessListReceipt},</span>
<span class="term-fg32">+		{name: &quot;EIP1559&quot;, rcpt: eip1559Receipt},</span>
<span class="term-fg32">+		{name: &quot;DepositNoNonce&quot;, rcpt: depositReceiptNoNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonce&quot;, rcpt: depositReceiptWithNonce},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := rlp.EncodeToBytes((*ReceiptForStorage)(test.rcpt))</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			d := &amp;ReceiptForStorage{}</span>
<span class="term-fg32">+			err = rlp.DecodeBytes(data, d)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			&#47;&#47; Only check the stored fields - the others are derived later</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.Status, d.Status)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.CumulativeGasUsed, d.CumulativeGasUsed)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.Logs, d.Logs)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositNonce, d.DepositNonce)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-13a89e2ac494c644b7e91582" role="button"
                   aria-expanded="false" aria-controls="id-13a89e2ac494c644b7e91582">
                    <code>core/types/rollup_l1_cost_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/rollup_l1_cost_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+30</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-13a89e2ac494c644b7e91582"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;rollup_l1_cost_test.go op-geth&#47;core&#47;types&#47;rollup_l1_cost_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..e43ea967ee87a257cfc2afa58396c2eb6685ed76</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;rollup_l1_cost_test.go</span>
<span class="term-fg36">@@ -0,0 +1,30 @@</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;rand&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRollupGasData(t *testing.T) {</span>
<span class="term-fg32">+	for i := 0; i &lt; 100; i++ {</span>
<span class="term-fg32">+		zeroes := rand.Uint64()</span>
<span class="term-fg32">+		ones := rand.Uint64()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		r := RollupGasData{</span>
<span class="term-fg32">+			Zeroes: zeroes,</span>
<span class="term-fg32">+			Ones:   ones,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		time := uint64(1)</span>
<span class="term-fg32">+		cfg := &amp;params.ChainConfig{</span>
<span class="term-fg32">+			RegolithTime: &amp;time,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		gasPreRegolith := r.DataGas(0, cfg)</span>
<span class="term-fg32">+		gasPostRegolith := r.DataGas(1, cfg)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		require.Equal(t, r.Zeroes*params.TxDataZeroGas+(r.Ones+68)*params.TxDataNonZeroGasEIP2028, gasPreRegolith)</span>
<span class="term-fg32">+		require.Equal(t, r.Zeroes*params.TxDataZeroGas+r.Ones*params.TxDataNonZeroGasEIP2028, gasPostRegolith)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7dca8b6afd08d9c86195903a" role="button"
                   aria-expanded="false" aria-controls="id-7dca8b6afd08d9c86195903a">
                    <code>core/types/tx_blob.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/core/types/tx_blob.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/core/types/tx_blob.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7dca8b6afd08d9c86195903a"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_blob.go op-geth&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg1">index 58065d0017d314c13e0047d19203f37592aff33a..4b6caa5a996046344acccdce0be107c5749d1db4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg36">@@ -108,6 +108,7 @@</span> func (tx *BlobTx) to() *common.Address       { return tx.To }
 func (tx *BlobTx) blobGas() uint64           { return params.BlobTxDataGasPerBlob * uint64(len(tx.BlobHashes)) }
 func (tx *BlobTx) blobGasFeeCap() *big.Int   { return tx.BlobFeeCap.ToBig() }
 func (tx *BlobTx) blobHashes() []common.Hash { return tx.BlobHashes }
<span class="term-fg32">+func (tx *BlobTx) isSystemTx() bool          { return false }</span>
&nbsp;
 func (tx *BlobTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	if baseFee == nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e4e33f8c4b98e51a89ec9a7b" role="button"
                   aria-expanded="false" aria-controls="id-e4e33f8c4b98e51a89ec9a7b">
                    <code>eth/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+7</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e4e33f8c4b98e51a89ec9a7b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;api.go op-geth&#47;eth&#47;api.go</span>
<span class="term-fg1">index 00ad48fbfc8f03597db7a3802c887390cb8dc4f6..96c20d60206b586510202fac10152cfa5f6e0439 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;api.go</span>
<span class="term-fg36">@@ -261,6 +261,9 @@</span> 		&#47;&#47; If we&#39;re dumping the pending state, we need to request
 		&#47;&#47; both the pending block as well as the pending state from
 		&#47;&#47; the miner and operate on those
 		_, stateDb := api.eth.miner.Pending()
<span class="term-fg32">+		if stateDb == nil {</span>
<span class="term-fg32">+			return state.Dump{}, errors.New(&quot;no pending state&quot;)</span>
<span class="term-fg32">+		}</span>
 		return stateDb.RawDump(opts), nil
 	}
 	var header *types.Header
<span class="term-fg36">@@ -320,7 +323,7 @@</span> 			blockRlp = err.Error() &#47;&#47; Hacky, but hey, it works
 		} else {
 			blockRlp = fmt.Sprintf(&quot;%#x&quot;, rlpBytes)
 		}
<span class="term-fg31">-		if blockJSON, err = ethapi.RPCMarshalBlock(block, true, true, api.eth.APIBackend.ChainConfig()); err != nil {</span>
<span class="term-fg32">+		if blockJSON, err = ethapi.RPCMarshalBlock(ctx, block, true, true, api.eth.APIBackend.ChainConfig(), api.eth.APIBackend); err != nil {</span>
 			blockJSON = map[string]interface{}{&quot;error&quot;: err.Error()}
 		}
 		results = append(results, &amp;BadBlockArgs{
<span class="term-fg36">@@ -346,6 +349,9 @@</span> 			&#47;&#47; If we&#39;re dumping the pending state, we need to request
 			&#47;&#47; both the pending block as well as the pending state from
 			&#47;&#47; the miner and operate on those
 			_, stateDb = api.eth.miner.Pending()
<span class="term-fg32">+			if stateDb == nil {</span>
<span class="term-fg32">+				return state.IteratorDump{}, errors.New(&quot;no pending state&quot;)</span>
<span class="term-fg32">+			}</span>
 		} else {
 			var header *types.Header
 			if number == rpc.LatestBlockNumber {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-35831b9733a3b89288fce92d" role="button"
                   aria-expanded="false" aria-controls="id-35831b9733a3b89288fce92d">
                    <code>eth/catalyst/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/catalyst/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/catalyst/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-35831b9733a3b89288fce92d"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;api_test.go op-geth&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg1">index 5bab7ba18643ad418ef1b5d4d37e8a73f84e57a8..4df09636fe3fa6682e03a281be3c8f99d5f6e22d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg36">@@ -428,6 +428,11 @@</span> }
&nbsp;
 &#47;&#47; startEthService creates a full node instance for testing.
 func startEthService(t *testing.T, genesis *core.Genesis, blocks []*types.Block) (*node.Node, *eth.Ethereum) {
<span class="term-fg32">+	ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+	return startEthServiceWithConfigFn(t, blocks, ethcfg)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func startEthServiceWithConfigFn(t *testing.T, blocks []*types.Block, ethcfg *ethconfig.Config) (*node.Node, *eth.Ethereum) {</span>
 	t.Helper()
&nbsp;
 	n, err := node.New(&amp;node.Config{
<span class="term-fg36">@@ -440,7 +445,7 @@</span> 	if err != nil {
 		t.Fatal(&quot;can&#39;t create node:&quot;, err)
 	}
&nbsp;
<span class="term-fg31">-	ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+	&#47;&#47; default eth config is moved to startEthService</span>
 	ethservice, err := eth.New(n, ethcfg)
 	if err != nil {
 		t.Fatal(&quot;can&#39;t create eth service:&quot;, err)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e646efff99dfdaf254e2764f" role="button"
                   aria-expanded="false" aria-controls="id-e646efff99dfdaf254e2764f">
                    <code>eth/catalyst/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/catalyst/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+64</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e646efff99dfdaf254e2764f"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;superchain.go op-geth&#47;eth&#47;catalyst&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..2d44647046b6bb9b64f06bde5a29f4e428f66bf1</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,64 @@</span>
<span class="term-fg32">+package catalyst</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	requiredProtocolDeltaGauge    = metrics.NewRegisteredGauge(&quot;superchain&#47;required&#47;delta&quot;, nil)</span>
<span class="term-fg32">+	recommendedProtocolDeltaGauge = metrics.NewRegisteredGauge(&quot;superchain&#47;recommended&#47;delta&quot;, nil)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type SuperchainSignal struct {</span>
<span class="term-fg32">+	Recommended params.ProtocolVersion `json:&quot;recommended&quot;`</span>
<span class="term-fg32">+	Required    params.ProtocolVersion `json:&quot;required&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (api *ConsensusAPI) SignalSuperchainV1(signal *SuperchainSignal) (params.ProtocolVersion, error) {</span>
<span class="term-fg32">+	if signal == nil {</span>
<span class="term-fg32">+		log.Info(&quot;Received empty superchain version signal&quot;, &quot;local&quot;, params.OPStackSupport)</span>
<span class="term-fg32">+		return params.OPStackSupport, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; update metrics and log any warnings&#47;info</span>
<span class="term-fg32">+	requiredProtocolDeltaGauge.Update(int64(params.OPStackSupport.Compare(signal.Required)))</span>
<span class="term-fg32">+	recommendedProtocolDeltaGauge.Update(int64(params.OPStackSupport.Compare(signal.Recommended)))</span>
<span class="term-fg32">+	logger := log.New(&quot;local&quot;, params.OPStackSupport, &quot;required&quot;, signal.Required, &quot;recommended&quot;, signal.Recommended)</span>
<span class="term-fg32">+	LogProtocolVersionSupport(logger, params.OPStackSupport, signal.Recommended, &quot;recommended&quot;)</span>
<span class="term-fg32">+	LogProtocolVersionSupport(logger, params.OPStackSupport, signal.Required, &quot;required&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if err := api.eth.HandleRequiredProtocolVersion(signal.Required); err != nil {</span>
<span class="term-fg32">+		log.Error(&quot;Failed to handle required protocol version&quot;, &quot;err&quot;, err, &quot;required&quot;, signal.Required)</span>
<span class="term-fg32">+		return params.OPStackSupport, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return params.OPStackSupport, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LogProtocolVersionSupport(logger log.Logger, local, other params.ProtocolVersion, name string) {</span>
<span class="term-fg32">+	switch local.Compare(other) {</span>
<span class="term-fg32">+	case params.AheadMajor:</span>
<span class="term-fg32">+		logger.Info(fmt.Sprintf(&quot;Ahead with major %s protocol version change&quot;, name))</span>
<span class="term-fg32">+	case params.AheadMinor, params.AheadPatch, params.AheadPrerelease:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Ahead with compatible %s protocol version change&quot;, name))</span>
<span class="term-fg32">+	case params.Matching:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Latest %s protocol version is supported&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedMajor:</span>
<span class="term-fg32">+		logger.Error(fmt.Sprintf(&quot;Outdated with major %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedMinor:</span>
<span class="term-fg32">+		logger.Warn(fmt.Sprintf(&quot;Outdated with minor backward-compatible %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedPatch:</span>
<span class="term-fg32">+		logger.Info(fmt.Sprintf(&quot;Outdated with support backward-compatible %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedPrerelease:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;New %s protocol pre-release is available&quot;, name))</span>
<span class="term-fg32">+	case params.DiffBuild:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Ignoring %s protocolversion signal, local build is different&quot;, name))</span>
<span class="term-fg32">+	case params.DiffVersionType:</span>
<span class="term-fg32">+		logger.Warn(fmt.Sprintf(&quot;Failed to recognize %s protocol version signal version-type&quot;, name))</span>
<span class="term-fg32">+	case params.EmptyVersion:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;No %s protocol version available to check&quot;, name))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8341272f5ad814083bdafb32" role="button"
                   aria-expanded="false" aria-controls="id-8341272f5ad814083bdafb32">
                    <code>eth/catalyst/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/catalyst/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+100</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8341272f5ad814083bdafb32"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;superchain_test.go op-geth&#47;eth&#47;catalyst&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..e06770fa3235a5f9022468c9f2fb47117cca1343</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,100 @@</span>
<span class="term-fg32">+package catalyst</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+	&quot;time&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;ethconfig&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;node&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSignalSuperchainV1(t *testing.T) {</span>
<span class="term-fg32">+	genesis, preMergeBlocks := generateMergeChain(2, false)</span>
<span class="term-fg32">+	n, ethservice := startEthService(t, genesis, preMergeBlocks)</span>
<span class="term-fg32">+	defer n.Close()</span>
<span class="term-fg32">+	api := NewConsensusAPI(ethservice)</span>
<span class="term-fg32">+	t.Run(&quot;matching&quot;, func(t *testing.T) {</span>
<span class="term-fg32">+		out, err := api.SignalSuperchainV1(&amp;SuperchainSignal{</span>
<span class="term-fg32">+			Recommended: params.OPStackSupport,</span>
<span class="term-fg32">+			Required:    params.OPStackSupport,</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if out != params.OPStackSupport {</span>
<span class="term-fg32">+			t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	t.Run(&quot;null_arg&quot;, func(t *testing.T) {</span>
<span class="term-fg32">+		out, err := api.SignalSuperchainV1(nil)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if out != params.OPStackSupport {</span>
<span class="term-fg32">+			t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSignalSuperchainV1Halt(t *testing.T) {</span>
<span class="term-fg32">+	testCases := []struct {</span>
<span class="term-fg32">+		cfg  string</span>
<span class="term-fg32">+		bump string</span>
<span class="term-fg32">+		halt bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{&quot;none&quot;, &quot;major&quot;, false},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;minor&quot;, false},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;minor&quot;, true},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;minor&quot;, true},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;patch&quot;, false},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;patch&quot;, false},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;patch&quot;, true},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, tc := range testCases {</span>
<span class="term-fg32">+		t.Run(tc.cfg+&quot;_&quot;+tc.bump, func(t *testing.T) {</span>
<span class="term-fg32">+			genesis, preMergeBlocks := generateMergeChain(2, false)</span>
<span class="term-fg32">+			ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+			ethcfg.RollupHaltOnIncompatibleProtocolVersion = tc.cfg &#47;&#47; opt-in to halting (or not)</span>
<span class="term-fg32">+			n, ethservice := startEthServiceWithConfigFn(t, preMergeBlocks, ethcfg)</span>
<span class="term-fg32">+			defer n.Close() &#47;&#47; close at the end, regardless of any prior (failed) closing</span>
<span class="term-fg32">+			api := NewConsensusAPI(ethservice)</span>
<span class="term-fg32">+			_, build, major, minor, patch, preRelease := params.OPStackSupport.Parse()</span>
<span class="term-fg32">+			majorSignal, minorSignal, patchSignal := major, minor, patch</span>
<span class="term-fg32">+			switch tc.bump {</span>
<span class="term-fg32">+			case &quot;major&quot;:</span>
<span class="term-fg32">+				majorSignal += 1</span>
<span class="term-fg32">+			case &quot;minor&quot;:</span>
<span class="term-fg32">+				minorSignal += 1</span>
<span class="term-fg32">+			case &quot;patch&quot;:</span>
<span class="term-fg32">+				patchSignal += 1</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			out, err := api.SignalSuperchainV1(&amp;SuperchainSignal{</span>
<span class="term-fg32">+				Recommended: params.OPStackSupport, &#47;&#47; required version change should be enough</span>
<span class="term-fg32">+				Required:    params.ProtocolVersionV0{Build: build, Major: majorSignal, Minor: minorSignal, Patch: patchSignal, PreRelease: preRelease}.Encode(),</span>
<span class="term-fg32">+			})</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if out != params.OPStackSupport {</span>
<span class="term-fg32">+				t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			closeErr := n.Close()</span>
<span class="term-fg32">+			if tc.halt {</span>
<span class="term-fg32">+				&#47;&#47; assert no halt by closing, and not getting any error</span>
<span class="term-fg32">+				if closeErr == nil {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected not to have closed already, but just closed without error&quot;)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				&#47;&#47; assert halt by closing again, and seeing if things error</span>
<span class="term-fg32">+				if closeErr == node.ErrNodeStopped {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected to have already closed and get a ErrNodeStopped error, but got %v&quot;, closeErr)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cd233959f66e6fe985e23930" role="button"
                   aria-expanded="false" aria-controls="id-cd233959f66e6fe985e23930">
                    <code>eth/gasprice/gasprice.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/gasprice/gasprice.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/gasprice/gasprice.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+23</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cd233959f66e6fe985e23930"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;gasprice.go op-geth&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg1">index a3dd83d79fb20f25ad005189c2350472353999f1..41d6bf38b1a91bbd335897cde47847b3526cce44 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg36">@@ -37,6 +37,8 @@</span>
 var (
 	DefaultMaxPrice    = big.NewInt(500 * params.GWei)
 	DefaultIgnorePrice = big.NewInt(2 * params.Wei)
<span class="term-fg32">+</span>
<span class="term-fg32">+	DefaultMinSuggestedPriorityFee = big.NewInt(1e6 * params.Wei) &#47;&#47; 0.001 gwei, for Optimism fee suggestion</span>
 )
&nbsp;
 type Config struct {
<span class="term-fg36">@@ -47,6 +49,8 @@</span> 	MaxBlockHistory  uint64
 	Default          *big.Int `toml:&quot;,omitempty&quot;`
 	MaxPrice         *big.Int `toml:&quot;,omitempty&quot;`
 	IgnorePrice      *big.Int `toml:&quot;,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	MinSuggestedPriorityFee *big.Int `toml:&quot;,omitempty&quot;` &#47;&#47; for Optimism fee suggestion</span>
 }
&nbsp;
 &#47;&#47; OracleBackend includes all necessary background APIs for oracle.
<span class="term-fg36">@@ -74,6 +78,8 @@</span> 	checkBlocks, percentile           int
 	maxHeaderHistory, maxBlockHistory uint64
&nbsp;
 	historyCache *lru.Cache[cacheKey, processedFees]
<span class="term-fg32">+</span>
<span class="term-fg32">+	minSuggestedPriorityFee *big.Int &#47;&#47; for Optimism fee suggestion</span>
 }
&nbsp;
 &#47;&#47; NewOracle returns a new gasprice oracle which can recommend suitable
<span class="term-fg36">@@ -128,7 +134,7 @@</span> 			lastHead = ev.Block.Hash()
 		}
 	}()
&nbsp;
<span class="term-fg31">-	return &amp;Oracle{</span>
<span class="term-fg32">+	r := &amp;Oracle{</span>
 		backend:          backend,
 		lastPrice:        params.Default,
 		maxPrice:         maxPrice,
<span class="term-fg36">@@ -139,6 +145,17 @@</span> 		maxHeaderHistory: maxHeaderHistory,
 		maxBlockHistory:  maxBlockHistory,
 		historyCache:     cache,
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if backend.ChainConfig().IsOptimism() {</span>
<span class="term-fg32">+		r.minSuggestedPriorityFee = params.MinSuggestedPriorityFee</span>
<span class="term-fg32">+		if r.minSuggestedPriorityFee == nil || r.minSuggestedPriorityFee.Int64() &lt;= 0 {</span>
<span class="term-fg32">+			r.minSuggestedPriorityFee = DefaultMinSuggestedPriorityFee</span>
<span class="term-fg32">+			log.Warn(&quot;Sanitizing invalid optimism gasprice oracle min priority fee suggestion&quot;,</span>
<span class="term-fg32">+				&quot;provided&quot;, params.MinSuggestedPriorityFee,</span>
<span class="term-fg32">+				&quot;updated&quot;, r.minSuggestedPriorityFee)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return r</span>
 }
&nbsp;
 &#47;&#47; SuggestTipCap returns a tip cap so that newly created transaction can have a
<span class="term-fg36">@@ -168,6 +185,11 @@</span> 	oracle.cacheLock.RUnlock()
 	if headHash == lastHead {
 		return new(big.Int).Set(lastPrice), nil
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if oracle.backend.ChainConfig().IsOptimism() {</span>
<span class="term-fg32">+		return oracle.SuggestOptimismPriorityFee(ctx, head, headHash), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var (
 		sent, exp int
 		number    = head.Number.Uint64()</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-dd234fd399164bffdada63c2" role="button"
                   aria-expanded="false" aria-controls="id-dd234fd399164bffdada63c2">
                    <code>eth/gasprice/optimism-gasprice.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/gasprice/optimism-gasprice.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+110</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-dd234fd399164bffdada63c2"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;optimism-gasprice.go op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..71cd021f637f92e4b6d99ec5fc337d27edf547e5</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice.go</span>
<span class="term-fg36">@@ -0,0 +1,110 @@</span>
<span class="term-fg32">+package gasprice</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;context&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;sort&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; SuggestOptimismPriorityFee returns a max priority fee value that can be used such that newly</span>
<span class="term-fg32">+&#47;&#47; created transactions have a very high chance to be included in the following blocks, using a</span>
<span class="term-fg32">+&#47;&#47; simplified and more predictable algorithm appropriate for chains like Optimism with a single</span>
<span class="term-fg32">+&#47;&#47; known block builder.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; In the typical case, which results whenever the last block had room for more transactions, this</span>
<span class="term-fg32">+&#47;&#47; function returns a minimum suggested priority fee value. Otherwise it returns the higher of this</span>
<span class="term-fg32">+&#47;&#47; minimum suggestion or 10% over the median effective priority fee from the last block.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Rationale: For a chain such as Optimism where there is a single block builder whose behavior is</span>
<span class="term-fg32">+&#47;&#47; known, we know priority fee (as long as it is non-zero) has no impact on the probability for tx</span>
<span class="term-fg32">+&#47;&#47; inclusion as long as there is capacity for it in the block. In this case then, there&#39;s no reason</span>
<span class="term-fg32">+&#47;&#47; to return any value higher than some fixed minimum. Blocks typically reach capacity only under</span>
<span class="term-fg32">+&#47;&#47; extreme events such as airdrops, meaning predicting whether the next block is going to be at</span>
<span class="term-fg32">+&#47;&#47; capacity is difficult *except* in the case where we&#39;re already experiencing the increased demand</span>
<span class="term-fg32">+&#47;&#47; from such an event. We therefore expect whether the last known block is at capacity to be one of</span>
<span class="term-fg32">+&#47;&#47; the best predictors of whether the next block is likely to be at capacity. (An even better</span>
<span class="term-fg32">+&#47;&#47; predictor is to look at the state of the transaction pool, but we want an algorithm that works</span>
<span class="term-fg32">+&#47;&#47; even if the txpool is private or unavailable.)</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; In the event the next block may be at capacity, the algorithm should allow for average fees to</span>
<span class="term-fg32">+&#47;&#47; rise in order to reach a market price that appropriately reflects demand. We accomplish this by</span>
<span class="term-fg32">+&#47;&#47; returning a suggestion that is a significant amount (10%) higher than the median effective</span>
<span class="term-fg32">+&#47;&#47; priority fee from the previous block.</span>
<span class="term-fg32">+func (oracle *Oracle) SuggestOptimismPriorityFee(ctx context.Context, h *types.Header, headHash common.Hash) *big.Int {</span>
<span class="term-fg32">+	suggestion := new(big.Int).Set(oracle.minSuggestedPriorityFee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; find the maximum gas used by any of the transactions in the block to use as the capacity</span>
<span class="term-fg32">+	&#47;&#47; margin</span>
<span class="term-fg32">+	receipts, err := oracle.backend.GetReceipts(ctx, headHash)</span>
<span class="term-fg32">+	if receipts == nil || err != nil {</span>
<span class="term-fg32">+		log.Error(&quot;failed to get block receipts&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+		return suggestion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var maxTxGasUsed uint64</span>
<span class="term-fg32">+	for i := range receipts {</span>
<span class="term-fg32">+		gu := receipts[i].GasUsed</span>
<span class="term-fg32">+		if gu &gt; maxTxGasUsed {</span>
<span class="term-fg32">+			maxTxGasUsed = gu</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; sanity check the max gas used value</span>
<span class="term-fg32">+	if maxTxGasUsed &gt; h.GasLimit {</span>
<span class="term-fg32">+		log.Error(&quot;found tx consuming more gas than the block limit&quot;, &quot;gas&quot;, maxTxGasUsed)</span>
<span class="term-fg32">+		return suggestion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if h.GasUsed+maxTxGasUsed &gt; h.GasLimit {</span>
<span class="term-fg32">+		&#47;&#47; A block is &quot;at capacity&quot; if, when it is built, there is a pending tx in the txpool that</span>
<span class="term-fg32">+		&#47;&#47; could not be included because the block&#39;s gas limit would be exceeded. Since we don&#39;t</span>
<span class="term-fg32">+		&#47;&#47; have access to the txpool, we instead adopt the following heuristic: consider a block as</span>
<span class="term-fg32">+		&#47;&#47; at capacity if the total gas consumed by its transactions is within max-tx-gas-used of</span>
<span class="term-fg32">+		&#47;&#47; the block limit, where max-tx-gas-used is the most gas used by any one transaction</span>
<span class="term-fg32">+		&#47;&#47; within the block. This heuristic is almost perfectly accurate when transactions always</span>
<span class="term-fg32">+		&#47;&#47; consume the same amount of gas, but becomes less accurate as tx gas consumption begins</span>
<span class="term-fg32">+		&#47;&#47; to vary. The typical error is we assume a block is at capacity when it was not because</span>
<span class="term-fg32">+		&#47;&#47; max-tx-gas-used will in most cases over-estimate the &quot;capacity margin&quot;. But it&#39;s better</span>
<span class="term-fg32">+		&#47;&#47; to err on the side of returning a higher-than-needed suggestion than a lower-than-needed</span>
<span class="term-fg32">+		&#47;&#47; one in order to satisfy our desire for high chance of inclusion and rising fees under</span>
<span class="term-fg32">+		&#47;&#47; high demand.</span>
<span class="term-fg32">+		block, err := oracle.backend.BlockByNumber(ctx, rpc.BlockNumber(h.Number.Int64()))</span>
<span class="term-fg32">+		if block == nil || err != nil {</span>
<span class="term-fg32">+			log.Error(&quot;failed to get last block&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+			return suggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		baseFee := block.BaseFee()</span>
<span class="term-fg32">+		txs := block.Transactions()</span>
<span class="term-fg32">+		if len(txs) == 0 {</span>
<span class="term-fg32">+			log.Error(&quot;block was at capacity but doesn&#39;t have transactions&quot;)</span>
<span class="term-fg32">+			return suggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		tips := bigIntArray(make([]*big.Int, len(txs)))</span>
<span class="term-fg32">+		for i := range txs {</span>
<span class="term-fg32">+			tips[i] = txs[i].EffectiveGasTipValue(baseFee)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		sort.Sort(tips)</span>
<span class="term-fg32">+		median := tips[len(tips)&#47;2]</span>
<span class="term-fg32">+		newSuggestion := new(big.Int).Add(median, new(big.Int).Div(median, big.NewInt(10)))</span>
<span class="term-fg32">+		&#47;&#47; use the new suggestion only if it&#39;s bigger than the minimum</span>
<span class="term-fg32">+		if newSuggestion.Cmp(suggestion) &gt; 0 {</span>
<span class="term-fg32">+			suggestion = newSuggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; the suggestion should be capped by oracle.maxPrice</span>
<span class="term-fg32">+	if suggestion.Cmp(oracle.maxPrice) &gt; 0 {</span>
<span class="term-fg32">+		suggestion.Set(oracle.maxPrice)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	oracle.cacheLock.Lock()</span>
<span class="term-fg32">+	oracle.lastHead = headHash</span>
<span class="term-fg32">+	oracle.lastPrice = suggestion</span>
<span class="term-fg32">+	oracle.cacheLock.Unlock()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return new(big.Int).Set(suggestion)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-499a129d2d6cbacae4d0f04e" role="button"
                   aria-expanded="false" aria-controls="id-499a129d2d6cbacae4d0f04e">
                    <code>eth/gasprice/optimism-gasprice_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/gasprice/optimism-gasprice_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+142</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-499a129d2d6cbacae4d0f04e"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..dd0140839d91e45be16d06faae9b714ad53265fa</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go</span>
<span class="term-fg36">@@ -0,0 +1,142 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2020 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package gasprice</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;context&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	blockGasLimit = params.TxGas * 3</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type testTxData struct {</span>
<span class="term-fg32">+	priorityFee int64</span>
<span class="term-fg32">+	gasLimit    uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type opTestBackend struct {</span>
<span class="term-fg32">+	block    *types.Block</span>
<span class="term-fg32">+	receipts []*types.Receipt</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) HeaderByNumber(ctx context.Context, number rpc.BlockNumber) (*types.Header, error) {</span>
<span class="term-fg32">+	panic(&quot;not implemented&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) BlockByNumber(ctx context.Context, number rpc.BlockNumber) (*types.Block, error) {</span>
<span class="term-fg32">+	return b.block, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) GetReceipts(ctx context.Context, hash common.Hash) (types.Receipts, error) {</span>
<span class="term-fg32">+	return b.receipts, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) PendingBlockAndReceipts() (*types.Block, types.Receipts) {</span>
<span class="term-fg32">+	panic(&quot;not implemented&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) ChainConfig() *params.ChainConfig {</span>
<span class="term-fg32">+	return params.OptimismTestConfig</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) SubscribeChainHeadEvent(ch chan&lt;- core.ChainHeadEvent) event.Subscription {</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newOpTestBackend(t *testing.T, txs []testTxData) *opTestBackend {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		key, _ = crypto.HexToECDSA(&quot;b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291&quot;)</span>
<span class="term-fg32">+		signer = types.LatestSigner(params.TestChainConfig)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	&#47;&#47; only the most recent block is considered for optimism priority fee suggestions, so this is</span>
<span class="term-fg32">+	&#47;&#47; where we add the test transactions</span>
<span class="term-fg32">+	ts := []*types.Transaction{}</span>
<span class="term-fg32">+	rs := []*types.Receipt{}</span>
<span class="term-fg32">+	header := types.Header{}</span>
<span class="term-fg32">+	header.GasLimit = blockGasLimit</span>
<span class="term-fg32">+	var nonce uint64</span>
<span class="term-fg32">+	for _, tx := range txs {</span>
<span class="term-fg32">+		txdata := &amp;types.DynamicFeeTx{</span>
<span class="term-fg32">+			ChainID:   params.TestChainConfig.ChainID,</span>
<span class="term-fg32">+			Nonce:     nonce,</span>
<span class="term-fg32">+			To:        &amp;common.Address{},</span>
<span class="term-fg32">+			Gas:       params.TxGas,</span>
<span class="term-fg32">+			GasFeeCap: big.NewInt(100 * params.GWei),</span>
<span class="term-fg32">+			GasTipCap: big.NewInt(tx.priorityFee),</span>
<span class="term-fg32">+			Data:      []byte{},</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		t := types.MustSignNewTx(key, signer, txdata)</span>
<span class="term-fg32">+		ts = append(ts, t)</span>
<span class="term-fg32">+		r := types.Receipt{}</span>
<span class="term-fg32">+		r.GasUsed = tx.gasLimit</span>
<span class="term-fg32">+		header.GasUsed += r.GasUsed</span>
<span class="term-fg32">+		rs = append(rs, &amp;r)</span>
<span class="term-fg32">+		nonce++</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	hasher := trie.NewStackTrie(nil)</span>
<span class="term-fg32">+	b := types.NewBlock(&amp;header, ts, nil, nil, hasher)</span>
<span class="term-fg32">+	return &amp;opTestBackend{block: b, receipts: rs}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSuggestOptimismPriorityFee(t *testing.T) {</span>
<span class="term-fg32">+	minSuggestion := new(big.Int).SetUint64(1e8 * params.Wei)</span>
<span class="term-fg32">+	var cases = []struct {</span>
<span class="term-fg32">+		txdata []testTxData</span>
<span class="term-fg32">+		want   *big.Int</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; block well under capacity, expect min priority fee suggestion</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   minSuggestion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 2 txs, still under capacity, expect min priority fee suggestion</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}, testTxData{params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   minSuggestion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 2 txs w same priority fee (1 gwei), but second tx puts it right over capacity</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}, testTxData{params.GWei, 21001}},</span>
<span class="term-fg32">+			want:   big.NewInt(1100000000), &#47;&#47; 10 percent over 1 gwei, the median</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 3 txs, full block. return 10% over the median tx (10 gwei * 10% == 11 gwei)</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{10 * params.GWei, 21000}, testTxData{1 * params.GWei, 21000}, testTxData{100 * params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   big.NewInt(11 * params.GWei),</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for i, c := range cases {</span>
<span class="term-fg32">+		backend := newOpTestBackend(t, c.txdata)</span>
<span class="term-fg32">+		oracle := NewOracle(backend, Config{MinSuggestedPriorityFee: minSuggestion})</span>
<span class="term-fg32">+		got := oracle.SuggestOptimismPriorityFee(context.Background(), backend.block.Header(), backend.block.Hash())</span>
<span class="term-fg32">+		if got.Cmp(c.want) != 0 {</span>
<span class="term-fg32">+			t.Errorf(&quot;Gas price mismatch for test case %d: want %d, got %d&quot;, i, c.want, got)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-75562994dd7fec5a5bae5776" role="button"
                   aria-expanded="false" aria-controls="id-75562994dd7fec5a5bae5776">
                    <code>eth/protocols/snap/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/eth/protocols/snap/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/eth/protocols/snap/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-75562994dd7fec5a5bae5776"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;snap&#47;handler.go op-geth&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg1">index 55781ac54b74c1b9d111548a83feac79d385e37b..c57ac5e2e386c56c6775265c54cd5facbf18a215 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg36">@@ -469,7 +469,7 @@</span> 		if hash == types.EmptyCodeHash {
 			&#47;&#47; Peers should not request the empty code, but if they do, at
 			&#47;&#47; least sent them back a correct response without db lookups
 			codes = append(codes, []byte{})
<span class="term-fg31">-		} else if blob, err := chain.ContractCodeWithPrefix(hash); err == nil {</span>
<span class="term-fg32">+		} else if blob, err := chain.ContractCode(hash); err == nil {</span>
 			codes = append(codes, blob)
 			bytes += uint64(len(blob))
 		}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d1f95e704a7378c9556ec3a4" role="button"
                   aria-expanded="false" aria-controls="id-d1f95e704a7378c9556ec3a4">
                    <code>light/odr_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/light/odr_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/light/odr_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d1f95e704a7378c9556ec3a4"><span class="term-fg1">diff --git go-ethereum&#47;light&#47;odr_test.go op-geth&#47;light&#47;odr_test.go</span>
<span class="term-fg1">index 0df1fbf2f5b29c12c5b80e0fca4372b6dec17d07..6d58f9aab8bf319379786dba02b58e71ce1c0545 100644</span>
<span class="term-fg1">--- go-ethereum&#47;light&#47;odr_test.go</span>
<span class="term-fg1">+++ op-geth&#47;light&#47;odr_test.go</span>
<span class="term-fg36">@@ -212,7 +212,7 @@</span> 			Data:              data,
 			SkipAccountChecks: true,
 		}
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(header, chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(header, chain, nil, config, st)</span>
 		vmenv := vm.NewEVM(context, txContext, st, config, vm.Config{NoBaseFee: true})
 		gp := new(core.GasPool).AddGas(math.MaxUint64)
 		result, _ := core.ApplyMessage(vmenv, msg, gp)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-878570ba69063cd3a739b4c1" role="button"
                   aria-expanded="false" aria-controls="id-878570ba69063cd3a739b4c1">
                    <code>p2p/server.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/p2p/server.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/p2p/server.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-878570ba69063cd3a739b4c1"><span class="term-fg1">diff --git go-ethereum&#47;p2p&#47;server.go op-geth&#47;p2p&#47;server.go</span>
<span class="term-fg1">index f7bf948b6901249e49e06c04e08597e16b6ea260..6aa5d29d8ee301b7a77b8b6812a38d0d4a8ef7dd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;p2p&#47;server.go</span>
<span class="term-fg1">+++ op-geth&#47;p2p&#47;server.go</span>
<span class="term-fg36">@@ -621,6 +621,7 @@</span> 		}
 		if err != nil {
 			return err
 		}
<span class="term-fg32">+		srv.discmix.AddSource(srv.DiscV5.RandomNodes())</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ea4ec0bc10787a1a3ae0eb0a" role="button"
                   aria-expanded="false" aria-controls="id-ea4ec0bc10787a1a3ae0eb0a">
                    <code>params/config_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/params/config_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/params/config_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ea4ec0bc10787a1a3ae0eb0a"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;config_test.go op-geth&#47;params&#47;config_test.go</span>
<span class="term-fg1">index bf8ce2fc5e247242615ff478a455785f9f07f88b..14d7f833bb978c2bb7cefc70cff2015079c9a04a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;config_test.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;config_test.go</span>
<span class="term-fg36">@@ -137,3 +137,22 @@</span> 	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsShanghai {
 		t.Errorf(&quot;expected %v to be shanghai&quot;, stamp)
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestConfigRulesRegolith(t *testing.T) {</span>
<span class="term-fg32">+	c := &amp;ChainConfig{</span>
<span class="term-fg32">+		RegolithTime: newUint64(500),</span>
<span class="term-fg32">+		Optimism:     &amp;OptimismConfig{},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var stamp uint64</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to not be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	stamp = 500</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	stamp = math.MaxInt64</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-da7485216c51224fc63ca3ef" role="button"
                   aria-expanded="false" aria-controls="id-da7485216c51224fc63ca3ef">
                    <code>params/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/params/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+231</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-da7485216c51224fc63ca3ef"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;superchain.go op-geth&#47;params&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..a55c2eb1bf619d1f7304c88c23d92762a5ac3a34</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,231 @@</span>
<span class="term-fg32">+package params</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;encoding&#47;binary&quot;</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;strings&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var OPStackSupport = ProtocolVersionV0{Build: [8]byte{}, Major: 3, Minor: 1, Patch: 0, PreRelease: 1}.Encode()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func init() {</span>
<span class="term-fg32">+	for id, ch := range superchain.OPChains {</span>
<span class="term-fg32">+		NetworkNames[fmt.Sprintf(&quot;%d&quot;, id)] = ch.Name</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func OPStackChainIDByName(name string) (uint64, error) {</span>
<span class="term-fg32">+	for id, ch := range superchain.OPChains {</span>
<span class="term-fg32">+		if ch.Chain+&quot;-&quot;+ch.Superchain == name {</span>
<span class="term-fg32">+			return id, nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0, fmt.Errorf(&quot;unknown chain %q&quot;, name)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LoadOPStackChainConfig(chainID uint64) (*ChainConfig, error) {</span>
<span class="term-fg32">+	chConfig, ok := superchain.OPChains[chainID]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;unknown chain ID: %d&quot;, chainID)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	superchainConfig, ok := superchain.Superchains[chConfig.Superchain]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;unknown superchain %q&quot;, chConfig.Superchain)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesisActivation := uint64(0)</span>
<span class="term-fg32">+	out := &amp;ChainConfig{</span>
<span class="term-fg32">+		ChainID:                       new(big.Int).SetUint64(chainID),</span>
<span class="term-fg32">+		HomesteadBlock:                common.Big0,</span>
<span class="term-fg32">+		DAOForkBlock:                  nil,</span>
<span class="term-fg32">+		DAOForkSupport:                false,</span>
<span class="term-fg32">+		EIP150Block:                   common.Big0,</span>
<span class="term-fg32">+		EIP155Block:                   common.Big0,</span>
<span class="term-fg32">+		EIP158Block:                   common.Big0,</span>
<span class="term-fg32">+		ByzantiumBlock:                common.Big0,</span>
<span class="term-fg32">+		ConstantinopleBlock:           common.Big0,</span>
<span class="term-fg32">+		PetersburgBlock:               common.Big0,</span>
<span class="term-fg32">+		IstanbulBlock:                 common.Big0,</span>
<span class="term-fg32">+		MuirGlacierBlock:              common.Big0,</span>
<span class="term-fg32">+		BerlinBlock:                   common.Big0,</span>
<span class="term-fg32">+		LondonBlock:                   common.Big0,</span>
<span class="term-fg32">+		ArrowGlacierBlock:             common.Big0,</span>
<span class="term-fg32">+		GrayGlacierBlock:              common.Big0,</span>
<span class="term-fg32">+		MergeNetsplitBlock:            common.Big0,</span>
<span class="term-fg32">+		ShanghaiTime:                  nil,</span>
<span class="term-fg32">+		CancunTime:                    nil,</span>
<span class="term-fg32">+		PragueTime:                    nil,</span>
<span class="term-fg32">+		BedrockBlock:                  common.Big0,</span>
<span class="term-fg32">+		RegolithTime:                  &amp;genesisActivation,</span>
<span class="term-fg32">+		TerminalTotalDifficulty:       common.Big0,</span>
<span class="term-fg32">+		TerminalTotalDifficultyPassed: true,</span>
<span class="term-fg32">+		Ethash:                        nil,</span>
<span class="term-fg32">+		Clique:                        nil,</span>
<span class="term-fg32">+		Optimism: &amp;OptimismConfig{</span>
<span class="term-fg32">+			EIP1559Elasticity:  6,</span>
<span class="term-fg32">+			EIP1559Denominator: 50,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; note: no actual parameters are being loaded, yet.</span>
<span class="term-fg32">+	&#47;&#47; Future superchain upgrades are loaded from the superchain chConfig and applied to the geth ChainConfig here.</span>
<span class="term-fg32">+	_ = superchainConfig.Config</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; special overrides for OP-Stack chains with pre-Regolith upgrade history</span>
<span class="term-fg32">+	switch chainID {</span>
<span class="term-fg32">+	case OPGoerliChainID:</span>
<span class="term-fg32">+		out.LondonBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.ArrowGlacierBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.GrayGlacierBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.MergeNetsplitBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.BedrockBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.RegolithTime = &amp;OptimismGoerliRegolithTime</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	case OPMainnetChainID:</span>
<span class="term-fg32">+		out.BerlinBlock = big.NewInt(3950000)</span>
<span class="term-fg32">+		out.LondonBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.ArrowGlacierBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.GrayGlacierBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.MergeNetsplitBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.BedrockBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+	case BaseGoerliChainID:</span>
<span class="term-fg32">+		out.RegolithTime = &amp;BaseGoerliRegolithTime</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return out, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ProtocolVersion encodes the OP-Stack protocol version. See OP-Stack superchain-upgrade specification.</span>
<span class="term-fg32">+type ProtocolVersion [32]byte</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) MarshalText() ([]byte, error) {</span>
<span class="term-fg32">+	return common.Hash(p).MarshalText()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p *ProtocolVersion) UnmarshalText(input []byte) error {</span>
<span class="term-fg32">+	return (*common.Hash)(p).UnmarshalText(input)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) Parse() (versionType uint8, build [8]byte, major, minor, patch, preRelease uint32) {</span>
<span class="term-fg32">+	versionType = p[0]</span>
<span class="term-fg32">+	if versionType != 0 {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; bytes 1:8 reserved for future use</span>
<span class="term-fg32">+	copy(build[:], p[8:16])                        &#47;&#47; differentiates forks and custom-builds of standard protocol</span>
<span class="term-fg32">+	major = binary.BigEndian.Uint32(p[16:20])      &#47;&#47; incompatible API changes</span>
<span class="term-fg32">+	minor = binary.BigEndian.Uint32(p[20:24])      &#47;&#47; identifies additional functionality in backwards compatible manner</span>
<span class="term-fg32">+	patch = binary.BigEndian.Uint32(p[24:28])      &#47;&#47; identifies backward-compatible bug-fixes</span>
<span class="term-fg32">+	preRelease = binary.BigEndian.Uint32(p[28:32]) &#47;&#47; identifies unstable versions that may not satisfy the above</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) String() string {</span>
<span class="term-fg32">+	versionType, build, major, minor, patch, preRelease := p.Parse()</span>
<span class="term-fg32">+	if versionType != 0 {</span>
<span class="term-fg32">+		return &quot;v0.0.0-unknown.&quot; + common.Hash(p).String()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	ver := fmt.Sprintf(&quot;v%d.%d.%d&quot;, major, minor, patch)</span>
<span class="term-fg32">+	if preRelease != 0 {</span>
<span class="term-fg32">+		ver += fmt.Sprintf(&quot;-%d&quot;, preRelease)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if build != ([8]byte{}) {</span>
<span class="term-fg32">+		if humanBuildTag(build) {</span>
<span class="term-fg32">+			ver += fmt.Sprintf(&quot;+%s&quot;, strings.TrimRight(string(build[:]), &quot;\x00&quot;))</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			ver += fmt.Sprintf(&quot;+0x%x&quot;, build)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return ver</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; humanBuildTag identifies which build tag we can stringify for human-readable versions</span>
<span class="term-fg32">+func humanBuildTag(v [8]byte) bool {</span>
<span class="term-fg32">+	for i, c := range v { &#47;&#47; following semver.org advertised regex, alphanumeric with &#39;-&#39; and &#39;.&#39;, except leading &#39;.&#39;.</span>
<span class="term-fg32">+		if c == 0 { &#47;&#47; trailing zeroed are allowed</span>
<span class="term-fg32">+			for _, d := range v[i:] {</span>
<span class="term-fg32">+				if d != 0 {</span>
<span class="term-fg32">+					return false</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return true</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !((c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;Z&#39;) || (c &gt;= &#39;a&#39; &amp;&amp; c &lt;= &#39;z&#39;) || (c &gt;= &#39;0&#39; &amp;&amp; c &lt;= &#39;9&#39;) || c == &#39;-&#39; || (c == &#39;.&#39; &amp;&amp; i &gt; 0)) {</span>
<span class="term-fg32">+			return false</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return true</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ProtocolVersionComparison is used to identify how far ahead&#47;outdated a protocol version is relative to another.</span>
<span class="term-fg32">+&#47;&#47; This value is used in metrics and switch comparisons, to easily identify each type of version difference.</span>
<span class="term-fg32">+&#47;&#47; Negative values mean the version is outdated.</span>
<span class="term-fg32">+&#47;&#47; Positive values mean the version is up-to-date.</span>
<span class="term-fg32">+&#47;&#47; Matching versions have a 0.</span>
<span class="term-fg32">+type ProtocolVersionComparison int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	AheadMajor         ProtocolVersionComparison = 4</span>
<span class="term-fg32">+	OutdatedMajor      ProtocolVersionComparison = -4</span>
<span class="term-fg32">+	AheadMinor         ProtocolVersionComparison = 3</span>
<span class="term-fg32">+	OutdatedMinor      ProtocolVersionComparison = -3</span>
<span class="term-fg32">+	AheadPatch         ProtocolVersionComparison = 2</span>
<span class="term-fg32">+	OutdatedPatch      ProtocolVersionComparison = -2</span>
<span class="term-fg32">+	AheadPrerelease    ProtocolVersionComparison = 1</span>
<span class="term-fg32">+	OutdatedPrerelease ProtocolVersionComparison = -1</span>
<span class="term-fg32">+	Matching           ProtocolVersionComparison = 0</span>
<span class="term-fg32">+	DiffVersionType    ProtocolVersionComparison = 100</span>
<span class="term-fg32">+	DiffBuild          ProtocolVersionComparison = 101</span>
<span class="term-fg32">+	EmptyVersion       ProtocolVersionComparison = 102</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) Compare(other ProtocolVersion) (cmp ProtocolVersionComparison) {</span>
<span class="term-fg32">+	if p == (ProtocolVersion{}) || (other == (ProtocolVersion{})) {</span>
<span class="term-fg32">+		return EmptyVersion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	aVersionType, aBuild, aMajor, aMinor, aPatch, aPreRelease := p.Parse()</span>
<span class="term-fg32">+	bVersionType, bBuild, bMajor, bMinor, bPatch, bPreRelease := other.Parse()</span>
<span class="term-fg32">+	if aVersionType != bVersionType {</span>
<span class="term-fg32">+		return DiffVersionType</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if aBuild != bBuild {</span>
<span class="term-fg32">+		return DiffBuild</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	fn := func(a, b uint32, ahead, outdated ProtocolVersionComparison) ProtocolVersionComparison {</span>
<span class="term-fg32">+		if a == b {</span>
<span class="term-fg32">+			return Matching</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if a &gt; b {</span>
<span class="term-fg32">+			return ahead</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return outdated</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aMajor, bMajor, AheadMajor, OutdatedMajor); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aMinor, bMinor, AheadMinor, OutdatedMinor); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aPatch, bPatch, AheadPatch, OutdatedPatch); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return fn(aPreRelease, bPreRelease, AheadPrerelease, OutdatedPrerelease)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type ProtocolVersionV0 struct {</span>
<span class="term-fg32">+	Build                           [8]byte</span>
<span class="term-fg32">+	Major, Minor, Patch, PreRelease uint32</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (v ProtocolVersionV0) Encode() (out ProtocolVersion) {</span>
<span class="term-fg32">+	copy(out[8:16], v.Build[:])</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[16:20], v.Major)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[20:24], v.Minor)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[24:28], v.Patch)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[28:32], v.PreRelease)</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-da6e6087720ae03eea39590a" role="button"
                   aria-expanded="false" aria-controls="id-da6e6087720ae03eea39590a">
                    <code>params/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/params/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+111</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-da6e6087720ae03eea39590a"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;superchain_test.go op-geth&#47;params&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..a1fe1d5332ad24daa4cd4cd617019e97cb190762</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,111 @@</span>
<span class="term-fg32">+package params</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type HumanProtocolVersion struct {</span>
<span class="term-fg32">+	VersionType         uint8</span>
<span class="term-fg32">+	Major, Minor, Patch uint32</span>
<span class="term-fg32">+	Prerelease          uint32</span>
<span class="term-fg32">+	Build               [8]byte</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type ComparisonCase struct {</span>
<span class="term-fg32">+	A, B HumanProtocolVersion</span>
<span class="term-fg32">+	Cmp  ProtocolVersionComparison</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestProtocolVersion_Compare(t *testing.T) {</span>
<span class="term-fg32">+	testCases := []ComparisonCase{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 2, 1, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 2, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMajor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 2, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 2, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 1, 2, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 1, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 1, 1, 2, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPrerelease,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 2, 3, 4, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 3, 4, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: Matching,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 3, 2, 1, 5, [8]byte{3}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{1, 1, 2, 3, 3, [8]byte{6}},</span>
<span class="term-fg32">+			Cmp: DiffVersionType,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 3, 2, 1, 5, [8]byte{3}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 3, 3, [8]byte{6}},</span>
<span class="term-fg32">+			Cmp: DiffBuild,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 0, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 3, 3, 3, [8]byte{3}},</span>
<span class="term-fg32">+			Cmp: EmptyVersion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for i, tc := range testCases {</span>
<span class="term-fg32">+		t.Run(fmt.Sprintf(&quot;case_%d&quot;, i), func(t *testing.T) {</span>
<span class="term-fg32">+			a := ProtocolVersionV0{tc.A.Build, tc.A.Major, tc.A.Minor, tc.A.Patch, tc.A.Prerelease}.Encode()</span>
<span class="term-fg32">+			a[0] = tc.A.VersionType</span>
<span class="term-fg32">+			b := ProtocolVersionV0{tc.B.Build, tc.B.Major, tc.B.Minor, tc.B.Patch, tc.B.Prerelease}.Encode()</span>
<span class="term-fg32">+			b[0] = tc.B.VersionType</span>
<span class="term-fg32">+			cmp := a.Compare(b)</span>
<span class="term-fg32">+			if cmp != tc.Cmp {</span>
<span class="term-fg32">+				t.Fatalf(&quot;expected %d but got %d&quot;, tc.Cmp, cmp)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			switch tc.Cmp {</span>
<span class="term-fg32">+			case AheadMajor, AheadMinor, AheadPatch, AheadPrerelease:</span>
<span class="term-fg32">+				inv := b.Compare(a)</span>
<span class="term-fg32">+				if inv != -tc.Cmp {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected inverse when reversing the comparison, %d but got %d&quot;, -tc.Cmp, inv)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			case DiffVersionType, DiffBuild, EmptyVersion, Matching:</span>
<span class="term-fg32">+				inv := b.Compare(a)</span>
<span class="term-fg32">+				if inv != tc.Cmp {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected comparison reversed to hold the same, expected %d but got %d&quot;, tc.Cmp, inv)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+func TestProtocolVersion_String(t *testing.T) {</span>
<span class="term-fg32">+	testCases := []struct {</span>
<span class="term-fg32">+		version  ProtocolVersion</span>
<span class="term-fg32">+		expected string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 0, 0}.Encode(), &quot;v0.0.0&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 0, 1}.Encode(), &quot;v0.0.0-1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 1, 0}.Encode(), &quot;v0.0.1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 4, 3, 2, 1}.Encode(), &quot;v4.3.2-1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 100, 2, 0}.Encode(), &quot;v0.100.2&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;O&#39;, &#39;P&#39;, &#39;-&#39;, &#39;m&#39;, &#39;o&#39;, &#39;d&#39;}, 42, 0, 2, 1}.Encode(), &quot;v42.0.2-1+OP-mod&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;b&#39;, &#39;e&#39;, &#39;t&#39;, &#39;a&#39;, &#39;.&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;}, 1, 0, 0, 0}.Encode(), &quot;v1.0.0+beta.123&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;a&#39;, &#39;b&#39;, 1}, 42, 0, 2, 0}.Encode(), &quot;v42.0.2+0x6162010000000000&quot;}, &#47;&#47; do not render invalid alpha numeric</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{1, 2, 3, 4, 5, 6, 7, 8}, 42, 0, 2, 0}.Encode(), &quot;v42.0.2+0x0102030405060708&quot;},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, tc := range testCases {</span>
<span class="term-fg32">+		t.Run(tc.expected, func(t *testing.T) {</span>
<span class="term-fg32">+			got := tc.version.String()</span>
<span class="term-fg32">+			if got != tc.expected {</span>
<span class="term-fg32">+				t.Fatalf(&quot;got %q but expected %q&quot;, got, tc.expected)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3d64131891724b44be29c2fa" role="button"
                   aria-expanded="false" aria-controls="id-3d64131891724b44be29c2fa">
                    <code>tests/state_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/tests/state_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/tests/state_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3d64131891724b44be29c2fa"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;state_test.go op-geth&#47;tests&#47;state_test.go</span>
<span class="term-fg1">index 9d3862e1dc7c2c243982dd08808d487f803e3779..2f54ccdbc74f6d7210ae1a32d777ad469d3604cf 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;state_test.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;state_test.go</span>
<span class="term-fg36">@@ -221,7 +221,7 @@</span> 			}
&nbsp;
 			&#47;&#47; Prepare the EVM.
 			txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-			context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase)</span>
<span class="term-fg32">+			context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase, config, statedb)</span>
 			context.GetHash = vmTestBlockHash
 			context.BaseFee = baseFee
 			evm := vm.NewEVM(context, txContext, statedb, config, vmconfig)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a9e2629a40971f5f80a60f90" role="button"
                   aria-expanded="false" aria-controls="id-a9e2629a40971f5f80a60f90">
                    <code>tests/state_test_util.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/tests/state_test_util.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/tests/state_test_util.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a9e2629a40971f5f80a60f90"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;state_test_util.go op-geth&#47;tests&#47;state_test_util.go</span>
<span class="term-fg1">index eec91b67a7d461b0264ab4347c6407993d71379e..83b68da5769ca3b14ea2bf1675281a97ca9a8b62 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;state_test_util.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;state_test_util.go</span>
<span class="term-fg36">@@ -247,7 +247,7 @@</span> 	}
&nbsp;
 	&#47;&#47; Prepare the EVM.
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase, config, statedb)</span>
 	context.GetHash = vmTestBlockHash
 	context.BaseFee = baseFee
 	context.Random = nil</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

                
                    <div class="text-muted">
                        <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-0422779adb835c7bd3f67d5a"role="button" aria-expanded="false" aria-controls="id-0422779adb835c7bd3f67d5a">
        
            <div class="col-12 col-sm-9 text-start"><h4>Ignored changes</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+501</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-0422779adb835c7bd3f67d5a">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8806b0a4b8cfa240fd863b8f" role="button"
                   aria-expanded="false" aria-controls="id-8806b0a4b8cfa240fd863b8f">
                    <code>.circleci/check-releases.sh</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/.circleci/check-releases.sh" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8806b0a4b8cfa240fd863b8f"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;check-releases.sh op-geth&#47;.circleci&#47;check-releases.sh</span>
<span class="term-fg1">new file mode 100755</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..f3595e1320377bea4b17c13326d87342083071c0</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;check-releases.sh</span>
<span class="term-fg36">@@ -0,0 +1,21 @@</span>
<span class="term-fg32">+#!&#47;bin&#47;bash</span>
<span class="term-fg32">+set -euo pipefail</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+LATEST_RELEASE=$(curl -s --fail -L \</span>
<span class="term-fg32">+  -H &quot;Accept: application&#47;vnd.github+json&quot; \</span>
<span class="term-fg32">+  -H &quot;X-GitHub-Api-Version: 2022-11-28&quot; \</span>
<span class="term-fg32">+  https:&#47;&#47;api.github.com&#47;repos&#47;ethereum&#47;go-ethereum&#47;releases \</span>
<span class="term-fg32">+  | jq -r &#39;(.[] | select(.draft==false) | select(.prerelease==false)).tag_name&#39; | head -n 1)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Detected latest go-ethereum release as ${LATEST_RELEASE}&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+git remote add upstream https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum</span>
<span class="term-fg32">+git fetch upstream &gt; &#47;dev&#47;null</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+if git branch --contains &quot;${LATEST_RELEASE}&quot; 2&gt;&amp;1 | grep -e &#39;^[ *]*optimism$&#39; &gt; &#47;dev&#47;null</span>
<span class="term-fg32">+then</span>
<span class="term-fg32">+  echo &quot;Up to date with latest release.  Great job! &quot;</span>
<span class="term-fg32">+else</span>
<span class="term-fg32">+  echo &quot;Release has not been merged&quot;</span>
<span class="term-fg32">+  exit 1</span>
<span class="term-fg32">+fi</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-05dda85294cb810307e7f921" role="button"
                   aria-expanded="false" aria-controls="id-05dda85294cb810307e7f921">
                    <code>.circleci/ci-docker-tag-op-geth-release.sh</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/.circleci/ci-docker-tag-op-geth-release.sh" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+38</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-05dda85294cb810307e7f921"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh op-geth&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh</span>
<span class="term-fg1">new file mode 100755</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..7b66e789a4d7e50699f2d22ff037117c0d7a3a35</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh</span>
<span class="term-fg36">@@ -0,0 +1,38 @@</span>
<span class="term-fg32">+#!&#47;usr&#47;bin&#47;env bash</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+set -euo pipefail</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+DOCKER_REPO=$1</span>
<span class="term-fg32">+GIT_TAG=$2</span>
<span class="term-fg32">+GIT_SHA=$3</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+IMAGE_NAME=&quot;op-geth&quot;</span>
<span class="term-fg32">+IMAGE_TAG=$GIT_TAG</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+SOURCE_IMAGE_TAG=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:$GIT_SHA&quot;</span>
<span class="term-fg32">+TARGET_IMAGE_TAG=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:$IMAGE_TAG&quot;</span>
<span class="term-fg32">+TARGET_IMAGE_TAG_LATEST=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:latest&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Checking if docker images exist for &#39;$IMAGE_NAME&#39;&quot;</span>
<span class="term-fg32">+echo &quot;&quot;</span>
<span class="term-fg32">+tags=$(gcloud container images list-tags &quot;$DOCKER_REPO&#47;$IMAGE_NAME&quot; --limit 1 --format json)</span>
<span class="term-fg32">+if [ &quot;$tags&quot; = &quot;[]&quot; ]; then</span>
<span class="term-fg32">+  echo &quot;No existing docker images were found for &#39;$IMAGE_NAME&#39;. The code tagged with &#39;$GIT_TAG&#39; may not have an associated dockerfile or docker build job.&quot;</span>
<span class="term-fg32">+  echo &quot;If this service has a dockerfile, add a docker-publish job for it in the circleci config.&quot;</span>
<span class="term-fg32">+  echo &quot;&quot;</span>
<span class="term-fg32">+  echo &quot;Exiting&quot;</span>
<span class="term-fg32">+  exit 0</span>
<span class="term-fg32">+fi</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Tagging $SOURCE_IMAGE_TAG with &#39;$IMAGE_TAG&#39;&quot;</span>
<span class="term-fg32">+gcloud container images add-tag -q &quot;$SOURCE_IMAGE_TAG&quot; &quot;$TARGET_IMAGE_TAG&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+# Do not tag with latest if the release is a release candidate.</span>
<span class="term-fg32">+if [[ &quot;$IMAGE_TAG&quot; == *&quot;rc&quot;* ]]; then</span>
<span class="term-fg32">+  echo &quot;Not tagging with &#39;latest&#39; because the release is a release candidate.&quot;</span>
<span class="term-fg32">+  exit 0</span>
<span class="term-fg32">+fi</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Tagging $SOURCE_IMAGE_TAG with &#39;latest&#39;&quot;</span>
<span class="term-fg32">+gcloud container images add-tag -q &quot;$SOURCE_IMAGE_TAG&quot; &quot;$TARGET_IMAGE_TAG_LATEST&quot;</span>
<span class="term-fg32">+</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4d6ebe48e6fdb232b6b49e4a" role="button"
                   aria-expanded="false" aria-controls="id-4d6ebe48e6fdb232b6b49e4a">
                    <code>.circleci/config.yml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/.circleci/config.yml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+198</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4d6ebe48e6fdb232b6b49e4a"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;config.yml op-geth&#47;.circleci&#47;config.yml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..0c9b7cda88004459f3635bc7e86704fc3df4f898</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;config.yml</span>
<span class="term-fg36">@@ -0,0 +1,198 @@</span>
<span class="term-fg32">+version: 2.1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+orbs:</span>
<span class="term-fg32">+  gcp-cli: circleci&#47;gcp-cli@3.0.1</span>
<span class="term-fg32">+  slack: circleci&#47;slack@4.10.1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+commands:</span>
<span class="term-fg32">+  gcp-oidc-authenticate:</span>
<span class="term-fg32">+    description: &quot;Authenticate with GCP using a CircleCI OIDC token.&quot;</span>
<span class="term-fg32">+    parameters:</span>
<span class="term-fg32">+      project_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_PROJECT_ID</span>
<span class="term-fg32">+      workload_identity_pool_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_WIP_ID</span>
<span class="term-fg32">+      workload_identity_pool_provider_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_WIP_PROVIDER_ID</span>
<span class="term-fg32">+      service_account_email:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_SERVICE_ACCOUNT_EMAIL</span>
<span class="term-fg32">+      gcp_cred_config_file_path:</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &#47;home&#47;circleci&#47;gcp_cred_config.json</span>
<span class="term-fg32">+      oidc_token_file_path:</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &#47;home&#47;circleci&#47;oidc_token.json</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: &quot;Create OIDC credential configuration&quot;</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            # Store OIDC token in temp file</span>
<span class="term-fg32">+            echo $CIRCLE_OIDC_TOKEN &gt; &lt;&lt; parameters.oidc_token_file_path &gt;&gt;</span>
<span class="term-fg32">+            # Create a credential configuration for the generated OIDC ID Token</span>
<span class="term-fg32">+            gcloud iam workload-identity-pools create-cred-config \</span>
<span class="term-fg32">+                &quot;projects&#47;${&lt;&lt; parameters.project_id &gt;&gt;}&#47;locations&#47;global&#47;workloadIdentityPools&#47;${&lt;&lt; parameters.workload_identity_pool_id &gt;&gt;}&#47;providers&#47;${&lt;&lt; parameters.workload_identity_pool_provider_id &gt;&gt;}&quot;\</span>
<span class="term-fg32">+                --output-file=&quot;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&quot; \</span>
<span class="term-fg32">+                --service-account=&quot;${&lt;&lt; parameters.service_account_email &gt;&gt;}&quot; \</span>
<span class="term-fg32">+                --credential-source-file=&lt;&lt; parameters.oidc_token_file_path &gt;&gt;</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: &quot;Authenticate with GCP using OIDC&quot;</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            # Configure gcloud to leverage the generated credential configuration</span>
<span class="term-fg32">+            gcloud auth login --brief --cred-file &quot;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&quot;</span>
<span class="term-fg32">+            # Configure ADC</span>
<span class="term-fg32">+            echo &quot;export GOOGLE_APPLICATION_CREDENTIALS=&#39;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&#39;&quot; | tee -a &quot;$BASH_ENV&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+jobs:</span>
<span class="term-fg32">+  docker-release:</span>
<span class="term-fg32">+    environment:</span>
<span class="term-fg32">+      DOCKER_BUILDKIT: 1</span>
<span class="term-fg32">+    parameters:</span>
<span class="term-fg32">+      docker_name:</span>
<span class="term-fg32">+        description: Docker image name</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;op-geth&quot;</span>
<span class="term-fg32">+      docker_tags:</span>
<span class="term-fg32">+        description: Docker image tags as csv</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+      registry:</span>
<span class="term-fg32">+        description: Docker registry</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;us-docker.pkg.dev&quot;</span>
<span class="term-fg32">+      repo:</span>
<span class="term-fg32">+        description: Docker repo</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;oplabs-tools-artifacts&#47;images&quot;</span>
<span class="term-fg32">+      push_tags:</span>
<span class="term-fg32">+        description: Push release push tags</span>
<span class="term-fg32">+        type: boolean</span>
<span class="term-fg32">+        default: false</span>
<span class="term-fg32">+    machine:</span>
<span class="term-fg32">+      image: ubuntu-2204:2022.07.1</span>
<span class="term-fg32">+      resource_class: xlarge</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - gcp-cli&#47;install</span>
<span class="term-fg32">+      - gcp-oidc-authenticate</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: Configure Docker</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            gcloud auth configure-docker &lt;&lt;parameters.registry&gt;&gt;</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: Build and push</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            RAW_TAGS=&quot;&lt;&lt;parameters.docker_tags&gt;&gt;&quot;</span>
<span class="term-fg32">+            if [ &quot;$CIRCLE_BRANCH&quot; = &quot;optimism&quot; ]; then</span>
<span class="term-fg32">+              RAW_TAGS=&quot;$RAW_TAGS,optimism&quot;</span>
<span class="term-fg32">+            fi</span>
<span class="term-fg32">+            IMAGE_BASE=&quot;&lt;&lt;parameters.registry&gt;&gt;&#47;&lt;&lt;parameters.repo&gt;&gt;&#47;&lt;&lt;parameters.docker_name&gt;&gt;&quot;</span>
<span class="term-fg32">+            DOCKER_TAGS=$(echo -ne &quot;$RAW_TAGS&quot; | sed &quot;s&#47;,&#47;\n&#47;g&quot; | sed &quot;s&#47;[^a-zA-Z0-9\n.]&#47;-&#47;g&quot; | sed -e &quot;s|^|-t ${IMAGE_BASE}:|&quot;)</span>
<span class="term-fg32">+            docker context create buildx-build</span>
<span class="term-fg32">+            docker buildx create --use buildx-build</span>
<span class="term-fg32">+            docker buildx build --push \</span>
<span class="term-fg32">+              $(echo -ne $DOCKER_TAGS | tr &#39;\n&#39; &#39; &#39;) \</span>
<span class="term-fg32">+              --platform=linux&#47;arm64,linux&#47;amd64 \</span>
<span class="term-fg32">+              --build-arg VERSION=$CIRCLE_TAG \</span>
<span class="term-fg32">+              --build-arg COMMIT=$CIRCLE_SHA \</span>
<span class="term-fg32">+              --build-arg BUILDNUM=$CIRCLE_BUILD_NUM \</span>
<span class="term-fg32">+              --progress plain \</span>
<span class="term-fg32">+              -f Dockerfile .</span>
<span class="term-fg32">+      - when:</span>
<span class="term-fg32">+          condition:</span>
<span class="term-fg32">+            equal: [ true, &lt;&lt;parameters.push_tags&gt;&gt; ]</span>
<span class="term-fg32">+          steps:</span>
<span class="term-fg32">+            - run:</span>
<span class="term-fg32">+                name: Tag</span>
<span class="term-fg32">+                command: |</span>
<span class="term-fg32">+                  .&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh &lt;&lt;parameters.registry&gt;&gt;&#47;&lt;&lt;parameters.repo&gt;&gt; $CIRCLE_TAG $CIRCLE_SHA1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+  build-geth:</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.19</span>
<span class="term-fg32">+    resource_class: xlarge</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go install</span>
<span class="term-fg32">+  unit-test:</span>
<span class="term-fg32">+    resource_class: xlarge</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.19</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go test</span>
<span class="term-fg32">+  lint-geth:</span>
<span class="term-fg32">+    resource_class: medium</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.19</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go lint</span>
<span class="term-fg32">+  check-releases:</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.19</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: .circleci&#47;check-releases.sh</span>
<span class="term-fg32">+      - slack&#47;notify:</span>
<span class="term-fg32">+          channel: C03N11M0BBN</span>
<span class="term-fg32">+          branch_pattern: optimism</span>
<span class="term-fg32">+          event: fail</span>
<span class="term-fg32">+          template: basic_fail_1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+workflows:</span>
<span class="term-fg32">+  main:</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - build-geth:</span>
<span class="term-fg32">+          name: Build geth</span>
<span class="term-fg32">+      - unit-test:</span>
<span class="term-fg32">+          name: Run unit tests for geth</span>
<span class="term-fg32">+      - lint-geth:</span>
<span class="term-fg32">+          name: Run linter over geth</span>
<span class="term-fg32">+      - docker-release:</span>
<span class="term-fg32">+          name: Push to Docker</span>
<span class="term-fg32">+          docker_tags: &lt;&lt;pipeline.git.revision&gt;&gt;</span>
<span class="term-fg32">+          context:</span>
<span class="term-fg32">+            - oplabs-gcr</span>
<span class="term-fg32">+  release:</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - hold:</span>
<span class="term-fg32">+          type: approval</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            tags:</span>
<span class="term-fg32">+              only: &#47;^v.*&#47;</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              ignore: &#47;.*&#47;</span>
<span class="term-fg32">+      - docker-release:</span>
<span class="term-fg32">+          name: Push to Docker (release)</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            tags:</span>
<span class="term-fg32">+              only: &#47;^v.*&#47;</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              ignore: &#47;.*&#47;</span>
<span class="term-fg32">+          docker_tags: &lt;&lt;pipeline.git.revision&gt;&gt;,&lt;&lt;pipeline.git.tag&gt;&gt;</span>
<span class="term-fg32">+          push_tags: true</span>
<span class="term-fg32">+          context:</span>
<span class="term-fg32">+            - oplabs-gcr-release</span>
<span class="term-fg32">+          requires:</span>
<span class="term-fg32">+            - hold</span>
<span class="term-fg32">+  scheduled:</span>
<span class="term-fg32">+    triggers:</span>
<span class="term-fg32">+      - schedule:</span>
<span class="term-fg32">+          # run daily</span>
<span class="term-fg32">+          cron: &quot;0 0 * * *&quot;</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              only: [ &quot;optimism&quot; ]</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - check-releases:</span>
<span class="term-fg32">+          name: Check for new upstream releases</span>
<span class="term-fg32">+          context: slack</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-dfdae19c9ee68ddd7467bbd1" role="button"
                   aria-expanded="false" aria-controls="id-dfdae19c9ee68ddd7467bbd1">
                    <code>.github/workflows/pages.yaml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/.github/workflows/pages.yaml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+36</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-dfdae19c9ee68ddd7467bbd1"><span class="term-fg1">diff --git go-ethereum&#47;.github&#47;workflows&#47;pages.yaml op-geth&#47;.github&#47;workflows&#47;pages.yaml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..6973b227ce779be6138ee2084e71bb5a5cdd57de</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.github&#47;workflows&#47;pages.yaml</span>
<span class="term-fg36">@@ -0,0 +1,36 @@</span>
<span class="term-fg32">+name: Build and publish forkdiff github-pages</span>
<span class="term-fg32">+permissions:</span>
<span class="term-fg32">+  contents: write</span>
<span class="term-fg32">+on:</span>
<span class="term-fg32">+  push:</span>
<span class="term-fg32">+    branches:</span>
<span class="term-fg32">+      - optimism</span>
<span class="term-fg32">+jobs:</span>
<span class="term-fg32">+  deploy:</span>
<span class="term-fg32">+    concurrency: ci-${{ github.ref }}</span>
<span class="term-fg32">+    runs-on: ubuntu-latest</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - name: Checkout</span>
<span class="term-fg32">+        uses: actions&#47;checkout@v3</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          fetch-depth: 1000  # make sure to fetch the old commit we diff against</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Build forkdiff</span>
<span class="term-fg32">+        uses: &quot;docker:&#47;&#47;protolambda&#47;forkdiff:latest&quot;</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          args: -repo=&#47;github&#47;workspace -fork=&#47;github&#47;workspace&#47;fork.yaml -out=&#47;github&#47;workspace&#47;index.html</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Build pages</span>
<span class="term-fg32">+        run: |</span>
<span class="term-fg32">+          mkdir -p tmp&#47;pages</span>
<span class="term-fg32">+          mv index.html tmp&#47;pages&#47;index.html</span>
<span class="term-fg32">+          touch tmp&#47;pages&#47;.nojekyll</span>
<span class="term-fg32">+          if [ &quot;$GITHUB_REPOSITORY&quot; == &quot;ethereum-optimism&#47;op-geth&quot; ]; then</span>
<span class="term-fg32">+              echo &quot;op-geth.optimism.io&quot; &gt; tmp&#47;pages&#47;CNAME</span>
<span class="term-fg32">+          fi;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Deploy</span>
<span class="term-fg32">+        uses: JamesIves&#47;github-pages-deploy-action@v4</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          folder: tmp&#47;pages</span>
<span class="term-fg32">+          clean: true</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-902a28cf69af001e14798866" role="button"
                   aria-expanded="false" aria-controls="id-902a28cf69af001e14798866">
                    <code>fork.yaml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/fork.yaml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+203</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-902a28cf69af001e14798866"><span class="term-fg1">diff --git go-ethereum&#47;fork.yaml op-geth&#47;fork.yaml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..061e8fd7c71840a05e60b911fb5dbe548a1839fb</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;fork.yaml</span>
<span class="term-fg36">@@ -0,0 +1,203 @@</span>
<span class="term-fg32">+title: &quot;op-geth - go-ethereum fork diff overview&quot;</span>
<span class="term-fg32">+footer: |</span>
<span class="term-fg32">+  Fork-diff overview of [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth), a fork of [`go-ethereum`](https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum).</span>
<span class="term-fg32">+  and execution-engine of the [OP-stack](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism).</span>
<span class="term-fg32">+base:</span>
<span class="term-fg32">+  name: go-ethereum</span>
<span class="term-fg32">+  url: https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum</span>
<span class="term-fg32">+  hash: e501b3b05db8e169f67dc78b7b59bc352b3c638d</span>
<span class="term-fg32">+fork:</span>
<span class="term-fg32">+  name: op-geth</span>
<span class="term-fg32">+  url: https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth</span>
<span class="term-fg32">+  ref: refs&#47;heads&#47;optimism</span>
<span class="term-fg32">+def:</span>
<span class="term-fg32">+  title: &quot;op-geth&quot;</span>
<span class="term-fg32">+  description: |</span>
<span class="term-fg32">+    This is an overview of the changes in [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth),</span>
<span class="term-fg32">+    a fork of [`go-ethereum`](https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum), part of the OP-stack.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    The OP-stack architecture is modular, following the Consensus&#47;Execution split of post-Merge Ethereum L1:</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - [`op-node`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;tree&#47;develop&#47;op-node) implements most rollup-specific functionality as Consensus-Layer, similar to a L1 beacon-node. </span>
<span class="term-fg32">+      - [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth) implements the Execution-Layer, with **minimal changes** for a secure Ethereum-equivalent application environment.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    Related [op-stack specifications](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;tree&#47;develop&#47;specs):</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    - [L2 Execution Engine spec](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;exec-engine.md)</span>
<span class="term-fg32">+    - [Deposit Transaction spec](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;deposits.md)</span>
<span class="term-fg32">+  sub:</span>
<span class="term-fg32">+    - title: &quot;Core modifications&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;State-transition modifications&quot;</span>
<span class="term-fg32">+          description: &quot;&quot;</span>
<span class="term-fg32">+          sub:</span>
<span class="term-fg32">+            - title: &quot;Deposit Transaction type&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The Bedrock upgrade introduces a `Deposit` transaction-type (`0x7E`) to enable both users and the</span>
<span class="term-fg32">+                rollup system itself to change the L2 state based on L1 events and system rules as</span>
<span class="term-fg32">+                [specified](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;deposits.md).</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;deposit_tx.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction_marshalling.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction_signing.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Transaction properties&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The `Transaction` type now exposes the deposit-transaction and L1-cost properties required for the rollup.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_access_list.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_dynamic_fee.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_legacy.go&quot;</span>
<span class="term-fg32">+            - title: &quot;L1 cost computation&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Transactions must pay an additional L1 cost based on the amount of rollup-data-gas they consume,</span>
<span class="term-fg32">+                estimated based on gas-price-oracle information and encoded tx size.&quot;</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;vm&#47;evm.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;rollup_l1_cost.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;state_processor.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;state_prefetcher.go&quot;</span>
<span class="term-fg32">+            - title: Transaction processing</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Deposit transactions have special processing rules: gas is pre-paid on L1,</span>
<span class="term-fg32">+                and deposits with EVM-failure are included with rolled back changes (except mint).</span>
<span class="term-fg32">+                For regular transactions, at the end of the transition, the 1559 burn and L1 cost are routed to vaults.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;state_transition.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Gaslimit&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The gaslimit is free to be set by the Engine API caller, instead of enforcing adjustments of the</span>
<span class="term-fg32">+                gaslimit in increments of 1&#47;1024 of the previous gaslimit.</span>
<span class="term-fg32">+                The gaslimit is changed (and limited) through the `SystemConfig` contract.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;misc&#47;eip1559.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Consensus tweaks&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The Engine API is activated at the Merge transition, with a Total Terminal Difficulty (TTD).</span>
<span class="term-fg32">+                The rollup starts post-merge, and thus sets the TTD to 0.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;beacon&#47;consensus.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Chain config&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The rollup functionality is enabled with the `optimism` field in the chain config.</span>
<span class="term-fg32">+            The EIP-1559 parameters are configurable to adjust for faster more frequent and smaller blocks.</span>
<span class="term-fg32">+            The parameters can be overriden for testing.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;params&#47;config.go&quot;</span>
<span class="term-fg32">+            - &quot;params&#47;protocol_params.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;genesis.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Chain config cleanup&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The optimism Goerli testnet used clique-config data to make geth internals accept blocks.</span>
<span class="term-fg32">+            Post-bedrock the beacon-consensus (i.e. follow Engine API) is now used, and the clique config is removed.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;rawdb&#47;accessors_metadata.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Engine API modifications&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The Engine API is extended to insert transactions into the block and optionally exclude the tx-pool,</span>
<span class="term-fg32">+            to reproduce the exact block of the sequencer from just the inputs, as derived from L1 by the rollup-node.</span>
<span class="term-fg32">+            See [L2 execution engine specs](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;exec-engine.md).</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;beacon&#47;engine&#47;types.go&quot;</span>
<span class="term-fg32">+            - &quot;beacon&#47;engine&#47;gen_blockparams.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;catalyst&#47;api.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Block-building modifications&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The block-building code (in the &quot;miner&quot; package because of Proof-Of-Work legacy of ethereum) implements the</span>
<span class="term-fg32">+            changes to support the transaction-inclusion, tx-pool toggle and gaslimit parameters of the Engine API.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;miner&#47;*&quot;</span>
<span class="term-fg32">+        - title: &quot;Tx-pool tx cost updates&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Transaction queueing and inclusion needs to account for the L1 cost component.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;txpool&#47;*&quot;</span>
<span class="term-fg32">+    - title: &quot;Node modifications&quot;</span>
<span class="term-fg32">+      description: Changes to the node configuration and services.</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;CLI&quot;</span>
<span class="term-fg32">+          sub:</span>
<span class="term-fg32">+            - title: &quot;Flags&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Flag changes:</span>
<span class="term-fg32">+                  - Transactions can be forwarded to an RPC for sequencing.</span>
<span class="term-fg32">+                  - Historical calls can be forwarded to a legacy node.</span>
<span class="term-fg32">+                  - The tx pool propagation can be enabled&#47;disabled.</span>
<span class="term-fg32">+                  - The Optimism bedrock fork activation can be changed for testing.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;cmd&#47;utils&#47;flags.go&quot;</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;main.go&quot;</span>
<span class="term-fg32">+                - &quot;internal&#47;flags&#47;categories.go&quot;</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;config.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Versioning&quot;</span>
<span class="term-fg32">+              description: List the op-geth and upstream go-ethereum versions.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;misccmd.go&quot;</span>
<span class="term-fg32">+                - &quot;params&#47;version.go&quot;</span>
<span class="term-fg32">+                - &quot;build&#47;ci.go&quot;</span>
<span class="term-fg32">+        - title: Node config</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;ethconfig&#47;config.go&quot;</span>
<span class="term-fg32">+        - title: Tx gossip disable option</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;handler.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;handler_eth.go&quot;</span>
<span class="term-fg32">+    - title: &quot;User API enhancements&quot;</span>
<span class="term-fg32">+      description: &quot;Encode the Deposit Tx properties, the L1 costs, and daisy-chain RPC-calls for pre-Bedrock historical data&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;Receipts metadata&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Pre-Bedrock L1-cost receipt data is loaded from the database if available, and post-Bedrock the L1-cost </span>
<span class="term-fg32">+            metadata is hydrated on-the-fly based on the L1 fee information in the corresponding block.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;receipt.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;gen_receipt_json.go&quot;</span>
<span class="term-fg32">+        - title: &quot;API Backend&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Forward transactions to the sequencer if configured.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;api_backend.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;backend.go&quot;</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;backend.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Apply L1 cost in API responses&quot;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;state_accessor.go&quot;</span>
<span class="term-fg32">+        - title: API frontend</span>
<span class="term-fg32">+          description: Format deposit and L1-cost data in transaction responses. Add `debug_chainConfig` API.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;api.go&quot;</span>
<span class="term-fg32">+            - &quot;rpc&#47;errors.go&quot;</span>
<span class="term-fg32">+        - title: Tracer RPC daisy-chain</span>
<span class="term-fg32">+          description: Forward pre-bedrock tracing calls to legacy node.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;tracers&#47;api.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Light Ethereum Subprotocol (LES) RPC&quot;</span>
<span class="term-fg32">+          description: Match the RPC changes in the LES RPC</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;les&#47;*&quot;</span>
<span class="term-fg32">+        - title: &quot;Daisy Chain tests&quot;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;transaction_args_test.go&quot;</span>
<span class="term-fg32">+            - &quot;ethclient&#47;ethclient_test.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;tracers&#47;api_test.go&quot;</span>
<span class="term-fg32">+    - title: &quot;Geth extras&quot;</span>
<span class="term-fg32">+      description: Extend the tools available in geth to improve external testing and tooling.</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: Simulated Backend</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go&quot;</span>
<span class="term-fg32">+        - title: diff-included testing testing</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Most of the op-geth changes are tested in the Optimism Monorepo and not part of the geth diff,</span>
<span class="term-fg32">+            but some testing like the Deposit TX encoding and API interactions are embedded in the op-geth diff instead.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;transaction_marshalling_test.go&quot;</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;api_test.go&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+# ignored globally, does not count towards line count</span>
<span class="term-fg32">+ignore:</span>
<span class="term-fg32">+  - &quot;.circleci&#47;*&quot;</span>
<span class="term-fg32">+  - &quot;*.sum&quot;</span>
<span class="term-fg32">+  - &quot;go.mod&quot;</span>
<span class="term-fg32">+  - &quot;fork.yaml&quot;</span>
<span class="term-fg32">+  - &quot;.github&#47;workflows&#47;*&quot;</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-12792908b59bc7221568ab34" role="button"
                   aria-expanded="false" aria-controls="id-12792908b59bc7221568ab34">
                    <code>go.mod</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/go.mod" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/go.mod" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-12792908b59bc7221568ab34"><span class="term-fg1">diff --git go-ethereum&#47;go.mod op-geth&#47;go.mod</span>
<span class="term-fg1">index ef4ea6ee74086e53704b77facbeb8642416051bd..22d85d04083e34c00f2290410b2f9c57d3764693 100644</span>
<span class="term-fg1">--- go-ethereum&#47;go.mod</span>
<span class="term-fg1">+++ op-geth&#47;go.mod</span>
<span class="term-fg36">@@ -19,6 +19,7 @@</span> 	github.com&#47;davecgh&#47;go-spew v1.1.1
 	github.com&#47;deckarep&#47;golang-set&#47;v2 v2.1.0
 	github.com&#47;docker&#47;docker v1.6.2
 	github.com&#47;dop251&#47;goja v0.0.0-20230122112309-96b1610dd4f7
<span class="term-fg32">+	github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20230817174831-5d3ca1966435</span>
 	github.com&#47;ethereum&#47;c-kzg-4844 v0.2.0
 	github.com&#47;fatih&#47;color v1.7.0
 	github.com&#47;fjl&#47;gencodec v0.0.0-20230517082657-f9840df7b83e
<span class="term-fg36">@@ -119,6 +120,7 @@</span> 	github.com&#47;prometheus&#47;common v0.39.0 &#47;&#47; indirect
 	github.com&#47;prometheus&#47;procfs v0.9.0 &#47;&#47; indirect
 	github.com&#47;rogpeppe&#47;go-internal v1.9.0 &#47;&#47; indirect
 	github.com&#47;russross&#47;blackfriday&#47;v2 v2.1.0 &#47;&#47; indirect
<span class="term-fg32">+	github.com&#47;stretchr&#47;objx v0.5.0 &#47;&#47; indirect</span>
 	github.com&#47;tklauser&#47;go-sysconf v0.3.5 &#47;&#47; indirect
 	github.com&#47;tklauser&#47;numcpus v0.2.2 &#47;&#47; indirect
 	github.com&#47;xrash&#47;smetrics v0.0.0-20201216005158-039620a65673 &#47;&#47; indirect</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f78e973d9ec7ce024c841fe5" role="button"
                   aria-expanded="false" aria-controls="id-f78e973d9ec7ce024c841fe5">
                    <code>go.sum</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/e501b3b05db8e169f67dc78b7b59bc352b3c638d/go.sum" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/a87a03ee14249975461810c53f7294275f4017b0/go.sum" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f78e973d9ec7ce024c841fe5"><span class="term-fg1">diff --git go-ethereum&#47;go.sum op-geth&#47;go.sum</span>
<span class="term-fg1">index e02153096313fb634fac20c9488426d5f894e8f4..54d75d3b8ba3f3d2cbb42e5ae12d56aeaba6e51b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;go.sum</span>
<span class="term-fg1">+++ op-geth&#47;go.sum</span>
<span class="term-fg36">@@ -122,6 +122,8 @@</span> github.com&#47;envoyproxy&#47;go-control-plane v0.9.1-0.20191026205805-5f8ba28d4473&#47;go.mod h1:YTl&#47;9mNaCwkRvm6d1a2C3ymFceY&#47;DCBVvsKhRF0iEA4=
 github.com&#47;envoyproxy&#47;go-control-plane v0.9.9-0.20210217033140-668b12f5399d&#47;go.mod h1:cXg6YxExXjJnVBQHBLXeUAgxn2UodCpnH306RInaBQk=
 github.com&#47;envoyproxy&#47;protoc-gen-validate v0.1.0&#47;go.mod h1:iSmxcyjqTsJpI2R4NaDN7+kN2VEUnK&#47;pcBlmesArF7c=
 github.com&#47;etcd-io&#47;bbolt v1.3.3&#47;go.mod h1:ZF2nL25h33cCyBtcyWeZ2&#47;I3HQOfTP+0PIEvHjkjCrw=
<span class="term-fg32">+github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20230817174831-5d3ca1966435 h1:2CzkJkkTLuVyoVFkoW5w6vDB2Q7eJzxXw&#47;ybA17xjqM=</span>
<span class="term-fg32">+github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20230817174831-5d3ca1966435&#47;go.mod h1:v2YpePbdGBF0Gr6VWq49MFFmcTW0kRYZ2ingBJYWEwg=</span>
 github.com&#47;ethereum&#47;c-kzg-4844 v0.2.0 h1:+cUvymlnoDDQgMInp25Bo3OmLajmmY8mLJ&#47;tLjqd77Q=
 github.com&#47;ethereum&#47;c-kzg-4844 v0.2.0&#47;go.mod h1:WI2Nd82DMZAAZI1wV2neKGost9EKjvbpQR9OqE5Qqa8=
 github.com&#47;fasthttp-contrib&#47;websocket v0.0.0-20160511215533-1f3b11f56072&#47;go.mod h1:duJ4Jxv5lDcvg4QuQr0oowTf7dz4&#47;CR8NtyCooz9HL8=
<span class="term-fg36">@@ -407,6 +409,7 @@</span> github.com&#47;status-im&#47;keycard-go v0.2.0 h1:QDLFswOQu1r5jsycloeQh3bVU8n&#47;NatHHaZobtDnDzA=
 github.com&#47;status-im&#47;keycard-go v0.2.0&#47;go.mod h1:wlp8ZLbsmrF6g6WjugPAx+IzoLrkdf9+mHxBEeo3Hbg=
 github.com&#47;stretchr&#47;objx v0.1.0&#47;go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
 github.com&#47;stretchr&#47;objx v0.4.0&#47;go.mod h1:YvHI0jy2hoMjB+UWwv71VJQ9isScKT&#47;TqJzVSSt89Yw=
<span class="term-fg32">+github.com&#47;stretchr&#47;objx v0.5.0 h1:1zr&#47;of2m5FGMsad5YfcqgdqdWrIhu+EBEJRhR1U7z&#47;c=</span>
 github.com&#47;stretchr&#47;objx v0.5.0&#47;go.mod h1:Yh+to48EsGEfYuaHDzXPcE3xhTkx73EhmCGUpEOglKo=
 github.com&#47;stretchr&#47;testify v1.2.2&#47;go.mod h1:a8OnRcib4nhh0OaRAV+Yts87kKdq0PP7pXfy6kDkUVs=
 github.com&#47;stretchr&#47;testify v1.3.0&#47;go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

                    </div>
                
            </div>
        </main>
    </div>

    <footer class="col-xl-10 col-xxl-8 mx-auto px-3 pt-5 my-5 text-muted border-top">
        <p>Fork-diff overview of <a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a>, a fork of <a href="https://github.com/ethereum/go-ethereum"><code>go-ethereum</code></a>.
and execution-engine of the <a href="https://github.com/ethereum-optimism/optimism">OP-stack</a>.</p>

    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const storedTheme = localStorage.getItem('theme')

        // Get the preferred theme from the user's OS
        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme
            }

            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        // Set the bootstrap theme
        const setTheme = function (theme) {
            document.documentElement.setAttribute('data-bs-theme', theme)
            if (theme === 'dark') {
                document.getElementById('dark-mode-toggle').setAttribute('checked', true)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-high-fill', 'bi-brightness-low')
            } else {
                document.getElementById('dark-mode-toggle').setAttribute('checked', false)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-low', 'bi-brightness-high-fill')
            }
        }

        // Returns true if the current theme is dark
        const isDark = () => {
            return document.documentElement.getAttribute('data-bs-theme') === 'dark'
        }

        // Toggles dark mode
        const toggleDarkMode = () => {
            const newTheme = isDark() ? 'light' : 'dark'
            setTheme(newTheme)
            localStorage.setItem('theme', newTheme)
        }

        // Set the preferred theme on page load
        window.onload = () => {
            // Set preferred theme
            setTheme(getPreferredTheme());
            // Initialize tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }

        // Toggle dark mode when the toggle button is clicked
        addEventListener("click", (event) => {
            if (event.target.id === 'dark-mode-toggle') {
                toggleDarkMode();
                // De-focus the toggle
                document.activeElement.blur()
            }
        });
    </script>
</body>
</html>
