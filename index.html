<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">

    <title>op-geth - go-ethereum fork diff overview</title>

    <style>
        .line-stat {
            width: 14rem;
            float: right;
        }
        .line-stat div {
            width: 50%;
        }
    </style>

    
<style>
    .term-container {
        background: #171717;
        border-radius: 5px;
        color: white;
        word-break: break-word;
        overflow-wrap: break-word;
        font-family: "SFMono-Regular", Monaco, Menlo, Consolas, "Liberation Mono", Courier, monospace;
        font-size: 12px;
        line-height: 20px;
        padding: 14px 18px;
        white-space: pre-wrap;
    }

    .term-container img { max-width: 100%; }

    .term a { color: inherit; text-decoration: underline; text-decoration-style: dashed; }
    .term a:hover { color: #2882F9 }

    @keyframes blink-animation {
        to {
            visibility: hidden;
        }
    }

    .term-fg1 { } /* don't bold beccause it looks weird */
    .term-fg2 { color: #838887; } /* faint (decreased intensity) - same as gray really */
    .term-fg3 { font-style: italic; } /* italic */
    .term-fg4 { text-decoration: underline; } /* underline */
    .term-fg5 { animation: blink-animation 1s steps(3, start) infinite; } /* blink */
    .term-fg9 { text-decoration: line-through; } /* crossed-out */

    .term-fg30 { color: #666666; } /* black (but we can't use black, so a diff color) */
    .term-fg31 { color: #ff7070; } /* red */
    .term-fg32 { color: #b0f986; } /* green */
    .term-fg33 { color: #c6c502; } /* yellow */
    .term-fg34 { color: #8db7e0; } /* blue */
    .term-fg35 { color: #f271fb; } /* magenta */
    .term-fg36 { color: #6bf7ff; } /* cyan */

    /* high intense colors */
    .term-fgi1 { color: #5ef765; }
    .term-fgi90 { color: #838887; } /* grey */
    .term-fgi91 { color: #ff3333; } /* red */
    .term-fgi92 { color: #00FF00; } /* green */
    .term-fgi93 { color: #fffc67; } /* yellow */
    .term-fgi94 { color: #6871ff; } /* blue */
    .term-fgi95 { color: #ff76ff; } /* magenta */
    .term-fgi96 { color: #60fcff; } /* cyan */

    /* background colors */
    .term-bg40 { background: #676767; } /* grey */
    .term-bg41 { background: #ff4343; } /* red */
    .term-bg42 { background: #99ff5f; } /* green */

    /* custom foreground/background combos for readability */
    .term-fg31.term-bg40 { color: #F8A39F; }

    /* xterm colors */
    .term-fgx16 { color: #000000; }
    .term-fgx17 { color: #00005f; }
    .term-fgx18 { color: #000087; }
    .term-fgx19 { color: #0000af; }
    .term-fgx20 { color: #0000d7; }
    .term-fgx21 { color: #0000ff; }
    .term-fgx22 { color: #005f00; }
    .term-fgx23 { color: #005f5f; }
    .term-fgx24 { color: #005f87; }
    .term-fgx25 { color: #005faf; }
    .term-fgx26 { color: #005fd7; }
    .term-fgx27 { color: #005fff; }
    .term-fgx28 { color: #008700; }
    .term-fgx29 { color: #00875f; }
    .term-fgx30 { color: #008787; }
    .term-fgx31 { color: #0087af; }
    .term-fgx32 { color: #0087d7; }
    .term-fgx33 { color: #0087ff; }
    .term-fgx34 { color: #00af00; }
    .term-fgx35 { color: #00af5f; }
    .term-fgx36 { color: #00af87; }
    .term-fgx37 { color: #00afaf; }
    .term-fgx38 { color: #00afd7; }
    .term-fgx39 { color: #00afff; }
    .term-fgx40 { color: #00d700; }
    .term-fgx41 { color: #00d75f; }
    .term-fgx42 { color: #00d787; }
    .term-fgx43 { color: #00d7af; }
    .term-fgx44 { color: #00d7d7; }
    .term-fgx45 { color: #00d7ff; }
    .term-fgx46 { color: #00ff00; }
    .term-fgx47 { color: #00ff5f; }
    .term-fgx48 { color: #00ff87; }
    .term-fgx49 { color: #00ffaf; }
    .term-fgx50 { color: #00ffd7; }
    .term-fgx51 { color: #00ffff; }
    .term-fgx52 { color: #5f0000; }
    .term-fgx53 { color: #5f005f; }
    .term-fgx54 { color: #5f0087; }
    .term-fgx55 { color: #5f00af; }
    .term-fgx56 { color: #5f00d7; }
    .term-fgx57 { color: #5f00ff; }
    .term-fgx58 { color: #5f5f00; }
    .term-fgx59 { color: #5f5f5f; }
    .term-fgx60 { color: #5f5f87; }
    .term-fgx61 { color: #5f5faf; }
    .term-fgx62 { color: #5f5fd7; }
    .term-fgx63 { color: #5f5fff; }
    .term-fgx64 { color: #5f8700; }
    .term-fgx65 { color: #5f875f; }
    .term-fgx66 { color: #5f8787; }
    .term-fgx67 { color: #5f87af; }
    .term-fgx68 { color: #5f87d7; }
    .term-fgx69 { color: #5f87ff; }
    .term-fgx70 { color: #5faf00; }
    .term-fgx71 { color: #5faf5f; }
    .term-fgx72 { color: #5faf87; }
    .term-fgx73 { color: #5fafaf; }
    .term-fgx74 { color: #5fafd7; }
    .term-fgx75 { color: #5fafff; }
    .term-fgx76 { color: #5fd700; }
    .term-fgx77 { color: #5fd75f; }
    .term-fgx78 { color: #5fd787; }
    .term-fgx79 { color: #5fd7af; }
    .term-fgx80 { color: #5fd7d7; }
    .term-fgx81 { color: #5fd7ff; }
    .term-fgx82 { color: #5fff00; }
    .term-fgx83 { color: #5fff5f; }
    .term-fgx84 { color: #5fff87; }
    .term-fgx85 { color: #5fffaf; }
    .term-fgx86 { color: #5fffd7; }
    .term-fgx87 { color: #5fffff; }
    .term-fgx88 { color: #870000; }
    .term-fgx89 { color: #87005f; }
    .term-fgx90 { color: #870087; }
    .term-fgx91 { color: #8700af; }
    .term-fgx92 { color: #8700d7; }
    .term-fgx93 { color: #8700ff; }
    .term-fgx94 { color: #875f00; }
    .term-fgx95 { color: #875f5f; }
    .term-fgx96 { color: #875f87; }
    .term-fgx97 { color: #875faf; }
    .term-fgx98 { color: #875fd7; }
    .term-fgx99 { color: #875fff; }
    .term-fgx100 { color: #878700; }
    .term-fgx101 { color: #87875f; }
    .term-fgx102 { color: #878787; }
    .term-fgx103 { color: #8787af; }
    .term-fgx104 { color: #8787d7; }
    .term-fgx105 { color: #8787ff; }
    .term-fgx106 { color: #87af00; }
    .term-fgx107 { color: #87af5f; }
    .term-fgx108 { color: #87af87; }
    .term-fgx109 { color: #87afaf; }
    .term-fgx110 { color: #87afd7; }
    .term-fgx111 { color: #87afff; }
    .term-fgx112 { color: #87d700; }
    .term-fgx113 { color: #87d75f; }
    .term-fgx114 { color: #87d787; }
    .term-fgx115 { color: #87d7af; }
    .term-fgx116 { color: #87d7d7; }
    .term-fgx117 { color: #87d7ff; }
    .term-fgx118 { color: #87ff00; }
    .term-fgx119 { color: #87ff5f; }
    .term-fgx120 { color: #87ff87; }
    .term-fgx121 { color: #87ffaf; }
    .term-fgx122 { color: #87ffd7; }
    .term-fgx123 { color: #87ffff; }
    .term-fgx124 { color: #af0000; }
    .term-fgx125 { color: #af005f; }
    .term-fgx126 { color: #af0087; }
    .term-fgx127 { color: #af00af; }
    .term-fgx128 { color: #af00d7; }
    .term-fgx129 { color: #af00ff; }
    .term-fgx130 { color: #af5f00; }
    .term-fgx131 { color: #af5f5f; }
    .term-fgx132 { color: #af5f87; }
    .term-fgx133 { color: #af5faf; }
    .term-fgx134 { color: #af5fd7; }
    .term-fgx135 { color: #af5fff; }
    .term-fgx136 { color: #af8700; }
    .term-fgx137 { color: #af875f; }
    .term-fgx138 { color: #af8787; }
    .term-fgx139 { color: #af87af; }
    .term-fgx140 { color: #af87d7; }
    .term-fgx141 { color: #af87ff; }
    .term-fgx142 { color: #afaf00; }
    .term-fgx143 { color: #afaf5f; }
    .term-fgx144 { color: #afaf87; }
    .term-fgx145 { color: #afafaf; }
    .term-fgx146 { color: #afafd7; }
    .term-fgx147 { color: #afafff; }
    .term-fgx148 { color: #afd700; }
    .term-fgx149 { color: #afd75f; }
    .term-fgx150 { color: #afd787; }
    .term-fgx151 { color: #afd7af; }
    .term-fgx152 { color: #afd7d7; }
    .term-fgx153 { color: #afd7ff; }
    .term-fgx154 { color: #afff00; }
    .term-fgx155 { color: #afff5f; }
    .term-fgx156 { color: #afff87; }
    .term-fgx157 { color: #afffaf; }
    .term-fgx158 { color: #afffd7; }
    .term-fgx159 { color: #afffff; }
    .term-fgx160 { color: #d70000; }
    .term-fgx161 { color: #d7005f; }
    .term-fgx162 { color: #d70087; }
    .term-fgx163 { color: #d700af; }
    .term-fgx164 { color: #d700d7; }
    .term-fgx165 { color: #d700ff; }
    .term-fgx166 { color: #d75f00; }
    .term-fgx167 { color: #d75f5f; }
    .term-fgx168 { color: #d75f87; }
    .term-fgx169 { color: #d75faf; }
    .term-fgx170 { color: #d75fd7; }
    .term-fgx171 { color: #d75fff; }
    .term-fgx172 { color: #d78700; }
    .term-fgx173 { color: #d7875f; }
    .term-fgx174 { color: #d78787; }
    .term-fgx175 { color: #d787af; }
    .term-fgx176 { color: #d787d7; }
    .term-fgx177 { color: #d787ff; }
    .term-fgx178 { color: #d7af00; }
    .term-fgx179 { color: #d7af5f; }
    .term-fgx180 { color: #d7af87; }
    .term-fgx181 { color: #d7afaf; }
    .term-fgx182 { color: #d7afd7; }
    .term-fgx183 { color: #d7afff; }
    .term-fgx184 { color: #d7d700; }
    .term-fgx185 { color: #d7d75f; }
    .term-fgx186 { color: #d7d787; }
    .term-fgx187 { color: #d7d7af; }
    .term-fgx188 { color: #d7d7d7; }
    .term-fgx189 { color: #d7d7ff; }
    .term-fgx190 { color: #d7ff00; }
    .term-fgx191 { color: #d7ff5f; }
    .term-fgx192 { color: #d7ff87; }
    .term-fgx193 { color: #d7ffaf; }
    .term-fgx194 { color: #d7ffd7; }
    .term-fgx195 { color: #d7ffff; }
    .term-fgx196 { color: #ff0000; }
    .term-fgx197 { color: #ff005f; }
    .term-fgx198 { color: #ff0087; }
    .term-fgx199 { color: #ff00af; }
    .term-fgx200 { color: #ff00d7; }
    .term-fgx201 { color: #ff00ff; }
    .term-fgx202 { color: #ff5f00; }
    .term-fgx203 { color: #ff5f5f; }
    .term-fgx204 { color: #ff5f87; }
    .term-fgx205 { color: #ff5faf; }
    .term-fgx206 { color: #ff5fd7; }
    .term-fgx207 { color: #ff5fff; }
    .term-fgx208 { color: #ff8700; }
    .term-fgx209 { color: #ff875f; }
    .term-fgx210 { color: #ff8787; }
    .term-fgx211 { color: #ff87af; }
    .term-fgx212 { color: #ff87d7; }
    .term-fgx213 { color: #ff87ff; }
    .term-fgx214 { color: #ffaf00; }
    .term-fgx215 { color: #ffaf5f; }
    .term-fgx216 { color: #ffaf87; }
    .term-fgx217 { color: #ffafaf; }
    .term-fgx218 { color: #ffafd7; }
    .term-fgx219 { color: #ffafff; }
    .term-fgx220 { color: #ffd700; }
    .term-fgx221 { color: #ffd75f; }
    .term-fgx222 { color: #ffd787; }
    .term-fgx223 { color: #ffd7af; }
    .term-fgx224 { color: #ffd7d7; }
    .term-fgx225 { color: #ffd7ff; }
    .term-fgx226 { color: #ffff00; }
    .term-fgx227 { color: #ffff5f; }
    .term-fgx228 { color: #ffff87; }
    .term-fgx229 { color: #ffffaf; }
    .term-fgx230 { color: #ffffd7; }
    .term-fgx231 { color: #ffffff; }
    .term-fgx232 { color: #080808; }
    .term-fgx233 { color: #121212; }
    .term-fgx234 { color: #1c1c1c; }
    .term-fgx235 { color: #262626; }
    .term-fgx236 { color: #303030; }
    .term-fgx237 { color: #3a3a3a; }
    .term-fgx238 { color: #444444; }
    .term-fgx239 { color: #4e4e4e; }
    .term-fgx240 { color: #585858; }
    .term-fgx241 { color: #626262; }
    .term-fgx242 { color: #6c6c6c; }
    .term-fgx243 { color: #767676; }
    .term-fgx244 { color: #808080; }
    .term-fgx245 { color: #8a8a8a; }
    .term-fgx246 { color: #949494; }
    .term-fgx247 { color: #9e9e9e; }
    .term-fgx248 { color: #a8a8a8; }
    .term-fgx249 { color: #b2b2b2; }
    .term-fgx250 { color: #bcbcbc; }
    .term-fgx251 { color: #c6c6c6; }
    .term-fgx252 { color: #d0d0d0; }
    .term-fgx253 { color: #dadada; }
    .term-fgx254 { color: #e4e4e4; }
    .term-fgx255 { color: #eeeeee; }
</style>

</head>
<body>
    <div class="col-xl-10 col-xxl-8 mx-auto px-3 py-1 py-md-3">
        <main class="container-fluid">
            <div class="row">
                <div>
                    <div class="float-end">
                        <div class="form-check form-switch">
                            <i class="bi bi-brightness-low" id="dark-mode-icon"></i>
                            <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle" data-bs-toggle="tooltip"
                                   data-bs-placement="bottom" data-bs-title="Toggle Dark Mode"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"role="button" aria-expanded="true" aria-controls="id-d3c875ac40d354a234f173ac">
        
            <div class="col-12 col-sm-9 text-start"><h1>op-geth</h1></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3737</span></div>
                <div class="text-start"><span class="text-danger">-1080</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse show border-1 ps-3 my-3" id="id-d3c875ac40d354a234f173ac">
        <div><p>This is an overview of the changes in <a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a>,
a fork of <a href="https://github.com/ethereum/go-ethereum"><code>go-ethereum</code></a>, part of the OP-stack.</p>

<p>The OP-stack architecture is modular, following the Consensus/Execution split of post-Merge Ethereum L1:</p>

<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/tree/develop/op-node"><code>op-node</code></a> implements most rollup-specific functionality as Consensus-Layer, similar to a L1 beacon-node.</li>
<li><a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a> implements the Execution-Layer, with <strong>minimal changes</strong> for a secure Ethereum-equivalent application environment.</li>
</ul>

<p>Related <a href="https://github.com/ethereum-optimism/optimism/tree/develop/specs">op-stack specifications</a>:</p>

<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md">L2 Execution Engine spec</a></li>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md">Deposit Transaction spec</a></li>
</ul>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-487de54800e7847513cb1bd6"role="button" aria-expanded="false" aria-controls="id-487de54800e7847513cb1bd6">
        
            <div class="col-12 col-sm-9 text-start"><h2>Core modifications</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+840</span></div>
                <div class="text-start"><span class="text-danger">-86</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-487de54800e7847513cb1bd6">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-a4e5306998daddcfe79caf76"role="button" aria-expanded="false" aria-controls="id-a4e5306998daddcfe79caf76">
        
            <div class="col-12 col-sm-9 text-start"><h3>State-transition modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+491</span></div>
                <div class="text-start"><span class="text-danger">-24</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-a4e5306998daddcfe79caf76">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-ab611db35fe714110bfb9556"role="button" aria-expanded="false" aria-controls="id-ab611db35fe714110bfb9556">
        
            <div class="col-12 col-sm-9 text-start"><h4>Deposit Transaction type</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+181</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-ab611db35fe714110bfb9556">
        <div><p>The Bedrock upgrade introduces a <code>Deposit</code> transaction-type (<code>0x7E</code>) to enable both users and the
rollup system itself to change the L2 state based on L1 events and system rules as
<a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md">specified</a>.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4b9a829ad610b49bb9b498e9" role="button"
                   aria-expanded="false" aria-controls="id-4b9a829ad610b49bb9b498e9">
                    <code>core/types/deposit_tx.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/deposit_tx.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+93</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4b9a829ad610b49bb9b498e9"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;deposit_tx.go op-geth&#47;core&#47;types&#47;deposit_tx.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..dc0708a0c208defb6e2c94c3428c26637094f1c3</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;deposit_tx.go</span>
<span class="term-fg36">@@ -0,0 +1,93 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2021 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const DepositTxType = 0x7E</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type DepositTx struct {</span>
<span class="term-fg32">+	&#47;&#47; SourceHash uniquely identifies the source of the deposit</span>
<span class="term-fg32">+	SourceHash common.Hash</span>
<span class="term-fg32">+	&#47;&#47; From is exposed through the types.Signer, not through TxData</span>
<span class="term-fg32">+	From common.Address</span>
<span class="term-fg32">+	&#47;&#47; nil means contract creation</span>
<span class="term-fg32">+	To *common.Address `rlp:&quot;nil&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Mint is minted on L2, locked on L1, nil if no minting.</span>
<span class="term-fg32">+	Mint *big.Int `rlp:&quot;nil&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Value is transferred from L2 balance, executed after Mint (if any)</span>
<span class="term-fg32">+	Value *big.Int</span>
<span class="term-fg32">+	&#47;&#47; gas limit</span>
<span class="term-fg32">+	Gas uint64</span>
<span class="term-fg32">+	&#47;&#47; Field indicating if this transaction is exempt from the L2 gas limit.</span>
<span class="term-fg32">+	IsSystemTransaction bool</span>
<span class="term-fg32">+	&#47;&#47; Normal Tx data</span>
<span class="term-fg32">+	Data []byte</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; copy creates a deep copy of the transaction data and initializes all fields.</span>
<span class="term-fg32">+func (tx *DepositTx) copy() TxData {</span>
<span class="term-fg32">+	cpy := &amp;DepositTx{</span>
<span class="term-fg32">+		SourceHash:          tx.SourceHash,</span>
<span class="term-fg32">+		From:                tx.From,</span>
<span class="term-fg32">+		To:                  copyAddressPtr(tx.To),</span>
<span class="term-fg32">+		Mint:                nil,</span>
<span class="term-fg32">+		Value:               new(big.Int),</span>
<span class="term-fg32">+		Gas:                 tx.Gas,</span>
<span class="term-fg32">+		IsSystemTransaction: tx.IsSystemTransaction,</span>
<span class="term-fg32">+		Data:                common.CopyBytes(tx.Data),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if tx.Mint != nil {</span>
<span class="term-fg32">+		cpy.Mint = new(big.Int).Set(tx.Mint)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if tx.Value != nil {</span>
<span class="term-fg32">+		cpy.Value.Set(tx.Value)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return cpy</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; accessors for innerTx.</span>
<span class="term-fg32">+func (tx *DepositTx) txType() byte           { return DepositTxType }</span>
<span class="term-fg32">+func (tx *DepositTx) chainID() *big.Int      { return common.Big0 }</span>
<span class="term-fg32">+func (tx *DepositTx) accessList() AccessList { return nil }</span>
<span class="term-fg32">+func (tx *DepositTx) data() []byte           { return tx.Data }</span>
<span class="term-fg32">+func (tx *DepositTx) gas() uint64            { return tx.Gas }</span>
<span class="term-fg32">+func (tx *DepositTx) gasFeeCap() *big.Int    { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) gasTipCap() *big.Int    { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) gasPrice() *big.Int     { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) value() *big.Int        { return tx.Value }</span>
<span class="term-fg32">+func (tx *DepositTx) nonce() uint64          { return 0 }</span>
<span class="term-fg32">+func (tx *DepositTx) to() *common.Address    { return tx.To }</span>
<span class="term-fg32">+func (tx *DepositTx) isSystemTx() bool       { return tx.IsSystemTransaction }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {</span>
<span class="term-fg32">+	return dst.Set(new(big.Int))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) effectiveNonce() *uint64 { return nil }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) rawSignatureValues() (v, r, s *big.Int) {</span>
<span class="term-fg32">+	return common.Big0, common.Big0, common.Big0</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) setSignatureValues(chainID, v, r, s *big.Int) {</span>
<span class="term-fg32">+	&#47;&#47; this is a noop for deposit transactions</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-797ce0b5c1bec7a1c604f955" role="button"
                   aria-expanded="false" aria-controls="id-797ce0b5c1bec7a1c604f955">
                    <code>core/types/transaction_marshalling.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/transaction_marshalling.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/transaction_marshalling.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+79</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-797ce0b5c1bec7a1c604f955"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_marshalling.go op-geth&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg1">index 2566d0b8d6566aa2953cb0456ede19af069e7d4c..dccb54ffcad6e5565a463bc911fc16824ca5e4f6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg36">@@ -19,10 +19,12 @@</span>
 import (
 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;io&quot;</span>
 	&quot;math&#47;big&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
 )
&nbsp;
 &#47;&#47; txJSON is the JSON representation of transactions.
<span class="term-fg36">@@ -41,6 +43,12 @@</span> 	V                    *hexutil.Big    `json:&quot;v&quot;`
 	R                    *hexutil.Big    `json:&quot;r&quot;`
 	S                    *hexutil.Big    `json:&quot;s&quot;`
 	To                   *common.Address `json:&quot;to&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Deposit transaction fields</span>
<span class="term-fg32">+	SourceHash *common.Hash    `json:&quot;sourceHash,omitempty&quot;`</span>
<span class="term-fg32">+	From       *common.Address `json:&quot;from,omitempty&quot;`</span>
<span class="term-fg32">+	Mint       *hexutil.Big    `json:&quot;mint,omitempty&quot;`</span>
<span class="term-fg32">+	IsSystemTx *bool           `json:&quot;isSystemTx,omitempty&quot;`</span>
&nbsp;
 	&#47;&#47; Access list transaction fields:
 	ChainID    *hexutil.Big `json:&quot;chainId,omitempty&quot;`
<span class="term-fg36">@@ -94,6 +102,18 @@</span> 		enc.To = tx.To()
 		enc.V = (*hexutil.Big)(itx.V)
 		enc.R = (*hexutil.Big)(itx.R)
 		enc.S = (*hexutil.Big)(itx.S)
<span class="term-fg32">+	case *DepositTx:</span>
<span class="term-fg32">+		enc.Gas = (*hexutil.Uint64)(&amp;itx.Gas)</span>
<span class="term-fg32">+		enc.Value = (*hexutil.Big)(itx.Value)</span>
<span class="term-fg32">+		enc.Data = (*hexutil.Bytes)(&amp;itx.Data)</span>
<span class="term-fg32">+		enc.To = tx.To()</span>
<span class="term-fg32">+		enc.SourceHash = &amp;itx.SourceHash</span>
<span class="term-fg32">+		enc.From = &amp;itx.From</span>
<span class="term-fg32">+		if itx.Mint != nil {</span>
<span class="term-fg32">+			enc.Mint = (*hexutil.Big)(itx.Mint)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		enc.IsSystemTx = &amp;itx.IsSystemTransaction</span>
<span class="term-fg32">+		&#47;&#47; other fields will show up as null.</span>
 	}
 	return json.Marshal(&amp;enc)
 }
<span class="term-fg36">@@ -262,7 +282,54 @@</span> 			if err := sanityCheckSignature(itx.V, itx.R, itx.S, false); err != nil {
 				return err
 			}
 		}
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		if dec.AccessList != nil || dec.MaxFeePerGas != nil ||</span>
<span class="term-fg32">+			dec.MaxPriorityFeePerGas != nil {</span>
<span class="term-fg32">+			return errors.New(&quot;unexpected field(s) in deposit transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if dec.GasPrice != nil &amp;&amp; dec.GasPrice.ToInt().Cmp(common.Big0) != 0 {</span>
<span class="term-fg32">+			return errors.New(&quot;deposit transaction GasPrice must be 0&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if (dec.V != nil &amp;&amp; dec.V.ToInt().Cmp(common.Big0) != 0) ||</span>
<span class="term-fg32">+			(dec.R != nil &amp;&amp; dec.R.ToInt().Cmp(common.Big0) != 0) ||</span>
<span class="term-fg32">+			(dec.S != nil &amp;&amp; dec.S.ToInt().Cmp(common.Big0) != 0) {</span>
<span class="term-fg32">+			return errors.New(&quot;deposit transaction signature must be 0 or unset&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var itx DepositTx</span>
<span class="term-fg32">+		inner = &amp;itx</span>
<span class="term-fg32">+		if dec.To != nil {</span>
<span class="term-fg32">+			itx.To = dec.To</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if dec.Gas == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;gas&#39; for txdata&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Gas = uint64(*dec.Gas)</span>
<span class="term-fg32">+		if dec.Value == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;value&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Value = (*big.Int)(dec.Value)</span>
<span class="term-fg32">+		&#47;&#47; mint may be omitted or nil if there is nothing to mint.</span>
<span class="term-fg32">+		itx.Mint = (*big.Int)(dec.Mint)</span>
<span class="term-fg32">+		if dec.Data == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;input&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Data = *dec.Data</span>
<span class="term-fg32">+		if dec.From == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;from&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.From = *dec.From</span>
<span class="term-fg32">+		if dec.SourceHash == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;sourceHash&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.SourceHash = *dec.SourceHash</span>
<span class="term-fg32">+		&#47;&#47; IsSystemTx may be omitted. Defaults to false.</span>
<span class="term-fg32">+		if dec.IsSystemTx != nil {</span>
<span class="term-fg32">+			itx.IsSystemTransaction = *dec.IsSystemTx</span>
<span class="term-fg32">+		}</span>
&nbsp;
<span class="term-fg32">+		if dec.Nonce != nil {</span>
<span class="term-fg32">+			inner = &amp;depositTxWithNonce{DepositTx: itx, EffectiveNonce: uint64(*dec.Nonce)}</span>
<span class="term-fg32">+		}</span>
 	default:
 		return ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -273,3 +340,15 @@</span>
 	&#47;&#47; TODO: check hash here?
 	return nil
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+type depositTxWithNonce struct {</span>
<span class="term-fg32">+	DepositTx</span>
<span class="term-fg32">+	EffectiveNonce uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; EncodeRLP ensures that RLP encoding this transaction excludes the nonce. Otherwise, the tx Hash would change</span>
<span class="term-fg32">+func (tx *depositTxWithNonce) EncodeRLP(w io.Writer) error {</span>
<span class="term-fg32">+	return rlp.Encode(w, tx.DepositTx)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *depositTxWithNonce) effectiveNonce() *uint64 { return &amp;tx.EffectiveNonce }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7e49c565e5f40eddc519c16d" role="button"
                   aria-expanded="false" aria-controls="id-7e49c565e5f40eddc519c16d">
                    <code>core/types/transaction_signing.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/transaction_signing.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/transaction_signing.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7e49c565e5f40eddc519c16d"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_signing.go op-geth&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg1">index 87f0390a6f9ce448873688ef214fc02753856342..70a10eb1c1ed086a4421914f940555e406040c55 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg36">@@ -182,6 +182,9 @@</span> 	return londonSigner{eip2930Signer{NewEIP155Signer(chainId)}}
 }
&nbsp;
 func (s londonSigner) Sender(tx *Transaction) (common.Address, error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return tx.inner.(*DepositTx).From, nil</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() != DynamicFeeTxType {
 		return s.eip2930Signer.Sender(tx)
 	}
<span class="term-fg36">@@ -201,6 +204,9 @@</span> 	return ok &amp;&amp; x.chainId.Cmp(s.chainId) == 0
 }
&nbsp;
 func (s londonSigner) SignatureValues(tx *Transaction, sig []byte) (R, S, V *big.Int, err error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return nil, nil, nil, fmt.Errorf(&quot;deposits do not have a signature&quot;)</span>
<span class="term-fg32">+	}</span>
 	txdata, ok := tx.inner.(*DynamicFeeTx)
 	if !ok {
 		return s.eip2930Signer.SignatureValues(tx, sig)
<span class="term-fg36">@@ -218,6 +224,9 @@</span>
 &#47;&#47; Hash returns the hash to be signed by the sender.
 &#47;&#47; It does not uniquely identify the transaction.
 func (s londonSigner) Hash(tx *Transaction) common.Hash {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		panic(&quot;deposits cannot be signed and do not have a signing hash&quot;)</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() != DynamicFeeTxType {
 		return s.eip2930Signer.Hash(tx)
 	}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-f6aee7357fc47bfbced73555"role="button" aria-expanded="false" aria-controls="id-f6aee7357fc47bfbced73555">
        
            <div class="col-12 col-sm-9 text-start"><h4>Transaction properties</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+83</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-f6aee7357fc47bfbced73555">
        <div><p>The <code>Transaction</code> type now exposes the deposit-transaction and L1-cost properties required for the rollup.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5440cc3296d49e3e210b3339" role="button"
                   aria-expanded="false" aria-controls="id-5440cc3296d49e3e210b3339">
                    <code>core/types/transaction.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/transaction.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/transaction.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+80</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5440cc3296d49e3e210b3339"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction.go op-geth&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg1">index 89192f049bd5c49dcbb7d06959a570426e4ecf07..6485d0516914a4291a5e7ea95d4f7d0edd4a8642 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg36">@@ -28,6 +28,7 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 )
&nbsp;
<span class="term-fg36">@@ -56,6 +57,9 @@</span> 	&#47;&#47; caches
 	hash atomic.Value
 	size atomic.Value
 	from atomic.Value
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; cache of RollupGasData details to compute the gas the tx takes on L1 for its share of rollup data</span>
<span class="term-fg32">+	rollupGas atomic.Value</span>
 }
&nbsp;
 &#47;&#47; NewTx creates a new transaction.
<span class="term-fg36">@@ -82,6 +86,7 @@</span> 	gasFeeCap() *big.Int
 	value() *big.Int
 	nonce() uint64
 	to() *common.Address
<span class="term-fg32">+	isSystemTx() bool</span>
&nbsp;
 	rawSignatureValues() (v, r, s *big.Int)
 	setSignatureValues(chainID, v, r, s *big.Int)
<span class="term-fg36">@@ -192,6 +197,10 @@</span> 	case DynamicFeeTxType:
 		var inner DynamicFeeTx
 		err := rlp.DecodeBytes(b[1:], &amp;inner)
 		return &amp;inner, err
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		var inner DepositTx</span>
<span class="term-fg32">+		err := rlp.DecodeBytes(b[1:], &amp;inner)</span>
<span class="term-fg32">+		return &amp;inner, err</span>
 	default:
 		return nil, ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -287,12 +296,56 @@</span>
 &#47;&#47; Nonce returns the sender account nonce of the transaction.
 func (tx *Transaction) Nonce() uint64 { return tx.inner.nonce() }
&nbsp;
<span class="term-fg32">+&#47;&#47; EffectiveNonce returns the nonce that was actually used as part of transaction execution</span>
<span class="term-fg32">+&#47;&#47; Returns nil if the effective nonce is not known</span>
<span class="term-fg32">+func (tx *Transaction) EffectiveNonce() *uint64 {</span>
<span class="term-fg32">+	type txWithEffectiveNonce interface {</span>
<span class="term-fg32">+		effectiveNonce() *uint64</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if itx, ok := tx.inner.(txWithEffectiveNonce); ok {</span>
<span class="term-fg32">+		return itx.effectiveNonce()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonce := tx.inner.nonce()</span>
<span class="term-fg32">+	return &amp;nonce</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; To returns the recipient address of the transaction.
 &#47;&#47; For contract-creation transactions, To returns nil.
 func (tx *Transaction) To() *common.Address {
 	return copyAddressPtr(tx.inner.to())
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; SourceHash returns the hash that uniquely identifies the source of the deposit tx,</span>
<span class="term-fg32">+&#47;&#47; e.g. a user deposit event, or a L1 info deposit included in a specific L2 block height.</span>
<span class="term-fg32">+&#47;&#47; Non-deposit transactions return a zeroed hash.</span>
<span class="term-fg32">+func (tx *Transaction) SourceHash() common.Hash {</span>
<span class="term-fg32">+	if dep, ok := tx.inner.(*DepositTx); ok {</span>
<span class="term-fg32">+		return dep.SourceHash</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return common.Hash{}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Mint returns the ETH to mint in the deposit tx.</span>
<span class="term-fg32">+&#47;&#47; This returns nil if there is nothing to mint, or if this is not a deposit tx.</span>
<span class="term-fg32">+func (tx *Transaction) Mint() *big.Int {</span>
<span class="term-fg32">+	if dep, ok := tx.inner.(*DepositTx); ok {</span>
<span class="term-fg32">+		return dep.Mint</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsDepositTx returns true if the transaction is a deposit tx type.</span>
<span class="term-fg32">+func (tx *Transaction) IsDepositTx() bool {</span>
<span class="term-fg32">+	return tx.Type() == DepositTxType</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsSystemTx returns true for deposits that are system transactions. These transactions</span>
<span class="term-fg32">+&#47;&#47; are executed in an unmetered environment &amp; do not contribute to the block gas limit.</span>
<span class="term-fg32">+func (tx *Transaction) IsSystemTx() bool {</span>
<span class="term-fg32">+	return tx.inner.isSystemTx()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Cost returns gas * gasPrice + value.
 func (tx *Transaction) Cost() *big.Int {
 	total := new(big.Int).Mul(tx.GasPrice(), new(big.Int).SetUint64(tx.Gas()))
<span class="term-fg36">@@ -300,6 +353,30 @@</span> 	total.Add(total, tx.Value())
 	return total
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; RollupDataGas is the amount of gas it takes to confirm the tx on L1 as a rollup</span>
<span class="term-fg32">+func (tx *Transaction) RollupDataGas() RollupGasData {</span>
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return RollupGasData{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if v := tx.rollupGas.Load(); v != nil {</span>
<span class="term-fg32">+		return v.(RollupGasData)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	data, err := tx.MarshalBinary()</span>
<span class="term-fg32">+	if err != nil { &#47;&#47; Silent error, invalid txs will not be marshalled&#47;unmarshalled for batch submission anyway.</span>
<span class="term-fg32">+		log.Error(&quot;failed to encode tx for L1 cost computation&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var out RollupGasData</span>
<span class="term-fg32">+	for _, byt := range data {</span>
<span class="term-fg32">+		if byt == 0 {</span>
<span class="term-fg32">+			out.Zeroes++</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			out.Ones++</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	tx.rollupGas.Store(out)</span>
<span class="term-fg32">+	return out</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; RawSignatureValues returns the V, R, S signature values of the transaction.
 &#47;&#47; The return values should not be modified by the caller.
 func (tx *Transaction) RawSignatureValues() (v, r, s *big.Int) {
<span class="term-fg36">@@ -330,6 +407,9 @@</span> &#47;&#47; EffectiveGasTip returns the effective miner gasTipCap for the given base fee.
 &#47;&#47; Note: if the effective gasTipCap is negative, this method returns both error
 &#47;&#47; the actual negative value, _and_ ErrGasFeeCapTooLow
 func (tx *Transaction) EffectiveGasTip(baseFee *big.Int) (*big.Int, error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return new(big.Int), nil</span>
<span class="term-fg32">+	}</span>
 	if baseFee == nil {
 		return tx.GasTipCap(), nil
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5a5c7acfba568bcf64200cec" role="button"
                   aria-expanded="false" aria-controls="id-5a5c7acfba568bcf64200cec">
                    <code>core/types/tx_access_list.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/tx_access_list.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/tx_access_list.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5a5c7acfba568bcf64200cec"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_access_list.go op-geth&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg1">index 692bba4ff2d9bf4affda01bb23f9f28f1ef41fd1..518fb603754dcd3497d8b8829598736cd640e136 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg36">@@ -105,6 +105,7 @@</span> func (tx *AccessListTx) gasFeeCap() *big.Int    { return tx.GasPrice }
 func (tx *AccessListTx) value() *big.Int        { return tx.Value }
 func (tx *AccessListTx) nonce() uint64          { return tx.Nonce }
 func (tx *AccessListTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *AccessListTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *AccessListTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	return dst.Set(tx.GasPrice)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4a9157301395afb1b3501661" role="button"
                   aria-expanded="false" aria-controls="id-4a9157301395afb1b3501661">
                    <code>core/types/tx_dynamic_fee.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/tx_dynamic_fee.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/tx_dynamic_fee.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4a9157301395afb1b3501661"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_dynamic_fee.go op-geth&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg1">index 5708106658173b2dda9dcce75f53df8899aaa190..ee84b7741f21c8bfbe5dd9f7cce0304d89b6a9bc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg36">@@ -93,6 +93,7 @@</span> func (tx *DynamicFeeTx) gasPrice() *big.Int     { return tx.GasFeeCap }
 func (tx *DynamicFeeTx) value() *big.Int        { return tx.Value }
 func (tx *DynamicFeeTx) nonce() uint64          { return tx.Nonce }
 func (tx *DynamicFeeTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *DynamicFeeTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *DynamicFeeTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	if baseFee == nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-34a6501df28afac693f98c72" role="button"
                   aria-expanded="false" aria-controls="id-34a6501df28afac693f98c72">
                    <code>core/types/tx_legacy.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/tx_legacy.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/tx_legacy.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-34a6501df28afac693f98c72"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_legacy.go op-geth&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg1">index 988de7db09aa6fb14bf02e53c66d766f7e887b20..3fdbaf1eec4d5f22ffa47c8723c095ff825fde97 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg36">@@ -102,6 +102,7 @@</span> func (tx *LegacyTx) gasFeeCap() *big.Int    { return tx.GasPrice }
 func (tx *LegacyTx) value() *big.Int        { return tx.Value }
 func (tx *LegacyTx) nonce() uint64          { return tx.Nonce }
 func (tx *LegacyTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *LegacyTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *LegacyTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	return dst.Set(tx.GasPrice)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-80758c363730e51023cd7402"role="button" aria-expanded="false" aria-controls="id-80758c363730e51023cd7402">
        
            <div class="col-12 col-sm-9 text-start"><h4>L1 cost computation</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+103</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-80758c363730e51023cd7402">
        <div><p>Transactions must pay an additional L1 cost based on the amount of rollup-data-gas they consume,
estimated based on gas-price-oracle information and encoded tx size.&rdquo;</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7591345e37d6a1205e720862" role="button"
                   aria-expanded="false" aria-controls="id-7591345e37d6a1205e720862">
                    <code>core/vm/evm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/vm/evm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/vm/evm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7591345e37d6a1205e720862"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;evm.go op-geth&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg1">index d78ea07926641a08a6ccda5b552fa4f851eadd4e..9ab030dbabd8fb5b961f88365ec8505afd4ad9d5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg36">@@ -20,10 +20,12 @@</span> import (
 	&quot;math&#47;big&quot;
 	&quot;sync&#47;atomic&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg31">-	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 &#47;&#47; emptyCodeHash is used by create to ensure deployment is disallowed to already
<span class="term-fg36">@@ -66,6 +68,8 @@</span> 	&#47;&#47; Transfer transfers ether from one account to the other
 	Transfer TransferFunc
 	&#47;&#47; GetHash returns the hash corresponding to n
 	GetHash GetHashFunc
<span class="term-fg32">+	&#47;&#47; L1CostFunc returns the L1 cost of the rollup message, the function may be nil, or return nil</span>
<span class="term-fg32">+	L1CostFunc types.L1CostFunc</span>
&nbsp;
 	&#47;&#47; Block information
 	Coinbase    common.Address &#47;&#47; Provides information for COINBASE</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-89bb72f1beb53a812b3cad71" role="button"
                   aria-expanded="false" aria-controls="id-89bb72f1beb53a812b3cad71">
                    <code>core/types/rollup_l1_cost.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/rollup_l1_cost.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+83</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-89bb72f1beb53a812b3cad71"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;rollup_l1_cost.go op-geth&#47;core&#47;types&#47;rollup_l1_cost.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..521dfc10d7a7f086456cea4d16b2a756a0dbc777</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;rollup_l1_cost.go</span>
<span class="term-fg36">@@ -0,0 +1,83 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2022 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type RollupGasData struct {</span>
<span class="term-fg32">+	Zeroes, Ones uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (r RollupGasData) DataGas(time uint64, cfg *params.ChainConfig) (gas uint64) {</span>
<span class="term-fg32">+	gas = r.Zeroes * params.TxDataZeroGas</span>
<span class="term-fg32">+	if cfg.IsRegolith(time) {</span>
<span class="term-fg32">+		gas += r.Ones * params.TxDataNonZeroGasEIP2028</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		gas += (r.Ones + 68) * params.TxDataNonZeroGasEIP2028</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return gas</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type StateGetter interface {</span>
<span class="term-fg32">+	GetState(common.Address, common.Hash) common.Hash</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; L1CostFunc is used in the state transition to determine the cost of a rollup message.</span>
<span class="term-fg32">+&#47;&#47; Returns nil if there is no cost.</span>
<span class="term-fg32">+type L1CostFunc func(blockNum uint64, blockTime uint64, dataGas RollupGasData, isDepositTx bool) *big.Int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	L1BaseFeeSlot = common.BigToHash(big.NewInt(1))</span>
<span class="term-fg32">+	OverheadSlot  = common.BigToHash(big.NewInt(5))</span>
<span class="term-fg32">+	ScalarSlot    = common.BigToHash(big.NewInt(6))</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var L1BlockAddr = common.HexToAddress(&quot;0x4200000000000000000000000000000000000015&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewL1CostFunc returns a function used for calculating L1 fee cost.</span>
<span class="term-fg32">+&#47;&#47; This depends on the oracles because gas costs can change over time.</span>
<span class="term-fg32">+&#47;&#47; It returns nil if there is no applicable cost function.</span>
<span class="term-fg32">+func NewL1CostFunc(config *params.ChainConfig, statedb StateGetter) L1CostFunc {</span>
<span class="term-fg32">+	cacheBlockNum := ^uint64(0)</span>
<span class="term-fg32">+	var l1BaseFee, overhead, scalar *big.Int</span>
<span class="term-fg32">+	return func(blockNum uint64, blockTime uint64, dataGas RollupGasData, isDepositTx bool) *big.Int {</span>
<span class="term-fg32">+		rollupDataGas := dataGas.DataGas(blockTime, config) &#47;&#47; Only fake txs for RPC view-calls are 0.</span>
<span class="term-fg32">+		if config.Optimism == nil || isDepositTx || rollupDataGas == 0 {</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if blockNum != cacheBlockNum {</span>
<span class="term-fg32">+			l1BaseFee = statedb.GetState(L1BlockAddr, L1BaseFeeSlot).Big()</span>
<span class="term-fg32">+			overhead = statedb.GetState(L1BlockAddr, OverheadSlot).Big()</span>
<span class="term-fg32">+			scalar = statedb.GetState(L1BlockAddr, ScalarSlot).Big()</span>
<span class="term-fg32">+			cacheBlockNum = blockNum</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return L1Cost(rollupDataGas, l1BaseFee, overhead, scalar)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func L1Cost(rollupDataGas uint64, l1BaseFee, overhead, scalar *big.Int) *big.Int {</span>
<span class="term-fg32">+	l1GasUsed := new(big.Int).SetUint64(rollupDataGas)</span>
<span class="term-fg32">+	l1GasUsed = l1GasUsed.Add(l1GasUsed, overhead)</span>
<span class="term-fg32">+	l1Cost := l1GasUsed.Mul(l1GasUsed, l1BaseFee)</span>
<span class="term-fg32">+	l1Cost = l1Cost.Mul(l1Cost, scalar)</span>
<span class="term-fg32">+	return l1Cost.Div(l1Cost, big.NewInt(1_000_000))</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-67bcd4d54aafbffb377917a1" role="button"
                   aria-expanded="false" aria-controls="id-67bcd4d54aafbffb377917a1">
                    <code>core/state_processor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/state_processor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/state_processor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+14</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-67bcd4d54aafbffb377917a1"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_processor.go op-geth&#47;core&#47;state_processor.go</span>
<span class="term-fg1">index 2fa9c41bcc018b50f2509959206eb1bbce60efdb..7a638190aafc4c37bd2fe3855a755b2e75d00089 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_processor.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_processor.go</span>
<span class="term-fg36">@@ -70,7 +70,7 @@</span> 	&#47;&#47; Mutate the block and state according to any hard-fork specs
 	if p.config.DAOForkSupport &amp;&amp; p.config.DAOForkBlock != nil &amp;&amp; p.config.DAOForkBlock.Cmp(block.Number()) == 0 {
 		misc.ApplyDAOHardFork(statedb)
 	}
<span class="term-fg31">-	blockContext := NewEVMBlockContext(header, p.bc, nil)</span>
<span class="term-fg32">+	blockContext := NewEVMBlockContext(header, p.bc, nil, p.config, statedb)</span>
 	vmenv := vm.NewEVM(blockContext, vm.TxContext{}, statedb, p.config, cfg)
 	&#47;&#47; Iterate over and process the individual transactions
 	for i, tx := range block.Transactions() {
<span class="term-fg36">@@ -102,6 +102,11 @@</span> 	&#47;&#47; Create a new context to be used in the EVM environment.
 	txContext := NewEVMTxContext(msg)
 	evm.Reset(txContext, statedb)
&nbsp;
<span class="term-fg32">+	nonce := tx.Nonce()</span>
<span class="term-fg32">+	if msg.IsDepositTx &amp;&amp; config.IsOptimismRegolith(evm.Context.Time) {</span>
<span class="term-fg32">+		nonce = statedb.GetNonce(msg.From)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Apply the transaction to the current state (included in the env).
 	result, err := ApplyMessage(evm, msg, gp)
 	if err != nil {
<span class="term-fg36">@@ -128,9 +133,15 @@</span> 	}
 	receipt.TxHash = tx.Hash()
 	receipt.GasUsed = result.UsedGas
&nbsp;
<span class="term-fg32">+	if msg.IsDepositTx &amp;&amp; config.IsOptimismRegolith(evm.Context.Time) {</span>
<span class="term-fg32">+		&#47;&#47; The actual nonce for deposit transactions is only recorded from Regolith onwards.</span>
<span class="term-fg32">+		&#47;&#47; Before the Regolith fork the DepositNonce must remain nil</span>
<span class="term-fg32">+		receipt.DepositNonce = &amp;nonce</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; If the transaction created a contract, store the creation address in the receipt.
 	if msg.To == nil {
<span class="term-fg31">-		receipt.ContractAddress = crypto.CreateAddress(evm.TxContext.Origin, tx.Nonce())</span>
<span class="term-fg32">+		receipt.ContractAddress = crypto.CreateAddress(evm.TxContext.Origin, nonce)</span>
 	}
&nbsp;
 	&#47;&#47; Set the receipt logs and create the bloom filter.
<span class="term-fg36">@@ -152,7 +163,7 @@</span> 	if err != nil {
 		return nil, err
 	}
 	&#47;&#47; Create a new context to be used in the EVM environment
<span class="term-fg31">-	blockContext := NewEVMBlockContext(header, bc, author)</span>
<span class="term-fg32">+	blockContext := NewEVMBlockContext(header, bc, author, config, statedb)</span>
 	vmenv := vm.NewEVM(blockContext, vm.TxContext{}, statedb, config, cfg)
 	return applyTransaction(msg, config, gp, statedb, header.Number, header.Hash(), tx, usedGas, vmenv)
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7a83b1807fa7b8a72faf16b3" role="button"
                   aria-expanded="false" aria-controls="id-7a83b1807fa7b8a72faf16b3">
                    <code>core/state_prefetcher.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/state_prefetcher.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/state_prefetcher.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7a83b1807fa7b8a72faf16b3"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_prefetcher.go op-geth&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg1">index c258eee4f4cc0ba508fa209ec233121428017763..72cb249f22edc98eac716c2bfc5e363690bd16f1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg36">@@ -51,7 +51,7 @@</span> func (p *statePrefetcher) Prefetch(block *types.Block, statedb *state.StateDB, cfg vm.Config, interrupt *uint32) {
 	var (
 		header       = block.Header()
 		gaspool      = new(GasPool).AddGas(block.GasLimit())
<span class="term-fg31">-		blockContext = NewEVMBlockContext(header, p.bc, nil)</span>
<span class="term-fg32">+		blockContext = NewEVMBlockContext(header, p.bc, nil, p.config, statedb)</span>
 		evm          = vm.NewEVM(blockContext, vm.TxContext{}, statedb, p.config, cfg)
 		signer       = types.MakeSigner(p.config, header.Number)
 	)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-1326571923a0ba6384c9bd7d"role="button" aria-expanded="false" aria-controls="id-1326571923a0ba6384c9bd7d">
        
            <div class="col-12 col-sm-9 text-start"><h4>Transaction processing</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+110</span></div>
                <div class="text-start"><span class="text-danger">-9</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-1326571923a0ba6384c9bd7d">
        <div><p>Deposit transactions have special processing rules: gas is pre-paid on L1,
and deposits with EVM-failure are included with rolled back changes (except mint).
For regular transactions, at the end of the transition, the 1559 burn and L1 cost are routed to vaults.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0842bcebd7c85fb6a1cdeab4" role="button"
                   aria-expanded="false" aria-controls="id-0842bcebd7c85fb6a1cdeab4">
                    <code>core/state_transition.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/state_transition.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/state_transition.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+110</span></div>
                        <div class="text-start"><span class="text-danger">-9</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0842bcebd7c85fb6a1cdeab4"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_transition.go op-geth&#47;core&#47;state_transition.go</span>
<span class="term-fg1">index 1802f1daf70ae988a08010bf2089da55690159cd..232a79af7cf2cb6e57332b2a7a0baeb07d6d27aa 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_transition.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_transition.go</span>
<span class="term-fg36">@@ -140,20 +140,30 @@</span> 	&#47;&#47; When SkipAccountCheckss is true, the message nonce is not checked against the
 	&#47;&#47; account nonce in state. It also disables checking that the sender is an EOA.
 	&#47;&#47; This field will be set to true for operations like RPC eth_call.
 	SkipAccountChecks bool
<span class="term-fg32">+</span>
<span class="term-fg32">+	IsSystemTx    bool                &#47;&#47; IsSystemTx indicates the message, if also a deposit, does not emit gas usage.</span>
<span class="term-fg32">+	IsDepositTx   bool                &#47;&#47; IsDepositTx indicates the message is force-included and can persist a mint.</span>
<span class="term-fg32">+	Mint          *big.Int            &#47;&#47; Mint is the amount to mint before EVM processing, or nil if there is no minting.</span>
<span class="term-fg32">+	RollupDataGas types.RollupGasData &#47;&#47; RollupDataGas indicates the rollup cost of the message, 0 if not a rollup or no cost.</span>
 }
&nbsp;
 &#47;&#47; TransactionToMessage converts a transaction into a Message.
 func TransactionToMessage(tx *types.Transaction, s types.Signer, baseFee *big.Int) (*Message, error) {
 	msg := &amp;Message{
<span class="term-fg31">-		Nonce:             tx.Nonce(),</span>
<span class="term-fg31">-		GasLimit:          tx.Gas(),</span>
<span class="term-fg31">-		GasPrice:          new(big.Int).Set(tx.GasPrice()),</span>
<span class="term-fg31">-		GasFeeCap:         new(big.Int).Set(tx.GasFeeCap()),</span>
<span class="term-fg31">-		GasTipCap:         new(big.Int).Set(tx.GasTipCap()),</span>
<span class="term-fg31">-		To:                tx.To(),</span>
<span class="term-fg31">-		Value:             tx.Value(),</span>
<span class="term-fg31">-		Data:              tx.Data(),</span>
<span class="term-fg31">-		AccessList:        tx.AccessList(),</span>
<span class="term-fg32">+		Nonce:         tx.Nonce(),</span>
<span class="term-fg32">+		GasLimit:      tx.Gas(),</span>
<span class="term-fg32">+		GasPrice:      new(big.Int).Set(tx.GasPrice()),</span>
<span class="term-fg32">+		GasFeeCap:     new(big.Int).Set(tx.GasFeeCap()),</span>
<span class="term-fg32">+		GasTipCap:     new(big.Int).Set(tx.GasTipCap()),</span>
<span class="term-fg32">+		To:            tx.To(),</span>
<span class="term-fg32">+		Value:         tx.Value(),</span>
<span class="term-fg32">+		Data:          tx.Data(),</span>
<span class="term-fg32">+		AccessList:    tx.AccessList(),</span>
<span class="term-fg32">+		IsSystemTx:    tx.IsSystemTx(),</span>
<span class="term-fg32">+		IsDepositTx:   tx.IsDepositTx(),</span>
<span class="term-fg32">+		Mint:          tx.Mint(),</span>
<span class="term-fg32">+		RollupDataGas: tx.RollupDataGas(),</span>
<span class="term-fg32">+</span>
 		SkipAccountChecks: false,
 	}
 	&#47;&#47; If baseFee provided, set gasPrice to effectiveGasPrice.
<span class="term-fg36">@@ -228,11 +238,21 @@</span>
 func (st *StateTransition) buyGas() error {
 	mgval := new(big.Int).SetUint64(st.msg.GasLimit)
 	mgval = mgval.Mul(mgval, st.msg.GasPrice)
<span class="term-fg32">+	var l1Cost *big.Int</span>
<span class="term-fg32">+	if st.evm.Context.L1CostFunc != nil &amp;&amp; !st.msg.SkipAccountChecks {</span>
<span class="term-fg32">+		l1Cost = st.evm.Context.L1CostFunc(st.evm.Context.BlockNumber.Uint64(), st.evm.Context.Time, st.msg.RollupDataGas, st.msg.IsDepositTx)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if l1Cost != nil {</span>
<span class="term-fg32">+		mgval = mgval.Add(mgval, l1Cost)</span>
<span class="term-fg32">+	}</span>
 	balanceCheck := mgval
 	if st.msg.GasFeeCap != nil {
 		balanceCheck = new(big.Int).SetUint64(st.msg.GasLimit)
 		balanceCheck = balanceCheck.Mul(balanceCheck, st.msg.GasFeeCap)
 		balanceCheck.Add(balanceCheck, st.msg.Value)
<span class="term-fg32">+		if l1Cost != nil {</span>
<span class="term-fg32">+			balanceCheck.Add(balanceCheck, l1Cost)</span>
<span class="term-fg32">+		}</span>
 	}
 	if have, want := st.state.GetBalance(st.msg.From), balanceCheck; have.Cmp(want) &lt; 0 {
 		return fmt.Errorf(&quot;%w: address %v have %v want %v&quot;, ErrInsufficientFunds, st.msg.From.Hex(), have, want)
<span class="term-fg36">@@ -248,6 +268,21 @@</span> 	return nil
 }
&nbsp;
 func (st *StateTransition) preCheck() error {
<span class="term-fg32">+	if st.msg.IsDepositTx {</span>
<span class="term-fg32">+		&#47;&#47; No fee fields to check, no nonce to check, and no need to check if EOA (L1 already verified it for us)</span>
<span class="term-fg32">+		&#47;&#47; Gas is free, but no refunds!</span>
<span class="term-fg32">+		st.initialGas = st.msg.GasLimit</span>
<span class="term-fg32">+		st.gasRemaining += st.msg.GasLimit &#47;&#47; Add gas here in order to be able to execute calls.</span>
<span class="term-fg32">+		&#47;&#47; Don&#39;t touch the gas pool for system transactions</span>
<span class="term-fg32">+		if st.msg.IsSystemTx {</span>
<span class="term-fg32">+			if st.evm.ChainConfig().IsOptimismRegolith(st.evm.Context.Time) {</span>
<span class="term-fg32">+				return fmt.Errorf(&quot;%w: address %v&quot;, ErrSystemTxNotSupported,</span>
<span class="term-fg32">+					st.msg.From.Hex())</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return st.gp.SubGas(st.msg.GasLimit) &#47;&#47; gas used by deposits may not be used by other txs</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Only check transactions that are not fake
 	msg := st.msg
 	if !msg.SkipAccountChecks {
<span class="term-fg36">@@ -309,6 +344,37 @@</span> &#47;&#47;
 &#47;&#47; However if any consensus issue encountered, return the error directly with
 &#47;&#47; nil evm execution result.
 func (st *StateTransition) TransitionDb() (*ExecutionResult, error) {
<span class="term-fg32">+	if mint := st.msg.Mint; mint != nil {</span>
<span class="term-fg32">+		st.state.AddBalance(st.msg.From, mint)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	snap := st.state.Snapshot()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := st.innerTransitionDb()</span>
<span class="term-fg32">+	&#47;&#47; Failed deposits must still be included. Unless we cannot produce the block at all due to the gas limit.</span>
<span class="term-fg32">+	&#47;&#47; On deposit failure, we rewind any state changes from after the minting, and increment the nonce.</span>
<span class="term-fg32">+	if err != nil &amp;&amp; err != ErrGasLimitReached &amp;&amp; st.msg.IsDepositTx {</span>
<span class="term-fg32">+		st.state.RevertToSnapshot(snap)</span>
<span class="term-fg32">+		&#47;&#47; Even though we revert the state changes, always increment the nonce for the next deposit transaction</span>
<span class="term-fg32">+		st.state.SetNonce(st.msg.From, st.state.GetNonce(st.msg.From)+1)</span>
<span class="term-fg32">+		&#47;&#47; Record deposits as using all their gas (matches the gas pool)</span>
<span class="term-fg32">+		&#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+		&#47;&#47; Regolith changes this behaviour so the actual gas used is reported.</span>
<span class="term-fg32">+		&#47;&#47; In this case the tx is invalid so is recorded as using all gas.</span>
<span class="term-fg32">+		gasUsed := st.msg.GasLimit</span>
<span class="term-fg32">+		if st.msg.IsSystemTx &amp;&amp; !st.evm.ChainConfig().IsRegolith(st.evm.Context.Time) {</span>
<span class="term-fg32">+			gasUsed = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		result = &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    gasUsed,</span>
<span class="term-fg32">+			Err:        fmt.Errorf(&quot;failed deposit: %w&quot;, err),</span>
<span class="term-fg32">+			ReturnData: nil,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		err = nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return result, err</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (st *StateTransition) innerTransitionDb() (*ExecutionResult, error) {</span>
 	&#47;&#47; First check this message satisfies all consensus rules before
 	&#47;&#47; applying the message. The rules include these clauses
 	&#47;&#47;
<span class="term-fg36">@@ -375,6 +441,24 @@</span> 		st.state.SetNonce(msg.From, st.state.GetNonce(sender.Address())+1)
 		ret, st.gasRemaining, vmerr = st.evm.Call(sender, st.to(), msg.Data, st.gasRemaining, msg.Value)
 	}
&nbsp;
<span class="term-fg32">+	&#47;&#47; if deposit: skip refunds, skip tipping coinbase</span>
<span class="term-fg32">+	&#47;&#47; Regolith changes this behaviour to report the actual gasUsed instead of always reporting all gas used.</span>
<span class="term-fg32">+	if st.msg.IsDepositTx &amp;&amp; !rules.IsOptimismRegolith {</span>
<span class="term-fg32">+		&#47;&#47; Record deposits as using all their gas (matches the gas pool)</span>
<span class="term-fg32">+		&#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+		gasUsed := st.msg.GasLimit</span>
<span class="term-fg32">+		if st.msg.IsSystemTx {</span>
<span class="term-fg32">+			gasUsed = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    gasUsed,</span>
<span class="term-fg32">+			Err:        vmerr,</span>
<span class="term-fg32">+			ReturnData: ret,</span>
<span class="term-fg32">+		}, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Note for deposit tx there is no ETH refunded for unused gas, but that&#39;s taken care of by the fact that gasPrice</span>
<span class="term-fg32">+	&#47;&#47; is always 0 for deposit tx. So calling refundGas will ensure the gasUsed accounting is correct without actually</span>
<span class="term-fg32">+	&#47;&#47; changing the sender&#39;s balance</span>
 	if !rules.IsLondon {
 		&#47;&#47; Before EIP-3529: refunds were capped to gasUsed &#47; 2
 		st.refundGas(params.RefundQuotient)
<span class="term-fg36">@@ -382,6 +466,14 @@</span> 	} else {
 		&#47;&#47; After EIP-3529: refunds are capped to gasUsed &#47; 5
 		st.refundGas(params.RefundQuotientEIP3529)
 	}
<span class="term-fg32">+	if st.msg.IsDepositTx &amp;&amp; rules.IsOptimismRegolith {</span>
<span class="term-fg32">+		&#47;&#47; Skip coinbase payments for deposit tx in Regolith</span>
<span class="term-fg32">+		return &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    st.gasUsed(),</span>
<span class="term-fg32">+			Err:        vmerr,</span>
<span class="term-fg32">+			ReturnData: ret,</span>
<span class="term-fg32">+		}, nil</span>
<span class="term-fg32">+	}</span>
 	effectiveTip := msg.GasPrice
 	if rules.IsLondon {
 		effectiveTip = cmath.BigMin(msg.GasTipCap, new(big.Int).Sub(msg.GasFeeCap, st.evm.Context.BaseFee))
<span class="term-fg36">@@ -395,6 +487,15 @@</span> 	} else {
 		fee := new(big.Int).SetUint64(st.gasUsed())
 		fee.Mul(fee, effectiveTip)
 		st.state.AddBalance(st.evm.Context.Coinbase, fee)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that we are post bedrock to enable op-geth to be able to create pseudo pre-bedrock blocks (these are pre-bedrock, but don&#39;t follow l2 geth rules)</span>
<span class="term-fg32">+	&#47;&#47; Note optimismConfig will not be nil if rules.IsOptimismBedrock is true</span>
<span class="term-fg32">+	if optimismConfig := st.evm.ChainConfig().Optimism; optimismConfig != nil &amp;&amp; rules.IsOptimismBedrock {</span>
<span class="term-fg32">+		st.state.AddBalance(params.OptimismBaseFeeRecipient, new(big.Int).Mul(new(big.Int).SetUint64(st.gasUsed()), st.evm.Context.BaseFee))</span>
<span class="term-fg32">+		if cost := st.evm.Context.L1CostFunc(st.evm.Context.BlockNumber.Uint64(), st.evm.Context.Time, st.msg.RollupDataGas, st.msg.IsDepositTx); cost != nil {</span>
<span class="term-fg32">+			st.state.AddBalance(params.OptimismL1FeeRecipient, cost)</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	return &amp;ExecutionResult{</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-e3d1388a94b39ac63fb0e0ad"role="button" aria-expanded="false" aria-controls="id-e3d1388a94b39ac63fb0e0ad">
        
            <div class="col-12 col-sm-9 text-start"><h4>Gaslimit</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+4</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-e3d1388a94b39ac63fb0e0ad">
        <div><p>The gaslimit is free to be set by the Engine API caller, instead of enforcing adjustments of the
gaslimit in increments of <sup>1</sup>&frasl;<sub>1024</sub> of the previous gaslimit.
The gaslimit is changed (and limited) through the <code>SystemConfig</code> contract.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6d9dd3bb3493a13e3155e220" role="button"
                   aria-expanded="false" aria-controls="id-6d9dd3bb3493a13e3155e220">
                    <code>consensus/misc/eip1559.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/consensus/misc/eip1559.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/consensus/misc/eip1559.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6d9dd3bb3493a13e3155e220"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;eip1559.go op-geth&#47;consensus&#47;misc&#47;eip1559.go</span>
<span class="term-fg1">index 4521b47b36e6b4d6fe0aa1c9895383f1be2f3ec1..0b6c8532ac01995cc73a161889a29612b63615e1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;misc&#47;eip1559.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;eip1559.go</span>
<span class="term-fg36">@@ -35,8 +35,10 @@</span> 	parentGasLimit := parent.GasLimit
 	if !config.IsLondon(parent.Number) {
 		parentGasLimit = parent.GasLimit * config.ElasticityMultiplier()
 	}
<span class="term-fg31">-	if err := VerifyGaslimit(parentGasLimit, header.GasLimit); err != nil {</span>
<span class="term-fg31">-		return err</span>
<span class="term-fg32">+	if config.Optimism == nil { &#47;&#47; gasLimit can adjust instantly in optimism</span>
<span class="term-fg32">+		if err := VerifyGaslimit(parentGasLimit, header.GasLimit); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
 	}
 	&#47;&#47; Verify the header is not malformed
 	if header.BaseFee == nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-496bd721f2f48e1cf8b33bf9"role="button" aria-expanded="false" aria-controls="id-496bd721f2f48e1cf8b33bf9">
        
            <div class="col-12 col-sm-9 text-start"><h4>Consensus tweaks</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+10</span></div>
                <div class="text-start"><span class="text-danger">-8</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-496bd721f2f48e1cf8b33bf9">
        <div><p>The Engine API is activated at the Merge transition, with a Total Terminal Difficulty (TTD).
The rollup starts post-merge, and thus sets the TTD to 0.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-04c752e241bfe73106c36dcd" role="button"
                   aria-expanded="false" aria-controls="id-04c752e241bfe73106c36dcd">
                    <code>consensus/beacon/consensus.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/consensus/beacon/consensus.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/consensus/beacon/consensus.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-8</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-04c752e241bfe73106c36dcd"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;beacon&#47;consensus.go op-geth&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg1">index eb5aa58ca8879b6eb1f73b631954a97a283e129d..acc4228a55c3d7e0e81fd399687cdd6d68d9ffda 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg36">@@ -326,10 +326,8 @@</span> 	header.Difficulty = beaconDifficulty
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Finalize implements consensus.Engine, setting the final state on the header</span>
<span class="term-fg32">+&#47;&#47; Finalize implements consensus.Engine and processes withdrawals on top.</span>
 func (beacon *Beacon) Finalize(chain consensus.ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, withdrawals []*types.Withdrawal) {
<span class="term-fg31">-	&#47;&#47; Finalize is different with Prepare, it can be used in both block generation</span>
<span class="term-fg31">-	&#47;&#47; and verification. So determine the consensus rules by header type.</span>
 	if !beacon.IsPoSHeader(header) {
 		beacon.ethone.Finalize(chain, header, state, txs, uncles, nil)
 		return
<span class="term-fg36">@@ -341,16 +339,12 @@</span> 		amount := new(big.Int).SetUint64(w.Amount)
 		amount = amount.Mul(amount, big.NewInt(params.GWei))
 		state.AddBalance(w.Address, amount)
 	}
<span class="term-fg31">-	&#47;&#47; The block reward is no longer handled here. It&#39;s done by the</span>
<span class="term-fg31">-	&#47;&#47; external consensus engine.</span>
<span class="term-fg31">-	header.Root = state.IntermediateRoot(true)</span>
<span class="term-fg32">+	&#47;&#47; No block reward which is issued by consensus layer instead.</span>
 }
&nbsp;
 &#47;&#47; FinalizeAndAssemble implements consensus.Engine, setting the final state and
 &#47;&#47; assembling the block.
 func (beacon *Beacon) FinalizeAndAssemble(chain consensus.ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, receipts []*types.Receipt, withdrawals []*types.Withdrawal) (*types.Block, error) {
<span class="term-fg31">-	&#47;&#47; FinalizeAndAssemble is different with Prepare, it can be used in both block</span>
<span class="term-fg31">-	&#47;&#47; generation and verification. So determine the consensus rules by header type.</span>
 	if !beacon.IsPoSHeader(header) {
 		return beacon.ethone.FinalizeAndAssemble(chain, header, state, txs, uncles, receipts, nil)
 	}
<span class="term-fg36">@@ -367,6 +361,11 @@</span> 		}
 	}
 	&#47;&#47; Finalize and assemble the block.
 	beacon.Finalize(chain, header, state, txs, uncles, withdrawals)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Assign the final state root to header.</span>
<span class="term-fg32">+	header.Root = state.IntermediateRoot(true)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Assemble and return the final block.</span>
 	return types.NewBlockWithWithdrawals(header, txs, uncles, receipts, withdrawals, trie.NewStackTrie(nil)), nil
 }
&nbsp;
<span class="term-fg36">@@ -444,6 +443,9 @@</span> &#47;&#47; If the parentHash is not stored in the database a UnknownAncestor error is returned.
 func IsTTDReached(chain consensus.ChainHeaderReader, parentHash common.Hash, parentNumber uint64) (bool, error) {
 	if chain.Config().TerminalTotalDifficulty == nil {
 		return false, nil
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if common.Big0.Cmp(chain.Config().TerminalTotalDifficulty) == 0 { &#47;&#47; in case TTD is reached at genesis.</span>
<span class="term-fg32">+		return true, nil</span>
 	}
 	td := chain.GetTd(parentHash, parentNumber)
 	if td == nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-6281d034f5d7c0df263f94a3"role="button" aria-expanded="false" aria-controls="id-6281d034f5d7c0df263f94a3">
        
            <div class="col-12 col-sm-9 text-start"><h3>Chain config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+113</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-6281d034f5d7c0df263f94a3">
        <div><p>The rollup functionality is enabled with the <code>optimism</code> field in the chain config.
The EIP-1559 parameters are configurable to adjust for faster more frequent and smaller blocks.
The parameters can be overriden for testing.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ff45cd6a72df0c768180774f" role="button"
                   aria-expanded="false" aria-controls="id-ff45cd6a72df0c768180774f">
                    <code>params/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/params/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/params/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+79</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ff45cd6a72df0c768180774f"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;config.go op-geth&#47;params&#47;config.go</span>
<span class="term-fg1">index adb5f44f09527e65b4e74b1266e40d3003d9e2b4..d16a5224e69704d811547a3ccc8bdd7b1505b8b1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;config.go</span>
<span class="term-fg36">@@ -21,8 +21,9 @@</span> 	&quot;encoding&#47;binary&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
&nbsp;
<span class="term-fg32">+	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg31">-	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;</span>
 )
&nbsp;
 &#47;&#47; Genesis hashes to enforce below configs on.
<span class="term-fg36">@@ -31,6 +32,13 @@</span> 	MainnetGenesisHash = common.HexToHash(&quot;0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3&quot;)
 	SepoliaGenesisHash = common.HexToHash(&quot;0x25a5cc106eea7138acab33231d7160d69cb777ee0c2c553fcddf5138993e6dd9&quot;)
 	RinkebyGenesisHash = common.HexToHash(&quot;0x6341fd3daf94b748c72ced5a5b26028f2474f5f00d824504e4fa37a75767e177&quot;)
 	GoerliGenesisHash  = common.HexToHash(&quot;0xbf7e331f7f7c1dd2e05159666b3bf8bc7a8a3a9eb1d518969eab529dd9b88c1a&quot;)
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Optimism chain config</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	OptimismGoerliChainId = big.NewInt(420)</span>
<span class="term-fg32">+	&#47;&#47; March 17, 2023 @ 7:00:00 pm UTC</span>
<span class="term-fg32">+	OptimismGoerliRegolithTime = uint64(1679079600)</span>
 )
&nbsp;
 &#47;&#47; TrustedCheckpoints associates each known checkpoint with the genesis hash of
<span class="term-fg36">@@ -76,6 +84,7 @@</span> 		ArrowGlacierBlock:             big.NewInt(13_773_000),
 		GrayGlacierBlock:              big.NewInt(15_050_000),
 		TerminalTotalDifficulty:       MainnetTerminalTotalDifficulty, &#47;&#47; 58_750_000_000_000_000_000_000
 		TerminalTotalDifficultyPassed: true,
<span class="term-fg32">+		ShanghaiTime:                  newUint64(1681338455),</span>
 		Ethash:                        new(EthashConfig),
 	}
&nbsp;
<span class="term-fg36">@@ -342,6 +351,15 @@</span> 		Ethash:                        new(EthashConfig),
 		Clique:                        nil,
 	}
 	TestRules = TestChainConfig.Rules(new(big.Int), false, 0)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; This is an Optimism chain config with bedrock starting a block 5, introduced for historical endpoint testing, largely based on the clique config</span>
<span class="term-fg32">+	OptimismTestConfig = func() *ChainConfig {</span>
<span class="term-fg32">+		conf := *AllCliqueProtocolChanges &#47;&#47; copy the config</span>
<span class="term-fg32">+		conf.Clique = nil</span>
<span class="term-fg32">+		conf.BedrockBlock = big.NewInt(5)</span>
<span class="term-fg32">+		conf.Optimism = &amp;OptimismConfig{EIP1559Elasticity: 50, EIP1559Denominator: 10}</span>
<span class="term-fg32">+		return &amp;conf</span>
<span class="term-fg32">+	}()</span>
 )
&nbsp;
 &#47;&#47; NetworkNames are user friendly names to use in the chain spec banner.
<span class="term-fg36">@@ -437,6 +455,9 @@</span> 	ShanghaiTime *uint64 `json:&quot;shanghaiTime,omitempty&quot;` &#47;&#47; Shanghai switch time (nil = no fork, 0 = already on shanghai)
 	CancunTime   *uint64 `json:&quot;cancunTime,omitempty&quot;`   &#47;&#47; Cancun switch time (nil = no fork, 0 = already on cancun)
 	PragueTime   *uint64 `json:&quot;pragueTime,omitempty&quot;`   &#47;&#47; Prague switch time (nil = no fork, 0 = already on prague)
&nbsp;
<span class="term-fg32">+	BedrockBlock *big.Int `json:&quot;bedrockBlock,omitempty&quot;` &#47;&#47; Bedrock switch block (nil = no fork, 0 = already on optimism bedrock)</span>
<span class="term-fg32">+	RegolithTime *uint64  `json:&quot;regolithTime,omitempty&quot;` &#47;&#47; Regolith switch time (nil = no fork, 0 = already on optimism regolith)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; TerminalTotalDifficulty is the amount of total difficulty reached by
 	&#47;&#47; the network that triggers the consensus upgrade.
 	TerminalTotalDifficulty *big.Int `json:&quot;terminalTotalDifficulty,omitempty&quot;`
<span class="term-fg36">@@ -449,6 +470,9 @@</span>
 	&#47;&#47; Various consensus engines
 	Ethash *EthashConfig `json:&quot;ethash,omitempty&quot;`
 	Clique *CliqueConfig `json:&quot;clique,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Optimism config, nil if not active</span>
<span class="term-fg32">+	Optimism *OptimismConfig `json:&quot;optimism,omitempty&quot;`</span>
 }
&nbsp;
 &#47;&#47; EthashConfig is the consensus engine configs for proof-of-work based sealing.
<span class="term-fg36">@@ -470,6 +494,17 @@</span> func (c *CliqueConfig) String() string {
 	return &quot;clique&quot;
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; OptimismConfig is the optimism config.</span>
<span class="term-fg32">+type OptimismConfig struct {</span>
<span class="term-fg32">+	EIP1559Elasticity  uint64 `json:&quot;eip1559Elasticity&quot;`</span>
<span class="term-fg32">+	EIP1559Denominator uint64 `json:&quot;eip1559Denominator&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; String implements the stringer interface, returning the optimism fee config details.</span>
<span class="term-fg32">+func (o *OptimismConfig) String() string {</span>
<span class="term-fg32">+	return &quot;optimism&quot;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Description returns a human-readable description of ChainConfig.
 func (c *ChainConfig) Description() string {
 	var banner string
<span class="term-fg36">@@ -481,6 +516,8 @@</span> 		network = &quot;unknown&quot;
 	}
 	banner += fmt.Sprintf(&quot;Chain ID:  %v (%s)\n&quot;, c.ChainID, network)
 	switch {
<span class="term-fg32">+	case c.Optimism != nil:</span>
<span class="term-fg32">+		banner += &quot;Consensus: Optimism\n&quot;</span>
 	case c.Ethash != nil:
 		if c.TerminalTotalDifficulty == nil {
 			banner += &quot;Consensus: Ethash (proof-of-work)\n&quot;
<span class="term-fg36">@@ -556,6 +593,9 @@</span> 	}
 	if c.PragueTime != nil {
 		banner += fmt.Sprintf(&quot; - Prague:                      @%-10v\n&quot;, *c.PragueTime)
 	}
<span class="term-fg32">+	if c.RegolithTime != nil {</span>
<span class="term-fg32">+		banner += fmt.Sprintf(&quot; - Regolith:                    @%-10v\n&quot;, *c.RegolithTime)</span>
<span class="term-fg32">+	}</span>
 	return banner
 }
&nbsp;
<span class="term-fg36">@@ -654,6 +694,34 @@</span> func (c *ChainConfig) IsPrague(time uint64) bool {
 	return isTimestampForked(c.PragueTime, time)
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; IsBedrock returns whether num is either equal to the Bedrock fork block or greater.</span>
<span class="term-fg32">+func (c *ChainConfig) IsBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return isBlockForked(c.BedrockBlock, num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsRegolith(time uint64) bool {</span>
<span class="term-fg32">+	return isTimestampForked(c.RegolithTime, time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimism returns whether the node is an optimism node or not.</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimism() bool {</span>
<span class="term-fg32">+	return c.Optimism != nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimismBedrock returns true iff this is an optimism node &amp; bedrock is active</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsBedrock(num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismRegolith(time uint64) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsRegolith(time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimismPreBedrock returns true iff this is an optimism node &amp; bedrock is not yet active</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismPreBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; !c.IsBedrock(num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; CheckCompatible checks whether scheduled fork transitions have been imported
 &#47;&#47; with a mismatching chain configuration.
 func (c *ChainConfig) CheckCompatible(newcfg *ChainConfig, height uint64, time uint64) *ConfigCompatError {
<span class="term-fg36">@@ -816,11 +884,17 @@</span> }
&nbsp;
 &#47;&#47; BaseFeeChangeDenominator bounds the amount the base fee can change between blocks.
 func (c *ChainConfig) BaseFeeChangeDenominator() uint64 {
<span class="term-fg32">+	if c.Optimism != nil {</span>
<span class="term-fg32">+		return c.Optimism.EIP1559Denominator</span>
<span class="term-fg32">+	}</span>
 	return DefaultBaseFeeChangeDenominator
 }
&nbsp;
 &#47;&#47; ElasticityMultiplier bounds the maximum gas limit an EIP-1559 block may have.
 func (c *ChainConfig) ElasticityMultiplier() uint64 {
<span class="term-fg32">+	if c.Optimism != nil {</span>
<span class="term-fg32">+		return c.Optimism.EIP1559Elasticity</span>
<span class="term-fg32">+	}</span>
 	return DefaultElasticityMultiplier
 }
&nbsp;
<span class="term-fg36">@@ -956,6 +1030,7 @@</span> 	IsHomestead, IsEIP150, IsEIP155, IsEIP158               bool
 	IsByzantium, IsConstantinople, IsPetersburg, IsIstanbul bool
 	IsBerlin, IsLondon                                      bool
 	IsMerge, IsShanghai, isCancun, isPrague                 bool
<span class="term-fg32">+	IsOptimismBedrock, IsOptimismRegolith                   bool</span>
 }
&nbsp;
 &#47;&#47; Rules ensures c&#39;s ChainID is not nil.
<span class="term-fg36">@@ -980,5 +1055,8 @@</span> 		IsMerge:          isMerge,
 		IsShanghai:       c.IsShanghai(timestamp),
 		isCancun:         c.IsCancun(timestamp),
 		isPrague:         c.IsPrague(timestamp),
<span class="term-fg32">+		&#47;&#47; Optimism</span>
<span class="term-fg32">+		IsOptimismBedrock:  c.IsOptimismBedrock(num),</span>
<span class="term-fg32">+		IsOptimismRegolith: c.IsOptimismRegolith(timestamp),</span>
 	}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-35b131b9fde0d72f93414766" role="button"
                   aria-expanded="false" aria-controls="id-35b131b9fde0d72f93414766">
                    <code>params/protocol_params.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/params/protocol_params.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/params/protocol_params.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-35b131b9fde0d72f93414766"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;protocol_params.go op-geth&#47;params&#47;protocol_params.go</span>
<span class="term-fg1">index bb703d0b74dce80d4f90c83f428eb54a0aedd780..e5a5b7f669951fa74cf635f0fec87bf717aa526c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;protocol_params.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;protocol_params.go</span>
<span class="term-fg36">@@ -16,7 +16,18 @@</span> &#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.
&nbsp;
 package params
&nbsp;
<span class="term-fg31">-import &quot;math&#47;big&quot;</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; The base fee portion of the transaction fee accumulates at this predeploy</span>
<span class="term-fg32">+	OptimismBaseFeeRecipient = common.HexToAddress(&quot;0x4200000000000000000000000000000000000019&quot;)</span>
<span class="term-fg32">+	&#47;&#47; The L1 portion of the transaction fee accumulates at this predeploy</span>
<span class="term-fg32">+	OptimismL1FeeRecipient = common.HexToAddress(&quot;0x420000000000000000000000000000000000001A&quot;)</span>
<span class="term-fg32">+)</span>
&nbsp;
 const (
 	GasLimitBoundDivisor uint64 = 1024               &#47;&#47; The bound divisor of the gas limit, used in update calculations.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0c647c5def0f8c4498ddb5ae" role="button"
                   aria-expanded="false" aria-controls="id-0c647c5def0f8c4498ddb5ae">
                    <code>core/genesis.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/genesis.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/genesis.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+22</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0c647c5def0f8c4498ddb5ae"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;genesis.go op-geth&#47;core&#47;genesis.go</span>
<span class="term-fg1">index 269c1486d31d824f238bfb9180b960aad137ef91..f012cb9d55c3488fddbd046075b402d9297c1da9 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;genesis.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;genesis.go</span>
<span class="term-fg36">@@ -268,6 +268,10 @@</span>
 &#47;&#47; ChainOverrides contains the changes to chain config.
 type ChainOverrides struct {
 	OverrideShanghai *uint64
<span class="term-fg32">+	&#47;&#47; optimism</span>
<span class="term-fg32">+	OverrideOptimismBedrock  *big.Int</span>
<span class="term-fg32">+	OverrideOptimismRegolith *uint64</span>
<span class="term-fg32">+	OverrideOptimism         *bool</span>
 }
&nbsp;
 &#47;&#47; SetupGenesisBlock writes or updates the genesis block in db.
<span class="term-fg36">@@ -293,8 +297,26 @@</span> 		return params.AllEthashProtocolChanges, common.Hash{}, errGenesisNoConfig
 	}
 	applyOverrides := func(config *params.ChainConfig) {
 		if config != nil {
<span class="term-fg32">+			if config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; config.ChainID.Cmp(params.OptimismGoerliChainId) == 0 {</span>
<span class="term-fg32">+				&#47;&#47; Apply Optimism Goerli regolith time</span>
<span class="term-fg32">+				config.RegolithTime = &amp;params.OptimismGoerliRegolithTime</span>
<span class="term-fg32">+			}</span>
 			if overrides != nil &amp;&amp; overrides.OverrideShanghai != nil {
 				config.ShanghaiTime = overrides.OverrideShanghai
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimismBedrock != nil {</span>
<span class="term-fg32">+				config.BedrockBlock = overrides.OverrideOptimismBedrock</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimismRegolith != nil {</span>
<span class="term-fg32">+				config.RegolithTime = overrides.OverrideOptimismRegolith</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimism != nil {</span>
<span class="term-fg32">+				if *overrides.OverrideOptimism {</span>
<span class="term-fg32">+					config.Optimism = &amp;params.OptimismConfig{</span>
<span class="term-fg32">+						EIP1559Elasticity:  10,</span>
<span class="term-fg32">+						EIP1559Denominator: 50,</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+				}</span>
 			}
 		}
 	}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-dd1b60d781f6662178f47b8c"role="button" aria-expanded="false" aria-controls="id-dd1b60d781f6662178f47b8c">
        
            <div class="col-12 col-sm-9 text-start"><h3>Chain config cleanup</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-dd1b60d781f6662178f47b8c">
        <div><p>The optimism Goerli testnet used clique-config data to make geth internals accept blocks.
Post-bedrock the beacon-consensus (i.e. follow Engine API) is now used, and the clique config is removed.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6084d7ba9e847099b35b09b6" role="button"
                   aria-expanded="false" aria-controls="id-6084d7ba9e847099b35b09b6">
                    <code>core/rawdb/accessors_metadata.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/rawdb/accessors_metadata.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/rawdb/accessors_metadata.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6084d7ba9e847099b35b09b6"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_metadata.go op-geth&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg1">index 2ff29d1add93938a5f76f621ce6b47af179d9aca..45ced36a4fd400cc84f60a9a9dffedd19cb7e1cf 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg36">@@ -64,6 +64,9 @@</span> 	if err := json.Unmarshal(data, &amp;config); err != nil {
 		log.Error(&quot;Invalid chain config JSON&quot;, &quot;hash&quot;, hash, &quot;err&quot;, err)
 		return nil
 	}
<span class="term-fg32">+	if config.Optimism != nil {</span>
<span class="term-fg32">+		config.Clique = nil &#47;&#47; get rid of legacy clique data in chain config (optimism goerli issue)</span>
<span class="term-fg32">+	}</span>
 	return &amp;config
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-a99bc51ddc6af90556c80b1d"role="button" aria-expanded="false" aria-controls="id-a99bc51ddc6af90556c80b1d">
        
            <div class="col-12 col-sm-9 text-start"><h3>Engine API modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+59</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-a99bc51ddc6af90556c80b1d">
        <div><p>The Engine API is extended to insert transactions into the block and optionally exclude the tx-pool,
to reproduce the exact block of the sequencer from just the inputs, as derived from L1 by the rollup-node.
See <a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md">L2 execution engine specs</a>.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e125cc12c9bbda417962caa7" role="button"
                   aria-expanded="false" aria-controls="id-e125cc12c9bbda417962caa7">
                    <code>beacon/engine/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/beacon/engine/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/beacon/engine/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e125cc12c9bbda417962caa7"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;types.go op-geth&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg1">index 07ebe544b438f4c0d356efc4362928c37de8062b..00128cf777744fba0aec75a29d5566ca968d20ce 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg36">@@ -34,12 +34,23 @@</span> type PayloadAttributes struct {
 	Timestamp             uint64              `json:&quot;timestamp&quot;             gencodec:&quot;required&quot;`
 	Random                common.Hash         `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 	SuggestedFeeRecipient common.Address      `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
<span class="term-fg31">-	Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`</span>
<span class="term-fg32">+	Withdrawals           []*types.Withdrawal `json:&quot;withdrawals,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Transactions is a field for rollups: the transactions list is forced into the block</span>
<span class="term-fg32">+	Transactions [][]byte `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; NoTxPool is a field for rollups: if true, the no transactions are taken out of the tx-pool,</span>
<span class="term-fg32">+	&#47;&#47; only transactions from the above Transactions list will be included.</span>
<span class="term-fg32">+	NoTxPool bool `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; GasLimit is a field for rollups: if set, this sets the exact gas limit the block produced with.</span>
<span class="term-fg32">+	GasLimit *uint64 `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 }
&nbsp;
 &#47;&#47; JSON type overrides for PayloadAttributes.
 type payloadAttributesMarshaling struct {
 	Timestamp hexutil.Uint64
<span class="term-fg32">+</span>
<span class="term-fg32">+	Transactions []hexutil.Bytes</span>
<span class="term-fg32">+	GasLimit     *hexutil.Uint64</span>
 }
&nbsp;
 &#47;&#47;go:generate go run github.com&#47;fjl&#47;gencodec -type ExecutableData -field-override executableDataMarshaling -out gen_ed.go</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b67697d14d8960bb87fad841" role="button"
                   aria-expanded="false" aria-controls="id-b67697d14d8960bb87fad841">
                    <code>beacon/engine/gen_blockparams.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/beacon/engine/gen_blockparams.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/beacon/engine/gen_blockparams.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b67697d14d8960bb87fad841"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;gen_blockparams.go op-geth&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg1">index 0dd2b52597ad5ddc7fc46d97c6c8878edf29d471..0a76475841a12886ef2f9eaadba0172f2708d2b4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg36">@@ -19,13 +19,24 @@</span> 	type PayloadAttributes struct {
 		Timestamp             hexutil.Uint64      `json:&quot;timestamp&quot;             gencodec:&quot;required&quot;`
 		Random                common.Hash         `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 		SuggestedFeeRecipient common.Address      `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
<span class="term-fg31">-		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`</span>
<span class="term-fg32">+		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		Transactions          []hexutil.Bytes     `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		NoTxPool              bool                `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		GasLimit              *hexutil.Uint64     `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 	}
 	var enc PayloadAttributes
 	enc.Timestamp = hexutil.Uint64(p.Timestamp)
 	enc.Random = p.Random
 	enc.SuggestedFeeRecipient = p.SuggestedFeeRecipient
 	enc.Withdrawals = p.Withdrawals
<span class="term-fg32">+	if p.Transactions != nil {</span>
<span class="term-fg32">+		enc.Transactions = make([]hexutil.Bytes, len(p.Transactions))</span>
<span class="term-fg32">+		for k, v := range p.Transactions {</span>
<span class="term-fg32">+			enc.Transactions[k] = v</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	enc.NoTxPool = p.NoTxPool</span>
<span class="term-fg32">+	enc.GasLimit = (*hexutil.Uint64)(p.GasLimit)</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -35,7 +46,10 @@</span> 	type PayloadAttributes struct {
 		Timestamp             *hexutil.Uint64     `json:&quot;timestamp&quot;             gencodec:&quot;required&quot;`
 		Random                *common.Hash        `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 		SuggestedFeeRecipient *common.Address     `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
<span class="term-fg31">-		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`</span>
<span class="term-fg32">+		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		Transactions          []hexutil.Bytes     `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		NoTxPool              *bool               `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		GasLimit              *hexutil.Uint64     `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 	}
 	var dec PayloadAttributes
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -55,6 +69,18 @@</span> 	}
 	p.SuggestedFeeRecipient = *dec.SuggestedFeeRecipient
 	if dec.Withdrawals != nil {
 		p.Withdrawals = dec.Withdrawals
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.Transactions != nil {</span>
<span class="term-fg32">+		p.Transactions = make([][]byte, len(dec.Transactions))</span>
<span class="term-fg32">+		for k, v := range dec.Transactions {</span>
<span class="term-fg32">+			p.Transactions[k] = v</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.NoTxPool != nil {</span>
<span class="term-fg32">+		p.NoTxPool = *dec.NoTxPool</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.GasLimit != nil {</span>
<span class="term-fg32">+		p.GasLimit = (*uint64)(dec.GasLimit)</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-601f378e671259b213ea6fa8" role="button"
                   aria-expanded="false" aria-controls="id-601f378e671259b213ea6fa8">
                    <code>eth/catalyst/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/catalyst/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/catalyst/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-601f378e671259b213ea6fa8"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;api.go op-geth&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg1">index fc7529c8f5d7bce0c42f3a3e89d836dc15115c37..8d5d301518be66b8bcb8a941e2ca66dd7e83a5dc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg36">@@ -72,7 +72,7 @@</span>
 	&#47;&#47; beaconUpdateConsensusTimeout is the max time allowed for a beacon client
 	&#47;&#47; to send a consensus update before it&#39;s considered offline and the user is
 	&#47;&#47; warned.
<span class="term-fg31">-	beaconUpdateConsensusTimeout = 30 * time.Second</span>
<span class="term-fg32">+	beaconUpdateConsensusTimeout = 2 * time.Minute</span>
&nbsp;
 	&#47;&#47; beaconUpdateWarnFrequency is the frequency at which to warn the user that
 	&#47;&#47; the beacon client is offline.
<span class="term-fg36">@@ -149,6 +149,9 @@</span> 		invalidBlocksHits: make(map[common.Hash]int),
 		invalidTipsets:    make(map[common.Hash]*types.Header),
 	}
 	eth.Downloader().SetBadBlockCallback(api.setInvalidAncestor)
<span class="term-fg32">+	if api.eth.BlockChain().Config().Optimism != nil { &#47;&#47; don&#39;t start the api heartbeat, there is no transition</span>
<span class="term-fg32">+		return api</span>
<span class="term-fg32">+	}</span>
 	go api.heartbeat()
&nbsp;
 	return api
<span class="term-fg36">@@ -298,7 +301,7 @@</span> 	} else if api.eth.BlockChain().CurrentBlock().Hash() == update.HeadBlockHash {
 		&#47;&#47; If the specified head matches with our local head, do nothing and keep
 		&#47;&#47; generating the payload. It&#39;s a special corner case that a few slots are
 		&#47;&#47; missing and we are requested to generate the payload in slot.
<span class="term-fg31">-	} else {</span>
<span class="term-fg32">+	} else if api.eth.BlockChain().Config().Optimism == nil { &#47;&#47; minor Engine API divergence: allow proposers to reorg their own chain</span>
 		&#47;&#47; If the head block is already in our canonical chain, the beacon client is
 		&#47;&#47; probably resyncing. Ignore the update.
 		log.Info(&quot;Ignoring beacon update to old head&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, update.HeadBlockHash, &quot;age&quot;, common.PrettyAge(time.Unix(int64(block.Time()), 0)), &quot;have&quot;, api.eth.BlockChain().CurrentBlock().Number)
<span class="term-fg36">@@ -342,12 +345,26 @@</span> 	&#47;&#47; If payload generation was requested, create a new block to be potentially
 	&#47;&#47; sealed by the beacon client. The payload will be requested later, and we
 	&#47;&#47; will replace it arbitrarily many times in between.
 	if payloadAttributes != nil {
<span class="term-fg32">+		if api.eth.BlockChain().Config().Optimism != nil &amp;&amp; payloadAttributes.GasLimit == nil {</span>
<span class="term-fg32">+			return engine.STATUS_INVALID, engine.InvalidPayloadAttributes.With(errors.New(&quot;gasLimit parameter is required&quot;))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		transactions := make(types.Transactions, 0, len(payloadAttributes.Transactions))</span>
<span class="term-fg32">+		for i, otx := range payloadAttributes.Transactions {</span>
<span class="term-fg32">+			var tx types.Transaction</span>
<span class="term-fg32">+			if err := tx.UnmarshalBinary(otx); err != nil {</span>
<span class="term-fg32">+				return engine.STATUS_INVALID, fmt.Errorf(&quot;transaction %d is not valid: %v&quot;, i, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			transactions = append(transactions, &amp;tx)</span>
<span class="term-fg32">+		}</span>
 		args := &amp;miner.BuildPayloadArgs{
 			Parent:       update.HeadBlockHash,
 			Timestamp:    payloadAttributes.Timestamp,
 			FeeRecipient: payloadAttributes.SuggestedFeeRecipient,
 			Random:       payloadAttributes.Random,
 			Withdrawals:  payloadAttributes.Withdrawals,
<span class="term-fg32">+			NoTxPool:     payloadAttributes.NoTxPool,</span>
<span class="term-fg32">+			Transactions: transactions,</span>
<span class="term-fg32">+			GasLimit:     payloadAttributes.GasLimit,</span>
 		}
 		id := args.Id()
 		&#47;&#47; If we already are busy generating this work, then we do not need</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-39b1fbb6c6b8594711ded020"role="button" aria-expanded="false" aria-controls="id-39b1fbb6c6b8594711ded020">
        
            <div class="col-12 col-sm-9 text-start"><h3>Block-building modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+72</span></div>
                <div class="text-start"><span class="text-danger">-10</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-39b1fbb6c6b8594711ded020">
        <div><p>The block-building code (in the &ldquo;miner&rdquo; package because of Proof-Of-Work legacy of ethereum) implements the
changes to support the transaction-inclusion, tx-pool toggle and gaslimit parameters of the Engine API.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4d0b38a4643552120684faa4" role="button"
                   aria-expanded="false" aria-controls="id-4d0b38a4643552120684faa4">
                    <code>miner/miner.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/miner/miner.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/miner/miner.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4d0b38a4643552120684faa4"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;miner.go op-geth&#47;miner&#47;miner.go</span>
<span class="term-fg1">index c969aec735469405966e7676eb0d44d169155541..aa17a57967a0bfcc11ee454460598be37a5e9c38 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;miner.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;miner.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> &#47;&#47; Package miner implements Ethereum block creation and mining.
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;sync&quot;
<span class="term-fg36">@@ -31,6 +32,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -41,6 +43,10 @@</span> &#47;&#47; to offer all the functions here.
 type Backend interface {
 	BlockChain() *core.BlockChain
 	TxPool() *txpool.TxPool
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type BackendWithHistoricalState interface {</span>
<span class="term-fg32">+	StateAtBlock(ctx context.Context, block *types.Block, reexec uint64, base *state.StateDB, readOnly bool, preferDisk bool) (*state.StateDB, tracers.StateReleaseFunc, error)</span>
 }
&nbsp;
 &#47;&#47; Config is the configuration parameters of mining.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c13aff36aa052d1ffe43245f" role="button"
                   aria-expanded="false" aria-controls="id-c13aff36aa052d1ffe43245f">
                    <code>miner/worker_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/miner/worker_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/miner/worker_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c13aff36aa052d1ffe43245f"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;worker_test.go op-geth&#47;miner&#47;worker_test.go</span>
<span class="term-fg1">index e60de679326cf18a3cc9bf0dbfb8ea9107864e68..46f0e0a8f1283e3dfa1f59e677941cbc1cb69ece 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;worker_test.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;worker_test.go</span>
<span class="term-fg36">@@ -635,7 +635,7 @@</span> 	}
&nbsp;
 	&#47;&#47; This API should work even when the automatic sealing is not enabled
 	for _, c := range cases {
<span class="term-fg31">-		block, _, err := w.getSealingBlock(c.parent, timestamp, c.coinbase, c.random, nil, false)</span>
<span class="term-fg32">+		block, _, err := w.getSealingBlock(c.parent, timestamp, c.coinbase, c.random, nil, false, nil, nil)</span>
 		if c.expectErr {
 			if err == nil {
 				t.Error(&quot;Expect error but get nil&quot;)
<span class="term-fg36">@@ -651,7 +651,7 @@</span>
 	&#47;&#47; This API should work even when the automatic sealing is enabled
 	w.start()
 	for _, c := range cases {
<span class="term-fg31">-		block, _, err := w.getSealingBlock(c.parent, timestamp, c.coinbase, c.random, nil, false)</span>
<span class="term-fg32">+		block, _, err := w.getSealingBlock(c.parent, timestamp, c.coinbase, c.random, nil, false, nil, nil)</span>
 		if c.expectErr {
 			if err == nil {
 				t.Error(&quot;Expect error but get nil&quot;)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a2d465282ef70dd579e3599c" role="button"
                   aria-expanded="false" aria-controls="id-a2d465282ef70dd579e3599c">
                    <code>miner/worker.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/miner/worker.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/miner/worker.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+42</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a2d465282ef70dd579e3599c"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;worker.go op-geth&#47;miner&#47;worker.go</span>
<span class="term-fg1">index 67a5842d23e0ddecfd019821081032a01ae69ea9..f09bc32058ed4813cff36738fffc58de4db53dfa 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;worker.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;worker.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg36">@@ -31,6 +32,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -794,6 +796,15 @@</span> func (w *worker) makeEnv(parent *types.Header, header *types.Header, coinbase common.Address) (*environment, error) {
 	&#47;&#47; Retrieve the parent state to execute on top and start a prefetcher for
 	&#47;&#47; the miner to speed block sealing up a bit.
 	state, err := w.chain.StateAt(parent.Root)
<span class="term-fg32">+	if err != nil &amp;&amp; w.chainConfig.Optimism != nil { &#47;&#47; Allow the miner to reorg its own chain arbitrarily deep</span>
<span class="term-fg32">+		if historicalBackend, ok := w.eth.(BackendWithHistoricalState); ok {</span>
<span class="term-fg32">+			var release tracers.StateReleaseFunc</span>
<span class="term-fg32">+			parentBlock := w.eth.BlockChain().GetBlockByHash(parent.Hash())</span>
<span class="term-fg32">+			state, release, err = historicalBackend.StateAtBlock(context.Background(), parentBlock, ^uint64(0), nil, false, false)</span>
<span class="term-fg32">+			state = state.Copy()</span>
<span class="term-fg32">+			release()</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -979,6 +990,9 @@</span> 	random      common.Hash       &#47;&#47; The randomness generated by beacon chain, empty before the merge
 	withdrawals types.Withdrawals &#47;&#47; List of withdrawals to include in block.
 	noUncle     bool              &#47;&#47; Flag whether the uncle block inclusion is allowed
 	noTxs       bool              &#47;&#47; Flag whether an empty block without any transaction is expected
<span class="term-fg32">+</span>
<span class="term-fg32">+	txs      types.Transactions &#47;&#47; Deposit transactions to include at the start of the block</span>
<span class="term-fg32">+	gasLimit *uint64            &#47;&#47; Optional gas limit override</span>
 }
&nbsp;
 &#47;&#47; prepareWork constructs the sealing task according to the given parameters,
<span class="term-fg36">@@ -1015,7 +1029,7 @@</span> 		Time:       timestamp,
 		Coinbase:   genParams.coinbase,
 	}
 	&#47;&#47; Set the extra field.
<span class="term-fg31">-	if len(w.extra) != 0 {</span>
<span class="term-fg32">+	if len(w.extra) != 0 &amp;&amp; w.chainConfig.Optimism == nil { &#47;&#47; Optimism chains must not set any extra data.</span>
 		header.Extra = w.extra
 	}
 	&#47;&#47; Set the randomness field from the beacon chain if it&#39;s available.
<span class="term-fg36">@@ -1029,6 +1043,12 @@</span> 		if !w.chainConfig.IsLondon(parent.Number) {
 			parentGasLimit := parent.GasLimit * w.chainConfig.ElasticityMultiplier()
 			header.GasLimit = core.CalcGasLimit(parentGasLimit, w.config.GasCeil)
 		}
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if genParams.gasLimit != nil { &#47;&#47; override gas limit if specified</span>
<span class="term-fg32">+		header.GasLimit = *genParams.gasLimit</span>
<span class="term-fg32">+	} else if w.chain.Config().Optimism != nil &amp;&amp; w.config.GasCeil != 0 {</span>
<span class="term-fg32">+		&#47;&#47; configure the gas limit of pending blocks with the miner gas limit config when using optimism</span>
<span class="term-fg32">+		header.GasLimit = w.config.GasCeil</span>
 	}
 	&#47;&#47; Run the consensus preparation with the default or customized consensus engine.
 	if err := w.engine.Prepare(w.chain, header); err != nil {
<span class="term-fg36">@@ -1094,14 +1114,28 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; generateWork generates a sealing block based on the given parameters.
<span class="term-fg31">-func (w *worker) generateWork(params *generateParams) (*types.Block, *big.Int, error) {</span>
<span class="term-fg31">-	work, err := w.prepareWork(params)</span>
<span class="term-fg32">+func (w *worker) generateWork(genParams *generateParams) (*types.Block, *big.Int, error) {</span>
<span class="term-fg32">+	work, err := w.prepareWork(genParams)</span>
 	if err != nil {
 		return nil, nil, err
 	}
 	defer work.discard()
<span class="term-fg32">+	if work.gasPool == nil {</span>
<span class="term-fg32">+		work.gasPool = new(core.GasPool).AddGas(work.header.GasLimit)</span>
<span class="term-fg32">+	}</span>
&nbsp;
<span class="term-fg31">-	if !params.noTxs {</span>
<span class="term-fg32">+	for _, tx := range genParams.txs {</span>
<span class="term-fg32">+		from, _ := types.Sender(work.signer, tx)</span>
<span class="term-fg32">+		work.state.SetTxContext(tx.Hash(), work.tcount)</span>
<span class="term-fg32">+		_, err := w.commitTransaction(work, tx)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, nil, fmt.Errorf(&quot;failed to force-include tx: %s type: %d sender: %s nonce: %d, err: %w&quot;, tx.Hash(), tx.Type(), from, tx.Nonce(), err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		work.tcount++</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; forced transactions done, fill rest of block with transactions</span>
<span class="term-fg32">+	if !genParams.noTxs {</span>
 		interrupt := new(int32)
 		timer := time.AfterFunc(w.newpayloadTimeout, func() {
 			atomic.StoreInt32(interrupt, commitInterruptTimeout)
<span class="term-fg36">@@ -1113,7 +1147,7 @@</span> 		if errors.Is(err, errBlockInterruptedByTimeout) {
 			log.Warn(&quot;Block building is interrupted&quot;, &quot;allowance&quot;, common.PrettyDuration(w.newpayloadTimeout))
 		}
 	}
<span class="term-fg31">-	block, err := w.engine.FinalizeAndAssemble(w.chain, work.header, work.state, work.txs, work.unclelist(), work.receipts, params.withdrawals)</span>
<span class="term-fg32">+	block, err := w.engine.FinalizeAndAssemble(w.chain, work.header, work.state, work.txs, work.unclelist(), work.receipts, genParams.withdrawals)</span>
 	if err != nil {
 		return nil, nil, err
 	}
<span class="term-fg36">@@ -1230,7 +1264,7 @@</span>
 &#47;&#47; getSealingBlock generates the sealing block based on the given parameters.
 &#47;&#47; The generation result will be passed back via the given channel no matter
 &#47;&#47; the generation itself succeeds or not.
<span class="term-fg31">-func (w *worker) getSealingBlock(parent common.Hash, timestamp uint64, coinbase common.Address, random common.Hash, withdrawals types.Withdrawals, noTxs bool) (*types.Block, *big.Int, error) {</span>
<span class="term-fg32">+func (w *worker) getSealingBlock(parent common.Hash, timestamp uint64, coinbase common.Address, random common.Hash, withdrawals types.Withdrawals, noTxs bool, transactions types.Transactions, gasLimit *uint64) (*types.Block, *big.Int, error) {</span>
 	req := &amp;getWorkReq{
 		params: &amp;generateParams{
 			timestamp:   timestamp,
<span class="term-fg36">@@ -1241,6 +1275,8 @@</span> 			random:      random,
 			withdrawals: withdrawals,
 			noUncle:     true,
 			noTxs:       noTxs,
<span class="term-fg32">+			txs:         transactions,</span>
<span class="term-fg32">+			gasLimit:    gasLimit,</span>
 		},
 		result: make(chan *newPayloadResult, 1),
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cfdd1beef8e0bac9b5712ca2" role="button"
                   aria-expanded="false" aria-controls="id-cfdd1beef8e0bac9b5712ca2">
                    <code>miner/payload_building.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/miner/payload_building.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/miner/payload_building.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+22</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cfdd1beef8e0bac9b5712ca2"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;payload_building.go op-geth&#47;miner&#47;payload_building.go</span>
<span class="term-fg1">index f84d908e86d68dbb132e2cd75ba5e21887fc018c..26e89eef31cab52754e0a41bb540639b4f58067f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;payload_building.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;payload_building.go</span>
<span class="term-fg36">@@ -40,6 +40,10 @@</span> 	Timestamp    uint64            &#47;&#47; The provided timestamp of generated payload
 	FeeRecipient common.Address    &#47;&#47; The provided recipient address for collecting transaction fee
 	Random       common.Hash       &#47;&#47; The provided randomness value
 	Withdrawals  types.Withdrawals &#47;&#47; The provided withdrawals
<span class="term-fg32">+</span>
<span class="term-fg32">+	NoTxPool     bool                 &#47;&#47; Optimism addition: option to disable tx pool contents from being included</span>
<span class="term-fg32">+	Transactions []*types.Transaction &#47;&#47; Optimism addition: txs forced into the block via engine API</span>
<span class="term-fg32">+	GasLimit     *uint64              &#47;&#47; Optimism addition: override gas limit of the block to build</span>
 }
&nbsp;
 &#47;&#47; Id computes an 8-byte identifier by hashing the components of the payload arguments.
<span class="term-fg36">@@ -51,6 +55,19 @@</span> 	binary.Write(hasher, binary.BigEndian, args.Timestamp)
 	hasher.Write(args.Random[:])
 	hasher.Write(args.FeeRecipient[:])
 	rlp.Encode(hasher, args.Withdrawals)
<span class="term-fg32">+</span>
<span class="term-fg32">+	if args.NoTxPool || len(args.Transactions) &gt; 0 { &#47;&#47; extend if extra payload attributes are used</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, args.NoTxPool)</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, uint64(len(args.Transactions)))</span>
<span class="term-fg32">+		for _, tx := range args.Transactions {</span>
<span class="term-fg32">+			h := tx.Hash()</span>
<span class="term-fg32">+			hasher.Write(h[:])</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if args.GasLimit != nil {</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, *args.GasLimit)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var out engine.PayloadID
 	copy(out[:], hasher.Sum(nil)[:8])
 	return out
<span class="term-fg36">@@ -156,12 +173,15 @@</span> func (w *worker) buildPayload(args *BuildPayloadArgs) (*Payload, error) {
 	&#47;&#47; Build the initial version with no transaction included. It should be fast
 	&#47;&#47; enough to run. The empty payload can at least make sure there is something
 	&#47;&#47; to deliver for not missing slot.
<span class="term-fg31">-	empty, _, err := w.getSealingBlock(args.Parent, args.Timestamp, args.FeeRecipient, args.Random, args.Withdrawals, true)</span>
<span class="term-fg32">+	empty, _, err := w.getSealingBlock(args.Parent, args.Timestamp, args.FeeRecipient, args.Random, args.Withdrawals, true, args.Transactions, args.GasLimit)</span>
 	if err != nil {
 		return nil, err
 	}
 	&#47;&#47; Construct a payload object for return.
 	payload := newPayload(empty, args.Id())
<span class="term-fg32">+	if args.NoTxPool { &#47;&#47; don&#39;t start the background payload updating job if there is no tx pool to pull from</span>
<span class="term-fg32">+		return payload, nil</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Spin up a routine for updating the payload in background. This strategy
 	&#47;&#47; can maximum the revenue for including transactions with highest fee.
<span class="term-fg36">@@ -180,7 +200,7 @@</span> 		for {
 			select {
 			case &lt;-timer.C:
 				start := time.Now()
<span class="term-fg31">-				block, fees, err := w.getSealingBlock(args.Parent, args.Timestamp, args.FeeRecipient, args.Random, args.Withdrawals, false)</span>
<span class="term-fg32">+				block, fees, err := w.getSealingBlock(args.Parent, args.Timestamp, args.FeeRecipient, args.Random, args.Withdrawals, false, args.Transactions, args.GasLimit)</span>
 				if err == nil {
 					payload.update(block, fees, time.Since(start))
 				}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4400cdf25c415c1cd55e0a3f"role="button" aria-expanded="false" aria-controls="id-4400cdf25c415c1cd55e0a3f">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tx-pool tx cost updates</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+102</span></div>
                <div class="text-start"><span class="text-danger">-45</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4400cdf25c415c1cd55e0a3f">
        <div><p>Transaction queueing and inclusion needs to account for the L1 cost component.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8ee5a2b1e7c8573a33a7ae04" role="button"
                   aria-expanded="false" aria-controls="id-8ee5a2b1e7c8573a33a7ae04">
                    <code>core/txpool/list.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/txpool/list.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/txpool/list.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+15</span></div>
                        <div class="text-start"><span class="text-danger">-9</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8ee5a2b1e7c8573a33a7ae04"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;list.go op-geth&#47;core&#47;txpool&#47;list.go</span>
<span class="term-fg1">index 724bb6caca9923803eacf03d202cabaeb1ad44e2..2aaaa7678337172bf80ac85d2e779a426fdd72d5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;list.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;list.go</span>
<span class="term-fg36">@@ -246,6 +246,15 @@</span> 	cache := m.flatten()
 	return cache[len(cache)-1]
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; FirstElement returns the first element from the heap (guaranteed to be lowest), thus, the</span>
<span class="term-fg32">+&#47;&#47; transaction with the lowest nonce. Returns nil if there are no elements.</span>
<span class="term-fg32">+func (m *sortedMap) FirstElement() *types.Transaction {</span>
<span class="term-fg32">+	if m.Len() == 0 {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return m.Get((*m.index)[0])</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; list is a &quot;list&quot; of transactions belonging to an account, sorted by account
 &#47;&#47; nonce. The same type can be used both for storing contiguous transactions for
 &#47;&#47; the executable&#47;pending queue; and for storing gapped transactions for the non-
<span class="term-fg36">@@ -508,10 +517,7 @@</span> &#47;&#47; better candidates for inclusion while in other cases (at the top of the baseFee peak)
 &#47;&#47; the floating heap is better. When baseFee is decreasing they behave similarly.
 type pricedList struct {
 	&#47;&#47; Number of stale price points to (re-heap trigger).
<span class="term-fg31">-	&#47;&#47; This field is accessed atomically, and must be the first field</span>
<span class="term-fg31">-	&#47;&#47; to ensure it has correct alignment for atomic.AddInt64.</span>
<span class="term-fg31">-	&#47;&#47; See https:&#47;&#47;golang.org&#47;pkg&#47;sync&#47;atomic&#47;#pkg-note-BUG.</span>
<span class="term-fg31">-	stales int64</span>
<span class="term-fg32">+	stales atomic.Int64</span>
&nbsp;
 	all              *lookup    &#47;&#47; Pointer to the map of all transactions
 	urgent, floating priceHeap  &#47;&#47; Heaps of prices of all the stored **remote** transactions
<span class="term-fg36">@@ -545,7 +551,7 @@</span> &#47;&#47; from the pool. The list will just keep a counter of stale objects and update
 &#47;&#47; the heap if a large enough ratio of transactions go stale.
 func (l *pricedList) Removed(count int) {
 	&#47;&#47; Bump the stale counter, but exit if still too low (&lt; 25%)
<span class="term-fg31">-	stales := atomic.AddInt64(&amp;l.stales, int64(count))</span>
<span class="term-fg32">+	stales := l.stales.Add(int64(count))</span>
 	if int(stales) &lt;= (len(l.urgent.list)+len(l.floating.list))&#47;4 {
 		return
 	}
<span class="term-fg36">@@ -570,7 +576,7 @@</span> 	&#47;&#47; Discard stale price points if found at the heap start
 	for len(h.list) &gt; 0 {
 		head := h.list[0]
 		if l.all.GetRemote(head.Hash()) == nil { &#47;&#47; Removed or migrated
<span class="term-fg31">-			atomic.AddInt64(&amp;l.stales, -1)</span>
<span class="term-fg32">+			l.stales.Add(-1)</span>
 			heap.Pop(h)
 			continue
 		}
<span class="term-fg36">@@ -597,7 +603,7 @@</span> 		if len(l.urgent.list)*floatingRatio &gt; len(l.floating.list)*urgentRatio || floatingRatio == 0 {
 			&#47;&#47; Discard stale transactions if found during cleanup
 			tx := heap.Pop(&amp;l.urgent).(*types.Transaction)
 			if l.all.GetRemote(tx.Hash()) == nil { &#47;&#47; Removed or migrated
<span class="term-fg31">-				atomic.AddInt64(&amp;l.stales, -1)</span>
<span class="term-fg32">+				l.stales.Add(-1)</span>
 				continue
 			}
 			&#47;&#47; Non stale transaction found, move to floating heap
<span class="term-fg36">@@ -610,7 +616,7 @@</span> 			}
 			&#47;&#47; Discard stale transactions if found during cleanup
 			tx := heap.Pop(&amp;l.floating).(*types.Transaction)
 			if l.all.GetRemote(tx.Hash()) == nil { &#47;&#47; Removed or migrated
<span class="term-fg31">-				atomic.AddInt64(&amp;l.stales, -1)</span>
<span class="term-fg32">+				l.stales.Add(-1)</span>
 				continue
 			}
 			&#47;&#47; Non stale transaction found, discard it
<span class="term-fg36">@@ -633,7 +639,7 @@</span> func (l *pricedList) Reheap() {
 	l.reheapMu.Lock()
 	defer l.reheapMu.Unlock()
 	start := time.Now()
<span class="term-fg31">-	atomic.StoreInt64(&amp;l.stales, 0)</span>
<span class="term-fg32">+	l.stales.Store(0)</span>
 	l.urgent.list = make([]*types.Transaction, 0, l.all.RemoteCount())
 	l.all.Range(func(hash common.Hash, tx *types.Transaction, local bool) bool {
 		l.urgent.list = append(l.urgent.list, tx)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6e47f6ec7431313f381d9ac8" role="button"
                   aria-expanded="false" aria-controls="id-6e47f6ec7431313f381d9ac8">
                    <code>core/txpool/txpool2_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/txpool/txpool2_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/txpool/txpool2_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6e47f6ec7431313f381d9ac8"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;txpool2_test.go op-geth&#47;core&#47;txpool&#47;txpool2_test.go</span>
<span class="term-fg1">index 20d6dd713a95d7022d98d4c3011ef106a09ee9e6..6d84975d83f9544abdf1607bbf2da28c89209ec8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;txpool2_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;txpool2_test.go</span>
<span class="term-fg36">@@ -79,7 +79,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the limit enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
 	config := testTxPoolConfig
 	config.GlobalQueue = 100
 	config.GlobalSlots = 100
<span class="term-fg36">@@ -115,7 +115,7 @@</span> func TestTransactionFuture1559(t *testing.T) {
 	t.Parallel()
 	&#47;&#47; Create the pool to test the pricing enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
 	pool := NewTxPool(testTxPoolConfig, eip1559Config, blockchain)
 	defer pool.Stop()
&nbsp;
<span class="term-fg36">@@ -147,7 +147,7 @@</span> func TestTransactionZAttack(t *testing.T) {
 	t.Parallel()
 	&#47;&#47; Create the pool to test the pricing enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
 	pool := NewTxPool(testTxPoolConfig, eip1559Config, blockchain)
 	defer pool.Stop()
 	&#47;&#47; Create a number of test accounts, fund them and make transactions</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9cffbebabbb8e052e0a7aaf4" role="button"
                   aria-expanded="false" aria-controls="id-9cffbebabbb8e052e0a7aaf4">
                    <code>core/txpool/txpool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/txpool/txpool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/txpool/txpool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+55</span></div>
                        <div class="text-start"><span class="text-danger">-10</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9cffbebabbb8e052e0a7aaf4"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;txpool.go op-geth&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg1">index 4306d5aee6f5a6a77f63a88f92257b28b3972eea..8bfd8dbba76bae9f3a6b6e70096fd1167aefad6f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg36">@@ -17,14 +17,12 @@</span>
 package txpool
&nbsp;
 import (
<span class="term-fg31">-	&quot;container&#47;heap&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&quot;
 	&quot;math&#47;big&quot;
 	&quot;sort&quot;
 	&quot;sync&quot;
<span class="term-fg31">-	&quot;sync&#47;atomic&quot;</span>
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -261,6 +259,8 @@</span> 	currentState  *state.StateDB &#47;&#47; Current state in the blockchain head
 	pendingNonces *noncer        &#47;&#47; Pending state tracking virtual nonces
 	currentMaxGas uint64         &#47;&#47; Current gas limit for transaction caps
&nbsp;
<span class="term-fg32">+	l1CostFn func(dataGas types.RollupGasData, isDepositTx bool) *big.Int &#47;&#47; Current L1 fee cost function</span>
<span class="term-fg32">+</span>
 	locals  *accountSet &#47;&#47; Set of local transaction to exempt from eviction rules
 	journal *journal    &#47;&#47; Journal of local transaction to back up to disk
&nbsp;
<span class="term-fg36">@@ -384,7 +384,7 @@</span> 		case &lt;-report.C:
 			pool.mu.RLock()
 			pending, queued := pool.stats()
 			pool.mu.RUnlock()
<span class="term-fg31">-			stales := int(atomic.LoadInt64(&amp;pool.priced.stales))</span>
<span class="term-fg32">+			stales := int(pool.priced.stales.Load())</span>
&nbsp;
 			if pending != prevPending || queued != prevQueued || stales != prevStales {
 				log.Debug(&quot;Transaction pool status report&quot;, &quot;executable&quot;, pending, &quot;queued&quot;, queued, &quot;stales&quot;, stales)
<span class="term-fg36">@@ -597,6 +597,12 @@</span>
 &#47;&#47; validateTx checks whether a transaction is valid according to the consensus
 &#47;&#47; rules and adheres to some heuristic limits of the local node (price and size).
 func (pool *TxPool) validateTx(tx *types.Transaction, local bool) error {
<span class="term-fg32">+	&#47;&#47; No unauthenticated deposits allowed in the transaction pool.</span>
<span class="term-fg32">+	&#47;&#47; This is for spam protection, not consensus,</span>
<span class="term-fg32">+	&#47;&#47; as the external engine-API user authenticates deposits.</span>
<span class="term-fg32">+	if tx.Type() == types.DepositTxType {</span>
<span class="term-fg32">+		return core.ErrTxTypeNotSupported</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Accept only legacy transactions until EIP-2718&#47;2930 activates.
 	if !pool.eip2718 &amp;&amp; tx.Type() != types.LegacyTxType {
 		return core.ErrTxTypeNotSupported
<span class="term-fg36">@@ -648,18 +654,26 @@</span> 		return core.ErrNonceTooLow
 	}
 	&#47;&#47; Transactor should have enough funds to cover the costs
 	&#47;&#47; cost == V + GP * GL
<span class="term-fg32">+	cost := tx.Cost()</span>
<span class="term-fg32">+	if l1Cost := pool.l1CostFn(tx.RollupDataGas(), tx.IsDepositTx()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+		cost = cost.Add(cost, l1Cost)</span>
<span class="term-fg32">+	}</span>
 	balance := pool.currentState.GetBalance(from)
<span class="term-fg31">-	if balance.Cmp(tx.Cost()) &lt; 0 {</span>
<span class="term-fg32">+	if balance.Cmp(cost) &lt; 0 {</span>
 		return core.ErrInsufficientFunds
 	}
&nbsp;
 	&#47;&#47; Verify that replacing transactions will not result in overdraft
 	list := pool.pending[from]
 	if list != nil { &#47;&#47; Sender already has pending txs
<span class="term-fg31">-		sum := new(big.Int).Add(tx.Cost(), list.totalcost)</span>
<span class="term-fg32">+		sum := new(big.Int).Add(cost, list.totalcost)</span>
 		if repl := list.txs.Get(tx.Nonce()); repl != nil {
 			&#47;&#47; Deduct the cost of a transaction replaced by this
<span class="term-fg31">-			sum.Sub(sum, repl.Cost())</span>
<span class="term-fg32">+			replL1Cost := repl.Cost()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(tx.RollupDataGas(), tx.IsDepositTx()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+				replL1Cost = replL1Cost.Add(cost, l1Cost)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			sum.Sub(sum, replL1Cost)</span>
 		}
 		if balance.Cmp(sum) &lt; 0 {
 			log.Trace(&quot;Replacing transactions would overdraft&quot;, &quot;sender&quot;, from, &quot;balance&quot;, pool.currentState.GetBalance(from), &quot;required&quot;, sum)
<span class="term-fg36">@@ -738,7 +752,7 @@</span> 			return false, ErrTxPoolOverflow
 		}
&nbsp;
 		&#47;&#47; If the new transaction is a future transaction it should never churn pending transactions
<span class="term-fg31">-		if pool.isFuture(from, tx) {</span>
<span class="term-fg32">+		if !isLocal &amp;&amp; pool.isFuture(from, tx) {</span>
 			var replacesPending bool
 			for _, dropTx := range drop {
 				dropSender, _ := types.Sender(pool.signer, dropTx)
<span class="term-fg36">@@ -750,7 +764,7 @@</span> 			}
 			&#47;&#47; Add all transactions back to the priced queue
 			if replacesPending {
 				for _, dropTx := range drop {
<span class="term-fg31">-					heap.Push(&amp;pool.priced.urgent, dropTx)</span>
<span class="term-fg32">+					pool.priced.Put(dropTx, false)</span>
 				}
 				log.Trace(&quot;Discarding future transaction replacing pending tx&quot;, &quot;hash&quot;, hash)
 				return false, ErrFutureReplacePending
<span class="term-fg36">@@ -1351,6 +1365,16 @@</span> 						log.Error(&quot;Unrooted new chain seen by tx pool&quot;, &quot;block&quot;, newHead.Number, &quot;hash&quot;, newHead.Hash())
 						return
 					}
 				}
<span class="term-fg32">+				&#47;&#47; Do not insert deposit txs back into the pool</span>
<span class="term-fg32">+				&#47;&#47; (validateTx would still catch it if not filtered, but no need to re-inject in the first place).</span>
<span class="term-fg32">+				j := 0</span>
<span class="term-fg32">+				for _, tx := range discarded {</span>
<span class="term-fg32">+					if tx.Type() != types.DepositTxType {</span>
<span class="term-fg32">+						discarded[j] = tx</span>
<span class="term-fg32">+						j++</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+				discarded = discarded[:j]</span>
 				reinject = types.TxDifference(discarded, included)
 			}
 		}
<span class="term-fg36">@@ -1368,6 +1392,11 @@</span> 	pool.currentState = statedb
 	pool.pendingNonces = newNoncer(statedb)
 	pool.currentMaxGas = newHead.GasLimit
&nbsp;
<span class="term-fg32">+	costFn := types.NewL1CostFunc(pool.chainconfig, statedb)</span>
<span class="term-fg32">+	pool.l1CostFn = func(dataGas types.RollupGasData, isDepositTx bool) *big.Int {</span>
<span class="term-fg32">+		return costFn(newHead.Number.Uint64(), newHead.Time, dataGas, isDepositTx)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Inject any transactions discarded due to reorgs
 	log.Debug(&quot;Reinjecting stale transactions&quot;, &quot;count&quot;, len(reinject))
 	core.SenderCacher.Recover(pool.signer, reinject)
<span class="term-fg36">@@ -1401,8 +1430,16 @@</span> 			hash := tx.Hash()
 			pool.all.Remove(hash)
 		}
 		log.Trace(&quot;Removed old queued transactions&quot;, &quot;count&quot;, len(forwards))
<span class="term-fg32">+		balance := pool.currentState.GetBalance(addr)</span>
<span class="term-fg32">+		if !list.Empty() {</span>
<span class="term-fg32">+			&#47;&#47; Reduce the cost-cap by L1 rollup cost of the first tx if necessary. Other txs will get filtered out afterwards.</span>
<span class="term-fg32">+			el := list.txs.FirstElement()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(el.RollupDataGas(), el.IsDepositTx()); l1Cost != nil {</span>
<span class="term-fg32">+				balance = new(big.Int).Sub(balance, l1Cost) &#47;&#47; negative big int is fine</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; Drop all transactions that are too costly (low balance or out of gas)
<span class="term-fg31">-		drops, _ := list.Filter(pool.currentState.GetBalance(addr), pool.currentMaxGas)</span>
<span class="term-fg32">+		drops, _ := list.Filter(balance, pool.currentMaxGas)</span>
 		for _, tx := range drops {
 			hash := tx.Hash()
 			pool.all.Remove(hash)
<span class="term-fg36">@@ -1598,8 +1635,16 @@</span> 			hash := tx.Hash()
 			pool.all.Remove(hash)
 			log.Trace(&quot;Removed old pending transaction&quot;, &quot;hash&quot;, hash)
 		}
<span class="term-fg32">+		balance := pool.currentState.GetBalance(addr)</span>
<span class="term-fg32">+		if !list.Empty() {</span>
<span class="term-fg32">+			&#47;&#47; Reduce the cost-cap by L1 rollup cost of the first tx if necessary. Other txs will get filtered out afterwards.</span>
<span class="term-fg32">+			el := list.txs.FirstElement()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(el.RollupDataGas(), el.IsDepositTx()); l1Cost != nil {</span>
<span class="term-fg32">+				balance = new(big.Int).Sub(balance, l1Cost) &#47;&#47; negative big int is fine</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; Drop all transactions that are too costly (low balance or out of gas), and queue any invalids back for later
<span class="term-fg31">-		drops, invalids := list.Filter(pool.currentState.GetBalance(addr), pool.currentMaxGas)</span>
<span class="term-fg32">+		drops, invalids := list.Filter(balance, pool.currentMaxGas)</span>
 		for _, tx := range drops {
 			hash := tx.Hash()
 			log.Trace(&quot;Removed unpayable pending transaction&quot;, &quot;hash&quot;, hash)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-72c6e5895446f71f4bfcea0e" role="button"
                   aria-expanded="false" aria-controls="id-72c6e5895446f71f4bfcea0e">
                    <code>core/txpool/txpool_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/txpool/txpool_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/txpool/txpool_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+29</span></div>
                        <div class="text-start"><span class="text-danger">-23</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-72c6e5895446f71f4bfcea0e"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;txpool_test.go op-geth&#47;core&#47;txpool&#47;txpool_test.go</span>
<span class="term-fg1">index c4c62db2d6da7d0fd896bc5ff37372e40102751f..7771c5f7cda1464489943454f72869924285ed6a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;txpool_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;txpool_test.go</span>
<span class="term-fg36">@@ -59,15 +59,21 @@</span> 	eip1559Config.LondonBlock = common.Big0
 }
&nbsp;
 type testBlockChain struct {
<span class="term-fg31">-	gasLimit      uint64 &#47;&#47; must be first field for 64 bit alignment (atomic access)</span>
<span class="term-fg32">+	gasLimit      atomic.Uint64</span>
 	statedb       *state.StateDB
 	chainHeadFeed *event.Feed
 }
&nbsp;
<span class="term-fg32">+func newTestBlockChain(gasLimit uint64, statedb *state.StateDB, chainHeadFeed *event.Feed) *testBlockChain {</span>
<span class="term-fg32">+	bc := testBlockChain{statedb: statedb, chainHeadFeed: new(event.Feed)}</span>
<span class="term-fg32">+	bc.gasLimit.Store(gasLimit)</span>
<span class="term-fg32">+	return &amp;bc</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func (bc *testBlockChain) CurrentBlock() *types.Header {
 	return &amp;types.Header{
 		Number:   new(big.Int),
<span class="term-fg31">-		GasLimit: atomic.LoadUint64(&amp;bc.gasLimit),</span>
<span class="term-fg32">+		GasLimit: bc.gasLimit.Load(),</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -121,7 +127,7 @@</span> }
&nbsp;
 func setupPoolWithConfig(config *params.ChainConfig) (*TxPool, *ecdsa.PrivateKey) {
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{10000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(10000000, statedb, new(event.Feed))</span>
&nbsp;
 	key, _ := crypto.GenerateKey()
 	pool := NewTxPool(testTxPoolConfig, config, blockchain)
<span class="term-fg36">@@ -236,7 +242,7 @@</span> 	)
&nbsp;
 	&#47;&#47; setup pool with 2 transaction in it
 	statedb.SetBalance(address, new(big.Int).SetUint64(params.Ether))
<span class="term-fg31">-	blockchain := &amp;testChain{&amp;testBlockChain{1000000000, statedb, new(event.Feed)}, address, &amp;trigger}</span>
<span class="term-fg32">+	blockchain := &amp;testChain{newTestBlockChain(1000000000, statedb, new(event.Feed)), address, &amp;trigger}</span>
&nbsp;
 	tx0 := transaction(0, 100000, key)
 	tx1 := transaction(1, 100000, key)
<span class="term-fg36">@@ -430,7 +436,7 @@</span> 	resetState := func() {
 		statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
 		statedb.AddBalance(addr, big.NewInt(100000000000000))
&nbsp;
<span class="term-fg31">-		pool.chain = &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+		pool.chain = newTestBlockChain(1000000, statedb, new(event.Feed))</span>
 		&lt;-pool.requestReset(nil, nil)
 	}
 	resetState()
<span class="term-fg36">@@ -459,7 +465,7 @@</span> 	resetState := func() {
 		statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
 		statedb.AddBalance(addr, big.NewInt(100000000000000))
&nbsp;
<span class="term-fg31">-		pool.chain = &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+		pool.chain = newTestBlockChain(1000000, statedb, new(event.Feed))</span>
 		&lt;-pool.requestReset(nil, nil)
 	}
 	resetState()
<span class="term-fg36">@@ -629,7 +635,7 @@</span> 	if pool.all.Count() != 4 {
 		t.Errorf(&quot;total transaction mismatch: have %d, want %d&quot;, pool.all.Count(), 4)
 	}
 	&#47;&#47; Reduce the block gas limit, check that invalidated transactions are dropped
<span class="term-fg31">-	atomic.StoreUint64(&amp;pool.chain.(*testBlockChain).gasLimit, 100)</span>
<span class="term-fg32">+	pool.chain.(*testBlockChain).gasLimit.Store(100)</span>
 	&lt;-pool.requestReset(nil, nil)
&nbsp;
 	if _, ok := pool.pending[account].txs.items[tx0.Nonce()]; !ok {
<span class="term-fg36">@@ -657,7 +663,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the postponing with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	pool := NewTxPool(testTxPoolConfig, params.TestChainConfig, blockchain)
 	defer pool.Stop()
<span class="term-fg36">@@ -869,7 +875,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the limit enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	config := testTxPoolConfig
 	config.NoLocals = nolocals
<span class="term-fg36">@@ -961,7 +967,7 @@</span> 	evictionInterval = time.Millisecond * 100
&nbsp;
 	&#47;&#47; Create the pool to test the non-expiration enforcement
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	config := testTxPoolConfig
 	config.Lifetime = time.Second
<span class="term-fg36">@@ -1146,7 +1152,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the limit enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	config := testTxPoolConfig
 	config.GlobalSlots = config.AccountSlots * 10
<span class="term-fg36">@@ -1248,7 +1254,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the limit enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	config := testTxPoolConfig
 	config.AccountSlots = 2
<span class="term-fg36">@@ -1282,7 +1288,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the limit enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	config := testTxPoolConfig
 	config.GlobalSlots = 1
<span class="term-fg36">@@ -1330,7 +1336,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the pricing enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	pool := NewTxPool(testTxPoolConfig, params.TestChainConfig, blockchain)
 	defer pool.Stop()
<span class="term-fg36">@@ -1578,7 +1584,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the pricing enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	pool := NewTxPool(testTxPoolConfig, eip1559Config, blockchain)
 	defer pool.Stop()
<span class="term-fg36">@@ -1651,7 +1657,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the pricing enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	config := testTxPoolConfig
 	config.GlobalSlots = 2
<span class="term-fg36">@@ -1765,7 +1771,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the pricing enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	config := testTxPoolConfig
 	config.GlobalSlots = 128
<span class="term-fg36">@@ -1997,7 +2003,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the pricing enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	pool := NewTxPool(testTxPoolConfig, params.TestChainConfig, blockchain)
 	defer pool.Stop()
<span class="term-fg36">@@ -2063,7 +2069,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the pricing enforcement with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	pool := NewTxPool(testTxPoolConfig, params.TestChainConfig, blockchain)
 	defer pool.Stop()
<span class="term-fg36">@@ -2268,7 +2274,7 @@</span> 	os.Remove(journal)
&nbsp;
 	&#47;&#47; Create the original pool to inject transaction into the journal
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	config := testTxPoolConfig
 	config.NoLocals = nolocals
<span class="term-fg36">@@ -2310,7 +2316,7 @@</span> 	}
 	&#47;&#47; Terminate the old pool, bump the local nonce, create a new pool and ensure relevant transaction survive
 	pool.Stop()
 	statedb.SetNonce(crypto.PubkeyToAddress(local.PublicKey), 1)
<span class="term-fg31">-	blockchain = &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain = newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	pool = NewTxPool(config, params.TestChainConfig, blockchain)
&nbsp;
<span class="term-fg36">@@ -2337,7 +2343,7 @@</span> 	time.Sleep(2 * config.Rejournal)
 	pool.Stop()
&nbsp;
 	statedb.SetNonce(crypto.PubkeyToAddress(local.PublicKey), 1)
<span class="term-fg31">-	blockchain = &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain = newTestBlockChain(1000000, statedb, new(event.Feed))</span>
 	pool = NewTxPool(config, params.TestChainConfig, blockchain)
&nbsp;
 	pending, queued = pool.Stats()
<span class="term-fg36">@@ -2366,7 +2372,7 @@</span> 	t.Parallel()
&nbsp;
 	&#47;&#47; Create the pool to test the status retrievals with
 	statedb, _ := state.New(common.Hash{}, state.NewDatabase(rawdb.NewMemoryDatabase()), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{1000000, statedb, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := newTestBlockChain(1000000, statedb, new(event.Feed))</span>
&nbsp;
 	pool := NewTxPool(testTxPoolConfig, params.TestChainConfig, blockchain)
 	defer pool.Stop()</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-28f7ef5a76ee33f42d45d293"role="button" aria-expanded="false" aria-controls="id-28f7ef5a76ee33f42d45d293">
        
            <div class="col-12 col-sm-9 text-start"><h2>Node modifications</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+138</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-28f7ef5a76ee33f42d45d293">
        <div><p>Changes to the node configuration and services.</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-24591d69430a7662e9651213"role="button" aria-expanded="false" aria-controls="id-24591d69430a7662e9651213">
        
            <div class="col-12 col-sm-9 text-start"><h3>CLI</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+107</span></div>
                <div class="text-start"><span class="text-danger">-11</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-24591d69430a7662e9651213">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-b9689cbef02e196c8a60aab2"role="button" aria-expanded="false" aria-controls="id-b9689cbef02e196c8a60aab2">
        
            <div class="col-12 col-sm-9 text-start"><h4>Flags</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+77</span></div>
                <div class="text-start"><span class="text-danger">-5</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-b9689cbef02e196c8a60aab2">
        <div><p>Flag changes:
  - Transactions can be forwarded to an RPC for sequencing.
  - Historical calls can be forwarded to a legacy node.
  - The tx pool propagation can be enabled/disabled.
  - The Optimism bedrock fork activation can be changed for testing.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5a8b670c423f8ff970a21037" role="button"
                   aria-expanded="false" aria-controls="id-5a8b670c423f8ff970a21037">
                    <code>cmd/utils/flags.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/cmd/utils/flags.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/cmd/utils/flags.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+56</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5a8b670c423f8ff970a21037"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;utils&#47;flags.go op-geth&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg1">index 08de71ee831bfb9e29441c76226842e748108702..7b17390d97dff41d3cfe9b57bd0bc8e24b75bcf1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg36">@@ -34,6 +34,10 @@</span> 	&quot;strconv&quot;
 	&quot;strings&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	pcsclite &quot;github.com&#47;gballet&#47;go-libpcsclite&quot;</span>
<span class="term-fg32">+	gopsutil &quot;github.com&#47;shirou&#47;gopsutil&#47;mem&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;urfave&#47;cli&#47;v2&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -74,9 +78,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;netutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg31">-	pcsclite &quot;github.com&#47;gballet&#47;go-libpcsclite&quot;</span>
<span class="term-fg31">-	gopsutil &quot;github.com&#47;shirou&#47;gopsutil&#47;mem&quot;</span>
<span class="term-fg31">-	&quot;github.com&#47;urfave&#47;cli&#47;v2&quot;</span>
 )
&nbsp;
 &#47;&#47; These are all the command line flags we support.
<span class="term-fg36">@@ -271,6 +272,21 @@</span> 	}
 	OverrideShanghai = &amp;cli.Uint64Flag{
 		Name:     &quot;override.shanghai&quot;,
 		Usage:    &quot;Manually specify the Shanghai fork timestamp, overriding the bundled setting&quot;,
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OverrideOptimismBedrock = &amp;flags.BigFlag{</span>
<span class="term-fg32">+		Name:     &quot;override.bedrock&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify OptimsimBedrock, overriding the bundled setting&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OverrideOptimismRegolith = &amp;flags.BigFlag{</span>
<span class="term-fg32">+		Name:     &quot;override.regolith&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify the OptimsimRegolith fork timestamp, overriding the bundled setting&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OverrideOptimism = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;override.optimism&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify optimism&quot;,</span>
 		Category: flags.EthCategory,
 	}
 	&#47;&#47; Light server and client settings
<span class="term-fg36">@@ -898,6 +914,32 @@</span> 		Name:     &quot;gpo.ignoreprice&quot;,
 		Usage:    &quot;Gas price below which gpo will ignore transactions&quot;,
 		Value:    ethconfig.Defaults.GPO.IgnorePrice.Int64(),
 		Category: flags.GasPriceCategory,
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Rollup Flags</span>
<span class="term-fg32">+	RollupSequencerHTTPFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.sequencerhttp&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;HTTP endpoint for the sequencer mempool&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupHistoricalRPCFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.historicalrpc&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;RPC endpoint for historical data.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupHistoricalRPCTimeoutFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.historicalrpctimeout&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Timeout for historical RPC requests.&quot;,</span>
<span class="term-fg32">+		Value:    &quot;5s&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupDisableTxPoolGossipFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.disabletxpoolgossip&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Disable transaction pool gossip.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
 	}
&nbsp;
 	&#47;&#47; Metrics flags
<span class="term-fg36">@@ -1857,7 +1899,17 @@</span> 		} else {
 			cfg.EthDiscoveryURLs = SplitAndTrim(urls)
 		}
 	}
<span class="term-fg31">-</span>
<span class="term-fg32">+	&#47;&#47; Only configure sequencer http flag if we&#39;re running in verifier mode i.e. --mine is disabled.</span>
<span class="term-fg32">+	if ctx.IsSet(RollupSequencerHTTPFlag.Name) &amp;&amp; !ctx.IsSet(MiningEnabledFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupSequencerHTTP = ctx.String(RollupSequencerHTTPFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupHistoricalRPCFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupHistoricalRPC = ctx.String(RollupHistoricalRPCFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupHistoricalRPCTimeoutFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupHistoricalRPCTimeout = ctx.Duration(RollupHistoricalRPCTimeoutFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	cfg.RollupDisableTxPoolGossip = ctx.Bool(RollupDisableTxPoolGossipFlag.Name)</span>
 	&#47;&#47; Override any default configs for hard coded networks.
 	switch {
 	case ctx.Bool(MainnetFlag.Name):</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1eb298d03b4406b35a6aa9d2" role="button"
                   aria-expanded="false" aria-controls="id-1eb298d03b4406b35a6aa9d2">
                    <code>cmd/geth/main.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/cmd/geth/main.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/cmd/geth/main.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+7</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1eb298d03b4406b35a6aa9d2"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;main.go op-geth&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg1">index 5ba07024989706783e48353498a37e0016552f2b..b1d23fdd190c01b47a03db003e1c4f2e4d603262 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg36">@@ -66,6 +66,9 @@</span> 		utils.USBFlag,
 		utils.SmartCardDaemonPathFlag,
 		utils.OverrideShanghai,
 		utils.EnablePersonal,
<span class="term-fg32">+		utils.OverrideOptimismBedrock,</span>
<span class="term-fg32">+		utils.OverrideOptimismRegolith,</span>
<span class="term-fg32">+		utils.OverrideOptimism,</span>
 		utils.EthashCacheDirFlag,
 		utils.EthashCachesInMemoryFlag,
 		utils.EthashCachesOnDiskFlag,
<span class="term-fg36">@@ -149,6 +152,10 @@</span> 		utils.GpoPercentileFlag,
 		utils.GpoMaxGasPriceFlag,
 		utils.GpoIgnoreGasPriceFlag,
 		utils.MinerNotifyFullFlag,
<span class="term-fg32">+		utils.RollupSequencerHTTPFlag,</span>
<span class="term-fg32">+		utils.RollupHistoricalRPCFlag,</span>
<span class="term-fg32">+		utils.RollupHistoricalRPCTimeoutFlag,</span>
<span class="term-fg32">+		utils.RollupDisableTxPoolGossipFlag,</span>
 		configFileFlag,
 	}, utils.NetworkFlags, utils.DatabasePathFlags)
&nbsp;
<span class="term-fg36">@@ -205,7 +212,6 @@</span>
 func init() {
 	&#47;&#47; Initialize the CLI app and start Geth
 	app.Action = geth
<span class="term-fg31">-	app.HideVersion = true &#47;&#47; we have a command to print the version</span>
 	app.Copyright = &quot;Copyright 2013-2023 The go-ethereum Authors&quot;
 	app.Commands = []*cli.Command{
 		&#47;&#47; See chaincmd.go:</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2bb8040fb6868dc55e6ccf9b" role="button"
                   aria-expanded="false" aria-controls="id-2bb8040fb6868dc55e6ccf9b">
                    <code>internal/flags/categories.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/internal/flags/categories.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/internal/flags/categories.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2bb8040fb6868dc55e6ccf9b"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;flags&#47;categories.go op-geth&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg1">index c2db6c6c1d25c115c77c8a829d481133a932faa7..f2b368775867174abef2e16d6c64d10b890ca9ff 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg36">@@ -31,6 +31,7 @@</span> 	NetworkingCategory = &quot;NETWORKING&quot;
 	MinerCategory      = &quot;MINER&quot;
 	GasPriceCategory   = &quot;GAS PRICE ORACLE&quot;
 	VMCategory         = &quot;VIRTUAL MACHINE&quot;
<span class="term-fg32">+	RollupCategory     = &quot;ROLLUP NODE&quot;</span>
 	LoggingCategory    = &quot;LOGGING AND DEBUGGING&quot;
 	MetricsCategory    = &quot;METRICS AND STATS&quot;
 	MiscCategory       = &quot;MISC&quot;</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-42c5927577495448bb9a45b1" role="button"
                   aria-expanded="false" aria-controls="id-42c5927577495448bb9a45b1">
                    <code>cmd/geth/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/cmd/geth/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/cmd/geth/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+13</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-42c5927577495448bb9a45b1"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;config.go op-geth&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg1">index 0b856d1c1b7a9c25a29c0b467a3f88487ef09ebb..10a519c2cbcd859a59abde028660a5b8e7df37a2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg36">@@ -162,6 +162,19 @@</span> 	if ctx.IsSet(utils.OverrideShanghai.Name) {
 		v := ctx.Uint64(utils.OverrideShanghai.Name)
 		cfg.Eth.OverrideShanghai = &amp;v
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimismBedrock.Name) {</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimismBedrock = flags.GlobalBig(ctx, utils.OverrideOptimismBedrock.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimismRegolith.Name) {</span>
<span class="term-fg32">+		v := ctx.Uint64(utils.OverrideOptimismRegolith.Name)</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimismRegolith = &amp;v</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimism.Name) {</span>
<span class="term-fg32">+		override := ctx.Bool(utils.OverrideOptimism.Name)</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimism = &amp;override</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	backend, eth := utils.RegisterEthService(stack, &amp;cfg.Eth)
&nbsp;
 	&#47;&#47; Configure log filter RPC API.</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4451b65073bf0c6b0c7129af"role="button" aria-expanded="false" aria-controls="id-4451b65073bf0c6b0c7129af">
        
            <div class="col-12 col-sm-9 text-start"><h4>Versioning</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+30</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4451b65073bf0c6b0c7129af">
        <div><p>List the op-geth and upstream go-ethereum versions.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f00fa21def9a4ba6a8360e42" role="button"
                   aria-expanded="false" aria-controls="id-f00fa21def9a4ba6a8360e42">
                    <code>cmd/geth/misccmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/cmd/geth/misccmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/cmd/geth/misccmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f00fa21def9a4ba6a8360e42"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;misccmd.go op-geth&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg1">index d8a523c6322168c5c532e81a05b8fb5a4933d642..5ca1732e07ade07abae15ce53e042f97e1be8634 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg36">@@ -137,6 +137,7 @@</span> 	}
 	if git.Date != &quot;&quot; {
 		fmt.Println(&quot;Git Commit Date:&quot;, git.Date)
 	}
<span class="term-fg32">+	fmt.Println(&quot;Upstream Version:&quot;, params.GethVersionWithMeta)</span>
 	fmt.Println(&quot;Architecture:&quot;, runtime.GOARCH)
 	fmt.Println(&quot;Go Version:&quot;, runtime.Version())
 	fmt.Println(&quot;Operating System:&quot;, runtime.GOOS)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-50347a913774934be71d153f" role="button"
                   aria-expanded="false" aria-controls="id-50347a913774934be71d153f">
                    <code>params/version.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/params/version.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/params/version.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-50347a913774934be71d153f"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;version.go op-geth&#47;params&#47;version.go</span>
<span class="term-fg1">index 74f27877ef232960d857fff69d3d7acb7645d5a0..3f79a6aa53d8297ae66ac1b378c41dd8069d1007 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;version.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;version.go</span>
<span class="term-fg36">@@ -20,21 +20,44 @@</span> import (
 	&quot;fmt&quot;
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; Version is the version of upstream geth</span>
 const (
 	VersionMajor = 1        &#47;&#47; Major version component of the current release
 	VersionMinor = 11       &#47;&#47; Minor version component of the current release
<span class="term-fg31">-	VersionPatch = 4        &#47;&#47; Patch version component of the current release</span>
<span class="term-fg32">+	VersionPatch = 5        &#47;&#47; Patch version component of the current release</span>
 	VersionMeta  = &quot;stable&quot; &#47;&#47; Version metadata to append to the version string
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; OPVersion is the version of op-geth</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	OPVersionMajor = 0          &#47;&#47; Major version component of the current release</span>
<span class="term-fg32">+	OPVersionMinor = 1          &#47;&#47; Minor version component of the current release</span>
<span class="term-fg32">+	OPVersionPatch = 0          &#47;&#47; Patch version component of the current release</span>
<span class="term-fg32">+	OPVersionMeta  = &quot;unstable&quot; &#47;&#47; Version metadata to append to the version string</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
 &#47;&#47; Version holds the textual version string.
 var Version = func() string {
<span class="term-fg31">-	return fmt.Sprintf(&quot;%d.%d.%d&quot;, VersionMajor, VersionMinor, VersionPatch)</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d.%d.%d&quot;, OPVersionMajor, OPVersionMinor, OPVersionPatch)</span>
 }()
&nbsp;
 &#47;&#47; VersionWithMeta holds the textual version string including the metadata.
 var VersionWithMeta = func() string {
 	v := Version
<span class="term-fg32">+	if OPVersionMeta != &quot;&quot; {</span>
<span class="term-fg32">+		v += &quot;-&quot; + OPVersionMeta</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return v</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; GethVersion holds the textual geth version string.</span>
<span class="term-fg32">+var GethVersion = func() string {</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d.%d.%d&quot;, VersionMajor, VersionMinor, VersionPatch)</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; GethVersionWithMeta holds the textual geth version string including the metadata.</span>
<span class="term-fg32">+var GethVersionWithMeta = func() string {</span>
<span class="term-fg32">+	v := GethVersion</span>
 	if VersionMeta != &quot;&quot; {
 		v += &quot;-&quot; + VersionMeta
 	}
<span class="term-fg36">@@ -46,8 +69,8 @@</span> &#47;&#47; &quot;1.8.11-dea1ce05&quot; for stable releases, or &quot;1.8.13-unstable-21c059b6&quot; for unstable
 &#47;&#47; releases.
 func ArchiveVersion(gitCommit string) string {
 	vsn := Version
<span class="term-fg31">-	if VersionMeta != &quot;stable&quot; {</span>
<span class="term-fg31">-		vsn += &quot;-&quot; + VersionMeta</span>
<span class="term-fg32">+	if OPVersionMeta != &quot;stable&quot; {</span>
<span class="term-fg32">+		vsn += &quot;-&quot; + OPVersionMeta</span>
 	}
 	if len(gitCommit) &gt;= 8 {
 		vsn += &quot;-&quot; + gitCommit[:8]
<span class="term-fg36">@@ -60,7 +83,7 @@</span> 	vsn := VersionWithMeta
 	if len(gitCommit) &gt;= 8 {
 		vsn += &quot;-&quot; + gitCommit[:8]
 	}
<span class="term-fg31">-	if (VersionMeta != &quot;stable&quot;) &amp;&amp; (gitDate != &quot;&quot;) {</span>
<span class="term-fg32">+	if (OPVersionMeta != &quot;stable&quot;) &amp;&amp; (gitDate != &quot;&quot;) {</span>
 		vsn += &quot;-&quot; + gitDate
 	}
 	return vsn</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-40e45da2f60401169858578e" role="button"
                   aria-expanded="false" aria-controls="id-40e45da2f60401169858578e">
                    <code>build/ci.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/build/ci.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/build/ci.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-40e45da2f60401169858578e"><span class="term-fg1">diff --git go-ethereum&#47;build&#47;ci.go op-geth&#47;build&#47;ci.go</span>
<span class="term-fg1">index 49926621bda6c56ee630f643ebaa22107ac1faf2..c939f7672fc77c4464179877772e6e25f814d387 100644</span>
<span class="term-fg1">--- go-ethereum&#47;build&#47;ci.go</span>
<span class="term-fg1">+++ op-geth&#47;build&#47;ci.go</span>
<span class="term-fg36">@@ -512,7 +512,7 @@</span> 	switch {
 	case env.Branch == &quot;master&quot;:
 		tags = []string{&quot;latest&quot;}
 	case strings.HasPrefix(env.Tag, &quot;v1.&quot;):
<span class="term-fg31">-		tags = []string{&quot;stable&quot;, fmt.Sprintf(&quot;release-1.%d&quot;, params.VersionMinor), &quot;v&quot; + params.Version}</span>
<span class="term-fg32">+		tags = []string{&quot;stable&quot;, fmt.Sprintf(&quot;release-1.%d&quot;, params.OPVersionMinor), &quot;v&quot; + params.Version}</span>
 	}
 	&#47;&#47; If architecture specific image builds are requested, build and push them
 	if *image {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-3486a225d4d172b51f67d990"role="button" aria-expanded="false" aria-controls="id-3486a225d4d172b51f67d990">
        
            <div class="col-12 col-sm-9 text-start"><h3>Node config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+10</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-3486a225d4d172b51f67d990">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1b98e3caf36f0648c6dd3b31" role="button"
                   aria-expanded="false" aria-controls="id-1b98e3caf36f0648c6dd3b31">
                    <code>eth/ethconfig/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/ethconfig/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/ethconfig/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1b98e3caf36f0648c6dd3b31"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;ethconfig&#47;config.go op-geth&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg1">index db686c5d0875f43f099e401865558f7ccf2b9224..272433cd278c2e58b7064ec141bba9611cc2c6cd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> &#47;&#47; Package ethconfig contains the configuration of the ETH and LES protocols.
 package ethconfig
&nbsp;
 import (
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
 	&quot;os&quot;
 	&quot;os&#47;user&quot;
 	&quot;path&#47;filepath&quot;
<span class="term-fg36">@@ -207,6 +208,15 @@</span> 	CheckpointOracle *params.CheckpointOracleConfig `toml:&quot;,omitempty&quot;`
&nbsp;
 	&#47;&#47; OverrideShanghai (TODO: remove after the fork)
 	OverrideShanghai *uint64 `toml:&quot;,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	OverrideOptimismBedrock  *big.Int</span>
<span class="term-fg32">+	OverrideOptimismRegolith *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+	OverrideOptimism         *bool</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupSequencerHTTP        string</span>
<span class="term-fg32">+	RollupHistoricalRPC        string</span>
<span class="term-fg32">+	RollupHistoricalRPCTimeout time.Duration</span>
<span class="term-fg32">+	RollupDisableTxPoolGossip  bool</span>
 }
&nbsp;
 &#47;&#47; CreateConsensusEngine creates a consensus engine for the given chain configuration.</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-f0a7d37e421e6df658d8f13b"role="button" aria-expanded="false" aria-controls="id-f0a7d37e421e6df658d8f13b">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tx gossip disable option</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+21</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-f0a7d37e421e6df658d8f13b">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-02fe27f2018b18c6a76c4ace" role="button"
                   aria-expanded="false" aria-controls="id-02fe27f2018b18c6a76c4ace">
                    <code>eth/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-02fe27f2018b18c6a76c4ace"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler.go op-geth&#47;eth&#47;handler.go</span>
<span class="term-fg1">index 83df6ff2eb60238fae8221d89b287fa352c5ecbb..b39f5d0fd82756695f71b2f1db4e9d5dd1433b24 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler.go</span>
<span class="term-fg36">@@ -87,6 +87,7 @@</span> 	BloomCache     uint64                    &#47;&#47; Megabytes to alloc for snap sync bloom
 	EventMux       *event.TypeMux            &#47;&#47; Legacy event mux, deprecate for `feed`
 	Checkpoint     *params.TrustedCheckpoint &#47;&#47; Hard coded checkpoint for sync challenges
 	RequiredBlocks map[uint64]common.Hash    &#47;&#47; Hard coded map of required block hashes for sync challenges
<span class="term-fg32">+	NoTxGossip     bool                      &#47;&#47; Disable P2P transaction gossip</span>
 }
&nbsp;
 type handler struct {
<span class="term-fg36">@@ -103,6 +104,8 @@</span> 	database ethdb.Database
 	txpool   txPool
 	chain    *core.BlockChain
 	maxPeers int
<span class="term-fg32">+</span>
<span class="term-fg32">+	noTxGossip bool</span>
&nbsp;
 	downloader   *downloader.Downloader
 	blockFetcher *fetcher.BlockFetcher
<span class="term-fg36">@@ -137,6 +140,7 @@</span> 		forkFilter:     forkid.NewFilter(config.Chain),
 		eventMux:       config.EventMux,
 		database:       config.Database,
 		txpool:         config.TxPool,
<span class="term-fg32">+		noTxGossip:     config.NoTxGossip,</span>
 		chain:          config.Chain,
 		peers:          newPeerSet(),
 		merger:         config.Merger,</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8e904aa4a2339c930fc01c92" role="button"
                   aria-expanded="false" aria-controls="id-8e904aa4a2339c930fc01c92">
                    <code>eth/handler_eth.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/handler_eth.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/handler_eth.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+17</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8e904aa4a2339c930fc01c92"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler_eth.go op-geth&#47;eth&#47;handler_eth.go</span>
<span class="term-fg1">index 4ed6335769cf9c32017c19c3037df91e7fabed48..6f573cc3e9a98861531f976b59a8ab67d5d33e51 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler_eth.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler_eth.go</span>
<span class="term-fg36">@@ -34,7 +34,20 @@</span> &#47;&#47; packets that are sent as replies or broadcasts.
 type ethHandler handler
&nbsp;
 func (h *ethHandler) Chain() *core.BlockChain { return h.chain }
<span class="term-fg31">-func (h *ethHandler) TxPool() eth.TxPool      { return h.txpool }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NilPool satisfies the TxPool interface but does not return any tx in the</span>
<span class="term-fg32">+&#47;&#47; pool. It is used to disable transaction gossip.</span>
<span class="term-fg32">+type NilPool struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NilPool Get always returns nil</span>
<span class="term-fg32">+func (n NilPool) Get(hash common.Hash) *types.Transaction { return nil }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (h *ethHandler) TxPool() eth.TxPool {</span>
<span class="term-fg32">+	if h.noTxGossip {</span>
<span class="term-fg32">+		return &amp;NilPool{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return h.txpool</span>
<span class="term-fg32">+}</span>
&nbsp;
 &#47;&#47; RunPeer is invoked when a peer joins on the `eth` protocol.
 func (h *ethHandler) RunPeer(peer *eth.Peer, hand eth.Handler) error {
<span class="term-fg36">@@ -52,6 +65,9 @@</span>
 &#47;&#47; AcceptTxs retrieves whether transaction processing is enabled on the node
 &#47;&#47; or if inbound transactions should simply be dropped.
 func (h *ethHandler) AcceptTxs() bool {
<span class="term-fg32">+	if h.noTxGossip {</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
 	return atomic.LoadUint32(&amp;h.acceptTxs) == 1
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-c83357cc005d62c15b3047ef"role="button" aria-expanded="false" aria-controls="id-c83357cc005d62c15b3047ef">
        
            <div class="col-12 col-sm-9 text-start"><h2>User API enhancements</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+992</span></div>
                <div class="text-start"><span class="text-danger">-62</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-c83357cc005d62c15b3047ef">
        <div><p>Encode the Deposit Tx properties, the L1 costs, and daisy-chain RPC-calls for pre-Bedrock historical data</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-9bdcfede110845e0a353b738"role="button" aria-expanded="false" aria-controls="id-9bdcfede110845e0a353b738">
        
            <div class="col-12 col-sm-9 text-start"><h3>Receipts metadata</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+222</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-9bdcfede110845e0a353b738">
        <div><p>Pre-Bedrock L1-cost receipt data is loaded from the database if available, and post-Bedrock the L1-cost
metadata is hydrated on-the-fly based on the L1 fee information in the corresponding block.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-680440cf40ba66b412a61c25" role="button"
                   aria-expanded="false" aria-controls="id-680440cf40ba66b412a61c25">
                    <code>core/types/receipt.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/receipt.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/receipt.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+194</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-680440cf40ba66b412a61c25"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;receipt.go op-geth&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg1">index 61b3b351780694beb99f6442f837f7e07d1184f2..874e10efb01a7a5307ea566094647e980208d871 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg36">@@ -58,17 +58,28 @@</span> 	CumulativeGasUsed uint64 `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`
 	Bloom             Bloom  `json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`
 	Logs              []*Log `json:&quot;logs&quot;              gencodec:&quot;required&quot;`
&nbsp;
<span class="term-fg31">-	&#47;&#47; Implementation fields: These fields are added by geth when processing a transaction.</span>
<span class="term-fg32">+	&#47;&#47; Implementation fields: These fields are added by geth when processing a transaction or retrieving a receipt.</span>
<span class="term-fg32">+	&#47;&#47; gencodec annotated fields: these are stored in the chain database.</span>
 	TxHash            common.Hash    `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`
 	ContractAddress   common.Address `json:&quot;contractAddress&quot;`
 	GasUsed           uint64         `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`
 	EffectiveGasPrice *big.Int       `json:&quot;effectiveGasPrice&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions</span>
<span class="term-fg32">+	&#47;&#47; The state transition process ensures this is only set for Regolith deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
&nbsp;
 	&#47;&#47; Inclusion information: These fields provide information about the inclusion of the
 	&#47;&#47; transaction corresponding to this receipt.
 	BlockHash        common.Hash `json:&quot;blockHash,omitempty&quot;`
 	BlockNumber      *big.Int    `json:&quot;blockNumber,omitempty&quot;`
 	TransactionIndex uint        `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; OVM legacy: extend receipts with their L1 price (if a rollup tx)</span>
<span class="term-fg32">+	L1GasPrice *big.Int   `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+	L1GasUsed  *big.Int   `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+	L1Fee      *big.Int   `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+	FeeScalar  *big.Float `json:&quot;l1FeeScalar,omitempty&quot;`</span>
 }
&nbsp;
 type receiptMarshaling struct {
<span class="term-fg36">@@ -79,6 +90,12 @@</span> 	CumulativeGasUsed hexutil.Uint64
 	GasUsed           hexutil.Uint64
 	BlockNumber       *hexutil.Big
 	TransactionIndex  hexutil.Uint
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Optimism: extend receipts with their L1 price (if a rollup tx)</span>
<span class="term-fg32">+	L1GasPrice *hexutil.Big</span>
<span class="term-fg32">+	L1GasUsed  *hexutil.Big</span>
<span class="term-fg32">+	L1Fee      *hexutil.Big</span>
<span class="term-fg32">+	FeeScalar  *big.Float</span>
 }
&nbsp;
 &#47;&#47; receiptRLP is the consensus encoding of a receipt.
<span class="term-fg36">@@ -89,11 +106,90 @@</span> 	Bloom             Bloom
 	Logs              []*Log
 }
&nbsp;
<span class="term-fg32">+type depositReceiptRlp struct {</span>
<span class="term-fg32">+	PostStateOrStatus []byte</span>
<span class="term-fg32">+	CumulativeGasUsed uint64</span>
<span class="term-fg32">+	Bloom             Bloom</span>
<span class="term-fg32">+	Logs              []*Log</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions.</span>
<span class="term-fg32">+	&#47;&#47; Must be nil for any transactions prior to Regolith or that aren&#39;t deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; storedReceiptRLP is the storage encoding of a receipt.
 type storedReceiptRLP struct {
 	PostStateOrStatus []byte
 	CumulativeGasUsed uint64
 	Logs              []*Log
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions.</span>
<span class="term-fg32">+	&#47;&#47; Must be nil for any transactions prior to Regolith or that aren&#39;t deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LegacyOptimismStoredReceiptRLP is the pre bedrock storage encoding of a</span>
<span class="term-fg32">+&#47;&#47; receipt. It will only exist in the database if it was migrated using the</span>
<span class="term-fg32">+&#47;&#47; migration tool. Nodes that sync using snap-sync will not have any of these</span>
<span class="term-fg32">+&#47;&#47; entries.</span>
<span class="term-fg32">+type LegacyOptimismStoredReceiptRLP struct {</span>
<span class="term-fg32">+	PostStateOrStatus []byte</span>
<span class="term-fg32">+	CumulativeGasUsed uint64</span>
<span class="term-fg32">+	Logs              []*LogForStorage</span>
<span class="term-fg32">+	L1GasUsed         *big.Int</span>
<span class="term-fg32">+	L1GasPrice        *big.Int</span>
<span class="term-fg32">+	L1Fee             *big.Int</span>
<span class="term-fg32">+	FeeScalar         string</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LogForStorage is a wrapper around a Log that handles</span>
<span class="term-fg32">+&#47;&#47; backward compatibility with prior storage formats.</span>
<span class="term-fg32">+type LogForStorage Log</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; EncodeRLP implements rlp.Encoder.</span>
<span class="term-fg32">+func (l *LogForStorage) EncodeRLP(w io.Writer) error {</span>
<span class="term-fg32">+	rl := rlpLog{Address: l.Address, Topics: l.Topics, Data: l.Data}</span>
<span class="term-fg32">+	return rlp.Encode(w, &amp;rl)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type legacyRlpStorageLog struct {</span>
<span class="term-fg32">+	Address     common.Address</span>
<span class="term-fg32">+	Topics      []common.Hash</span>
<span class="term-fg32">+	Data        []byte</span>
<span class="term-fg32">+	BlockNumber uint64</span>
<span class="term-fg32">+	TxHash      common.Hash</span>
<span class="term-fg32">+	TxIndex     uint</span>
<span class="term-fg32">+	BlockHash   common.Hash</span>
<span class="term-fg32">+	Index       uint</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; DecodeRLP implements rlp.Decoder.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Note some redundant fields(e.g. block number, tx hash etc) will be assembled later.</span>
<span class="term-fg32">+func (l *LogForStorage) DecodeRLP(s *rlp.Stream) error {</span>
<span class="term-fg32">+	blob, err := s.Raw()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var dec rlpLog</span>
<span class="term-fg32">+	err = rlp.DecodeBytes(blob, &amp;dec)</span>
<span class="term-fg32">+	if err == nil {</span>
<span class="term-fg32">+		*l = LogForStorage{</span>
<span class="term-fg32">+			Address: dec.Address,</span>
<span class="term-fg32">+			Topics:  dec.Topics,</span>
<span class="term-fg32">+			Data:    dec.Data,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		&#47;&#47; Try to decode log with previous definition.</span>
<span class="term-fg32">+		var dec legacyRlpStorageLog</span>
<span class="term-fg32">+		err = rlp.DecodeBytes(blob, &amp;dec)</span>
<span class="term-fg32">+		if err == nil {</span>
<span class="term-fg32">+			*l = LogForStorage{</span>
<span class="term-fg32">+				Address: dec.Address,</span>
<span class="term-fg32">+				Topics:  dec.Topics,</span>
<span class="term-fg32">+				Data:    dec.Data,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return err</span>
 }
&nbsp;
 &#47;&#47; NewReceipt creates a barebone transaction receipt, copying the init fields.
<span class="term-fg36">@@ -131,7 +227,13 @@</span>
 &#47;&#47; encodeTyped writes the canonical encoding of a typed receipt to w.
 func (r *Receipt) encodeTyped(data *receiptRLP, w *bytes.Buffer) error {
 	w.WriteByte(r.Type)
<span class="term-fg31">-	return rlp.Encode(w, data)</span>
<span class="term-fg32">+	switch r.Type {</span>
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		withNonce := depositReceiptRlp{data.PostStateOrStatus, data.CumulativeGasUsed, data.Bloom, data.Logs, r.DepositNonce}</span>
<span class="term-fg32">+		return rlp.Encode(w, withNonce)</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return rlp.Encode(w, data)</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 &#47;&#47; MarshalBinary returns the consensus encoding of the receipt.
<span class="term-fg36">@@ -201,6 +303,15 @@</span> 			return err
 		}
 		r.Type = b[0]
 		return r.setFromRLP(data)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		var data depositReceiptRlp</span>
<span class="term-fg32">+		err := rlp.DecodeBytes(b[1:], &amp;data)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		r.Type = b[0]</span>
<span class="term-fg32">+		r.DepositNonce = data.DepositNonce</span>
<span class="term-fg32">+		return r.setFromRLP(receiptRLP{data.PostStateOrStatus, data.CumulativeGasUsed, data.Bloom, data.Logs})</span>
 	default:
 		return ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -264,6 +375,9 @@</span> 			return err
 		}
 	}
 	w.ListEnd(logList)
<span class="term-fg32">+	if r.DepositNonce != nil {</span>
<span class="term-fg32">+		w.WriteUint64(*r.DepositNonce)</span>
<span class="term-fg32">+	}</span>
 	w.ListEnd(outerList)
 	return w.Flush()
 }
<span class="term-fg36">@@ -271,8 +385,51 @@</span>
 &#47;&#47; DecodeRLP implements rlp.Decoder, and loads both consensus and implementation
 &#47;&#47; fields of a receipt from an RLP stream.
 func (r *ReceiptForStorage) DecodeRLP(s *rlp.Stream) error {
<span class="term-fg32">+	&#47;&#47; Retrieve the entire receipt blob as we need to try multiple decoders</span>
<span class="term-fg32">+	blob, err := s.Raw()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; First try to decode the latest receipt database format, try the pre-bedrock Optimism legacy format otherwise.</span>
<span class="term-fg32">+	if err := decodeStoredReceiptRLP(r, blob); err == nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return decodeLegacyOptimismReceiptRLP(r, blob)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeLegacyOptimismReceiptRLP(r *ReceiptForStorage, blob []byte) error {</span>
<span class="term-fg32">+	var stored LegacyOptimismStoredReceiptRLP</span>
<span class="term-fg32">+	if err := rlp.DecodeBytes(blob, &amp;stored); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err := (*Receipt)(r).setStatus(stored.PostStateOrStatus); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.CumulativeGasUsed = stored.CumulativeGasUsed</span>
<span class="term-fg32">+	r.Logs = make([]*Log, len(stored.Logs))</span>
<span class="term-fg32">+	for i, log := range stored.Logs {</span>
<span class="term-fg32">+		r.Logs[i] = (*Log)(log)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.Bloom = CreateBloom(Receipts{(*Receipt)(r)})</span>
<span class="term-fg32">+	&#47;&#47; UsingOVM</span>
<span class="term-fg32">+	scalar := new(big.Float)</span>
<span class="term-fg32">+	if stored.FeeScalar != &quot;&quot; {</span>
<span class="term-fg32">+		var ok bool</span>
<span class="term-fg32">+		scalar, ok = scalar.SetString(stored.FeeScalar)</span>
<span class="term-fg32">+		if !ok {</span>
<span class="term-fg32">+			return errors.New(&quot;cannot parse fee scalar&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.L1GasUsed = stored.L1GasUsed</span>
<span class="term-fg32">+	r.L1GasPrice = stored.L1GasPrice</span>
<span class="term-fg32">+	r.L1Fee = stored.L1Fee</span>
<span class="term-fg32">+	r.FeeScalar = scalar</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeStoredReceiptRLP(r *ReceiptForStorage, blob []byte) error {</span>
 	var stored storedReceiptRLP
<span class="term-fg31">-	if err := s.Decode(&amp;stored); err != nil {</span>
<span class="term-fg32">+	if err := rlp.DecodeBytes(blob, &amp;stored); err != nil {</span>
 		return err
 	}
 	if err := (*Receipt)(r).setStatus(stored.PostStateOrStatus); err != nil {
<span class="term-fg36">@@ -281,7 +438,9 @@</span> 	}
 	r.CumulativeGasUsed = stored.CumulativeGasUsed
 	r.Logs = stored.Logs
 	r.Bloom = CreateBloom(Receipts{(*Receipt)(r)})
<span class="term-fg31">-</span>
<span class="term-fg32">+	if stored.DepositNonce != nil {</span>
<span class="term-fg32">+		r.DepositNonce = stored.DepositNonce</span>
<span class="term-fg32">+	}</span>
 	return nil
 }
&nbsp;
<span class="term-fg36">@@ -304,6 +463,9 @@</span> 		rlp.Encode(w, data)
 	case DynamicFeeTxType:
 		w.WriteByte(DynamicFeeTxType)
 		rlp.Encode(w, data)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		w.WriteByte(DepositTxType)</span>
<span class="term-fg32">+		rlp.Encode(w, data)</span>
 	default:
 		&#47;&#47; For unsupported types, write nothing. Since this is for
 		&#47;&#47; DeriveSha, the error will be caught matching the derived hash
<span class="term-fg36">@@ -313,7 +475,7 @@</span> }
&nbsp;
 &#47;&#47; DeriveFields fills the receipts with their computed fields based on consensus
 &#47;&#47; data and contextual infos like containing block and transactions.
<span class="term-fg31">-func (rs Receipts) DeriveFields(config *params.ChainConfig, hash common.Hash, number uint64, baseFee *big.Int, txs []*Transaction) error {</span>
<span class="term-fg32">+func (rs Receipts) DeriveFields(config *params.ChainConfig, hash common.Hash, number uint64, time uint64, baseFee *big.Int, txs Transactions) error {</span>
 	signer := MakeSigner(config, new(big.Int).SetUint64(number))
&nbsp;
 	logIndex := uint(0)
<span class="term-fg36">@@ -336,7 +498,11 @@</span> 		&#47;&#47; The contract address can be derived from the transaction itself
 		if txs[i].To() == nil {
 			&#47;&#47; Deriving the signer is expensive, only do if it&#39;s actually needed
 			from, _ := Sender(signer, txs[i])
<span class="term-fg31">-			rs[i].ContractAddress = crypto.CreateAddress(from, txs[i].Nonce())</span>
<span class="term-fg32">+			nonce := txs[i].Nonce()</span>
<span class="term-fg32">+			if rs[i].DepositNonce != nil {</span>
<span class="term-fg32">+				nonce = *rs[i].DepositNonce</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			rs[i].ContractAddress = crypto.CreateAddress(from, nonce)</span>
 		} else {
 			rs[i].ContractAddress = common.Address{}
 		}
<span class="term-fg36">@@ -358,5 +524,27 @@</span> 			rs[i].Logs[j].Index = logIndex
 			logIndex++
 		}
 	}
<span class="term-fg32">+	if config.Optimism != nil &amp;&amp; len(txs) &gt;= 2 { &#47;&#47; need at least an info tx and a non-info tx</span>
<span class="term-fg32">+		if data := txs[0].Data(); len(data) &gt;= 4+32*8 { &#47;&#47; function selector + 8 arguments to setL1BlockValues</span>
<span class="term-fg32">+			l1Basefee := new(big.Int).SetBytes(data[4+32*2 : 4+32*3]) &#47;&#47; arg index 2</span>
<span class="term-fg32">+			overhead := new(big.Int).SetBytes(data[4+32*6 : 4+32*7])  &#47;&#47; arg index 6</span>
<span class="term-fg32">+			scalar := new(big.Int).SetBytes(data[4+32*7 : 4+32*8])    &#47;&#47; arg index 7</span>
<span class="term-fg32">+			fscalar := new(big.Float).SetInt(scalar)                  &#47;&#47; legacy: format fee scalar as big Float</span>
<span class="term-fg32">+			fdivisor := new(big.Float).SetUint64(1_000_000)           &#47;&#47; 10**6, i.e. 6 decimals</span>
<span class="term-fg32">+			feeScalar := new(big.Float).Quo(fscalar, fdivisor)</span>
<span class="term-fg32">+			for i := 0; i &lt; len(rs); i++ {</span>
<span class="term-fg32">+				if !txs[i].IsDepositTx() {</span>
<span class="term-fg32">+					gas := txs[i].RollupDataGas().DataGas(time, config)</span>
<span class="term-fg32">+					rs[i].L1GasPrice = l1Basefee</span>
<span class="term-fg32">+					rs[i].L1GasUsed = new(big.Int).SetUint64(gas)</span>
<span class="term-fg32">+					rs[i].L1Fee = L1Cost(gas, l1Basefee, overhead, scalar)</span>
<span class="term-fg32">+					rs[i].FeeScalar = feeScalar</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return fmt.Errorf(&quot;L1 info tx only has %d bytes, cannot read gas price parameters&quot;, len(data))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-016597eb1ff938c3a4d6f3ab" role="button"
                   aria-expanded="false" aria-controls="id-016597eb1ff938c3a4d6f3ab">
                    <code>core/types/gen_receipt_json.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/gen_receipt_json.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/gen_receipt_json.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-016597eb1ff938c3a4d6f3ab"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;gen_receipt_json.go op-geth&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg1">index 8d85dd5b9c1aa295cda6d232427fda9d7dc9ded2..9fd74009becf231aa3596aeb22f657abfb6a964a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg36">@@ -29,6 +29,10 @@</span> 		EffectiveGasPrice *hexutil.Big   `json:&quot;effectiveGasPrice,omitempty&quot;`
 		BlockHash         common.Hash    `json:&quot;blockHash,omitempty&quot;`
 		BlockNumber       *hexutil.Big   `json:&quot;blockNumber,omitempty&quot;`
 		TransactionIndex  hexutil.Uint   `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+		L1GasPrice        *hexutil.Big   `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		L1GasUsed         *hexutil.Big   `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		L1Fee             *hexutil.Big   `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+		FeeScalar         *big.Float     `json:&quot;l1FeeScalar,omitempty&quot;`</span>
 	}
 	var enc Receipt
 	enc.Type = hexutil.Uint64(r.Type)
<span class="term-fg36">@@ -44,6 +48,10 @@</span> 	enc.EffectiveGasPrice = (*hexutil.Big)(r.EffectiveGasPrice)
 	enc.BlockHash = r.BlockHash
 	enc.BlockNumber = (*hexutil.Big)(r.BlockNumber)
 	enc.TransactionIndex = hexutil.Uint(r.TransactionIndex)
<span class="term-fg32">+	enc.L1GasPrice = (*hexutil.Big)(r.L1GasPrice)</span>
<span class="term-fg32">+	enc.L1GasUsed = (*hexutil.Big)(r.L1GasUsed)</span>
<span class="term-fg32">+	enc.L1Fee = (*hexutil.Big)(r.L1Fee)</span>
<span class="term-fg32">+	enc.FeeScalar = r.FeeScalar</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -63,6 +71,11 @@</span> 		EffectiveGasPrice *hexutil.Big    `json:&quot;effectiveGasPrice,omitempty&quot;`
 		BlockHash         *common.Hash    `json:&quot;blockHash,omitempty&quot;`
 		BlockNumber       *hexutil.Big    `json:&quot;blockNumber,omitempty&quot;`
 		TransactionIndex  *hexutil.Uint   `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+		L1GasPrice        *hexutil.Big    `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		L1GasUsed         *hexutil.Big    `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		L1Fee             *hexutil.Big    `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+		FeeScalar         *big.Float      `json:&quot;l1FeeScalar,omitempty&quot;`</span>
<span class="term-fg32">+		DepositNonce      *hexutil.Uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
 	}
 	var dec Receipt
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -111,6 +124,21 @@</span> 		r.BlockNumber = (*big.Int)(dec.BlockNumber)
 	}
 	if dec.TransactionIndex != nil {
 		r.TransactionIndex = uint(*dec.TransactionIndex)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1GasPrice != nil {</span>
<span class="term-fg32">+		r.L1GasPrice = (*big.Int)(dec.L1GasPrice)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1GasUsed != nil {</span>
<span class="term-fg32">+		r.L1GasUsed = (*big.Int)(dec.L1GasUsed)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1Fee != nil {</span>
<span class="term-fg32">+		r.L1Fee = (*big.Int)(dec.L1Fee)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.FeeScalar != nil {</span>
<span class="term-fg32">+		r.FeeScalar = dec.FeeScalar</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.DepositNonce != nil {</span>
<span class="term-fg32">+		r.DepositNonce = (*uint64)(dec.DepositNonce)</span>
 	}
 	return nil
 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-a99be7fb7fd456feeb61408d"role="button" aria-expanded="false" aria-controls="id-a99be7fb7fd456feeb61408d">
        
            <div class="col-12 col-sm-9 text-start"><h3>API Backend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+96</span></div>
                <div class="text-start"><span class="text-danger">-7</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-a99be7fb7fd456feeb61408d">
        <div><p>Forward transactions to the sequencer if configured.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-920385daccc12b841708a11b" role="button"
                   aria-expanded="false" aria-controls="id-920385daccc12b841708a11b">
                    <code>eth/api_backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/api_backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/api_backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+42</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-920385daccc12b841708a11b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;api_backend.go op-geth&#47;eth&#47;api_backend.go</span>
<span class="term-fg1">index 78b9b08ecb3241e80170d3d3d7f3bc9001030b97..1aebf4e47d9f6dcc8cd0fc3447ba22c66a8935a7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;api_backend.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;api_backend.go</span>
<span class="term-fg36">@@ -19,12 +19,14 @@</span>
 import (
 	&quot;context&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&#47;big&quot;
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;bloombits&quot;
<span class="term-fg36">@@ -75,6 +77,9 @@</span> 	if number == rpc.LatestBlockNumber {
 		return b.eth.blockchain.CurrentBlock(), nil
 	}
 	if number == rpc.FinalizedBlockNumber {
<span class="term-fg32">+		if !b.eth.Merger().TDDReached() {</span>
<span class="term-fg32">+			return nil, errors.New(&quot;&#39;finalized&#39; tag not supported on pre-merge network&quot;)</span>
<span class="term-fg32">+		}</span>
 		block := b.eth.blockchain.CurrentFinalBlock()
 		if block != nil {
 			return block, nil
<span class="term-fg36">@@ -82,6 +87,9 @@</span> 		}
 		return nil, errors.New(&quot;finalized block not found&quot;)
 	}
 	if number == rpc.SafeBlockNumber {
<span class="term-fg32">+		if !b.eth.Merger().TDDReached() {</span>
<span class="term-fg32">+			return nil, errors.New(&quot;&#39;safe&#39; tag not supported on pre-merge network&quot;)</span>
<span class="term-fg32">+		}</span>
 		block := b.eth.blockchain.CurrentSafeBlock()
 		if block != nil {
 			return block, nil
<span class="term-fg36">@@ -124,11 +132,23 @@</span> 		header := b.eth.blockchain.CurrentBlock()
 		return b.eth.blockchain.GetBlock(header.Hash(), header.Number.Uint64()), nil
 	}
 	if number == rpc.FinalizedBlockNumber {
<span class="term-fg32">+		if !b.eth.Merger().TDDReached() {</span>
<span class="term-fg32">+			return nil, errors.New(&quot;&#39;finalized&#39; tag not supported on pre-merge network&quot;)</span>
<span class="term-fg32">+		}</span>
 		header := b.eth.blockchain.CurrentFinalBlock()
<span class="term-fg32">+		if header == nil {</span>
<span class="term-fg32">+			return nil, nil</span>
<span class="term-fg32">+		}</span>
 		return b.eth.blockchain.GetBlock(header.Hash(), header.Number.Uint64()), nil
 	}
 	if number == rpc.SafeBlockNumber {
<span class="term-fg32">+		if !b.eth.Merger().TDDReached() {</span>
<span class="term-fg32">+			return nil, errors.New(&quot;&#39;safe&#39; tag not supported on pre-merge network&quot;)</span>
<span class="term-fg32">+		}</span>
 		header := b.eth.blockchain.CurrentSafeBlock()
<span class="term-fg32">+		if header == nil {</span>
<span class="term-fg32">+			return nil, nil</span>
<span class="term-fg32">+		}</span>
 		return b.eth.blockchain.GetBlock(header.Hash(), header.Number.Uint64()), nil
 	}
 	return b.eth.blockchain.GetBlockByNumber(uint64(number)), nil
<span class="term-fg36">@@ -186,7 +206,7 @@</span> 	if err != nil {
 		return nil, nil, err
 	}
 	if header == nil {
<span class="term-fg31">-		return nil, nil, errors.New(&quot;header not found&quot;)</span>
<span class="term-fg32">+		return nil, nil, fmt.Errorf(&quot;header %w&quot;, ethereum.NotFound)</span>
 	}
 	stateDb, err := b.eth.BlockChain().StateAt(header.Root)
 	return stateDb, header, err
<span class="term-fg36">@@ -202,7 +222,7 @@</span> 		if err != nil {
 			return nil, nil, err
 		}
 		if header == nil {
<span class="term-fg31">-			return nil, nil, errors.New(&quot;header for hash not found&quot;)</span>
<span class="term-fg32">+			return nil, nil, fmt.Errorf(&quot;header for hash %w&quot;, ethereum.NotFound)</span>
 		}
 		if blockNrOrHash.RequireCanonical &amp;&amp; b.eth.blockchain.GetCanonicalHash(header.Number.Uint64()) != hash {
 			return nil, nil, errors.New(&quot;hash is not currently canonical&quot;)
<span class="term-fg36">@@ -233,7 +253,7 @@</span> 	if vmConfig == nil {
 		vmConfig = b.eth.blockchain.GetVMConfig()
 	}
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(header, b.eth.BlockChain(), nil)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(header, b.eth.BlockChain(), nil, b.eth.blockchain.Config(), state)</span>
 	return vm.NewEVM(context, txContext, state, b.eth.blockchain.Config(), *vmConfig), state.Error, nil
 }
&nbsp;
<span class="term-fg36">@@ -261,8 +281,17 @@</span> func (b *EthAPIBackend) SubscribeLogsEvent(ch chan&lt;- []*types.Log) event.Subscription {
 	return b.eth.BlockChain().SubscribeLogsEvent(ch)
 }
&nbsp;
<span class="term-fg31">-func (b *EthAPIBackend) SendTx(ctx context.Context, signedTx *types.Transaction) error {</span>
<span class="term-fg31">-	return b.eth.txPool.AddLocal(signedTx)</span>
<span class="term-fg32">+func (b *EthAPIBackend) SendTx(ctx context.Context, tx *types.Transaction) error {</span>
<span class="term-fg32">+	if b.eth.seqRPCService != nil {</span>
<span class="term-fg32">+		data, err := tx.MarshalBinary()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if err := b.eth.seqRPCService.CallContext(ctx, nil, &quot;eth_sendRawTransaction&quot;, hexutil.Encode(data)); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return b.eth.txPool.AddLocal(tx)</span>
 }
&nbsp;
 func (b *EthAPIBackend) GetPoolTransactions() (types.Transactions, error) {
<span class="term-fg36">@@ -385,3 +414,11 @@</span>
 func (b *EthAPIBackend) StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, tracers.StateReleaseFunc, error) {
 	return b.eth.stateAtTransaction(ctx, block, txIndex, reexec)
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *EthAPIBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.eth.historicalRPCService</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *EthAPIBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	return b.eth.blockchain.Genesis()</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-29e9ad070b303252343e506d" role="button"
                   aria-expanded="false" aria-controls="id-29e9ad070b303252343e506d">
                    <code>eth/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+52</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-29e9ad070b303252343e506d"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;backend.go op-geth&#47;eth&#47;backend.go</span>
<span class="term-fg1">index 6368c0e03c564cdc5e457883b7f81e0d8d9c7431..0e3351ab8baa35d22c68872dcc072e5995eb3263 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;backend.go</span>
<span class="term-fg36">@@ -18,12 +18,14 @@</span> &#47;&#47; Package eth implements the Ethereum protocol.
 package eth
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;runtime&quot;
 	&quot;sync&quot;
 	&quot;sync&#47;atomic&quot;
<span class="term-fg32">+	&quot;time&quot;</span>
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -74,6 +76,9 @@</span> 	ethDialCandidates  enode.Iterator
 	snapDialCandidates enode.Iterator
 	merger             *consensus.Merger
&nbsp;
<span class="term-fg32">+	seqRPCService        *rpc.Client</span>
<span class="term-fg32">+	historicalRPCService *rpc.Client</span>
<span class="term-fg32">+</span>
 	&#47;&#47; DB interfaces
 	chainDb ethdb.Database &#47;&#47; Block chain database
&nbsp;
<span class="term-fg36">@@ -165,7 +170,6 @@</span> 	var dbVer = &quot;&lt;nil&gt;&quot;
 	if bcVersion != nil {
 		dbVer = fmt.Sprintf(&quot;%d&quot;, *bcVersion)
 	}
<span class="term-fg31">-	log.Info(&quot;Initialising Ethereum protocol&quot;, &quot;network&quot;, config.NetworkId, &quot;dbversion&quot;, dbVer)</span>
&nbsp;
 	if !config.SkipBcVersionCheck {
 		if bcVersion != nil &amp;&amp; *bcVersion &gt; core.BlockChainVersion {
<span class="term-fg36">@@ -198,10 +202,29 @@</span> 	var overrides core.ChainOverrides
 	if config.OverrideShanghai != nil {
 		overrides.OverrideShanghai = config.OverrideShanghai
 	}
<span class="term-fg32">+	if config.OverrideOptimismBedrock != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimismBedrock = config.OverrideOptimismBedrock</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if config.OverrideOptimismRegolith != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimismRegolith = config.OverrideOptimismRegolith</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if config.OverrideOptimism != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimism = config.OverrideOptimism</span>
<span class="term-fg32">+	}</span>
 	eth.blockchain, err = core.NewBlockChain(chainDb, cacheConfig, config.Genesis, &amp;overrides, eth.engine, vmConfig, eth.shouldPreserve, &amp;config.TxLookupLimit)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+	if chainConfig := eth.blockchain.Config(); chainConfig.Optimism != nil { &#47;&#47; config.Genesis.Config.ChainID cannot be used because it&#39;s based on CLI flags only, thus default to mainnet L1</span>
<span class="term-fg32">+		config.NetworkId = chainConfig.ChainID.Uint64() &#47;&#47; optimism defaults eth network ID to chain ID</span>
<span class="term-fg32">+		eth.networkID = config.NetworkId</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	log.Info(&quot;Initialising Ethereum protocol&quot;, &quot;network&quot;, config.NetworkId, &quot;dbversion&quot;, dbVer)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if eth.blockchain.Config().Optimism != nil { &#47;&#47; Optimism Bedrock depends on Merge functionality</span>
<span class="term-fg32">+		eth.merger.FinalizePoS()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	eth.bloomIndexer.Start(eth.blockchain)
&nbsp;
 	if config.TxPool.Journal != &quot;&quot; {
<span class="term-fg36">@@ -226,6 +249,7 @@</span> 		BloomCache:     uint64(cacheLimit),
 		EventMux:       eth.eventMux,
 		Checkpoint:     checkpoint,
 		RequiredBlocks: config.RequiredBlocks,
<span class="term-fg32">+		NoTxGossip:     config.RollupDisableTxPoolGossip,</span>
 	}); err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -254,6 +278,26 @@</span> 	if err != nil {
 		return nil, err
 	}
&nbsp;
<span class="term-fg32">+	if config.RollupSequencerHTTP != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupSequencerHTTP)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		eth.seqRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupHistoricalRPC != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), config.RollupHistoricalRPCTimeout)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupHistoricalRPC)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		eth.historicalRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Start the RPC service
 	eth.netRPCService = ethapi.NewNetAPI(eth.p2pServer, config.NetworkId)
&nbsp;
<span class="term-fg36">@@ -272,7 +316,7 @@</span> func makeExtraData(extra []byte) []byte {
 	if len(extra) == 0 {
 		&#47;&#47; create default extradata
 		extra, _ = rlp.EncodeToBytes([]interface{}{
<span class="term-fg31">-			uint(params.VersionMajor&lt;&lt;16 | params.VersionMinor&lt;&lt;8 | params.VersionPatch),</span>
<span class="term-fg32">+			uint(params.OPVersionMajor&lt;&lt;16 | params.OPVersionMinor&lt;&lt;8 | params.OPVersionPatch),</span>
 			&quot;geth&quot;,
 			runtime.Version(),
 			runtime.GOOS,
<span class="term-fg36">@@ -533,6 +577,12 @@</span> 	s.txPool.Stop()
 	s.miner.Close()
 	s.blockchain.Stop()
 	s.engine.Close()
<span class="term-fg32">+	if s.seqRPCService != nil {</span>
<span class="term-fg32">+		s.seqRPCService.Close()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.historicalRPCService != nil {</span>
<span class="term-fg32">+		s.historicalRPCService.Close()</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Clean shutdown marker as the last thing before closing db
 	s.shutdownTracker.Stop()</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5920f45afb84ed4939bc83b0" role="button"
                   aria-expanded="false" aria-controls="id-5920f45afb84ed4939bc83b0">
                    <code>internal/ethapi/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/internal/ethapi/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/internal/ethapi/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5920f45afb84ed4939bc83b0"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;backend.go op-geth&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg1">index 98887afc803fab93f18e569b71aaa44d53efde27..cbb488027aa30389cf47de71f3e12298a2bde9be 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg36">@@ -86,6 +86,8 @@</span> 	SubscribeNewTxsEvent(chan&lt;- core.NewTxsEvent) event.Subscription
&nbsp;
 	ChainConfig() *params.ChainConfig
 	Engine() consensus.Engine
<span class="term-fg32">+	HistoricalRPCService() *rpc.Client</span>
<span class="term-fg32">+	Genesis() *types.Block</span>
&nbsp;
 	&#47;&#47; This is copied from filters.Backend
 	&#47;&#47; eth&#47;filters needs to be initialized from this backend type, so methods needed by</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-5474aaa685c03940e4c36042"role="button" aria-expanded="false" aria-controls="id-5474aaa685c03940e4c36042">
        
            <div class="col-12 col-sm-9 text-start"><h3>Apply L1 cost in API responses</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-5474aaa685c03940e4c36042">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d4a585af86756e2e87946d8d" role="button"
                   aria-expanded="false" aria-controls="id-d4a585af86756e2e87946d8d">
                    <code>eth/state_accessor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/state_accessor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/state_accessor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d4a585af86756e2e87946d8d"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;state_accessor.go op-geth&#47;eth&#47;state_accessor.go</span>
<span class="term-fg1">index 59b471425542fb4b1cb6241a537a7bd231b54512..c5f34822e15410bb772ad9f6771e8809b894cdd7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;state_accessor.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;state_accessor.go</span>
<span class="term-fg36">@@ -214,7 +214,7 @@</span> 	for idx, tx := range block.Transactions() {
 		&#47;&#47; Assemble the transaction call message and return if the requested offset
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), eth.blockchain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), eth.blockchain, nil, eth.blockchain.Config(), statedb)</span>
 		if idx == txIndex {
 			return msg, context, statedb, release, nil
 		}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-7467fb8d16390b5b95ae5d7d"role="button" aria-expanded="false" aria-controls="id-7467fb8d16390b5b95ae5d7d">
        
            <div class="col-12 col-sm-9 text-start"><h3>API frontend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+228</span></div>
                <div class="text-start"><span class="text-danger">-14</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-7467fb8d16390b5b95ae5d7d">
        <div><p>Format deposit and L1-cost data in transaction responses.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-aec353c6b6171b5c9b04f802" role="button"
                   aria-expanded="false" aria-controls="id-aec353c6b6171b5c9b04f802">
                    <code>internal/ethapi/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/internal/ethapi/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/internal/ethapi/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+218</span></div>
                        <div class="text-start"><span class="text-danger">-14</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-aec353c6b6171b5c9b04f802"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;api.go op-geth&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg1">index 93a2d1264d3248adac1a4fc6ea0c6713214e9207..97575366f4477787ea46af2fb8e65c5bf2887dfe 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg36">@@ -25,7 +25,11 @@</span> 	&quot;math&#47;big&quot;
 	&quot;strings&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;davecgh&#47;go-spew&#47;spew&quot;
<span class="term-fg32">+	&quot;github.com&#47;tyler-smith&#47;go-bip39&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;abi&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
<span class="term-fg36">@@ -46,7 +50,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg31">-	&quot;github.com&#47;tyler-smith&#47;go-bip39&quot;</span>
 )
&nbsp;
 &#47;&#47; EthereumAPI provides an API to access Ethereum related information.
<span class="term-fg36">@@ -630,10 +633,29 @@</span> &#47;&#47; GetBalance returns the amount of wei for the given address in the state of the
 &#47;&#47; given block number. The rpc.LatestBlockNumber and rpc.PendingBlockNumber meta
 &#47;&#47; block numbers are also allowed.
 func (s *BlockChainAPI) GetBalance(ctx context.Context, address common.Address, blockNrOrHash rpc.BlockNumberOrHash) (*hexutil.Big, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Big</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getBalance&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	return (*hexutil.Big)(state.GetBalance(address)), state.Error()
 }
&nbsp;
<span class="term-fg36">@@ -656,6 +678,22 @@</span> }
&nbsp;
 &#47;&#47; GetProof returns the Merkle-proof for a given account and optionally some storage keys.
 func (s *BlockChainAPI) GetProof(ctx context.Context, address common.Address, storageKeys []string, blockNrOrHash rpc.BlockNumberOrHash) (*AccountResult, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res AccountResult</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getProof&quot;, address, storageKeys, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
<span class="term-fg36">@@ -836,10 +874,29 @@</span> }
&nbsp;
 &#47;&#47; GetCode returns the code stored at the given address in the state for the given block number.
 func (s *BlockChainAPI) GetCode(ctx context.Context, address common.Address, blockNrOrHash rpc.BlockNumberOrHash) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getCode&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	code := state.GetCode(address)
 	return code, state.Error()
 }
<span class="term-fg36">@@ -848,10 +905,29 @@</span> &#47;&#47; GetStorageAt returns the storage from the state at the given address, key and
 &#47;&#47; block number. The rpc.LatestBlockNumber and rpc.PendingBlockNumber meta block
 &#47;&#47; numbers are also allowed.
 func (s *BlockChainAPI) GetStorageAt(ctx context.Context, address common.Address, hexKey string, blockNrOrHash rpc.BlockNumberOrHash) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getStorageAt&quot;, address, hexKey, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	key, err := decodeHash(hexKey)
 	if err != nil {
 		return nil, fmt.Errorf(&quot;unable to decode storage key: %s&quot;, err)
<span class="term-fg36">@@ -860,6 +936,18 @@</span> 	res := state.GetState(address, key)
 	return res[:], state.Error()
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; The HeaderByNumberOrHash method returns a nil error and nil header</span>
<span class="term-fg32">+&#47;&#47; if the header is not found, but only for nonexistent block numbers. This is</span>
<span class="term-fg32">+&#47;&#47; different from StateAndHeaderByNumberOrHash. To account for this discrepancy,</span>
<span class="term-fg32">+&#47;&#47; headerOrNumberByHash will properly convert the error into an ethereum.NotFound.</span>
<span class="term-fg32">+func headerByNumberOrHash(ctx context.Context, b Backend, blockNrOrHash rpc.BlockNumberOrHash) (*types.Header, error) {</span>
<span class="term-fg32">+	header, err := b.HeaderByNumberOrHash(ctx, blockNrOrHash)</span>
<span class="term-fg32">+	if header == nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;header %w&quot;, ethereum.NotFound)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return header, err</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; OverrideAccount indicates the overriding fields of account during the execution
 &#47;&#47; of a message call.
 &#47;&#47; Note, state and stateDiff can&#39;t be specified at the same time. If state is
<span class="term-fg36">@@ -1047,6 +1135,24 @@</span> &#47;&#47;
 &#47;&#47; Note, this function doesn&#39;t make and changes in the state&#47;blockchain and is
 &#47;&#47; useful to execute and retrieve values.
 func (s *BlockChainAPI) Call(ctx context.Context, args TransactionArgs, blockNrOrHash rpc.BlockNumberOrHash, overrides *StateOverride) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_call&quot;, args, blockNrOrHash, overrides)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	result, err := DoCall(ctx, s.b, args, blockNrOrHash, overrides, s.b.RPCEVMTimeout(), s.b.RPCGasCap())
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -1185,6 +1291,25 @@</span> 	bNrOrHash := rpc.BlockNumberOrHashWithNumber(rpc.PendingBlockNumber)
 	if blockNrOrHash != nil {
 		bNrOrHash = *blockNrOrHash
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, bNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return 0, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Uint64</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_estimateGas&quot;, args, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return 0, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return 0, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return DoEstimateGas(ctx, s.b, args, bNrOrHash, s.b.RPCGasCap())
 }
&nbsp;
<span class="term-fg36">@@ -1224,7 +1349,7 @@</span>
 &#47;&#47; RPCMarshalBlock converts the given block to the RPC output which depends on fullTx. If inclTx is true transactions are
 &#47;&#47; returned. When fullTx is true the returned block contains full transaction details, otherwise it will only contain
 &#47;&#47; transaction hashes.
<span class="term-fg31">-func RPCMarshalBlock(block *types.Block, inclTx bool, fullTx bool, config *params.ChainConfig) (map[string]interface{}, error) {</span>
<span class="term-fg32">+func RPCMarshalBlock(ctx context.Context, block *types.Block, inclTx bool, fullTx bool, backend Backend) (map[string]interface{}, error) {</span>
 	fields := RPCMarshalHeader(block.Header())
 	fields[&quot;size&quot;] = hexutil.Uint64(block.Size())
&nbsp;
<span class="term-fg36">@@ -1234,7 +1359,7 @@</span> 			return tx.Hash(), nil
 		}
 		if fullTx {
 			formatTx = func(tx *types.Transaction) (interface{}, error) {
<span class="term-fg31">-				return newRPCTransactionFromBlockHash(block, tx.Hash(), config), nil</span>
<span class="term-fg32">+				return newRPCTransactionFromBlockHash(ctx, block, tx.Hash(), backend), nil</span>
 			}
 		}
 		txs := block.Transactions()
<span class="term-fg36">@@ -1270,7 +1395,7 @@</span>
 &#47;&#47; rpcMarshalBlock uses the generalized output filler, then adds the total difficulty field, which requires
 &#47;&#47; a `BlockchainAPI`.
 func (s *BlockChainAPI) rpcMarshalBlock(ctx context.Context, b *types.Block, inclTx bool, fullTx bool) (map[string]interface{}, error) {
<span class="term-fg31">-	fields, err := RPCMarshalBlock(b, inclTx, fullTx, s.b.ChainConfig())</span>
<span class="term-fg32">+	fields, err := RPCMarshalBlock(ctx, b, inclTx, fullTx, s.b)</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -1301,11 +1426,16 @@</span> 	ChainID          *hexutil.Big      `json:&quot;chainId,omitempty&quot;`
 	V                *hexutil.Big      `json:&quot;v&quot;`
 	R                *hexutil.Big      `json:&quot;r&quot;`
 	S                *hexutil.Big      `json:&quot;s&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; deposit-tx only</span>
<span class="term-fg32">+	SourceHash *common.Hash `json:&quot;sourceHash,omitempty&quot;`</span>
<span class="term-fg32">+	Mint       *hexutil.Big `json:&quot;mint,omitempty&quot;`</span>
<span class="term-fg32">+	IsSystemTx *bool        `json:&quot;isSystemTx,omitempty&quot;`</span>
 }
&nbsp;
 &#47;&#47; newRPCTransaction returns a transaction that will serialize to the RPC
 &#47;&#47; representation, with the given location metadata set (if available).
<span class="term-fg31">-func newRPCTransaction(tx *types.Transaction, blockHash common.Hash, blockNumber uint64, index uint64, baseFee *big.Int, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransaction(tx *types.Transaction, blockHash common.Hash, blockNumber uint64, index uint64, baseFee *big.Int, config *params.ChainConfig, receipt *types.Receipt) *RPCTransaction {</span>
 	signer := types.MakeSigner(config, new(big.Int).SetUint64(blockNumber))
 	from, _ := types.Sender(signer, tx)
 	v, r, s := tx.RawSignatureValues()
<span class="term-fg36">@@ -1328,7 +1458,20 @@</span> 		result.BlockHash = &amp;blockHash
 		result.BlockNumber = (*hexutil.Big)(new(big.Int).SetUint64(blockNumber))
 		result.TransactionIndex = (*hexutil.Uint64)(&amp;index)
 	}
<span class="term-fg32">+</span>
 	switch tx.Type() {
<span class="term-fg32">+	case types.DepositTxType:</span>
<span class="term-fg32">+		srcHash := tx.SourceHash()</span>
<span class="term-fg32">+		isSystemTx := tx.IsSystemTx()</span>
<span class="term-fg32">+		result.SourceHash = &amp;srcHash</span>
<span class="term-fg32">+		if isSystemTx {</span>
<span class="term-fg32">+			&#47;&#47; Only include IsSystemTx when true</span>
<span class="term-fg32">+			result.IsSystemTx = &amp;isSystemTx</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		result.Mint = (*hexutil.Big)(tx.Mint())</span>
<span class="term-fg32">+		if receipt != nil &amp;&amp; receipt.DepositNonce != nil {</span>
<span class="term-fg32">+			result.Nonce = hexutil.Uint64(*receipt.DepositNonce)</span>
<span class="term-fg32">+		}</span>
 	case types.LegacyTxType:
 		&#47;&#47; if a legacy transaction has an EIP-155 chain id, include it explicitly
 		if id := tx.ChainId(); id.Sign() != 0 {
<span class="term-fg36">@@ -1364,16 +1507,32 @@</span> 	if current != nil {
 		baseFee = misc.CalcBaseFee(config, current)
 		blockNumber = current.Number.Uint64()
 	}
<span class="term-fg31">-	return newRPCTransaction(tx, common.Hash{}, blockNumber, 0, baseFee, config)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, common.Hash{}, blockNumber, 0, baseFee, config, nil)</span>
 }
&nbsp;
 &#47;&#47; newRPCTransactionFromBlockIndex returns a transaction that will serialize to the RPC representation.
<span class="term-fg31">-func newRPCTransactionFromBlockIndex(b *types.Block, index uint64, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransactionFromBlockIndex(ctx context.Context, b *types.Block, index uint64, backend Backend) *RPCTransaction {</span>
 	txs := b.Transactions()
 	if index &gt;= uint64(len(txs)) {
 		return nil
 	}
<span class="term-fg31">-	return newRPCTransaction(txs[index], b.Hash(), b.NumberU64(), index, b.BaseFee(), config)</span>
<span class="term-fg32">+	tx := txs[index]</span>
<span class="term-fg32">+	rcpt := depositTxReceipt(ctx, b.Hash(), index, backend, tx)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, b.Hash(), b.NumberU64(), index, b.BaseFee(), backend.ChainConfig(), rcpt)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func depositTxReceipt(ctx context.Context, blockHash common.Hash, index uint64, backend Backend, tx *types.Transaction) *types.Receipt {</span>
<span class="term-fg32">+	if tx.Type() != types.DepositTxType {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	receipts, err := backend.GetReceipts(ctx, blockHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if index &gt;= uint64(len(receipts)) {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return receipts[index]</span>
 }
&nbsp;
 &#47;&#47; newRPCRawTransactionFromBlockIndex returns the bytes of a transaction given a block and a transaction index.
<span class="term-fg36">@@ -1387,10 +1546,10 @@</span> 	return blob
 }
&nbsp;
 &#47;&#47; newRPCTransactionFromBlockHash returns a transaction that will serialize to the RPC representation.
<span class="term-fg31">-func newRPCTransactionFromBlockHash(b *types.Block, hash common.Hash, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransactionFromBlockHash(ctx context.Context, b *types.Block, hash common.Hash, backend Backend) *RPCTransaction {</span>
 	for idx, tx := range b.Transactions() {
 		if tx.Hash() == hash {
<span class="term-fg31">-			return newRPCTransactionFromBlockIndex(b, uint64(idx), config)</span>
<span class="term-fg32">+			return newRPCTransactionFromBlockIndex(ctx, b, uint64(idx), backend)</span>
 		}
 	}
 	return nil
<span class="term-fg36">@@ -1412,6 +1571,21 @@</span> 	bNrOrHash := rpc.BlockNumberOrHashWithNumber(rpc.PendingBlockNumber)
 	if blockNrOrHash != nil {
 		bNrOrHash = *blockNrOrHash
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, bNrOrHash)</span>
<span class="term-fg32">+	if err == nil &amp;&amp; header != nil &amp;&amp; s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res accessListResult</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_createAccessList&quot;, args, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	acl, gasUsed, vmerr, err := AccessList(ctx, s.b, bNrOrHash, args)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -1525,7 +1699,7 @@</span>
 &#47;&#47; GetTransactionByBlockNumberAndIndex returns the transaction for the given block number and index.
 func (s *TransactionAPI) GetTransactionByBlockNumberAndIndex(ctx context.Context, blockNr rpc.BlockNumber, index hexutil.Uint) *RPCTransaction {
 	if block, _ := s.b.BlockByNumber(ctx, blockNr); block != nil {
<span class="term-fg31">-		return newRPCTransactionFromBlockIndex(block, uint64(index), s.b.ChainConfig())</span>
<span class="term-fg32">+		return newRPCTransactionFromBlockIndex(ctx, block, uint64(index), s.b)</span>
 	}
 	return nil
 }
<span class="term-fg36">@@ -1533,7 +1707,7 @@</span>
 &#47;&#47; GetTransactionByBlockHashAndIndex returns the transaction for the given block hash and index.
 func (s *TransactionAPI) GetTransactionByBlockHashAndIndex(ctx context.Context, blockHash common.Hash, index hexutil.Uint) *RPCTransaction {
 	if block, _ := s.b.BlockByHash(ctx, blockHash); block != nil {
<span class="term-fg31">-		return newRPCTransactionFromBlockIndex(block, uint64(index), s.b.ChainConfig())</span>
<span class="term-fg32">+		return newRPCTransactionFromBlockIndex(ctx, block, uint64(index), s.b)</span>
 	}
 	return nil
 }
<span class="term-fg36">@@ -1565,10 +1739,29 @@</span> 		}
 		return (*hexutil.Uint64)(&amp;nonce), nil
 	}
 	&#47;&#47; Resolve block number and use its state to ask for the nonce
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Uint64</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getTransactionCount&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	nonce := state.GetNonce(address)
 	return (*hexutil.Uint64)(&amp;nonce), state.Error()
 }
<span class="term-fg36">@@ -1585,7 +1778,8 @@</span> 		header, err := s.b.HeaderByHash(ctx, blockHash)
 		if err != nil {
 			return nil, err
 		}
<span class="term-fg31">-		return newRPCTransaction(tx, blockHash, blockNumber, index, header.BaseFee, s.b.ChainConfig()), nil</span>
<span class="term-fg32">+		rcpt := depositTxReceipt(ctx, blockHash, index, s.b, tx)</span>
<span class="term-fg32">+		return newRPCTransaction(tx, blockHash, blockNumber, index, header.BaseFee, s.b.ChainConfig(), rcpt), nil</span>
 	}
 	&#47;&#47; No finalized transaction, try to retrieve it from the pool
 	if tx := s.b.GetPoolTransaction(hash); tx != nil {
<span class="term-fg36">@@ -1626,7 +1820,7 @@</span> 	receipts, err := s.b.GetReceipts(ctx, blockHash)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	if len(receipts) &lt;= int(index) {</span>
<span class="term-fg32">+	if uint64(len(receipts)) &lt;= index {</span>
 		return nil, nil
 	}
 	receipt := receipts[index]
<span class="term-fg36">@@ -1650,6 +1844,16 @@</span> 		&quot;logs&quot;:              receipt.Logs,
 		&quot;logsBloom&quot;:         receipt.Bloom,
 		&quot;type&quot;:              hexutil.Uint(tx.Type()),
 		&quot;effectiveGasPrice&quot;: (*hexutil.Big)(receipt.EffectiveGasPrice),
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().Optimism != nil &amp;&amp; !tx.IsDepositTx() {</span>
<span class="term-fg32">+		fields[&quot;l1GasPrice&quot;] = (*hexutil.Big)(receipt.L1GasPrice)</span>
<span class="term-fg32">+		fields[&quot;l1GasUsed&quot;] = (*hexutil.Big)(receipt.L1GasUsed)</span>
<span class="term-fg32">+		fields[&quot;l1Fee&quot;] = (*hexutil.Big)(receipt.L1Fee)</span>
<span class="term-fg32">+		fields[&quot;l1FeeScalar&quot;] = receipt.FeeScalar.String()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.b.ChainConfig().Optimism != nil &amp;&amp; tx.IsDepositTx() &amp;&amp; receipt.DepositNonce != nil {</span>
<span class="term-fg32">+		fields[&quot;depositNonce&quot;] = hexutil.Uint64(*receipt.DepositNonce)</span>
 	}
&nbsp;
 	&#47;&#47; Assign receipt status or post state.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-694fe03ec7e92726b84d373b" role="button"
                   aria-expanded="false" aria-controls="id-694fe03ec7e92726b84d373b">
                    <code>rpc/errors.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rpc/errors.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rpc/errors.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-694fe03ec7e92726b84d373b"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;errors.go op-geth&#47;rpc&#47;errors.go</span>
<span class="term-fg1">index 7188332d551ebdcd541438d7a58daad996b5c70f..4a2dab3d9836494a8618d56bfa204e2339a12491 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;errors.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;errors.go</span>
<span class="term-fg36">@@ -69,6 +69,16 @@</span> const (
 	errMsgTimeout = &quot;request timed out&quot;
 )
&nbsp;
<span class="term-fg32">+var ErrNoHistoricalFallback = NoHistoricalFallbackError{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type NoHistoricalFallbackError struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (e NoHistoricalFallbackError) ErrorCode() int { return -32801 }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (e NoHistoricalFallbackError) Error() string {</span>
<span class="term-fg32">+	return &quot;no historical RPC is available for this historical (pre-bedrock) execution request&quot;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 type methodNotFoundError struct{ method string }
&nbsp;
 func (e *methodNotFoundError) ErrorCode() int { return -32601 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-6822a199dfca29adcc9e52ca"role="button" aria-expanded="false" aria-controls="id-6822a199dfca29adcc9e52ca">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tracer RPC daisy-chain</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+59</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-6822a199dfca29adcc9e52ca">
        <div><p>Forward pre-bedrock tracing calls to legacy node.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2a832973b6b4f3234cc66a16" role="button"
                   aria-expanded="false" aria-controls="id-2a832973b6b4f3234cc66a16">
                    <code>eth/tracers/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/tracers/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/tracers/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+59</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2a832973b6b4f3234cc66a16"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;api.go op-geth&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg1">index 58ad0c3c9ad768f883047d7d75181253b81fe2f1..c32f03857748363bafd4fbd5f77ccc00c7905827 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg36">@@ -23,6 +23,7 @@</span> 	&quot;context&quot;
 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
 	&quot;os&quot;
 	&quot;runtime&quot;
 	&quot;sync&quot;
<span class="term-fg36">@@ -68,8 +69,6 @@</span> 	&#47;&#47; trace states exceed this limit.
 	maximumPendingTraceStates = 128
 )
&nbsp;
<span class="term-fg31">-var errTxNotFound = errors.New(&quot;transaction not found&quot;)</span>
<span class="term-fg31">-</span>
 &#47;&#47; StateReleaseFunc is used to deallocate resources held by constructing a
 &#47;&#47; historical state for tracing purposes.
 type StateReleaseFunc func()
<span class="term-fg36">@@ -88,6 +87,7 @@</span> 	Engine() consensus.Engine
 	ChainDb() ethdb.Database
 	StateAtBlock(ctx context.Context, block *types.Block, reexec uint64, base *state.StateDB, readOnly bool, preferDisk bool) (*state.StateDB, StateReleaseFunc, error)
 	StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, StateReleaseFunc, error)
<span class="term-fg32">+	HistoricalRPCService() *rpc.Client</span>
 }
&nbsp;
 &#47;&#47; API is the collection of tracing APIs exposed over the private debugging endpoint.
<span class="term-fg36">@@ -231,6 +231,7 @@</span>
 &#47;&#47; TraceChain returns the structured logs created during the execution of EVM
 &#47;&#47; between two blocks (excluding start) and returns them as a JSON object.
 func (api *API) TraceChain(ctx context.Context, start, end rpc.BlockNumber, config *TraceConfig) (*rpc.Subscription, error) { &#47;&#47; Fetch the block interval that we want to trace
<span class="term-fg32">+	&#47;&#47; TODO: Need to implement a fallback for this</span>
 	from, err := api.blockByNumber(ctx, start)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -289,7 +290,7 @@</span> 			&#47;&#47; Fetch and execute the block trace taskCh
 			for task := range taskCh {
 				var (
 					signer   = types.MakeSigner(api.backend.ChainConfig(), task.block.Number())
<span class="term-fg31">-					blockCtx = core.NewEVMBlockContext(task.block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+					blockCtx = core.NewEVMBlockContext(task.block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), task.statedb)</span>
 				)
 				&#47;&#47; Trace all the transactions contained within
 				for i, tx := range task.block.Transactions() {
<span class="term-fg36">@@ -459,6 +460,20 @@</span> 	block, err := api.blockByNumber(ctx, number)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult []*txTraceResult</span>
<span class="term-fg32">+			err = api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceBlockByNumber&quot;, number, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return api.traceBlock(ctx, block, config)
 }
&nbsp;
<span class="term-fg36">@@ -469,6 +484,20 @@</span> 	block, err := api.blockByHash(ctx, hash)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult []*txTraceResult</span>
<span class="term-fg32">+			err = api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceBlockByHash&quot;, hash, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return api.traceBlock(ctx, block, config)
 }
&nbsp;
<span class="term-fg36">@@ -518,6 +547,7 @@</span> &#47;&#47; IntermediateRoots executes a block (bad- or canon- or side-), and returns a list
 &#47;&#47; of intermediate roots: the stateroot after each transaction.
 func (api *API) IntermediateRoots(ctx context.Context, hash common.Hash, config *TraceConfig) ([]common.Hash, error) {
 	block, _ := api.blockByHash(ctx, hash)
<span class="term-fg32">+	&#47;&#47; TODO: Cannot get intermediate roots for pre-bedrock block without daisy chain</span>
 	if block == nil {
 		&#47;&#47; Check in the bad blocks
 		block = rawdb.ReadBadBlock(api.backend.ChainDb(), hash)
<span class="term-fg36">@@ -546,7 +576,7 @@</span> 	var (
 		roots              []common.Hash
 		signer             = types.MakeSigner(api.backend.ChainConfig(), block.Number())
 		chainConfig        = api.backend.ChainConfig()
<span class="term-fg31">-		vmctx              = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		vmctx              = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, chainConfig, statedb)</span>
 		deleteEmptyObjects = chainConfig.IsEIP158(block.Number())
 	)
 	for i, tx := range block.Transactions() {
<span class="term-fg36">@@ -622,7 +652,7 @@</span> 	var (
 		txs       = block.Transactions()
 		blockHash = block.Hash()
 		is158     = api.backend.ChainConfig().IsEIP158(block.Number())
<span class="term-fg31">-		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 		signer    = types.MakeSigner(api.backend.ChainConfig(), block.Number())
 		results   = make([]*txTraceResult, len(txs))
 	)
<span class="term-fg36">@@ -655,7 +685,6 @@</span> 	&#47;&#47; Execute all the transaction contained within the block concurrently
 	var (
 		txs       = block.Transactions()
 		blockHash = block.Hash()
<span class="term-fg31">-		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
 		signer    = types.MakeSigner(api.backend.ChainConfig(), block.Number())
 		results   = make([]*txTraceResult, len(txs))
 		pend      sync.WaitGroup
<span class="term-fg36">@@ -671,6 +700,7 @@</span> 		go func() {
 			defer pend.Done()
 			&#47;&#47; Fetch and execute the next transaction trace tasks
 			for task := range jobs {
<span class="term-fg32">+				blockCtx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), task.statedb)</span>
 				msg, _ := core.TransactionToMessage(txs[task.index], signer, block.BaseFee())
 				txctx := &amp;Context{
 					BlockHash:   blockHash,
<span class="term-fg36">@@ -690,6 +720,7 @@</span> 	}
&nbsp;
 	&#47;&#47; Feed the transactions into the tracers and return
 	var failed error
<span class="term-fg32">+	blockCtx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 txloop:
 	for i, tx := range txs {
 		&#47;&#47; Send the trace task over for execution
<span class="term-fg36">@@ -767,7 +798,7 @@</span> 	var (
 		dumps       []string
 		signer      = types.MakeSigner(api.backend.ChainConfig(), block.Number())
 		chainConfig = api.backend.ChainConfig()
<span class="term-fg31">-		vmctx       = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		vmctx       = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, chainConfig, statedb)</span>
 		canon       = true
 	)
 	&#47;&#47; Check if there are any overrides: the caller may wish to enable a future
<span class="term-fg36">@@ -850,14 +881,25 @@</span>
 &#47;&#47; TraceTransaction returns the structured logs created during the execution of EVM
 &#47;&#47; and returns them as a JSON object.
 func (api *API) TraceTransaction(ctx context.Context, hash common.Hash, config *TraceConfig) (interface{}, error) {
<span class="term-fg31">-	tx, blockHash, blockNumber, index, err := api.backend.GetTransaction(ctx, hash)</span>
<span class="term-fg32">+	&#47;&#47; GetTransaction returns 0 for the blocknumber if the transaction is not found</span>
<span class="term-fg32">+	_, blockHash, blockNumber, index, err := api.backend.GetTransaction(ctx, hash)</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	&#47;&#47; Only mined txes are supported</span>
<span class="term-fg31">-	if tx == nil {</span>
<span class="term-fg31">-		return nil, errTxNotFound</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(new(big.Int).SetUint64(blockNumber)) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult json.RawMessage</span>
<span class="term-fg32">+			err := api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceTransaction&quot;, hash, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
 	}
<span class="term-fg32">+</span>
 	&#47;&#47; It shouldn&#39;t happen in practice.
 	if blockNumber == 0 {
 		return nil, errors.New(&quot;genesis is not traceable&quot;)
<span class="term-fg36">@@ -912,6 +954,11 @@</span> 	}
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		return nil, errors.New(&quot;l2geth does not have a debug_traceCall method&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; try to recompute the state
 	reexec := defaultTraceReexec
 	if config != nil &amp;&amp; config.Reexec != nil {
<span class="term-fg36">@@ -923,7 +970,7 @@</span> 		return nil, err
 	}
 	defer release()
&nbsp;
<span class="term-fg31">-	vmctx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+	vmctx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 	&#47;&#47; Apply the customization rules if required.
 	if config != nil {
 		if err := config.StateOverrides.Apply(statedb); err != nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-731c4f64c1d61f6526629092"role="button" aria-expanded="false" aria-controls="id-731c4f64c1d61f6526629092">
        
            <div class="col-12 col-sm-9 text-start"><h3>Light Ethereum Subprotocol (LES) RPC</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+36</span></div>
                <div class="text-start"><span class="text-danger">-4</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-731c4f64c1d61f6526629092">
        <div><p>Match the RPC changes in the LES RPC</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b3e46131dc2538159c943d72" role="button"
                   aria-expanded="false" aria-controls="id-b3e46131dc2538159c943d72">
                    <code>les/client.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/les/client.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/les/client.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+24</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b3e46131dc2538159c943d72"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;client.go op-geth&#47;les&#47;client.go</span>
<span class="term-fg1">index 9ac85ecdac6fb5d2f41c88f13ad9e5fd37ae09c2..b40f1372bc1594fffb1ae84ed5fd804052b934d1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;client.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;client.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> &#47;&#47; Package les implements the Light Ethereum Subprotocol.
 package les
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;fmt&quot;
 	&quot;strings&quot;
 	&quot;time&quot;
<span class="term-fg36">@@ -66,6 +67,9 @@</span> 	serverPool         *vfc.ServerPool
 	serverPoolIterator enode.Iterator
 	pruner             *pruner
 	merger             *consensus.Merger
<span class="term-fg32">+</span>
<span class="term-fg32">+	seqRPCService        *rpc.Client</span>
<span class="term-fg32">+	historicalRPCService *rpc.Client</span>
&nbsp;
 	bloomRequests chan chan *bloombits.Retrieval &#47;&#47; Channel receiving bloom data retrieval requests
 	bloomIndexer  *core.ChainIndexer             &#47;&#47; Bloom indexer operating during block imports
<span class="term-fg36">@@ -195,6 +199,26 @@</span> 	leth.handler = newClientHandler(config.UltraLightServers, config.UltraLightFraction, checkpoint, leth)
 	if leth.handler.ulc != nil {
 		log.Warn(&quot;Ultra light client is enabled&quot;, &quot;trustedNodes&quot;, len(leth.handler.ulc.keys), &quot;minTrustedFraction&quot;, leth.handler.ulc.fraction)
 		leth.blockchain.DisableCheckFreq()
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupSequencerHTTP != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupSequencerHTTP)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		leth.seqRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupHistoricalRPC != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), config.RollupHistoricalRPCTimeout)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupHistoricalRPC)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		leth.historicalRPCService = client</span>
 	}
&nbsp;
 	leth.netRPCService = ethapi.NewNetAPI(leth.p2pServer, leth.config.NetworkId)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e278c4048533b608327bb922" role="button"
                   aria-expanded="false" aria-controls="id-e278c4048533b608327bb922">
                    <code>les/api_backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/les/api_backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/les/api_backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e278c4048533b608327bb922"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;api_backend.go op-geth&#47;les&#47;api_backend.go</span>
<span class="term-fg1">index 4b0369845a5a24f8dd4beb74a322a9f41d4043c5..8a5ed1ba754945bc87076b2fffdd3d364312271b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;api_backend.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;api_backend.go</span>
<span class="term-fg36">@@ -189,7 +189,7 @@</span> 	if vmConfig == nil {
 		vmConfig = new(vm.Config)
 	}
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(header, b.eth.blockchain, nil)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(header, b.eth.blockchain, nil, b.eth.chainConfig, state)</span>
 	return vm.NewEVM(context, txContext, state, b.eth.chainConfig, *vmConfig), state.Error, nil
 }
&nbsp;
<span class="term-fg36">@@ -333,3 +333,11 @@</span>
 func (b *LesApiBackend) StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, tracers.StateReleaseFunc, error) {
 	return b.eth.stateAtTransaction(ctx, block, txIndex, reexec)
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *LesApiBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.eth.historicalRPCService</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *LesApiBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	return b.eth.blockchain.Genesis()</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-86559b36ac8866ee7f7fd9cf" role="button"
                   aria-expanded="false" aria-controls="id-86559b36ac8866ee7f7fd9cf">
                    <code>les/odr_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/les/odr_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/les/odr_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-86559b36ac8866ee7f7fd9cf"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;odr_test.go op-geth&#47;les&#47;odr_test.go</span>
<span class="term-fg1">index 90b7cd08d7f5c42c2a923b30e49321914462550b..8654bb4bdad8c4a6a853f919dbe7431918311abd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;odr_test.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;odr_test.go</span>
<span class="term-fg36">@@ -142,7 +142,7 @@</span> 					Data:              data,
 					SkipAccountChecks: true,
 				}
&nbsp;
<span class="term-fg31">-				context := core.NewEVMBlockContext(header, bc, nil)</span>
<span class="term-fg32">+				context := core.NewEVMBlockContext(header, bc, nil, config, statedb)</span>
 				txContext := core.NewEVMTxContext(msg)
 				vmenv := vm.NewEVM(context, txContext, statedb, config, vm.Config{NoBaseFee: true})
&nbsp;
<span class="term-fg36">@@ -166,7 +166,7 @@</span> 				GasTipCap:         new(big.Int),
 				Data:              data,
 				SkipAccountChecks: true,
 			}
<span class="term-fg31">-			context := core.NewEVMBlockContext(header, lc, nil)</span>
<span class="term-fg32">+			context := core.NewEVMBlockContext(header, lc, nil, config, state)</span>
 			txContext := core.NewEVMTxContext(msg)
 			vmenv := vm.NewEVM(context, txContext, state, config, vm.Config{NoBaseFee: true})
 			gp := new(core.GasPool).AddGas(math.MaxUint64)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b33c35626f05a7bc82e9ee50" role="button"
                   aria-expanded="false" aria-controls="id-b33c35626f05a7bc82e9ee50">
                    <code>les/state_accessor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/les/state_accessor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/les/state_accessor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b33c35626f05a7bc82e9ee50"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;state_accessor.go op-geth&#47;les&#47;state_accessor.go</span>
<span class="term-fg1">index 030d6b5a50044abe36d871f474c14a64c9eef77c..b6ba7f8f04322a9f714666a65b7e5ac1abb1beb1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;state_accessor.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;state_accessor.go</span>
<span class="term-fg36">@@ -62,7 +62,7 @@</span> 	for idx, tx := range block.Transactions() {
 		&#47;&#47; Assemble the transaction call message and return if the requested offset
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), leth.blockchain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), leth.blockchain, nil, leth.blockchain.Config(), statedb)</span>
 		statedb.SetTxContext(tx.Hash(), idx)
 		if idx == txIndex {
 			return msg, context, statedb, release, nil</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4811dd4c7fed97b907320525"role="button" aria-expanded="false" aria-controls="id-4811dd4c7fed97b907320525">
        
            <div class="col-12 col-sm-9 text-start"><h3>Daisy Chain tests</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+350</span></div>
                <div class="text-start"><span class="text-danger">-18</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4811dd4c7fed97b907320525">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e90d754efe30f96e10043797" role="button"
                   aria-expanded="false" aria-controls="id-e90d754efe30f96e10043797">
                    <code>internal/ethapi/transaction_args_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/internal/ethapi/transaction_args_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/internal/ethapi/transaction_args_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e90d754efe30f96e10043797"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;transaction_args_test.go op-geth&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg1">index 1b533861d5d6e3c3777ca8f0b9ce8121606ae121..a62e189e00dc6cefdf75689ffa9a25f2e4a66928 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg36">@@ -342,4 +342,6 @@</span> func (b *backendMock) SubscribeRemovedLogsEvent(ch chan&lt;- core.RemovedLogsEvent) event.Subscription {
 	return nil
 }
&nbsp;
<span class="term-fg31">-func (b *backendMock) Engine() consensus.Engine { return nil }</span>
<span class="term-fg32">+func (b *backendMock) Engine() consensus.Engine          { return nil }</span>
<span class="term-fg32">+func (b *backendMock) HistoricalRPCService() *rpc.Client { return nil }</span>
<span class="term-fg32">+func (b *backendMock) Genesis() *types.Block             { return nil }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f7f2dda6e47092d1e85bfbfa" role="button"
                   aria-expanded="false" aria-controls="id-f7f2dda6e47092d1e85bfbfa">
                    <code>ethclient/ethclient_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/ethclient/ethclient_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/ethclient/ethclient_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+151</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f7f2dda6e47092d1e85bfbfa"><span class="term-fg1">diff --git go-ethereum&#47;ethclient&#47;ethclient_test.go op-geth&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg1">index 8bd8b0614c2d6f0fe37b5dd9c0a2da86f57d1892..c22446f6f3bd9a262957877ba2caa54ca1d80cb6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg1">+++ op-geth&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg36">@@ -22,9 +22,14 @@</span> 	&quot;context&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg32">+	&quot;net&quot;</span>
<span class="term-fg32">+	&quot;net&#47;http&quot;</span>
 	&quot;reflect&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;ethapi&quot;</span>
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -194,6 +199,14 @@</span> 	Timestamp: 9000,
 	BaseFee:   big.NewInt(params.InitialBaseFee),
 }
&nbsp;
<span class="term-fg32">+var genesisForHistorical = &amp;core.Genesis{</span>
<span class="term-fg32">+	Config:    params.OptimismTestConfig,</span>
<span class="term-fg32">+	Alloc:     core.GenesisAlloc{testAddr: {Balance: testBalance}},</span>
<span class="term-fg32">+	ExtraData: []byte(&quot;test genesis&quot;),</span>
<span class="term-fg32">+	Timestamp: 9000,</span>
<span class="term-fg32">+	BaseFee:   big.NewInt(params.InitialBaseFee),</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 var testTx1 = types.MustSignNewTx(testKey, types.LatestSigner(genesis.Config), &amp;types.LegacyTx{
 	Nonce:    0,
 	Value:    big.NewInt(12),
<span class="term-fg36">@@ -210,9 +223,64 @@</span> 	Gas:      params.TxGas,
 	To:       &amp;common.Address{2},
 })
&nbsp;
<span class="term-fg31">-func newTestBackend(t *testing.T) (*node.Node, []*types.Block) {</span>
<span class="term-fg32">+type mockHistoricalBackend struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) Call(ctx context.Context, args ethapi.TransactionArgs, blockNrOrHash rpc.BlockNumberOrHash, overrides *ethapi.StateOverride) (hexutil.Bytes, error) {</span>
<span class="term-fg32">+	num, ok := blockNrOrHash.Number()</span>
<span class="term-fg32">+	if ok &amp;&amp; num == 1 {</span>
<span class="term-fg32">+		return hexutil.Bytes(&quot;test&quot;), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil, ethereum.NotFound</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) EstimateGas(ctx context.Context, args ethapi.TransactionArgs, blockNrOrHash *rpc.BlockNumberOrHash) (hexutil.Uint64, error) {</span>
<span class="term-fg32">+	num, ok := blockNrOrHash.Number()</span>
<span class="term-fg32">+	if ok &amp;&amp; num == 1 {</span>
<span class="term-fg32">+		return hexutil.Uint64(12345), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0, ethereum.NotFound</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newMockHistoricalBackend(t *testing.T) string {</span>
<span class="term-fg32">+	s := rpc.NewServer()</span>
<span class="term-fg32">+	err := node.RegisterApis([]rpc.API{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			Namespace:     &quot;eth&quot;,</span>
<span class="term-fg32">+			Service:       new(mockHistoricalBackend),</span>
<span class="term-fg32">+			Public:        true,</span>
<span class="term-fg32">+			Authenticated: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}, nil, s)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	hdlr := node.NewHTTPHandlerStack(s, []string{&quot;*&quot;}, []string{&quot;*&quot;}, nil)</span>
<span class="term-fg32">+	mux := http.NewServeMux()</span>
<span class="term-fg32">+	mux.Handle(&quot;&#47;&quot;, hdlr)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	listener, err := net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend listener: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	go func() {</span>
<span class="term-fg32">+		httpS := &amp;http.Server{Handler: mux}</span>
<span class="term-fg32">+		httpS.Serve(listener)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Cleanup(func() {</span>
<span class="term-fg32">+			httpS.Shutdown(context.Background())</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;http:&#47;&#47;%s&quot;, listener.Addr().String())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newTestBackend(t *testing.T, enableHistoricalState bool) (*node.Node, []*types.Block) {</span>
<span class="term-fg32">+	histAddr := newMockHistoricalBackend(t)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Generate test chain.
<span class="term-fg31">-	blocks := generateTestChain()</span>
<span class="term-fg32">+	blocks := generateTestChain(enableHistoricalState)</span>
&nbsp;
 	&#47;&#47; Create node
 	n, err := node.New(&amp;node.Config{})
<span class="term-fg36">@@ -220,8 +288,18 @@</span> 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new node: %v&quot;, err)
 	}
 	&#47;&#47; Create Ethereum Service
<span class="term-fg31">-	config := &amp;ethconfig.Config{Genesis: genesis}</span>
<span class="term-fg32">+	var actualGenesis *core.Genesis</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		actualGenesis = genesisForHistorical</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		actualGenesis = genesis</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	config := &amp;ethconfig.Config{Genesis: actualGenesis}</span>
 	config.Ethash.PowMode = ethash.ModeFake
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		config.RollupHistoricalRPC = histAddr</span>
<span class="term-fg32">+		config.RollupHistoricalRPCTimeout = time.Second * 5</span>
<span class="term-fg32">+	}</span>
 	ethservice, err := eth.New(n, config)
 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new ethereum service: %v&quot;, err)
<span class="term-fg36">@@ -236,7 +314,7 @@</span> 	}
 	return n, blocks
 }
&nbsp;
<span class="term-fg31">-func generateTestChain() []*types.Block {</span>
<span class="term-fg32">+func generateTestChain(enableHistoricalState bool) []*types.Block {</span>
 	generate := func(i int, g *core.BlockGen) {
 		g.OffsetTime(5)
 		g.SetExtra([]byte(&quot;test&quot;))
<span class="term-fg36">@@ -246,12 +324,27 @@</span> 			g.AddTx(testTx1)
 			g.AddTx(testTx2)
 		}
 	}
<span class="term-fg31">-	_, blocks, _ := core.GenerateChainWithGenesis(genesis, ethash.NewFaker(), 2, generate)</span>
<span class="term-fg31">-	return append([]*types.Block{genesis.ToBlock()}, blocks...)</span>
<span class="term-fg32">+	var actualGenesis *core.Genesis</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		actualGenesis = genesisForHistorical</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		actualGenesis = genesis</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	_, blocks, _ := core.GenerateChainWithGenesis(actualGenesis, ethash.NewFaker(), 2, generate)</span>
<span class="term-fg32">+	return append([]*types.Block{actualGenesis.ToBlock()}, blocks...)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestEthClientHistoricalBackend(t *testing.T) {</span>
<span class="term-fg32">+	backend, _ := newTestBackend(t, true)</span>
<span class="term-fg32">+	client, _ := backend.Attach()</span>
<span class="term-fg32">+	defer backend.Close()</span>
<span class="term-fg32">+	defer client.Close()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	testHistoricalRPC(t, client)</span>
 }
&nbsp;
 func TestEthClient(t *testing.T) {
<span class="term-fg31">-	backend, chain := newTestBackend(t)</span>
<span class="term-fg32">+	backend, chain := newTestBackend(t, false)</span>
 	client, _ := backend.Attach()
 	defer backend.Close()
 	defer client.Close()
<span class="term-fg36">@@ -288,6 +381,9 @@</span> 			func(t *testing.T) { testAtFunctions(t, client) },
 		},
 		&quot;TransactionSender&quot;: {
 			func(t *testing.T) { testTransactionSender(t, client) },
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&quot;EstimateGas&quot;: {</span>
<span class="term-fg32">+			func(t *testing.T) { testEstimateGas(t, client) },</span>
 		},
 	}
&nbsp;
<span class="term-fg36">@@ -684,6 +780,54 @@</span> 		t.Fatal(err)
 	}
 	if sender2 != testAddr {
 		t.Fatal(&quot;wrong sender:&quot;, sender2)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testEstimateGas(t *testing.T, client *rpc.Client) {</span>
<span class="term-fg32">+	ec := NewClient(client)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; EstimateGas</span>
<span class="term-fg32">+	msg := ethereum.CallMsg{</span>
<span class="term-fg32">+		From:  testAddr,</span>
<span class="term-fg32">+		To:    &amp;common.Address{},</span>
<span class="term-fg32">+		Gas:   21000,</span>
<span class="term-fg32">+		Value: big.NewInt(1),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	gas, err := ec.EstimateGas(context.Background(), msg)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if gas != 21000 {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected gas price: %v&quot;, gas)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testHistoricalRPC(t *testing.T, client *rpc.Client) {</span>
<span class="term-fg32">+	ec := NewClient(client)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Estimate Gas RPC</span>
<span class="term-fg32">+	msg := ethereum.CallMsg{</span>
<span class="term-fg32">+		From:  testAddr,</span>
<span class="term-fg32">+		To:    &amp;common.Address{},</span>
<span class="term-fg32">+		Gas:   21000,</span>
<span class="term-fg32">+		Value: big.NewInt(1),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var res hexutil.Uint64</span>
<span class="term-fg32">+	err := client.CallContext(context.Background(), &amp;res, &quot;eth_estimateGas&quot;, toCallArg(msg), rpc.BlockNumberOrHashWithNumber(1))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if res != 12345 {</span>
<span class="term-fg32">+		t.Fatalf(&quot;invalid result: %d&quot;, res)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Call Contract RPC</span>
<span class="term-fg32">+	histVal, err := ec.CallContract(context.Background(), msg, big.NewInt(1))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if string(histVal) != &quot;test&quot; {</span>
<span class="term-fg32">+		t.Fatalf(&quot;expected %s to equal test&quot;, string(histVal))</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-913613083da479d219ecf2a2" role="button"
                   aria-expanded="false" aria-controls="id-913613083da479d219ecf2a2">
                    <code>eth/tracers/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/tracers/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/tracers/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+196</span></div>
                        <div class="text-start"><span class="text-danger">-10</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-913613083da479d219ecf2a2"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;api_test.go op-geth&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg1">index b1eaf60b16c44e158f335248749b5b067fa23c44..a2d00f3edc2352fcc256af6437e8b2857e0704a6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg36">@@ -24,12 +24,15 @@</span> 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg32">+	&quot;net&quot;</span>
<span class="term-fg32">+	&quot;net&#47;http&quot;</span>
 	&quot;reflect&quot;
 	&quot;sort&quot;
 	&quot;sync&#47;atomic&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;davecgh&#47;go-spew&#47;spew&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
<span class="term-fg36">@@ -43,15 +46,78 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&#47;logger&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;ethapi&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;node&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;mock&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg31">-	errStateNotFound = errors.New(&quot;state not found&quot;)</span>
<span class="term-fg31">-	errBlockNotFound = errors.New(&quot;block not found&quot;)</span>
<span class="term-fg32">+	errStateNotFound       = errors.New(&quot;state not found&quot;)</span>
<span class="term-fg32">+	errBlockNotFound       = errors.New(&quot;block not found&quot;)</span>
<span class="term-fg32">+	errTransactionNotFound = errors.New(&quot;transaction not found&quot;)</span>
 )
&nbsp;
<span class="term-fg32">+type mockHistoricalBackend struct {</span>
<span class="term-fg32">+	mock.Mock</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; mockHistoricalBackend does not have a TraceCall, because pre-bedrock there is no debug_traceCall available</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) TraceBlockByNumber(ctx context.Context, number rpc.BlockNumber, config *TraceConfig) ([]*txTraceResult, error) {</span>
<span class="term-fg32">+	ret := m.Mock.MethodCalled(&quot;TraceBlockByNumber&quot;, number, config)</span>
<span class="term-fg32">+	return ret[0].([]*txTraceResult), *ret[1].(*error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) ExpectTraceBlockByNumber(number rpc.BlockNumber, config *TraceConfig, out []*txTraceResult, err error) {</span>
<span class="term-fg32">+	m.Mock.On(&quot;TraceBlockByNumber&quot;, number, config).Once().Return(out, &amp;err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) TraceTransaction(ctx context.Context, hash common.Hash, config *TraceConfig) (interface{}, error) {</span>
<span class="term-fg32">+	ret := m.Mock.MethodCalled(&quot;TraceTransaction&quot;, hash, config)</span>
<span class="term-fg32">+	return ret[0], *ret[1].(*error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) ExpectTraceTransaction(hash common.Hash, config *TraceConfig, out interface{}, err error) {</span>
<span class="term-fg32">+	jsonOut, _ := json.Marshal(out)</span>
<span class="term-fg32">+	m.Mock.On(&quot;TraceTransaction&quot;, hash, config).Once().Return(json.RawMessage(jsonOut), &amp;err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newMockHistoricalBackend(t *testing.T, backend *mockHistoricalBackend) string {</span>
<span class="term-fg32">+	s := rpc.NewServer()</span>
<span class="term-fg32">+	err := node.RegisterApis([]rpc.API{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			Namespace:     &quot;debug&quot;,</span>
<span class="term-fg32">+			Service:       backend,</span>
<span class="term-fg32">+			Public:        true,</span>
<span class="term-fg32">+			Authenticated: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}, nil, s)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	hdlr := node.NewHTTPHandlerStack(s, []string{&quot;*&quot;}, []string{&quot;*&quot;}, nil)</span>
<span class="term-fg32">+	mux := http.NewServeMux()</span>
<span class="term-fg32">+	mux.Handle(&quot;&#47;&quot;, hdlr)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	listener, err := net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend listener: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	go func() {</span>
<span class="term-fg32">+		httpS := &amp;http.Server{Handler: mux}</span>
<span class="term-fg32">+		httpS.Serve(listener)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Cleanup(func() {</span>
<span class="term-fg32">+			httpS.Shutdown(context.Background())</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;http:&#47;&#47;%s&quot;, listener.Addr().String())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 type testBackend struct {
 	chainConfig *params.ChainConfig
 	engine      consensus.Engine
<span class="term-fg36">@@ -60,15 +126,28 @@</span> 	chain       *core.BlockChain
&nbsp;
 	refHook func() &#47;&#47; Hook is invoked when the requested state is referenced
 	relHook func() &#47;&#47; Hook is invoked when the requested state is released
<span class="term-fg32">+</span>
<span class="term-fg32">+	historical     *rpc.Client</span>
<span class="term-fg32">+	mockHistorical *mockHistoricalBackend</span>
 }
&nbsp;
 &#47;&#47; testBackend creates a new test backend. OBS: After test is done, teardown must be
 &#47;&#47; invoked in order to release associated resources.
 func newTestBackend(t *testing.T, n int, gspec *core.Genesis, generator func(i int, b *core.BlockGen)) *testBackend {
<span class="term-fg32">+	mock := new(mockHistoricalBackend)</span>
<span class="term-fg32">+	historicalAddr := newMockHistoricalBackend(t, mock)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	historicalClient, err := rpc.Dial(historicalAddr)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error making historical client: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	backend := &amp;testBackend{
<span class="term-fg31">-		chainConfig: gspec.Config,</span>
<span class="term-fg31">-		engine:      ethash.NewFaker(),</span>
<span class="term-fg31">-		chaindb:     rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		chainConfig:    gspec.Config,</span>
<span class="term-fg32">+		engine:         ethash.NewFaker(),</span>
<span class="term-fg32">+		chaindb:        rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		historical:     historicalClient,</span>
<span class="term-fg32">+		mockHistorical: mock,</span>
 	}
 	&#47;&#47; Generate blocks for testing
 	_, blocks, _ := core.GenerateChainWithGenesis(gspec, backend.engine, n, generator)
<span class="term-fg36">@@ -116,6 +195,9 @@</span> }
&nbsp;
 func (b *testBackend) GetTransaction(ctx context.Context, txHash common.Hash) (*types.Transaction, common.Hash, uint64, uint64, error) {
 	tx, hash, blockNumber, index := rawdb.ReadTransaction(b.chaindb, txHash)
<span class="term-fg32">+	if tx == nil {</span>
<span class="term-fg32">+		return nil, common.Hash{}, 0, 0, errTransactionNotFound</span>
<span class="term-fg32">+	}</span>
 	return tx, hash, blockNumber, index, nil
 }
&nbsp;
<span class="term-fg36">@@ -173,7 +255,7 @@</span> 	signer := types.MakeSigner(b.chainConfig, block.Number())
 	for idx, tx := range block.Transactions() {
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), b.chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), b.chain, nil, b.chainConfig, statedb)</span>
 		if idx == txIndex {
 			return msg, context, statedb, release, nil
 		}
<span class="term-fg36">@@ -184,6 +266,10 @@</span> 		}
 		statedb.Finalise(vmenv.ChainConfig().IsEIP158(block.Number()))
 	}
 	return nil, vm.BlockContext{}, nil, nil, fmt.Errorf(&quot;transaction index %d out of range for block %#x&quot;, txIndex, block.Hash())
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *testBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.historical</span>
 }
&nbsp;
 func TestTraceCall(t *testing.T) {
<span class="term-fg36">@@ -361,11 +447,58 @@</span> 		StructLogs:  []logger.StructLogRes{},
 	}) {
 		t.Error(&quot;Transaction tracing result is different&quot;)
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+func TestTraceTransactionHistorical(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
&nbsp;
<span class="term-fg31">-	&#47;&#47; Test non-existent transaction</span>
<span class="term-fg31">-	_, err = api.TraceTransaction(context.Background(), common.Hash{42}, nil)</span>
<span class="term-fg31">-	if !errors.Is(err, errTxNotFound) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;want %v, have %v&quot;, errTxNotFound, err)</span>
<span class="term-fg32">+	&#47;&#47; Initialize test accounts</span>
<span class="term-fg32">+	accounts := newAccounts(2)</span>
<span class="term-fg32">+	genesis := &amp;core.Genesis{</span>
<span class="term-fg32">+		Config: params.OptimismTestConfig,</span>
<span class="term-fg32">+		Alloc: core.GenesisAlloc{</span>
<span class="term-fg32">+			accounts[0].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[1].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	target := common.Hash{}</span>
<span class="term-fg32">+	signer := types.HomesteadSigner{}</span>
<span class="term-fg32">+	backend := newTestBackend(t, 1, genesis, func(i int, b *core.BlockGen) {</span>
<span class="term-fg32">+		&#47;&#47; Transfer from account[0] to account[1]</span>
<span class="term-fg32">+		&#47;&#47;    value: 1000 wei</span>
<span class="term-fg32">+		&#47;&#47;    fee:   0 wei</span>
<span class="term-fg32">+		tx, _ := types.SignTx(types.NewTransaction(uint64(i), accounts[1].addr, big.NewInt(1000), params.TxGas, b.BaseFee(), nil), signer, accounts[0].key)</span>
<span class="term-fg32">+		b.AddTx(tx)</span>
<span class="term-fg32">+		target = tx.Hash()</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer backend.mockHistorical.AssertExpectations(t)</span>
<span class="term-fg32">+	defer backend.chain.Stop()</span>
<span class="term-fg32">+	backend.mockHistorical.ExpectTraceTransaction(</span>
<span class="term-fg32">+		target,</span>
<span class="term-fg32">+		nil,</span>
<span class="term-fg32">+		logger.ExecutionResult{</span>
<span class="term-fg32">+			Gas:         params.TxGas,</span>
<span class="term-fg32">+			Failed:      false,</span>
<span class="term-fg32">+			ReturnValue: &quot;&quot;,</span>
<span class="term-fg32">+			StructLogs:  []logger.StructLogRes{},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		nil)</span>
<span class="term-fg32">+	api := NewAPI(backend)</span>
<span class="term-fg32">+	result, err := api.TraceTransaction(context.Background(), target, nil)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;Failed to trace transaction %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var have *logger.ExecutionResult</span>
<span class="term-fg32">+	spew.Dump(result)</span>
<span class="term-fg32">+	if err := json.Unmarshal(result.(json.RawMessage), &amp;have); err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;failed to unmarshal result %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if !reflect.DeepEqual(have, &amp;logger.ExecutionResult{</span>
<span class="term-fg32">+		Gas:         params.TxGas,</span>
<span class="term-fg32">+		Failed:      false,</span>
<span class="term-fg32">+		ReturnValue: &quot;&quot;,</span>
<span class="term-fg32">+		StructLogs:  []logger.StructLogRes{},</span>
<span class="term-fg32">+	}) {</span>
<span class="term-fg32">+		t.Error(&quot;Transaction tracing result is different&quot;)</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -447,6 +580,59 @@</span> 		want := tc.want
 		if string(have) != want {
 			t.Errorf(&quot;test %d, result mismatch, have\n%v\n, want\n%v\n&quot;, i, string(have), want)
 		}
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTraceBlockHistorical(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Initialize test accounts</span>
<span class="term-fg32">+	accounts := newAccounts(3)</span>
<span class="term-fg32">+	genesis := &amp;core.Genesis{</span>
<span class="term-fg32">+		Config: params.OptimismTestConfig,</span>
<span class="term-fg32">+		Alloc: core.GenesisAlloc{</span>
<span class="term-fg32">+			accounts[0].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[1].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[2].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	genBlocks := 10</span>
<span class="term-fg32">+	signer := types.HomesteadSigner{}</span>
<span class="term-fg32">+	backend := newTestBackend(t, genBlocks, genesis, func(i int, b *core.BlockGen) {</span>
<span class="term-fg32">+		&#47;&#47; Transfer from account[0] to account[1]</span>
<span class="term-fg32">+		&#47;&#47;    value: 1000 wei</span>
<span class="term-fg32">+		&#47;&#47;    fee:   0 wei</span>
<span class="term-fg32">+		tx, _ := types.SignTx(types.NewTransaction(uint64(i), accounts[1].addr, big.NewInt(1000), params.TxGas, b.BaseFee(), nil), signer, accounts[0].key)</span>
<span class="term-fg32">+		b.AddTx(tx)</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer backend.mockHistorical.AssertExpectations(t)</span>
<span class="term-fg32">+	defer backend.chain.Stop()</span>
<span class="term-fg32">+	api := NewAPI(backend)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var expectErr error</span>
<span class="term-fg32">+	var config *TraceConfig</span>
<span class="term-fg32">+	blockNumber := rpc.BlockNumber(3)</span>
<span class="term-fg32">+	want := `[{&quot;result&quot;:{&quot;failed&quot;:false,&quot;gas&quot;:21000,&quot;returnValue&quot;:&quot;&quot;,&quot;structLogs&quot;:[]}}]`</span>
<span class="term-fg32">+	var ret []*txTraceResult</span>
<span class="term-fg32">+	_ = json.Unmarshal([]byte(want), &amp;ret)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	backend.mockHistorical.ExpectTraceBlockByNumber(blockNumber, config, ret, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := api.TraceBlockByNumber(context.Background(), blockNumber, config)</span>
<span class="term-fg32">+	if expectErr != nil {</span>
<span class="term-fg32">+		if err == nil {</span>
<span class="term-fg32">+			t.Errorf(&quot;want error %v&quot;, expectErr)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !reflect.DeepEqual(err, expectErr) {</span>
<span class="term-fg32">+			t.Errorf(&quot;error mismatch, want %v, get %v&quot;, expectErr, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;want no error, have %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	have, _ := json.Marshal(result)</span>
<span class="term-fg32">+	if string(have) != want {</span>
<span class="term-fg32">+		t.Errorf(&quot;result mismatch, have\n%v\n, want\n%v\n&quot;, string(have), want)</span>
 	}
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-e88b26bafeefe425a71e3f1b"role="button" aria-expanded="false" aria-controls="id-e88b26bafeefe425a71e3f1b">
        
            <div class="col-12 col-sm-9 text-start"><h2>Geth extras</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+288</span></div>
                <div class="text-start"><span class="text-danger">-20</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-e88b26bafeefe425a71e3f1b">
        <div><p>Extend the tools available in geth to improve external testing and tooling.</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4bf0233becf9baa37340a713"role="button" aria-expanded="false" aria-controls="id-4bf0233becf9baa37340a713">
        
            <div class="col-12 col-sm-9 text-start"><h3>Simulated Backend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+90</span></div>
                <div class="text-start"><span class="text-danger">-19</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4bf0233becf9baa37340a713">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-96b5630fa4c28d79c7cde5be" role="button"
                   aria-expanded="false" aria-controls="id-96b5630fa4c28d79c7cde5be">
                    <code>accounts/abi/bind/backends/simulated.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/accounts/abi/bind/backends/simulated.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/accounts/abi/bind/backends/simulated.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+90</span></div>
                        <div class="text-start"><span class="text-danger">-19</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-96b5630fa4c28d79c7cde5be"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go op-geth&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg1">index 3d5259b894dff183006f0afb1f7161b8a9c1f7b6..b2892e3cb1932e234aa0919f7703ada91eaf349c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg36">@@ -30,6 +30,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;abi&#47;bind&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;ethash&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;bloombits&quot;
<span class="term-fg36">@@ -63,6 +64,8 @@</span> type SimulatedBackend struct {
 	database   ethdb.Database   &#47;&#47; In memory database to store our testing data
 	blockchain *core.BlockChain &#47;&#47; Ethereum blockchain to handle the consensus
&nbsp;
<span class="term-fg32">+	consensus consensus.Engine</span>
<span class="term-fg32">+</span>
 	mu              sync.Mutex
 	pendingBlock    *types.Block   &#47;&#47; Currently pending block that will be imported on request
 	pendingState    *state.StateDB &#47;&#47; Currently pending state that will be the active on request
<span class="term-fg36">@@ -78,20 +81,93 @@</span> &#47;&#47; NewSimulatedBackendWithDatabase creates a new binding backend based on the given database
 &#47;&#47; and uses a simulated blockchain for testing purposes.
 &#47;&#47; A simulated backend always uses chainID 1337.
 func NewSimulatedBackendWithDatabase(database ethdb.Database, alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {
<span class="term-fg31">-	genesis := core.Genesis{</span>
<span class="term-fg31">-		Config:   params.AllEthashProtocolChanges,</span>
<span class="term-fg31">-		GasLimit: gasLimit,</span>
<span class="term-fg31">-		Alloc:    alloc,</span>
<span class="term-fg32">+	return NewSimulatedBackendWithOpts(WithDatabase(database), WithAlloc(alloc), WithGasLimit(gasLimit))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewSimulatedBackend creates a new binding backend using a simulated blockchain</span>
<span class="term-fg32">+&#47;&#47; for testing purposes.</span>
<span class="term-fg32">+&#47;&#47; A simulated backend always uses chainID 1337.</span>
<span class="term-fg32">+func NewSimulatedBackend(alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {</span>
<span class="term-fg32">+	return NewSimulatedBackendWithOpts(WithGasLimit(gasLimit), WithAlloc(alloc))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type simulatedBackendConfig struct {</span>
<span class="term-fg32">+	genesis     core.Genesis</span>
<span class="term-fg32">+	cacheConfig *core.CacheConfig</span>
<span class="term-fg32">+	database    ethdb.Database</span>
<span class="term-fg32">+	vmConfig    vm.Config</span>
<span class="term-fg32">+	consensus   consensus.Engine</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type SimulatedBackendOpt func(s *simulatedBackendConfig)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithDatabase(database ethdb.Database) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.database = database</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithGasLimit(gasLimit uint64) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis.GasLimit = gasLimit</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithAlloc(alloc core.GenesisAlloc) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis.Alloc = alloc</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithCacheConfig(cacheConfig *core.CacheConfig) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.cacheConfig = cacheConfig</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithGenesis(genesis core.Genesis) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis = genesis</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithVMConfig(vmConfig vm.Config) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.vmConfig = vmConfig</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithConsensus(consensus consensus.Engine) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.consensus = consensus</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewSimulatedBackendWithOpts creates a new binding backend based on the given database</span>
<span class="term-fg32">+&#47;&#47; and uses a simulated blockchain for testing purposes. It exposes additional configuration</span>
<span class="term-fg32">+&#47;&#47; options that are useful to</span>
<span class="term-fg32">+func NewSimulatedBackendWithOpts(opts ...SimulatedBackendOpt) *SimulatedBackend {</span>
<span class="term-fg32">+	config := &amp;simulatedBackendConfig{</span>
<span class="term-fg32">+		genesis:   core.Genesis{Config: params.AllEthashProtocolChanges, GasLimit: 100000000, Alloc: make(core.GenesisAlloc)},</span>
<span class="term-fg32">+		database:  rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		consensus: ethash.NewFaker(),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for _, opt := range opts {</span>
<span class="term-fg32">+		opt(config)</span>
 	}
<span class="term-fg31">-	blockchain, _ := core.NewBlockChain(database, nil, &amp;genesis, nil, ethash.NewFaker(), vm.Config{}, nil, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	config.genesis.MustCommit(config.database)</span>
<span class="term-fg32">+	blockchain, _ := core.NewBlockChain(config.database, config.cacheConfig, &amp;config.genesis, nil, config.consensus, config.vmConfig, nil, nil)</span>
&nbsp;
 	backend := &amp;SimulatedBackend{
<span class="term-fg31">-		database:   database,</span>
<span class="term-fg32">+		database:   config.database,</span>
 		blockchain: blockchain,
<span class="term-fg31">-		config:     genesis.Config,</span>
<span class="term-fg32">+		config:     config.genesis.Config,</span>
<span class="term-fg32">+		consensus:  config.consensus,</span>
 	}
&nbsp;
<span class="term-fg31">-	filterBackend := &amp;filterBackend{database, blockchain, backend}</span>
<span class="term-fg32">+	filterBackend := &amp;filterBackend{config.database, blockchain, backend}</span>
 	backend.filterSystem = filters.NewFilterSystem(filterBackend, filters.Config{})
 	backend.events = filters.NewEventSystem(backend.filterSystem, false)
&nbsp;
<span class="term-fg36">@@ -102,13 +178,6 @@</span> 	backend.rollback(block)
 	return backend
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NewSimulatedBackend creates a new binding backend using a simulated blockchain</span>
<span class="term-fg31">-&#47;&#47; for testing purposes.</span>
<span class="term-fg31">-&#47;&#47; A simulated backend always uses chainID 1337.</span>
<span class="term-fg31">-func NewSimulatedBackend(alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {</span>
<span class="term-fg31">-	return NewSimulatedBackendWithDatabase(rawdb.NewMemoryDatabase(), alloc, gasLimit)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; Close terminates the underlying blockchain&#39;s update loop.
 func (b *SimulatedBackend) Close() error {
 	b.blockchain.Stop()
<span class="term-fg36">@@ -124,6 +193,8 @@</span>
 	if _, err := b.blockchain.InsertChain([]*types.Block{b.pendingBlock}); err != nil {
 		panic(err) &#47;&#47; This cannot happen unless the simulator is wrong, fail in that case
 	}
<span class="term-fg32">+	&#47;&#47; Don&#39;t wait for the async tx indexing</span>
<span class="term-fg32">+	rawdb.WriteTxLookupEntriesByBlock(b.database, b.pendingBlock)</span>
 	blockHash := b.pendingBlock.Hash()
&nbsp;
 	&#47;&#47; Using the last inserted block here makes it possible to build on a side
<span class="term-fg36">@@ -145,7 +216,7 @@</span> 	b.rollback(block)
 }
&nbsp;
 func (b *SimulatedBackend) rollback(parent *types.Block) {
<span class="term-fg31">-	blocks, _ := core.GenerateChain(b.config, parent, ethash.NewFaker(), b.database, 1, func(int, *core.BlockGen) {})</span>
<span class="term-fg32">+	blocks, _ := core.GenerateChain(b.config, parent, b.consensus, b.database, 1, func(int, *core.BlockGen) {})</span>
&nbsp;
 	b.pendingBlock = blocks[0]
 	b.pendingState, _ = state.New(b.pendingBlock.Root(), b.blockchain.StateCache(), nil)
<span class="term-fg36">@@ -666,7 +737,7 @@</span>
 	&#47;&#47; Create a new environment which holds all relevant information
 	&#47;&#47; about the transaction and calling mechanisms.
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	evmContext := core.NewEVMBlockContext(header, b.blockchain, nil)</span>
<span class="term-fg32">+	evmContext := core.NewEVMBlockContext(header, b.blockchain, nil, b.config, stateDB)</span>
 	vmEnv := vm.NewEVM(evmContext, txContext, stateDB, b.config, vm.Config{NoBaseFee: true})
 	gasPool := new(core.GasPool).AddGas(math.MaxUint64)
&nbsp;
<span class="term-fg36">@@ -694,7 +765,7 @@</span> 	if tx.Nonce() != nonce {
 		return fmt.Errorf(&quot;invalid transaction nonce: got %d, want %d&quot;, tx.Nonce(), nonce)
 	}
 	&#47;&#47; Include tx in chain
<span class="term-fg31">-	blocks, receipts := core.GenerateChain(b.config, block, ethash.NewFaker(), b.database, 1, func(number int, block *core.BlockGen) {</span>
<span class="term-fg32">+	blocks, receipts := core.GenerateChain(b.config, block, b.consensus, b.database, 1, func(number int, block *core.BlockGen) {</span>
 		for _, tx := range b.pendingBlock.Transactions() {
 			block.AddTxWithChain(b.blockchain, tx)
 		}
<span class="term-fg36">@@ -818,7 +889,7 @@</span> 	if block == nil {
 		return fmt.Errorf(&quot;could not find parent&quot;)
 	}
&nbsp;
<span class="term-fg31">-	blocks, _ := core.GenerateChain(b.config, block, ethash.NewFaker(), b.database, 1, func(number int, block *core.BlockGen) {</span>
<span class="term-fg32">+	blocks, _ := core.GenerateChain(b.config, block, b.consensus, b.database, 1, func(number int, block *core.BlockGen) {</span>
 		block.OffsetTime(int64(adjustment.Seconds()))
 	})
 	stateDB, _ := b.blockchain.State()</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-e79957bc6029938f393775f7"role="button" aria-expanded="false" aria-controls="id-e79957bc6029938f393775f7">
        
            <div class="col-12 col-sm-9 text-start"><h3>diff-included testing testing</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+198</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-e79957bc6029938f393775f7">
        <div><p>Most of the op-geth changes are tested in the Optimism Monorepo and not part of the geth diff,
but some testing like the Deposit TX encoding and API interactions are embedded in the op-geth diff instead.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3501884a8e0a039bd643fd78" role="button"
                   aria-expanded="false" aria-controls="id-3501884a8e0a039bd643fd78">
                    <code>core/types/transaction_marshalling_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/transaction_marshalling_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+80</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3501884a8e0a039bd643fd78"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_marshalling_test.go op-geth&#47;core&#47;types&#47;transaction_marshalling_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..497dd8b0207c35db1c7d1bff22a9404966050222</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_marshalling_test.go</span>
<span class="term-fg36">@@ -0,0 +1,80 @@</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;encoding&#47;json&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTransactionUnmarshalJsonDeposit(t *testing.T) {</span>
<span class="term-fg32">+	tx := NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	json, err := tx.MarshalJSON()</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;Failed to marshal tx JSON&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	got := &amp;Transaction{}</span>
<span class="term-fg32">+	err = got.UnmarshalJSON(json)</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;Failed to unmarshal tx JSON&quot;)</span>
<span class="term-fg32">+	require.Equal(t, tx.Hash(), got.Hash())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTransactionUnmarshalJSON(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name          string</span>
<span class="term-fg32">+		json          string</span>
<span class="term-fg32">+		expectedError string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No gas&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;gas&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No value&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;value&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No input&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;input&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No from&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;from&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No sourceHash&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;sourceHash&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;No mint&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			&#47;&#47; Allowed</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;No IsSystemTx&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			&#47;&#47; Allowed</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			var parsedTx = &amp;Transaction{}</span>
<span class="term-fg32">+			err := json.Unmarshal([]byte(test.json), &amp;parsedTx)</span>
<span class="term-fg32">+			if test.expectedError == &quot;&quot; {</span>
<span class="term-fg32">+				require.NoError(t, err)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				require.ErrorContains(t, err, test.expectedError)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2cdc4e61d9207b4972212d85" role="button"
                   aria-expanded="false" aria-controls="id-2cdc4e61d9207b4972212d85">
                    <code>internal/ethapi/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/internal/ethapi/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/internal/ethapi/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+118</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2cdc4e61d9207b4972212d85"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;api_test.go op-geth&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg1">index 762dc8337d30706d2472b9516b1f516392c3998c..f950ce4011d05372c6907c945d775f4236c1cc85 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg36">@@ -22,11 +22,128 @@</span> 	&quot;math&#47;big&quot;
 	&quot;testing&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 )
&nbsp;
<span class="term-fg32">+func TestNewRPCTransactionDepositTx(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	nonce := uint64(7)</span>
<span class="term-fg32">+	receipt := &amp;types.Receipt{</span>
<span class="term-fg32">+		DepositNonce: &amp;nonce,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, receipt)</span>
<span class="term-fg32">+	&#47;&#47; Should provide zero values for unused fields that are required in other transactions</span>
<span class="term-fg32">+	require.Equal(t, got.GasPrice, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().GasPrice = %v, want 0x0&quot;, got.GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, got.V, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().V = %v, want 0x0&quot;, got.V)</span>
<span class="term-fg32">+	require.Equal(t, got.R, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().R = %v, want 0x0&quot;, got.R)</span>
<span class="term-fg32">+	require.Equal(t, got.S, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().S = %v, want 0x0&quot;, got.S)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Should include deposit tx specific fields</span>
<span class="term-fg32">+	require.Equal(t, *got.SourceHash, tx.SourceHash(), &quot;newRPCTransaction().SourceHash = %v, want %v&quot;, got.SourceHash, tx.SourceHash())</span>
<span class="term-fg32">+	require.Equal(t, *got.IsSystemTx, tx.IsSystemTx(), &quot;newRPCTransaction().IsSystemTx = %v, want %v&quot;, got.IsSystemTx, tx.IsSystemTx())</span>
<span class="term-fg32">+	require.Equal(t, got.Mint, (*hexutil.Big)(tx.Mint()), &quot;newRPCTransaction().Mint = %v, want %v&quot;, got.Mint, tx.Mint())</span>
<span class="term-fg32">+	require.Equal(t, got.Nonce, (hexutil.Uint64)(nonce), &quot;newRPCTransaction().Mint = %v, want %v&quot;, got.Nonce, nonce)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestNewRPCTransactionOmitIsSystemTxFalse(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		IsSystemTransaction: false,</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Nil(t, got.IsSystemTx, &quot;should omit IsSystemTx when false&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestUnmarshalRpcDepositTx(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name     string</span>
<span class="term-fg32">+		modifier func(tx *RPCTransaction)</span>
<span class="term-fg32">+		valid    bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:     &quot;Unmodified&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {},</span>
<span class="term-fg32">+			valid:    true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Zero Values&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.R = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.S = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.GasPrice = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Nil Values&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = nil</span>
<span class="term-fg32">+				tx.R = nil</span>
<span class="term-fg32">+				tx.S = nil</span>
<span class="term-fg32">+				tx.GasPrice = nil</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero GasPrice&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.GasPrice = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero V&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero R&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.R = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero S&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.S = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+				SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+				IsSystemTransaction: true,</span>
<span class="term-fg32">+				Mint:                big.NewInt(34),</span>
<span class="term-fg32">+			})</span>
<span class="term-fg32">+			rpcTx := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, nil)</span>
<span class="term-fg32">+			test.modifier(rpcTx)</span>
<span class="term-fg32">+			json, err := json.Marshal(rpcTx)</span>
<span class="term-fg32">+			require.NoError(t, err, &quot;marshalling failed: %w&quot;, err)</span>
<span class="term-fg32">+			parsed := &amp;types.Transaction{}</span>
<span class="term-fg32">+			err = parsed.UnmarshalJSON(json)</span>
<span class="term-fg32">+			if test.valid {</span>
<span class="term-fg32">+				require.NoError(t, err, &quot;unmarshal failed: %w&quot;, err)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				require.Error(t, err, &quot;unmarshal should have failed but did not&quot;)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func TestTransaction_RoundTripRpcJSON(t *testing.T) {
 	var (
 		config = params.AllEthashProtocolChanges
<span class="term-fg36">@@ -51,7 +168,7 @@</span> 			t.Fatalf(&quot;test %d: stx changed, want %x have %x&quot;, i, want, have)
 		}
&nbsp;
 		&#47;&#47;  rpcTransaction
<span class="term-fg31">-		rpcTx := newRPCTransaction(tx, common.Hash{}, 0, 0, nil, config)</span>
<span class="term-fg32">+		rpcTx := newRPCTransaction(tx, common.Hash{}, 0, 0, nil, config, nil)</span>
 		if data, err := json.Marshal(rpcTx); err != nil {
 			t.Fatalf(&quot;test %d: marshalling failed; %v&quot;, i, err)
 		} else if err = tx2.UnmarshalJSON(data); err != nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-ab4e57ed8c616283a4456837"role="button" aria-expanded="false" aria-controls="id-ab4e57ed8c616283a4456837">
        
            <div class="col-12 col-sm-9 text-start"><h2>Other changes</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1479</span></div>
                <div class="text-start"><span class="text-danger">-900</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-ab4e57ed8c616283a4456837">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e0a1824f97fd0499c60d1011" role="button"
                   aria-expanded="false" aria-controls="id-e0a1824f97fd0499c60d1011">
                    <code>.github/CONTRIBUTING.md</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/.github/CONTRIBUTING.md" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/.github/CONTRIBUTING.md" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e0a1824f97fd0499c60d1011"><span class="term-fg1">diff --git go-ethereum&#47;.github&#47;CONTRIBUTING.md op-geth&#47;.github&#47;CONTRIBUTING.md</span>
<span class="term-fg1">index a08542df25553564ea96570479ce2b754770d34a..969b7f8f9fa1ef4cd87f80bb9df2e80d6cbbc2e8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;.github&#47;CONTRIBUTING.md</span>
<span class="term-fg1">+++ op-geth&#47;.github&#47;CONTRIBUTING.md</span>
<span class="term-fg36">@@ -35,6 +35,6 @@</span> and help.
&nbsp;
 ## Configuration, dependencies, and tests
&nbsp;
<span class="term-fg31">-Please see the [Developers&#39; Guide](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;developers&#47;devguide)</span>
<span class="term-fg32">+Please see the [Developers&#39; Guide](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;developers&#47;geth-developer&#47;dev-guide)</span>
 for more details on configuring your environment, managing project dependencies
 and testing procedures.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d7a15988866682da9177458c" role="button"
                   aria-expanded="false" aria-controls="id-d7a15988866682da9177458c">
                    <code>.travis.yml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/.travis.yml" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/.travis.yml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d7a15988866682da9177458c"><span class="term-fg1">diff --git go-ethereum&#47;.travis.yml op-geth&#47;.travis.yml</span>
<span class="term-fg1">index db21bd5d96aeb7f1e36fe1efc5f676eca1f9db69..925e23b1a57f7555d882f4a8fbf2cb8c7d59ef0b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;.travis.yml</span>
<span class="term-fg1">+++ op-geth&#47;.travis.yml</span>
<span class="term-fg36">@@ -140,7 +140,7 @@</span>         - go run build&#47;ci.go test $TEST_PACKAGES
&nbsp;
     # This builder does the Ubuntu PPA nightly uploads
     - stage: build
<span class="term-fg31">-      if: type = cron</span>
<span class="term-fg32">+      if: type = cron || (type = push &amp;&amp; tag ~= &#47;^v[0-9]&#47;)</span>
       os: linux
       dist: bionic
       go: 1.20.x</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7dd8d6ebbb6661e222589f91" role="button"
                   aria-expanded="false" aria-controls="id-7dd8d6ebbb6661e222589f91">
                    <code>README.md</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/README.md" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/README.md" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7dd8d6ebbb6661e222589f91"><span class="term-fg1">diff --git go-ethereum&#47;README.md op-geth&#47;README.md</span>
<span class="term-fg1">index 325f796a3e3b67c5c0fded26ff62a6cebe564136..34bd8b94c98d5e5ede03bb5395b6ed83b02157ac 100644</span>
<span class="term-fg1">--- go-ethereum&#47;README.md</span>
<span class="term-fg1">+++ op-geth&#47;README.md</span>
<span class="term-fg36">@@ -36,10 +36,10 @@</span> directory.
&nbsp;
 |  Command   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
 | :--------: | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
<span class="term-fg31">-| **`geth`** | Our main Ethereum CLI client. It is the entry point into the Ethereum network (main-, test- or private net), capable of running as a full node (default), archive node (retaining all historical state) or a light node (retrieving data live). It can be used by other processes as a gateway into the Ethereum network via JSON RPC endpoints exposed on top of HTTP, WebSocket and&#47;or IPC transports. `geth --help` and the [CLI page](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interface&#47;command-line-options) for command line options. |</span>
<span class="term-fg32">+| **`geth`** | Our main Ethereum CLI client. It is the entry point into the Ethereum network (main-, test- or private net), capable of running as a full node (default), archive node (retaining all historical state) or a light node (retrieving data live). It can be used by other processes as a gateway into the Ethereum network via JSON RPC endpoints exposed on top of HTTP, WebSocket and&#47;or IPC transports. `geth --help` and the [CLI page](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;fundamentals&#47;command-line-options) for command line options. |</span>
 |   `clef`   | Stand-alone signing tool, which can be used as a backend signer for `geth`.                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
 |  `devp2p`  | Utilities to interact with nodes on the networking layer, without running a full blockchain.                                                                                                                                                                                                                                                                                                                                                                                                                                       |
<span class="term-fg31">-|  `abigen`  | Source code generator to convert Ethereum contract definitions into easy-to-use, compile-time type-safe Go packages. It operates on plain [Ethereum contract ABIs](https:&#47;&#47;docs.soliditylang.org&#47;en&#47;develop&#47;abi-spec.html) with expanded functionality if the contract bytecode is also available. However, it also accepts Solidity source files, making development much more streamlined. Please see our [Native DApps](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;dapp&#47;native-bindings) page for details.                                  |</span>
<span class="term-fg32">+|  `abigen`  | Source code generator to convert Ethereum contract definitions into easy-to-use, compile-time type-safe Go packages. It operates on plain [Ethereum contract ABIs](https:&#47;&#47;docs.soliditylang.org&#47;en&#47;develop&#47;abi-spec.html) with expanded functionality if the contract bytecode is also available. However, it also accepts Solidity source files, making development much more streamlined. Please see our [Native DApps](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;developers&#47;dapp-developer&#47;native-bindings) page for details.                                  |</span>
 | `bootnode` | Stripped down version of our Ethereum client implementation that only takes part in the network node discovery protocol, but does not run any of the higher level application protocols. It can be used as a lightweight bootstrap node to aid in finding peers in private networks.                                                                                                                                                                                                                                               |
 |   `evm`    | Developer utility version of the EVM (Ethereum Virtual Machine) that is capable of running bytecode snippets within a configurable environment and execution mode. Its purpose is to allow isolated, fine-grained debugging of EVM opcodes (e.g. `evm --code 60ff60ff --debug run`).                                                                                                                                                                                                                                               |
 | `rlpdump`  | Developer utility tool to convert binary RLP ([Recursive Length Prefix](https:&#47;&#47;ethereum.org&#47;en&#47;developers&#47;docs&#47;data-structures-and-encoding&#47;rlp)) dumps (data encoding used by the Ethereum protocol both network as well as consensus wise) to user-friendlier hierarchical representation (e.g. `rlpdump --hex CE0183FFFFFFC4C304050583616263`).                                                                                                                                                                                |
<span class="term-fg36">@@ -47,7 +47,7 @@</span>
 ## Running `geth`
&nbsp;
 Going through all the possible command line flags is out of scope here (please consult our
<span class="term-fg31">-[CLI Wiki page](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interface&#47;command-line-options)),</span>
<span class="term-fg32">+[CLI Wiki page](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;fundamentals&#47;command-line-options)),</span>
 but we&#39;ve enumerated a few common parameter combos to get you up to speed quickly
 on how you can run your own `geth` instance.
&nbsp;
<span class="term-fg36">@@ -82,10 +82,10 @@</span> This command will:
  * Start `geth` in snap sync mode (default, can be changed with the `--syncmode` flag),
    causing it to download more data in exchange for avoiding processing the entire history
    of the Ethereum network, which is very CPU intensive.
<span class="term-fg31">- * Start the built-in interactive [JavaScript console](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interface&#47;javascript-console),</span>
<span class="term-fg32">+ * Start the built-in interactive [JavaScript console](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interacting-with-geth&#47;javascript-console),</span>
    (via the trailing `console` subcommand) through which you can interact using [`web3` methods](https:&#47;&#47;github.com&#47;ChainSafe&#47;web3.js&#47;blob&#47;0.20.7&#47;DOCUMENTATION.md)
    (note: the `web3` version bundled within `geth` is very old, and not up to date with official docs),
<span class="term-fg31">-   as well as `geth`&#39;s own [management APIs](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;rpc&#47;server).</span>
<span class="term-fg32">+   as well as `geth`&#39;s own [management APIs](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interacting-with-geth&#47;rpc).</span>
    This tool is optional and if you leave it out you can always attach it to an already running
    `geth` instance with `geth attach`.
&nbsp;
<span class="term-fg36">@@ -175,7 +175,7 @@</span>
 As a developer, sooner rather than later you&#39;ll want to start interacting with `geth` and the
 Ethereum network via your own programs and not manually through the console. To aid
 this, `geth` has built-in support for a JSON-RPC based APIs ([standard APIs](https:&#47;&#47;ethereum.github.io&#47;execution-apis&#47;api-documentation&#47;)
<span class="term-fg31">-and [`geth` specific APIs](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;rpc&#47;server)).</span>
<span class="term-fg32">+and [`geth` specific APIs](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interacting-with-geth&#47;rpc)).</span>
 These can be exposed via HTTP, WebSockets and IPC (UNIX sockets on UNIX based
 platforms, and named pipes on Windows).
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8671d5be09fc8e9e7abd8a14" role="button"
                   aria-expanded="false" aria-controls="id-8671d5be09fc8e9e7abd8a14">
                    <code>accounts/abi/abi.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/accounts/abi/abi.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/accounts/abi/abi.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8671d5be09fc8e9e7abd8a14"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;abi&#47;abi.go op-geth&#47;accounts&#47;abi&#47;abi.go</span>
<span class="term-fg1">index 841d3c6cb676714e23ee4bd80ffc681be7fb2c76..62b860e18c777291d75a0e5d2604b5f39e6dc6af 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;abi&#47;abi.go</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;abi&#47;abi.go</span>
<span class="term-fg36">@@ -246,7 +246,10 @@</span> 	}
 	if !bytes.Equal(data[:4], revertSelector) {
 		return &quot;&quot;, errors.New(&quot;invalid data for unpacking&quot;)
 	}
<span class="term-fg31">-	typ, _ := NewType(&quot;string&quot;, &quot;&quot;, nil)</span>
<span class="term-fg32">+	typ, err := NewType(&quot;string&quot;, &quot;&quot;, nil)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return &quot;&quot;, err</span>
<span class="term-fg32">+	}</span>
 	unpacked, err := (Arguments{{Type: typ}}).Unpack(data[4:])
 	if err != nil {
 		return &quot;&quot;, err</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a4d252c7c0524957e2745ee8" role="button"
                   aria-expanded="false" aria-controls="id-a4d252c7c0524957e2745ee8">
                    <code>cmd/checkpoint-admin/README.md</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/cmd/checkpoint-admin/README.md" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/cmd/checkpoint-admin/README.md" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a4d252c7c0524957e2745ee8"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;checkpoint-admin&#47;README.md op-geth&#47;cmd&#47;checkpoint-admin&#47;README.md</span>
<span class="term-fg1">index 7c0c657eb5cb2dbc817f091f0cce026fcd151608..1067ead0564f8b34b03faeda8ab7d7d66f4305fd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;checkpoint-admin&#47;README.md</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;checkpoint-admin&#47;README.md</span>
<span class="term-fg36">@@ -46,7 +46,7 @@</span> ```shell
 checkpoint-admin deploy --rpc &lt;NODE_RPC_ENDPOINT&gt; --clef &lt;CLEF_ENDPOINT&gt; --signer &lt;SIGNER_TO_SIGN_TX&gt; --signers &lt;TRUSTED_SIGNER_LIST&gt; --threshold 1
 ```
&nbsp;
<span class="term-fg31">-It is worth noting that checkpoint-admin only supports clef as a signer for transactions and plain text(checkpoint). For more clef usage, please see the clef [tutorial](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;clef&#47;tutorial) .</span>
<span class="term-fg32">+It is worth noting that checkpoint-admin only supports clef as a signer for transactions and plain text(checkpoint). For more clef usage, please see the clef [tutorial](https:&#47;&#47;geth.ethereum.org&#47;docs&#47;tools&#47;clef&#47;tutorial) .</span>
&nbsp;
 #### Sign
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-42dcab3404c4e654e3ff04c2" role="button"
                   aria-expanded="false" aria-controls="id-42dcab3404c4e654e3ff04c2">
                    <code>cmd/devp2p/main.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/cmd/devp2p/main.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/cmd/devp2p/main.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+0</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-42dcab3404c4e654e3ff04c2"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;main.go op-geth&#47;cmd&#47;devp2p&#47;main.go</span>
<span class="term-fg1">index 9e13d29ab72d62529fcdc98069989955d55f9fce..8461a8b9b5e257c8cecbad8e99ee7801e38312b7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;main.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;main.go</span>
<span class="term-fg36">@@ -29,7 +29,6 @@</span>
 var app = flags.NewApp(&quot;go-ethereum devp2p tool&quot;)
&nbsp;
 func init() {
<span class="term-fg31">-	app.HideVersion = true</span>
 	app.Flags = append(app.Flags, debug.Flags...)
 	app.Before = func(ctx *cli.Context) error {
 		flags.MigrateGlobalFlags(ctx)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-47a5eb0eec2453e65c056f52" role="button"
                   aria-expanded="false" aria-controls="id-47a5eb0eec2453e65c056f52">
                    <code>cmd/geth/consolecmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/cmd/geth/consolecmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/cmd/geth/consolecmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-47a5eb0eec2453e65c056f52"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;consolecmd.go op-geth&#47;cmd&#47;geth&#47;consolecmd.go</span>
<span class="term-fg1">index 23f6fd277c611a3a7ea02b6902dc395bb5fb49b6..aeee6f9c9e404707e69d161f19e2e6a5fc2920f0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;consolecmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;consolecmd.go</span>
<span class="term-fg36">@@ -37,7 +37,7 @@</span> 		Flags:  flags.Merge(nodeFlags, rpcFlags, consoleFlags),
 		Description: `
 The Geth console is an interactive shell for the JavaScript runtime environment
 which exposes a node admin interface as well as the app JavaScript API.
<span class="term-fg31">-See https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interface&#47;javascript-console.`,</span>
<span class="term-fg32">+See https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interacting-with-geth&#47;javascript-console.`,</span>
 	}
&nbsp;
 	attachCommand = &amp;cli.Command{
<span class="term-fg36">@@ -49,7 +49,7 @@</span> 		Flags:     flags.Merge([]cli.Flag{utils.DataDirFlag, utils.HttpHeaderFlag}, consoleFlags),
 		Description: `
 The Geth console is an interactive shell for the JavaScript runtime environment
 which exposes a node admin interface as well as the app JavaScript API.
<span class="term-fg31">-See https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interface&#47;javascript-console.</span>
<span class="term-fg32">+See https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interacting-with-geth&#47;javascript-console.</span>
 This command allows to open a console on a running geth node.`,
 	}
&nbsp;
<span class="term-fg36">@@ -61,7 +61,7 @@</span> 		ArgsUsage: &quot;&lt;jsfile&gt; [jsfile...]&quot;,
 		Flags:     flags.Merge(nodeFlags, consoleFlags),
 		Description: `
 The JavaScript VM exposes a node admin interface as well as the app
<span class="term-fg31">-JavaScript API. See https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interface&#47;javascript-console`,</span>
<span class="term-fg32">+JavaScript API. See https:&#47;&#47;geth.ethereum.org&#47;docs&#47;interacting-with-geth&#47;javascript-console`,</span>
 	}
 )
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-568bde6a0cb2e49222ff17f6" role="button"
                   aria-expanded="false" aria-controls="id-568bde6a0cb2e49222ff17f6">
                    <code>consensus/clique/clique.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/consensus/clique/clique.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/consensus/clique/clique.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+7</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-568bde6a0cb2e49222ff17f6"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;clique&#47;clique.go op-geth&#47;consensus&#47;clique&#47;clique.go</span>
<span class="term-fg1">index 4706bbac1ca9e2250bd75dca560d09541e3805f7..6c20803b2a117b2fbc0e2cb46cb36e5aa4590346 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;clique&#47;clique.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;clique&#47;clique.go</span>
<span class="term-fg36">@@ -565,12 +565,10 @@</span> 	}
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Finalize implements consensus.Engine, ensuring no uncles are set, nor block</span>
<span class="term-fg31">-&#47;&#47; rewards given.</span>
<span class="term-fg32">+&#47;&#47; Finalize implements consensus.Engine. There is no post-transaction</span>
<span class="term-fg32">+&#47;&#47; consensus rules in clique, do nothing here.</span>
 func (c *Clique) Finalize(chain consensus.ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, withdrawals []*types.Withdrawal) {
<span class="term-fg31">-	&#47;&#47; No block rewards in PoA, so the state remains as is and uncles are dropped</span>
<span class="term-fg31">-	header.Root = state.IntermediateRoot(chain.Config().IsEIP158(header.Number))</span>
<span class="term-fg31">-	header.UncleHash = types.CalcUncleHash(nil)</span>
<span class="term-fg32">+	&#47;&#47; No block rewards in PoA, so the state remains as is</span>
 }
&nbsp;
 &#47;&#47; FinalizeAndAssemble implements consensus.Engine, ensuring no uncles are set,
<span class="term-fg36">@@ -579,11 +577,13 @@</span> func (c *Clique) FinalizeAndAssemble(chain consensus.ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, receipts []*types.Receipt, withdrawals []*types.Withdrawal) (*types.Block, error) {
 	if len(withdrawals) &gt; 0 {
 		return nil, errors.New(&quot;clique does not support withdrawals&quot;)
 	}
<span class="term-fg31">-</span>
 	&#47;&#47; Finalize block
 	c.Finalize(chain, header, state, txs, uncles, nil)
&nbsp;
<span class="term-fg31">-	&#47;&#47; Assemble and return the final block for sealing</span>
<span class="term-fg32">+	&#47;&#47; Assign the final state root to header.</span>
<span class="term-fg32">+	header.Root = state.IntermediateRoot(chain.Config().IsEIP158(header.Number))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Assemble and return the final block for sealing.</span>
 	return types.NewBlock(header, txs, nil, receipts, trie.NewStackTrie(nil)), nil
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8931038d6216ee70427aa282" role="button"
                   aria-expanded="false" aria-controls="id-8931038d6216ee70427aa282">
                    <code>consensus/consensus.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/consensus/consensus.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/consensus/consensus.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8931038d6216ee70427aa282"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;consensus.go op-geth&#47;consensus&#47;consensus.go</span>
<span class="term-fg1">index 190d5ae12c8ad61bc61e47f0b36c24509efb9cf3..a9fd8dd1cf9f85abaaf4bba87ecd88928bf328ea 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;consensus.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;consensus.go</span>
<span class="term-fg36">@@ -84,16 +84,16 @@</span> 	&#47;&#47; Prepare initializes the consensus fields of a block header according to the
 	&#47;&#47; rules of a particular engine. The changes are executed inline.
 	Prepare(chain ChainHeaderReader, header *types.Header) error
&nbsp;
<span class="term-fg31">-	&#47;&#47; Finalize runs any post-transaction state modifications (e.g. block rewards)</span>
<span class="term-fg31">-	&#47;&#47; but does not assemble the block.</span>
<span class="term-fg32">+	&#47;&#47; Finalize runs any post-transaction state modifications (e.g. block rewards</span>
<span class="term-fg32">+	&#47;&#47; or process withdrawals) but does not assemble the block.</span>
 	&#47;&#47;
<span class="term-fg31">-	&#47;&#47; Note: The block header and state database might be updated to reflect any</span>
<span class="term-fg31">-	&#47;&#47; consensus rules that happen at finalization (e.g. block rewards).</span>
<span class="term-fg32">+	&#47;&#47; Note: The state database might be updated to reflect any consensus rules</span>
<span class="term-fg32">+	&#47;&#47; that happen at finalization (e.g. block rewards).</span>
 	Finalize(chain ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction,
 		uncles []*types.Header, withdrawals []*types.Withdrawal)
&nbsp;
 	&#47;&#47; FinalizeAndAssemble runs any post-transaction state modifications (e.g. block
<span class="term-fg31">-	&#47;&#47; rewards) and assembles the final block.</span>
<span class="term-fg32">+	&#47;&#47; rewards or process withdrawals) and assembles the final block.</span>
 	&#47;&#47;
 	&#47;&#47; Note: The block header and state database might be updated to reflect any
 	&#47;&#47; consensus rules that happen at finalization (e.g. block rewards).</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c741d8640850de138ec3595b" role="button"
                   aria-expanded="false" aria-controls="id-c741d8640850de138ec3595b">
                    <code>consensus/ethash/consensus.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/consensus/ethash/consensus.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/consensus/ethash/consensus.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c741d8640850de138ec3595b"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;ethash&#47;consensus.go op-geth&#47;consensus&#47;ethash&#47;consensus.go</span>
<span class="term-fg1">index da29e16597b6d7a85fa04baf48e456c15ce388cb..c3c06c541cab5cbe02d36ebb57e6e0885b2bbc74 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;ethash&#47;consensus.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;ethash&#47;consensus.go</span>
<span class="term-fg36">@@ -598,12 +598,10 @@</span> 	header.Difficulty = ethash.CalcDifficulty(chain, header.Time, parent)
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Finalize implements consensus.Engine, accumulating the block and uncle rewards,</span>
<span class="term-fg31">-&#47;&#47; setting the final state on the header</span>
<span class="term-fg32">+&#47;&#47; Finalize implements consensus.Engine, accumulating the block and uncle rewards.</span>
 func (ethash *Ethash) Finalize(chain consensus.ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, withdrawals []*types.Withdrawal) {
<span class="term-fg31">-	&#47;&#47; Accumulate any block and uncle rewards and commit the final state root</span>
<span class="term-fg32">+	&#47;&#47; Accumulate any block and uncle rewards</span>
 	accumulateRewards(chain.Config(), state, header, uncles)
<span class="term-fg31">-	header.Root = state.IntermediateRoot(chain.Config().IsEIP158(header.Number))</span>
 }
&nbsp;
 &#47;&#47; FinalizeAndAssemble implements consensus.Engine, accumulating the block and
<span class="term-fg36">@@ -612,9 +610,12 @@</span> func (ethash *Ethash) FinalizeAndAssemble(chain consensus.ChainHeaderReader, header *types.Header, state *state.StateDB, txs []*types.Transaction, uncles []*types.Header, receipts []*types.Receipt, withdrawals []*types.Withdrawal) (*types.Block, error) {
 	if len(withdrawals) &gt; 0 {
 		return nil, errors.New(&quot;ethash does not support withdrawals&quot;)
 	}
<span class="term-fg31">-</span>
 	&#47;&#47; Finalize block
 	ethash.Finalize(chain, header, state, txs, uncles, nil)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Assign the final state root to header.</span>
<span class="term-fg32">+	header.Root = state.IntermediateRoot(chain.Config().IsEIP158(header.Number))</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Header seems complete, assemble into a block and return
 	return types.NewBlock(header, txs, uncles, receipts, trie.NewStackTrie(nil)), nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-baa14ec024ee5d6f7a138622" role="button"
                   aria-expanded="false" aria-controls="id-baa14ec024ee5d6f7a138622">
                    <code>core/block_validator.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/block_validator.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/block_validator.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-baa14ec024ee5d6f7a138622"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;block_validator.go op-geth&#47;core&#47;block_validator.go</span>
<span class="term-fg1">index db7ea35687237819eb02e663ff24cefb978b917e..bcb228830d4ea77a5d76cbce303c7631874699fc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;block_validator.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;block_validator.go</span>
<span class="term-fg36">@@ -90,10 +90,8 @@</span> 	}
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; ValidateState validates the various changes that happen after a state</span>
<span class="term-fg31">-&#47;&#47; transition, such as amount of used gas, the receipt roots and the state root</span>
<span class="term-fg31">-&#47;&#47; itself. ValidateState returns a database batch if the validation was a success</span>
<span class="term-fg31">-&#47;&#47; otherwise nil and an error is returned.</span>
<span class="term-fg32">+&#47;&#47; ValidateState validates the various changes that happen after a state transition,</span>
<span class="term-fg32">+&#47;&#47; such as amount of used gas, the receipt roots and the state root itself.</span>
 func (v *BlockValidator) ValidateState(block *types.Block, statedb *state.StateDB, receipts types.Receipts, usedGas uint64) error {
 	header := block.Header()
 	if block.GasUsed() != usedGas {
<span class="term-fg36">@@ -113,7 +111,7 @@</span> 	}
 	&#47;&#47; Validate the state root against the received state root and throw
 	&#47;&#47; an error if they don&#39;t match.
 	if root := statedb.IntermediateRoot(v.config.IsEIP158(header.Number)); header.Root != root {
<span class="term-fg31">-		return fmt.Errorf(&quot;invalid merkle root (remote: %x local: %x)&quot;, header.Root, root)</span>
<span class="term-fg32">+		return fmt.Errorf(&quot;invalid merkle root (remote: %x local: %x) dberr: %w&quot;, header.Root, root, statedb.Error())</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-884ddf14575a256950186999" role="button"
                   aria-expanded="false" aria-controls="id-884ddf14575a256950186999">
                    <code>core/blockchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/blockchain.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/blockchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+34</span></div>
                        <div class="text-start"><span class="text-danger">-29</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-884ddf14575a256950186999"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;blockchain.go op-geth&#47;core&#47;blockchain.go</span>
<span class="term-fg1">index f22562ccfa94f31f97d3bacbfe4cfcbd496f7207..1709f9cbaed785d044ac917d84dcaefc281cb376 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;blockchain.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;blockchain.go</span>
<span class="term-fg36">@@ -255,6 +255,10 @@</span> 	}
 	log.Info(strings.Repeat(&quot;-&quot;, 153))
 	log.Info(&quot;&quot;)
&nbsp;
<span class="term-fg32">+	if chainConfig.IsOptimism() &amp;&amp; chainConfig.RegolithTime == nil {</span>
<span class="term-fg32">+		log.Warn(&quot;Optimism RegolithTime has not been set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	bc := &amp;BlockChain{
 		chainConfig:   chainConfig,
 		cacheConfig:   cacheConfig,
<span class="term-fg36">@@ -1740,56 +1744,57 @@</span> 		if !bc.cacheConfig.TrieCleanNoPrefetch {
 			if followup, err := it.peek(); followup != nil &amp;&amp; err == nil {
 				throwaway, _ := state.New(parent.Root, bc.stateCache, bc.snaps)
&nbsp;
<span class="term-fg31">-				go func(start time.Time, followup *types.Block, throwaway *state.StateDB, interrupt *uint32) {</span>
<span class="term-fg32">+				go func(start time.Time, followup *types.Block, throwaway *state.StateDB) {</span>
 					bc.prefetcher.Prefetch(followup, throwaway, bc.vmConfig, &amp;followupInterrupt)
&nbsp;
 					blockPrefetchExecuteTimer.Update(time.Since(start))
<span class="term-fg31">-					if atomic.LoadUint32(interrupt) == 1 {</span>
<span class="term-fg32">+					if atomic.LoadUint32(&amp;followupInterrupt) == 1 {</span>
 						blockPrefetchInterruptMeter.Mark(1)
 					}
<span class="term-fg31">-				}(time.Now(), followup, throwaway, &amp;followupInterrupt)</span>
<span class="term-fg32">+				}(time.Now(), followup, throwaway)</span>
 			}
 		}
&nbsp;
 		&#47;&#47; Process block using the parent state as reference point
<span class="term-fg31">-		substart := time.Now()</span>
<span class="term-fg32">+		pstart := time.Now()</span>
 		receipts, logs, usedGas, err := bc.processor.Process(block, statedb, bc.vmConfig)
 		if err != nil {
 			bc.reportBlock(block, receipts, err)
 			atomic.StoreUint32(&amp;followupInterrupt, 1)
 			return it.index, err
 		}
<span class="term-fg32">+		ptime := time.Since(pstart)</span>
&nbsp;
<span class="term-fg31">-		&#47;&#47; Update the metrics touched during block processing</span>
<span class="term-fg31">-		accountReadTimer.Update(statedb.AccountReads)                 &#47;&#47; Account reads are complete, we can mark them</span>
<span class="term-fg31">-		storageReadTimer.Update(statedb.StorageReads)                 &#47;&#47; Storage reads are complete, we can mark them</span>
<span class="term-fg31">-		accountUpdateTimer.Update(statedb.AccountUpdates)             &#47;&#47; Account updates are complete, we can mark them</span>
<span class="term-fg31">-		storageUpdateTimer.Update(statedb.StorageUpdates)             &#47;&#47; Storage updates are complete, we can mark them</span>
<span class="term-fg31">-		snapshotAccountReadTimer.Update(statedb.SnapshotAccountReads) &#47;&#47; Account reads are complete, we can mark them</span>
<span class="term-fg31">-		snapshotStorageReadTimer.Update(statedb.SnapshotStorageReads) &#47;&#47; Storage reads are complete, we can mark them</span>
<span class="term-fg31">-		triehash := statedb.AccountHashes + statedb.StorageHashes     &#47;&#47; Save to not double count in validation</span>
<span class="term-fg31">-		trieproc := statedb.SnapshotAccountReads + statedb.AccountReads + statedb.AccountUpdates</span>
<span class="term-fg31">-		trieproc += statedb.SnapshotStorageReads + statedb.StorageReads + statedb.StorageUpdates</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-		blockExecutionTimer.Update(time.Since(substart) - trieproc - triehash)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-		&#47;&#47; Validate the state using the default validator</span>
<span class="term-fg31">-		substart = time.Now()</span>
<span class="term-fg32">+		vstart := time.Now()</span>
 		if err := bc.validator.ValidateState(block, statedb, receipts, usedGas); err != nil {
 			bc.reportBlock(block, receipts, err)
 			atomic.StoreUint32(&amp;followupInterrupt, 1)
 			return it.index, err
 		}
<span class="term-fg31">-		proctime := time.Since(start)</span>
<span class="term-fg32">+		vtime := time.Since(vstart)</span>
<span class="term-fg32">+		proctime := time.Since(start) &#47;&#47; processing + validation</span>
&nbsp;
<span class="term-fg31">-		&#47;&#47; Update the metrics touched during block validation</span>
<span class="term-fg31">-		accountHashTimer.Update(statedb.AccountHashes) &#47;&#47; Account hashes are complete, we can mark them</span>
<span class="term-fg31">-		storageHashTimer.Update(statedb.StorageHashes) &#47;&#47; Storage hashes are complete, we can mark them</span>
<span class="term-fg31">-		blockValidationTimer.Update(time.Since(substart) - (statedb.AccountHashes + statedb.StorageHashes - triehash))</span>
<span class="term-fg32">+		&#47;&#47; Update the metrics touched during block processing and validation</span>
<span class="term-fg32">+		accountReadTimer.Update(statedb.AccountReads)                   &#47;&#47; Account reads are complete(in processing)</span>
<span class="term-fg32">+		storageReadTimer.Update(statedb.StorageReads)                   &#47;&#47; Storage reads are complete(in processing)</span>
<span class="term-fg32">+		snapshotAccountReadTimer.Update(statedb.SnapshotAccountReads)   &#47;&#47; Account reads are complete(in processing)</span>
<span class="term-fg32">+		snapshotStorageReadTimer.Update(statedb.SnapshotStorageReads)   &#47;&#47; Storage reads are complete(in processing)</span>
<span class="term-fg32">+		accountUpdateTimer.Update(statedb.AccountUpdates)               &#47;&#47; Account updates are complete(in validation)</span>
<span class="term-fg32">+		storageUpdateTimer.Update(statedb.StorageUpdates)               &#47;&#47; Storage updates are complete(in validation)</span>
<span class="term-fg32">+		accountHashTimer.Update(statedb.AccountHashes)                  &#47;&#47; Account hashes are complete(in validation)</span>
<span class="term-fg32">+		storageHashTimer.Update(statedb.StorageHashes)                  &#47;&#47; Storage hashes are complete(in validation)</span>
<span class="term-fg32">+		triehash := statedb.AccountHashes + statedb.StorageHashes       &#47;&#47; The time spent on tries hashing</span>
<span class="term-fg32">+		trieUpdate := statedb.AccountUpdates + statedb.StorageUpdates   &#47;&#47; The time spent on tries update</span>
<span class="term-fg32">+		trieRead := statedb.SnapshotAccountReads + statedb.AccountReads &#47;&#47; The time spent on account read</span>
<span class="term-fg32">+		trieRead += statedb.SnapshotStorageReads + statedb.StorageReads &#47;&#47; The time spent on storage read</span>
<span class="term-fg32">+		blockExecutionTimer.Update(ptime - trieRead)                    &#47;&#47; The time spent on EVM processing</span>
<span class="term-fg32">+		blockValidationTimer.Update(vtime - (triehash + trieUpdate))    &#47;&#47; The time spent on block validation</span>
&nbsp;
 		&#47;&#47; Write the block to the chain and get the status.
<span class="term-fg31">-		substart = time.Now()</span>
<span class="term-fg31">-		var status WriteStatus</span>
<span class="term-fg32">+		var (</span>
<span class="term-fg32">+			wstart = time.Now()</span>
<span class="term-fg32">+			status WriteStatus</span>
<span class="term-fg32">+		)</span>
 		if !setHead {
 			&#47;&#47; Don&#39;t set the head, only insert the block
 			err = bc.writeBlockWithState(block, receipts, statedb)
<span class="term-fg36">@@ -1804,9 +1809,9 @@</span> 		&#47;&#47; Update the metrics touched during block commit
 		accountCommitTimer.Update(statedb.AccountCommits)   &#47;&#47; Account commits are complete, we can mark them
 		storageCommitTimer.Update(statedb.StorageCommits)   &#47;&#47; Storage commits are complete, we can mark them
 		snapshotCommitTimer.Update(statedb.SnapshotCommits) &#47;&#47; Snapshot commits are complete, we can mark them
<span class="term-fg31">-		triedbCommitTimer.Update(statedb.TrieDBCommits)     &#47;&#47; Triedb commits are complete, we can mark them</span>
<span class="term-fg32">+		triedbCommitTimer.Update(statedb.TrieDBCommits)     &#47;&#47; Trie database commits are complete, we can mark them</span>
&nbsp;
<span class="term-fg31">-		blockWriteTimer.Update(time.Since(substart) - statedb.AccountCommits - statedb.StorageCommits - statedb.SnapshotCommits - statedb.TrieDBCommits)</span>
<span class="term-fg32">+		blockWriteTimer.Update(time.Since(wstart) - statedb.AccountCommits - statedb.StorageCommits - statedb.SnapshotCommits - statedb.TrieDBCommits)</span>
 		blockInsertTimer.UpdateSince(start)
&nbsp;
 		&#47;&#47; Report the import stats before returning the various results
<span class="term-fg36">@@ -2049,7 +2054,7 @@</span> &#47;&#47; collectLogs collects the logs that were generated or removed during
 &#47;&#47; the processing of a block. These logs are later announced as deleted or reborn.
 func (bc *BlockChain) collectLogs(b *types.Block, removed bool) []*types.Log {
 	receipts := rawdb.ReadRawReceipts(bc.db, b.Hash(), b.NumberU64())
<span class="term-fg31">-	receipts.DeriveFields(bc.chainConfig, b.Hash(), b.NumberU64(), b.BaseFee(), b.Transactions())</span>
<span class="term-fg32">+	receipts.DeriveFields(bc.chainConfig, b.Hash(), b.NumberU64(), b.Time(), b.BaseFee(), b.Transactions())</span>
&nbsp;
 	var logs []*types.Log
 	for _, receipt := range receipts {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5e509152ef1d0ceccc6c0847" role="button"
                   aria-expanded="false" aria-controls="id-5e509152ef1d0ceccc6c0847">
                    <code>core/error.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/error.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/error.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5e509152ef1d0ceccc6c0847"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;error.go op-geth&#47;core&#47;error.go</span>
<span class="term-fg1">index 872ba8d365d8c152641f2dcd32b39343a285bd4d..d99b85e2490725b35c5797c93060ac7009b909d8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;error.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;error.go</span>
<span class="term-fg36">@@ -100,4 +100,7 @@</span> 	ErrFeeCapTooLow = errors.New(&quot;max fee per gas less than block base fee&quot;)
&nbsp;
 	&#47;&#47; ErrSenderNoEOA is returned if the sender of a transaction is a contract.
 	ErrSenderNoEOA = errors.New(&quot;sender not an eoa&quot;)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; ErrSystemTxNotSupported is returned for any deposit tx with IsSystemTx=true after the Regolith fork</span>
<span class="term-fg32">+	ErrSystemTxNotSupported = errors.New(&quot;system tx not supported&quot;)</span>
 )</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bbb9d8c1faa463b50bf4011d" role="button"
                   aria-expanded="false" aria-controls="id-bbb9d8c1faa463b50bf4011d">
                    <code>core/evm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/evm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/evm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bbb9d8c1faa463b50bf4011d"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;evm.go op-geth&#47;core&#47;evm.go</span>
<span class="term-fg1">index bd4f2b0e55f1cf039549830eed93514272962171..527a81ad29d6d1b2faedb37579fce28d2ad24efd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;evm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;evm.go</span>
<span class="term-fg36">@@ -23,6 +23,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
 )
&nbsp;
 &#47;&#47; ChainContext supports retrieving headers and consensus parameters from the
<span class="term-fg36">@@ -36,7 +37,7 @@</span> 	GetHeader(common.Hash, uint64) *types.Header
 }
&nbsp;
 &#47;&#47; NewEVMBlockContext creates a new context for use in the EVM.
<span class="term-fg31">-func NewEVMBlockContext(header *types.Header, chain ChainContext, author *common.Address) vm.BlockContext {</span>
<span class="term-fg32">+func NewEVMBlockContext(header *types.Header, chain ChainContext, author *common.Address, config *params.ChainConfig, statedb types.StateGetter) vm.BlockContext {</span>
 	var (
 		beneficiary common.Address
 		baseFee     *big.Int
<span class="term-fg36">@@ -66,6 +67,7 @@</span> 		Difficulty:  new(big.Int).Set(header.Difficulty),
 		BaseFee:     baseFee,
 		GasLimit:    header.GasLimit,
 		Random:      random,
<span class="term-fg32">+		L1CostFunc:  types.NewL1CostFunc(config, statedb),</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-12d6ac0fca0aabdbd93da0a9" role="button"
                   aria-expanded="false" aria-controls="id-12d6ac0fca0aabdbd93da0a9">
                    <code>core/forkid/forkid_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/forkid/forkid_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/forkid/forkid_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+73</span></div>
                        <div class="text-start"><span class="text-danger">-112</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-12d6ac0fca0aabdbd93da0a9"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;forkid&#47;forkid_test.go op-geth&#47;core&#47;forkid&#47;forkid_test.go</span>
<span class="term-fg1">index 4dda280e71509e6c4df1dce0190417ae39c019bc..ab59a454d8c95b259abf12dacf6043f846a80240 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;forkid&#47;forkid_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;forkid&#47;forkid_test.go</span>
<span class="term-fg36">@@ -26,15 +26,9 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 )
&nbsp;
<span class="term-fg31">-func u64(val uint64) *uint64 { return &amp;val }</span>
<span class="term-fg31">-</span>
 &#47;&#47; TestCreation tests that different genesis and fork rule combinations result in
 &#47;&#47; the correct fork ID.
 func TestCreation(t *testing.T) {
<span class="term-fg31">-	&#47;&#47; Temporary non-existent scenario TODO(karalabe): delete when Shanghai is enabled</span>
<span class="term-fg31">-	timestampedConfig := *params.MainnetChainConfig</span>
<span class="term-fg31">-	timestampedConfig.ShanghaiTime = u64(1668000000)</span>
<span class="term-fg31">-</span>
 	type testcase struct {
 		head uint64
 		time uint64
<span class="term-fg36">@@ -50,32 +44,34 @@</span> 		{
 			params.MainnetChainConfig,
 			params.MainnetGenesisHash,
 			[]testcase{
<span class="term-fg31">-				{0, 0, ID{Hash: checksumToBytes(0xfc64ec04), Next: 1150000}},         &#47;&#47; Unsynced</span>
<span class="term-fg31">-				{1149999, 0, ID{Hash: checksumToBytes(0xfc64ec04), Next: 1150000}},   &#47;&#47; Last Frontier block</span>
<span class="term-fg31">-				{1150000, 0, ID{Hash: checksumToBytes(0x97c2c34c), Next: 1920000}},   &#47;&#47; First Homestead block</span>
<span class="term-fg31">-				{1919999, 0, ID{Hash: checksumToBytes(0x97c2c34c), Next: 1920000}},   &#47;&#47; Last Homestead block</span>
<span class="term-fg31">-				{1920000, 0, ID{Hash: checksumToBytes(0x91d1f948), Next: 2463000}},   &#47;&#47; First DAO block</span>
<span class="term-fg31">-				{2462999, 0, ID{Hash: checksumToBytes(0x91d1f948), Next: 2463000}},   &#47;&#47; Last DAO block</span>
<span class="term-fg31">-				{2463000, 0, ID{Hash: checksumToBytes(0x7a64da13), Next: 2675000}},   &#47;&#47; First Tangerine block</span>
<span class="term-fg31">-				{2674999, 0, ID{Hash: checksumToBytes(0x7a64da13), Next: 2675000}},   &#47;&#47; Last Tangerine block</span>
<span class="term-fg31">-				{2675000, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}},   &#47;&#47; First Spurious block</span>
<span class="term-fg31">-				{4369999, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}},   &#47;&#47; Last Spurious block</span>
<span class="term-fg31">-				{4370000, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}},   &#47;&#47; First Byzantium block</span>
<span class="term-fg31">-				{7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}},   &#47;&#47; Last Byzantium block</span>
<span class="term-fg31">-				{7280000, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 9069000}},   &#47;&#47; First and last Constantinople, first Petersburg block</span>
<span class="term-fg31">-				{9068999, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 9069000}},   &#47;&#47; Last Petersburg block</span>
<span class="term-fg31">-				{9069000, 0, ID{Hash: checksumToBytes(0x879d6e30), Next: 9200000}},   &#47;&#47; First Istanbul and first Muir Glacier block</span>
<span class="term-fg31">-				{9199999, 0, ID{Hash: checksumToBytes(0x879d6e30), Next: 9200000}},   &#47;&#47; Last Istanbul and first Muir Glacier block</span>
<span class="term-fg31">-				{9200000, 0, ID{Hash: checksumToBytes(0xe029e991), Next: 12244000}},  &#47;&#47; First Muir Glacier block</span>
<span class="term-fg31">-				{12243999, 0, ID{Hash: checksumToBytes(0xe029e991), Next: 12244000}}, &#47;&#47; Last Muir Glacier block</span>
<span class="term-fg31">-				{12244000, 0, ID{Hash: checksumToBytes(0x0eb440f6), Next: 12965000}}, &#47;&#47; First Berlin block</span>
<span class="term-fg31">-				{12964999, 0, ID{Hash: checksumToBytes(0x0eb440f6), Next: 12965000}}, &#47;&#47; Last Berlin block</span>
<span class="term-fg31">-				{12965000, 0, ID{Hash: checksumToBytes(0xb715077d), Next: 13773000}}, &#47;&#47; First London block</span>
<span class="term-fg31">-				{13772999, 0, ID{Hash: checksumToBytes(0xb715077d), Next: 13773000}}, &#47;&#47; Last London block</span>
<span class="term-fg31">-				{13773000, 0, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}}, &#47;&#47; First Arrow Glacier block</span>
<span class="term-fg31">-				{15049999, 0, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}}, &#47;&#47; Last Arrow Glacier block</span>
<span class="term-fg31">-				{15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}},        &#47;&#47; First Gray Glacier block</span>
<span class="term-fg31">-				{20000000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}},        &#47;&#47; Future Gray Glacier block</span>
<span class="term-fg32">+				{0, 0, ID{Hash: checksumToBytes(0xfc64ec04), Next: 1150000}},                    &#47;&#47; Unsynced</span>
<span class="term-fg32">+				{1149999, 0, ID{Hash: checksumToBytes(0xfc64ec04), Next: 1150000}},              &#47;&#47; Last Frontier block</span>
<span class="term-fg32">+				{1150000, 0, ID{Hash: checksumToBytes(0x97c2c34c), Next: 1920000}},              &#47;&#47; First Homestead block</span>
<span class="term-fg32">+				{1919999, 0, ID{Hash: checksumToBytes(0x97c2c34c), Next: 1920000}},              &#47;&#47; Last Homestead block</span>
<span class="term-fg32">+				{1920000, 0, ID{Hash: checksumToBytes(0x91d1f948), Next: 2463000}},              &#47;&#47; First DAO block</span>
<span class="term-fg32">+				{2462999, 0, ID{Hash: checksumToBytes(0x91d1f948), Next: 2463000}},              &#47;&#47; Last DAO block</span>
<span class="term-fg32">+				{2463000, 0, ID{Hash: checksumToBytes(0x7a64da13), Next: 2675000}},              &#47;&#47; First Tangerine block</span>
<span class="term-fg32">+				{2674999, 0, ID{Hash: checksumToBytes(0x7a64da13), Next: 2675000}},              &#47;&#47; Last Tangerine block</span>
<span class="term-fg32">+				{2675000, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}},              &#47;&#47; First Spurious block</span>
<span class="term-fg32">+				{4369999, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}},              &#47;&#47; Last Spurious block</span>
<span class="term-fg32">+				{4370000, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}},              &#47;&#47; First Byzantium block</span>
<span class="term-fg32">+				{7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}},              &#47;&#47; Last Byzantium block</span>
<span class="term-fg32">+				{7280000, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 9069000}},              &#47;&#47; First and last Constantinople, first Petersburg block</span>
<span class="term-fg32">+				{9068999, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 9069000}},              &#47;&#47; Last Petersburg block</span>
<span class="term-fg32">+				{9069000, 0, ID{Hash: checksumToBytes(0x879d6e30), Next: 9200000}},              &#47;&#47; First Istanbul and first Muir Glacier block</span>
<span class="term-fg32">+				{9199999, 0, ID{Hash: checksumToBytes(0x879d6e30), Next: 9200000}},              &#47;&#47; Last Istanbul and first Muir Glacier block</span>
<span class="term-fg32">+				{9200000, 0, ID{Hash: checksumToBytes(0xe029e991), Next: 12244000}},             &#47;&#47; First Muir Glacier block</span>
<span class="term-fg32">+				{12243999, 0, ID{Hash: checksumToBytes(0xe029e991), Next: 12244000}},            &#47;&#47; Last Muir Glacier block</span>
<span class="term-fg32">+				{12244000, 0, ID{Hash: checksumToBytes(0x0eb440f6), Next: 12965000}},            &#47;&#47; First Berlin block</span>
<span class="term-fg32">+				{12964999, 0, ID{Hash: checksumToBytes(0x0eb440f6), Next: 12965000}},            &#47;&#47; Last Berlin block</span>
<span class="term-fg32">+				{12965000, 0, ID{Hash: checksumToBytes(0xb715077d), Next: 13773000}},            &#47;&#47; First London block</span>
<span class="term-fg32">+				{13772999, 0, ID{Hash: checksumToBytes(0xb715077d), Next: 13773000}},            &#47;&#47; Last London block</span>
<span class="term-fg32">+				{13773000, 0, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}},            &#47;&#47; First Arrow Glacier block</span>
<span class="term-fg32">+				{15049999, 0, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}},            &#47;&#47; Last Arrow Glacier block</span>
<span class="term-fg32">+				{15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1681338455}},          &#47;&#47; First Gray Glacier block</span>
<span class="term-fg32">+				{20000000, 1681338454, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1681338455}}, &#47;&#47; Last Gray Glacier block</span>
<span class="term-fg32">+				{20000000, 1681338455, ID{Hash: checksumToBytes(0xdce96c2d), Next: 0}},          &#47;&#47; First Shanghai block</span>
<span class="term-fg32">+				{30000000, 2000000000, ID{Hash: checksumToBytes(0xdce96c2d), Next: 0}},          &#47;&#47; Future Shanghai block</span>
 			},
 		},
 		&#47;&#47; Rinkeby test cases
<span class="term-fg36">@@ -131,41 +127,6 @@</span> 				{1735372, 1677557087, ID{Hash: checksumToBytes(0xb96cbd13), Next: 1677557088}}, &#47;&#47; Last MergeNetsplit block
 				{1735372, 1677557088, ID{Hash: checksumToBytes(0xf7f9bc08), Next: 0}},          &#47;&#47; First Shanghai block
 			},
 		},
<span class="term-fg31">-		&#47;&#47; Temporary timestamped test cases</span>
<span class="term-fg31">-		{</span>
<span class="term-fg31">-			&amp;timestampedConfig,</span>
<span class="term-fg31">-			params.MainnetGenesisHash,</span>
<span class="term-fg31">-			[]testcase{</span>
<span class="term-fg31">-				{0, 0, ID{Hash: checksumToBytes(0xfc64ec04), Next: 1150000}},                    &#47;&#47; Unsynced</span>
<span class="term-fg31">-				{1149999, 0, ID{Hash: checksumToBytes(0xfc64ec04), Next: 1150000}},              &#47;&#47; Last Frontier block</span>
<span class="term-fg31">-				{1150000, 0, ID{Hash: checksumToBytes(0x97c2c34c), Next: 1920000}},              &#47;&#47; First Homestead block</span>
<span class="term-fg31">-				{1919999, 0, ID{Hash: checksumToBytes(0x97c2c34c), Next: 1920000}},              &#47;&#47; Last Homestead block</span>
<span class="term-fg31">-				{1920000, 0, ID{Hash: checksumToBytes(0x91d1f948), Next: 2463000}},              &#47;&#47; First DAO block</span>
<span class="term-fg31">-				{2462999, 0, ID{Hash: checksumToBytes(0x91d1f948), Next: 2463000}},              &#47;&#47; Last DAO block</span>
<span class="term-fg31">-				{2463000, 0, ID{Hash: checksumToBytes(0x7a64da13), Next: 2675000}},              &#47;&#47; First Tangerine block</span>
<span class="term-fg31">-				{2674999, 0, ID{Hash: checksumToBytes(0x7a64da13), Next: 2675000}},              &#47;&#47; Last Tangerine block</span>
<span class="term-fg31">-				{2675000, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}},              &#47;&#47; First Spurious block</span>
<span class="term-fg31">-				{4369999, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}},              &#47;&#47; Last Spurious block</span>
<span class="term-fg31">-				{4370000, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}},              &#47;&#47; First Byzantium block</span>
<span class="term-fg31">-				{7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}},              &#47;&#47; Last Byzantium block</span>
<span class="term-fg31">-				{7280000, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 9069000}},              &#47;&#47; First and last Constantinople, first Petersburg block</span>
<span class="term-fg31">-				{9068999, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 9069000}},              &#47;&#47; Last Petersburg block</span>
<span class="term-fg31">-				{9069000, 0, ID{Hash: checksumToBytes(0x879d6e30), Next: 9200000}},              &#47;&#47; First Istanbul and first Muir Glacier block</span>
<span class="term-fg31">-				{9199999, 0, ID{Hash: checksumToBytes(0x879d6e30), Next: 9200000}},              &#47;&#47; Last Istanbul and first Muir Glacier block</span>
<span class="term-fg31">-				{9200000, 0, ID{Hash: checksumToBytes(0xe029e991), Next: 12244000}},             &#47;&#47; First Muir Glacier block</span>
<span class="term-fg31">-				{12243999, 0, ID{Hash: checksumToBytes(0xe029e991), Next: 12244000}},            &#47;&#47; Last Muir Glacier block</span>
<span class="term-fg31">-				{12244000, 0, ID{Hash: checksumToBytes(0x0eb440f6), Next: 12965000}},            &#47;&#47; First Berlin block</span>
<span class="term-fg31">-				{12964999, 0, ID{Hash: checksumToBytes(0x0eb440f6), Next: 12965000}},            &#47;&#47; Last Berlin block</span>
<span class="term-fg31">-				{12965000, 0, ID{Hash: checksumToBytes(0xb715077d), Next: 13773000}},            &#47;&#47; First London block</span>
<span class="term-fg31">-				{13772999, 0, ID{Hash: checksumToBytes(0xb715077d), Next: 13773000}},            &#47;&#47; Last London block</span>
<span class="term-fg31">-				{13773000, 0, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}},            &#47;&#47; First Arrow Glacier block</span>
<span class="term-fg31">-				{15049999, 0, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}},            &#47;&#47; Last Arrow Glacier block</span>
<span class="term-fg31">-				{15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1668000000}},          &#47;&#47; First Gray Glacier block</span>
<span class="term-fg31">-				{19999999, 1667999999, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1668000000}}, &#47;&#47; Last Gray Glacier block</span>
<span class="term-fg31">-				{20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: 0}},          &#47;&#47; First Shanghai block</span>
<span class="term-fg31">-				{20000000, 2668000000, ID{Hash: checksumToBytes(0x71147644), Next: 0}},          &#47;&#47; Future Shanghai block</span>
<span class="term-fg31">-			},</span>
<span class="term-fg31">-		},</span>
 	}
 	for i, tt := range tests {
 		for j, ttt := range tt.cases {
<span class="term-fg36">@@ -179,9 +140,9 @@</span>
 &#47;&#47; TestValidation tests that a local peer correctly validates and accepts a remote
 &#47;&#47; fork ID.
 func TestValidation(t *testing.T) {
<span class="term-fg31">-	&#47;&#47; Temporary non-existent scenario TODO(karalabe): delete when Shanghai is enabled</span>
<span class="term-fg31">-	timestampedConfig := *params.MainnetChainConfig</span>
<span class="term-fg31">-	timestampedConfig.ShanghaiTime = u64(1668000000)</span>
<span class="term-fg32">+	&#47;&#47; Config that has not timestamp enabled</span>
<span class="term-fg32">+	legacyConfig := *params.MainnetChainConfig</span>
<span class="term-fg32">+	legacyConfig.ShanghaiTime = nil</span>
&nbsp;
 	tests := []struct {
 		config *params.ChainConfig
<span class="term-fg36">@@ -195,60 +156,60 @@</span> 		&#47;&#47; Block based tests
 		&#47;&#47;------------------
&nbsp;
 		&#47;&#47; Local is mainnet Gray Glacier, remote announces the same. No future fork is announced.
<span class="term-fg31">-		{params.MainnetChainConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Gray Glacier, remote announces the same. Remote also announces a next fork
 		&#47;&#47; at block 0xffffffff, but that is uncertain.
<span class="term-fg31">-		{params.MainnetChainConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: math.MaxUint64}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: math.MaxUint64}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet currently in Byzantium only (so it&#39;s aware of Petersburg), remote announces
 		&#47;&#47; also Byzantium, but it&#39;s not yet aware of Petersburg (e.g. non updated node before the fork).
 		&#47;&#47; In this case we don&#39;t know if Petersburg passed yet or not.
<span class="term-fg31">-		{params.MainnetChainConfig, 7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet currently in Byzantium only (so it&#39;s aware of Petersburg), remote announces
 		&#47;&#47; also Byzantium, and it&#39;s also aware of Petersburg (e.g. updated node before the fork). We
 		&#47;&#47; don&#39;t know if Petersburg passed yet (will pass) or not.
<span class="term-fg31">-		{params.MainnetChainConfig, 7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet currently in Byzantium only (so it&#39;s aware of Petersburg), remote announces
 		&#47;&#47; also Byzantium, and it&#39;s also aware of some random fork (e.g. misconfigured Petersburg). As
 		&#47;&#47; neither forks passed at neither nodes, they may mismatch, but we still connect for now.
<span class="term-fg31">-		{params.MainnetChainConfig, 7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: math.MaxUint64}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: math.MaxUint64}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet exactly on Petersburg, remote announces Byzantium + knowledge about Petersburg. Remote
 		&#47;&#47; is simply out of sync, accept.
<span class="term-fg31">-		{params.MainnetChainConfig, 7280000, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7280000, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Petersburg, remote announces Byzantium + knowledge about Petersburg. Remote
 		&#47;&#47; is simply out of sync, accept.
<span class="term-fg31">-		{params.MainnetChainConfig, 7987396, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7987396, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Petersburg, remote announces Spurious + knowledge about Byzantium. Remote
 		&#47;&#47; is definitely out of sync. It may or may not need the Petersburg update, we don&#39;t know yet.
<span class="term-fg31">-		{params.MainnetChainConfig, 7987396, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7987396, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Byzantium, remote announces Petersburg. Local is out of sync, accept.
<span class="term-fg31">-		{params.MainnetChainConfig, 7279999, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 0}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7279999, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Spurious, remote announces Byzantium, but is not aware of Petersburg. Local
 		&#47;&#47; out of sync. Local also knows about a future fork, but that is uncertain yet.
<span class="term-fg31">-		{params.MainnetChainConfig, 4369999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, nil},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 4369999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Petersburg. remote announces Byzantium but is not aware of further forks.
 		&#47;&#47; Remote needs software update.
<span class="term-fg31">-		{params.MainnetChainConfig, 7987396, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, ErrRemoteStale},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7987396, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, ErrRemoteStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Petersburg, and isn&#39;t aware of more forks. Remote announces Petersburg +
 		&#47;&#47; 0xffffffff. Local needs software update, reject.
<span class="term-fg31">-		{params.MainnetChainConfig, 7987396, 0, ID{Hash: checksumToBytes(0x5cddc0e1), Next: 0}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7987396, 0, ID{Hash: checksumToBytes(0x5cddc0e1), Next: 0}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Byzantium, and is aware of Petersburg. Remote announces Petersburg +
 		&#47;&#47; 0xffffffff. Local needs software update, reject.
<span class="term-fg31">-		{params.MainnetChainConfig, 7279999, 0, ID{Hash: checksumToBytes(0x5cddc0e1), Next: 0}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7279999, 0, ID{Hash: checksumToBytes(0x5cddc0e1), Next: 0}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Petersburg, remote is Rinkeby Petersburg.
<span class="term-fg31">-		{params.MainnetChainConfig, 7987396, 0, ID{Hash: checksumToBytes(0xafec6b27), Next: 0}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7987396, 0, ID{Hash: checksumToBytes(0xafec6b27), Next: 0}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Gray Glacier, far in the future. Remote announces Gopherium (non existing fork)
 		&#47;&#47; at some future block 88888888, for itself, but past block for local. Local is incompatible.
<span class="term-fg36">@@ -256,13 +217,13 @@</span> 		&#47;&#47;
 		&#47;&#47; This case detects non-upgraded nodes with majority hash power (typical Ropsten mess).
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): This testcase will fail once mainnet gets timestamped forks, make legacy chain config
<span class="term-fg31">-		{params.MainnetChainConfig, 88888888, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 88888888}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 88888888, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 88888888}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Byzantium. Remote is also in Byzantium, but announces Gopherium (non existing
 		&#47;&#47; fork) at block 7279999, before Petersburg. Local is incompatible.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): This testcase will fail once mainnet gets timestamped forks, make legacy chain config
<span class="term-fg31">-		{params.MainnetChainConfig, 7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7279999}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{&amp;legacyConfig, 7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7279999}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47;------------------------------------
 		&#47;&#47; Block to timestamp transition tests
<span class="term-fg36">@@ -271,40 +232,40 @@</span>
 		&#47;&#47; Local is mainnet currently in Gray Glacier only (so it&#39;s aware of Shanghai), remote announces
 		&#47;&#47; also Gray Glacier, but it&#39;s not yet aware of Shanghai (e.g. non updated node before the fork).
 		&#47;&#47; In this case we don&#39;t know if Shanghai passed yet or not.
<span class="term-fg31">-		{&amp;timestampedConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet currently in Gray Glacier only (so it&#39;s aware of Shanghai), remote announces
 		&#47;&#47; also Gray Glacier, and it&#39;s also aware of Shanghai (e.g. updated node before the fork). We
 		&#47;&#47; don&#39;t know if Shanghai passed yet (will pass) or not.
<span class="term-fg31">-		{&amp;timestampedConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1668000000}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1681338455}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet currently in Gray Glacier only (so it&#39;s aware of Shanghai), remote announces
 		&#47;&#47; also Gray Glacier, and it&#39;s also aware of some random fork (e.g. misconfigured Shanghai). As
 		&#47;&#47; neither forks passed at neither nodes, they may mismatch, but we still connect for now.
<span class="term-fg31">-		{&amp;timestampedConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: math.MaxUint64}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: math.MaxUint64}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet exactly on Shanghai, remote announces Gray Glacier + knowledge about Shanghai. Remote
 		&#47;&#47; is simply out of sync, accept.
<span class="term-fg31">-		{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1668000000}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 20000000, 1681338455, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1681338455}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, remote announces Gray Glacier + knowledge about Shanghai. Remote
 		&#47;&#47; is simply out of sync, accept.
<span class="term-fg31">-		{&amp;timestampedConfig, 20123456, 1668123456, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1668000000}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 20123456, 1681338456, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1681338455}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, remote announces Arrow Glacier + knowledge about Gray Glacier. Remote
 		&#47;&#47; is definitely out of sync. It may or may not need the Shanghai update, we don&#39;t know yet.
<span class="term-fg31">-		{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 20000000, 1681338455, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Gray Glacier, remote announces Shanghai. Local is out of sync, accept.
<span class="term-fg31">-		{&amp;timestampedConfig, 15050000, 0, ID{Hash: checksumToBytes(0x71147644), Next: 0}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 15050000, 0, ID{Hash: checksumToBytes(0xdce96c2d), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Arrow Glacier, remote announces Gray Glacier, but is not aware of Shanghai. Local
 		&#47;&#47; out of sync. Local also knows about a future fork, but that is uncertain yet.
<span class="term-fg31">-		{&amp;timestampedConfig, 13773000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 13773000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai. remote announces Gray Glacier but is not aware of further forks.
 		&#47;&#47; Remote needs software update.
<span class="term-fg31">-		{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}, ErrRemoteStale},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 20000000, 1681338455, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 0}, ErrRemoteStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Gray Glacier, and isn&#39;t aware of more forks. Remote announces Gray Glacier +
 		&#47;&#47; 0xffffffff. Local needs software update, reject.
<span class="term-fg36">@@ -312,7 +273,7 @@</span> 		{params.MainnetChainConfig, 15050000, 0, ID{Hash: checksumToBytes(checksumUpdate(0xf0afd0e3, math.MaxUint64)), Next: 0}, ErrLocalIncompatibleOrStale},
&nbsp;
 		&#47;&#47; Local is mainnet Gray Glacier, and is aware of Shanghai. Remote announces Shanghai +
 		&#47;&#47; 0xffffffff. Local needs software update, reject.
<span class="term-fg31">-		{&amp;timestampedConfig, 15050000, 0, ID{Hash: checksumToBytes(checksumUpdate(0x71147644, math.MaxUint64)), Next: 0}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 15050000, 0, ID{Hash: checksumToBytes(checksumUpdate(0xdce96c2d, math.MaxUint64)), Next: 0}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Gray Glacier, far in the future. Remote announces Gopherium (non existing fork)
 		&#47;&#47; at some future timestamp 8888888888, for itself, but past block for local. Local is incompatible.
<span class="term-fg36">@@ -322,92 +283,92 @@</span> 		{params.MainnetChainConfig, 888888888, 1660000000, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1660000000}, ErrLocalIncompatibleOrStale},
&nbsp;
 		&#47;&#47; Local is mainnet Gray Glacier. Remote is also in Gray Glacier, but announces Gopherium (non existing
 		&#47;&#47; fork) at block 7279999, before Shanghai. Local is incompatible.
<span class="term-fg31">-		{&amp;timestampedConfig, 19999999, 1667999999, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1667999999}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 19999999, 1667999999, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 1667999999}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47;----------------------
 		&#47;&#47; Timestamp based tests
 		&#47;&#47;----------------------
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, remote announces the same. No future fork is announced.
<span class="term-fg31">-		{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: 0}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 20000000, 1681338455, ID{Hash: checksumToBytes(0xdce96c2d), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, remote announces the same. Remote also announces a next fork
 		&#47;&#47; at time 0xffffffff, but that is uncertain.
<span class="term-fg31">-		{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: math.MaxUint64}, nil},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 20000000, 1681338455, ID{Hash: checksumToBytes(0xdce96c2d), Next: math.MaxUint64}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet currently in Shanghai only (so it&#39;s aware of Cancun), remote announces
 		&#47;&#47; also Shanghai, but it&#39;s not yet aware of Cancun (e.g. non updated node before the fork).
 		&#47;&#47; In this case we don&#39;t know if Cancun passed yet or not.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun is specced
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: 0}, nil},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet currently in Shanghai only (so it&#39;s aware of Cancun), remote announces
 		&#47;&#47; also Shanghai, and it&#39;s also aware of Cancun (e.g. updated node before the fork). We
 		&#47;&#47; don&#39;t know if Cancun passed yet (will pass) or not.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun is specced and update next timestamp
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: 1678000000}, nil},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: 1678000000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet currently in Shanghai only (so it&#39;s aware of Cancun), remote announces
 		&#47;&#47; also Shanghai, and it&#39;s also aware of some random fork (e.g. misconfigured Cancun). As
 		&#47;&#47; neither forks passed at neither nodes, they may mismatch, but we still connect for now.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun is specced
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: math.MaxUint64}, nil},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x71147644), Next: math.MaxUint64}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet exactly on Cancun, remote announces Shanghai + knowledge about Cancun. Remote
 		&#47;&#47; is simply out of sync, accept.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun is specced, update local head and time, next timestamp
<span class="term-fg31">-		&#47;&#47; {&amp;timestampedConfig, 21000000, 1678000000, ID{Hash: checksumToBytes(0x71147644), Next: 1678000000}, nil},</span>
<span class="term-fg32">+		&#47;&#47; {params.MainnetChainConfig, 21000000, 1678000000, ID{Hash: checksumToBytes(0x71147644), Next: 1678000000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Cancun, remote announces Shanghai + knowledge about Cancun. Remote
 		&#47;&#47; is simply out of sync, accept.
 		&#47;&#47; TODO(karalabe): Enable this when Cancun is specced, update local head and time, next timestamp
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 21123456, 1678123456, ID{Hash: checksumToBytes(0x71147644), Next: 1678000000}, nil},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 21123456, 1678123456, ID{Hash: checksumToBytes(0x71147644), Next: 1678000000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Prague, remote announces Shanghai + knowledge about Cancun. Remote
 		&#47;&#47; is definitely out of sync. It may or may not need the Prague update, we don&#39;t know yet.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun **and** Prague is specced, update all the numbers
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 0, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}, nil},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 0, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, remote announces Cancun. Local is out of sync, accept.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun is specced, update remote checksum
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 21000000, 1678000000, ID{Hash: checksumToBytes(0x00000000), Next: 0}, nil},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 21000000, 1678000000, ID{Hash: checksumToBytes(0x00000000), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, remote announces Cancun, but is not aware of Prague. Local
 		&#47;&#47; out of sync. Local also knows about a future fork, but that is uncertain yet.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun **and** Prague is specced, update remote checksum
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 21000000, 1678000000, ID{Hash: checksumToBytes(0x00000000), Next: 0}, nil},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 21000000, 1678000000, ID{Hash: checksumToBytes(0x00000000), Next: 0}, nil},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Cancun. remote announces Shanghai but is not aware of further forks.
 		&#47;&#47; Remote needs software update.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun is specced, update local head and time
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 21000000, 1678000000, ID{Hash: checksumToBytes(0x71147644), Next: 0}, ErrRemoteStale},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 21000000, 1678000000, ID{Hash: checksumToBytes(0x71147644), Next: 0}, ErrRemoteStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, and isn&#39;t aware of more forks. Remote announces Shanghai +
 		&#47;&#47; 0xffffffff. Local needs software update, reject.
<span class="term-fg31">-		{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(checksumUpdate(0x71147644, math.MaxUint64)), Next: 0}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 20000000, 1681338455, ID{Hash: checksumToBytes(checksumUpdate(0xdce96c2d, math.MaxUint64)), Next: 0}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, and is aware of Cancun. Remote announces Cancun +
 		&#47;&#47; 0xffffffff. Local needs software update, reject.
 		&#47;&#47;
 		&#47;&#47; TODO(karalabe): Enable this when Cancun is specced, update remote checksum
<span class="term-fg31">-		&#47;&#47;{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(checksumUpdate(0x00000000, math.MaxUint64)), Next: 0}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		&#47;&#47;{params.MainnetChainConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(checksumUpdate(0x00000000, math.MaxUint64)), Next: 0}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, remote is random Shanghai.
<span class="term-fg31">-		{&amp;timestampedConfig, 20000000, 1668000000, ID{Hash: checksumToBytes(0x12345678), Next: 0}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 20000000, 1681338455, ID{Hash: checksumToBytes(0x12345678), Next: 0}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai, far in the future. Remote announces Gopherium (non existing fork)
 		&#47;&#47; at some future timestamp 8888888888, for itself, but past block for local. Local is incompatible.
 		&#47;&#47;
 		&#47;&#47; This case detects non-upgraded nodes with majority hash power (typical Ropsten mess).
<span class="term-fg31">-		{&amp;timestampedConfig, 88888888, 8888888888, ID{Hash: checksumToBytes(0x71147644), Next: 8888888888}, ErrLocalIncompatibleOrStale},</span>
<span class="term-fg32">+		{params.MainnetChainConfig, 88888888, 8888888888, ID{Hash: checksumToBytes(0xdce96c2d), Next: 8888888888}, ErrLocalIncompatibleOrStale},</span>
&nbsp;
 		&#47;&#47; Local is mainnet Shanghai. Remote is also in Shanghai, but announces Gopherium (non existing
 		&#47;&#47; fork) at timestamp 1668000000, before Cancun. Local is incompatible.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-90e30518ab5d52d5f311c0c7" role="button"
                   aria-expanded="false" aria-controls="id-90e30518ab5d52d5f311c0c7">
                    <code>core/rawdb/accessors_chain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/rawdb/accessors_chain.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/rawdb/accessors_chain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-90e30518ab5d52d5f311c0c7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_chain.go op-geth&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg1">index 3d0f36ba7644cce44fb330e4201cd544e483b659..7e41476b42e7734471dd99c3223af79979021d6e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg36">@@ -637,13 +637,11 @@</span> 		log.Error(&quot;Missing body but have receipt&quot;, &quot;hash&quot;, hash, &quot;number&quot;, number)
 		return nil
 	}
 	header := ReadHeader(db, hash, number)
<span class="term-fg31">-	var baseFee *big.Int</span>
 	if header == nil {
<span class="term-fg31">-		baseFee = big.NewInt(0)</span>
<span class="term-fg31">-	} else {</span>
<span class="term-fg31">-		baseFee = header.BaseFee</span>
<span class="term-fg32">+		log.Error(&quot;Missing header but have receipt&quot;, &quot;hash&quot;, hash, &quot;number&quot;, number)</span>
<span class="term-fg32">+		return nil</span>
 	}
<span class="term-fg31">-	if err := receipts.DeriveFields(config, hash, number, baseFee, body.Transactions); err != nil {</span>
<span class="term-fg32">+	if err := receipts.DeriveFields(config, hash, number, header.Time, header.BaseFee, body.Transactions); err != nil {</span>
 		log.Error(&quot;Failed to derive block receipts fields&quot;, &quot;hash&quot;, hash, &quot;number&quot;, number, &quot;err&quot;, err)
 		return nil
 	}
<span class="term-fg36">@@ -681,6 +679,15 @@</span> type storedReceiptRLP struct {
 	PostStateOrStatus []byte
 	CumulativeGasUsed uint64
 	Logs              []*types.Log
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Remaining fields are declared to allow the receipt RLP to be parsed without errors.</span>
<span class="term-fg32">+	&#47;&#47; However, they must not be used as they may not be populated correctly due to multiple receipt formats</span>
<span class="term-fg32">+	&#47;&#47; being combined into a single list of optional fields which can be mistaken for each other.</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce (*uint64) from Regolith deposit tx receipts will be parsed into L1GasUsed</span>
<span class="term-fg32">+	L1GasUsed  *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	L1GasPrice *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	L1Fee      *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	FeeScalar  string   `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
 }
&nbsp;
 &#47;&#47; ReceiptLogs is a barebone version of ReceiptForStorage which only keeps</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f61de86ff3e0403ce37b35e7" role="button"
                   aria-expanded="false" aria-controls="id-f61de86ff3e0403ce37b35e7">
                    <code>core/rawdb/accessors_chain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/rawdb/accessors_chain_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/rawdb/accessors_chain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+41</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f61de86ff3e0403ce37b35e7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_chain_test.go op-geth&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg1">index 84eae1d90d25fc6025854543f97a33a704da031e..a99da4a84bd2ef22eae2d0f7f2af225443993dfa 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg36">@@ -27,10 +27,12 @@</span> 	&quot;reflect&quot;
 	&quot;testing&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;
 )
&nbsp;
<span class="term-fg36">@@ -347,6 +349,9 @@</span> 	&#47;&#47; Create a live block since we need metadata to reconstruct the receipt
 	tx1 := types.NewTransaction(1, common.HexToAddress(&quot;0x1&quot;), big.NewInt(1), 1, big.NewInt(1), nil)
 	tx2 := types.NewTransaction(2, common.HexToAddress(&quot;0x2&quot;), big.NewInt(2), 2, big.NewInt(2), nil)
&nbsp;
<span class="term-fg32">+	header := &amp;types.Header{</span>
<span class="term-fg32">+		Number: big.NewInt(0),</span>
<span class="term-fg32">+	}</span>
 	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2}}
&nbsp;
 	&#47;&#47; Create the two receipts to manage afterwards
<span class="term-fg36">@@ -378,12 +383,15 @@</span> 	receipt2.Bloom = types.CreateBloom(types.Receipts{receipt2})
 	receipts := []*types.Receipt{receipt1, receipt2}
&nbsp;
 	&#47;&#47; Check that no receipt entries are in a pristine database
<span class="term-fg31">-	hash := common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+	hash := header.Hash()</span>
 	if rs := ReadReceipts(db, hash, 0, params.TestChainConfig); len(rs) != 0 {
 		t.Fatalf(&quot;non existent receipts returned: %v&quot;, rs)
 	}
 	&#47;&#47; Insert the body that corresponds to the receipts
 	WriteBody(db, hash, 0, body)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Insert the header that corresponds to the receipts</span>
<span class="term-fg32">+	WriteHeader(db, header)</span>
&nbsp;
 	&#47;&#47; Insert the receipt slice into the database and check presence
 	WriteReceipts(db, hash, 0, receipts)
<span class="term-fg36">@@ -698,6 +706,7 @@</span>
 	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2}}
&nbsp;
 	&#47;&#47; Create the two receipts to manage afterwards
<span class="term-fg32">+	depositNonce := uint64(math.MaxUint64)</span>
 	receipt1 := &amp;types.Receipt{
 		Status:            types.ReceiptStatusFailed,
 		CumulativeGasUsed: 1,
<span class="term-fg36">@@ -708,6 +717,7 @@</span> 		},
 		TxHash:          tx1.Hash(),
 		ContractAddress: common.BytesToAddress([]byte{0x01, 0x11, 0x11}),
 		GasUsed:         111111,
<span class="term-fg32">+		DepositNonce:    &amp;depositNonce,</span>
 	}
 	receipt1.Bloom = types.CreateBloom(types.Receipts{receipt1})
&nbsp;
<span class="term-fg36">@@ -765,6 +775,36 @@</span> 				t.Fatalf(&quot;receipt #%d: receipt mismatch: have %s, want %s&quot;, i, hex.EncodeToString(rlpHave), hex.EncodeToString(rlpWant))
 			}
 		}
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestParseLegacyReceiptRLP(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Create a gasUsed value greater than a uint64 can represent</span>
<span class="term-fg32">+	gasUsed := big.NewInt(0)</span>
<span class="term-fg32">+	gasUsed = gasUsed.SetUint64(math.MaxUint64)</span>
<span class="term-fg32">+	gasUsed = gasUsed.Add(gasUsed, big.NewInt(math.MaxInt64))</span>
<span class="term-fg32">+	sanityCheck := (&amp;big.Int{}).SetUint64(gasUsed.Uint64())</span>
<span class="term-fg32">+	require.NotEqual(t, gasUsed, sanityCheck)</span>
<span class="term-fg32">+	receipt := types.LegacyOptimismStoredReceiptRLP{</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		Logs: []*types.LogForStorage{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x11})},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x01, 0x11})},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		L1GasUsed:  gasUsed,</span>
<span class="term-fg32">+		L1GasPrice: gasUsed,</span>
<span class="term-fg32">+		L1Fee:      gasUsed,</span>
<span class="term-fg32">+		FeeScalar:  &quot;6&quot;,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	data, err := rlp.EncodeToBytes(receipt)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	var result storedReceiptRLP</span>
<span class="term-fg32">+	err = rlp.DecodeBytes(data, &amp;result)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1GasUsed, result.L1GasUsed)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1GasPrice, result.L1GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1Fee, result.L1Fee)</span>
<span class="term-fg32">+	require.Equal(t, receipt.FeeScalar, result.FeeScalar)</span>
 }
&nbsp;
 func TestDeriveLogFields(t *testing.T) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-55a99b1249d65c63eaec23da" role="button"
                   aria-expanded="false" aria-controls="id-55a99b1249d65c63eaec23da">
                    <code>core/state/state_object.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/state/state_object.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/state/state_object.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-37</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-55a99b1249d65c63eaec23da"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state&#47;state_object.go op-geth&#47;core&#47;state&#47;state_object.go</span>
<span class="term-fg1">index 5dfd3c1b648ae37a405339c31ea15f77653f025b..7e34cba44a8299c1ea843ca1b50fae98a248f3eb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state&#47;state_object.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state&#47;state_object.go</span>
<span class="term-fg36">@@ -43,7 +43,6 @@</span> func (s Storage) String() (str string) {
 	for key, value := range s {
 		str += fmt.Sprintf(&quot;%X : %X\n&quot;, key, value)
 	}
<span class="term-fg31">-</span>
 	return
 }
&nbsp;
<span class="term-fg36">@@ -52,7 +51,6 @@</span> 	cpy := make(Storage, len(s))
 	for key, value := range s {
 		cpy[key] = value
 	}
<span class="term-fg31">-</span>
 	return cpy
 }
&nbsp;
<span class="term-fg36">@@ -68,13 +66,6 @@</span> 	addrHash common.Hash &#47;&#47; hash of ethereum address of the account
 	data     types.StateAccount
 	db       *StateDB
&nbsp;
<span class="term-fg31">-	&#47;&#47; DB error.</span>
<span class="term-fg31">-	&#47;&#47; State objects are used by the consensus core and VM which are</span>
<span class="term-fg31">-	&#47;&#47; unable to deal with database-level errors. Any error that occurs</span>
<span class="term-fg31">-	&#47;&#47; during a database read is memoized here and will eventually be returned</span>
<span class="term-fg31">-	&#47;&#47; by StateDB.Commit.</span>
<span class="term-fg31">-	dbErr error</span>
<span class="term-fg31">-</span>
 	&#47;&#47; Write caches.
 	trie Trie &#47;&#47; storage trie, which becomes non-nil on first access
 	code Code &#47;&#47; contract bytecode, which gets set when code is loaded
<span class="term-fg36">@@ -84,7 +75,7 @@</span> 	pendingStorage Storage &#47;&#47; Storage entries that need to be flushed to disk, at the end of an entire block
 	dirtyStorage   Storage &#47;&#47; Storage entries that have been modified in the current transaction execution
&nbsp;
 	&#47;&#47; Cache flags.
<span class="term-fg31">-	&#47;&#47; When an object is marked suicided it will be delete from the trie</span>
<span class="term-fg32">+	&#47;&#47; When an object is marked suicided it will be deleted from the trie</span>
 	&#47;&#47; during the &quot;update&quot; phase of the state transition.
 	dirtyCode bool &#47;&#47; true if the code was updated
 	suicided  bool
<span class="term-fg36">@@ -123,13 +114,6 @@</span> func (s *stateObject) EncodeRLP(w io.Writer) error {
 	return rlp.Encode(w, &amp;s.data)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; setError remembers the first non-nil error it is called with.</span>
<span class="term-fg31">-func (s *stateObject) setError(err error) {</span>
<span class="term-fg31">-	if s.dbErr == nil {</span>
<span class="term-fg31">-		s.dbErr = err</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 func (s *stateObject) markSuicided() {
 	s.suicided = true
 }
<span class="term-fg36">@@ -214,7 +198,7 @@</span> 	if s.db.snap == nil || err != nil {
 		start := time.Now()
 		tr, err := s.getTrie(db)
 		if err != nil {
<span class="term-fg31">-			s.setError(err)</span>
<span class="term-fg32">+			s.db.setError(err)</span>
 			return common.Hash{}
 		}
 		enc, err = tr.TryGet(key.Bytes())
<span class="term-fg36">@@ -222,7 +206,7 @@</span> 		if metrics.EnabledExpensive {
 			s.db.StorageReads += time.Since(start)
 		}
 		if err != nil {
<span class="term-fg31">-			s.setError(err)</span>
<span class="term-fg32">+			s.db.setError(err)</span>
 			return common.Hash{}
 		}
 	}
<span class="term-fg36">@@ -230,7 +214,7 @@</span> 	var value common.Hash
 	if len(enc) &gt; 0 {
 		_, content, _, err := rlp.Split(enc)
 		if err != nil {
<span class="term-fg31">-			s.setError(err)</span>
<span class="term-fg32">+			s.db.setError(err)</span>
 		}
 		value.SetBytes(content)
 	}
<span class="term-fg36">@@ -296,7 +280,7 @@</span> 		hasher  = s.db.hasher
 	)
 	tr, err := s.getTrie(db)
 	if err != nil {
<span class="term-fg31">-		s.setError(err)</span>
<span class="term-fg32">+		s.db.setError(err)</span>
 		return nil, err
 	}
 	&#47;&#47; Insert all the pending updates into the trie
<span class="term-fg36">@@ -311,7 +295,7 @@</span>
 		var v []byte
 		if (value == common.Hash{}) {
 			if err := tr.TryDelete(key[:]); err != nil {
<span class="term-fg31">-				s.setError(err)</span>
<span class="term-fg32">+				s.db.setError(err)</span>
 				return nil, err
 			}
 			s.db.StorageDeleted += 1
<span class="term-fg36">@@ -319,7 +303,7 @@</span> 		} else {
 			&#47;&#47; Encoding []byte cannot fail, ok to ignore the error.
 			v, _ = rlp.EncodeToBytes(common.TrimLeftZeroes(value[:]))
 			if err := tr.TryUpdate(key[:], v); err != nil {
<span class="term-fg31">-				s.setError(err)</span>
<span class="term-fg32">+				s.db.setError(err)</span>
 				return nil, err
 			}
 			s.db.StorageUpdated += 1
<span class="term-fg36">@@ -351,7 +335,6 @@</span> &#47;&#47; will be returned if trie root hash is not computed correctly.
 func (s *stateObject) updateRoot(db Database) {
 	tr, err := s.updateTrie(db)
 	if err != nil {
<span class="term-fg31">-		s.setError(fmt.Errorf(&quot;updateRoot (%x) error: %w&quot;, s.address, err))</span>
 		return
 	}
 	&#47;&#47; If nothing changed, don&#39;t bother with hashing anything
<span class="term-fg36">@@ -372,9 +355,6 @@</span> 	tr, err := s.updateTrie(db)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	if s.dbErr != nil {</span>
<span class="term-fg31">-		return nil, s.dbErr</span>
<span class="term-fg31">-	}</span>
 	&#47;&#47; If nothing changed, don&#39;t bother with committing anything
 	if tr == nil {
 		return nil, nil
<span class="term-fg36">@@ -385,7 +365,7 @@</span> 		defer func(start time.Time) { s.db.StorageCommits += time.Since(start) }(time.Now())
 	}
 	root, nodes := tr.Commit(false)
 	s.data.Root = root
<span class="term-fg31">-	return nodes, err</span>
<span class="term-fg32">+	return nodes, nil</span>
 }
&nbsp;
 &#47;&#47; AddBalance adds amount to s&#39;s balance.
<span class="term-fg36">@@ -457,7 +437,7 @@</span> 		return nil
 	}
 	code, err := db.ContractCode(s.addrHash, common.BytesToHash(s.CodeHash()))
 	if err != nil {
<span class="term-fg31">-		s.setError(fmt.Errorf(&quot;can&#39;t load code hash %x: %v&quot;, s.CodeHash(), err))</span>
<span class="term-fg32">+		s.db.setError(fmt.Errorf(&quot;can&#39;t load code hash %x: %v&quot;, s.CodeHash(), err))</span>
 	}
 	s.code = code
 	return code
<span class="term-fg36">@@ -475,7 +455,7 @@</span> 		return 0
 	}
 	size, err := db.ContractCodeSize(s.addrHash, common.BytesToHash(s.CodeHash()))
 	if err != nil {
<span class="term-fg31">-		s.setError(fmt.Errorf(&quot;can&#39;t load code size %x: %v&quot;, s.CodeHash(), err))</span>
<span class="term-fg32">+		s.db.setError(fmt.Errorf(&quot;can&#39;t load code size %x: %v&quot;, s.CodeHash(), err))</span>
 	}
 	return size
 }
<span class="term-fg36">@@ -519,10 +499,3 @@</span>
 func (s *stateObject) Nonce() uint64 {
 	return s.data.Nonce
 }
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; Value is never called, but must be present to allow stateObject to be used</span>
<span class="term-fg31">-&#47;&#47; as a vm.Account interface that also satisfies the vm.ContractRef</span>
<span class="term-fg31">-&#47;&#47; interface. Interfaces are awesome.</span>
<span class="term-fg31">-func (s *stateObject) Value() *big.Int {</span>
<span class="term-fg31">-	panic(&quot;Value on stateObject should never be called&quot;)</span>
<span class="term-fg31">-}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4f80af693eacc1a7ea77c2f1" role="button"
                   aria-expanded="false" aria-controls="id-4f80af693eacc1a7ea77c2f1">
                    <code>core/state/statedb.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/state/statedb.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/state/statedb.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+7</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4f80af693eacc1a7ea77c2f1"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state&#47;statedb.go op-geth&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg1">index 3d8fd15bbd25690049b9cd9f76321ddec354958f..54d5040451be1c7198f09d94d8271a5b0e78c463 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg36">@@ -81,8 +81,10 @@</span>
 	&#47;&#47; DB error.
 	&#47;&#47; State objects are used by the consensus core and VM which are
 	&#47;&#47; unable to deal with database-level errors. Any error that occurs
<span class="term-fg31">-	&#47;&#47; during a database read is memoized here and will eventually be returned</span>
<span class="term-fg31">-	&#47;&#47; by StateDB.Commit.</span>
<span class="term-fg32">+	&#47;&#47; during a database read is memoized here and will eventually be</span>
<span class="term-fg32">+	&#47;&#47; returned by StateDB.Commit. Notably, this error is also shared</span>
<span class="term-fg32">+	&#47;&#47; by all cached state objects in case the database failure occurs</span>
<span class="term-fg32">+	&#47;&#47; when accessing state of accounts.</span>
 	dbErr error
&nbsp;
 	&#47;&#47; The refund counter, also used by state transitioning.
<span class="term-fg36">@@ -187,6 +189,7 @@</span> 		s.dbErr = err
 	}
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; Error returns the memorized database failure occurred earlier.</span>
 func (s *StateDB) Error() error {
 	return s.dbErr
 }
<span class="term-fg36">@@ -478,13 +481,11 @@</span> 	prev := s.GetTransientState(addr, key)
 	if prev == value {
 		return
 	}
<span class="term-fg31">-</span>
 	s.journal.append(transientStorageChange{
 		account:  &amp;addr,
 		key:      key,
 		prevalue: prev,
 	})
<span class="term-fg31">-</span>
 	s.setTransientState(addr, key, value)
 }
&nbsp;
<span class="term-fg36">@@ -957,6 +958,7 @@</span> }
&nbsp;
 &#47;&#47; Commit writes the state to the underlying in-memory trie database.
 func (s *StateDB) Commit(deleteEmptyObjects bool) (common.Hash, error) {
<span class="term-fg32">+	&#47;&#47; Short circuit in case any database failure occurred earlier.</span>
 	if s.dbErr != nil {
 		return common.Hash{}, fmt.Errorf(&quot;commit aborted due to earlier error: %v&quot;, s.dbErr)
 	}
<span class="term-fg36">@@ -970,8 +972,8 @@</span> 		accountTrieNodesDeleted int
 		storageTrieNodesUpdated int
 		storageTrieNodesDeleted int
 		nodes                   = trie.NewMergedNodeSet()
<span class="term-fg32">+		codeWriter              = s.db.DiskDB().NewBatch()</span>
 	)
<span class="term-fg31">-	codeWriter := s.db.DiskDB().NewBatch()</span>
 	for addr := range s.stateObjectsDirty {
 		if obj := s.stateObjects[addr]; !obj.deleted {
 			&#47;&#47; Write any contract code associated with the state object</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-47c840fd4132a1a4c76670a5" role="button"
                   aria-expanded="false" aria-controls="id-47c840fd4132a1a4c76670a5">
                    <code>core/types/receipt_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/types/receipt_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/receipt_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+171</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-47c840fd4132a1a4c76670a5"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;receipt_test.go op-geth&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg1">index 376177f976efb48b55e887c7229462a89246b16e..3f3df0398357e71b5915b8f63e6adbdce9327067 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg36">@@ -19,6 +19,7 @@</span>
 import (
 	&quot;bytes&quot;
 	&quot;encoding&#47;json&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&quot;
 	&quot;math&#47;big&quot;
 	&quot;reflect&quot;
<span class="term-fg36">@@ -28,6 +29,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;kylelemons&#47;godebug&#47;diff&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -81,6 +83,42 @@</span> 			},
 		},
 		Type: DynamicFeeTxType,
 	}
<span class="term-fg32">+	depositReceiptNoNonce = &amp;Receipt{</span>
<span class="term-fg32">+		Status:            ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonce                   = uint64(1234)</span>
<span class="term-fg32">+	depositReceiptWithNonce = &amp;Receipt{</span>
<span class="term-fg32">+		Status:            ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		DepositNonce:      &amp;nonce,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
 )
&nbsp;
 func TestDecodeEmptyTypedReceipt(t *testing.T) {
<span class="term-fg36">@@ -137,8 +175,13 @@</span> 			Gas:       5,
 			GasTipCap: big.NewInt(56),
 			GasFeeCap: big.NewInt(1055),
 		}),
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   50,</span>
<span class="term-fg32">+		}),</span>
 	}
<span class="term-fg31">-</span>
<span class="term-fg32">+	depNonce := uint64(7)</span>
 	blockNumber := big.NewInt(1)
 	blockHash := common.BytesToHash([]byte{0x03, 0x14})
&nbsp;
<span class="term-fg36">@@ -246,12 +289,45 @@</span> 			BlockHash:         blockHash,
 			BlockNumber:       blockNumber,
 			TransactionIndex:  4,
 		},
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 50 + 15,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[5].Hash(),</span>
<span class="term-fg32">+					TxIndex:     5,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       4,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[5].Hash(),</span>
<span class="term-fg32">+					TxIndex:     5,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       5,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:            txs[5].Hash(),</span>
<span class="term-fg32">+			ContractAddress:   common.HexToAddress(&quot;0x3bb898b4bbe24f68a4e9be46cfe72d1787fd74f4&quot;),</span>
<span class="term-fg32">+			GasUsed:           50,</span>
<span class="term-fg32">+			EffectiveGasPrice: big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:         blockHash,</span>
<span class="term-fg32">+			BlockNumber:       blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:  5,</span>
<span class="term-fg32">+			DepositNonce:      &amp;depNonce,</span>
<span class="term-fg32">+		},</span>
 	}
&nbsp;
 	&#47;&#47; Re-derive receipts.
 	basefee := big.NewInt(1000)
 	derivedReceipts := clearComputedFieldsOnReceipts(receipts)
<span class="term-fg31">-	err := Receipts(derivedReceipts).DeriveFields(params.TestChainConfig, blockHash, blockNumber.Uint64(), basefee, txs)</span>
<span class="term-fg32">+	err := Receipts(derivedReceipts).DeriveFields(params.TestChainConfig, blockHash, blockNumber.Uint64(), 0, basefee, txs)</span>
 	if err != nil {
 		t.Fatalf(&quot;DeriveFields(...) = %v, want &lt;nil&gt;&quot;, err)
 	}
<span class="term-fg36">@@ -398,6 +474,38 @@</span> 		t.Errorf(&quot;receipt unmarshalled from binary mismatch, got %v want %v&quot;, got1559Receipt, eip1559Receipt)
 	}
 }
&nbsp;
<span class="term-fg32">+func TestBedrockDepositReceiptUnchanged(t *testing.T) {</span>
<span class="term-fg32">+	expectedRlp := common.FromHex(&quot;7EF90156A003000000000000000000000000000000000000000000000000000000000000000AB9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0D7940000000000000000000000000000000000000033C001D7940000000000000000000000000000000000000333C002&quot;)</span>
<span class="term-fg32">+	&#47;&#47; Deposit receipt with no nonce</span>
<span class="term-fg32">+	receipt := &amp;Receipt{</span>
<span class="term-fg32">+		Type:              DepositTxType,</span>
<span class="term-fg32">+		PostState:         common.Hash{3}.Bytes(),</span>
<span class="term-fg32">+		CumulativeGasUsed: 10,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x33}), Data: []byte{1}, Topics: []common.Hash{}},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x03, 0x33}), Data: []byte{2}, Topics: []common.Hash{}},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		TxHash:          common.Hash{},</span>
<span class="term-fg32">+		ContractAddress: common.BytesToAddress([]byte{0x03, 0x33, 0x33}),</span>
<span class="term-fg32">+		GasUsed:         4,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	rlp, err := receipt.MarshalBinary()</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, expectedRlp, rlp)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Consensus values should be unchanged after reparsing</span>
<span class="term-fg32">+	parsed := new(Receipt)</span>
<span class="term-fg32">+	err = parsed.UnmarshalBinary(rlp)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, receipt.Status, parsed.Status)</span>
<span class="term-fg32">+	require.Equal(t, receipt.CumulativeGasUsed, parsed.CumulativeGasUsed)</span>
<span class="term-fg32">+	require.Equal(t, receipt.Bloom, parsed.Bloom)</span>
<span class="term-fg32">+	require.EqualValues(t, receipt.Logs, parsed.Logs)</span>
<span class="term-fg32">+	&#47;&#47; And still shouldn&#39;t have a nonce</span>
<span class="term-fg32">+	require.Nil(t, parsed.DepositNonce)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func clearComputedFieldsOnReceipts(receipts []*Receipt) []*Receipt {
 	r := make([]*Receipt, len(receipts))
 	for i, receipt := range receipts {
<span class="term-fg36">@@ -431,3 +539,64 @@</span> 		l[i] = &amp;cpy
 	}
 	return l
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRoundTripReceipt(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name string</span>
<span class="term-fg32">+		rcpt *Receipt</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{name: &quot;Legacy&quot;, rcpt: legacyReceipt},</span>
<span class="term-fg32">+		{name: &quot;AccessList&quot;, rcpt: accessListReceipt},</span>
<span class="term-fg32">+		{name: &quot;EIP1559&quot;, rcpt: eip1559Receipt},</span>
<span class="term-fg32">+		{name: &quot;DepositNoNonce&quot;, rcpt: depositReceiptNoNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonce&quot;, rcpt: depositReceiptWithNonce},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := test.rcpt.MarshalBinary()</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			d := &amp;Receipt{}</span>
<span class="term-fg32">+			err = d.UnmarshalBinary(data)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt, d)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Run(fmt.Sprintf(&quot;%sRejectExtraData&quot;, test.name), func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := test.rcpt.MarshalBinary()</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			data = append(data, 1, 2, 3, 4)</span>
<span class="term-fg32">+			d := &amp;Receipt{}</span>
<span class="term-fg32">+			err = d.UnmarshalBinary(data)</span>
<span class="term-fg32">+			require.Error(t, err)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRoundTripReceiptForStorage(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name string</span>
<span class="term-fg32">+		rcpt *Receipt</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{name: &quot;Legacy&quot;, rcpt: legacyReceipt},</span>
<span class="term-fg32">+		{name: &quot;AccessList&quot;, rcpt: accessListReceipt},</span>
<span class="term-fg32">+		{name: &quot;EIP1559&quot;, rcpt: eip1559Receipt},</span>
<span class="term-fg32">+		{name: &quot;DepositNoNonce&quot;, rcpt: depositReceiptNoNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonce&quot;, rcpt: depositReceiptWithNonce},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := rlp.EncodeToBytes((*ReceiptForStorage)(test.rcpt))</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			d := &amp;ReceiptForStorage{}</span>
<span class="term-fg32">+			err = rlp.DecodeBytes(data, d)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			&#47;&#47; Only check the stored fields - the others are derived later</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.Status, d.Status)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.CumulativeGasUsed, d.CumulativeGasUsed)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.Logs, d.Logs)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositNonce, d.DepositNonce)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e537545a67ce996f82921420" role="button"
                   aria-expanded="false" aria-controls="id-e537545a67ce996f82921420">
                    <code>core/types/rollup_l1_cost_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/types/rollup_l1_cost_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+30</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e537545a67ce996f82921420"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;rollup_l1_cost_test.go op-geth&#47;core&#47;types&#47;rollup_l1_cost_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..e43ea967ee87a257cfc2afa58396c2eb6685ed76</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;rollup_l1_cost_test.go</span>
<span class="term-fg36">@@ -0,0 +1,30 @@</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;rand&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRollupGasData(t *testing.T) {</span>
<span class="term-fg32">+	for i := 0; i &lt; 100; i++ {</span>
<span class="term-fg32">+		zeroes := rand.Uint64()</span>
<span class="term-fg32">+		ones := rand.Uint64()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		r := RollupGasData{</span>
<span class="term-fg32">+			Zeroes: zeroes,</span>
<span class="term-fg32">+			Ones:   ones,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		time := uint64(1)</span>
<span class="term-fg32">+		cfg := &amp;params.ChainConfig{</span>
<span class="term-fg32">+			RegolithTime: &amp;time,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		gasPreRegolith := r.DataGas(0, cfg)</span>
<span class="term-fg32">+		gasPostRegolith := r.DataGas(1, cfg)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		require.Equal(t, r.Zeroes*params.TxDataZeroGas+(r.Ones+68)*params.TxDataNonZeroGasEIP2028, gasPreRegolith)</span>
<span class="term-fg32">+		require.Equal(t, r.Zeroes*params.TxDataZeroGas+r.Ones*params.TxDataNonZeroGasEIP2028, gasPostRegolith)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-62c049d2990e98f0fd8e68a8" role="button"
                   aria-expanded="false" aria-controls="id-62c049d2990e98f0fd8e68a8">
                    <code>core/vm/interface.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/vm/interface.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/vm/interface.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+0</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-62c049d2990e98f0fd8e68a8"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;interface.go op-geth&#47;core&#47;vm&#47;interface.go</span>
<span class="term-fg1">index 0ee32b1dd510d97f2225f207c31d7e87c4f4b71a..b83f78307eb79622d9048435a2b417fcf5f70727 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;interface.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;interface.go</span>
<span class="term-fg36">@@ -76,8 +76,6 @@</span> 	Snapshot() int
&nbsp;
 	AddLog(*types.Log)
 	AddPreimage(common.Hash, []byte)
<span class="term-fg31">-</span>
<span class="term-fg31">-	ForEachStorage(common.Address, func(common.Hash, common.Hash) bool) error</span>
 }
&nbsp;
 &#47;&#47; CallContext provides a basic interface for the EVM calling conventions. The EVM</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7bf53ba0fa499bb1da313596" role="button"
                   aria-expanded="false" aria-controls="id-7bf53ba0fa499bb1da313596">
                    <code>core/vm/jump_table.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/core/vm/jump_table.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/core/vm/jump_table.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7bf53ba0fa499bb1da313596"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;jump_table.go op-geth&#47;core&#47;vm&#47;jump_table.go</span>
<span class="term-fg1">index 91f1be669a40d19497f4e2677a6e92d15d0f45ff..a45287de80dfeda56c2431bbb30133ec34c281d8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;jump_table.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;jump_table.go</span>
<span class="term-fg36">@@ -98,7 +98,7 @@</span> 	return validate(instructionSet)
 }
&nbsp;
 &#47;&#47; newLondonInstructionSet returns the frontier, homestead, byzantium,
<span class="term-fg31">-&#47;&#47; contantinople, istanbul, petersburg, berlin and london instructions.</span>
<span class="term-fg32">+&#47;&#47; constantinople, istanbul, petersburg, berlin and london instructions.</span>
 func newLondonInstructionSet() JumpTable {
 	instructionSet := newBerlinInstructionSet()
 	enable3529(&amp;instructionSet) &#47;&#47; EIP-3529: Reduction in refunds https:&#47;&#47;eips.ethereum.org&#47;EIPS&#47;eip-3529
<span class="term-fg36">@@ -107,7 +107,7 @@</span> 	return validate(instructionSet)
 }
&nbsp;
 &#47;&#47; newBerlinInstructionSet returns the frontier, homestead, byzantium,
<span class="term-fg31">-&#47;&#47; contantinople, istanbul, petersburg and berlin instructions.</span>
<span class="term-fg32">+&#47;&#47; constantinople, istanbul, petersburg and berlin instructions.</span>
 func newBerlinInstructionSet() JumpTable {
 	instructionSet := newIstanbulInstructionSet()
 	enable2929(&amp;instructionSet) &#47;&#47; Access lists for trie accesses https:&#47;&#47;eips.ethereum.org&#47;EIPS&#47;eip-2929
<span class="term-fg36">@@ -115,7 +115,7 @@</span> 	return validate(instructionSet)
 }
&nbsp;
 &#47;&#47; newIstanbulInstructionSet returns the frontier, homestead, byzantium,
<span class="term-fg31">-&#47;&#47; contantinople, istanbul and petersburg instructions.</span>
<span class="term-fg32">+&#47;&#47; constantinople, istanbul and petersburg instructions.</span>
 func newIstanbulInstructionSet() JumpTable {
 	instructionSet := newConstantinopleInstructionSet()
&nbsp;
<span class="term-fg36">@@ -127,7 +127,7 @@</span> 	return validate(instructionSet)
 }
&nbsp;
 &#47;&#47; newConstantinopleInstructionSet returns the frontier, homestead,
<span class="term-fg31">-&#47;&#47; byzantium and contantinople instructions.</span>
<span class="term-fg32">+&#47;&#47; byzantium and constantinople instructions.</span>
 func newConstantinopleInstructionSet() JumpTable {
 	instructionSet := newByzantiumInstructionSet()
 	instructionSet[SHL] = &amp;operation{</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d104f97118554fa04c842e1f" role="button"
                   aria-expanded="false" aria-controls="id-d104f97118554fa04c842e1f">
                    <code>eth/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/eth/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/eth/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d104f97118554fa04c842e1f"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;api.go op-geth&#47;eth&#47;api.go</span>
<span class="term-fg1">index cd6510ccf9a23bc97b6ceb7bbc9acf2cd1880f34..92b7f00fd4017ed2cee517e00aca3f944f106863 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;api.go</span>
<span class="term-fg36">@@ -161,7 +161,7 @@</span> 		&#47;&#47; since the &#39;file&#39; may point to arbitrary paths on the drive.
 		return false, errors.New(&quot;location would overwrite an existing file&quot;)
 	}
 	&#47;&#47; Make sure we can create the file to export into
<span class="term-fg31">-	out, err := os.OpenFile(file, os.O_CREATE|os.O_WRONLY|os.O_TRUNC, os.ModePerm)</span>
<span class="term-fg32">+	out, err := os.OpenFile(file, os.O_CREATE|os.O_WRONLY|os.O_TRUNC, 0644)</span>
 	if err != nil {
 		return false, err
 	}
<span class="term-fg36">@@ -324,7 +324,7 @@</span> 			blockRlp = err.Error() &#47;&#47; Hacky, but hey, it works
 		} else {
 			blockRlp = fmt.Sprintf(&quot;%#x&quot;, rlpBytes)
 		}
<span class="term-fg31">-		if blockJSON, err = ethapi.RPCMarshalBlock(block, true, true, api.eth.APIBackend.ChainConfig()); err != nil {</span>
<span class="term-fg32">+		if blockJSON, err = ethapi.RPCMarshalBlock(ctx, block, true, true, api.eth.APIBackend); err != nil {</span>
 			blockJSON = map[string]interface{}{&quot;error&quot;: err.Error()}
 		}
 		results = append(results, &amp;BadBlockArgs{</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0f371a74ed471949a60b5d11" role="button"
                   aria-expanded="false" aria-controls="id-0f371a74ed471949a60b5d11">
                    <code>light/odr_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/light/odr_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/light/odr_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0f371a74ed471949a60b5d11"><span class="term-fg1">diff --git go-ethereum&#47;light&#47;odr_test.go op-geth&#47;light&#47;odr_test.go</span>
<span class="term-fg1">index 173298bb77f2705bbea9a7fe6db44b7c132aef0d..31ec261811d7a9a85995e781ba8af9e9bffd3b1a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;light&#47;odr_test.go</span>
<span class="term-fg1">+++ op-geth&#47;light&#47;odr_test.go</span>
<span class="term-fg36">@@ -211,7 +211,7 @@</span> 			Data:              data,
 			SkipAccountChecks: true,
 		}
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(header, chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(header, chain, nil, config, st)</span>
 		vmenv := vm.NewEVM(context, txContext, st, config, vm.Config{NoBaseFee: true})
 		gp := new(core.GasPool).AddGas(math.MaxUint64)
 		result, _ := core.ApplyMessage(vmenv, msg, gp)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-17baa40568ed84c45a1e8e5c" role="button"
                   aria-expanded="false" aria-controls="id-17baa40568ed84c45a1e8e5c">
                    <code>light/odr_util.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/light/odr_util.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/light/odr_util.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-17baa40568ed84c45a1e8e5c"><span class="term-fg1">diff --git go-ethereum&#47;light&#47;odr_util.go op-geth&#47;light&#47;odr_util.go</span>
<span class="term-fg1">index 786b54132aa720840f5f9dde2e088c85557d477d..37a1b7a633fb9771653825ed8c58e862a6eebd93 100644</span>
<span class="term-fg1">--- go-ethereum&#47;light&#47;odr_util.go</span>
<span class="term-fg1">+++ op-geth&#47;light&#47;odr_util.go</span>
<span class="term-fg36">@@ -175,7 +175,7 @@</span> 		}
 		genesis := rawdb.ReadCanonicalHash(odr.Database(), 0)
 		config := rawdb.ReadChainConfig(odr.Database(), genesis)
&nbsp;
<span class="term-fg31">-		if err := receipts.DeriveFields(config, block.Hash(), block.NumberU64(), block.BaseFee(), block.Transactions()); err != nil {</span>
<span class="term-fg32">+		if err := receipts.DeriveFields(config, block.Hash(), block.NumberU64(), block.Time(), block.BaseFee(), block.Transactions()); err != nil {</span>
 			return nil, err
 		}
 		rawdb.WriteReceipts(odr.Database(), hash, number, receipts)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-14a2fbd82a385969d592f8cb" role="button"
                   aria-expanded="false" aria-controls="id-14a2fbd82a385969d592f8cb">
                    <code>p2p/discover/v5_udp.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/p2p/discover/v5_udp.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/p2p/discover/v5_udp.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-14a2fbd82a385969d592f8cb"><span class="term-fg1">diff --git go-ethereum&#47;p2p&#47;discover&#47;v5_udp.go op-geth&#47;p2p&#47;discover&#47;v5_udp.go</span>
<span class="term-fg1">index 53a1c6f7670a5704390632aeb35a535763748e9c..38f5b3b652cf65e0d5bed17ea2c159dbe014f322 100644</span>
<span class="term-fg1">--- go-ethereum&#47;p2p&#47;discover&#47;v5_udp.go</span>
<span class="term-fg1">+++ op-geth&#47;p2p&#47;discover&#47;v5_udp.go</span>
<span class="term-fg36">@@ -83,6 +83,7 @@</span> 	readNextCh    chan struct{}
 	callCh        chan *callV5
 	callDoneCh    chan *callV5
 	respTimeoutCh chan *callTimeout
<span class="term-fg32">+	unhandled     chan&lt;- ReadPacket</span>
&nbsp;
 	&#47;&#47; state of dispatch
 	codec            codecV5
<span class="term-fg36">@@ -156,6 +157,7 @@</span> 		readNextCh:    make(chan struct{}, 1),
 		callCh:        make(chan *callV5),
 		callDoneCh:    make(chan *callV5),
 		respTimeoutCh: make(chan *callTimeout),
<span class="term-fg32">+		unhandled:     cfg.Unhandled,</span>
 		&#47;&#47; state of dispatch
 		codec:            v5wire.NewCodec(ln, cfg.PrivateKey, cfg.Clock, cfg.V5ProtocolID),
 		activeCallByNode: make(map[enode.ID]*callV5),
<span class="term-fg36">@@ -657,6 +659,14 @@</span> func (t *UDPv5) handlePacket(rawpacket []byte, fromAddr *net.UDPAddr) error {
 	addr := fromAddr.String()
 	fromID, fromNode, packet, err := t.codec.Decode(rawpacket, addr)
 	if err != nil {
<span class="term-fg32">+		if t.unhandled != nil &amp;&amp; v5wire.IsInvalidHeader(err) {</span>
<span class="term-fg32">+			&#47;&#47; The packet seems unrelated to discv5, send it to the next protocol.</span>
<span class="term-fg32">+			&#47;&#47; t.log.Trace(&quot;Unhandled discv5 packet&quot;, &quot;id&quot;, fromID, &quot;addr&quot;, addr, &quot;err&quot;, err)</span>
<span class="term-fg32">+			up := ReadPacket{Data: make([]byte, len(rawpacket)), Addr: fromAddr}</span>
<span class="term-fg32">+			copy(up.Data, rawpacket)</span>
<span class="term-fg32">+			t.unhandled &lt;- up</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
 		t.log.Debug(&quot;Bad discv5 packet&quot;, &quot;id&quot;, fromID, &quot;addr&quot;, addr, &quot;err&quot;, err)
 		return err
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1459a169c2480f527c0aec36" role="button"
                   aria-expanded="false" aria-controls="id-1459a169c2480f527c0aec36">
                    <code>p2p/discover/v5wire/encoding.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/p2p/discover/v5wire/encoding.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/p2p/discover/v5wire/encoding.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+16</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1459a169c2480f527c0aec36"><span class="term-fg1">diff --git go-ethereum&#47;p2p&#47;discover&#47;v5wire&#47;encoding.go op-geth&#47;p2p&#47;discover&#47;v5wire&#47;encoding.go</span>
<span class="term-fg1">index d979ab0f9cd83a403f41c46dbde9f97bb3f598b5..5108910620e0b38b4e8830f7d4b728a3becfc723 100644</span>
<span class="term-fg1">--- go-ethereum&#47;p2p&#47;discover&#47;v5wire&#47;encoding.go</span>
<span class="term-fg1">+++ op-geth&#47;p2p&#47;discover&#47;v5wire&#47;encoding.go</span>
<span class="term-fg36">@@ -94,6 +94,8 @@</span> 	&#47;&#47; The minimum size of any Discovery v5 packet is 63 bytes.
 	&#47;&#47; Should reject packets smaller than minPacketSize.
 	minPacketSize = 63
&nbsp;
<span class="term-fg32">+	maxPacketSize = 1280</span>
<span class="term-fg32">+</span>
 	minMessageSize      = 48 &#47;&#47; this refers to data after static headers
 	randomPacketMsgSize = 20
 )
<span class="term-fg36">@@ -122,6 +124,13 @@</span> 	&#47;&#47; ErrInvalidReqID represents error when the ID is invalid.
 	ErrInvalidReqID = errors.New(&quot;request ID larger than 8 bytes&quot;)
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; IsInvalidHeader reports whether &#39;err&#39; is related to an invalid packet header. When it</span>
<span class="term-fg32">+&#47;&#47; returns false, it is pretty certain that the packet causing the error does not belong</span>
<span class="term-fg32">+&#47;&#47; to discv5.</span>
<span class="term-fg32">+func IsInvalidHeader(err error) bool {</span>
<span class="term-fg32">+	return err == errTooShort || err == errInvalidHeader || err == errMsgTooShort</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Packet sizes.
 var (
 	sizeofStaticHeader      = binary.Size(StaticHeader{})
<span class="term-fg36">@@ -147,6 +156,7 @@</span> 	msgbuf   bytes.Buffer &#47;&#47; message RLP plaintext
 	msgctbuf []byte       &#47;&#47; message data ciphertext
&nbsp;
 	&#47;&#47; decoder buffer
<span class="term-fg32">+	decbuf []byte</span>
 	reader bytes.Reader
 }
&nbsp;
<span class="term-fg36">@@ -158,6 +168,7 @@</span> 		localnode:  ln,
 		privkey:    key,
 		sc:         NewSessionCache(1024, clock),
 		protocolID: DefaultProtocolID,
<span class="term-fg32">+		decbuf:     make([]byte, maxPacketSize),</span>
 	}
 	if protocolID != nil {
 		c.protocolID = *protocolID
<span class="term-fg36">@@ -424,10 +435,13 @@</span> 	return messageCT, err
 }
&nbsp;
 &#47;&#47; Decode decodes a discovery packet.
<span class="term-fg31">-func (c *Codec) Decode(input []byte, addr string) (src enode.ID, n *enode.Node, p Packet, err error) {</span>
<span class="term-fg31">-	if len(input) &lt; minPacketSize {</span>
<span class="term-fg32">+func (c *Codec) Decode(inputData []byte, addr string) (src enode.ID, n *enode.Node, p Packet, err error) {</span>
<span class="term-fg32">+	if len(inputData) &lt; minPacketSize {</span>
 		return enode.ID{}, nil, nil, errTooShort
 	}
<span class="term-fg32">+	&#47;&#47; Copy the packet to a tmp buffer to avoid modifying it.</span>
<span class="term-fg32">+	c.decbuf = append(c.decbuf[:0], inputData...)</span>
<span class="term-fg32">+	input := c.decbuf</span>
 	&#47;&#47; Unmask the static header.
 	var head Header
 	copy(head.IV[:], input[:sizeofMaskingIV])</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-669bb68f7dac027673cfe90f" role="button"
                   aria-expanded="false" aria-controls="id-669bb68f7dac027673cfe90f">
                    <code>params/config_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/params/config_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/params/config_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-669bb68f7dac027673cfe90f"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;config_test.go op-geth&#47;params&#47;config_test.go</span>
<span class="term-fg1">index 5634569e29f09891985c442d87ad51a0d053268f..bf9181d00afa04eb9d1ed8c2ee7b22797260be70 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;config_test.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;config_test.go</span>
<span class="term-fg36">@@ -136,3 +136,22 @@</span> 	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsShanghai {
 		t.Errorf(&quot;expected %v to be shanghai&quot;, stamp)
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestConfigRulesRegolith(t *testing.T) {</span>
<span class="term-fg32">+	c := &amp;ChainConfig{</span>
<span class="term-fg32">+		RegolithTime: newUint64(500),</span>
<span class="term-fg32">+		Optimism:     &amp;OptimismConfig{},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var stamp uint64</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to not be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	stamp = 500</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	stamp = math.MaxInt64</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-136f796107ff1ebfc97adea8" role="button"
                   aria-expanded="false" aria-controls="id-136f796107ff1ebfc97adea8">
                    <code>rlp/decode.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rlp/decode.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/decode.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+64</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-136f796107ff1ebfc97adea8"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;decode.go op-geth&#47;rlp&#47;decode.go</span>
<span class="term-fg1">index c9b2652414558468afadbd0866ca3248a53c142b..c9b50e8c18795ee3da5634d6184f36ffaafedaa8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rlp&#47;decode.go</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;decode.go</span>
<span class="term-fg36">@@ -29,6 +29,7 @@</span> 	&quot;strings&quot;
 	&quot;sync&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&#47;internal&#47;rlpstruct&quot;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 &#47;&#47;lint:ignore ST1012 EOL is not an error.
<span class="term-fg36">@@ -52,6 +53,7 @@</span> 	errNotAtEOL      = errors.New(&quot;rlp: call of ListEnd not positioned at EOL&quot;)
 	errUintOverflow  = errors.New(&quot;rlp: uint overflow&quot;)
 	errNoPointer     = errors.New(&quot;rlp: interface given to Decode must be a pointer&quot;)
 	errDecodeIntoNil = errors.New(&quot;rlp: pointer given to Decode must not be nil&quot;)
<span class="term-fg32">+	errUint256Large  = errors.New(&quot;rlp: value too large for uint256&quot;)</span>
&nbsp;
 	streamPool = sync.Pool{
 		New: func() interface{} { return new(Stream) },
<span class="term-fg36">@@ -148,6 +150,7 @@</span>
 var (
 	decoderInterface = reflect.TypeOf(new(Decoder)).Elem()
 	bigInt           = reflect.TypeOf(big.Int{})
<span class="term-fg32">+	u256Int          = reflect.TypeOf(uint256.Int{})</span>
 )
&nbsp;
 func makeDecoder(typ reflect.Type, tags rlpstruct.Tags) (dec decoder, err error) {
<span class="term-fg36">@@ -159,6 +162,10 @@</span> 	case typ.AssignableTo(reflect.PtrTo(bigInt)):
 		return decodeBigInt, nil
 	case typ.AssignableTo(bigInt):
 		return decodeBigIntNoPtr, nil
<span class="term-fg32">+	case typ == reflect.PtrTo(u256Int):</span>
<span class="term-fg32">+		return decodeU256, nil</span>
<span class="term-fg32">+	case typ == u256Int:</span>
<span class="term-fg32">+		return decodeU256NoPtr, nil</span>
 	case kind == reflect.Ptr:
 		return makePtrDecoder(typ, tags)
 	case reflect.PtrTo(typ).Implements(decoderInterface):
<span class="term-fg36">@@ -229,6 +236,24 @@</span> 		val.Set(reflect.ValueOf(i))
 	}
&nbsp;
 	err := s.decodeBigInt(i)
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return wrapStreamError(err, val.Type())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeU256NoPtr(s *Stream, val reflect.Value) error {</span>
<span class="term-fg32">+	return decodeU256(s, val.Addr())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeU256(s *Stream, val reflect.Value) error {</span>
<span class="term-fg32">+	i := val.Interface().(*uint256.Int)</span>
<span class="term-fg32">+	if i == nil {</span>
<span class="term-fg32">+		i = new(uint256.Int)</span>
<span class="term-fg32">+		val.Set(reflect.ValueOf(i))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	err := s.ReadUint256(i)</span>
 	if err != nil {
 		return wrapStreamError(err, val.Type())
 	}
<span class="term-fg36">@@ -852,6 +877,45 @@</span> 		buffer = make([]byte, size)
 		if err := s.readFull(buffer); err != nil {
 			return err
 		}
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Reject leading zero bytes.</span>
<span class="term-fg32">+	if len(buffer) &gt; 0 &amp;&amp; buffer[0] == 0 {</span>
<span class="term-fg32">+		return ErrCanonInt</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Set the integer bytes.</span>
<span class="term-fg32">+	dst.SetBytes(buffer)</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ReadUint256 decodes the next value as a uint256.</span>
<span class="term-fg32">+func (s *Stream) ReadUint256(dst *uint256.Int) error {</span>
<span class="term-fg32">+	var buffer []byte</span>
<span class="term-fg32">+	kind, size, err := s.Kind()</span>
<span class="term-fg32">+	switch {</span>
<span class="term-fg32">+	case err != nil:</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	case kind == List:</span>
<span class="term-fg32">+		return ErrExpectedString</span>
<span class="term-fg32">+	case kind == Byte:</span>
<span class="term-fg32">+		buffer = s.uintbuf[:1]</span>
<span class="term-fg32">+		buffer[0] = s.byteval</span>
<span class="term-fg32">+		s.kind = -1 &#47;&#47; re-arm Kind</span>
<span class="term-fg32">+	case size == 0:</span>
<span class="term-fg32">+		&#47;&#47; Avoid zero-length read.</span>
<span class="term-fg32">+		s.kind = -1</span>
<span class="term-fg32">+	case size &lt;= uint64(len(s.uintbuf)):</span>
<span class="term-fg32">+		&#47;&#47; All possible uint256 values fit into s.uintbuf.</span>
<span class="term-fg32">+		buffer = s.uintbuf[:size]</span>
<span class="term-fg32">+		if err := s.readFull(buffer); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Reject inputs where single byte encoding should have been used.</span>
<span class="term-fg32">+		if size == 1 &amp;&amp; buffer[0] &lt; 128 {</span>
<span class="term-fg32">+			return ErrCanonSize</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return errUint256Large</span>
 	}
&nbsp;
 	&#47;&#47; Reject leading zero bytes.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-094298cfbb0f1981e6e5554b" role="button"
                   aria-expanded="false" aria-controls="id-094298cfbb0f1981e6e5554b">
                    <code>rlp/decode_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rlp/decode_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/decode_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+42</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-094298cfbb0f1981e6e5554b"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;decode_test.go op-geth&#47;rlp&#47;decode_test.go</span>
<span class="term-fg1">index dbcfcffed1a1a45994a9adb4384e91b096cba6cf..07d9c579a6a47e709b29e8ad0d85c5986aab038d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rlp&#47;decode_test.go</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;decode_test.go</span>
<span class="term-fg36">@@ -28,6 +28,7 @@</span> 	&quot;strings&quot;
 	&quot;testing&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 func TestStreamKind(t *testing.T) {
<span class="term-fg36">@@ -468,6 +469,10 @@</span> 	)
 	veryVeryBigInt = new(big.Int).Exp(veryBigInt, big.NewInt(8), nil)
 )
&nbsp;
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	veryBigInt256, _ = uint256.FromBig(veryBigInt)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
 var decodeTests = []decodeTest{
 	&#47;&#47; booleans
 	{input: &quot;01&quot;, ptr: new(bool), value: true},
<span class="term-fg36">@@ -541,10 +546,26 @@</span> 	{input: &quot;01&quot;, ptr: new(*big.Int), value: big.NewInt(1)},
 	{input: &quot;89FFFFFFFFFFFFFFFFFF&quot;, ptr: new(*big.Int), value: veryBigInt},
 	{input: &quot;B848FFFFFFFFFFFFFFFFF800000000000000001BFFFFFFFFFFFFFFFFC8000000000000000045FFFFFFFFFFFFFFFFC800000000000000001BFFFFFFFFFFFFFFFFF8000000000000000001&quot;, ptr: new(*big.Int), value: veryVeryBigInt},
 	{input: &quot;10&quot;, ptr: new(big.Int), value: *big.NewInt(16)}, &#47;&#47; non-pointer also works
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; big int errors</span>
 	{input: &quot;C0&quot;, ptr: new(*big.Int), error: &quot;rlp: expected input string or byte for *big.Int&quot;},
 	{input: &quot;00&quot;, ptr: new(*big.Int), error: &quot;rlp: non-canonical integer (leading zero bytes) for *big.Int&quot;},
 	{input: &quot;820001&quot;, ptr: new(*big.Int), error: &quot;rlp: non-canonical integer (leading zero bytes) for *big.Int&quot;},
 	{input: &quot;8105&quot;, ptr: new(*big.Int), error: &quot;rlp: non-canonical size information for *big.Int&quot;},
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; uint256</span>
<span class="term-fg32">+	{input: &quot;80&quot;, ptr: new(*uint256.Int), value: uint256.NewInt(0)},</span>
<span class="term-fg32">+	{input: &quot;01&quot;, ptr: new(*uint256.Int), value: uint256.NewInt(1)},</span>
<span class="term-fg32">+	{input: &quot;88FFFFFFFFFFFFFFFF&quot;, ptr: new(*uint256.Int), value: uint256.NewInt(math.MaxUint64)},</span>
<span class="term-fg32">+	{input: &quot;89FFFFFFFFFFFFFFFFFF&quot;, ptr: new(*uint256.Int), value: veryBigInt256},</span>
<span class="term-fg32">+	{input: &quot;10&quot;, ptr: new(uint256.Int), value: *uint256.NewInt(16)}, &#47;&#47; non-pointer also works</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; uint256 errors</span>
<span class="term-fg32">+	{input: &quot;C0&quot;, ptr: new(*uint256.Int), error: &quot;rlp: expected input string or byte for *uint256.Int&quot;},</span>
<span class="term-fg32">+	{input: &quot;00&quot;, ptr: new(*uint256.Int), error: &quot;rlp: non-canonical integer (leading zero bytes) for *uint256.Int&quot;},</span>
<span class="term-fg32">+	{input: &quot;820001&quot;, ptr: new(*uint256.Int), error: &quot;rlp: non-canonical integer (leading zero bytes) for *uint256.Int&quot;},</span>
<span class="term-fg32">+	{input: &quot;8105&quot;, ptr: new(*uint256.Int), error: &quot;rlp: non-canonical size information for *uint256.Int&quot;},</span>
<span class="term-fg32">+	{input: &quot;A1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00&quot;, ptr: new(*uint256.Int), error: &quot;rlp: value too large for uint256&quot;},</span>
&nbsp;
 	&#47;&#47; structs
 	{
<span class="term-fg36">@@ -1216,6 +1237,27 @@</span> 	b.ReportAllocs()
 	b.ResetTimer()
&nbsp;
 	var out []*big.Int
<span class="term-fg32">+	for i := 0; i &lt; b.N; i++ {</span>
<span class="term-fg32">+		if err := DecodeBytes(enc, &amp;out); err != nil {</span>
<span class="term-fg32">+			b.Fatal(err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func BenchmarkDecodeU256Ints(b *testing.B) {</span>
<span class="term-fg32">+	ints := make([]*uint256.Int, 200)</span>
<span class="term-fg32">+	for i := range ints {</span>
<span class="term-fg32">+		ints[i], _ = uint256.FromBig(math.BigPow(2, int64(i)))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	enc, err := EncodeToBytes(ints)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		b.Fatal(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	b.SetBytes(int64(len(enc)))</span>
<span class="term-fg32">+	b.ReportAllocs()</span>
<span class="term-fg32">+	b.ResetTimer()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var out []*uint256.Int</span>
 	for i := 0; i &lt; b.N; i++ {
 		if err := DecodeBytes(enc, &amp;out); err != nil {
 			b.Fatal(err)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-011a318fd75da8da4f549177" role="button"
                   aria-expanded="false" aria-controls="id-011a318fd75da8da4f549177">
                    <code>rlp/encbuffer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rlp/encbuffer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/encbuffer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+25</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-011a318fd75da8da4f549177"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;encbuffer.go op-geth&#47;rlp&#47;encbuffer.go</span>
<span class="term-fg1">index d2c6d93bcaeaa6ac99b5466958c0c745a2ffecb5..9ac4fcb2cabc18731996fdd5a60bc7235701faf8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rlp&#47;encbuffer.go</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;encbuffer.go</span>
<span class="term-fg36">@@ -17,10 +17,13 @@</span>
 package rlp
&nbsp;
 import (
<span class="term-fg32">+	&quot;encoding&#47;binary&quot;</span>
 	&quot;io&quot;
 	&quot;math&#47;big&quot;
 	&quot;reflect&quot;
 	&quot;sync&quot;
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 type encBuffer struct {
<span class="term-fg36">@@ -167,6 +170,23 @@</span> 			buf[index] = byte(d)
 			d &gt;&gt;= 8
 		}
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; writeUint256 writes z as an integer.</span>
<span class="term-fg32">+func (w *encBuffer) writeUint256(z *uint256.Int) {</span>
<span class="term-fg32">+	bitlen := z.BitLen()</span>
<span class="term-fg32">+	if bitlen &lt;= 64 {</span>
<span class="term-fg32">+		w.writeUint64(z.Uint64())</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nBytes := byte((bitlen + 7) &#47; 8)</span>
<span class="term-fg32">+	var b [33]byte</span>
<span class="term-fg32">+	binary.BigEndian.PutUint64(b[1:9], z[3])</span>
<span class="term-fg32">+	binary.BigEndian.PutUint64(b[9:17], z[2])</span>
<span class="term-fg32">+	binary.BigEndian.PutUint64(b[17:25], z[1])</span>
<span class="term-fg32">+	binary.BigEndian.PutUint64(b[25:33], z[0])</span>
<span class="term-fg32">+	b[32-nBytes] = 0x80 + nBytes</span>
<span class="term-fg32">+	w.str = append(w.str, b[32-nBytes:]...)</span>
 }
&nbsp;
 &#47;&#47; list adds a new list header to the header stack. It returns the index of the header.
<span class="term-fg36">@@ -374,6 +394,11 @@</span> &#47;&#47; WriteBigInt encodes a big.Int as an RLP string.
 &#47;&#47; Note: Unlike with Encode, the sign of i is ignored.
 func (w EncoderBuffer) WriteBigInt(i *big.Int) {
 	w.buf.writeBigInt(i)
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; WriteUint256 encodes uint256.Int as an RLP string.</span>
<span class="term-fg32">+func (w EncoderBuffer) WriteUint256(i *uint256.Int) {</span>
<span class="term-fg32">+	w.buf.writeUint256(i)</span>
 }
&nbsp;
 &#47;&#47; WriteBytes encodes b as an RLP string.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6669faf990940303098b537e" role="button"
                   aria-expanded="false" aria-controls="id-6669faf990940303098b537e">
                    <code>rlp/encode.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rlp/encode.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/encode.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6669faf990940303098b537e"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;encode.go op-geth&#47;rlp&#47;encode.go</span>
<span class="term-fg1">index a377a1ef4c9960282fa800fe51c29774482e3b64..3fac0bd2d3c2fe5c31f70cd6bbf1e1dcbc28427c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rlp&#47;encode.go</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;encode.go</span>
<span class="term-fg36">@@ -24,6 +24,7 @@</span> 	&quot;math&#47;big&quot;
 	&quot;reflect&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&#47;internal&#47;rlpstruct&quot;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -144,6 +145,10 @@</span> 	case typ.AssignableTo(reflect.PtrTo(bigInt)):
 		return writeBigIntPtr, nil
 	case typ.AssignableTo(bigInt):
 		return writeBigIntNoPtr, nil
<span class="term-fg32">+	case typ == reflect.PtrTo(u256Int):</span>
<span class="term-fg32">+		return writeU256IntPtr, nil</span>
<span class="term-fg32">+	case typ == u256Int:</span>
<span class="term-fg32">+		return writeU256IntNoPtr, nil</span>
 	case kind == reflect.Ptr:
 		return makePtrWriter(typ, ts)
 	case reflect.PtrTo(typ).Implements(encoderInterface):
<span class="term-fg36">@@ -203,6 +208,22 @@</span> 	if i.Sign() == -1 {
 		return ErrNegativeBigInt
 	}
 	w.writeBigInt(&amp;i)
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func writeU256IntPtr(val reflect.Value, w *encBuffer) error {</span>
<span class="term-fg32">+	ptr := val.Interface().(*uint256.Int)</span>
<span class="term-fg32">+	if ptr == nil {</span>
<span class="term-fg32">+		w.str = append(w.str, 0x80)</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	w.writeUint256(ptr)</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func writeU256IntNoPtr(val reflect.Value, w *encBuffer) error {</span>
<span class="term-fg32">+	i := val.Interface().(uint256.Int)</span>
<span class="term-fg32">+	w.writeUint256(&amp;i)</span>
 	return nil
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1fdf71cc5427ca415ab47424" role="button"
                   aria-expanded="false" aria-controls="id-1fdf71cc5427ca415ab47424">
                    <code>rlp/encode_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rlp/encode_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/encode_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+49</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1fdf71cc5427ca415ab47424"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;encode_test.go op-geth&#47;rlp&#47;encode_test.go</span>
<span class="term-fg1">index 82c490a802751b049e975127bc82f392dddd1329..02be47d0ef1b4efc768600cc406ceb77f48ff688 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rlp&#47;encode_test.go</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;encode_test.go</span>
<span class="term-fg36">@@ -27,6 +27,7 @@</span> 	&quot;sync&quot;
 	&quot;testing&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 type testEncoder struct {
<span class="term-fg36">@@ -146,6 +147,30 @@</span>
 	&#47;&#47; negative ints are not supported
 	{val: big.NewInt(-1), error: &quot;rlp: cannot encode negative big.Int&quot;},
 	{val: *big.NewInt(-1), error: &quot;rlp: cannot encode negative big.Int&quot;},
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; uint256</span>
<span class="term-fg32">+	{val: uint256.NewInt(0), output: &quot;80&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(1), output: &quot;01&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(127), output: &quot;7F&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(128), output: &quot;8180&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(256), output: &quot;820100&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(1024), output: &quot;820400&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(0xFFFFFF), output: &quot;83FFFFFF&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(0xFFFFFFFF), output: &quot;84FFFFFFFF&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(0xFFFFFFFFFF), output: &quot;85FFFFFFFFFF&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(0xFFFFFFFFFFFF), output: &quot;86FFFFFFFFFFFF&quot;},</span>
<span class="term-fg32">+	{val: uint256.NewInt(0xFFFFFFFFFFFFFF), output: &quot;87FFFFFFFFFFFFFF&quot;},</span>
<span class="term-fg32">+	{</span>
<span class="term-fg32">+		val:    new(uint256.Int).SetBytes(unhex(&quot;102030405060708090A0B0C0D0E0F2&quot;)),</span>
<span class="term-fg32">+		output: &quot;8F102030405060708090A0B0C0D0E0F2&quot;,</span>
<span class="term-fg32">+	},</span>
<span class="term-fg32">+	{</span>
<span class="term-fg32">+		val:    new(uint256.Int).SetBytes(unhex(&quot;0100020003000400050006000700080009000A000B000C000D000E01&quot;)),</span>
<span class="term-fg32">+		output: &quot;9C0100020003000400050006000700080009000A000B000C000D000E01&quot;,</span>
<span class="term-fg32">+	},</span>
<span class="term-fg32">+	&#47;&#47; non-pointer uint256.Int</span>
<span class="term-fg32">+	{val: *uint256.NewInt(0), output: &quot;80&quot;},</span>
<span class="term-fg32">+	{val: *uint256.NewInt(0xFFFFFF), output: &quot;83FFFFFF&quot;},</span>
&nbsp;
 	&#47;&#47; byte arrays
 	{val: [0]byte{}, output: &quot;80&quot;},
<span class="term-fg36">@@ -256,6 +281,12 @@</span> 		},
 		output: &quot;F90200CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376CF84617364668471776572847A786376&quot;,
 	},
&nbsp;
<span class="term-fg32">+	&#47;&#47; Non-byte arrays are encoded as lists.</span>
<span class="term-fg32">+	&#47;&#47; Note that it is important to test [4]uint64 specifically,</span>
<span class="term-fg32">+	&#47;&#47; because that&#39;s the underlying type of uint256.Int.</span>
<span class="term-fg32">+	{val: [4]uint32{1, 2, 3, 4}, output: &quot;C401020304&quot;},</span>
<span class="term-fg32">+	{val: [4]uint64{1, 2, 3, 4}, output: &quot;C401020304&quot;},</span>
<span class="term-fg32">+</span>
 	&#47;&#47; RawValue
 	{val: RawValue(unhex(&quot;01&quot;)), output: &quot;01&quot;},
 	{val: RawValue(unhex(&quot;82FFFF&quot;)), output: &quot;82FFFF&quot;},
<span class="term-fg36">@@ -301,6 +332,7 @@</span> 	{val: (*string)(nil), output: &quot;80&quot;},
 	{val: (*[]byte)(nil), output: &quot;80&quot;},
 	{val: (*[10]byte)(nil), output: &quot;80&quot;},
 	{val: (*big.Int)(nil), output: &quot;80&quot;},
<span class="term-fg32">+	{val: (*uint256.Int)(nil), output: &quot;80&quot;},</span>
 	{val: (*[]string)(nil), output: &quot;C0&quot;},
 	{val: (*[10]string)(nil), output: &quot;C0&quot;},
 	{val: (*[]interface{})(nil), output: &quot;C0&quot;},
<span class="term-fg36">@@ -496,6 +528,23 @@</span> func BenchmarkEncodeBigInts(b *testing.B) {
 	ints := make([]*big.Int, 200)
 	for i := range ints {
 		ints[i] = math.BigPow(2, int64(i))
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	out := bytes.NewBuffer(make([]byte, 0, 4096))</span>
<span class="term-fg32">+	b.ResetTimer()</span>
<span class="term-fg32">+	b.ReportAllocs()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for i := 0; i &lt; b.N; i++ {</span>
<span class="term-fg32">+		out.Reset()</span>
<span class="term-fg32">+		if err := Encode(out, ints); err != nil {</span>
<span class="term-fg32">+			b.Fatal(err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func BenchmarkEncodeU256Ints(b *testing.B) {</span>
<span class="term-fg32">+	ints := make([]*uint256.Int, 200)</span>
<span class="term-fg32">+	for i := range ints {</span>
<span class="term-fg32">+		ints[i], _ = uint256.FromBig(math.BigPow(2, int64(i)))</span>
 	}
 	out := bytes.NewBuffer(make([]byte, 0, 4096))
 	b.ResetTimer()</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cdd0b5964527575a8533caf6" role="button"
                   aria-expanded="false" aria-controls="id-cdd0b5964527575a8533caf6">
                    <code>rlp/rlpgen/gen.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rlp/rlpgen/gen.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/rlpgen/gen.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+50</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cdd0b5964527575a8533caf6"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;rlpgen&#47;gen.go op-geth&#47;rlp&#47;rlpgen&#47;gen.go</span>
<span class="term-fg1">index 1deb5a93c2a38405b07bcee49bb11bb969272b78..0c6586482698329fc09075d9dba9a97d663a2bb6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rlp&#47;rlpgen&#47;gen.go</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;rlpgen&#47;gen.go</span>
<span class="term-fg36">@@ -283,7 +283,7 @@</span> 	fmt.Fprintf(&amp;b, &quot;if err := dec.ReadBytes(%s[:]); err != nil { return err }\n&quot;, resultV)
 	return resultV, b.String()
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; bigIntNoPtrOp handles non-pointer big.Int.</span>
<span class="term-fg32">+&#47;&#47; bigIntOp handles big.Int.</span>
 &#47;&#47; This exists because big.Int has it&#39;s own decoder operation on rlp.Stream,
 &#47;&#47; but the decode method returns *big.Int, so it needs to be dereferenced.
 type bigIntOp struct {
<span class="term-fg36">@@ -326,6 +326,49 @@</span>
 	result := resultV
 	if !op.pointer {
 		result = &quot;(*&quot; + resultV + &quot;)&quot;
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return result, b.String()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; uint256Op handles &quot;github.com&#47;holiman&#47;uint256&quot;.Int</span>
<span class="term-fg32">+type uint256Op struct {</span>
<span class="term-fg32">+	pointer bool</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (op uint256Op) genWrite(ctx *genContext, v string) string {</span>
<span class="term-fg32">+	var b bytes.Buffer</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	dst := v</span>
<span class="term-fg32">+	if !op.pointer {</span>
<span class="term-fg32">+		dst = &quot;&amp;&quot; + v</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	fmt.Fprintf(&amp;b, &quot;w.WriteUint256(%s)\n&quot;, dst)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Wrap with nil check.</span>
<span class="term-fg32">+	if op.pointer {</span>
<span class="term-fg32">+		code := b.String()</span>
<span class="term-fg32">+		b.Reset()</span>
<span class="term-fg32">+		fmt.Fprintf(&amp;b, &quot;if %s == nil {\n&quot;, v)</span>
<span class="term-fg32">+		fmt.Fprintf(&amp;b, &quot;  w.Write(rlp.EmptyString)&quot;)</span>
<span class="term-fg32">+		fmt.Fprintf(&amp;b, &quot;} else {\n&quot;)</span>
<span class="term-fg32">+		fmt.Fprint(&amp;b, code)</span>
<span class="term-fg32">+		fmt.Fprintf(&amp;b, &quot;}\n&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return b.String()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (op uint256Op) genDecode(ctx *genContext) (string, string) {</span>
<span class="term-fg32">+	ctx.addImport(&quot;github.com&#47;holiman&#47;uint256&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var b bytes.Buffer</span>
<span class="term-fg32">+	resultV := ctx.temp()</span>
<span class="term-fg32">+	fmt.Fprintf(&amp;b, &quot;var %s uint256.Int\n&quot;, resultV)</span>
<span class="term-fg32">+	fmt.Fprintf(&amp;b, &quot;if err := dec.ReadUint256(&amp;%s); err != nil { return err }\n&quot;, resultV)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result := resultV</span>
<span class="term-fg32">+	if op.pointer {</span>
<span class="term-fg32">+		result = &quot;&amp;&quot; + resultV</span>
 	}
 	return result, b.String()
 }
<span class="term-fg36">@@ -635,6 +678,9 @@</span> 	case *types.Named:
 		if isBigInt(typ) {
 			return bigIntOp{}, nil
 		}
<span class="term-fg32">+		if isUint256(typ) {</span>
<span class="term-fg32">+			return uint256Op{}, nil</span>
<span class="term-fg32">+		}</span>
 		if typ == bctx.rawValueType {
 			return bctx.makeRawValueOp(), nil
 		}
<span class="term-fg36">@@ -646,6 +692,9 @@</span> 		return bctx.makeOp(typ, typ.Underlying(), tags)
 	case *types.Pointer:
 		if isBigInt(typ.Elem()) {
 			return bigIntOp{pointer: true}, nil
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if isUint256(typ.Elem()) {</span>
<span class="term-fg32">+			return uint256Op{pointer: true}, nil</span>
 		}
 		&#47;&#47; Encoder&#47;Decoder interfaces.
 		if bctx.isEncoder(typ) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8eacd7a23c7003189e06cd1b" role="button"
                   aria-expanded="false" aria-controls="id-8eacd7a23c7003189e06cd1b">
                    <code>rlp/rlpgen/gen_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rlp/rlpgen/gen_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/rlpgen/gen_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8eacd7a23c7003189e06cd1b"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;rlpgen&#47;gen_test.go op-geth&#47;rlp&#47;rlpgen&#47;gen_test.go</span>
<span class="term-fg1">index 241c34b6dfaafe0816a813123b4df7bdbe39db25..ff3b8385ae16e33ad889d1810c8b8c9e95db48bb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rlp&#47;rlpgen&#47;gen_test.go</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;rlpgen&#47;gen_test.go</span>
<span class="term-fg36">@@ -47,7 +47,7 @@</span> 		panic(fmt.Errorf(&quot;can&#39;t load package RLP: %v&quot;, err))
 	}
 }
&nbsp;
<span class="term-fg31">-var tests = []string{&quot;uints&quot;, &quot;nil&quot;, &quot;rawvalue&quot;, &quot;optional&quot;, &quot;bigint&quot;}</span>
<span class="term-fg32">+var tests = []string{&quot;uints&quot;, &quot;nil&quot;, &quot;rawvalue&quot;, &quot;optional&quot;, &quot;bigint&quot;, &quot;uint256&quot;}</span>
&nbsp;
 func TestOutput(t *testing.T) {
 	for _, test := range tests {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-69776bd866b9c6f13c5b5854" role="button"
                   aria-expanded="false" aria-controls="id-69776bd866b9c6f13c5b5854">
                    <code>rlp/rlpgen/testdata/uint256.in.txt</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/rlpgen/testdata/uint256.in.txt" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-69776bd866b9c6f13c5b5854"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;rlpgen&#47;testdata&#47;uint256.in.txt op-geth&#47;rlp&#47;rlpgen&#47;testdata&#47;uint256.in.txt</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..ed16e0a7882f60dea662ad9cb7b3ada12325ced4</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;rlpgen&#47;testdata&#47;uint256.in.txt</span>
<span class="term-fg36">@@ -0,0 +1,10 @@</span>
<span class="term-fg32">+&#47;&#47; -*- mode: go -*-</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package test</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import &quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type Test struct {</span>
<span class="term-fg32">+	Int      *uint256.Int</span>
<span class="term-fg32">+	IntNoPtr uint256.Int</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e5869a3a69de87e9e6b53a6f" role="button"
                   aria-expanded="false" aria-controls="id-e5869a3a69de87e9e6b53a6f">
                    <code>rlp/rlpgen/testdata/uint256.out.txt</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/rlpgen/testdata/uint256.out.txt" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+44</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e5869a3a69de87e9e6b53a6f"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;rlpgen&#47;testdata&#47;uint256.out.txt op-geth&#47;rlp&#47;rlpgen&#47;testdata&#47;uint256.out.txt</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..5e6d3ed992cdbe5b00bf439a493d647330b73c69</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;rlpgen&#47;testdata&#47;uint256.out.txt</span>
<span class="term-fg36">@@ -0,0 +1,44 @@</span>
<span class="term-fg32">+package test</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import &quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
<span class="term-fg32">+import &quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg32">+import &quot;io&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (obj *Test) EncodeRLP(_w io.Writer) error {</span>
<span class="term-fg32">+	w := rlp.NewEncoderBuffer(_w)</span>
<span class="term-fg32">+	_tmp0 := w.List()</span>
<span class="term-fg32">+	if obj.Int == nil {</span>
<span class="term-fg32">+		w.Write(rlp.EmptyString)</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		w.WriteUint256(obj.Int)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	w.WriteUint256(&amp;obj.IntNoPtr)</span>
<span class="term-fg32">+	w.ListEnd(_tmp0)</span>
<span class="term-fg32">+	return w.Flush()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (obj *Test) DecodeRLP(dec *rlp.Stream) error {</span>
<span class="term-fg32">+	var _tmp0 Test</span>
<span class="term-fg32">+	{</span>
<span class="term-fg32">+		if _, err := dec.List(); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Int:</span>
<span class="term-fg32">+		var _tmp1 uint256.Int</span>
<span class="term-fg32">+		if err := dec.ReadUint256(&amp;_tmp1); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		_tmp0.Int = &amp;_tmp1</span>
<span class="term-fg32">+		&#47;&#47; IntNoPtr:</span>
<span class="term-fg32">+		var _tmp2 uint256.Int</span>
<span class="term-fg32">+		if err := dec.ReadUint256(&amp;_tmp2); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		_tmp0.IntNoPtr = _tmp2</span>
<span class="term-fg32">+		if err := dec.ListEnd(); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	*obj = _tmp0</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-51b1575d6d0cf3d50421dce4" role="button"
                   aria-expanded="false" aria-controls="id-51b1575d6d0cf3d50421dce4">
                    <code>rlp/rlpgen/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rlp/rlpgen/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rlp/rlpgen/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-51b1575d6d0cf3d50421dce4"><span class="term-fg1">diff --git go-ethereum&#47;rlp&#47;rlpgen&#47;types.go op-geth&#47;rlp&#47;rlpgen&#47;types.go</span>
<span class="term-fg1">index 19694262e54eedbcaaa675196cd45999bcfd4a60..ea7dc96d88137deb5e69dfff0ce2dbf43584d631 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rlp&#47;rlpgen&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;rlp&#47;rlpgen&#47;types.go</span>
<span class="term-fg36">@@ -97,6 +97,16 @@</span> 	name := named.Obj()
 	return name.Pkg().Path() == &quot;math&#47;big&quot; &amp;&amp; name.Name() == &quot;Int&quot;
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; isUint256 checks whether &#39;typ&#39; is &quot;github.com&#47;holiman&#47;uint256&quot;.Int.</span>
<span class="term-fg32">+func isUint256(typ types.Type) bool {</span>
<span class="term-fg32">+	named, ok := typ.(*types.Named)</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	name := named.Obj()</span>
<span class="term-fg32">+	return name.Pkg().Path() == &quot;github.com&#47;holiman&#47;uint256&quot; &amp;&amp; name.Name() == &quot;Int&quot;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; isByte checks whether the underlying type of &#39;typ&#39; is uint8.
 func isByte(typ types.Type) bool {
 	basic, ok := resolveUnderlying(typ).(*types.Basic)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ce346b94a748cf105c7705ec" role="button"
                   aria-expanded="false" aria-controls="id-ce346b94a748cf105c7705ec">
                    <code>rpc/websocket.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/rpc/websocket.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/rpc/websocket.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ce346b94a748cf105c7705ec"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;websocket.go op-geth&#47;rpc&#47;websocket.go</span>
<span class="term-fg1">index 0ac2a2792d5afc5c468916ae3eb510024498bf09..a6b95dd2acd363714d780473f3dd5708183e1f5a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;websocket.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;websocket.go</span>
<span class="term-fg36">@@ -38,7 +38,7 @@</span> 	wsWriteBuffer      = 1024
 	wsPingInterval     = 30 * time.Second
 	wsPingWriteTimeout = 5 * time.Second
 	wsPongTimeout      = 30 * time.Second
<span class="term-fg31">-	wsMessageSizeLimit = 15 * 1024 * 1024</span>
<span class="term-fg32">+	wsMessageSizeLimit = 32 * 1024 * 1024</span>
 )
&nbsp;
 var wsBufferPool = new(sync.Pool)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d5fa9b16998dda22aae647e1" role="button"
                   aria-expanded="false" aria-controls="id-d5fa9b16998dda22aae647e1">
                    <code>tests/init.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/tests/init.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/tests/init.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+13</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d5fa9b16998dda22aae647e1"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;init.go op-geth&#47;tests&#47;init.go</span>
<span class="term-fg1">index db037e3e1a06c95a80867e42ea19f8120e7e59d3..869f1bfcdd67775fe0353a54c1fde24350a9b6ac 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;init.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;init.go</span>
<span class="term-fg36">@@ -90,6 +90,19 @@</span> 		ConstantinopleBlock: big.NewInt(0),
 		PetersburgBlock:     big.NewInt(0),
 		IstanbulBlock:       big.NewInt(0),
 	},
<span class="term-fg32">+	&quot;MuirGlacier&quot;: {</span>
<span class="term-fg32">+		ChainID:             big.NewInt(1),</span>
<span class="term-fg32">+		HomesteadBlock:      big.NewInt(0),</span>
<span class="term-fg32">+		EIP150Block:         big.NewInt(0),</span>
<span class="term-fg32">+		EIP155Block:         big.NewInt(0),</span>
<span class="term-fg32">+		EIP158Block:         big.NewInt(0),</span>
<span class="term-fg32">+		DAOForkBlock:        big.NewInt(0),</span>
<span class="term-fg32">+		ByzantiumBlock:      big.NewInt(0),</span>
<span class="term-fg32">+		ConstantinopleBlock: big.NewInt(0),</span>
<span class="term-fg32">+		PetersburgBlock:     big.NewInt(0),</span>
<span class="term-fg32">+		IstanbulBlock:       big.NewInt(0),</span>
<span class="term-fg32">+		MuirGlacierBlock:    big.NewInt(0),</span>
<span class="term-fg32">+	},</span>
 	&quot;FrontierToHomesteadAt5&quot;: {
 		ChainID:        big.NewInt(1),
 		HomesteadBlock: big.NewInt(5),</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-29b6c8db01f4ebbb29d739f8" role="button"
                   aria-expanded="false" aria-controls="id-29b6c8db01f4ebbb29d739f8">
                    <code>tests/state_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/tests/state_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/tests/state_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-29b6c8db01f4ebbb29d739f8"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;state_test.go op-geth&#47;tests&#47;state_test.go</span>
<span class="term-fg1">index 787427f01e45f7b1a7d8fa29338fde54edf3cfd4..0cfbbe992b5363d435cfd818d1312926535bdbb6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;state_test.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;state_test.go</span>
<span class="term-fg36">@@ -222,7 +222,7 @@</span> 			}
&nbsp;
 			&#47;&#47; Prepare the EVM.
 			txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-			context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase)</span>
<span class="term-fg32">+			context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase, config, statedb)</span>
 			context.GetHash = vmTestBlockHash
 			context.BaseFee = baseFee
 			evm := vm.NewEVM(context, txContext, statedb, config, vmconfig)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-30895f64d713e1f563d3b7ad" role="button"
                   aria-expanded="false" aria-controls="id-30895f64d713e1f563d3b7ad">
                    <code>tests/state_test_util.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/tests/state_test_util.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/tests/state_test_util.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-30895f64d713e1f563d3b7ad"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;state_test_util.go op-geth&#47;tests&#47;state_test_util.go</span>
<span class="term-fg1">index 98acc468a1d8308f16c4c5a99a02870aa959a812..8e9388fbffec4cd9f2ed803ffd693c9757f039b0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;state_test_util.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;state_test_util.go</span>
<span class="term-fg36">@@ -245,7 +245,7 @@</span> 	}
&nbsp;
 	&#47;&#47; Prepare the EVM.
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase, config, statedb)</span>
 	context.GetHash = vmTestBlockHash
 	context.BaseFee = baseFee
 	context.Random = nil</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-df56a3357c28a0a82f913f3d" role="button"
                   aria-expanded="false" aria-controls="id-df56a3357c28a0a82f913f3d">
                    <code>trie/committer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/committer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/committer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+14</span></div>
                        <div class="text-start"><span class="text-danger">-32</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-df56a3357c28a0a82f913f3d"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;committer.go op-geth&#47;trie&#47;committer.go</span>
<span class="term-fg1">index c4957f3490ea3a092c4423c0f33a2b67649b3173..9f978873a8dd5c33897cd7703fa31e9487c3a323 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;committer.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;committer.go</span>
<span class="term-fg36">@@ -33,29 +33,20 @@</span> &#47;&#47; capture all dirty nodes during the commit process and keep them cached in
 &#47;&#47; insertion order.
 type committer struct {
 	nodes       *NodeSet
<span class="term-fg31">-	tracer      *tracer</span>
 	collectLeaf bool
 }
&nbsp;
 &#47;&#47; newCommitter creates a new committer or picks one from the pool.
<span class="term-fg31">-func newCommitter(owner common.Hash, tracer *tracer, collectLeaf bool) *committer {</span>
<span class="term-fg32">+func newCommitter(nodeset *NodeSet, collectLeaf bool) *committer {</span>
 	return &amp;committer{
<span class="term-fg31">-		nodes:       NewNodeSet(owner),</span>
<span class="term-fg31">-		tracer:      tracer,</span>
<span class="term-fg32">+		nodes:       nodeset,</span>
 		collectLeaf: collectLeaf,
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Commit collapses a node down into a hash node and returns it along with</span>
<span class="term-fg31">-&#47;&#47; the modified nodeset.</span>
<span class="term-fg31">-func (c *committer) Commit(n node) (hashNode, *NodeSet) {</span>
<span class="term-fg31">-	h := c.commit(nil, n)</span>
<span class="term-fg31">-	&#47;&#47; Some nodes can be deleted from trie which can&#39;t be captured</span>
<span class="term-fg31">-	&#47;&#47; by committer itself. Iterate all deleted nodes tracked by</span>
<span class="term-fg31">-	&#47;&#47; tracer and marked them as deleted only if they are present</span>
<span class="term-fg31">-	&#47;&#47; in database previously.</span>
<span class="term-fg31">-	c.tracer.markDeletions(c.nodes)</span>
<span class="term-fg31">-	return h.(hashNode), c.nodes</span>
<span class="term-fg32">+&#47;&#47; Commit collapses a node down into a hash node.</span>
<span class="term-fg32">+func (c *committer) Commit(n node) hashNode {</span>
<span class="term-fg32">+	return c.commit(nil, n).(hashNode)</span>
 }
&nbsp;
 &#47;&#47; commit collapses a node down into a hash node and returns it.
<span class="term-fg36">@@ -74,9 +65,7 @@</span>
 		&#47;&#47; If the child is fullNode, recursively commit,
 		&#47;&#47; otherwise it can only be hashNode or valueNode.
 		if _, ok := cn.Val.(*fullNode); ok {
<span class="term-fg31">-			childV := c.commit(append(path, cn.Key...), cn.Val)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-			collapsed.Val = childV</span>
<span class="term-fg32">+			collapsed.Val = c.commit(append(path, cn.Key...), cn.Val)</span>
 		}
 		&#47;&#47; The key needs to be copied, since we&#39;re adding it to the
 		&#47;&#47; modified nodeset.
<span class="term-fg36">@@ -85,12 +74,6 @@</span> 		hashedNode := c.store(path, collapsed)
 		if hn, ok := hashedNode.(hashNode); ok {
 			return hn
 		}
<span class="term-fg31">-		&#47;&#47; The short node now is embedded in its parent. Mark the node as</span>
<span class="term-fg31">-		&#47;&#47; deleted if it&#39;s present in database previously. It&#39;s equivalent</span>
<span class="term-fg31">-		&#47;&#47; as deletion from database&#39;s perspective.</span>
<span class="term-fg31">-		if prev := c.tracer.getPrev(path); len(prev) != 0 {</span>
<span class="term-fg31">-			c.nodes.markDeleted(path, prev)</span>
<span class="term-fg31">-		}</span>
 		return collapsed
 	case *fullNode:
 		hashedKids := c.commitChildren(path, cn)
<span class="term-fg36">@@ -100,12 +83,6 @@</span>
 		hashedNode := c.store(path, collapsed)
 		if hn, ok := hashedNode.(hashNode); ok {
 			return hn
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		&#47;&#47; The full node now is embedded in its parent. Mark the node as</span>
<span class="term-fg31">-		&#47;&#47; deleted if it&#39;s present in database previously. It&#39;s equivalent</span>
<span class="term-fg31">-		&#47;&#47; as deletion from database&#39;s perspective.</span>
<span class="term-fg31">-		if prev := c.tracer.getPrev(path); len(prev) != 0 {</span>
<span class="term-fg31">-			c.nodes.markDeleted(path, prev)</span>
 		}
 		return collapsed
 	case hashNode:
<span class="term-fg36">@@ -134,8 +111,7 @@</span> 		}
 		&#47;&#47; Commit the child recursively and store the &quot;hashed&quot; value.
 		&#47;&#47; Note the returned node can be some embedded nodes, so it&#39;s
 		&#47;&#47; possible the type is not hashNode.
<span class="term-fg31">-		hashed := c.commit(append(path, byte(i)), child)</span>
<span class="term-fg31">-		children[i] = hashed</span>
<span class="term-fg32">+		children[i] = c.commit(append(path, byte(i)), child)</span>
 	}
 	&#47;&#47; For the 17th child, it&#39;s possible the type is valuenode.
 	if n.Children[16] != nil {
<span class="term-fg36">@@ -155,6 +131,12 @@</span> 	&#47;&#47; In theory, we should check if the node is leaf here (embedded node
 	&#47;&#47; usually is leaf node). But small value (less than 32bytes) is not
 	&#47;&#47; our target (leaves in account trie only).
 	if hash == nil {
<span class="term-fg32">+		&#47;&#47; The node is embedded in its parent, in other words, this node</span>
<span class="term-fg32">+		&#47;&#47; will not be stored in the database independently, mark it as</span>
<span class="term-fg32">+		&#47;&#47; deleted only if the node was existent in database before.</span>
<span class="term-fg32">+		if _, ok := c.nodes.accessList[string(path)]; ok {</span>
<span class="term-fg32">+			c.nodes.markDeleted(path)</span>
<span class="term-fg32">+		}</span>
 		return n
 	}
 	&#47;&#47; We have the hash already, estimate the RLP encoding-size of the node.
<span class="term-fg36">@@ -169,7 +151,7 @@</span> 			size: uint16(size),
 		}
 	)
 	&#47;&#47; Collect the dirty node to nodeset for return.
<span class="term-fg31">-	c.nodes.markUpdated(path, mnode, c.tracer.getPrev(path))</span>
<span class="term-fg32">+	c.nodes.markUpdated(path, mnode)</span>
&nbsp;
 	&#47;&#47; Collect the corresponding leaf node if it&#39;s required. We don&#39;t check
 	&#47;&#47; full node since it&#39;s impossible to store value in fullNode. The key</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d49061453e6c445a5bdbc401" role="button"
                   aria-expanded="false" aria-controls="id-d49061453e6c445a5bdbc401">
                    <code>trie/database.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/database.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/database.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d49061453e6c445a5bdbc401"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;database.go op-geth&#47;trie&#47;database.go</span>
<span class="term-fg1">index 895ffdf89d88f37ded8adb0c15d276e51e5ce6b0..200ed3674bf332b90e24c8717e106de87c759c15 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;database.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;database.go</span>
<span class="term-fg36">@@ -792,13 +792,12 @@</span> 		order = append(order, common.Hash{})
 	}
 	for _, owner := range order {
 		subset := nodes.sets[owner]
<span class="term-fg31">-		for _, path := range subset.updates.order {</span>
<span class="term-fg31">-			n, ok := subset.updates.nodes[path]</span>
<span class="term-fg31">-			if !ok {</span>
<span class="term-fg31">-				return fmt.Errorf(&quot;missing node %x %v&quot;, owner, path)</span>
<span class="term-fg32">+		subset.forEachWithOrder(func(path string, n *memoryNode) {</span>
<span class="term-fg32">+			if n.isDeleted() {</span>
<span class="term-fg32">+				return &#47;&#47; ignore deletion</span>
 			}
 			db.insert(n.hash, int(n.size), n.node)
<span class="term-fg31">-		}</span>
<span class="term-fg32">+		})</span>
 	}
 	&#47;&#47; Link up the account trie and storage trie if the node points
 	&#47;&#47; to an account trie leaf.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f7b59b65b0b88a2086b8913f" role="button"
                   aria-expanded="false" aria-controls="id-f7b59b65b0b88a2086b8913f">
                    <code>trie/nodeset.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/nodeset.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/nodeset.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+61</span></div>
                        <div class="text-start"><span class="text-danger">-54</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f7b59b65b0b88a2086b8913f"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;nodeset.go op-geth&#47;trie&#47;nodeset.go</span>
<span class="term-fg1">index 928172350171fccc8a1cfe6d9ca74c975fbdaf59..99e4a80fa8ac267f895e9de45834c7a7027a1d50 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;nodeset.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;nodeset.go</span>
<span class="term-fg36">@@ -19,6 +19,7 @@</span>
 import (
 	&quot;fmt&quot;
 	&quot;reflect&quot;
<span class="term-fg32">+	&quot;sort&quot;</span>
 	&quot;strings&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -40,8 +41,8 @@</span> var memoryNodeSize = int(reflect.TypeOf(memoryNode{}).Size())
&nbsp;
 &#47;&#47; memorySize returns the total memory size used by this node.
 &#47;&#47; nolint:unused
<span class="term-fg31">-func (n *memoryNode) memorySize(key int) int {</span>
<span class="term-fg31">-	return int(n.size) + memoryNodeSize + key</span>
<span class="term-fg32">+func (n *memoryNode) memorySize(pathlen int) int {</span>
<span class="term-fg32">+	return int(n.size) + memoryNodeSize + pathlen</span>
 }
&nbsp;
 &#47;&#47; rlp returns the raw rlp encoded blob of the cached trie node, either directly
<span class="term-fg36">@@ -64,7 +65,13 @@</span> 	}
 	return expandNode(n.hash[:], n.node)
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; isDeleted returns the indicator if the node is marked as deleted.</span>
<span class="term-fg32">+func (n *memoryNode) isDeleted() bool {</span>
<span class="term-fg32">+	return n.hash == (common.Hash{})</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; nodeWithPrev wraps the memoryNode with the previous node value.
<span class="term-fg32">+&#47;&#47; nolint: unused</span>
 type nodeWithPrev struct {
 	*memoryNode
 	prev []byte &#47;&#47; RLP-encoded previous value, nil means it&#39;s non-existent
<span class="term-fg36">@@ -79,64 +86,60 @@</span>
 &#47;&#47; memorySize returns the total memory size used by this node. It overloads
 &#47;&#47; the function in memoryNode by counting the size of previous value as well.
 &#47;&#47; nolint: unused
<span class="term-fg31">-func (n *nodeWithPrev) memorySize(key int) int {</span>
<span class="term-fg31">-	return n.memoryNode.memorySize(key) + len(n.prev)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; nodesWithOrder represents a collection of dirty nodes which includes</span>
<span class="term-fg31">-&#47;&#47; newly-inserted and updated nodes. The modification order of all nodes</span>
<span class="term-fg31">-&#47;&#47; is represented by order list.</span>
<span class="term-fg31">-type nodesWithOrder struct {</span>
<span class="term-fg31">-	order []string                 &#47;&#47; the path list of dirty nodes, sort by insertion order</span>
<span class="term-fg31">-	nodes map[string]*nodeWithPrev &#47;&#47; the map of dirty nodes, keyed by node path</span>
<span class="term-fg32">+func (n *nodeWithPrev) memorySize(pathlen int) int {</span>
<span class="term-fg32">+	return n.memoryNode.memorySize(pathlen) + len(n.prev)</span>
 }
&nbsp;
 &#47;&#47; NodeSet contains all dirty nodes collected during the commit operation.
 &#47;&#47; Each node is keyed by path. It&#39;s not thread-safe to use.
 type NodeSet struct {
<span class="term-fg31">-	owner   common.Hash       &#47;&#47; the identifier of the trie</span>
<span class="term-fg31">-	updates *nodesWithOrder   &#47;&#47; the set of updated nodes(newly inserted, updated)</span>
<span class="term-fg31">-	deletes map[string][]byte &#47;&#47; the map of deleted nodes, keyed by node</span>
<span class="term-fg31">-	leaves  []*leaf           &#47;&#47; the list of dirty leaves</span>
<span class="term-fg32">+	owner   common.Hash            &#47;&#47; the identifier of the trie</span>
<span class="term-fg32">+	nodes   map[string]*memoryNode &#47;&#47; the set of dirty nodes(inserted, updated, deleted)</span>
<span class="term-fg32">+	leaves  []*leaf                &#47;&#47; the list of dirty leaves</span>
<span class="term-fg32">+	updates int                    &#47;&#47; the count of updated and inserted nodes</span>
<span class="term-fg32">+	deletes int                    &#47;&#47; the count of deleted nodes</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; The list of accessed nodes, which records the original node value.</span>
<span class="term-fg32">+	&#47;&#47; The origin value is expected to be nil for newly inserted node</span>
<span class="term-fg32">+	&#47;&#47; and is expected to be non-nil for other types(updated, deleted).</span>
<span class="term-fg32">+	accessList map[string][]byte</span>
 }
&nbsp;
 &#47;&#47; NewNodeSet initializes an empty node set to be used for tracking dirty nodes
 &#47;&#47; from a specific account or storage trie. The owner is zero for the account
 &#47;&#47; trie and the owning account address hash for storage tries.
<span class="term-fg31">-func NewNodeSet(owner common.Hash) *NodeSet {</span>
<span class="term-fg32">+func NewNodeSet(owner common.Hash, accessList map[string][]byte) *NodeSet {</span>
 	return &amp;NodeSet{
<span class="term-fg31">-		owner: owner,</span>
<span class="term-fg31">-		updates: &amp;nodesWithOrder{</span>
<span class="term-fg31">-			nodes: make(map[string]*nodeWithPrev),</span>
<span class="term-fg31">-		},</span>
<span class="term-fg31">-		deletes: make(map[string][]byte),</span>
<span class="term-fg32">+		owner:      owner,</span>
<span class="term-fg32">+		nodes:      make(map[string]*memoryNode),</span>
<span class="term-fg32">+		accessList: accessList,</span>
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;*</span>
<span class="term-fg31">-&#47;&#47; NewNodeSetWithDeletion initializes the nodeset with provided deletion set.</span>
<span class="term-fg31">-func NewNodeSetWithDeletion(owner common.Hash, paths [][]byte, prev [][]byte) *NodeSet {</span>
<span class="term-fg31">-	set := NewNodeSet(owner)</span>
<span class="term-fg31">-	for i, path := range paths {</span>
<span class="term-fg31">-		set.markDeleted(path, prev[i])</span>
<span class="term-fg32">+&#47;&#47; forEachWithOrder iterates the dirty nodes with the order from bottom to top,</span>
<span class="term-fg32">+&#47;&#47; right to left, nodes with the longest path will be iterated first.</span>
<span class="term-fg32">+func (set *NodeSet) forEachWithOrder(callback func(path string, n *memoryNode)) {</span>
<span class="term-fg32">+	var paths sort.StringSlice</span>
<span class="term-fg32">+	for path := range set.nodes {</span>
<span class="term-fg32">+		paths = append(paths, path)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Bottom-up, longest path first</span>
<span class="term-fg32">+	sort.Sort(sort.Reverse(paths))</span>
<span class="term-fg32">+	for _, path := range paths {</span>
<span class="term-fg32">+		callback(path, set.nodes[path])</span>
 	}
<span class="term-fg31">-	return set</span>
 }
<span class="term-fg31">-*&#47;</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; markUpdated marks the node as dirty(newly-inserted or updated) with provided</span>
<span class="term-fg31">-&#47;&#47; node path, node object along with its previous value.</span>
<span class="term-fg31">-func (set *NodeSet) markUpdated(path []byte, node *memoryNode, prev []byte) {</span>
<span class="term-fg31">-	set.updates.order = append(set.updates.order, string(path))</span>
<span class="term-fg31">-	set.updates.nodes[string(path)] = &amp;nodeWithPrev{</span>
<span class="term-fg31">-		memoryNode: node,</span>
<span class="term-fg31">-		prev:       prev,</span>
<span class="term-fg31">-	}</span>
<span class="term-fg32">+&#47;&#47; markUpdated marks the node as dirty(newly-inserted or updated).</span>
<span class="term-fg32">+func (set *NodeSet) markUpdated(path []byte, node *memoryNode) {</span>
<span class="term-fg32">+	set.nodes[string(path)] = node</span>
<span class="term-fg32">+	set.updates += 1</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; markDeleted marks the node as deleted with provided path and previous value.</span>
<span class="term-fg31">-func (set *NodeSet) markDeleted(path []byte, prev []byte) {</span>
<span class="term-fg31">-	set.deletes[string(path)] = prev</span>
<span class="term-fg32">+&#47;&#47; markDeleted marks the node as deleted.</span>
<span class="term-fg32">+func (set *NodeSet) markDeleted(path []byte) {</span>
<span class="term-fg32">+	set.nodes[string(path)] = &amp;memoryNode{}</span>
<span class="term-fg32">+	set.deletes += 1</span>
 }
&nbsp;
 &#47;&#47; addLeaf collects the provided leaf node into set.
<span class="term-fg36">@@ -144,16 +147,16 @@</span> func (set *NodeSet) addLeaf(node *leaf) {
 	set.leaves = append(set.leaves, node)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Size returns the number of updated and deleted nodes contained in the set.</span>
<span class="term-fg32">+&#47;&#47; Size returns the number of dirty nodes in set.</span>
 func (set *NodeSet) Size() (int, int) {
<span class="term-fg31">-	return len(set.updates.order), len(set.deletes)</span>
<span class="term-fg32">+	return set.updates, set.deletes</span>
 }
&nbsp;
 &#47;&#47; Hashes returns the hashes of all updated nodes. TODO(rjl493456442) how can
 &#47;&#47; we get rid of it?
 func (set *NodeSet) Hashes() []common.Hash {
 	var ret []common.Hash
<span class="term-fg31">-	for _, node := range set.updates.nodes {</span>
<span class="term-fg32">+	for _, node := range set.nodes {</span>
 		ret = append(ret, node.hash)
 	}
 	return ret
<span class="term-fg36">@@ -163,18 +166,22 @@</span> &#47;&#47; Summary returns a string-representation of the NodeSet.
 func (set *NodeSet) Summary() string {
 	var out = new(strings.Builder)
 	fmt.Fprintf(out, &quot;nodeset owner: %v\n&quot;, set.owner)
<span class="term-fg31">-	if set.updates != nil {</span>
<span class="term-fg31">-		for _, key := range set.updates.order {</span>
<span class="term-fg31">-			updated := set.updates.nodes[key]</span>
<span class="term-fg31">-			if updated.prev != nil {</span>
<span class="term-fg31">-				fmt.Fprintf(out, &quot;  [*]: %x -&gt; %v prev: %x\n&quot;, key, updated.hash, updated.prev)</span>
<span class="term-fg31">-			} else {</span>
<span class="term-fg31">-				fmt.Fprintf(out, &quot;  [+]: %x -&gt; %v\n&quot;, key, updated.hash)</span>
<span class="term-fg32">+	if set.nodes != nil {</span>
<span class="term-fg32">+		for path, n := range set.nodes {</span>
<span class="term-fg32">+			&#47;&#47; Deletion</span>
<span class="term-fg32">+			if n.isDeleted() {</span>
<span class="term-fg32">+				fmt.Fprintf(out, &quot;  [-]: %x prev: %x\n&quot;, path, set.accessList[path])</span>
<span class="term-fg32">+				continue</span>
 			}
<span class="term-fg32">+			&#47;&#47; Insertion</span>
<span class="term-fg32">+			origin, ok := set.accessList[path]</span>
<span class="term-fg32">+			if !ok {</span>
<span class="term-fg32">+				fmt.Fprintf(out, &quot;  [+]: %x -&gt; %v\n&quot;, path, n.hash)</span>
<span class="term-fg32">+				continue</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			&#47;&#47; Update</span>
<span class="term-fg32">+			fmt.Fprintf(out, &quot;  [*]: %x -&gt; %v prev: %x\n&quot;, path, n.hash, origin)</span>
 		}
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for k, n := range set.deletes {</span>
<span class="term-fg31">-		fmt.Fprintf(out, &quot;  [-]: %x -&gt; %x\n&quot;, k, n)</span>
 	}
 	for _, n := range set.leaves {
 		fmt.Fprintf(out, &quot;[leaf]: %v\n&quot;, n)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-59ba04e59e3fe095db492972" role="button"
                   aria-expanded="false" aria-controls="id-59ba04e59e3fe095db492972">
                    <code>trie/proof.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/proof.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/proof.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-59ba04e59e3fe095db492972"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;proof.go op-geth&#47;trie&#47;proof.go</span>
<span class="term-fg1">index af49ce36b36cdee09aa0e593be5a20f94f8207cb..f11dfc47afabd9c53dd0033aa6f5d0f5a75d6c1a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;proof.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;proof.go</span>
<span class="term-fg36">@@ -563,7 +563,7 @@</span> 		return false, err
 	}
 	&#47;&#47; Rebuild the trie with the leaf stream, the shape of trie
 	&#47;&#47; should be same with the original one.
<span class="term-fg31">-	tr := &amp;Trie{root: root, reader: newEmptyReader()}</span>
<span class="term-fg32">+	tr := &amp;Trie{root: root, reader: newEmptyReader(), tracer: newTracer()}</span>
 	if empty {
 		tr.root = nil
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ed47f7c25adb4582fac1d501" role="button"
                   aria-expanded="false" aria-controls="id-ed47f7c25adb4582fac1d501">
                    <code>trie/proof_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/proof_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/proof_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ed47f7c25adb4582fac1d501"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;proof_test.go op-geth&#47;trie&#47;proof_test.go</span>
<span class="term-fg1">index 5796a308930e8c0d00bbec6c6bcf442f28f208ee..6b23bcdb27d8bca62dd56e0b821b234a85f6352b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;proof_test.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;proof_test.go</span>
<span class="term-fg36">@@ -20,6 +20,7 @@</span> import (
 	&quot;bytes&quot;
 	crand &quot;crypto&#47;rand&quot;
 	&quot;encoding&#47;binary&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	mrand &quot;math&#47;rand&quot;
 	&quot;sort&quot;
 	&quot;testing&quot;
<span class="term-fg36">@@ -29,6 +30,24 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&#47;memorydb&quot;
 )
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Prng is a pseudo random number generator seeded by strong randomness.</span>
<span class="term-fg32">+&#47;&#47; The randomness is printed on startup in order to make failures reproducible.</span>
<span class="term-fg32">+var prng = initRnd()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func initRnd() *mrand.Rand {</span>
<span class="term-fg32">+	var seed [8]byte</span>
<span class="term-fg32">+	crand.Read(seed[:])</span>
<span class="term-fg32">+	rnd := mrand.New(mrand.NewSource(int64(binary.LittleEndian.Uint64(seed[:]))))</span>
<span class="term-fg32">+	fmt.Printf(&quot;Seed: %x\n&quot;, seed)</span>
<span class="term-fg32">+	return rnd</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func randBytes(n int) []byte {</span>
<span class="term-fg32">+	r := make([]byte, n)</span>
<span class="term-fg32">+	prng.Read(r)</span>
<span class="term-fg32">+	return r</span>
<span class="term-fg32">+}</span>
&nbsp;
 &#47;&#47; makeProvers creates Merkle trie provers based on different implementations to
 &#47;&#47; test all variations.
<span class="term-fg36">@@ -1039,12 +1058,6 @@</span> 		trie.Update(value.k, value.v)
 		vals[string(value.k)] = value
 	}
 	return trie, vals
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func randBytes(n int) []byte {</span>
<span class="term-fg31">-	r := make([]byte, n)</span>
<span class="term-fg31">-	crand.Read(r)</span>
<span class="term-fg31">-	return r</span>
 }
&nbsp;
 func nonRandomTrie(n int) (*Trie, map[string]*kv) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-32afd6ae5a810400b37b8d7d" role="button"
                   aria-expanded="false" aria-controls="id-32afd6ae5a810400b37b8d7d">
                    <code>trie/stacktrie.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/stacktrie.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/stacktrie.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-32afd6ae5a810400b37b8d7d"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;stacktrie.go op-geth&#47;trie&#47;stacktrie.go</span>
<span class="term-fg1">index e7b3171af6e8a7432c792ed79a9c438d86c13cc0..83034e29a530c66fa60b3ff8c1b8b5b0b75baa6e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;stacktrie.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;stacktrie.go</span>
<span class="term-fg36">@@ -144,7 +144,9 @@</span> 		NodeType uint8
 		Val      []byte
 		Key      []byte
 	}
<span class="term-fg31">-	gob.NewDecoder(r).Decode(&amp;dec)</span>
<span class="term-fg32">+	if err := gob.NewDecoder(r).Decode(&amp;dec); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
 	st.owner = dec.Owner
 	st.nodeType = dec.NodeType
 	st.val = dec.Val
<span class="term-fg36">@@ -158,7 +160,9 @@</span> 		} else if hasChild[0] == 0 {
 			continue
 		}
 		var child StackTrie
<span class="term-fg31">-		child.unmarshalBinary(r)</span>
<span class="term-fg32">+		if err := child.unmarshalBinary(r); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
 		st.children[i] = &amp;child
 	}
 	return nil</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9bec67d0b3b13b70dc24254a" role="button"
                   aria-expanded="false" aria-controls="id-9bec67d0b3b13b70dc24254a">
                    <code>trie/sync_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/sync_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/sync_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9bec67d0b3b13b70dc24254a"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;sync_test.go op-geth&#47;trie&#47;sync_test.go</span>
<span class="term-fg1">index fc871a22c80a12bf54634922fb39558746df8091..8fec378333da80ae9d7083632ccbbd30e9833b52 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;sync_test.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;sync_test.go</span>
<span class="term-fg36">@@ -434,6 +434,7 @@</span>
 &#47;&#47; Tests that at any point in time during a sync, only complete sub-tries are in
 &#47;&#47; the database.
 func TestIncompleteSync(t *testing.T) {
<span class="term-fg32">+	t.Parallel()</span>
 	&#47;&#47; Create a random trie to copy
 	srcDb, srcTrie, _ := makeTestTrie()
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-13a6c0ebcfe092df6d291803" role="button"
                   aria-expanded="false" aria-controls="id-13a6c0ebcfe092df6d291803">
                    <code>trie/tracer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/tracer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+125</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-13a6c0ebcfe092df6d291803"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;tracer.go op-geth&#47;trie&#47;tracer.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..a27e371c7acbe3da3a6212f5eaa63c1d90bc44e0</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;tracer.go</span>
<span class="term-fg36">@@ -0,0 +1,125 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2022 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package trie</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import &quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; tracer tracks the changes of trie nodes. During the trie operations,</span>
<span class="term-fg32">+&#47;&#47; some nodes can be deleted from the trie, while these deleted nodes</span>
<span class="term-fg32">+&#47;&#47; won&#39;t be captured by trie.Hasher or trie.Committer. Thus, these deleted</span>
<span class="term-fg32">+&#47;&#47; nodes won&#39;t be removed from the disk at all. Tracer is an auxiliary tool</span>
<span class="term-fg32">+&#47;&#47; used to track all insert and delete operations of trie and capture all</span>
<span class="term-fg32">+&#47;&#47; deleted nodes eventually.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The changed nodes can be mainly divided into two categories: the leaf</span>
<span class="term-fg32">+&#47;&#47; node and intermediate node. The former is inserted&#47;deleted by callers</span>
<span class="term-fg32">+&#47;&#47; while the latter is inserted&#47;deleted in order to follow the rule of trie.</span>
<span class="term-fg32">+&#47;&#47; This tool can track all of them no matter the node is embedded in its</span>
<span class="term-fg32">+&#47;&#47; parent or not, but valueNode is never tracked.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Besides, it&#39;s also used for recording the original value of the nodes</span>
<span class="term-fg32">+&#47;&#47; when they are resolved from the disk. The pre-value of the nodes will</span>
<span class="term-fg32">+&#47;&#47; be used to construct trie history in the future.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Note tracer is not thread-safe, callers should be responsible for handling</span>
<span class="term-fg32">+&#47;&#47; the concurrency issues by themselves.</span>
<span class="term-fg32">+type tracer struct {</span>
<span class="term-fg32">+	inserts    map[string]struct{}</span>
<span class="term-fg32">+	deletes    map[string]struct{}</span>
<span class="term-fg32">+	accessList map[string][]byte</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; newTracer initializes the tracer for capturing trie changes.</span>
<span class="term-fg32">+func newTracer() *tracer {</span>
<span class="term-fg32">+	return &amp;tracer{</span>
<span class="term-fg32">+		inserts:    make(map[string]struct{}),</span>
<span class="term-fg32">+		deletes:    make(map[string]struct{}),</span>
<span class="term-fg32">+		accessList: make(map[string][]byte),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; onRead tracks the newly loaded trie node and caches the rlp-encoded</span>
<span class="term-fg32">+&#47;&#47; blob internally. Don&#39;t change the value outside of function since</span>
<span class="term-fg32">+&#47;&#47; it&#39;s not deep-copied.</span>
<span class="term-fg32">+func (t *tracer) onRead(path []byte, val []byte) {</span>
<span class="term-fg32">+	t.accessList[string(path)] = val</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; onInsert tracks the newly inserted trie node. If it&#39;s already</span>
<span class="term-fg32">+&#47;&#47; in the deletion set (resurrected node), then just wipe it from</span>
<span class="term-fg32">+&#47;&#47; the deletion set as it&#39;s &quot;untouched&quot;.</span>
<span class="term-fg32">+func (t *tracer) onInsert(path []byte) {</span>
<span class="term-fg32">+	if _, present := t.deletes[string(path)]; present {</span>
<span class="term-fg32">+		delete(t.deletes, string(path))</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	t.inserts[string(path)] = struct{}{}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; onDelete tracks the newly deleted trie node. If it&#39;s already</span>
<span class="term-fg32">+&#47;&#47; in the addition set, then just wipe it from the addition set</span>
<span class="term-fg32">+&#47;&#47; as it&#39;s untouched.</span>
<span class="term-fg32">+func (t *tracer) onDelete(path []byte) {</span>
<span class="term-fg32">+	if _, present := t.inserts[string(path)]; present {</span>
<span class="term-fg32">+		delete(t.inserts, string(path))</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	t.deletes[string(path)] = struct{}{}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; reset clears the content tracked by tracer.</span>
<span class="term-fg32">+func (t *tracer) reset() {</span>
<span class="term-fg32">+	t.inserts = make(map[string]struct{})</span>
<span class="term-fg32">+	t.deletes = make(map[string]struct{})</span>
<span class="term-fg32">+	t.accessList = make(map[string][]byte)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; copy returns a deep copied tracer instance.</span>
<span class="term-fg32">+func (t *tracer) copy() *tracer {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		inserts    = make(map[string]struct{})</span>
<span class="term-fg32">+		deletes    = make(map[string]struct{})</span>
<span class="term-fg32">+		accessList = make(map[string][]byte)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	for path := range t.inserts {</span>
<span class="term-fg32">+		inserts[path] = struct{}{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for path := range t.deletes {</span>
<span class="term-fg32">+		deletes[path] = struct{}{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for path, blob := range t.accessList {</span>
<span class="term-fg32">+		accessList[path] = common.CopyBytes(blob)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return &amp;tracer{</span>
<span class="term-fg32">+		inserts:    inserts,</span>
<span class="term-fg32">+		deletes:    deletes,</span>
<span class="term-fg32">+		accessList: accessList,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; markDeletions puts all tracked deletions into the provided nodeset.</span>
<span class="term-fg32">+func (t *tracer) markDeletions(set *NodeSet) {</span>
<span class="term-fg32">+	for path := range t.deletes {</span>
<span class="term-fg32">+		&#47;&#47; It&#39;s possible a few deleted nodes were embedded</span>
<span class="term-fg32">+		&#47;&#47; in their parent before, the deletions can be no</span>
<span class="term-fg32">+		&#47;&#47; effect by deleting nothing, filter them out.</span>
<span class="term-fg32">+		if _, ok := set.accessList[path]; !ok {</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		set.markDeleted([]byte(path))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4227213905c587637ca762fd" role="button"
                   aria-expanded="false" aria-controls="id-4227213905c587637ca762fd">
                    <code>trie/tracer_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/tracer_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+368</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4227213905c587637ca762fd"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;tracer_test.go op-geth&#47;trie&#47;tracer_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..5e627c89c9be432c21292476ca83bb5e15c05f76</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;tracer_test.go</span>
<span class="term-fg36">@@ -0,0 +1,368 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2022 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package trie</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;bytes&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	tiny = []struct{ k, v string }{</span>
<span class="term-fg32">+		{&quot;k1&quot;, &quot;v1&quot;},</span>
<span class="term-fg32">+		{&quot;k2&quot;, &quot;v2&quot;},</span>
<span class="term-fg32">+		{&quot;k3&quot;, &quot;v3&quot;},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonAligned = []struct{ k, v string }{</span>
<span class="term-fg32">+		{&quot;do&quot;, &quot;verb&quot;},</span>
<span class="term-fg32">+		{&quot;ether&quot;, &quot;wookiedoo&quot;},</span>
<span class="term-fg32">+		{&quot;horse&quot;, &quot;stallion&quot;},</span>
<span class="term-fg32">+		{&quot;shaman&quot;, &quot;horse&quot;},</span>
<span class="term-fg32">+		{&quot;doge&quot;, &quot;coin&quot;},</span>
<span class="term-fg32">+		{&quot;dog&quot;, &quot;puppy&quot;},</span>
<span class="term-fg32">+		{&quot;somethingveryoddindeedthis is&quot;, &quot;myothernodedata&quot;},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	standard = []struct{ k, v string }{</span>
<span class="term-fg32">+		{string(randBytes(32)), &quot;verb&quot;},</span>
<span class="term-fg32">+		{string(randBytes(32)), &quot;wookiedoo&quot;},</span>
<span class="term-fg32">+		{string(randBytes(32)), &quot;stallion&quot;},</span>
<span class="term-fg32">+		{string(randBytes(32)), &quot;horse&quot;},</span>
<span class="term-fg32">+		{string(randBytes(32)), &quot;coin&quot;},</span>
<span class="term-fg32">+		{string(randBytes(32)), &quot;puppy&quot;},</span>
<span class="term-fg32">+		{string(randBytes(32)), &quot;myothernodedata&quot;},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTrieTracer(t *testing.T) {</span>
<span class="term-fg32">+	testTrieTracer(t, tiny)</span>
<span class="term-fg32">+	testTrieTracer(t, nonAligned)</span>
<span class="term-fg32">+	testTrieTracer(t, standard)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Tests if the trie diffs are tracked correctly. Tracer should capture</span>
<span class="term-fg32">+&#47;&#47; all non-leaf dirty nodes, no matter the node is embedded or not.</span>
<span class="term-fg32">+func testTrieTracer(t *testing.T, vals []struct{ k, v string }) {</span>
<span class="term-fg32">+	db := NewDatabase(rawdb.NewMemoryDatabase())</span>
<span class="term-fg32">+	trie := NewEmpty(db)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Determine all new nodes are tracked</span>
<span class="term-fg32">+	for _, val := range vals {</span>
<span class="term-fg32">+		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	insertSet := copySet(trie.tracer.inserts) &#47;&#47; copy before commit</span>
<span class="term-fg32">+	deleteSet := copySet(trie.tracer.deletes) &#47;&#47; copy before commit</span>
<span class="term-fg32">+	root, nodes := trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(nodes))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	seen := setKeys(iterNodes(db, root))</span>
<span class="term-fg32">+	if !compareSet(insertSet, seen) {</span>
<span class="term-fg32">+		t.Fatal(&quot;Unexpected insertion set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if !compareSet(deleteSet, nil) {</span>
<span class="term-fg32">+		t.Fatal(&quot;Unexpected deletion set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Determine all deletions are tracked</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	for _, val := range vals {</span>
<span class="term-fg32">+		trie.Delete([]byte(val.k))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	insertSet, deleteSet = copySet(trie.tracer.inserts), copySet(trie.tracer.deletes)</span>
<span class="term-fg32">+	if !compareSet(insertSet, nil) {</span>
<span class="term-fg32">+		t.Fatal(&quot;Unexpected insertion set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if !compareSet(deleteSet, seen) {</span>
<span class="term-fg32">+		t.Fatal(&quot;Unexpected deletion set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Test that after inserting a new batch of nodes and deleting them immediately,</span>
<span class="term-fg32">+&#47;&#47; the trie tracer should be cleared normally as no operation happened.</span>
<span class="term-fg32">+func TestTrieTracerNoop(t *testing.T) {</span>
<span class="term-fg32">+	testTrieTracerNoop(t, tiny)</span>
<span class="term-fg32">+	testTrieTracerNoop(t, nonAligned)</span>
<span class="term-fg32">+	testTrieTracerNoop(t, standard)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testTrieTracerNoop(t *testing.T, vals []struct{ k, v string }) {</span>
<span class="term-fg32">+	trie := NewEmpty(NewDatabase(rawdb.NewMemoryDatabase()))</span>
<span class="term-fg32">+	for _, val := range vals {</span>
<span class="term-fg32">+		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, val := range vals {</span>
<span class="term-fg32">+		trie.Delete([]byte(val.k))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if len(trie.tracer.inserts) != 0 {</span>
<span class="term-fg32">+		t.Fatal(&quot;Unexpected insertion set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if len(trie.tracer.deletes) != 0 {</span>
<span class="term-fg32">+		t.Fatal(&quot;Unexpected deletion set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Tests if the accessList is correctly tracked.</span>
<span class="term-fg32">+func TestAccessList(t *testing.T) {</span>
<span class="term-fg32">+	testAccessList(t, tiny)</span>
<span class="term-fg32">+	testAccessList(t, nonAligned)</span>
<span class="term-fg32">+	testAccessList(t, standard)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testAccessList(t *testing.T, vals []struct{ k, v string }) {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		db   = NewDatabase(rawdb.NewMemoryDatabase())</span>
<span class="term-fg32">+		trie = NewEmpty(db)</span>
<span class="term-fg32">+		orig = trie.Copy()</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	&#47;&#47; Create trie from scratch</span>
<span class="term-fg32">+	for _, val := range vals {</span>
<span class="term-fg32">+		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	root, nodes := trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(nodes))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	if err := verifyAccessList(orig, trie, nodes); err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;Invalid accessList %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Update trie</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	orig = trie.Copy()</span>
<span class="term-fg32">+	for _, val := range vals {</span>
<span class="term-fg32">+		trie.Update([]byte(val.k), randBytes(32))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	root, nodes = trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(nodes))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	if err := verifyAccessList(orig, trie, nodes); err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;Invalid accessList %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Add more new nodes</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	orig = trie.Copy()</span>
<span class="term-fg32">+	var keys []string</span>
<span class="term-fg32">+	for i := 0; i &lt; 30; i++ {</span>
<span class="term-fg32">+		key := randBytes(32)</span>
<span class="term-fg32">+		keys = append(keys, string(key))</span>
<span class="term-fg32">+		trie.Update(key, randBytes(32))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	root, nodes = trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(nodes))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	if err := verifyAccessList(orig, trie, nodes); err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;Invalid accessList %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Partial deletions</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	orig = trie.Copy()</span>
<span class="term-fg32">+	for _, key := range keys {</span>
<span class="term-fg32">+		trie.Update([]byte(key), nil)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	root, nodes = trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(nodes))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	if err := verifyAccessList(orig, trie, nodes); err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;Invalid accessList %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Delete all</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	orig = trie.Copy()</span>
<span class="term-fg32">+	for _, val := range vals {</span>
<span class="term-fg32">+		trie.Update([]byte(val.k), nil)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	root, nodes = trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(nodes))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	if err := verifyAccessList(orig, trie, nodes); err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;Invalid accessList %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Tests origin values won&#39;t be tracked in Iterator or Prover</span>
<span class="term-fg32">+func TestAccessListLeak(t *testing.T) {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		db   = NewDatabase(rawdb.NewMemoryDatabase())</span>
<span class="term-fg32">+		trie = NewEmpty(db)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	&#47;&#47; Create trie from scratch</span>
<span class="term-fg32">+	for _, val := range standard {</span>
<span class="term-fg32">+		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	root, nodes := trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(nodes))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var cases = []struct {</span>
<span class="term-fg32">+		op func(tr *Trie)</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			func(tr *Trie) {</span>
<span class="term-fg32">+				it := tr.NodeIterator(nil)</span>
<span class="term-fg32">+				for it.Next(true) {</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			func(tr *Trie) {</span>
<span class="term-fg32">+				it := NewIterator(tr.NodeIterator(nil))</span>
<span class="term-fg32">+				for it.Next() {</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			func(tr *Trie) {</span>
<span class="term-fg32">+				for _, val := range standard {</span>
<span class="term-fg32">+					tr.Prove([]byte(val.k), 0, rawdb.NewMemoryDatabase())</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, c := range cases {</span>
<span class="term-fg32">+		trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+		n1 := len(trie.tracer.accessList)</span>
<span class="term-fg32">+		c.op(trie)</span>
<span class="term-fg32">+		n2 := len(trie.tracer.accessList)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		if n1 != n2 {</span>
<span class="term-fg32">+			t.Fatalf(&quot;AccessList is leaked, prev %d after %d&quot;, n1, n2)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Tests whether the original tree node is correctly deleted after being embedded</span>
<span class="term-fg32">+&#47;&#47; in its parent due to the smaller size of the original tree node.</span>
<span class="term-fg32">+func TestTinyTree(t *testing.T) {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		db   = NewDatabase(rawdb.NewMemoryDatabase())</span>
<span class="term-fg32">+		trie = NewEmpty(db)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	for _, val := range tiny {</span>
<span class="term-fg32">+		trie.Update([]byte(val.k), randBytes(32))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	root, set := trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(set))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	orig := trie.Copy()</span>
<span class="term-fg32">+	for _, val := range tiny {</span>
<span class="term-fg32">+		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	root, set = trie.Commit(false)</span>
<span class="term-fg32">+	db.Update(NewWithNodeSet(set))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg32">+	if err := verifyAccessList(orig, trie, set); err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;Invalid accessList %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func compareSet(setA, setB map[string]struct{}) bool {</span>
<span class="term-fg32">+	if len(setA) != len(setB) {</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for key := range setA {</span>
<span class="term-fg32">+		if _, ok := setB[key]; !ok {</span>
<span class="term-fg32">+			return false</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return true</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func forNodes(tr *Trie) map[string][]byte {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		it    = tr.NodeIterator(nil)</span>
<span class="term-fg32">+		nodes = make(map[string][]byte)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	for it.Next(true) {</span>
<span class="term-fg32">+		if it.Leaf() {</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		nodes[string(it.Path())] = common.CopyBytes(it.NodeBlob())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nodes</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func iterNodes(db *Database, root common.Hash) map[string][]byte {</span>
<span class="term-fg32">+	tr, _ := New(TrieID(root), db)</span>
<span class="term-fg32">+	return forNodes(tr)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func forHashedNodes(tr *Trie) map[string][]byte {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		it    = tr.NodeIterator(nil)</span>
<span class="term-fg32">+		nodes = make(map[string][]byte)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	for it.Next(true) {</span>
<span class="term-fg32">+		if it.Hash() == (common.Hash{}) {</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		nodes[string(it.Path())] = common.CopyBytes(it.NodeBlob())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nodes</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func diffTries(trieA, trieB *Trie) (map[string][]byte, map[string][]byte, map[string][]byte) {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		nodesA = forHashedNodes(trieA)</span>
<span class="term-fg32">+		nodesB = forHashedNodes(trieB)</span>
<span class="term-fg32">+		inA    = make(map[string][]byte) &#47;&#47; hashed nodes in trie a but not b</span>
<span class="term-fg32">+		inB    = make(map[string][]byte) &#47;&#47; hashed nodes in trie b but not a</span>
<span class="term-fg32">+		both   = make(map[string][]byte) &#47;&#47; hashed nodes in both tries but different value</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	for path, blobA := range nodesA {</span>
<span class="term-fg32">+		if blobB, ok := nodesB[path]; ok {</span>
<span class="term-fg32">+			if bytes.Equal(blobA, blobB) {</span>
<span class="term-fg32">+				continue</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			both[path] = blobA</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		inA[path] = blobA</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for path, blobB := range nodesB {</span>
<span class="term-fg32">+		if _, ok := nodesA[path]; ok {</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		inB[path] = blobB</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return inA, inB, both</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func setKeys(set map[string][]byte) map[string]struct{} {</span>
<span class="term-fg32">+	keys := make(map[string]struct{})</span>
<span class="term-fg32">+	for k := range set {</span>
<span class="term-fg32">+		keys[k] = struct{}{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return keys</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func copySet(set map[string]struct{}) map[string]struct{} {</span>
<span class="term-fg32">+	copied := make(map[string]struct{})</span>
<span class="term-fg32">+	for k := range set {</span>
<span class="term-fg32">+		copied[k] = struct{}{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return copied</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-078acef1f2f7c62b606d4832" role="button"
                   aria-expanded="false" aria-controls="id-078acef1f2f7c62b606d4832">
                    <code>trie/trie.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/trie.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/trie.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+14</span></div>
                        <div class="text-start"><span class="text-danger">-14</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-078acef1f2f7c62b606d4832"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;trie.go op-geth&#47;trie&#47;trie.go</span>
<span class="term-fg1">index cf9108f1077ba5b446200098f03eee56d377a355..17bacba00fdc02d4e003221c1042b04d53c2b4b4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;trie.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;trie.go</span>
<span class="term-fg36">@@ -81,7 +81,7 @@</span> 	}
 	trie := &amp;Trie{
 		owner:  id.Owner,
 		reader: reader,
<span class="term-fg31">-		&#47;&#47;tracer: newTracer(),</span>
<span class="term-fg32">+		tracer: newTracer(),</span>
 	}
 	if id.Root != (common.Hash{}) &amp;&amp; id.Root != types.EmptyRootHash {
 		rootnode, err := trie.resolveAndTrack(id.Root[:], nil)
<span class="term-fg36">@@ -547,7 +547,7 @@</span>
 &#47;&#47; Hash returns the root hash of the trie. It does not write to the
 &#47;&#47; database and can be used even if the trie doesn&#39;t have one.
 func (t *Trie) Hash() common.Hash {
<span class="term-fg31">-	hash, cached, _ := t.hashRoot()</span>
<span class="term-fg32">+	hash, cached := t.hashRoot()</span>
 	t.root = cached
 	return common.BytesToHash(hash.(hashNode))
 }
<span class="term-fg36">@@ -561,14 +561,14 @@</span> &#47;&#47; be created with new root and updated trie database for following usage
 func (t *Trie) Commit(collectLeaf bool) (common.Hash, *NodeSet) {
 	defer t.tracer.reset()
&nbsp;
<span class="term-fg32">+	nodes := NewNodeSet(t.owner, t.tracer.accessList)</span>
<span class="term-fg32">+	t.tracer.markDeletions(nodes)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Trie is empty and can be classified into two types of situations:
 	&#47;&#47; - The trie was empty and no update happens
 	&#47;&#47; - The trie was non-empty and all nodes are dropped
 	if t.root == nil {
<span class="term-fg31">-		&#47;&#47; Wrap tracked deletions as the return</span>
<span class="term-fg31">-		set := NewNodeSet(t.owner)</span>
<span class="term-fg31">-		t.tracer.markDeletions(set)</span>
<span class="term-fg31">-		return types.EmptyRootHash, set</span>
<span class="term-fg32">+		return types.EmptyRootHash, nodes</span>
 	}
 	&#47;&#47; Derive the hash for all dirty nodes first. We hold the assumption
 	&#47;&#47; in the following procedure that all nodes are hashed.
<span class="term-fg36">@@ -582,23 +582,23 @@</span> 		&#47;&#47; ensure all resolved nodes are dropped after the commit.
 		t.root = hashedNode
 		return rootHash, nil
 	}
<span class="term-fg31">-	h := newCommitter(t.owner, t.tracer, collectLeaf)</span>
<span class="term-fg31">-	newRoot, nodes := h.Commit(t.root)</span>
<span class="term-fg31">-	t.root = newRoot</span>
<span class="term-fg32">+	t.root = newCommitter(nodes, collectLeaf).Commit(t.root)</span>
 	return rootHash, nodes
 }
&nbsp;
 &#47;&#47; hashRoot calculates the root hash of the given trie
<span class="term-fg31">-func (t *Trie) hashRoot() (node, node, error) {</span>
<span class="term-fg32">+func (t *Trie) hashRoot() (node, node) {</span>
 	if t.root == nil {
<span class="term-fg31">-		return hashNode(types.EmptyRootHash.Bytes()), nil, nil</span>
<span class="term-fg32">+		return hashNode(types.EmptyRootHash.Bytes()), nil</span>
 	}
 	&#47;&#47; If the number of changes is below 100, we let one thread handle it
 	h := newHasher(t.unhashed &gt;= 100)
<span class="term-fg31">-	defer returnHasherToPool(h)</span>
<span class="term-fg32">+	defer func() {</span>
<span class="term-fg32">+		returnHasherToPool(h)</span>
<span class="term-fg32">+		t.unhashed = 0</span>
<span class="term-fg32">+	}()</span>
 	hashed, cached := h.hash(t.root, true)
<span class="term-fg31">-	t.unhashed = 0</span>
<span class="term-fg31">-	return hashed, cached, nil</span>
<span class="term-fg32">+	return hashed, cached</span>
 }
&nbsp;
 &#47;&#47; Reset drops the referenced root node and cleans all internal state.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-01dd46f3c6bbac479bc2a356" role="button"
                   aria-expanded="false" aria-controls="id-01dd46f3c6bbac479bc2a356">
                    <code>trie/trie_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/trie_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/trie/trie_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+60</span></div>
                        <div class="text-start"><span class="text-danger">-37</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-01dd46f3c6bbac479bc2a356"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;trie_test.go op-geth&#47;trie&#47;trie_test.go</span>
<span class="term-fg1">index 2f56c89cde379e36c3c091da915457c1f54fecd4..089bb44a974190a77ec374895c478be474ee71aa 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;trie_test.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;trie_test.go</span>
<span class="term-fg36">@@ -18,7 +18,6 @@</span> package trie
&nbsp;
 import (
 	&quot;bytes&quot;
<span class="term-fg31">-	crand &quot;crypto&#47;rand&quot;</span>
 	&quot;encoding&#47;binary&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
<span class="term-fg36">@@ -403,6 +402,51 @@</span> 	}
 	return reflect.ValueOf(steps)
 }
&nbsp;
<span class="term-fg32">+func verifyAccessList(old *Trie, new *Trie, set *NodeSet) error {</span>
<span class="term-fg32">+	deletes, inserts, updates := diffTries(old, new)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check insertion set</span>
<span class="term-fg32">+	for path := range inserts {</span>
<span class="term-fg32">+		n, ok := set.nodes[path]</span>
<span class="term-fg32">+		if !ok || n.isDeleted() {</span>
<span class="term-fg32">+			return errors.New(&quot;expect new node&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		_, ok = set.accessList[path]</span>
<span class="term-fg32">+		if ok {</span>
<span class="term-fg32">+			return errors.New(&quot;unexpected origin value&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Check deletion set</span>
<span class="term-fg32">+	for path, blob := range deletes {</span>
<span class="term-fg32">+		n, ok := set.nodes[path]</span>
<span class="term-fg32">+		if !ok || !n.isDeleted() {</span>
<span class="term-fg32">+			return errors.New(&quot;expect deleted node&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		v, ok := set.accessList[path]</span>
<span class="term-fg32">+		if !ok {</span>
<span class="term-fg32">+			return errors.New(&quot;expect origin value&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !bytes.Equal(v, blob) {</span>
<span class="term-fg32">+			return errors.New(&quot;invalid origin value&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Check update set</span>
<span class="term-fg32">+	for path, blob := range updates {</span>
<span class="term-fg32">+		n, ok := set.nodes[path]</span>
<span class="term-fg32">+		if !ok || n.isDeleted() {</span>
<span class="term-fg32">+			return errors.New(&quot;expect updated node&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		v, ok := set.accessList[path]</span>
<span class="term-fg32">+		if !ok {</span>
<span class="term-fg32">+			return errors.New(&quot;expect origin value&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !bytes.Equal(v, blob) {</span>
<span class="term-fg32">+			return errors.New(&quot;invalid origin value&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func runRandTest(rt randTest) bool {
 	var (
 		triedb   = NewDatabase(rawdb.NewMemoryDatabase())
<span class="term-fg36">@@ -410,8 +454,6 @@</span> 		tr       = NewEmpty(triedb)
 		values   = make(map[string]string) &#47;&#47; tracks content of the trie
 		origTrie = NewEmpty(triedb)
 	)
<span class="term-fg31">-	tr.tracer = newTracer()</span>
<span class="term-fg31">-</span>
 	for i, step := range rt {
 		&#47;&#47; fmt.Printf(&quot;{op: %d, key: common.Hex2Bytes(\&quot;%x\&quot;), value: common.Hex2Bytes(\&quot;%x\&quot;)}, &#47;&#47; step %d\n&quot;,
 		&#47;&#47; 	step.op, step.key, step.value, i)
<span class="term-fg36">@@ -447,24 +489,6 @@</span> 		case opHash:
 			tr.Hash()
 		case opCommit:
 			root, nodes := tr.Commit(true)
<span class="term-fg31">-			&#47;&#47; Validity the returned nodeset</span>
<span class="term-fg31">-			if nodes != nil {</span>
<span class="term-fg31">-				for path, node := range nodes.updates.nodes {</span>
<span class="term-fg31">-					blob, _, _ := origTrie.TryGetNode(hexToCompact([]byte(path)))</span>
<span class="term-fg31">-					got := node.prev</span>
<span class="term-fg31">-					if !bytes.Equal(blob, got) {</span>
<span class="term-fg31">-						rt[i].err = fmt.Errorf(&quot;prevalue mismatch for 0x%x, got 0x%x want 0x%x&quot;, path, got, blob)</span>
<span class="term-fg31">-						panic(rt[i].err)</span>
<span class="term-fg31">-					}</span>
<span class="term-fg31">-				}</span>
<span class="term-fg31">-				for path, prev := range nodes.deletes {</span>
<span class="term-fg31">-					blob, _, _ := origTrie.TryGetNode(hexToCompact([]byte(path)))</span>
<span class="term-fg31">-					if !bytes.Equal(blob, prev) {</span>
<span class="term-fg31">-						rt[i].err = fmt.Errorf(&quot;prevalue mismatch for 0x%x, got 0x%x want 0x%x&quot;, path, prev, blob)</span>
<span class="term-fg31">-						return false</span>
<span class="term-fg31">-					}</span>
<span class="term-fg31">-				}</span>
<span class="term-fg31">-			}</span>
 			if nodes != nil {
 				triedb.Update(NewWithNodeSet(nodes))
 			}
<span class="term-fg36">@@ -473,13 +497,13 @@</span> 			if err != nil {
 				rt[i].err = err
 				return false
 			}
<span class="term-fg32">+			if nodes != nil {</span>
<span class="term-fg32">+				if err := verifyAccessList(origTrie, newtr, nodes); err != nil {</span>
<span class="term-fg32">+					rt[i].err = err</span>
<span class="term-fg32">+					return false</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
 			tr = newtr
<span class="term-fg31">-</span>
<span class="term-fg31">-			&#47;&#47; Enable node tracing. Resolve the root node again explicitly</span>
<span class="term-fg31">-			&#47;&#47; since it&#39;s not captured at the beginning.</span>
<span class="term-fg31">-			tr.tracer = newTracer()</span>
<span class="term-fg31">-			tr.resolveAndTrack(root.Bytes(), nil)</span>
<span class="term-fg31">-</span>
 			origTrie = tr.Copy()
 		case opItercheckhash:
 			checktr := NewEmpty(triedb)
<span class="term-fg36">@@ -492,8 +516,6 @@</span> 				rt[i].err = fmt.Errorf(&quot;hash mismatch in opItercheckhash&quot;)
 			}
 		case opNodeDiff:
 			var (
<span class="term-fg31">-				inserted = tr.tracer.insertList()</span>
<span class="term-fg31">-				deleted  = tr.tracer.deleteList()</span>
 				origIter = origTrie.NodeIterator(nil)
 				curIter  = tr.NodeIterator(nil)
 				origSeen = make(map[string]struct{})
<span class="term-fg36">@@ -527,19 +549,19 @@</span> 				if !present {
 					deleteExp[path] = struct{}{}
 				}
 			}
<span class="term-fg31">-			if len(insertExp) != len(inserted) {</span>
<span class="term-fg32">+			if len(insertExp) != len(tr.tracer.inserts) {</span>
 				rt[i].err = fmt.Errorf(&quot;insert set mismatch&quot;)
 			}
<span class="term-fg31">-			if len(deleteExp) != len(deleted) {</span>
<span class="term-fg32">+			if len(deleteExp) != len(tr.tracer.deletes) {</span>
 				rt[i].err = fmt.Errorf(&quot;delete set mismatch&quot;)
 			}
<span class="term-fg31">-			for _, insert := range inserted {</span>
<span class="term-fg31">-				if _, present := insertExp[string(insert)]; !present {</span>
<span class="term-fg32">+			for insert := range tr.tracer.inserts {</span>
<span class="term-fg32">+				if _, present := insertExp[insert]; !present {</span>
 					rt[i].err = fmt.Errorf(&quot;missing inserted node&quot;)
 				}
 			}
<span class="term-fg31">-			for _, del := range deleted {</span>
<span class="term-fg31">-				if _, present := deleteExp[string(del)]; !present {</span>
<span class="term-fg32">+			for del := range tr.tracer.deletes {</span>
<span class="term-fg32">+				if _, present := deleteExp[del]; !present {</span>
 					rt[i].err = fmt.Errorf(&quot;missing deleted node&quot;)
 				}
 			}
<span class="term-fg36">@@ -1123,13 +1145,14 @@</span> }
&nbsp;
 func TestDecodeNode(t *testing.T) {
 	t.Parallel()
<span class="term-fg32">+</span>
 	var (
 		hash  = make([]byte, 20)
 		elems = make([]byte, 20)
 	)
 	for i := 0; i &lt; 5000000; i++ {
<span class="term-fg31">-		crand.Read(hash)</span>
<span class="term-fg31">-		crand.Read(elems)</span>
<span class="term-fg32">+		prng.Read(hash)</span>
<span class="term-fg32">+		prng.Read(elems)</span>
 		decodeNode(hash, elems)
 	}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fe650e47957b149f48c43491" role="button"
                   aria-expanded="false" aria-controls="id-fe650e47957b149f48c43491">
                    <code>trie/util_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/util_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <span class="text-muted">(deleted)</span>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+0</span></div>
                        <div class="text-start"><span class="text-danger">-305</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fe650e47957b149f48c43491"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;util_test.go op-geth&#47;trie&#47;util_test.go</span>
<span class="term-fg1">deleted file mode 100644</span>
<span class="term-fg1">index 8d925a16aabb9b11753695021332a62157022028..0000000000000000000000000000000000000000</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;util_test.go</span>
<span class="term-fg1">+++ &#47;dev&#47;null</span>
<span class="term-fg36">@@ -1,305 +0,0 @@</span>
<span class="term-fg31">-&#47;&#47; Copyright 2022 The go-ethereum Authors</span>
<span class="term-fg31">-&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg31">-&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg31">-&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg31">-&#47;&#47; (at your option) any later version.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg31">-&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg31">-&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg31">-&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg31">-&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-package trie</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-import (</span>
<span class="term-fg31">-	&quot;bytes&quot;</span>
<span class="term-fg31">-	&quot;testing&quot;</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;</span>
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg31">-)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; Tests if the trie diffs are tracked correctly.</span>
<span class="term-fg31">-func TestTrieTracer(t *testing.T) {</span>
<span class="term-fg31">-	db := NewDatabase(rawdb.NewMemoryDatabase())</span>
<span class="term-fg31">-	trie := NewEmpty(db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Insert a batch of entries, all the nodes should be marked as inserted</span>
<span class="term-fg31">-	vals := []struct{ k, v string }{</span>
<span class="term-fg31">-		{&quot;do&quot;, &quot;verb&quot;},</span>
<span class="term-fg31">-		{&quot;ether&quot;, &quot;wookiedoo&quot;},</span>
<span class="term-fg31">-		{&quot;horse&quot;, &quot;stallion&quot;},</span>
<span class="term-fg31">-		{&quot;shaman&quot;, &quot;horse&quot;},</span>
<span class="term-fg31">-		{&quot;doge&quot;, &quot;coin&quot;},</span>
<span class="term-fg31">-		{&quot;dog&quot;, &quot;puppy&quot;},</span>
<span class="term-fg31">-		{&quot;somethingveryoddindeedthis is&quot;, &quot;myothernodedata&quot;},</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	trie.Hash()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	seen := make(map[string]struct{})</span>
<span class="term-fg31">-	it := trie.NodeIterator(nil)</span>
<span class="term-fg31">-	for it.Next(true) {</span>
<span class="term-fg31">-		if it.Leaf() {</span>
<span class="term-fg31">-			continue</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		seen[string(it.Path())] = struct{}{}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	inserted := trie.tracer.insertList()</span>
<span class="term-fg31">-	if len(inserted) != len(seen) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected inserted node tracked want %d got %d&quot;, len(seen), len(inserted))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, k := range inserted {</span>
<span class="term-fg31">-		_, ok := seen[string(k)]</span>
<span class="term-fg31">-		if !ok {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Unexpected inserted node&quot;)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	deleted := trie.tracer.deleteList()</span>
<span class="term-fg31">-	if len(deleted) != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected deleted node tracked %d&quot;, len(deleted))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Commit the changes and re-create with new root</span>
<span class="term-fg31">-	root, nodes := trie.Commit(false)</span>
<span class="term-fg31">-	if err := db.Update(NewWithNodeSet(nodes)); err != nil {</span>
<span class="term-fg31">-		t.Fatal(err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Delete all the elements, check deletion set</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.Delete([]byte(val.k))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	trie.Hash()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	inserted = trie.tracer.insertList()</span>
<span class="term-fg31">-	if len(inserted) != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected inserted node tracked %d&quot;, len(inserted))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	deleted = trie.tracer.deleteList()</span>
<span class="term-fg31">-	if len(deleted) != len(seen) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected deleted node tracked want %d got %d&quot;, len(seen), len(deleted))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, k := range deleted {</span>
<span class="term-fg31">-		_, ok := seen[string(k)]</span>
<span class="term-fg31">-		if !ok {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Unexpected inserted node&quot;)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func TestTrieTracerNoop(t *testing.T) {</span>
<span class="term-fg31">-	trie := NewEmpty(NewDatabase(rawdb.NewMemoryDatabase()))</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Insert a batch of entries, all the nodes should be marked as inserted</span>
<span class="term-fg31">-	vals := []struct{ k, v string }{</span>
<span class="term-fg31">-		{&quot;do&quot;, &quot;verb&quot;},</span>
<span class="term-fg31">-		{&quot;ether&quot;, &quot;wookiedoo&quot;},</span>
<span class="term-fg31">-		{&quot;horse&quot;, &quot;stallion&quot;},</span>
<span class="term-fg31">-		{&quot;shaman&quot;, &quot;horse&quot;},</span>
<span class="term-fg31">-		{&quot;doge&quot;, &quot;coin&quot;},</span>
<span class="term-fg31">-		{&quot;dog&quot;, &quot;puppy&quot;},</span>
<span class="term-fg31">-		{&quot;somethingveryoddindeedthis is&quot;, &quot;myothernodedata&quot;},</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.Delete([]byte(val.k))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if len(trie.tracer.insertList()) != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected inserted node tracked %d&quot;, len(trie.tracer.insertList()))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if len(trie.tracer.deleteList()) != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected deleted node tracked %d&quot;, len(trie.tracer.deleteList()))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func TestTrieTracePrevValue(t *testing.T) {</span>
<span class="term-fg31">-	db := NewDatabase(rawdb.NewMemoryDatabase())</span>
<span class="term-fg31">-	trie := NewEmpty(db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	paths, blobs := trie.tracer.prevList()</span>
<span class="term-fg31">-	if len(paths) != 0 || len(blobs) != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Nothing should be tracked&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Insert a batch of entries, all the nodes should be marked as inserted</span>
<span class="term-fg31">-	vals := []struct{ k, v string }{</span>
<span class="term-fg31">-		{&quot;do&quot;, &quot;verb&quot;},</span>
<span class="term-fg31">-		{&quot;ether&quot;, &quot;wookiedoo&quot;},</span>
<span class="term-fg31">-		{&quot;horse&quot;, &quot;stallion&quot;},</span>
<span class="term-fg31">-		{&quot;shaman&quot;, &quot;horse&quot;},</span>
<span class="term-fg31">-		{&quot;doge&quot;, &quot;coin&quot;},</span>
<span class="term-fg31">-		{&quot;dog&quot;, &quot;puppy&quot;},</span>
<span class="term-fg31">-		{&quot;somethingveryoddindeedthis is&quot;, &quot;myothernodedata&quot;},</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	paths, blobs = trie.tracer.prevList()</span>
<span class="term-fg31">-	if len(paths) != 0 || len(blobs) != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Nothing should be tracked&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Commit the changes and re-create with new root</span>
<span class="term-fg31">-	root, nodes := trie.Commit(false)</span>
<span class="term-fg31">-	if err := db.Update(NewWithNodeSet(nodes)); err != nil {</span>
<span class="term-fg31">-		t.Fatal(err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-	trie.resolveAndTrack(root.Bytes(), nil)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Load all nodes in trie</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.TryGet([]byte(val.k))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Ensure all nodes are tracked by tracer with correct prev-values</span>
<span class="term-fg31">-	iter := trie.NodeIterator(nil)</span>
<span class="term-fg31">-	seen := make(map[string][]byte)</span>
<span class="term-fg31">-	for iter.Next(true) {</span>
<span class="term-fg31">-		&#47;&#47; Embedded nodes are ignored since they are not present in</span>
<span class="term-fg31">-		&#47;&#47; database.</span>
<span class="term-fg31">-		if iter.Hash() == (common.Hash{}) {</span>
<span class="term-fg31">-			continue</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		seen[string(iter.Path())] = common.CopyBytes(iter.NodeBlob())</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	paths, blobs = trie.tracer.prevList()</span>
<span class="term-fg31">-	if len(paths) != len(seen) || len(blobs) != len(seen) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected tracked values&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for i, path := range paths {</span>
<span class="term-fg31">-		blob := blobs[i]</span>
<span class="term-fg31">-		prev, ok := seen[string(path)]</span>
<span class="term-fg31">-		if !ok {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Missing node %v&quot;, path)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if !bytes.Equal(blob, prev) {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Unexpected value path: %v, want: %v, got: %v&quot;, path, prev, blob)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Re-open the trie and iterate the trie, ensure nothing will be tracked.</span>
<span class="term-fg31">-	&#47;&#47; Iterator will not link any loaded nodes to trie.</span>
<span class="term-fg31">-	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	iter = trie.NodeIterator(nil)</span>
<span class="term-fg31">-	for iter.Next(true) {</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	paths, blobs = trie.tracer.prevList()</span>
<span class="term-fg31">-	if len(paths) != 0 || len(blobs) != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Nothing should be tracked&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Re-open the trie and generate proof for entries, ensure nothing will</span>
<span class="term-fg31">-	&#47;&#47; be tracked. Prover will not link any loaded nodes to trie.</span>
<span class="term-fg31">-	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.Prove([]byte(val.k), 0, rawdb.NewMemoryDatabase())</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	paths, blobs = trie.tracer.prevList()</span>
<span class="term-fg31">-	if len(paths) != 0 || len(blobs) != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Nothing should be tracked&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Delete entries from trie, ensure all previous values are correct.</span>
<span class="term-fg31">-	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-	trie.resolveAndTrack(root.Bytes(), nil)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.TryDelete([]byte(val.k))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	paths, blobs = trie.tracer.prevList()</span>
<span class="term-fg31">-	if len(paths) != len(seen) || len(blobs) != len(seen) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected tracked values&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for i, path := range paths {</span>
<span class="term-fg31">-		blob := blobs[i]</span>
<span class="term-fg31">-		prev, ok := seen[string(path)]</span>
<span class="term-fg31">-		if !ok {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Missing node %v&quot;, path)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if !bytes.Equal(blob, prev) {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Unexpected value path: %v, want: %v, got: %v&quot;, path, prev, blob)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func TestDeleteAll(t *testing.T) {</span>
<span class="term-fg31">-	db := NewDatabase(rawdb.NewMemoryDatabase())</span>
<span class="term-fg31">-	trie := NewEmpty(db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Insert a batch of entries, all the nodes should be marked as inserted</span>
<span class="term-fg31">-	vals := []struct{ k, v string }{</span>
<span class="term-fg31">-		{&quot;do&quot;, &quot;verb&quot;},</span>
<span class="term-fg31">-		{&quot;ether&quot;, &quot;wookiedoo&quot;},</span>
<span class="term-fg31">-		{&quot;horse&quot;, &quot;stallion&quot;},</span>
<span class="term-fg31">-		{&quot;shaman&quot;, &quot;horse&quot;},</span>
<span class="term-fg31">-		{&quot;doge&quot;, &quot;coin&quot;},</span>
<span class="term-fg31">-		{&quot;dog&quot;, &quot;puppy&quot;},</span>
<span class="term-fg31">-		{&quot;somethingveryoddindeedthis is&quot;, &quot;myothernodedata&quot;},</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.Update([]byte(val.k), []byte(val.v))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	root, set := trie.Commit(false)</span>
<span class="term-fg31">-	if err := db.Update(NewWithNodeSet(set)); err != nil {</span>
<span class="term-fg31">-		t.Fatal(err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Delete entries from trie, ensure all values are detected</span>
<span class="term-fg31">-	trie, _ = New(TrieID(root), db)</span>
<span class="term-fg31">-	trie.tracer = newTracer()</span>
<span class="term-fg31">-	trie.resolveAndTrack(root.Bytes(), nil)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Iterate all existent nodes</span>
<span class="term-fg31">-	var (</span>
<span class="term-fg31">-		it    = trie.NodeIterator(nil)</span>
<span class="term-fg31">-		nodes = make(map[string][]byte)</span>
<span class="term-fg31">-	)</span>
<span class="term-fg31">-	for it.Next(true) {</span>
<span class="term-fg31">-		if it.Hash() != (common.Hash{}) {</span>
<span class="term-fg31">-			nodes[string(it.Path())] = common.CopyBytes(it.NodeBlob())</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Perform deletion to purge the entire trie</span>
<span class="term-fg31">-	for _, val := range vals {</span>
<span class="term-fg31">-		trie.Delete([]byte(val.k))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	root, set = trie.Commit(false)</span>
<span class="term-fg31">-	if root != types.EmptyRootHash {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Invalid trie root %v&quot;, root)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for path, blob := range set.deletes {</span>
<span class="term-fg31">-		prev, ok := nodes[path]</span>
<span class="term-fg31">-		if !ok {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Extra node deleted %v&quot;, []byte(path))</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if !bytes.Equal(prev, blob) {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Unexpected previous value %v&quot;, []byte(path))</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if len(set.deletes) != len(nodes) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Unexpected deletion set&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2965224c9d924d4ad78adcac" role="button"
                   aria-expanded="false" aria-controls="id-2965224c9d924d4ad78adcac">
                    <code>trie/utils.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/trie/utils.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <span class="text-muted">(deleted)</span>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+0</span></div>
                        <div class="text-start"><span class="text-danger">-199</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2965224c9d924d4ad78adcac"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;utils.go op-geth&#47;trie&#47;utils.go</span>
<span class="term-fg1">deleted file mode 100644</span>
<span class="term-fg1">index 5dce65cd2971e0a72a5f5382c3480394369e2af4..0000000000000000000000000000000000000000</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;utils.go</span>
<span class="term-fg1">+++ &#47;dev&#47;null</span>
<span class="term-fg36">@@ -1,199 +0,0 @@</span>
<span class="term-fg31">-&#47;&#47; Copyright 2022 The go-ethereum Authors</span>
<span class="term-fg31">-&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg31">-&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg31">-&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg31">-&#47;&#47; (at your option) any later version.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg31">-&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg31">-&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg31">-&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg31">-&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-package trie</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; tracer tracks the changes of trie nodes. During the trie operations,</span>
<span class="term-fg31">-&#47;&#47; some nodes can be deleted from the trie, while these deleted nodes</span>
<span class="term-fg31">-&#47;&#47; won&#39;t be captured by trie.Hasher or trie.Committer. Thus, these deleted</span>
<span class="term-fg31">-&#47;&#47; nodes won&#39;t be removed from the disk at all. Tracer is an auxiliary tool</span>
<span class="term-fg31">-&#47;&#47; used to track all insert and delete operations of trie and capture all</span>
<span class="term-fg31">-&#47;&#47; deleted nodes eventually.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; The changed nodes can be mainly divided into two categories: the leaf</span>
<span class="term-fg31">-&#47;&#47; node and intermediate node. The former is inserted&#47;deleted by callers</span>
<span class="term-fg31">-&#47;&#47; while the latter is inserted&#47;deleted in order to follow the rule of trie.</span>
<span class="term-fg31">-&#47;&#47; This tool can track all of them no matter the node is embedded in its</span>
<span class="term-fg31">-&#47;&#47; parent or not, but valueNode is never tracked.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; Besides, it&#39;s also used for recording the original value of the nodes</span>
<span class="term-fg31">-&#47;&#47; when they are resolved from the disk. The pre-value of the nodes will</span>
<span class="term-fg31">-&#47;&#47; be used to construct reverse-diffs in the future.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47; Note tracer is not thread-safe, callers should be responsible for handling</span>
<span class="term-fg31">-&#47;&#47; the concurrency issues by themselves.</span>
<span class="term-fg31">-type tracer struct {</span>
<span class="term-fg31">-	insert map[string]struct{}</span>
<span class="term-fg31">-	delete map[string]struct{}</span>
<span class="term-fg31">-	origin map[string][]byte</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; newTracer initializes the tracer for capturing trie changes.</span>
<span class="term-fg31">-func newTracer() *tracer {</span>
<span class="term-fg31">-	return &amp;tracer{</span>
<span class="term-fg31">-		insert: make(map[string]struct{}),</span>
<span class="term-fg31">-		delete: make(map[string]struct{}),</span>
<span class="term-fg31">-		origin: make(map[string][]byte),</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; onRead tracks the newly loaded trie node and caches the rlp-encoded blob internally.</span>
<span class="term-fg31">-&#47;&#47; Don&#39;t change the value outside of function since it&#39;s not deep-copied.</span>
<span class="term-fg31">-func (t *tracer) onRead(path []byte, val []byte) {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	t.origin[string(path)] = val</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; onInsert tracks the newly inserted trie node. If it&#39;s already in the deletion set</span>
<span class="term-fg31">-&#47;&#47; (resurrected node), then just wipe it from the deletion set as the &quot;untouched&quot;.</span>
<span class="term-fg31">-func (t *tracer) onInsert(path []byte) {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if _, present := t.delete[string(path)]; present {</span>
<span class="term-fg31">-		delete(t.delete, string(path))</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	t.insert[string(path)] = struct{}{}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; onDelete tracks the newly deleted trie node. If it&#39;s already</span>
<span class="term-fg31">-&#47;&#47; in the addition set, then just wipe it from the addition set</span>
<span class="term-fg31">-&#47;&#47; as it&#39;s untouched.</span>
<span class="term-fg31">-func (t *tracer) onDelete(path []byte) {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if _, present := t.insert[string(path)]; present {</span>
<span class="term-fg31">-		delete(t.insert, string(path))</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	t.delete[string(path)] = struct{}{}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; insertList returns the tracked inserted trie nodes in list format.</span>
<span class="term-fg31">-func (t *tracer) insertList() [][]byte {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return nil</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	var ret [][]byte</span>
<span class="term-fg31">-	for path := range t.insert {</span>
<span class="term-fg31">-		ret = append(ret, []byte(path))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return ret</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; deleteList returns the tracked deleted trie nodes in list format.</span>
<span class="term-fg31">-func (t *tracer) deleteList() [][]byte {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return nil</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	var ret [][]byte</span>
<span class="term-fg31">-	for path := range t.delete {</span>
<span class="term-fg31">-		ret = append(ret, []byte(path))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return ret</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; prevList returns the tracked node blobs in list format.</span>
<span class="term-fg31">-func (t *tracer) prevList() ([][]byte, [][]byte) {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return nil, nil</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	var (</span>
<span class="term-fg31">-		paths [][]byte</span>
<span class="term-fg31">-		blobs [][]byte</span>
<span class="term-fg31">-	)</span>
<span class="term-fg31">-	for path, blob := range t.origin {</span>
<span class="term-fg31">-		paths = append(paths, []byte(path))</span>
<span class="term-fg31">-		blobs = append(blobs, blob)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return paths, blobs</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; getPrev returns the cached original value of the specified node.</span>
<span class="term-fg31">-func (t *tracer) getPrev(path []byte) []byte {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return nil</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return t.origin[string(path)]</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; reset clears the content tracked by tracer.</span>
<span class="term-fg31">-func (t *tracer) reset() {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	t.insert = make(map[string]struct{})</span>
<span class="term-fg31">-	t.delete = make(map[string]struct{})</span>
<span class="term-fg31">-	t.origin = make(map[string][]byte)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; copy returns a deep copied tracer instance.</span>
<span class="term-fg31">-func (t *tracer) copy() *tracer {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return nil</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	var (</span>
<span class="term-fg31">-		insert = make(map[string]struct{})</span>
<span class="term-fg31">-		delete = make(map[string]struct{})</span>
<span class="term-fg31">-		origin = make(map[string][]byte)</span>
<span class="term-fg31">-	)</span>
<span class="term-fg31">-	for key := range t.insert {</span>
<span class="term-fg31">-		insert[key] = struct{}{}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for key := range t.delete {</span>
<span class="term-fg31">-		delete[key] = struct{}{}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for key, val := range t.origin {</span>
<span class="term-fg31">-		origin[key] = val</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return &amp;tracer{</span>
<span class="term-fg31">-		insert: insert,</span>
<span class="term-fg31">-		delete: delete,</span>
<span class="term-fg31">-		origin: origin,</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; markDeletions puts all tracked deletions into the provided nodeset.</span>
<span class="term-fg31">-func (t *tracer) markDeletions(set *NodeSet) {</span>
<span class="term-fg31">-	&#47;&#47; Tracer isn&#39;t used right now, remove this check later.</span>
<span class="term-fg31">-	if t == nil {</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, path := range t.deleteList() {</span>
<span class="term-fg31">-		&#47;&#47; There are a few possibilities for this scenario(the node is deleted</span>
<span class="term-fg31">-		&#47;&#47; but not present in database previously), for example the node was</span>
<span class="term-fg31">-		&#47;&#47; embedded in the parent and now deleted from the trie. In this case</span>
<span class="term-fg31">-		&#47;&#47; it&#39;s noop from database&#39;s perspective.</span>
<span class="term-fg31">-		val := t.getPrev(path)</span>
<span class="term-fg31">-		if len(val) == 0 {</span>
<span class="term-fg31">-			continue</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		set.markDeleted(path, val)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

                
                    <div class="text-muted">
                        <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-f6c705bfe27373ef821524f7"role="button" aria-expanded="false" aria-controls="id-f6c705bfe27373ef821524f7">
        
            <div class="col-12 col-sm-9 text-start"><h4>Ignored changes</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+450</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-f6c705bfe27373ef821524f7">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7fff74d971fbf7960a3c1473" role="button"
                   aria-expanded="false" aria-controls="id-7fff74d971fbf7960a3c1473">
                    <code>.circleci/check-releases.sh</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/.circleci/check-releases.sh" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7fff74d971fbf7960a3c1473"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;check-releases.sh op-geth&#47;.circleci&#47;check-releases.sh</span>
<span class="term-fg1">new file mode 100755</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..f3595e1320377bea4b17c13326d87342083071c0</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;check-releases.sh</span>
<span class="term-fg36">@@ -0,0 +1,21 @@</span>
<span class="term-fg32">+#!&#47;bin&#47;bash</span>
<span class="term-fg32">+set -euo pipefail</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+LATEST_RELEASE=$(curl -s --fail -L \</span>
<span class="term-fg32">+  -H &quot;Accept: application&#47;vnd.github+json&quot; \</span>
<span class="term-fg32">+  -H &quot;X-GitHub-Api-Version: 2022-11-28&quot; \</span>
<span class="term-fg32">+  https:&#47;&#47;api.github.com&#47;repos&#47;ethereum&#47;go-ethereum&#47;releases \</span>
<span class="term-fg32">+  | jq -r &#39;(.[] | select(.draft==false) | select(.prerelease==false)).tag_name&#39; | head -n 1)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Detected latest go-ethereum release as ${LATEST_RELEASE}&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+git remote add upstream https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum</span>
<span class="term-fg32">+git fetch upstream &gt; &#47;dev&#47;null</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+if git branch --contains &quot;${LATEST_RELEASE}&quot; 2&gt;&amp;1 | grep -e &#39;^[ *]*optimism$&#39; &gt; &#47;dev&#47;null</span>
<span class="term-fg32">+then</span>
<span class="term-fg32">+  echo &quot;Up to date with latest release.  Great job! &quot;</span>
<span class="term-fg32">+else</span>
<span class="term-fg32">+  echo &quot;Release has not been merged&quot;</span>
<span class="term-fg32">+  exit 1</span>
<span class="term-fg32">+fi</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-57da33f79b13dc7dfb69e871" role="button"
                   aria-expanded="false" aria-controls="id-57da33f79b13dc7dfb69e871">
                    <code>.circleci/config.yml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/.circleci/config.yml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+184</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-57da33f79b13dc7dfb69e871"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;config.yml op-geth&#47;.circleci&#47;config.yml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..57716a3511eb1e6f40a3a98963d8ecee4c2546a2</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;config.yml</span>
<span class="term-fg36">@@ -0,0 +1,184 @@</span>
<span class="term-fg32">+version: 2.1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+orbs:</span>
<span class="term-fg32">+  gcp-cli: circleci&#47;gcp-cli@3.0.1</span>
<span class="term-fg32">+  slack: circleci&#47;slack@4.10.1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+commands:</span>
<span class="term-fg32">+  gcp-oidc-authenticate:</span>
<span class="term-fg32">+    description: &quot;Authenticate with GCP using a CircleCI OIDC token.&quot;</span>
<span class="term-fg32">+    parameters:</span>
<span class="term-fg32">+      project_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_PROJECT_ID</span>
<span class="term-fg32">+      workload_identity_pool_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_WIP_ID</span>
<span class="term-fg32">+      workload_identity_pool_provider_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_WIP_PROVIDER_ID</span>
<span class="term-fg32">+      service_account_email:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_SERVICE_ACCOUNT_EMAIL</span>
<span class="term-fg32">+      gcp_cred_config_file_path:</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &#47;home&#47;circleci&#47;gcp_cred_config.json</span>
<span class="term-fg32">+      oidc_token_file_path:</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &#47;home&#47;circleci&#47;oidc_token.json</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: &quot;Create OIDC credential configuration&quot;</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            # Store OIDC token in temp file</span>
<span class="term-fg32">+            echo $CIRCLE_OIDC_TOKEN &gt; &lt;&lt; parameters.oidc_token_file_path &gt;&gt;</span>
<span class="term-fg32">+            # Create a credential configuration for the generated OIDC ID Token</span>
<span class="term-fg32">+            gcloud iam workload-identity-pools create-cred-config \</span>
<span class="term-fg32">+                &quot;projects&#47;${&lt;&lt; parameters.project_id &gt;&gt;}&#47;locations&#47;global&#47;workloadIdentityPools&#47;${&lt;&lt; parameters.workload_identity_pool_id &gt;&gt;}&#47;providers&#47;${&lt;&lt; parameters.workload_identity_pool_provider_id &gt;&gt;}&quot;\</span>
<span class="term-fg32">+                --output-file=&quot;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&quot; \</span>
<span class="term-fg32">+                --service-account=&quot;${&lt;&lt; parameters.service_account_email &gt;&gt;}&quot; \</span>
<span class="term-fg32">+                --credential-source-file=&lt;&lt; parameters.oidc_token_file_path &gt;&gt;</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: &quot;Authenticate with GCP using OIDC&quot;</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            # Configure gcloud to leverage the generated credential configuration</span>
<span class="term-fg32">+            gcloud auth login --brief --cred-file &quot;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&quot;</span>
<span class="term-fg32">+            # Configure ADC</span>
<span class="term-fg32">+            echo &quot;export GOOGLE_APPLICATION_CREDENTIALS=&#39;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&#39;&quot; | tee -a &quot;$BASH_ENV&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+jobs:</span>
<span class="term-fg32">+  docker-release:</span>
<span class="term-fg32">+    environment:</span>
<span class="term-fg32">+      DOCKER_BUILDKIT: 1</span>
<span class="term-fg32">+    parameters:</span>
<span class="term-fg32">+      docker_name:</span>
<span class="term-fg32">+        description: Docker image name</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;op-geth&quot;</span>
<span class="term-fg32">+      docker_tags:</span>
<span class="term-fg32">+        description: Docker image tags as csv</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+      registry:</span>
<span class="term-fg32">+        description: Docker registry</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;us-docker.pkg.dev&quot;</span>
<span class="term-fg32">+      repo:</span>
<span class="term-fg32">+        description: Docker repo</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;oplabs-tools-artifacts&#47;images&quot;</span>
<span class="term-fg32">+    machine:</span>
<span class="term-fg32">+      image: ubuntu-2204:2022.07.1</span>
<span class="term-fg32">+      resource_class: xlarge</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - gcp-cli&#47;install</span>
<span class="term-fg32">+      - gcp-oidc-authenticate</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: Configure Docker</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            gcloud auth configure-docker &lt;&lt;parameters.registry&gt;&gt;</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: Build and push</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            RAW_TAGS=&quot;&lt;&lt;parameters.docker_tags&gt;&gt;&quot;</span>
<span class="term-fg32">+            if [ &quot;$CIRCLE_BRANCH&quot; = &quot;optimism&quot; ]; then</span>
<span class="term-fg32">+              RAW_TAGS=&quot;$RAW_TAGS,optimism&quot;</span>
<span class="term-fg32">+            fi</span>
<span class="term-fg32">+            IMAGE_BASE=&quot;&lt;&lt;parameters.registry&gt;&gt;&#47;&lt;&lt;parameters.repo&gt;&gt;&#47;&lt;&lt;parameters.docker_name&gt;&gt;&quot;</span>
<span class="term-fg32">+            DOCKER_TAGS=$(echo -ne &quot;$RAW_TAGS&quot; | sed &quot;s&#47;,&#47;\n&#47;g&quot; | sed &quot;s&#47;[^a-zA-Z0-9\n.]&#47;-&#47;g&quot; | sed -e &quot;s|^|-t ${IMAGE_BASE}:|&quot;)</span>
<span class="term-fg32">+            docker context create buildx-build</span>
<span class="term-fg32">+            docker buildx create --use buildx-build</span>
<span class="term-fg32">+            docker buildx build --push \</span>
<span class="term-fg32">+              $(echo -ne $DOCKER_TAGS | tr &#39;\n&#39; &#39; &#39;) \</span>
<span class="term-fg32">+              --platform=linux&#47;arm64,linux&#47;amd64 \</span>
<span class="term-fg32">+              --build-arg VERSION=$CIRCLE_TAG \</span>
<span class="term-fg32">+              --build-arg COMMIT=$CIRCLE_SHA \</span>
<span class="term-fg32">+              --build-arg BUILDNUM=$CIRCLE_BUILD_NUM \</span>
<span class="term-fg32">+              --progress plain \</span>
<span class="term-fg32">+              -f Dockerfile .</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+  build-geth:</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.19</span>
<span class="term-fg32">+    resource_class: medium</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go install</span>
<span class="term-fg32">+  unit-test:</span>
<span class="term-fg32">+    resource_class: medium</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.19</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go test</span>
<span class="term-fg32">+  lint-geth:</span>
<span class="term-fg32">+    resource_class: medium</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.19</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go lint</span>
<span class="term-fg32">+  check-releases:</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.19</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: .circleci&#47;check-releases.sh</span>
<span class="term-fg32">+      - slack&#47;notify:</span>
<span class="term-fg32">+          channel: C03N11M0BBN</span>
<span class="term-fg32">+          branch_pattern: optimism</span>
<span class="term-fg32">+          event: fail</span>
<span class="term-fg32">+          template: basic_fail_1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+workflows:</span>
<span class="term-fg32">+  main:</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - build-geth:</span>
<span class="term-fg32">+          name: Build geth</span>
<span class="term-fg32">+      - unit-test:</span>
<span class="term-fg32">+          name: Run unit tests for geth</span>
<span class="term-fg32">+      - lint-geth:</span>
<span class="term-fg32">+          name: Run linter over geth</span>
<span class="term-fg32">+      - docker-release:</span>
<span class="term-fg32">+          name: Push to Docker</span>
<span class="term-fg32">+          docker_tags: &lt;&lt;pipeline.git.revision&gt;&gt;</span>
<span class="term-fg32">+          context:</span>
<span class="term-fg32">+            - oplabs-gcr</span>
<span class="term-fg32">+  release:</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - hold:</span>
<span class="term-fg32">+          type: approval</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            tags:</span>
<span class="term-fg32">+              only: &#47;^v.*&#47;</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              ignore: &#47;.*&#47;</span>
<span class="term-fg32">+      - docker-release:</span>
<span class="term-fg32">+          name: Push to Docker</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            tags:</span>
<span class="term-fg32">+              only: &#47;^v.*&#47;</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              ignore: &#47;.*&#47;</span>
<span class="term-fg32">+          docker_tags: &lt;&lt;pipeline.git.revision&gt;&gt;,&lt;&lt;pipeline.git.tag&gt;&gt;</span>
<span class="term-fg32">+          context:</span>
<span class="term-fg32">+            - oplabs-gcr-release</span>
<span class="term-fg32">+          requires:</span>
<span class="term-fg32">+            - hold</span>
<span class="term-fg32">+  scheduled:</span>
<span class="term-fg32">+    triggers:</span>
<span class="term-fg32">+      - schedule:</span>
<span class="term-fg32">+          # run daily</span>
<span class="term-fg32">+          cron: &quot;0 0 * * *&quot;</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              only: [ &quot;optimism&quot; ]</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - check-releases:</span>
<span class="term-fg32">+          name: Check for new upstream releases</span>
<span class="term-fg32">+          context: slack</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e44901feb62cac4dc7894aac" role="button"
                   aria-expanded="false" aria-controls="id-e44901feb62cac4dc7894aac">
                    <code>.github/workflows/pages.yaml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/.github/workflows/pages.yaml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+36</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e44901feb62cac4dc7894aac"><span class="term-fg1">diff --git go-ethereum&#47;.github&#47;workflows&#47;pages.yaml op-geth&#47;.github&#47;workflows&#47;pages.yaml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..6973b227ce779be6138ee2084e71bb5a5cdd57de</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.github&#47;workflows&#47;pages.yaml</span>
<span class="term-fg36">@@ -0,0 +1,36 @@</span>
<span class="term-fg32">+name: Build and publish forkdiff github-pages</span>
<span class="term-fg32">+permissions:</span>
<span class="term-fg32">+  contents: write</span>
<span class="term-fg32">+on:</span>
<span class="term-fg32">+  push:</span>
<span class="term-fg32">+    branches:</span>
<span class="term-fg32">+      - optimism</span>
<span class="term-fg32">+jobs:</span>
<span class="term-fg32">+  deploy:</span>
<span class="term-fg32">+    concurrency: ci-${{ github.ref }}</span>
<span class="term-fg32">+    runs-on: ubuntu-latest</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - name: Checkout</span>
<span class="term-fg32">+        uses: actions&#47;checkout@v3</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          fetch-depth: 1000  # make sure to fetch the old commit we diff against</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Build forkdiff</span>
<span class="term-fg32">+        uses: &quot;docker:&#47;&#47;protolambda&#47;forkdiff:latest&quot;</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          args: -repo=&#47;github&#47;workspace -fork=&#47;github&#47;workspace&#47;fork.yaml -out=&#47;github&#47;workspace&#47;index.html</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Build pages</span>
<span class="term-fg32">+        run: |</span>
<span class="term-fg32">+          mkdir -p tmp&#47;pages</span>
<span class="term-fg32">+          mv index.html tmp&#47;pages&#47;index.html</span>
<span class="term-fg32">+          touch tmp&#47;pages&#47;.nojekyll</span>
<span class="term-fg32">+          if [ &quot;$GITHUB_REPOSITORY&quot; == &quot;ethereum-optimism&#47;op-geth&quot; ]; then</span>
<span class="term-fg32">+              echo &quot;op-geth.optimism.io&quot; &gt; tmp&#47;pages&#47;CNAME</span>
<span class="term-fg32">+          fi;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Deploy</span>
<span class="term-fg32">+        uses: JamesIves&#47;github-pages-deploy-action@v4</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          folder: tmp&#47;pages</span>
<span class="term-fg32">+          clean: true</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d545b737647ca9d3cafc5369" role="button"
                   aria-expanded="false" aria-controls="id-d545b737647ca9d3cafc5369">
                    <code>fork.yaml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/fork.yaml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+203</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d545b737647ca9d3cafc5369"><span class="term-fg1">diff --git go-ethereum&#47;fork.yaml op-geth&#47;fork.yaml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..8e3376a2b8eff70e17fb62b4421d36fb016d270b</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;fork.yaml</span>
<span class="term-fg36">@@ -0,0 +1,203 @@</span>
<span class="term-fg32">+title: &quot;op-geth - go-ethereum fork diff overview&quot;</span>
<span class="term-fg32">+footer: |</span>
<span class="term-fg32">+  Fork-diff overview of [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth), a fork of [`go-ethereum`](https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum).</span>
<span class="term-fg32">+  and execution-engine of the [OP-stack](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism).</span>
<span class="term-fg32">+base:</span>
<span class="term-fg32">+  name: go-ethereum</span>
<span class="term-fg32">+  url: https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum</span>
<span class="term-fg32">+  hash: 7e3b149be054053fd1177deaba3caf60d5f5d30b</span>
<span class="term-fg32">+fork:</span>
<span class="term-fg32">+  name: op-geth</span>
<span class="term-fg32">+  url: https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth</span>
<span class="term-fg32">+  ref: refs&#47;heads&#47;optimism</span>
<span class="term-fg32">+def:</span>
<span class="term-fg32">+  title: &quot;op-geth&quot;</span>
<span class="term-fg32">+  description: |</span>
<span class="term-fg32">+    This is an overview of the changes in [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth),</span>
<span class="term-fg32">+    a fork of [`go-ethereum`](https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum), part of the OP-stack.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    The OP-stack architecture is modular, following the Consensus&#47;Execution split of post-Merge Ethereum L1:</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - [`op-node`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;tree&#47;develop&#47;op-node) implements most rollup-specific functionality as Consensus-Layer, similar to a L1 beacon-node. </span>
<span class="term-fg32">+      - [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth) implements the Execution-Layer, with **minimal changes** for a secure Ethereum-equivalent application environment.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    Related [op-stack specifications](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;tree&#47;develop&#47;specs):</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    - [L2 Execution Engine spec](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;exec-engine.md)</span>
<span class="term-fg32">+    - [Deposit Transaction spec](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;deposits.md)</span>
<span class="term-fg32">+  sub:</span>
<span class="term-fg32">+    - title: &quot;Core modifications&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;State-transition modifications&quot;</span>
<span class="term-fg32">+          description: &quot;&quot;</span>
<span class="term-fg32">+          sub:</span>
<span class="term-fg32">+            - title: &quot;Deposit Transaction type&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The Bedrock upgrade introduces a `Deposit` transaction-type (`0x7E`) to enable both users and the</span>
<span class="term-fg32">+                rollup system itself to change the L2 state based on L1 events and system rules as</span>
<span class="term-fg32">+                [specified](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;deposits.md).</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;deposit_tx.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction_marshalling.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction_signing.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Transaction properties&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The `Transaction` type now exposes the deposit-transaction and L1-cost properties required for the rollup.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_access_list.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_dynamic_fee.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_legacy.go&quot;</span>
<span class="term-fg32">+            - title: &quot;L1 cost computation&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Transactions must pay an additional L1 cost based on the amount of rollup-data-gas they consume,</span>
<span class="term-fg32">+                estimated based on gas-price-oracle information and encoded tx size.&quot;</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;vm&#47;evm.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;rollup_l1_cost.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;state_processor.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;state_prefetcher.go&quot;</span>
<span class="term-fg32">+            - title: Transaction processing</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Deposit transactions have special processing rules: gas is pre-paid on L1,</span>
<span class="term-fg32">+                and deposits with EVM-failure are included with rolled back changes (except mint).</span>
<span class="term-fg32">+                For regular transactions, at the end of the transition, the 1559 burn and L1 cost are routed to vaults.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;state_transition.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Gaslimit&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The gaslimit is free to be set by the Engine API caller, instead of enforcing adjustments of the</span>
<span class="term-fg32">+                gaslimit in increments of 1&#47;1024 of the previous gaslimit.</span>
<span class="term-fg32">+                The gaslimit is changed (and limited) through the `SystemConfig` contract.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;misc&#47;eip1559.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Consensus tweaks&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The Engine API is activated at the Merge transition, with a Total Terminal Difficulty (TTD).</span>
<span class="term-fg32">+                The rollup starts post-merge, and thus sets the TTD to 0.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;beacon&#47;consensus.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Chain config&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The rollup functionality is enabled with the `optimism` field in the chain config.</span>
<span class="term-fg32">+            The EIP-1559 parameters are configurable to adjust for faster more frequent and smaller blocks.</span>
<span class="term-fg32">+            The parameters can be overriden for testing.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;params&#47;config.go&quot;</span>
<span class="term-fg32">+            - &quot;params&#47;protocol_params.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;genesis.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Chain config cleanup&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The optimism Goerli testnet used clique-config data to make geth internals accept blocks.</span>
<span class="term-fg32">+            Post-bedrock the beacon-consensus (i.e. follow Engine API) is now used, and the clique config is removed.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;rawdb&#47;accessors_metadata.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Engine API modifications&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The Engine API is extended to insert transactions into the block and optionally exclude the tx-pool,</span>
<span class="term-fg32">+            to reproduce the exact block of the sequencer from just the inputs, as derived from L1 by the rollup-node.</span>
<span class="term-fg32">+            See [L2 execution engine specs](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;exec-engine.md).</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;beacon&#47;engine&#47;types.go&quot;</span>
<span class="term-fg32">+            - &quot;beacon&#47;engine&#47;gen_blockparams.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;catalyst&#47;api.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Block-building modifications&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The block-building code (in the &quot;miner&quot; package because of Proof-Of-Work legacy of ethereum) implements the</span>
<span class="term-fg32">+            changes to support the transaction-inclusion, tx-pool toggle and gaslimit parameters of the Engine API.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;miner&#47;*&quot;</span>
<span class="term-fg32">+        - title: &quot;Tx-pool tx cost updates&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Transaction queueing and inclusion needs to account for the L1 cost component.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;txpool&#47;*&quot;</span>
<span class="term-fg32">+    - title: &quot;Node modifications&quot;</span>
<span class="term-fg32">+      description: Changes to the node configuration and services.</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;CLI&quot;</span>
<span class="term-fg32">+          sub:</span>
<span class="term-fg32">+            - title: &quot;Flags&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Flag changes:</span>
<span class="term-fg32">+                  - Transactions can be forwarded to an RPC for sequencing.</span>
<span class="term-fg32">+                  - Historical calls can be forwarded to a legacy node.</span>
<span class="term-fg32">+                  - The tx pool propagation can be enabled&#47;disabled.</span>
<span class="term-fg32">+                  - The Optimism bedrock fork activation can be changed for testing.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;cmd&#47;utils&#47;flags.go&quot;</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;main.go&quot;</span>
<span class="term-fg32">+                - &quot;internal&#47;flags&#47;categories.go&quot;</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;config.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Versioning&quot;</span>
<span class="term-fg32">+              description: List the op-geth and upstream go-ethereum versions.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;misccmd.go&quot;</span>
<span class="term-fg32">+                - &quot;params&#47;version.go&quot;</span>
<span class="term-fg32">+                - &quot;build&#47;ci.go&quot;</span>
<span class="term-fg32">+        - title: Node config</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;ethconfig&#47;config.go&quot;</span>
<span class="term-fg32">+        - title: Tx gossip disable option</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;handler.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;handler_eth.go&quot;</span>
<span class="term-fg32">+    - title: &quot;User API enhancements&quot;</span>
<span class="term-fg32">+      description: &quot;Encode the Deposit Tx properties, the L1 costs, and daisy-chain RPC-calls for pre-Bedrock historical data&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;Receipts metadata&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Pre-Bedrock L1-cost receipt data is loaded from the database if available, and post-Bedrock the L1-cost </span>
<span class="term-fg32">+            metadata is hydrated on-the-fly based on the L1 fee information in the corresponding block.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;receipt.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;gen_receipt_json.go&quot;</span>
<span class="term-fg32">+        - title: &quot;API Backend&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Forward transactions to the sequencer if configured.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;api_backend.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;backend.go&quot;</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;backend.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Apply L1 cost in API responses&quot;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;state_accessor.go&quot;</span>
<span class="term-fg32">+        - title: API frontend</span>
<span class="term-fg32">+          description: Format deposit and L1-cost data in transaction responses.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;api.go&quot;</span>
<span class="term-fg32">+            - &quot;rpc&#47;errors.go&quot;</span>
<span class="term-fg32">+        - title: Tracer RPC daisy-chain</span>
<span class="term-fg32">+          description: Forward pre-bedrock tracing calls to legacy node.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;tracers&#47;api.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Light Ethereum Subprotocol (LES) RPC&quot;</span>
<span class="term-fg32">+          description: Match the RPC changes in the LES RPC</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;les&#47;*&quot;</span>
<span class="term-fg32">+        - title: &quot;Daisy Chain tests&quot;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;transaction_args_test.go&quot;</span>
<span class="term-fg32">+            - &quot;ethclient&#47;ethclient_test.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;tracers&#47;api_test.go&quot;</span>
<span class="term-fg32">+    - title: &quot;Geth extras&quot;</span>
<span class="term-fg32">+      description: Extend the tools available in geth to improve external testing and tooling.</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: Simulated Backend</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go&quot;</span>
<span class="term-fg32">+        - title: diff-included testing testing</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Most of the op-geth changes are tested in the Optimism Monorepo and not part of the geth diff,</span>
<span class="term-fg32">+            but some testing like the Deposit TX encoding and API interactions are embedded in the op-geth diff instead.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;transaction_marshalling_test.go&quot;</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;api_test.go&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+# ignored globally, does not count towards line count</span>
<span class="term-fg32">+ignore:</span>
<span class="term-fg32">+  - &quot;.circleci&#47;*&quot;</span>
<span class="term-fg32">+  - &quot;*.sum&quot;</span>
<span class="term-fg32">+  - &quot;go.mod&quot;</span>
<span class="term-fg32">+  - &quot;fork.yaml&quot;</span>
<span class="term-fg32">+  - &quot;.github&#47;workflows&#47;*&quot;</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6d090ece723fd96ff9d7de0d" role="button"
                   aria-expanded="false" aria-controls="id-6d090ece723fd96ff9d7de0d">
                    <code>go.mod</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/go.mod" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/go.mod" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6d090ece723fd96ff9d7de0d"><span class="term-fg1">diff --git go-ethereum&#47;go.mod op-geth&#47;go.mod</span>
<span class="term-fg1">index 21325d5669e1c70a835e1387672f8f083bfa701b..430451fc3324ba5594a27b9560167c0823a0b066 100644</span>
<span class="term-fg1">--- go-ethereum&#47;go.mod</span>
<span class="term-fg1">+++ op-geth&#47;go.mod</span>
<span class="term-fg36">@@ -53,7 +53,7 @@</span> 	github.com&#47;peterh&#47;liner v1.1.1-0.20190123174540-a2c9a5303de7
 	github.com&#47;rs&#47;cors v1.7.0
 	github.com&#47;shirou&#47;gopsutil v3.21.4-0.20210419000835-c7a38de76ee5+incompatible
 	github.com&#47;status-im&#47;keycard-go v0.2.0
<span class="term-fg31">-	github.com&#47;stretchr&#47;testify v1.8.0</span>
<span class="term-fg32">+	github.com&#47;stretchr&#47;testify v1.8.1</span>
 	github.com&#47;supranational&#47;blst v0.3.8-0.20220526154634-513d2456b344
 	github.com&#47;syndtr&#47;goleveldb v1.0.1-0.20210819022825-2ae1ddf74ef7
 	github.com&#47;tyler-smith&#47;go-bip39 v1.1.0
<span class="term-fg36">@@ -113,6 +113,7 @@</span> 	github.com&#47;prometheus&#47;common v0.39.0 &#47;&#47; indirect
 	github.com&#47;prometheus&#47;procfs v0.9.0 &#47;&#47; indirect
 	github.com&#47;rogpeppe&#47;go-internal v1.9.0 &#47;&#47; indirect
 	github.com&#47;russross&#47;blackfriday&#47;v2 v2.1.0 &#47;&#47; indirect
<span class="term-fg32">+	github.com&#47;stretchr&#47;objx v0.5.0 &#47;&#47; indirect</span>
 	github.com&#47;tklauser&#47;go-sysconf v0.3.5 &#47;&#47; indirect
 	github.com&#47;tklauser&#47;numcpus v0.2.2 &#47;&#47; indirect
 	github.com&#47;xrash&#47;smetrics v0.0.0-20201216005158-039620a65673 &#47;&#47; indirect</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-21c11c6d9bdbdaad57296fea" role="button"
                   aria-expanded="false" aria-controls="id-21c11c6d9bdbdaad57296fea">
                    <code>go.sum</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/7e3b149be054053fd1177deaba3caf60d5f5d30b/go.sum" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/014c1f054a9a4b9b1bd2cd11a18ce862d56db924/go.sum" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-21c11c6d9bdbdaad57296fea"><span class="term-fg1">diff --git go-ethereum&#47;go.sum op-geth&#47;go.sum</span>
<span class="term-fg1">index 51beb15cd24ae8e159cc692b01e3ab3847c19b88..449f638159a73ff1f737fc897ecc47372f610436 100644</span>
<span class="term-fg1">--- go-ethereum&#47;go.sum</span>
<span class="term-fg1">+++ op-geth&#47;go.sum</span>
<span class="term-fg36">@@ -521,6 +521,8 @@</span> github.com&#47;status-im&#47;keycard-go v0.2.0&#47;go.mod h1:wlp8ZLbsmrF6g6WjugPAx+IzoLrkdf9+mHxBEeo3Hbg=
 github.com&#47;stretchr&#47;objx v0.1.0&#47;go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
 github.com&#47;stretchr&#47;objx v0.1.1&#47;go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
 github.com&#47;stretchr&#47;objx v0.4.0&#47;go.mod h1:YvHI0jy2hoMjB+UWwv71VJQ9isScKT&#47;TqJzVSSt89Yw=
<span class="term-fg32">+github.com&#47;stretchr&#47;objx v0.5.0 h1:1zr&#47;of2m5FGMsad5YfcqgdqdWrIhu+EBEJRhR1U7z&#47;c=</span>
<span class="term-fg32">+github.com&#47;stretchr&#47;objx v0.5.0&#47;go.mod h1:Yh+to48EsGEfYuaHDzXPcE3xhTkx73EhmCGUpEOglKo=</span>
 github.com&#47;stretchr&#47;testify v1.2.0&#47;go.mod h1:a8OnRcib4nhh0OaRAV+Yts87kKdq0PP7pXfy6kDkUVs=
 github.com&#47;stretchr&#47;testify v1.2.2&#47;go.mod h1:a8OnRcib4nhh0OaRAV+Yts87kKdq0PP7pXfy6kDkUVs=
 github.com&#47;stretchr&#47;testify v1.3.0&#47;go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
<span class="term-fg36">@@ -528,8 +530,9 @@</span> github.com&#47;stretchr&#47;testify v1.4.0&#47;go.mod h1:j7eGeouHqKxXV5pUuKE4zz7dFj8WfuZ+81PSLYec5m4=
 github.com&#47;stretchr&#47;testify v1.5.1&#47;go.mod h1:5W2xD1RspED5o8YsWQXVCued0rvSQ+mT+I5cxcmMvtA=
 github.com&#47;stretchr&#47;testify v1.7.0&#47;go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962&#47;h&#47;Wwjteg=
 github.com&#47;stretchr&#47;testify v1.7.1&#47;go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962&#47;h&#47;Wwjteg=
<span class="term-fg31">-github.com&#47;stretchr&#47;testify v1.8.0 h1:pSgiaMZlXftHpm5L7V1+rVB+AZJydKsMxsQBIJw4PKk=</span>
 github.com&#47;stretchr&#47;testify v1.8.0&#47;go.mod h1:yNjHg4UonilssWZ8iaSj1OCr&#47;vHnekPRkoO+kdMU+MU=
<span class="term-fg32">+github.com&#47;stretchr&#47;testify v1.8.1 h1:w7B6lhMri9wdJUVmEZPGGhZzrYTPvgJArz7wNPgYKsk=</span>
<span class="term-fg32">+github.com&#47;stretchr&#47;testify v1.8.1&#47;go.mod h1:w2LPCIKwWwSfY2zedu0+kehJoqGctiVI29o6fzry7u4=</span>
 github.com&#47;supranational&#47;blst v0.3.8-0.20220526154634-513d2456b344 h1:m+8fKfQwCAy1QjzINvKe&#47;pYtLjo2dl59x2w9YSEJxuY=
 github.com&#47;supranational&#47;blst v0.3.8-0.20220526154634-513d2456b344&#47;go.mod h1:jZJtfjgudtNl4en1tzwPIV3KjUnQUvG3&#47;j+w+fVonLw=
 github.com&#47;syndtr&#47;goleveldb v1.0.1-0.20210819022825-2ae1ddf74ef7 h1:epCh84lMvA70Z7CTTCmYQn2CKbY8j86K7&#47;FAIr141uY=</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

                    </div>
                
            </div>
        </main>
    </div>

    <footer class="col-xl-10 col-xxl-8 mx-auto px-3 pt-5 my-5 text-muted border-top">
        <p>Fork-diff overview of <a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a>, a fork of <a href="https://github.com/ethereum/go-ethereum"><code>go-ethereum</code></a>.
and execution-engine of the <a href="https://github.com/ethereum-optimism/optimism">OP-stack</a>.</p>

    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const storedTheme = localStorage.getItem('theme')

        // Get the preferred theme from the user's OS
        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme
            }

            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        // Set the bootstrap theme
        const setTheme = function (theme) {
            document.documentElement.setAttribute('data-bs-theme', theme)
            if (theme === 'dark') {
                document.getElementById('dark-mode-toggle').setAttribute('checked', true)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-high-fill', 'bi-brightness-low')
            } else {
                document.getElementById('dark-mode-toggle').setAttribute('checked', false)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-low', 'bi-brightness-high-fill')
            }
        }

        // Returns true if the current theme is dark
        const isDark = () => {
            return document.documentElement.getAttribute('data-bs-theme') === 'dark'
        }

        // Toggles dark mode
        const toggleDarkMode = () => {
            const newTheme = isDark() ? 'light' : 'dark'
            setTheme(newTheme)
            localStorage.setItem('theme', newTheme)
        }

        // Set the preferred theme on page load
        window.onload = () => {
            // Set preferred theme
            setTheme(getPreferredTheme());
            // Initialize tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }

        // Toggle dark mode when the toggle button is clicked
        addEventListener("click", (event) => {
            if (event.target.id === 'dark-mode-toggle') {
                toggleDarkMode();
                // De-focus the toggle
                document.activeElement.blur()
            }
        });
    </script>
</body>
</html>
